<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator Pro</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">

  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">

  <style>
    /* ... (CSS K√ìD ZOSTA≈áUJE ROVNAK√ù AKO V POSLEDNEJ KOMPLETNEJ VERZII) ... */
    :root {
      --primary-bg-color: #f0f2f5;
      --secondary-bg-color: #ffffff;
      --primary-text-color: #1f2937;
      --secondary-text-color: #4b5563;
      --input-bg-color: #fefcbf;
      --input-note-bg-color: #e0f2fe;
      --table-header-bg-color: #f9fafb;
      --table-border-color: #e5e7eb;
      --current-day-bg-color: #7c3aed;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #2563eb;
      --btn-primary-hover-bg: #1d4ed8;
      --btn-secondary-bg: #7c3aed;
      --btn-secondary-hover-bg: #6d28d9;
      --btn-danger-bg: #dc2626;
      --btn-danger-hover-bg: #b91c1c;
      --btn-warning-bg: #f59e0b;
      --btn-warning-hover-bg: #d97706;
      --btn-highlight-bg: #f59e0b; /* Pre notifik√°ciu */
      --btn-text-color: #ffffff;
      --total-salary-bg: #eff6ff;
      --link-color: #2563eb;
      --link-hover-color: #1d4ed8;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --box-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --base-font-size: 16px;
      --focus-outline-color: var(--btn-primary-bg);
      --transition-speed: 0.2s;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2') format('woff2');
      font-weight: 400 700;
      font-style: normal;
      font-display: swap;
    }

    html {
      font-size: var(--base-font-size);
      scroll-behavior: smooth;
    }
    body {
      font-family: var(--font-family);
      line-height: 1.6;
      margin: 0;
      padding: 12px;
      background-color: var(--primary-bg-color);
      color: var(--primary-text-color);
      font-size: 0.92rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container {
      max-width: 1500px;
      margin: 20px auto;
      background: var(--secondary-bg-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow-lg);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      color: var(--primary-text-color);
      margin-bottom: 10px;
      font-weight: 700;
    }
    h1#mainTitle {
      background: linear-gradient(45deg, #7c3aed, #db2777, #f59e0b);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      padding-bottom: 3px;
    }

    h2 {
      text-align: center;
      color: var(--secondary-text-color);
      margin-top: -5px;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 20px;
    }

    fieldset {
        border: 1px solid var(--table-border-color);
        border-radius: var(--border-radius);
        padding: 15px;
        margin-bottom: 20px;
    }
    legend {
        font-weight: 600;
        color: var(--primary-text-color);
        padding: 0 8px;
        font-size: 0.95rem;
    }

    *:focus-visible {
        outline: 3px solid var(--focus-outline-color);
        outline-offset: 2px;
        box-shadow: 0 0 0 5px rgba(37, 99, 235, 0.2);
    }
    input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible {
        outline: 2px solid var(--focus-outline-color);
        outline-offset: 1px;
    }

    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 10px;
    }
    .settings > div, .settings > button#toggleSettingsBtn {
      margin: 0;
    }
    .settings > div {
      flex: 1 1 220px;
    }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%;
      margin-bottom: 10px;
      background-color: var(--secondary-bg-color);
      color: var(--primary-text-color);
      border: 1px solid var(--table-border-color);
      text-align: left;
      padding: 10px 15px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
    }
    .settings > button#toggleSettingsBtn:hover {
        background-color: var(--primary-bg-color);
        box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--secondary-text-color);
    }
    #settings-collapsible-content {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
      gap: 10px 12px;
    }
    #settings-collapsible-content.visible {
      max-height: 700px;
      opacity: 1;
      margin-top: 10px;
    }
    #settings-collapsible-content > fieldset {
        display: contents;
    }
    #settings-collapsible-content > fieldset > div {
        flex: 1 1 220px;
        margin: 0;
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 20px;
      border: 1px solid var(--table-border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid var(--table-border-color);
      text-align: left;
      font-size: 0.875rem;
      vertical-align: middle;
      transition: background-color var(--transition-speed);
    }
    thead tr {
        border-bottom: 2px solid #d1d5db;
    }
    th {
      background-color: var(--table-header-bg-color);
      font-weight: 600;
      color: var(--primary-text-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tr.weekend-day td:first-child {
        background-color: #f3f4f6;
        font-style: normal;
        color: var(--secondary-text-color);
    }

    td .time-input-wrapper {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    td .time-input-wrapper input[type="tel"] {
      flex-grow: 1;
      min-width: 65px;
      padding: 8px 6px;
      font-size: 0.875rem;
    }
    td .time-input-wrapper .time-btn {
      font-size: 1.1rem;
      cursor: pointer;
      padding: 4px 5px;
      border: 1px solid transparent;
      border-radius: var(--border-radius);
      line-height: 1;
      background: none;
      color: var(--secondary-text-color);
      user-select: none;
      transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
    }

    td .time-input-wrapper .time-btn:hover {
      background-color: #e5e7eb;
      border-color: #d1d5db;
      color: var(--primary-text-color);
    }

    th:nth-child(1), td:nth-child(1) { width: 100px;}
    th:nth-child(2), td:nth-child(2) { width: 110px;}
    th:nth-child(3), td:nth-child(3) { width: 110px;}
    th:nth-child(4), td:nth-child(4) { width: 90px;}
    th:nth-child(5), td:nth-child(5) { width: 120px;}
    th:nth-child(6), td:nth-child(6) { min-width: 250px; width: auto; }
    th:nth-child(7), td:nth-child(7) { width: 100px;}
    th:nth-child(8), td:nth-child(8) { width: 100px;}
    th:nth-child(9), td:nth-child(9) { width: 50px; text-align: center;}

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 9px 12px;
      box-sizing: border-box;
      background-color: var(--input-bg-color);
      font-size: 0.9rem;
      border: 1px solid #d1d5db;
      border-radius: var(--border-radius);
      vertical-align: middle;
      font-family: var(--font-family);
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
      color: var(--primary-text-color);
    }
    input[type="tel"]:focus, input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
        border-color: var(--focus-outline-color);
        box-shadow: 0 0 0 1px var(--focus-outline-color);
    }
    input[type="tel"].invalid-time, input[type="number"].invalid-value, input[type="text"].invalid-value {
        border-color: var(--btn-danger-bg) !important;
        box-shadow: 0 0 0 1px var(--btn-danger-bg) !important;
    }

    td input[type="number"] { min-width: 60px; }
    td input[type="text"] {
        min-width: 60px;
    }

    td input[type="number"][readonly] {
      background-color: #f9fafb;
      border: none;
      padding-left: 2px; padding-right: 2px;
      color: var(--secondary-text-color);
      font-weight: 500;
    }
    textarea[id^="note-"] {
      background-color: var(--input-note-bg-color);
      resize: vertical;
      min-height: 38px;
      line-height: 1.5;
      overflow-y: hidden;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 25px;
      gap: 12px;
    }
    .btn {
      flex: 0 1 auto;
      padding: 10px 20px;
      color: var(--btn-text-color);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.92rem;
      font-weight: 500;
      margin: 0;
      transition: background-color var(--transition-speed) ease, transform 0.1s ease, box-shadow var(--transition-speed) ease;
      text-align: center;
      box-shadow: var(--box-shadow);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 10px -3px rgba(0,0,0,0.1), 0 4px 5px -2px rgba(0,0,0,0.06);
    }
    .btn:active {
        transform: translateY(0px);
        box-shadow: var(--box-shadow);
    }

    .btn.is-loading { pointer-events: none; position: relative; }
    .btn.is-loading::before {
        content: ""; position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.6);
        border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

    .reset-btn { background-color: var(--btn-danger-bg); }
    .reset-btn:hover { background-color: var(--btn-danger-hover-bg); }
    .btn.warning-btn { background-color: var(--btn-warning-bg); color: var(--primary-text-color); }
    .btn.warning-btn:hover { background-color: var(--btn-warning-hover-bg); }

    .export-btn { background-color: var(--btn-primary-bg); }
    .export-btn:hover { background-color: var(--btn-primary-hover-bg); }
    .backup-btn { background-color: var(--btn-secondary-bg); }
    .backup-btn:hover { background-color: var(--btn-secondary-hover-bg); }

    #totalSalary {
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      margin-top: 25px;
      padding: 15px;
      background-color: var(--total-salary-bg);
      border-radius: var(--border-radius);
      line-height: 1.8;
      color: var(--primary-text-color);
      box-shadow: var(--box-shadow);
    }
    #totalSalary strong { font-weight: 700; }
    #localStorageIndicator {
        font-size: 0.8rem; text-align: right; margin-top: 8px; color: #9ca3af;
    }

    .current-day { background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color); }
    .current-day td, .current-day th {
        background-color: var(--current-day-bg-color) !important;
        color: var(--current-day-text-color) !important;
        border-color: rgba(255,255,255,0.3) !important;
    }
    .current-day input, .current-day select, .current-day textarea {
      background-color: rgba(255,255,255,0.15) !important;
      color: var(--current-day-text-color) !important;
      border-color: rgba(255,255,255,0.4) !important;
    }
    .current-day input::placeholder, .current-day textarea::placeholder { color: rgba(255,255,255,0.7); }
    .current-day textarea[id^="note-"] { background-color: rgba(255,255,255,0.2) !important; }
    .current-day .time-btn { color: var(--current-day-text-color) !important; }
    .current-day .time-btn:hover {
        background-color: rgba(255,255,255,0.25) !important;
        border-color: rgba(255,255,255,0.5) !important;
    }

    #auth-container fieldset { width: 100%; max-width: 380px; margin-left:auto; margin-right:auto; }
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
      width: 100%;
      margin: 8px 0; display: block; padding: 10px; font-size: 0.95rem;
      box-sizing: border-box;
    }
    #login-form .btn {
      width: 100%;
      margin: 8px 0 0 0;
      padding: 10px 15px;
      font-size: 0.95rem;
      flex-grow: 0; flex-shrink: 0; flex-basis: auto;
      min-width: auto; max-width: none;
    }
    #login-form .btn + .btn { margin-top: 10px; }
    #login-form a { margin-top: 15px; display: block; font-size: 0.9rem; color: var(--link-color); text-decoration: none; }
    #login-form a:hover { text-decoration: underline; color: var(--link-hover-color); }
    #user-info { align-items: center; }

    @media (max-width: 768px) {
      body { padding: 8px; font-size: 0.9rem; }
      .container { padding: 15px; margin: 10px auto; }
      h1 { font-size: 1.8rem; } h2 { font-size: 0.95rem; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; }
      #settings-collapsible-content.visible { max-height: 700px; }
      th, td { padding: 8px; font-size: 0.85rem; }
      textarea[id^="note-"] { min-height: 40px; }

      .btn-container .btn {
        font-size: 0.9rem;
        padding: 12px 18px;
        margin: 5px 0;
        min-width: 180px;
        max-width: 300px;
      }
      .btn-container .btn[title*="Vymaza≈• mesiac"] {
        max-width: 240px;
      }

      #login-form input[type="email"], #login-form input[type="password"] { font-size: 0.9rem; padding: 10px;}
      #login-form .btn { font-size: 0.92rem !important; padding-top: 11px !important; padding-bottom: 11px !important;}
      #login-form a { margin-top: 18px !important; font-size: 0.88rem; }
    }

    @media (max-width: 480px) {
      body { padding: 6px; } .container { padding: 10px; }
      h1 { font-size: 1.6rem; } h2 { font-size: 0.9rem; }
      th, td { padding: 7px; font-size: 0.82rem; }
      textarea[id^="note-"] { min-height: 42px; }
      #settings-collapsible-content.visible { max-height: 800px; }

      .btn-container .btn {
        font-size: 0.88rem; padding: 11px 16px; min-width: 100%; max-width: 280px;
      }
      #login-form input[type="email"], #login-form input[type="password"],
      #login-form .btn {
         font-size: 0.88rem !important;
      }
    }

    #saveNotification, #errorNotification, #warningNotification {
        display: none; position: fixed; bottom: 25px; right: 25px;
        padding: 15px 22px;
        border-radius: var(--border-radius); font-size: 0.95rem;
        box-shadow: var(--box-shadow-lg); z-index: 10000;
        opacity: 0; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        transform: translateY(30px);
        font-weight: 500;
    }
    #saveNotification.show, #errorNotification.show, #warningNotification.show {
        display: block; opacity: 1; transform: translateY(0);
    }
    #saveNotification { background-color: var(--btn-primary-bg); color: white; }
    #errorNotification { background-color: var(--btn-danger-bg); color: white; }
    #warningNotification { background-color: var(--btn-highlight-bg); color: var(--primary-text-color); }

    @media print {
      body { padding: 0; font-size: 10pt; color: #000; background-color: #fff; font-family: Arial, sans-serif;}
      .container { max-width: 100%; margin: 0; padding: 10px; box-shadow: none; border: none;}
      #auth-container, .settings, .btn-container, #localStorageIndicator, #saveNotification, #errorNotification, #warningNotification, .time-btn, .reset-btn { display: none !important; }
      h1 { font-size: 18pt; margin-bottom: 5mm; background: none !important; -webkit-background-clip: unset !important; background-clip: unset !important; color: black !important;}
      h2 { font-size: 12pt; margin-bottom: 8mm; }
      .table-container { overflow: visible; border: 1px solid #ccc; }
      table { width: 100%; page-break-inside: auto; border-collapse: collapse;}
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      th, td {
        border: 1px solid #ccc !important; padding: 4px 6px; font-size: 9pt;
        background-color: #fff !important; color: #000 !important;
      }
      th { font-weight: bold; background-color: #f0f0f0 !important; }
      td input[type="number"][readonly], td input[type="tel"], td input[type="number"], td input[type="text"] {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; text-align: left; width: auto !important; font-size: 9pt !important;
      }
      textarea[id^="note-"] {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; min-height: auto !important; height: auto !important;
          overflow: visible !important; resize: none !important; font-size: 9pt !important; white-space: normal !important;
      }
      #totalSalary {
        margin-top: 10mm; padding: 8px; border: 1px solid #ccc;
        background-color: #f9f9f9 !important; color: #000 !important; box-shadow: none;
        page-break-before: auto;
      }
      a { text-decoration: none; color: #000; }
      a[href^="http"]:after { content: " (" attr(href) ")"; font-size: 8pt; }
      .current-day, .current-day td, .current-day th, .current-day input, .current-day textarea {
          background-color: #fff !important; color: #000 !important; border-color: #ccc !important;
      }
      .current-day span[aria-hidden="true"] { display: none !important; }
      #workDays td:nth-child(1) span[aria-hidden="true"] { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="margin-bottom: 20px;">
      <fieldset id="login-fieldset">
        <legend>Prihl√°senie / Registr√°cia</legend>
        <div id="login-form">
          <input type="email" id="email" placeholder="Email" aria-label="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Heslo" aria-label="Heslo" autocomplete="current-password">
          <!-- ODSTR√ÅNEN√â onclick, pridan√© ID -->
          <button class="btn export-btn" id="loginButton">Prihl√°si≈• sa</button>
          <button class="btn export-btn" id="registerButton">Registrova≈•</button>
          <a href="#" id="resetPasswordLink">Zabudli ste heslo?</a>
        </div>
      </fieldset>
      <div id="user-info" style="display: none; justify-content: center; align-items: center; gap: 15px; margin-top:10px;">
        <span id="user-email" style="font-weight:500;"></span>
        <!-- ODSTR√ÅNEN√â onclick, pridan√© ID -->
        <button class="btn reset-btn" id="logoutButton" style="padding: 8px 15px; font-size: 0.85rem; margin:0;">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <div class="settings">
        <!-- ODSTR√ÅNEN√â onclick, toggleSettingsBtn u≈æ m√° ID -->
        <button id="toggleSettingsBtn" class="btn" aria-expanded="false" aria-controls="settings-collapsible-content">Zobrazi≈• nastavenia aplik√°cie ‚ñº</button>
        <div id="settings-collapsible-content">
            <fieldset>
                <legend>Z√°kladn√© nastavenia</legend>
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <!-- oninput a onblur pre inputy v tabuƒæke/settings m√¥≈æu zosta≈•, lebo sa volaj√∫, keƒè u≈æ je v≈°etko definovan√© -->
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="window.updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="hourlyWageInput" oninput="window.handleNumericInput(this)" onblur="window.handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="text" inputmode="decimal" id="taxRateInput" oninput="window.handleNumericInput(this)" onblur="window.handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                    <select id="decimalPlacesSelect" onchange="window.changeDecimalPlaces()">
                      <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                    </select>
                </div>
            </fieldset>
             <fieldset>
                <legend>Navig√°cia v ƒçase</legend>
                <div>
                    <label for="monthSelect">Mesiac:</label>
                    <select id="monthSelect" onchange="window.changeMonth()"></select>
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect" onchange="window.changeYear()"></select>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays">
        </tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite">V√Ωpoƒçet celkovej mzdy...</div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <!-- ODSTR√ÅNEN√â onclick, pridan√© ID -->
        <button class="btn export-btn" id="exportPdfButton">Exportova≈• do PDF</button>
        <button class="btn export-btn" id="sendPdfButton">Odosla≈• PDF (s pozn.)</button>
        <button class="btn backup-btn" id="createBackupButton">Vytvori≈• z√°lohu (XLSX)</button>
        <button class="btn backup-btn" id="restoreBackupButton">Obnovi≈• z√°lohu (XLSX)</button>
        <button class="btn export-btn" id="loadFromCloudButton">Naƒç√≠ta≈• z Cloudu</button>
        <button class="btn warning-btn" id="clearMonthButton" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• Mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©.</div>
  <div id="errorNotification" role="alert" aria-live="assertive">Nastala chyba.</div>
  <div id="warningNotification" role="alert" aria-live="assertive">Upozornenie.</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js" defer></script>

  <script>
    // Glob√°lne premenn√© pre Firebase funkcie
    let initializeApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail;
    let getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, enableFirestorePersistence;
    let initializeFirebaseAppCheck_SDK, ReCaptchaV3Provider_SDK;

    function areFirebaseSDKsLoaded() {
        return (
            typeof window.firebase !== 'undefined' &&
            typeof window.firebase.app !== 'undefined' &&
            typeof window.firebase.auth !== 'undefined' &&
            typeof window.firebase.firestore !== 'undefined' &&
            typeof window.firebase.appCheck !== 'undefined'
        );
    }

    function setupAndRunApp() {
        if (!areFirebaseSDKsLoaded()) {
            console.log("Firebase SDKs not yet loaded, retrying in 100ms...");
            setTimeout(setupAndRunApp, 100);
            return;
        }
        console.log("Firebase SDKs loaded globally. Setting up app...");

        const firebaseApp_module = window.firebase.app;
        const firebaseAuth_module = window.firebase.auth;
        const firebaseFirestore_module = window.firebase.firestore;
        const firebaseAppCheck_module = window.firebase.appCheck;

        initializeApp = firebaseApp_module.initializeApp;
        getAuth = firebaseAuth_module.getAuth;
        signInWithEmailAndPassword = firebaseAuth_module.signInWithEmailAndPassword;
        createUserWithEmailAndPassword = firebaseAuth_module.createUserWithEmailAndPassword;
        signOut = firebaseAuth_module.signOut;
        onAuthStateChanged = firebaseAuth_module.onAuthStateChanged;
        sendPasswordResetEmail = firebaseAuth_module.sendPasswordResetEmail;
        getFirestore = firebaseFirestore_module.getFirestore;
        collection = firebaseFirestore_module.collection;
        doc = firebaseFirestore_module.doc;
        setDoc = firebaseFirestore_module.setDoc;
        getDoc = firebaseFirestore_module.getDoc;
        updateDoc = firebaseFirestore_module.updateDoc;
        deleteDoc = firebaseFirestore_module.deleteDoc;
        onSnapshot = firebaseFirestore_module.onSnapshot;
        writeBatch = firebaseFirestore_module.writeBatch;
        enableFirestorePersistence = firebaseFirestore_module.enableIndexedDbPersistence;
        initializeFirebaseAppCheck_SDK = firebaseAppCheck_module.initializeAppCheck;
        ReCaptchaV3Provider_SDK = firebaseAppCheck_module.ReCaptchaV3Provider;

        initializeAppLogic();
    }

    function initializeAppLogic() {
        const firebaseConfig = {
            apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // <-- !!! NAHRAƒé SVOJ√çM API KƒΩ√öƒåOM !!!
            authDomain: "uuuuu-f7ef9.firebaseapp.com",
            projectId: "uuuuu-f7ef9",
            storageBucket: "uuuuu-f7ef9.appspot.com",
            messagingSenderId: "456105865458",
            appId: "1:456105865458:web:101f0a4dcb455f174b606b",
        };

        const app = initializeApp(firebaseConfig);
        try {
           const appCheckInstance = initializeFirebaseAppCheck_SDK(app, {
                provider: new ReCaptchaV3Provider_SDK('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // <-- !!! NAHRAƒé SVOJ√çM reCAPTCHA SITE KEY !!!
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check initialized.");
        } catch (e) {
            console.warn("App Check initialization failed:", e);
        }
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableFirestorePersistence(db)
          .then(() => {
            console.log("Firestore offline persistence enabled.");
          })
          .catch((err) => {
            if (err.code == 'failed-precondition') {
              console.warn("Firestore offline persistence failed (multiple tabs open?):", err);
            } else if (err.code == 'unimplemented') {
              console.warn("Firestore offline persistence not available in this browser:", err);
            }
          });

        let currentUser = null;
        let currentListenerUnsubscribe = null;
        const uiRefs = {
            workDaysTbody: document.getElementById('workDays'),
            totalSalaryDiv: document.getElementById('totalSalary'),
            mainTitle: document.getElementById('mainTitle'),
            subTitle: document.getElementById('subTitle'),
            hourlyWageInput: document.getElementById('hourlyWageInput'),
            taxRateInput: document.getElementById('taxRateInput'),
            monthSelect: document.getElementById('monthSelect'),
            yearSelect: document.getElementById('yearSelect'),
            decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
            employeeNameInput: document.getElementById('employeeNameInput'),
            toggleSettingsBtn: document.getElementById('toggleSettingsBtn'),
            settingsCollapsibleContent: document.getElementById('settings-collapsible-content'),
            localStorageIndicator: document.getElementById('localStorageIndicator'),
            loginForm: document.getElementById('login-form'),
            loginFieldset: document.getElementById('login-fieldset'),
            userInfo: document.getElementById('user-info'),
            userEmailSpan: document.getElementById('user-email'),
        };

        const currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        let appSettings = {
            decimalPlaces: 2, employeeName: '', hourlyWage: 10, taxRate: 0.02,
        };

        const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
        const DAY_NAMES_SHORT = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];

        function getDaysInMonth(month, year) { return new Date(year, month + 1, 0).getDate(); }
        function getDayName(year, month, day) { return DAY_NAMES_SHORT[new Date(year, month, day).getDay()]; }
        function isWeekend(year, month, day) { const d = new Date(year, month, day).getDay(); return d === 0 || d === 6; }
        const debounce = (func, wait) => {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        };
        function isValidTimeFormat(timeString) { return typeof timeString === 'string' && /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }

        function showNotification(id, message, duration = 3500) {
            const notification = document.getElementById(id);
            if (!notification) return;
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), duration);
        }
        window.showSaveNotification = (message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©.') => showNotification('saveNotification', message);
        window.showErrorNotification = (message) => showNotification('errorNotification', message, 5000);
        window.showWarningNotification = (message) => showNotification('warningNotification', message, 4500);

        function setLoadingState(button, isLoading, originalTextIfLoading, originalTextIfNotLoading) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                if (!button.dataset.originalText) {
                    button.dataset.originalText = button.textContent;
                }
                button.innerHTML = `<span class="spinner" role="status" aria-hidden="true"></span> ${originalTextIfLoading || "Sprac√∫vam..."}`;
                button.classList.add('is-loading');
            } else {
                button.disabled = false;
                button.textContent = originalTextIfNotLoading || button.dataset.originalText || button.textContent;
                if(button.dataset.originalText && !originalTextIfNotLoading) {
                    delete button.dataset.originalText;
                }
                button.classList.remove('is-loading');
            }
        }

        function loadAppSettingsFromLocalStorage() {
            appSettings.decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
            appSettings.employeeName = localStorage.getItem('employeeName') || '';
            appSettings.hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
            appSettings.taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
        }
        function saveAppSettingToLocalStorage(key, value) {
            localStorage.setItem(key, value);
            appSettings[key] = value;
        }
        async function saveAppSettingsToFirestore() {
            if (!currentUser || !navigator.onLine) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            try {
                await setDoc(userDocRef, { appSettings: appSettings }, { merge: true });
                console.log("App settings saved to Firestore.");
            } catch (error) { console.error("Error saving app settings to Firestore:", error); showErrorNotification("Nepodarilo sa ulo≈æi≈• nastavenia aplik√°cie do cloudu."); }
        }
        const debouncedSaveAppSettingsToFirestore = debounce(saveAppSettingsToFirestore, 1800);

        async function loadUserAppSettingsFromFirestore() {
            if (!currentUser || !navigator.onLine) return Promise.resolve(false);
            const userDocRef = doc(db, 'users', currentUser.uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().appSettings) {
                    console.log("Loading app settings from Firestore.");
                    const fsSettings = docSnap.data().appSettings;
                    Object.keys(appSettings).forEach(key => {
                        if (fsSettings.hasOwnProperty(key) && fsSettings[key] !== undefined) {
                             appSettings[key] = fsSettings[key];
                        }
                    });
                    Object.entries(appSettings).forEach(([key, value]) => {
                        if (value !== undefined) localStorage.setItem(key, value);
                    });
                    updateSettingsUIInputs();
                    return true;
                }
            } catch (error) { console.error("Error loading user app settings:", error); showErrorNotification("Chyba naƒç√≠tania nastaven√≠ z cloudu."); }
            return false;
        }

        function updateSettingsUIInputs() {
            uiRefs.decimalPlacesSelect.value = appSettings.decimalPlaces;
            uiRefs.employeeNameInput.value = appSettings.employeeName;
            uiRefs.hourlyWageInput.value = appSettings.hourlyWage.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
            uiRefs.taxRateInput.value = (appSettings.taxRate * 100).toFixed(1);
        }

        function initializeUI() {
            loadAppSettingsFromLocalStorage();
            MONTH_NAMES.forEach((name, index) => {
                const option = document.createElement('option'); option.value = index; option.textContent = name; uiRefs.monthSelect.appendChild(option);
            });
            const startYear = 2020, endYear = currentDate.getFullYear() + 5;
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option'); option.value = year; option.textContent = year; uiRefs.yearSelect.appendChild(option);
            }
            uiRefs.monthSelect.value = currentMonth;
            uiRefs.yearSelect.value = currentYear;
            updateSettingsUIInputs();
            updatePageTitleAndGreeting();
            updateLocalStorageSizeIndicator();
        }

        window.updateEmployeeName = function() {
            saveAppSettingToLocalStorage('employeeName', uiRefs.employeeNameInput.value.trim());
            updatePageTitleAndGreeting();
            debouncedSaveAppSettingsToFirestore();
        }

        window.handleNumericInput = function(inputElement) {
            let value = inputElement.value;
            value = value.replace(',', '.');
            value = value.replace(/[^\d.]/g, '').replace(/(\..*)\./g, '$1');
            inputElement.value = value;
        }

        window.handleWageOrTaxBlur = function(inputElement) {
            let valueString = inputElement.value.replace(',', '.');
            let value = parseFloat(valueString);
            const id = inputElement.id;
            let validChange = true;
            inputElement.classList.remove('invalid-value');
            if (id === 'hourlyWageInput') {
                if (!isNaN(value) && value >= 0) {
                    appSettings.hourlyWage = value;
                    inputElement.value = value.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
                    saveAppSettingToLocalStorage('hourlyWage', appSettings.hourlyWage);
                } else {
                    inputElement.value = appSettings.hourlyWage.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
                    showErrorNotification("Neplatn√° hodinov√° mzda. Mus√≠ by≈• ƒç√≠slo >= 0.");
                    inputElement.classList.add('invalid-value');
                    validChange = false;
                }
            } else if (id === 'taxRateInput') {
                if (!isNaN(value) && value >= 0) {
                    appSettings.taxRate = value / 100;
                    inputElement.value = value.toFixed(1);
                    saveAppSettingToLocalStorage('taxRate', appSettings.taxRate);
                } else {
                    inputElement.value = (appSettings.taxRate * 100).toFixed(1);
                    showErrorNotification("Neplatn√© da≈àov√© percento. Mus√≠ by≈• ƒç√≠slo >= 0.");
                    inputElement.classList.add('invalid-value');
                    validChange = false;
                }
            }
            if (validChange) {
                recalculateAllRowsAndUpdateTotal();
                debouncedSaveAppSettingsToFirestore();
            }
        }

        window.changeDecimalPlaces = function() {
            saveAppSettingToLocalStorage('decimalPlaces', parseInt(uiRefs.decimalPlacesSelect.value));
            uiRefs.hourlyWageInput.value = appSettings.hourlyWage.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
            recalculateAllRowsAndUpdateTotal();
            debouncedSaveAppSettingsToFirestore();
        }
        function recalculateAllRowsAndUpdateTotal() {
             if (!uiRefs.workDaysTbody.hasChildNodes()) return;
            const days = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= days; i++) calculateRow(i);
            calculateTotal();
        }
        function updatePageTitleAndGreeting() {
            const wavingHand = "üëã"; const namePart = appSettings.employeeName ? `${appSettings.employeeName.split(' ')[0]}` : "";
            uiRefs.mainTitle.textContent = `Vitaj${namePart ? ' ' + namePart : ''} ${wavingHand}`;
            const monthName = MONTH_NAMES[currentMonth]; const titleNamePart = appSettings.employeeName ? `${appSettings.employeeName} - ` : "";
            document.title = `${titleNamePart}${monthName} ${currentYear} | Bruno's Calc Pro`;
            uiRefs.subTitle.textContent = `${monthName} ${currentYear}`;
        }
        function updateLocalStorageSizeIndicator() {
            let total = 0; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); total += (key.length + (localStorage.getItem(key)?.length || 0)) * 2; }
            uiRefs.localStorageIndicator.textContent = `Lok√°lne: ~${(total / 1024).toFixed(1)}KB`;
        }

        const authErrorMap = {
            'auth/invalid-email': 'Neplatn√Ω form√°t emailu.', 'auth/user-disabled': 'Tento √∫ƒçet bol deaktivovan√Ω.',
            'auth/user-not-found': 'Pou≈æ√≠vateƒæ s t√Ωmto emailom nebol n√°jden√Ω.', 'auth/wrong-password': 'Nespr√°vne heslo.',
            'auth/email-already-in-use': 'Tento email je u≈æ zaregistrovan√Ω.', 'auth/weak-password': 'Heslo je pr√≠li≈° slab√© (min. 6 znakov).',
            'auth/requires-recent-login': 'Vy≈æaduje sa ned√°vne prihl√°senie. Odhl√°ste sa a prihl√°ste znova.',
            'auth/network-request-failed': 'Chyba siete. Skontrolujte pripojenie.',
            'auth/too-many-requests': 'Pr√≠li≈° veƒæa pokusov. Sk√∫ste nesk√¥r.', 'auth/missing-email': 'Pros√≠m, zadajte emailov√∫ adresu.',
        };
        function mapFirebaseAuthError(code) { return authErrorMap[code] || `Nezn√°ma chyba (${code}). Sk√∫ste znova.`; }

        window.loginUser = async function(event) {
            const btn = event.currentTarget;
            setLoadingState(btn, true, "Prihlasujem...");
            if (!navigator.onLine) { showErrorNotification('Ste offline. Prihl√°senie je mo≈æn√© iba online.'); setLoadingState(btn, false, null, "Prihl√°si≈• sa"); return; }
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); setLoadingState(btn, false, null, "Prihl√°si≈• sa"); return; }
            try { await signInWithEmailAndPassword(auth, email, password); showSaveNotification('√öspe≈°ne prihl√°sen√Ω.'); }
            catch (error) { console.error('Chyba pri prihl√°sen√≠:', error); showErrorNotification('Chyba pri prihl√°sen√≠: ' + mapFirebaseAuthError(error.code)); }
            finally { setLoadingState(btn, false, null, "Prihl√°si≈• sa"); }
        };
        window.registerUser = async function(event) {
            const btn = event.currentTarget;
            setLoadingState(btn, true, "Registrujem...");
            if (!navigator.onLine) { showErrorNotification('Ste offline. Registr√°cia je mo≈æn√° iba online.'); setLoadingState(btn, false, null, "Registrova≈•"); return; }
            const email = document.getElementById('email').value; const password = document.getElementById('password').value;
            if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); setLoadingState(btn, false, null, "Registrova≈•"); return; }
            if (password.length < 6) { showErrorNotification('Heslo mus√≠ ma≈• aspo≈à 6 znakov.'); setLoadingState(btn, false, null, "Registrova≈•"); return; }
            try { await createUserWithEmailAndPassword(auth, email, password); await createUserCollectionAndSettings(); showSaveNotification('√öspe≈°ne zaregistrovan√Ω a prihl√°sen√Ω.'); }
            catch (error) { console.error('Chyba pri registr√°cii:', error); showErrorNotification('Chyba pri registr√°cii: ' + mapFirebaseAuthError(error.code)); }
            finally { setLoadingState(btn, false, null, "Registrova≈•"); }
        };
        async function createUserCollectionAndSettings() {
            if (auth.currentUser) {
                const userDocRef = doc(db, 'users', auth.currentUser.uid);
                const initialMonthDocId = getFirestoreDocId();
                const initialMonthDocRef = doc(db, 'users', auth.currentUser.uid, 'workData', initialMonthDocId);
                const batchOp = writeBatch(db);
                batchOp.set(userDocRef, { email: auth.currentUser.email, createdAt: new Date().toISOString(), appSettings: appSettings }, { merge: true });
                batchOp.set(initialMonthDocRef, { data: [], lastUpdated: new Date().toISOString() });
                try { await batchOp.commit(); console.log('User profile, settings, and initial month doc created.'); }
                catch (error) { console.error('Error in initial user data batch write:', error); showErrorNotification('Nepodarilo sa inicializova≈• d√°ta v cloude.');}
            }
        }
        window.logoutUser = async function(event) {
            const btn = event.currentTarget;
            setLoadingState(btn, true, "Odhlasujem...");
            if (currentListenerUnsubscribe) { currentListenerUnsubscribe(); currentListenerUnsubscribe = null; }
            try { await signOut(auth); showSaveNotification('√öspe≈°ne odhl√°sen√Ω.'); }
            catch (error) { console.error('Chyba pri odhl√°sen√≠:', error); showErrorNotification('Chyba pri odhl√°sen√≠: ' + error.message); }
            finally { setLoadingState(btn, false, null, "Odhl√°si≈• sa");}
        };
        window.resetUserPassword = async function() { // Tento event nepotrebuje, lebo nie je na tlaƒçidle
            if (!navigator.onLine) { showErrorNotification('Ste offline. Obnova hesla je mo≈æn√° iba online.'); return; }
            const emailInput = document.getElementById('email'); const email = emailInput.value;
            if (!email) { emailInput.style.border = '1px solid red'; showErrorNotification('Pros√≠m, zadajte email.'); setTimeout(() => { emailInput.style.border = ''; }, 3000); return; }
            emailInput.style.border = '';
            try { await sendPasswordResetEmail(auth, email); showSaveNotification(`Email na obnovu hesla odoslan√Ω na ${email}.`); }
            catch (error) { console.error('Chyba pri obnove hesla:', error); showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code)); }
        };

        // --- (Zvy≈°ok JavaScript k√≥du od 'updateUIForAuthStateChange' po koniec,
        //      vr√°tane exportov s dynamick√Ωm importom kni≈æn√≠c, zost√°va rovnak√Ω ako v predch√°dzaj√∫cej kompletnej odpovedi) ---
        // TENTO BLOK ZAƒå√çNA OD:
        function updateUIForAuthStateChange() {
            const isLoggedIn = !!currentUser;
            if (uiRefs.loginFieldset) {
                uiRefs.loginFieldset.style.display = isLoggedIn ? 'none' : 'block';
            }
            if (uiRefs.userInfo) {
                uiRefs.userInfo.style.display = isLoggedIn ? 'flex' : 'none';
            }

            if (isLoggedIn && uiRefs.userEmailSpan) {
                uiRefs.userEmailSpan.textContent = `${currentUser.email}`;
            }
            const logoutBtn = uiRefs.userInfo ? uiRefs.userInfo.querySelector('.reset-btn') : null; // uiRefs.userInfo u≈æ m√° ID
            if (logoutBtn && logoutBtn.id === 'logoutButton') { // Kontrola, ƒçi je to spr√°vne tlaƒçidlo
                 setLoadingState(logoutBtn, false, null, "Odhl√°si≈• sa");
            }
        }

        function setupFirestoreWorkDataListener() {
            if (currentListenerUnsubscribe) currentListenerUnsubscribe();
            if (!currentUser || !navigator.onLine) {
                loadWorkDataFromLocalStorage(); return;
            }
            const docIdFs = getFirestoreDocId();
            const docRef = doc(db, 'users', currentUser.uid, 'workData', docIdFs);
            console.log(`Attaching FS listener: users/${currentUser.uid}/workData/${docIdFs}`);
            currentListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                const localKey = getLocalStorageKeyForWorkData();
                if (docSnap.exists()) {
                    const firestoreData = docSnap.data();
                    const firestoreDataString = JSON.stringify(firestoreData);
                    if (!docSnap.metadata.hasPendingWrites || firestoreDataString !== localStorage.getItem(localKey)) {
                        console.log("Applying FS work data to UI & LS.");
                        localStorage.setItem(localKey, firestoreDataString);
                        parseAndApplyWorkData(firestoreDataString);
                    } else { console.log("FS work data is local echo or matches LS."); calculateTotal(); }
                } else {
                    console.log(`Doc ${docIdFs} not in FS. Clearing LS if exists.`);
                    if (localStorage.getItem(localKey)) localStorage.removeItem(localKey);
                    parseAndApplyWorkData(null);
                }
            }, (error) => {
                console.error(`FS listener error for ${docIdFs}:`, error);
                showErrorNotification(`Chyba synchroniz√°cie: ${error.message}. Zobrazujem lok√°lne d√°ta.`);
                loadWorkDataFromLocalStorage();
            });
            syncPendingWorkData();
        }

        const _debouncedSaveWorkDataAndSync = debounce(() => {
            const dataToSave = collectWorkDataForStorage();
            const localKey = getLocalStorageKeyForWorkData();
            localStorage.setItem(localKey, JSON.stringify(dataToSave));
            updateLocalStorageSizeIndicator();
            console.log("Work data saved to LS on input/change.");
            if (currentUser && navigator.onLine) saveWorkDataToFirestore(dataToSave, getFirestoreDocId());
            else if (currentUser) { localStorage.setItem(getPendingSyncKeyForWorkData(), JSON.stringify(dataToSave)); console.log("Work data marked for pending sync.");}
            calculateTotal();
        }, 1200);
        window.debouncedSaveWorkDataAndSync = _debouncedSaveWorkDataAndSync;


        function getFirestoreDocId() { return `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`; }
        function getLocalStorageKeyForWorkData() { return currentUser ? `workData-${currentUser.uid}-${getFirestoreDocId()}` : `workData-guest-${getFirestoreDocId()}`; }
        function getPendingSyncKeyForWorkData() { return currentUser ? `pendingSync-workData-${currentUser.uid}-${getFirestoreDocId()}` : null; }

        function collectWorkDataForStorage() {
            const saveData = { data: [] }; const days = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= days; i++) {
                saveData.data.push({
                    start: document.getElementById(`start-${i}`)?.value || '',
                    end: document.getElementById(`end-${i}`)?.value || '',
                    breakTime: document.getElementById(`break-${i}`)?.value || '',
                    note: document.getElementById(`note-${i}`)?.value || ''
                });
            }
            saveData.lastUpdated = new Date().toISOString(); return saveData;
        }
        async function saveWorkDataToFirestore(dataToSave, docIdFs) {
            if (!currentUser || !navigator.onLine) return;
            const docRef = doc(db, 'users', currentUser.uid, 'workData', docIdFs);
            try {
                await setDoc(docRef, dataToSave, { merge: true }); console.log(`Work data saved to FS for ${docIdFs}`);
                const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.removeItem(pendingKey);
            } catch (error) {
                console.error('Error saving work data to FS:', error); showErrorNotification('Chyba ukladania do cloudu: ' + error.message);
                const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.setItem(pendingKey, JSON.stringify(dataToSave));
            }
        }
        async function syncPendingWorkData() {
            if (!currentUser || !navigator.onLine) return;
            const pendingKey = getPendingSyncKeyForWorkData(); if (!pendingKey) return;
            const pendingDataString = localStorage.getItem(pendingKey);
            if (pendingDataString) {
                console.log('Found pending work data, syncing...');
                try {
                    const dataToSync = JSON.parse(pendingDataString); dataToSync.lastUpdated = new Date().toISOString();
                    await saveWorkDataToFirestore(dataToSync, getFirestoreDocId()); showSaveNotification('Lok√°lne zmeny synchronizovan√©.');
                } catch (error) { console.error('Error syncing pending work data:', error); showErrorNotification('Chyba synchroniz√°cie: ' + error.message); }
            } else { console.log('No pending work data to sync.'); }
        }

        window.loadFromFirestore = async function(event) {
            const btn = event.currentTarget;
            setLoadingState(btn, true, "Naƒç√≠tavam...");
            if (!currentUser) { showErrorNotification('Mus√≠te by≈• prihl√°sen√Ω.'); setLoadingState(btn, false, null, "Naƒç√≠ta≈• z Cloudu"); return; }
            if (!navigator.onLine) { showErrorNotification('Ste offline.'); setLoadingState(btn, false, null, "Naƒç√≠ta≈• z Cloudu"); return; }
            if (!confirm('Prep√≠sa≈• lok√°lne d√°ta pre tento mesiac d√°tami z cloudu?')) { setLoadingState(btn, false, null, "Naƒç√≠ta≈• z Cloudu"); return; }
            const docIdFs = getFirestoreDocId(); const docRef = doc(db, 'users', currentUser.uid, 'workData', docIdFs);
            try {
                const docSnap = await getDoc(docRef); const localKey = getLocalStorageKeyForWorkData();
                if (docSnap.exists()) {
                    const storedData = docSnap.data(); const dataString = JSON.stringify(storedData);
                    localStorage.setItem(localKey, dataString);
                    const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.removeItem(pendingKey);
                    parseAndApplyWorkData(dataString); showSaveNotification('D√°ta naƒç√≠tan√© z cloudu.');
                } else {
                    localStorage.removeItem(localKey);
                    const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.removeItem(pendingKey);
                    parseAndApplyWorkData(null); showWarningNotification('≈Ωiadne d√°ta v cloude pre tento mesiac.');
                }
            } catch (error) { console.error('Chyba manu√°lneho naƒç√≠tania z FS:', error); showErrorNotification('Chyba naƒç√≠tania: ' + error.message); }
            finally { setLoadingState(btn, false, null, "Naƒç√≠ta≈• z Cloudu"); }
        };

        function loadWorkDataFromLocalStorage() {
            const localKey = getLocalStorageKeyForWorkData(); const localData = localStorage.getItem(localKey);
            console.log(`Loading work data from LS (key: ${localKey}). Found: ${!!localData}`);
            parseAndApplyWorkData(localData);
        }

        function parseAndApplyWorkData(dataString) {
            resetTableInputsOnly();
            if (dataString) {
                try {
                    const storedWorkData = JSON.parse(dataString);
                    if (storedWorkData.data && Array.isArray(storedWorkData.data)) {
                        const daysInTable = getDaysInMonth(currentMonth, currentYear);
                        storedWorkData.data.slice(0, daysInTable).forEach((dayData, index) => {
                            const dayNum = index + 1;
                            const startEl = document.getElementById(`start-${dayNum}`); if (startEl) startEl.value = dayData.start || '';
                            const endEl = document.getElementById(`end-${dayNum}`); if (endEl) endEl.value = dayData.end || '';
                            const breakEl = document.getElementById(`break-${dayNum}`); if (breakEl) breakEl.value = dayData.breakTime || '';
                            const noteEl = document.getElementById(`note-${dayNum}`);
                            if (noteEl) {
                                noteEl.value = dayData.note || '';
                                autoResizeTextarea(noteEl);
                            }
                            calculateRow(dayNum);
                        });
                    }
                } catch (error) {
                    console.error('Chyba parsovania pracovn√Ωch d√°t:', error);
                    showErrorNotification('Chyba spracovania d√°t: ' + error.message);
                }
            }
            calculateTotal();
        }

        function resetTableInputsOnly() {
            if (!uiRefs.workDaysTbody.hasChildNodes()) return;
            const daysInTable = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= daysInTable; i++) {
                const startEl = document.getElementById(`start-${i}`); if (startEl) startEl.value = '';
                const endEl = document.getElementById(`end-${i}`); if (endEl) endEl.value = '';
                const breakEl = document.getElementById(`break-${i}`); if (breakEl) breakEl.value = '';
                const noteEl = document.getElementById(`note-${i}`);
                if (noteEl) {
                    noteEl.value = '';
                    autoResizeTextarea(noteEl);
                }
                calculateRow(i);
            }
        }

        function createTable() {
            uiRefs.workDaysTbody.innerHTML = ''; const today = new Date();
            const currentDayInMonth = today.getDate(), currentMonthIdx = today.getMonth(), currentFullYear = today.getFullYear();
            const days = getDaysInMonth(currentMonth, currentYear);

            if (days === 0) {
                console.warn("No days in month, table not created.");
                calculateTotal();
                return;
            }

            for (let i = 1; i <= days; i++) {
                const row = uiRefs.workDaysTbody.insertRow(); const dayStr = String(i);
                const isCurrDay = (i === currentDayInMonth && currentMonth === currentMonthIdx && currentYear === currentFullYear);
                if (isCurrDay) row.classList.add('current-day');
                if (isWeekend(currentYear, currentMonth, i)) row.classList.add('weekend-day');
                row.innerHTML = `
                    <td>${i}. ${getDayName(currentYear, currentMonth, i)} ${isCurrDay ? '<span aria-hidden="true">‚≠ê</span>': ''}</td>
                    <td><div class="time-input-wrapper">
                        <input type="tel" id="start-${dayStr}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" aria-label="Pr√≠chod d≈àa ${dayStr}" onblur="window.validateAndFormatTimeBlur(this, ${i}); window.debouncedSaveWorkDataAndSync();">
                        <button class="time-btn" onclick="window.setCurrentTime('start-${dayStr}', ${i})" title="Zada≈• aktu√°lny ƒças" aria-label="Zada≈• aktu√°lny ƒças pre pr√≠chod d≈àa ${dayStr}">üïí</button>
                    </div></td>
                    <td><div class="time-input-wrapper">
                        <input type="tel" id="end-${dayStr}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" aria-label="Odchod d≈àa ${dayStr}" onblur="window.validateAndFormatTimeBlur(this, ${i}); window.debouncedSaveWorkDataAndSync();">
                        <button class="time-btn" onclick="window.setCurrentTime('end-${dayStr}', ${i})" title="Zada≈• aktu√°lny ƒças" aria-label="Zada≈• aktu√°lny ƒças pre odchod d≈àa ${dayStr}">üïí</button>
                    </div></td>
                    <td><input type="text" inputmode="decimal" id="break-${dayStr}" placeholder="hod." aria-label="Prest√°vka d≈àa ${dayStr}" oninput="window.handleNumericInput(this);" onblur="window.handleBreakInput(${i}); window.debouncedSaveWorkDataAndSync();"></td>
                    <td id="total-${dayStr}">0h 0m (${(0).toFixed(appSettings.decimalPlaces)} h)</td>
                    <td><textarea id="note-${dayStr}" placeholder="Pozn√°mka..." aria-label="Pozn√°mka ku d≈àu ${dayStr}" oninput="window.handleNoteInput(this)" onblur="window.debouncedSaveWorkDataAndSync()"></textarea></td>
                    <td><input type="number" id="gross-${dayStr}" readonly aria-label="Hrub√° mzda d≈àa ${dayStr}" value="0.00"></td>
                    <td><input type="number" id="net-${dayStr}" readonly aria-label="ƒåist√° mzda d≈àa ${dayStr}" value="0.00"></td>
                    <td style="text-align:center;">
                        <button class="btn reset-btn" style="padding:4px 6px; font-size:0.8rem;" onclick="window.resetRow(${dayStr})" aria-label="Resetova≈• de≈à ${dayStr}">X</button>
                    </td>`;
                 const startInput = row.querySelector(`#start-${dayStr}`);
                 const endInput = row.querySelector(`#end-${dayStr}`);
                 const noteTextarea = row.querySelector(`#note-${dayStr}`);

                 if(startInput) startInput.oninput = (e) => window.handleTimeInput(e.target, `end-${dayStr}`, i);
                 if(endInput) endInput.oninput = (e) => window.handleTimeInput(e.target, `break-${dayStr}`, i);
                 if(noteTextarea) noteTextarea.oninput = (e) => window.handleNoteInput(e.target);
            }
            loadWorkDataFromLocalStorage();
        }

        window.setCurrentTime = function(inputId, day) {
            const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0');
            const targetInput = document.getElementById(inputId);
            if (targetInput) {
                targetInput.value = `${hours}:${minutes}`;
                handleTimeInput(targetInput, inputId.startsWith('start-') ? `end-${day}` : `break-${day}`, day);
                validateAndFormatTimeBlur(targetInput, day);
                debouncedSaveWorkDataAndSync();
            }
        }

        window.handleTimeInput = function(input, nextId, day) {
            formatTimeInputOnly(input);
            if (input.value.length === 5 && isValidTimeFormat(input.value)) {
                calculateRow(day);
                const nextElement = document.getElementById(nextId);
                if (nextElement && document.activeElement === input && !nextId.startsWith('break-')) {
                    nextElement.focus(); if (typeof nextElement.select === 'function') nextElement.select();
                }
            } else if (input.value.length < 5) {
                calculateRow(day);
            }
        }
        window.validateAndFormatTimeBlur = function(input, day) {
            formatTimeInputOnly(input);
            const isValid = isValidTimeFormat(input.value);
            const isDefaultSettingInput = input.id.startsWith('default');

            if (isDefaultSettingInput) {
                input.classList.toggle('invalid-time', input.value.length > 0 && !isValid);
            } else {
                input.classList.toggle('invalid-time', input.value.length > 0 && !isValid);
                if (input.value.length > 0 && !isValid && day) {
                    showWarningNotification(`Neplatn√Ω form√°t ƒçasu pre ${input.id.startsWith('start') ? 'pr√≠chod' : 'odchod'} d≈àa ${day}. (HH:MM)`);
                }
                if(day) calculateRow(day);
            }
        }
        function formatTimeInputOnly(input) {
            const rawValue = input.value; let digits = rawValue.replace(/[^\d]/g, ''); let formattedValue = "";
            if (digits.length <= 2) formattedValue = digits;
            else if (digits.length <= 4) formattedValue = `${digits.substring(0,2)}:${digits.substring(2)}`;
            else formattedValue = `${digits.substring(0,2)}:${digits.substring(2,4)}`;
            if (input.value !== formattedValue) input.value = formattedValue;
        }
        window.handleBreakInput = function(day) {
            const breakInput = document.getElementById(`break-${day}`);
            let value = breakInput.value.replace(',', '.');
            const numericValue = parseFloat(value);
            breakInput.classList.remove('invalid-value');
            if (value === '' || (!isNaN(numericValue) && numericValue >= 0)) {
                breakInput.value = value;
            } else {
                breakInput.value = '';
                breakInput.classList.add('invalid-value');
                showWarningNotification(`Neplatn√° hodnota prest√°vky pre de≈à ${day}. Mus√≠ by≈• ƒç√≠slo >= 0.`);
            }
            calculateRow(day);
        }
        window.handleNoteInput = function(textarea) { autoResizeTextarea(textarea); }
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(38, textarea.scrollHeight) + 'px';
        }

        function calculateRow(day) {
            const startInput = document.getElementById(`start-${day}`);
            const endTimeInput = document.getElementById(`end-${day}`);
            const breakTimeInput = document.getElementById(`break-${day}`);
            const totalCell = document.getElementById(`total-${day}`);
            const grossInput = document.getElementById(`gross-${day}`);
            const netInput = document.getElementById(`net-${day}`);

            if (!startInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) {
                return;
            }

            const startTime = startInput.value; const endTime = endTimeInput.value;
            const breakTimeHours = parseFloat(breakTimeInput.value.replace(',', '.')) || 0;
            let decimalHours = 0;

            startInput.classList.remove('invalid-time');
            endTimeInput.classList.remove('invalid-time');
            breakTimeInput.classList.remove('invalid-value');

            if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                const [sH, sM] = startTime.split(':').map(Number); const [eH, eM] = endTime.split(':').map(Number);
                let startDate = new Date(2000,0,1,sH,sM); let endDate = new Date(2000,0,1,eH,eM);

                if (endDate < startDate && (eH < sH || (eH === sH && eM < sM))) {
                     endDate.setDate(endDate.getDate() + 1);
                } else if (endDate < startDate) {
                    endTimeInput.classList.add('invalid-time');
                }

                if (!isNaN(breakTimeHours) && breakTimeHours >=0) {
                    if (!endTimeInput.classList.contains('invalid-time') && endDate >= startDate) {
                        let diffMillis = endDate.getTime() - startDate.getTime(); let totalWorkMinutes = diffMillis / (1000 * 60);
                        totalWorkMinutes -= (breakTimeHours * 60); if (totalWorkMinutes < 0) totalWorkMinutes = 0;
                        decimalHours = totalWorkMinutes / 60;
                    }
                } else {
                    breakTimeInput.classList.add('invalid-value');
                }
            } else {
                if (startTime.length > 0 && !isValidTimeFormat(startTime)) startInput.classList.add('invalid-time');
                if (endTime.length > 0 && !isValidTimeFormat(endTime)) endTimeInput.classList.add('invalid-time');
                if (breakTimeInput.value.length > 0 && (isNaN(breakTimeHours) || breakTimeHours < 0)) breakTimeInput.classList.add('invalid-value');
            }
            const hoursPart = Math.floor(decimalHours); const minutesPart = Math.round((decimalHours - hoursPart) * 60);
            totalCell.textContent = `${hoursPart}h ${minutesPart}m (${decimalHours.toFixed(appSettings.decimalPlaces)} h)`;
            const grossSalary = decimalHours * appSettings.hourlyWage; grossInput.value = Math.max(0, grossSalary).toFixed(appSettings.decimalPlaces);
            const netSalary = grossSalary * (1 - appSettings.taxRate); netInput.value = Math.max(0, netSalary).toFixed(appSettings.decimalPlaces);
        }
        window.resetRow = function(day) {
            if (!confirm(`Naozaj chcete vymaza≈• z√°znam pre ${day}. de≈à?`)) return;
            const dayStr = String(day);
            const startEl = document.getElementById(`start-${dayStr}`); if(startEl) startEl.value = '';
            const endEl = document.getElementById(`end-${dayStr}`); if(endEl) endEl.value = '';
            const breakEl = document.getElementById(`break-${dayStr}`); if(breakEl) breakEl.value = '';
            const noteEl = document.getElementById(`note-${dayStr}`);
            if (noteEl) {
                noteEl.value = '';
                autoResizeTextarea(noteEl);
            }
            calculateRow(day);
            debouncedSaveWorkDataAndSync();
            showSaveNotification(`Z√°znam pre ${day}. de≈à bol vymazan√Ω.`);
        }

        window.clearMonthData = async function(event) {
            const btn = event.currentTarget;
            if (!confirm(`Naozaj vymaza≈• V≈†ETKY d√°ta pre ${MONTH_NAMES[currentMonth]} ${currentYear}?`)) return;
            setLoadingState(btn, true, "Mazanie...");
            resetTableInputsOnly();
            calculateTotal();

            const emptyMonthData = { data: [], lastUpdated: new Date().toISOString() };
            localStorage.setItem(getLocalStorageKeyForWorkData(), JSON.stringify(emptyMonthData));
            updateLocalStorageSizeIndicator();

            if (currentUser && navigator.onLine) {
                const docIdFs = getFirestoreDocId();
                const docRef = doc(db, 'users', currentUser.uid, 'workData', docIdFs);
                try {
                    await setDoc(docRef, emptyMonthData);
                    console.log(`Data for month ${docIdFs} effectively cleared in Firestore.`);
                    const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.removeItem(pendingKey);
                } catch (error) {
                    console.error(`Error clearing month data in FS for ${docIdFs}:`, error);
                    showErrorNotification('Chyba mazania d√°t v cloude: ' + error.message);
                    const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.setItem(pendingKey, JSON.stringify(emptyMonthData));
                }
            } else if (currentUser) {
                 const pendingKey = getPendingSyncKeyForWorkData();
                 if(pendingKey) localStorage.setItem(pendingKey, JSON.stringify(emptyMonthData));
            }
            showSaveNotification(`V≈°etky d√°ta pre ${MONTH_NAMES[currentMonth]} ${currentYear} boli vymazan√©.`);
            setLoadingState(btn, false, null, "Vymaza≈• Mesiac");
        }

        function calculateTotal() {
            let totalWorkMinutes = 0, totalGrossSalary = 0, totalNetSalary = 0, daysWithEntries = 0;
            if (!uiRefs.workDaysTbody.hasChildNodes()) {
                uiRefs.totalSalaryDiv.innerHTML = `Zapoƒç√≠tan√Ωch dn√≠: <strong>0</strong><br>
                Celkov√Ω ƒças: <strong>0h 0m</strong> (0.${'0'.repeat(appSettings.decimalPlaces)} h)<br>
                Hrub√° mzda: <strong>0.${'0'.repeat(appSettings.decimalPlaces)} ‚Ç¨</strong> | ƒåist√° mzda: <strong>0.${'0'.repeat(appSettings.decimalPlaces)} ‚Ç¨</strong><br>
                Priem. ƒçist√° mzda/de≈à: 0.${'0'.repeat(appSettings.decimalPlaces)} ‚Ç¨ | Priem. ƒças/de≈à: 0h 0m (0.${'0'.repeat(appSettings.decimalPlaces)} h)`;
                return;
            }
            const days = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= days; i++) {
                const startTime = document.getElementById(`start-${i}`)?.value;
                const endTime = document.getElementById(`end-${i}`)?.value;
                const breakTimeStr = document.getElementById(`break-${i}`)?.value;
                const noteValue = document.getElementById(`note-${i}`)?.value || "";
                let dayWorkMinutes = 0;

                if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                    const [sH, sM] = startTime.split(':').map(Number);
                    const [eH, eM] = endTime.split(':').map(Number);
                    let sDate = new Date(2000,0,1,sH,sM);
                    let eDate = new Date(2000,0,1,eH,eM);
                    if (eDate < sDate && (eH < sH || (eH === sH && eM < sM))) eDate.setDate(eDate.getDate() + 1);

                    if (eDate >= sDate) {
                        let diffMillis = eDate.getTime() - sDate.getTime();
                        dayWorkMinutes = diffMillis / (1000 * 60);
                        const breakHours = parseFloat(breakTimeStr?.replace(',', '.')) || 0;
                        if (!isNaN(breakHours) && breakHours >=0) {
                            dayWorkMinutes -= (breakHours * 60);
                        }
                        if (dayWorkMinutes < 0) dayWorkMinutes = 0;
                    }
                }
                const grossInput = document.getElementById(`gross-${i}`);
                const netInput = document.getElementById(`net-${i}`);
                const grossSalary = grossInput ? (parseFloat(grossInput.value) || 0) : 0;
                const netSalary = netInput ? (parseFloat(netInput.value) || 0) : 0;

                if (dayWorkMinutes > 0 || grossSalary > 0 || noteValue.trim() !== "") {
                    daysWithEntries++;
                }
                totalWorkMinutes += dayWorkMinutes;
                totalGrossSalary += grossSalary;
                totalNetSalary += netSalary;
            }
            const totalHoursPart = Math.floor(totalWorkMinutes / 60);
            const totalMinutesPart = Math.round(totalWorkMinutes % 60);
            const totalDecimalHours = totalWorkMinutes / 60;
            const avgNetSalary = daysWithEntries > 0 ? totalNetSalary / daysWithEntries : 0;
            const avgWorkMinutes = daysWithEntries > 0 ? totalWorkMinutes / daysWithEntries : 0;
            const avgHoursPart = Math.floor(avgWorkMinutes / 60);
            const avgMinutesPart = Math.round(avgWorkMinutes % 60);
            const avgDecimalHours = avgWorkMinutes / 60;

            uiRefs.totalSalaryDiv.innerHTML = `
                Zapoƒç√≠tan√Ωch dn√≠: <strong>${daysWithEntries}</strong><br>
                Celkov√Ω ƒças: <strong>${totalHoursPart}h ${totalMinutesPart}m</strong> (${totalDecimalHours.toFixed(appSettings.decimalPlaces)} h)<br>
                Hrub√° mzda: <strong>${totalGrossSalary.toFixed(appSettings.decimalPlaces)} ‚Ç¨</strong> | ƒåist√° mzda: <strong>${totalNetSalary.toFixed(appSettings.decimalPlaces)} ‚Ç¨</strong><br>
                Priem. ƒçist√° mzda/de≈à: ${avgNetSalary.toFixed(appSettings.decimalPlaces)} ‚Ç¨ | Priem. ƒças/de≈à: ${avgHoursPart}h ${avgMinutesPart}m (${avgDecimalHours.toFixed(appSettings.decimalPlaces)} h)`;
        }

        window.exportToPDF = async function(event) {
            const btn = event.currentTarget; setLoadingState(btn, true, "Naƒç√≠tavam PDF...");
            try {
                const { default: jsPDF } = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js');

                setLoadingState(btn, true, "Exportujem PDF..."); calculateTotal();
                const docInstance = new jsPDF();

                try { docInstance.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); docInstance.setFont('Roboto'); }
                catch (e) { console.warn("Roboto font not found for PDF, using helvetica."); docInstance.setFont('helvetica'); }
                docInstance.setFontSize(16); docInstance.text(`V√Ωkaz pr√°ce - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
                docInstance.setFontSize(12); docInstance.text(`Pracovn√≠k: ${appSettings.employeeName || 'Nezadan√©'}`, 14, 30);
                docInstance.setFontSize(10); docInstance.text(`Mzda: ${appSettings.hourlyWage.toFixed(appSettings.decimalPlaces)}‚Ç¨/h, Da≈à: ${(appSettings.taxRate * 100).toFixed(1)}%`, 14, 36);
                const tableData = []; const days = getDaysInMonth(currentMonth, currentYear);
                for (let i = 1; i <= days; i++) {
                    const dayName = getDayName(currentYear, currentMonth, i);
                    const startTime = document.getElementById(`start-${i}`)?.value || ''; const endTime = document.getElementById(`end-${i}`)?.value || '';
                    const breakTime = document.getElementById(`break-${i}`)?.value || ''; const note = document.getElementById(`note-${i}`)?.value || '';
                    const totalTimeText = document.getElementById(`total-${i}`)?.textContent.trim() || '';
                    const grossSalary = parseFloat(document.getElementById(`gross-${i}`)?.value || '0').toFixed(appSettings.decimalPlaces);
                    const netSalary = parseFloat(document.getElementById(`net-${i}`)?.value || '0').toFixed(appSettings.decimalPlaces);
                    if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) || note.trim() !== "") {
                        tableData.push([`${i}. ${dayName}`, startTime, endTime, breakTime || '0', totalTimeText, note, `${grossSalary} ‚Ç¨`, `${netSalary} ‚Ç¨`]);
                    }
                }
                docInstance.autoTable({
                    head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka', 'Odprac.', 'Pozn√°mka', 'Hrub√°', 'ƒåist√°']],
                    body: tableData, startY: 42, theme: 'grid',
                    styles: { font: docInstance.getFont().fontName || 'helvetica', fontSize: 7.5, cellPadding: 1.2, valign: 'middle' },
                    headStyles: { fillColor: [230,230,230], textColor: [0,0,0], fontStyle: 'bold', fontSize: 8, halign: 'center' },
                    columnStyles: {
                        0: { cellWidth: 16, halign: 'left' }, 1: { cellWidth: 12, halign: 'center' }, 2: { cellWidth: 12, halign: 'center' },
                        3: { cellWidth: 13, halign: 'center' }, 4: { cellWidth: 20, halign: 'center' }, 5: { cellWidth: 'auto', halign: 'left' },
                        6: { cellWidth: 16, halign: 'right' }, 7: { cellWidth: 16, halign: 'right' }
                    },
                    didParseCell: (data) => { if (data.column.index === 5) data.cell.styles.cellWidth = 'wrap'; }
                });
                const totalY = docInstance.lastAutoTable.finalY + 8; docInstance.setFontSize(9);
                const totalTextContent = uiRefs.totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/gi, '').replace(/ /g, ' ').replace(/‚Ç¨/g, 'EUR');
                docInstance.text(totalTextContent, 14, totalY);
                const safeName = (appSettings.employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                docInstance.save(`Vykaz_${safeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`); showSaveNotification('PDF vygenerovan√©.');

            } catch (error) { console.error("Error PDF export:", error); showErrorNotification("Chyba exportu PDF: " + error.message); }
            finally { setLoadingState(btn, false, null, "Exportova≈• do PDF"); }
        }

        window.sendPDF = async function(event) {
            const btn = event.currentTarget; setLoadingState(btn, true, "Naƒç√≠tavam PDF...");
             try {
                const { default: jsPDF } = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js');

                setLoadingState(btn, true, "Pripravujem PDF..."); calculateTotal();
                const docInstance = new jsPDF();
                try { docInstance.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); docInstance.setFont('Roboto'); }
                catch (e) { console.warn("Roboto font not found for PDF, using helvetica."); docInstance.setFont('helvetica'); }
                docInstance.setFontSize(16); docInstance.text(`Doch√°dzka - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
                docInstance.setFontSize(12); docInstance.text(`Pracovn√≠k: ${appSettings.employeeName || 'Nezadan√©'}`, 14, 30);
                const workedDaysMatch = (uiRefs.totalSalaryDiv.textContent || "").match(/Zapoƒç√≠tan√Ωch dn√≠:\s*(\d+)/i);
                const workedDaysCount = workedDaysMatch && workedDaysMatch[1] ? parseInt(workedDaysMatch[1]) : 0;
                docInstance.setFontSize(10); docInstance.text(`Odpracovan√© dni: ${workedDaysCount}`, 14, 36);
                const tableData = []; const days = getDaysInMonth(currentMonth, currentYear);
                for (let i = 1; i <= days; i++) {
                    const dayName = getDayName(currentYear, currentMonth, i);
                    const startTime = document.getElementById(`start-${i}`)?.value || ''; const endTime = document.getElementById(`end-${i}`)?.value || '';
                    const breakTime = document.getElementById(`break-${i}`)?.value || ''; const note = document.getElementById(`note-${i}`)?.value || '';
                    if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) || note.trim() !== "") {
                        tableData.push([`${i}. ${dayName}`, startTime, endTime, breakTime || '0', note]);
                    }
                }
                docInstance.autoTable({
                    head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka', 'Pozn√°mka']], body: tableData, startY: 42, theme: 'grid',
                    styles: { font: docInstance.getFont().fontName || 'helvetica', fontSize: 8.5, cellPadding: 1.8, valign: 'middle' },
                    headStyles: { fillColor: [230,230,230], textColor: [0,0,0], fontStyle: 'bold', fontSize: 9, halign: 'center'},
                    columnStyles: { 0: { cellWidth: 28 }, 1: { cellWidth: 22, halign: 'center' }, 2: { cellWidth: 22, halign: 'center' }, 3: { cellWidth: 22, halign: 'center' }, 4: { cellWidth: 'auto' }},
                    didParseCell: (data) => { if (data.column.index === 4) data.cell.styles.cellWidth = 'wrap'; }
                });
                const pdfBlob = docInstance.output('blob'); const safeName = (appSettings.employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                const pdfFileName = `Dochadzka_${safeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`;
                const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
                if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    await navigator.share({ files: [pdfFile], title: `Doch√°dzka ${MONTH_NAMES[currentMonth]} ${currentYear}`, text: `Z√°znam doch√°dzky.` });
                } else { showWarningNotification('Zdieƒæanie nie je podporovan√©. S√∫bor sa stiahne.'); docInstance.save(pdfFileName); }

            } catch (error) { if (error.name !== 'AbortError') { console.error('Chyba zdieƒæania/generovania PDF:', error); showErrorNotification('Chyba zdieƒæania PDF: ' + error.message); } else { console.log('Zdieƒæanie zru≈°en√©.'); }}
            finally { setLoadingState(btn, false, null, "Odosla≈• PDF (s pozn.)"); }
        }

        window.createBackup = async function(event) {
            const btn = event.currentTarget; setLoadingState(btn, true, "Naƒç√≠tavam XLSX...");
            try {
                const XLSX_lib = await import('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js');
                setLoadingState(btn, true, "Vytv√°ram z√°lohu...");
                const workData = collectWorkDataForStorage();
                if (!workData.data.some(d => d.start || d.end || d.breakTime || d.note) && !appSettings.employeeName) {
                    showWarningNotification('≈Ωiadne d√°ta na z√°lohu.'); setLoadingState(btn, false, null, "Vytvori≈• z√°lohu (XLSX)"); return;
                }

                const wb = XLSX_lib.utils.book_new();
                const settings_ws_data = [["Nastavenie", "Hodnota"]];
                Object.entries(appSettings).forEach(([key, value]) => settings_ws_data.push([key, value]));
                const settings_ws = XLSX_lib.utils.aoa_to_sheet(settings_ws_data);
                settings_ws['!cols'] = [{wch:25}, {wch:30}];
                XLSX_lib.utils.book_append_sheet(wb, settings_ws, "NastaveniaAplikacie");

                const work_ws_data = [["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka"]];
                if (workData.data && Array.isArray(workData.data)) {
                    workData.data.forEach((row, index) => {
                        work_ws_data.push([`${index + 1}. ${getDayName(currentYear, currentMonth, index + 1)}`, row.start || "", row.end || "", row.breakTime || "", row.note || ""]);
                    });
                }
                work_ws_data.push([]); work_ws_data.push(["Mesiac z√°lohy (index)", currentMonth]); work_ws_data.push(["Rok z√°lohy", currentYear]);
                const work_ws = XLSX_lib.utils.aoa_to_sheet(work_ws_data);
                work_ws['!cols'] = [{wch:15}, {wch:10}, {wch:10}, {wch:15}, {wch:40}];
                XLSX_lib.utils.book_append_sheet(wb, work_ws, `Vykaz ${MONTH_NAMES[currentMonth]} ${currentYear}`);

                const safeName = (appSettings.employeeName || 'Vseobecna').replace(/[^a-zA-Z0-9]/g, '_');
                XLSX_lib.writeFile(wb, `Zaloha_BrunoCalcPro_${safeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.xlsx`);
                showSaveNotification('Z√°loha vytvoren√°.');

            } catch(error) { console.error('Chyba vytv√°rania z√°lohy:', error); showErrorNotification('Chyba z√°lohy: ' + error.message); }
            finally { setLoadingState(btn, false, null, "Vytvori≈• z√°lohu (XLSX)"); }
        };

        window.restoreBackup = function(event) {
            const btn = event.currentTarget;
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.xlsx';
            input.onchange = async (eventFile) => {
                setLoadingState(btn, true, "Naƒç√≠tavam XLSX...");
                const file = eventFile.target.files[0];
                if (!file) { setLoadingState(btn, false, null, "Obnovi≈• z√°lohu (XLSX)"); return; }

                try {
                    const XLSX_lib = await import('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js');
                    setLoadingState(btn, true, "Sprac√∫vam s√∫bor...");
                    const reader = new FileReader();
                    reader.onload = async (e_reader) => {
                        try {
                            const fileData = new Uint8Array(e_reader.target.result); const workbook = XLSX_lib.read(fileData, {type:'array'});
                            let restoredAppSettings = {}, restoredWorkData = { data: [] }, backupMonth = currentMonth, backupYear = currentYear;

                            const settingsSheetName = workbook.SheetNames.find(name => name.toLowerCase().includes("nastaveniaaplikacie"));
                            if (settingsSheetName) {
                                const ws = workbook.Sheets[settingsSheetName]; const jsonData = XLSX_lib.utils.sheet_to_json(ws, { header: 1, defval: "" });
                                for (let i = 1; i < jsonData.length; i++) {
                                    const row = jsonData[i]; if (row && row[0] && appSettings.hasOwnProperty(row[0])) {
                                        const key = row[0]; let value = row[1];
                                        if (['hourlyWage', 'taxRate'].includes(key)) value = parseFloat(value) || appSettings[key];
                                        else if (key === 'decimalPlaces') value = parseInt(value) || appSettings[key];
                                        else if (key === 'employeeName') value = String(value);
                                        restoredAppSettings[key] = value;
                                    }
                                }
                            } else { showWarningNotification("List 'NastaveniaAplikacie' nen√°jden√Ω v z√°lohe. Nastavenia nebud√∫ obnoven√©."); }

                            const workSheetName = workbook.SheetNames.find(name => name.toLowerCase().startsWith("vykaz"));
                            if (workSheetName) {
                                const ws = workbook.Sheets[workSheetName]; const jsonData = XLSX_lib.utils.sheet_to_json(ws, { header: 1, defval: "" });
                                const headerRowIndex = jsonData.findIndex(row => row && row[0] && row[0].toString().toLowerCase().includes("de≈à"));
                                if (headerRowIndex !== -1) {
                                    const colMap = { day: 0, start: 1, end: 2, break: 3, note: 4 };
                                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                                        const row = jsonData[i]; if (!row || !row[colMap.day] || !row[colMap.day].toString().match(/^\d+\./)) {
                                            if (row && row[0] && row[0].toString().toLowerCase().includes("mesiac z√°lohy")) backupMonth = parseInt(row[1]) ?? currentMonth;
                                            if (row && row[0] && row[0].toString().toLowerCase().includes("rok z√°lohy")) backupYear = parseInt(row[1]) ?? currentYear;
                                            continue;
                                        }
                                        restoredWorkData.data.push({ start: row[colMap.start] || "", end: row[colMap.end] || "", breakTime: row[colMap.break] ? row[colMap.break].toString().replace(',', '.') : "", note: row[colMap.note] || ""});
                                    }
                                } else { showWarningNotification(`List s d√°tami mesiaca (${workSheetName}) nem√° spr√°vnu hlaviƒçku.`); }
                            } else { showWarningNotification("List s d√°tami mesiaca nen√°jden√Ω. D√°ta mesiaca nebud√∫ obnoven√©."); }

                            if (Object.keys(restoredAppSettings).length === 0 && restoredWorkData.data.length === 0) {
                                showErrorNotification("Z√°loha neobsahuje ≈æiadne platn√© d√°ta na obnovu."); return;
                            }
                            if (!confirm(`Obnovi≈• nastavenia (${Object.keys(restoredAppSettings).length} polo≈æiek) a d√°ta pre ${MONTH_NAMES[backupMonth]} ${backupYear} (${restoredWorkData.data.length} dn√≠)?`)) {
                                return;
                            }

                            if (Object.keys(restoredAppSettings).length > 0) {
                                Object.assign(appSettings, restoredAppSettings);
                                Object.entries(appSettings).forEach(([key, value]) => localStorage.setItem(key, value));
                                updateSettingsUIInputs(); await saveAppSettingsToFirestore();
                            }
                            if (restoredWorkData.data.length > 0 || (workSheetName && restoredWorkData.data.length === 0)) {
                                if (backupMonth !== currentMonth || backupYear !== currentYear) {
                                    currentMonth = backupMonth; currentYear = backupYear;
                                    uiRefs.monthSelect.value = currentMonth; uiRefs.yearSelect.value = currentYear;
                                    createTable();
                                }
                                const workDataString = JSON.stringify({ ...restoredWorkData, lastUpdated: new Date().toISOString() });
                                localStorage.setItem(getLocalStorageKeyForWorkData(), workDataString);
                                const pendingKey = getPendingSyncKeyForWorkData(); if (pendingKey) localStorage.removeItem(pendingKey);
                                parseAndApplyWorkData(workDataString);
                                if (currentUser && navigator.onLine) await saveWorkDataToFirestore(JSON.parse(workDataString), getFirestoreDocId());
                            }
                            showSaveNotification('Z√°loha √∫spe≈°ne obnoven√°.');
                        } catch (error) { console.error('Chyba naƒç√≠tania z√°lohy:', error); showErrorNotification('Chyba naƒç√≠tania z√°lohy: ' + error.message); }
                        finally {
                           setLoadingState(btn, false, null, "Obnovi≈• z√°lohu (XLSX)");
                           input.value = '';
                        }
                    };
                    reader.onerror = () => {
                        showErrorNotification('Chyba ƒç√≠tania s√∫boru.');
                        setLoadingState(btn, false, null, "Obnovi≈• z√°lohu (XLSX)");
                    }
                    reader.readAsArrayBuffer(file);

                } catch (libError) {
                    console.error('Chyba naƒç√≠tania XLSX kni≈ænice:', libError);
                    showErrorNotification('Nepodarilo sa naƒç√≠ta≈• kni≈ænicu pre spracovanie z√°lohy.');
                    setLoadingState(btn, false, null, "Obnovi≈• z√°lohu (XLSX)");
                    input.value = '';
                }
            };
            input.click();
        };


        window.changeMonth = function() {
            currentMonth = parseInt(uiRefs.monthSelect.value);
            createTable();
            setupFirestoreWorkDataListener();
            updatePageTitleAndGreeting();
        }
        window.changeYear = function() {
            currentYear = parseInt(uiRefs.yearSelect.value);
            createTable();
            setupFirestoreWorkDataListener();
            updatePageTitleAndGreeting();
        }

        // Priradenie listenerov k tlaƒçidl√°m
        document.getElementById('loginButton').addEventListener('click', (event) => window.loginUser(event));
        document.getElementById('registerButton').addEventListener('click', (event) => window.registerUser(event));
        document.getElementById('resetPasswordLink').addEventListener('click', (event) => {
            event.preventDefault();
            window.resetUserPassword();
        });
        document.getElementById('logoutButton').addEventListener('click', (event) => window.logoutUser(event));
        document.getElementById('toggleSettingsBtn').addEventListener('click', () => { // Tento nepotrebuje event pre funkciu
            const isVisible = uiRefs.settingsCollapsibleContent.classList.toggle('visible');
            uiRefs.toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia aplik√°cie ‚ñ≤' : 'Zobrazi≈• nastavenia aplik√°cie ‚ñº';
            uiRefs.toggleSettingsBtn.setAttribute('aria-expanded', isVisible);
        });
        document.getElementById('exportPdfButton').addEventListener('click', (event) => window.exportToPDF(event));
        document.getElementById('sendPdfButton').addEventListener('click', (event) => window.sendPDF(event));
        document.getElementById('createBackupButton').addEventListener('click', (event) => window.createBackup(event));
        document.getElementById('restoreBackupButton').addEventListener('click', (event) => window.restoreBackup(event));
        document.getElementById('loadFromCloudButton').addEventListener('click', (event) => window.loadFromFirestore(event));
        document.getElementById('clearMonthButton').addEventListener('click', (event) => window.clearMonthData(event));


        window.addEventListener('online', () => { handleOnlineStatusChange(true); syncPendingWorkData(); if(currentUser) saveAppSettingsToFirestore(); });
        window.addEventListener('offline', () => handleOnlineStatusChange(false));
        function handleOnlineStatusChange(online) {
            const message = online ? 'Ste online.' : 'Ste offline. Zmeny sa ulo≈æia lok√°lne.';
            showNotification(online ? 'saveNotification' : 'warningNotification', message, online ? 3000: 4000);
        }

        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed. User:', user ? user.email : 'None');
            currentUser = user;
            updateUIForAuthStateChange();

            if (user) {
                const settingsLoadedFromFS = await loadUserAppSettingsFromFirestore();
                if (!settingsLoadedFromFS) {
                    loadAppSettingsFromLocalStorage();
                    updateSettingsUIInputs();
                    await saveAppSettingsToFirestore();
                }
            } else {
                loadAppSettingsFromLocalStorage();
                updateSettingsUIInputs();
            }
            createTable();
            setupFirestoreWorkDataListener();
            updatePageTitleAndGreeting();
        });

        initializeUI();
    }

    document.addEventListener('DOMContentLoaded', setupAndRunApp);

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('ServiceWorker Registered. Scope: ', reg.scope))
          .catch(err => console.error('ServiceWorker Reg Failed: ', err));
      });
    }
  </script>
</body>
</html>
