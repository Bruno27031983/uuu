<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <!-- Odporúčanie: Presunúť CSS do externého súboru style.css -->
  <!-- <link rel="stylesheet" href="style.css"> -->

  <style>
    /* --- Základné štýly (Bez veľkých zmien, len drobnosti) --- */
    :root {
      --primary-bg: #f4f4f4;
      --secondary-bg: white;
      --text-color: #333;
      --input-bg: #ffffd0;
      --input-border: #ccc;
      --table-border: #ddd;
      --header-bg: #f2f2f2;
      --button-reset-bg: #f44336;
      --button-reset-hover: #d32f2f;
      --button-export-bg: #4CAF50;
      --button-export-hover: #388e3c;
      --button-backup-bg: #8a2be2;
      --button-backup-hover: #6a1bb2;
      --highlight-bg: #ffcc00;
      --total-bg: #e6f3ff;
      --notification-success-bg: #4CAF50;
      --notification-error-bg: #f44336;
      --current-day-bg: #8a2be2;
      --current-day-text: white;
      --current-day-input-bg: #9932cc;
      --current-day-input-text: white;
    }

    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--primary-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--secondary-bg);
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555; /* Tento odtieň môže byť fixný alebo viazaný na premennú */
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px; /* Lepšie ako marginy pre flex */
    }
    .settings > div {
      flex: 1 1 200px;
      /* margin: 5px; Nahradené gap */
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Zachované pre layout */
      background-color: var(--secondary-bg); /* Pre tmavý režim */
    }
    th, td {
      padding: 8px;
      border: 1px solid var(--table-border);
      text-align: left;
      font-size: 0.9em;
      transition: background-color 0.3s, color 0.3s;
    }
    th {
      background-color: var(--header-bg);
      font-weight: bold;
    }
    /* Šírky stĺpcov ponechané */
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) { width: 25%; }
    th:nth-child(1), td:nth-child(1), th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3), th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5), th:nth-child(8), td:nth-child(8) { width: 8.33%; }

    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      background-color: var(--input-bg);
      color: var(--text-color); /* Zdedí z body */
      font-size: 14px;
      border: 1px solid var(--input-border);
      border-radius: 3px;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    /* Vylepšenie pre neplatný vstup */
    input:invalid {
        border-color: var(--button-reset-bg);
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Centrovanie tlačidiel */
      gap: 10px; /* Medzery */
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px; /* Zachovaný flex pre responzivitu */
      padding: 10px 15px; /* Upravený padding */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      text-align: center;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    .btn:active {
        transform: scale(0.98); /* Efekt stlačenia */
    }
    .reset-btn { background-color: var(--button-reset-bg); }
    .reset-btn:hover { background-color: var(--button-reset-hover); }
    .export-btn { background-color: var(--button-export-bg); }
    .export-btn:hover { background-color: var(--button-export-hover); }
    .backup-btn { background-color: var(--button-backup-bg); }
    .backup-btn:hover { background-color: var(--button-backup-hover); }

    .highlight { /* Použité pre dark mode toggle */
      background-color: var(--highlight-bg);
      color: #333;
      font-weight: bold;
    }
    #totalSalary {
      font-size: 1.1em; /* Relatívna veľkosť */
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background-color: var(--total-bg);
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    /* Data size bar - ponechané bez zmien */
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }

    .current-day {
      background-color: var(--current-day-bg) !important; /* !important pre istotu */
      color: var(--current-day-text) !important;
    }
    .current-day input, .current-day select {
      background-color: var(--current-day-input-bg) !important;
      color: var(--current-day-input-text) !important;
      border-color: var(--current-day-bg) !important;
    }
    .current-day .btn { /* Prispôsobenie reset tlačidla v aktuálnom dni */
        background-color: var(--button-reset-hover);
    }

    /* --- Tmavý režim --- */
    body.dark-mode {
      --primary-bg: #333;
      --secondary-bg: #444;
      --text-color: #f4f4f4;
      --input-bg: #666;
      --input-border: #888;
      --table-border: #666;
      --header-bg: #555;
      --total-bg: #2c3e50;
      --button-reset-bg: #d32f2f;
      --button-reset-hover: #b71c1c;
      --button-export-bg: #388e3c;
      --button-export-hover: #2e7d32;
      --button-backup-bg: #6a1bb2;
      --button-backup-hover: #4a148c;
      --current-day-bg: #4a0e8f;
      --current-day-input-bg: #5c1db3;
    }
    body.dark-mode h2 { color: #ccc; }
    body.dark-mode .highlight { background-color: #e0b800; color: #222; }
    body.dark-mode #dataSizeText { color: #bbb; }
    body.dark-mode #dataSizeBar { background-color: #555; }

    /* --- Animácie --- */
    @keyframes gradientText { /* Bez zmien */ }
    @keyframes textShadowPulse { /* Bez zmien */ }

    /* --- Responzivita (Drobné úpravy pre gap) --- */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      /* settings > div už má flex: 1 1 auto */
      table { min-width: 800px; } /* Zachované */
      th, td { padding: 6px; font-size: 0.8em; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { font-size: 14px; padding: 8px 16px; }
      /* backup-btn padding nepotrebuje špeciálne pravidlo */
      #totalSalary { font-size: 1em; }
      #dataSizeContainer { font-size: 12px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 12px; padding: 5px;}
      table { min-width: 800px; } /* Zachované */
    }

    /* --- Notifikácie --- */
    .notification {
      display: none; /* Skryté defaultne */
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1001; /* Nad ostatnými prvkami */
      opacity: 0;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      transform: translateY(20px);
      color: white;
    }
    .notification.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    #saveNotification { background-color: var(--notification-success-bg); }
    #errorNotification { background-color: var(--notification-error-bg); }
    #statusNotification { /* Pre online/offline status */
       background-color: grey; /* Default farba */
       top: 20px;
       bottom: auto;
       z-index: 1002;
    }

    /* --- Auth UI --- */
    .auth-section { text-align: center; margin-bottom: 20px; }
    #login-form { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    #login-form input[type="email"],
    #login-form input[type="password"] { width: 250px; max-width: 90%; }
    #login-form .btn { width: 150px; flex-grow: 0; flex-shrink: 0; flex-basis: auto; } /* Fixná šírka pre login/reg */
    #user-info { display: flex; align-items: center; justify-content: center; gap: 15px; }
    #user-email { font-weight: bold; }

    /* Pomocná trieda na skrývanie */
    .hidden { display: none !important; }

  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container" class="auth-section">
      <!-- Použitie triedy .hidden namiesto inline štýlu -->
      <div id="login-form" class="hidden">
        <input type="email" id="email" placeholder="Email" autocomplete="email">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div> <!-- Kontajner pre tlačidlá vedľa seba -->
            <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
            <button class="btn export-btn" onclick="register()">Registrovať</button>
        </div>
      </div>
      <div id="user-info" class="hidden">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="employeeSubtitle"></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <!-- Generované JS -->
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Generované JS -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinné miesta:</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2" selected>2</option> <!-- Default 2 miesta pre peniaze -->
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight" title="Prepínať svetlý/tmavý režim">Tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary">Celkové súčty sa načítavajú...</div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Export PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zo zálohy (.xlsx)</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu (.xlsx)</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Načítať z cloudu</button>
    </div>
  </div>

  <!-- Notifikačné elementy -->
  <div id="saveNotification" class="notification">Dáta uložené.</div>
  <div id="errorNotification" class="notification">Chyba.</div>
  <div id="statusNotification" class="notification">Status.</div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // DÔLEŽITÉ: Firestore bezpečnostné pravidlá na strane servera sú kľúčové!
    // Zabezpečte, aby užívatelia mohli čítať/písať iba svoje vlastné dáta.
    // Príklad pravidla (rules.json):
    // {
    //   "rules": {
    //     "users": {
    //       "$uid": {
    //         // Užívateľ môže čítať/písať iba svoje dokumenty
    //         ".read": "request.auth != null && request.auth.uid == $uid",
    //         ".write": "request.auth != null && request.auth.uid == $uid",
    //         "workDays": {
    //            "$monthDoc": {
    //              // Dedi pravidlá zhora (read/write pre vlastníka)
    //            }
    //         }
    //       }
    //     }
    //   }
    // }
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Zvážte použitie environment variables alebo inej metódy pre produkciu
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.appspot.com", // Oprava: .appspot.com pre storage
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Váš ReCaptcha kľúč
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------------------- KONŠTANTY --------------------
    const LS_KEYS = {
        DARK_MODE: 'darkMode',
        DECIMAL_PLACES: 'decimalPlaces',
        EMPLOYEE_NAME: 'employeeName',
        WORK_DATA_PREFIX: 'workData-',
        PENDING_SYNC_PREFIX: 'pendingSync-'
    };
    const CSS_CLASSES = {
        DARK_MODE: 'dark-mode',
        HIDDEN: 'hidden',
        CURRENT_DAY: 'current-day',
        NOTIFICATION_SHOW: 'show'
    };
    const MONTH_NAMES = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
    const DAYS_OF_WEEK = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; // Skrátené pre tabuľku

    // -------------------- DOM Elementy --------------------
    const Elements = {
        body: document.body,
        workDaysTbody: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        mainTitle: document.getElementById('mainTitle'),
        employeeSubtitle: document.getElementById('employeeSubtitle'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        saveNotification: document.getElementById('saveNotification'),
        errorNotification: document.getElementById('errorNotification'),
        statusNotification: document.getElementById('statusNotification'),
        loginForm: document.getElementById('login-form'),
        userInfo: document.getElementById('user-info'),
        userEmailSpan: document.getElementById('user-email'),
        emailInput: document.getElementById('email'),
        passwordInput: document.getElementById('password')
    };

    // -------------------- GLOBÁLNY STAV APLIKÁCIE --------------------
    let currentUser = null;
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem(LS_KEYS.DECIMAL_PLACES)) || 2; // Default 2
    let employeeName = localStorage.getItem(LS_KEYS.EMPLOYEE_NAME) || '';
    let hourlyWage = parseFloat(Elements.hourlyWageInput.value); // Načíta sa z inputu pri štarte
    let taxRate = parseFloat(Elements.taxRateInput.value) / 100; // Načíta sa z inputu pri štarte
    let debounceTimer = null; // Pre debounce ukladania

    // -------------------- INICIALIZÁCIA UI --------------------

    function initializeUI() {
        // Tmavý režim
        if (localStorage.getItem(LS_KEYS.DARK_MODE) === 'true') {
            Elements.body.classList.add(CSS_CLASSES.DARK_MODE);
        }
        // Výber mesiacov
        MONTH_NAMES.forEach((name, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            Elements.monthSelect.appendChild(option);
        });
        // Výber rokov
        populateYearSelect();

        // Nastavenie aktuálnych hodnôt v selectoch a inputoch
        Elements.monthSelect.value = currentMonth;
        Elements.yearSelect.value = currentYear;
        Elements.decimalPlacesSelect.value = decimalPlaces;
        Elements.employeeNameInput.value = employeeName;
        updateEmployeeSubtitle(); // Zobrazí meno v podnadpise

        // Počiatočné naviazanie listenerov (okrem inline onclick)
        window.addEventListener('online', handleOnlineStatus);
        window.addEventListener('offline', handleOnlineStatus);
        handleOnlineStatus(); // Skontroluj status pri štarte
    }

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = currentDate.getFullYear() + 2; // Pár rokov do budúcna
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        Elements.yearSelect.appendChild(option);
      }
      Elements.yearSelect.value = currentYear; // Predvolený aktuálny rok
    }

    // -------------------- ONLINE/OFFLINE STATUS --------------------
    function isOnline() {
      return navigator.onLine;
    }

    function handleOnlineStatus() {
        const online = isOnline();
        console.log(`Status zmenený: ${online ? 'Online' : 'Offline'}`);
        showStatusNotification(online ? 'Pripojené' : 'Offline', online ? 'green' : 'grey');
        if (online) {
            // Ak sme prešli do online, skúsime synchronizovať čakajúce dáta
            syncWithFirebase();
        }
    }

    function showStatusNotification(message, color) {
        Elements.statusNotification.textContent = message;
        Elements.statusNotification.style.backgroundColor = color;
        Elements.statusNotification.classList.add(CSS_CLASSES.NOTIFICATION_SHOW);
        // Notifikácia zmizne po 5 sekundách
        setTimeout(() => {
            Elements.statusNotification.classList.remove(CSS_CLASSES.NOTIFICATION_SHOW);
        }, 5000);
    }

    function showNotification(element, message, duration = 3000) {
      element.textContent = message;
      element.classList.add(CSS_CLASSES.NOTIFICATION_SHOW);
      setTimeout(() => {
        element.classList.remove(CSS_CLASSES.NOTIFICATION_SHOW);
      }, duration);
    }
    const showErrorNotification = (msg) => showNotification(Elements.errorNotification, msg, 4000);
    const showSaveNotification = (msg = 'Dáta úspešne uložené.') => showNotification(Elements.saveNotification, msg, 2000);

    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    window.login = async function() { // Priradenie k window pre onclick
      if (!isOnline()) return showErrorNotification('Ste offline. Prihlásenie vyžaduje internetové pripojenie.');

      const email = Elements.emailInput.value;
      const password = Elements.passwordInput.value;
      if (!email || !password) return showErrorNotification('Zadajte email aj heslo.');

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // currentUser sa nastaví cez onAuthStateChanged listener
        console.log('Prihlásenie úspešné');
        // updateUI sa zavolá cez onAuthStateChanged
      } catch (error) {
        console.error('Chyba pri prihlásení:', error);
        showErrorNotification(`Chyba pri prihlásení: ${mapAuthError(error.code)}`);
      }
    }

    window.register = async function() { // Priradenie k window pre onclick
      if (!isOnline()) return showErrorNotification('Ste offline. Registrácia vyžaduje internetové pripojenie.');

      const email = Elements.emailInput.value;
      const password = Elements.passwordInput.value;
      if (!email || !password) return showErrorNotification('Zadajte email aj heslo.');
      if (password.length < 6) return showErrorNotification('Heslo musí mať aspoň 6 znakov.');

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // currentUser sa nastaví cez onAuthStateChanged listener
        console.log('Registrácia úspešná');
        // Vytvorenie počiatočnej štruktúry v DB pre nového užívateľa
        await createUserCollection(userCredential.user);
        // updateUI sa zavolá cez onAuthStateChanged
      } catch (error) {
        console.error('Chyba pri registrácii:', error);
        showErrorNotification(`Chyba pri registrácii: ${mapAuthError(error.code)}`);
      }
    }

    window.logout = async function() { // Priradenie k window pre onclick
      try {
        await signOut(auth);
        // currentUser sa nastaví na null cez onAuthStateChanged
        console.log('Odhlásenie úspešné');
        // updateUI sa zavolá cez onAuthStateChanged
      } catch (error) {
        console.error('Chyba pri odhlásení:', error);
        showErrorNotification('Chyba pri odhlásení.');
      }
    }

    async function createUserCollection(user) {
      if (user) {
        try {
            const userRef = doc(db, 'users', user.uid);
            // Zapíše základné info, ak ešte neexistuje (merge=true by tiež fungovalo)
            await setDoc(userRef, {
              email: user.email,
              createdAt: new Date()
            }, { merge: true }); // Merge pre istotu, ak by už existovalo

            // Môžeme vytvoriť aj prvý dokument v subkolekcii, aby existovala
            const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup');
            await setDoc(initialDocRef, { setupComplete: true });
            console.log('Firestore štruktúra pre nového užívateľa vytvorená.');
        } catch(error) {
            console.error('Nepodarilo sa vytvoriť Firestore štruktúru pre užívateľa:', error);
            // Zvážiť, či zobraziť chybu užívateľovi
        }
      }
    }

    function mapAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatný formát emailu.';
            case 'auth/user-not-found': return 'Užívateľ s týmto emailom neexistuje.';
            case 'auth/wrong-password': return 'Nesprávne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je už registrovaný.';
            case 'auth/weak-password': return 'Heslo je príliš slabé (min. 6 znakov).';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            default: return 'Nastala neznáma chyba.';
        }
    }

    // -------------------- UI Update a Logika Načítania --------------------
    function updateAuthUI() {
        if (currentUser) {
            Elements.loginForm.classList.add(CSS_CLASSES.HIDDEN);
            Elements.userInfo.classList.remove(CSS_CLASSES.HIDDEN);
            Elements.userEmailSpan.textContent = `Prihlásený: ${currentUser.email}`;
        } else {
            Elements.loginForm.classList.remove(CSS_CLASSES.HIDDEN);
            Elements.userInfo.classList.add(CSS_CLASSES.HIDDEN);
            Elements.userEmailSpan.textContent = '';
            Elements.emailInput.value = ''; // Vyčistiť polia po odhlásení
            Elements.passwordInput.value = '';
        }
    }

    // Hlavná funkcia, ktorá sa volá pri zmene stavu Auth alebo pri zmene mesiaca/roka
    async function refreshDataAndView() {
        console.log(`Obnovujem dáta a pohľad pre ${getMonthName(currentMonth)} ${currentYear}`);
        updateAuthUI(); // Aktualizuje login/logout sekciu
        createTableStructure(); // Vytvorí prázdnu štruktúru tabuľky

        // Načíta dáta (priorita: LocalStorage -> Firestore -> prázdne)
        await loadDataForCurrentMonth();
    }

    // Načítanie dát pre aktuálne zvolený mesiac/rok
    async function loadDataForCurrentMonth() {
        const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
        const localDataString = localStorage.getItem(localKey);
        const pendingSyncKey = getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX);
        const hasPendingSync = localStorage.getItem(pendingSyncKey) !== null;

        if (localDataString) {
            console.log('Načítavam údaje z Local Storage.');
            parseAndApplyData(localDataString);
            // Ak sú dáta v LS a čakajú na synchronizáciu, upozorníme (alebo to rieši syncWithFirebase)
            if (hasPendingSync && isOnline() && currentUser) {
                console.log('Existujú dáta čakajúce na synchronizáciu.');
                syncWithFirebase(); // Skúsi odoslať hneď
            }
             // Voliteľné: Skontrolovať, či sa cloud nelíši, ak sme online a prihlásení
             // if (isOnline() && currentUser && !hasPendingSync) checkCloudForUpdates();
        } else if (isOnline() && currentUser) {
            console.log('Local Storage prázdny, načítavam z Firestore.');
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const storedData = docSnap.data();
                    console.log('Dáta nájdené vo Firestore, aplikujem a ukladám do Local Storage.');
                    const dataString = JSON.stringify(storedData);
                    localStorage.setItem(localKey, dataString); // Uložíme do LS
                    parseAndApplyData(dataString);
                } else {
                    console.log('Žiadne údaje vo Firestore pre tento mesiac.');
                    calculateTotal(); // Vypočíta nuly pre prázdnu tabuľku
                }
            } catch (error) {
                console.error('Chyba pri načítavaní z Firestore:', error);
                showErrorNotification('Chyba pri načítavaní dát z cloudu.');
                calculateTotal(); // Zobrazí prázdny súčet
            }
        } else {
            console.log('Žiadne lokálne ani cloudové dáta (alebo offline/neprihlásený).');
            calculateTotal(); // Vypočíta nuly pre prázdnu tabuľku
        }
    }

    // Funkcia pre manuálne načítanie z Firestore (tlačidlo)
    window.loadFromFirestore = async function() { // Priradenie k window pre onclick
        if (!currentUser) return showErrorNotification('Pre načítanie z cloudu sa musíte prihlásiť.');
        if (!isOnline()) return showErrorNotification('Ste offline. Načítanie z cloudu vyžaduje pripojenie.');

        if (!confirm('Naozaj chcete načítať dáta z cloudu? Týmto prepíšete všetky lokálne neuložené zmeny pre tento mesiac.')) {
            return; // Používateľ zrušil
        }

        console.log('Manuálne vyžiadané načítanie údajov z Firestore');
        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const storedData = docSnap.data();
                const dataString = JSON.stringify(storedData);

                console.log('Prepisujem lokálne dáta dátami z Firestore a ukladám do localStorage.');
                const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
                localStorage.setItem(localKey, dataString);
                // Odstránime príznak čakajúcej synchronizácie, ak existoval
                localStorage.removeItem(getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX));

                parseAndApplyData(dataString); // Aplikujeme načítané dáta
                showSaveNotification('Dáta boli úspešne načítané z cloudu.');
            } else {
                console.log('Žiadne údaje v Firestore pre tento mesiac na načítanie.');
                showErrorNotification('Pre tento mesiac neboli v cloude nájdené žiadne dáta.');
            }
        } catch (error) {
            console.error('Chyba pri manuálnom načítavaní z Firestore:', error);
            showErrorNotification('Chyba pri načítavaní dát z cloudu: ' + error.message);
        }
    }

    // Spracovanie JSON stringu a aplikovanie dát do UI a stavu
    function parseAndApplyData(dataString) {
        try {
            const storedData = JSON.parse(dataString);

            // Aktualizácia globálnych premenných a inputov pre nastavenia
            // Ak v uložených dátach chýba hodnota, použijeme aktuálnu z UI/stavu
            hourlyWage = storedData.hourlyWage ?? hourlyWage;
            taxRate = storedData.taxRate ?? taxRate;
            employeeName = storedData.employeeName ?? employeeName;
            decimalPlaces = storedData.decimalPlaces ?? decimalPlaces;

            Elements.hourlyWageInput.value = hourlyWage;
            Elements.taxRateInput.value = (taxRate * 100).toFixed(1); // Zobraz percentá
            Elements.employeeNameInput.value = employeeName;
            Elements.decimalPlacesSelect.value = decimalPlaces;
            updateEmployeeSubtitle();

            // Aplikácia dát do tabuľky
            if (storedData.data && Array.isArray(storedData.data)) {
                storedData.data.forEach((dayData, index) => {
                    const day = index + 1;
                    const startElement = document.getElementById(getInputId('start', day));
                    const endElement = document.getElementById(getInputId('end', day));
                    const breakElement = document.getElementById(getInputId('break', day));

                    if (startElement && endElement && breakElement) {
                        startElement.value = dayData.start || '';
                        endElement.value = dayData.end || '';
                        breakElement.value = dayData.breakTime || '';
                        // Hodnoty Gross/Net sa prepočítajú v calculateRow
                    }
                });
                // Prepočítame všetky riadky po naplnení inputov
                recalculateAllRows();
            } else {
                console.warn("Chýbajúce alebo neplatné pole 'data' v uložených dátach.");
                calculateTotal(); // Prepočítať s prázdnymi dátami
            }
        } catch (error) {
            console.error('Chyba pri parsovaní alebo aplikovaní dát z úložiska:', error);
            showErrorNotification('Chyba pri spracovaní uložených dát.');
            recalculateAllRows(); // Skúsi prepočítať aspoň to, čo je v UI
        }
    }

    // -------------------- UKLADANIE DÁT (LocalStorage + Firestore) --------------------

    // Zozbiera aktuálne dáta z UI (tabuľka + nastavenia)
    function collectCurrentDataForSaving() {
         const saveData = {
            hourlyWage: hourlyWage,
            taxRate: taxRate,
            employeeName: employeeName,
            decimalPlaces: decimalPlaces,
            lastUpdated: new Date().toISOString(),
            data: []
         };
         const daysInMonth = getDaysInMonth(currentMonth);

         for (let day = 1; day <= daysInMonth; day++) {
            const startElement = document.getElementById(getInputId('start', day));
            const endElement = document.getElementById(getInputId('end', day));
            const breakElement = document.getElementById(getInputId('break', day));
            const grossElement = document.getElementById(getInputId('gross', day)); // Pre istotu čítame z inputu
            const netElement = document.getElementById(getInputId('net', day)); // Pre istotu čítame z inputu

            // Pridáme záznam dňa, aj keď je prázdny, aby sme mali plnú štruktúru
            saveData.data.push({
                start: startElement?.value || '',
                end: endElement?.value || '',
                breakTime: breakElement?.value || '',
                // Ukladáme aj vypočítané hodnoty pre prípadné zobrazenie bez prepočtu
                gross: grossElement?.value || (0).toFixed(decimalPlaces),
                net: netElement?.value || (0).toFixed(decimalPlaces)
            });
         }
         return saveData;
    }

    // Funkcia, ktorá sa volá po každej zmene v tabuľke alebo nastaveniach
    function handleDataChange() {
        // 1. Prepočítať aktuálny riadok (ak je známy) - to sa deje v event handleri
        // 2. Prepočítať celkové súčty
        calculateTotal();
        // 3. Uložiť dáta (lokálne + debounced do cloudu)
        saveData();
    }

    // Uloží dáta (najprv lokálne, potom s debounce do Firestore)
    function saveData() {
        const currentData = collectCurrentDataForSaving();
        const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
        const dataString = JSON.stringify(currentData);

        // Vždy uložiť do Local Storage - offline first
        try {
            localStorage.setItem(localKey, dataString);
            //console.log('Dáta uložené lokálne.');
        } catch (e) {
            console.error("Chyba pri ukladaní do Local Storage:", e);
            showErrorNotification("Chyba pri lokálnom ukladaní dát! Možno je úložisko plné.");
            // Tu by sme mohli implementovať nejaký fallback alebo upozornenie
        }

        // Naplánovať uloženie do Firestore (ak sme online a prihlásení)
        // Použijeme debounce na zníženie počtu zápisov
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            saveToFirestore(currentData);
        }, 1500); // Počká 1.5 sekundy nečinnosti pred uložením do cloudu
    }

    // Funkcia pre zápis do Firestore
    async function saveToFirestore(dataToSave) {
      if (!currentUser) return; // Ukladáme len pre prihlásených

      const pendingSyncKey = getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX);

      if (isOnline()) {
        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
            await setDoc(docRef, dataToSave);

            // Ak boli dáta úspešne odoslané, odstránime príznak čakajúcej synchronizácie
            localStorage.removeItem(pendingSyncKey);
            console.log('Dáta úspešne synchronizované s Firestore.');
            showSaveNotification('Dáta synchronizované s cloudom.');
        } catch (error) {
            console.error('Chyba pri ukladaní do Firestore:', error);
            showErrorNotification('Chyba pri synchronizácii s cloudom.');
            // Ak ukladanie zlyhá, označíme dáta ako čakajúce (prepíšeme existujúce čakajúce najnovšími)
            localStorage.setItem(pendingSyncKey, JSON.stringify(dataToSave));
            console.log('Označujem dáta pre neskoršiu synchronizáciu (chyba zápisu).');
        }
      } else {
        // Ak sme offline, len označíme dáta ako čakajúce na synchronizáciu
        console.log('Offline: Označujem dáta pre neskoršiu synchronizáciu.');
        localStorage.setItem(pendingSyncKey, JSON.stringify(dataToSave));
        showSaveNotification('Ste offline, dáta uložené lokálne.');
      }
    }

    // Funkcia na synchronizáciu čakajúcich dát pri prechode do online stavu
    async function syncWithFirebase() {
      if (!currentUser || !isOnline()) return;

      const pendingSyncKey = getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX);
      const pendingDataString = localStorage.getItem(pendingSyncKey);

      if (pendingDataString) {
        console.log('Našli sa čakajúce dáta, pokúšam sa synchronizovať...');
        showStatusNotification('Synchronizujem offline dáta...', 'orange');
        try {
          const dataToSync = JSON.parse(pendingDataString);
          const userRef = doc(db, 'users', currentUser.uid);
          // Použijeme kľúč z dát, nie aktuálny mesiac/rok, pre prípad, že by sa zmenili
          const dataKey = `${currentYear}-${currentMonth}`; // TODO: Toto by malo byť uložené spolu s dátami, ak chceme synchronizovať staré mesiace
          const docRef = doc(userRef, 'workDays', dataKey);
          await setDoc(docRef, dataToSync);

          console.log('Čakajúce dáta boli úspešne synchronizované s Firestore.');
          localStorage.removeItem(pendingSyncKey); // Odstránime príznak po úspechu
          showSaveNotification('Offline dáta boli synchronizované.');
          showStatusNotification('Pripojené', 'green'); // Vrátime status
        } catch (error) {
          console.error('Chyba pri synchronizácii čakajúcich dát s Firestore:', error);
          showErrorNotification('Chyba pri synchronizácii offline dát.');
          showStatusNotification('Chyba synchronizácie', 'red');
          // Necháme pendingKey v localStorage pre ďalší pokus
        }
      } else {
         console.log('Žiadne čakajúce dáta na synchronizáciu.');
      }
    }

    // -------------------- TVORBA TABUĽKY A VÝPOČTY --------------------
    function getDayName(year, month, day) {
      const date = new Date(year, month, day);
      // Použijeme skrátené názvy pre úsporu miesta
      return DAYS_OF_WEEK[date.getDay()];
    }

    function getInputId(type, day) {
        // Štandardizovaný formát ID pre ľahší prístup
        return `${type}-${currentYear}-${currentMonth}-${day}`;
    }

    function createTableStructure() {
      console.log('Vytváram štruktúru tabuľky pre:', getMonthName(currentMonth), currentYear);
      Elements.workDaysTbody.innerHTML = ''; // Vyčistiť starý obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      const fragment = document.createDocumentFragment(); // Efektívnejšie pridávanie do DOM

      for (let day = 1; day <= daysInMonth; day++) {
        const row = document.createElement('tr');
        const isCurrentDay = day === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue;
        if (isCurrentDay) {
          row.classList.add(CSS_CLASSES.CURRENT_DAY);
        }

        const dayName = getDayName(currentYear, currentMonth, day);
        const startId = getInputId('start', day);
        const endId = getInputId('end', day);
        const breakId = getInputId('break', day);
        const totalId = getInputId('total', day);
        const grossId = getInputId('gross', day);
        const netId = getInputId('net', day);

        row.innerHTML = `
          <td>${day} (${dayName})</td>
          <td><input type="tel" id="${startId}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, '${endId}')"></td>
          <td><input type="tel" id="${endId}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, '${breakId}')"></td>
          <td><input type="number" id="${breakId}" min="0" step="0.1" placeholder="hod." oninput="handleBreakInput(${day})"></td>
          <td id="${totalId}">0h 0m (0.0 h)</td>
          <td><input type="text" id="${grossId}" readonly placeholder="0.00" style="background-color: transparent; border: none;"></td>
          <td><input type="text" id="${netId}" readonly placeholder="0.00" style="background-color: transparent; border: none;"></td>
          <td><button class="btn reset-btn" onclick="resetRow(${day})" title="Vynulovať riadok ${day}">X</button></td>
        `;
        // Optimalizácia: Pridávame event listenery tu namiesto oninput v HTML (aj keď oninput je zachované pre spätnú kompatibilitu)
        const startInput = row.querySelector(`#${startId}`);
        const endInput = row.querySelector(`#${endId}`);
        const breakInput = row.querySelector(`#${breakId}`);
        if (startInput) startInput.addEventListener('change', () => calculateRowAndUpdate(day)); // 'change' sa spustí po opustení poľa
        if (endInput) endInput.addEventListener('change', () => calculateRowAndUpdate(day));
        if (breakInput) breakInput.addEventListener('change', () => calculateRowAndUpdate(day));

        fragment.appendChild(row);
      }
      Elements.workDaysTbody.appendChild(fragment);
      console.log('Štruktúra tabuľky vytvorená.');
    }

    // --- Event Handlers pre Inputy ---
    window.handleTimeInput = function(input, nextId) { // Priradenie k window pre onclick
      formatTimeInput(input);
      const day = parseInt(input.id.split('-')[3]);
      if (isValidTimeFormat(input.value)) {
          calculateRowAndUpdate(day); // Prepočíta a spustí ukladanie
          moveFocus(input, nextId);
      } else if (input.value.length === 0) {
          calculateRowAndUpdate(day); // Prepočíta (na nulu) ak sa pole vymaže
      } else {
          // Ak formát nie je platný (napr. "12:"), zatiaľ nerobíme nič, čakáme na dokončenie
          // Môžeme pridať vizuálnu indikáciu neplatnosti cez CSS :invalid pseudotriedu
      }
    }

    window.handleBreakInput = function(day) { // Priradenie k window pre onclick
        const breakInput = document.getElementById(getInputId('break', day));
        // Jednoduchá validácia, či je číslo
        if (breakInput && !isNaN(parseFloat(breakInput.value)) || breakInput.value === '') {
             calculateRowAndUpdate(day); // Prepočíta a spustí ukladanie
             // Presun fokusu nie je nutne žiaduci po čísle prestávky
        } else if (breakInput) {
            // Ak zadal ne-číslo, môžeme ho vyčistiť alebo nechať :invalid štýl
            // breakInput.value = ''; // Možnosť
            // calculateRowAndUpdate(day);
        }
    }

    // --- Pomocné funkcie pre inputy ---
    function formatTimeInput(input) {
      let value = input.value.replace(/[^\d:]/g, '');
      // Automaticky pridá ':' po dvoch číslach, ak tam nie je
      if (value.length === 2 && !value.includes(':')) {
        value += ':';
      }
      // Obmedzí dĺžku na 5 znakov (HH:MM)
      if (value.length > 5) {
        value = value.slice(0, 5);
      }
      input.value = value;
    }

    function isValidTimeFormat(timeString) {
      return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString);
    }

    function moveFocus(currentElement, nextId) {
      if (currentElement.value.length === 5) { // Presuň len ak je čas plne zadaný
          const nextElement = document.getElementById(nextId);
          if (nextElement) {
              nextElement.focus();
              if (nextElement.tagName === 'INPUT') {
                  nextElement.select(); // Označí text pre ľahké prepísanie
              }
          }
      }
    }

    // --- Hlavné výpočtové funkcie ---
    function calculateRowAndUpdate(day) {
        // 1. Prepočíta logiku jedného riadku
        calculateRowLogic(day);
        // 2. Spustí proces ukladania a prepočtu súčtov
        handleDataChange();
    }

    function recalculateAllRows() {
        const daysInMonth = getDaysInMonth(currentMonth);
        for(let day = 1; day <= daysInMonth; day++) {
            calculateRowLogic(day);
        }
        calculateTotal(); // Prepočíta celkové súčty po všetkých riadkoch
    }

    // Logika výpočtu pre jeden riadok (bez ukladania)
    function calculateRowLogic(day) {
        const startTimeInput = document.getElementById(getInputId('start', day));
        const endTimeInput = document.getElementById(getInputId('end', day));
        const breakTimeInput = document.getElementById(getInputId('break', day));
        const totalCell = document.getElementById(getInputId('total', day));
        const grossInput = document.getElementById(getInputId('gross', day));
        const netInput = document.getElementById(getInputId('net', day));

        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) {
            return; // Elementy ešte nemusia existovať pri inicializácii
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        // Prestávka je v hodinách, pre výpočet prevedieme na minúty
        const breakHours = parseFloat(breakTimeInput.value) || 0;

        let workedMinutes = 0;
        let decimalHours = 0;

        if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);

            // Použitie Date objektov pre jednoduchší výpočet rozdielu (aj cez polnoc)
            const startDate = new Date(2000, 0, 1, startHours, startMinutes);
            let endDate = new Date(2000, 0, 1, endHours, endMinutes);

            // Ak je konečný čas menší ako počiatočný, predpokladáme prácu cez polnoc
            if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1); // Posuň konečný dátum o deň
            }

            const diffMillis = endDate.getTime() - startDate.getTime();
            let diffMinutes = diffMillis / (1000 * 60);

            const breakMinutes = breakHours * 60;
            diffMinutes -= breakMinutes;

            // Zaokrúhlenie na najbližšiu minútu a zabezpečenie nezápornosti
            workedMinutes = Math.max(0, Math.round(diffMinutes));
            decimalHours = Math.max(0, workedMinutes / 60);
        }

        // Zobrazenie odpracovaného času
        const hours = Math.floor(workedMinutes / 60);
        const minutes = workedMinutes % 60;
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

        // Výpočet a zobrazenie miezd
        const grossSalary = decimalHours * hourlyWage;
        const netSalary = grossSalary * (1 - taxRate);
        grossInput.value = grossSalary.toFixed(decimalPlaces);
        netInput.value = netSalary.toFixed(decimalPlaces);
    }

    window.resetRow = function(day) { // Priradenie k window pre onclick
      const startInput = document.getElementById(getInputId('start', day));
      const endInput = document.getElementById(getInputId('end', day));
      const breakInput = document.getElementById(getInputId('break', day));
      if(startInput) startInput.value = '';
      if(endInput) endInput.value = '';
      if(breakInput) breakInput.value = '';
      calculateRowAndUpdate(day); // Prepočíta na nulu a uloží
    }

    function calculateTotal() {
        let totalMinutesAggregated = 0;
        let totalGrossSalaryAggregated = 0;
        let totalNetSalaryAggregated = 0;
        let daysWithEntries = 0;
        const daysInMonth = getDaysInMonth(currentMonth);

        for (let day = 1; day <= daysInMonth; day++) {
            const startInput = document.getElementById(getInputId('start', day));
            const endInput = document.getElementById(getInputId('end', day));
            const breakInput = document.getElementById(getInputId('break', day));
            // Čítame priamo vypočítané hodnoty z inputov pre jednoduchosť
            const grossInput = document.getElementById(getInputId('gross', day));
            const netInput = document.getElementById(getInputId('net', day));

            if (!startInput || !endInput || !breakInput || !grossInput || !netInput) continue; // Skip if elements don't exist

            const startTime = startInput.value;
            const endTime = endInput.value;
            const breakHours = parseFloat(breakInput.value) || 0;
            const grossSalary = parseFloat(grossInput.value) || 0;
            const netSalary = parseFloat(netInput.value) || 0;

            let dayMinutes = 0;
            let hasEntry = false;

            if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                 // Znovu vypočítame minúty pre presný súčet času
                 const [startHours, startMinutes] = startTime.split(':').map(Number);
                 const [endHours, endMinutes] = endTime.split(':').map(Number);
                 const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                 let endDate = new Date(2000, 0, 1, endHours, endMinutes);
                 if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);
                 const diffMillis = endDate.getTime() - startDate.getTime();
                 let diffMinutes = diffMillis / (1000 * 60);
                 diffMinutes -= (breakHours * 60);
                 dayMinutes = Math.max(0, Math.round(diffMinutes));
                 if (dayMinutes > 0 || breakHours > 0) hasEntry = true; // Započítať deň, ak je čas alebo prestávka
            } else if (startTime || endTime || breakHours > 0) {
                 // Ak je niečo zadané, aj keď neplatne, rátame ako deň so záznamom
                 hasEntry = true;
            }

            totalMinutesAggregated += dayMinutes;
            totalGrossSalaryAggregated += grossSalary;
            totalNetSalaryAggregated += netSalary;
            if (hasEntry) daysWithEntries++;
        }

        // Výpočet celkových a priemerných hodnôt
        const totalHours = Math.floor(totalMinutesAggregated / 60);
        const totalMinutesRemainder = totalMinutesAggregated % 60;
        const totalDecimalHours = totalMinutesAggregated / 60;

        const averageNetSalary = daysWithEntries > 0 ? totalNetSalaryAggregated / daysWithEntries : 0;
        const averageMinutesPerDay = daysWithEntries > 0 ? totalMinutesAggregated / daysWithEntries : 0;
        const averageHours = Math.floor(averageMinutesPerDay / 60);
        const averageMinutesRemainder = Math.round(averageMinutesPerDay % 60); // Zaokrúhlime priemerné minúty
        const averageDecimalHours = daysWithEntries > 0 ? totalDecimalHours / daysWithEntries : 0;

        // Zobrazenie výsledkov
        Elements.totalSalaryDiv.innerHTML = `
            Započítaných dní: <strong>${daysWithEntries}</strong><br>
            Celkový čas: <strong>${totalHours}h ${totalMinutesRemainder}m</strong> (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>
            Hrubá mzda: <strong>${totalGrossSalaryAggregated.toFixed(decimalPlaces)} €</strong><br>
            Čistá mzda: <strong>${totalNetSalaryAggregated.toFixed(decimalPlaces)} €</strong><br>
            Priem. čistá mzda/deň: ${averageNetSalary.toFixed(decimalPlaces)} €<br>
            Priem. čas/deň: ${averageHours}h ${averageMinutesRemainder}m (${averageDecimalHours.toFixed(decimalPlaces)} h)
        `;
    }


    // -------------------- EXPORT DO PDF --------------------
    function getMonthName(monthIndex) {
      return MONTH_NAMES[monthIndex] || 'Neznámy mesiac';
    }

    // Pomocná funkcia na generovanie PDF dokumentu (bez ukladania/odosielania)
    function generatePDFDocument() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Pridanie fontu podporujúceho slovenčinu (Roboto je dobrá voľba)
        // Uistite sa, že cesta k fontu je správna alebo použite base64 embeddovanie
        // Pre jednoduchosť tu predpokladáme, že font je dostupný cez CDN v hlavičke,
        // ale pre spoľahlivosť by mal byť lokálne alebo base64.
        // Ak font nie je nájdený, jsPDF použije default (Helvetica), ktorá nemusí mať diakritiku.
        try {
             // Príklad pridania fontu (ak by nebol načítaný cez CDN)
             // doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
             doc.setFont('helvetica'); // Skúsime helvetica ako fallback
        } catch (e) {
            console.warn("Nepodarilo sa nastaviť preferovaný font pre PDF, použije sa default.", e);
            // Pokračuje s default fontom
        }

        doc.setFontSize(18);
        const title = `Výkaz práce - ${employeeName || 'Pracovník'} (${getMonthName(currentMonth)} ${currentYear})`;
        doc.text(title, 14, 20);

        // Základné informácie
        doc.setFontSize(11);
        doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 30);
        doc.text(`Hodinová mzda: ${hourlyWage.toFixed(decimalPlaces)} €`, 14, 35);
        doc.text(`Daňové percento: ${(taxRate * 100).toFixed(1)} %`, 14, 40);

        // Zbieranie dát pre tabuľku
        const tableData = [];
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let day = 1; day <= daysInMonth; day++) {
            const dayName = getDayName(currentYear, currentMonth, day);
            const startTime = document.getElementById(getInputId('start', day))?.value || '';
            const endTime = document.getElementById(getInputId('end', day))?.value || '';
            const breakTime = document.getElementById(getInputId('break', day))?.value || '';
            const totalTimeText = document.getElementById(getInputId('total', day))?.textContent || '';
             // Extrahujeme len formát HHh MMm pre PDF
            const totalTimeMatch = totalTimeText.match(/^(\d+h\s*\d+m)/);
            const totalTime = totalTimeMatch ? totalTimeMatch[1] : '';
            const grossSalary = document.getElementById(getInputId('gross', day))?.value || '';
            const netSalary = document.getElementById(getInputId('net', day))?.value || '';

            // Pridať riadok len ak existuje nejaký záznam (čas alebo prestávka)
            if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) {
                tableData.push([
                    `${day} (${dayName})`,
                    startTime,
                    endTime,
                    breakTime || '0', // Zobraz '0' ak je prázdne
                    totalTime,
                    grossSalary,
                    netSalary
                ]);
            }
        }

        // Vytvorenie tabuľky
        doc.autoTable({
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka(h)', 'Čas', 'Hrubá(€)', 'Čistá(€)']],
            body: tableData,
            startY: 45,
            styles: { fontSize: 9, cellPadding: 1.5 }, // Menšie písmo pre viac dát
            headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', fontSize: 9 },
            columnStyles: {
                0: { cellWidth: 25 }, // Deň
                1: { cellWidth: 18 }, // Príchod
                2: { cellWidth: 18 }, // Odchod
                3: { cellWidth: 20, halign: 'right' }, // Prestávka
                4: { cellWidth: 25 }, // Čas
                5: { cellWidth: 25, halign: 'right' }, // Hrubá
                6: { cellWidth: 25, halign: 'right' }  // Čistá
            },
            didDrawPage: function(data) {
                // Pridanie pätičky s číslom strany
                doc.setFontSize(8);
                doc.text('Strana ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
        });

        // Pridanie celkových súčtov pod tabuľku
        const totalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(11);
        doc.text("Celkové súčty:", 14, totalY);
        // Získame text zo súčtov a nahradíme HTML tagy
        const totalTextContent = Elements.totalSalaryDiv.innerHTML
            .replace(/<br\s*\/?>/gi, '\n') // Nahradí <br> za nový riadok
            .replace(/<\/?strong>/gi, '') // Odstráni <strong> tagy
            .replace(/ /g, ' ') // Nahradí   za medzeru
            .replace(/<[^>]*>/g, ''); // Odstráni prípadné zvyšné HTML tagy
        doc.text(totalTextContent, 14, totalY + 5);

        return doc; // Vráti vygenerovaný jsPDF objekt
    }

    window.exportToPDF = function() { // Priradenie k window pre onclick
        try {
            const doc = generatePDFDocument();
            const filename = `vykaz_prace_${employeeName.replace(/\s+/g, '_') || 'pracovnik'}_${getMonthName(currentMonth)}_${currentYear}.pdf`;
            doc.save(filename);
            showSaveNotification('PDF súbor bol vygenerovaný.');
        } catch (error) {
            console.error("Chyba pri generovaní PDF:", error);
            showErrorNotification("Nepodarilo sa vygenerovať PDF.");
        }
    }

    window.sendPDF = async function() { // Priradenie k window pre onclick
        try {
            const doc = generatePDFDocument();
            const pdfBlob = doc.output('blob');
            const filename = `vykaz_prace_${employeeName.replace(/\s+/g, '_') || 'pracovnik'}_${getMonthName(currentMonth)}_${currentYear}.pdf`;
            const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });

            // Použitie Web Share API (ak je dostupné)
            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                await navigator.share({
                    files: [pdfFile],
                    title: `Výkaz práce ${getMonthName(currentMonth)} ${currentYear}`,
                    text: `Výkaz práce pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}`
                });
                console.log('PDF úspešne zdieľané.');
                // Nepotrebujeme notifikáciu, lebo systémové UI pre zdieľanie sa zobrazí
            } else {
                showErrorNotification('Váš prehliadač nepodporuje priame zdieľanie súborov. Súbor bol stiahnutý, môžete ho odoslať manuálne.');
                // Ako fallback stiahneme súbor
                doc.save(filename);
            }
        } catch (error) {
            // Ak užívateľ zruší zdieľanie, môže to vyhodiť AbortError, čo nie je skutočná chyba
            if (error.name === 'AbortError') {
                console.log('Zdieľanie PDF bolo zrušené užívateľom.');
            } else {
                console.error('Chyba pri odosielaní/zdieľaní PDF:', error);
                showErrorNotification('Chyba pri zdieľaní PDF.');
            }
        }
    }

    // -------------------- OSTATNÉ NASTAVENIA A FUNKCIE --------------------
    window.toggleDarkMode = function() { // Priradenie k window pre onclick
      Elements.body.classList.toggle(CSS_CLASSES.DARK_MODE);
      localStorage.setItem(LS_KEYS.DARK_MODE, Elements.body.classList.contains(CSS_CLASSES.DARK_MODE));
    }

    window.changeDecimalPlaces = function() { // Priradenie k window pre onclick
      decimalPlaces = parseInt(Elements.decimalPlacesSelect.value);
      localStorage.setItem(LS_KEYS.DECIMAL_PLACES, decimalPlaces);
      // Prepočítať zobrazenie v tabuľke a súčty
      recalculateAllRows();
      // Uložiť zmenu nastavenia spolu s dátami
      handleDataChange();
    }

    window.updateEmployeeName = function() { // Priradenie k window pre onclick
      employeeName = Elements.employeeNameInput.value.trim();
      localStorage.setItem(LS_KEYS.EMPLOYEE_NAME, employeeName);
      updateEmployeeSubtitle();
      // Uložiť zmenu nastavenia spolu s dátami
      handleDataChange(); // Meno je súčasťou ukladaných dát
    }
    function updateEmployeeSubtitle() {
        Elements.employeeSubtitle.textContent = employeeName ? `Pracovník: ${employeeName}` : '';
    }


    window.updateSettings = function() { // Priradenie k window pre onclick (pre mzdu a daň)
        const newWage = parseFloat(Elements.hourlyWageInput.value) || 0;
        const newTaxRatePercent = parseFloat(Elements.taxRateInput.value) || 0;

        if (newWage >= 0 && newTaxRatePercent >= 0) {
            hourlyWage = newWage;
            taxRate = newTaxRatePercent / 100;
            // Prepočítať celú tabuľku a súčty
            recalculateAllRows();
            // Uložiť zmeny
            handleDataChange();
        } else {
             showErrorNotification("Hodinová mzda a daň musia byť kladné čísla.");
             // Vrátiť pôvodné hodnoty do inputov?
             Elements.hourlyWageInput.value = hourlyWage;
             Elements.taxRateInput.value = (taxRate * 100).toFixed(1);
        }
    }

    window.changeMonth = function() { // Priradenie k window pre onclick
      const newMonth = parseInt(Elements.monthSelect.value);
      if (newMonth !== currentMonth) {
          currentMonth = newMonth;
          refreshDataAndView(); // Načíta dáta pre nový mesiac a prekreslí UI
      }
    }

    window.changeYear = function() { // Priradenie k window pre onclick
      const newYear = parseInt(Elements.yearSelect.value);
       if (newYear !== currentYear) {
          currentYear = newYear;
          refreshDataAndView(); // Načíta dáta pre nový rok a prekreslí UI
      }
    }

    function getDaysInMonth(month) {
      // Mesiac je 0-based (0=Jan, 11=Dec)
      // new Date(year, month + 1, 0) vracia posledný deň *predchádzajúceho* mesiaca (teda posledný deň aktuálneho mesiaca)
      return new Date(currentYear, month + 1, 0).getDate();
    }

    function getLocalStorageKey(prefix) {
        // Vytvorí unikátny kľúč pre dáta daného mesiaca a roka
        return `${prefix}${currentYear}-${currentMonth}`;
    }

    // -------------------- FUNKCIE PRE ZÁLOHU A OBNOVU DO EXCELU (.xlsx) --------------------
    window.createBackup = function() { // Priradenie k window pre onclick
        const currentData = collectCurrentDataForSaving(); // Získame aktuálne dáta
        if (!currentData || !currentData.data || currentData.data.length === 0) {
            return showErrorNotification('Nie sú dostupné žiadne dáta na zálohu.');
        }

        try {
            const ws_data = [
              // Hlavička s informáciami o zálohe
              ["Záloha Bruno's Calculator"],
              ["Pracovník", employeeName],
              ["Mesiac", getMonthName(currentMonth)],
              ["Rok", currentYear],
              ["Hodinová mzda (€)", hourlyWage],
              ["Daňové percento (%)", taxRate * 100],
              ["Desatinné miesta", decimalPlaces],
              ["Dátum zálohy", new Date().toISOString()],
              [], // Prázdny riadok pre oddelenie
              // Hlavička tabuľky
              ["Deň č.", "Deň v týždni", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"]
            ];

            // Dáta z tabuľky
            currentData.data.forEach((dayData, index) => {
                const day = index + 1;
                const dayName = getDayName(currentYear, currentMonth, day);
                ws_data.push([
                    day,
                    dayName,
                    dayData.start,
                    dayData.end,
                    dayData.breakTime,
                    dayData.gross,
                    dayData.net
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Nastavenie šírky stĺpcov (voliteľné)
            ws['!cols'] = [
                { wch: 8 }, // Deň č.
                { wch: 12 }, // Deň v týždni
                { wch: 10 }, // Príchod
                { wch: 10 }, // Odchod
                { wch: 12 }, // Prestávka
                { wch: 15 }, // Hrubá
                { wch: 15 }  // Čistá
            ];

            XLSX.utils.book_append_sheet(wb, ws, "VykazPrace");
            const filename = `zaloha_vykaz_${employeeName.replace(/\s+/g, '_') || 'pracovnik'}_${getMonthName(currentMonth)}_${currentYear}.xlsx`;
            XLSX.writeFile(wb, filename);
            showSaveNotification('Záloha (.xlsx) bola úspešne vytvorená.');
        } catch(error) {
             console.error('Chyba pri vytváraní Excel zálohy:', error);
             showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message);
        }
    };

    window.restoreBackup = function() { // Priradenie k window pre onclick
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm(`Naozaj chcete obnoviť dáta zo súboru "${file.name}" pre ${getMonthName(currentMonth)} ${currentYear}? Týmto prepíšete aktuálne zobrazené dáta.`)) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0]; // Predpokladáme prvý list
            const ws = workbook.Sheets[sheetName];
            // Konvertujeme na pole polí (riadkov)
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false }); // raw: false pre formátovaný text

            // --- Parsovanie hlavičky a nastavení ---
            let restoredSettings = {};
            let dataStartIndex = -1;
            for(let i=0; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 2) continue; // Preskočiť prázdne alebo krátke riadky
                const key = row[0]?.toString().toLowerCase().trim();
                const value = row[1]?.toString().trim();

                if (key.includes("hodinová mzda")) restoredSettings.hourlyWage = parseFloat(value) || undefined;
                else if (key.includes("daňové percento")) restoredSettings.taxRate = (parseFloat(value) || 0) / 100; // Uložíme ako desatinné číslo
                else if (key.includes("meno pracovníka") || key.includes("pracovník")) restoredSettings.employeeName = value;
                else if (key.includes("desatinné miesta")) restoredSettings.decimalPlaces = parseInt(value) || undefined;
                // Môžeme parsovať aj mesiac/rok pre kontrolu, ale zatiaľ necháme
                // else if (key.includes("mesiac")) ...
                // else if (key.includes("rok")) ...

                // Hľadáme začiatok dátovej tabuľky (riadok s "Deň č.")
                if (key.includes("deň č.")) {
                    dataStartIndex = i + 1; // Dáta začínajú na ďalšom riadku
                    break; // Našli sme hlavičku dát, končíme parsovanie nastavení
                }
            }

            if (dataStartIndex === -1) {
                throw new Error("Nepodarilo sa nájsť hlavičku dátovej tabuľky (stĺpec 'Deň č.') v súbore.");
            }

            // --- Parsovanie dátových riadkov ---
            let restoredDataArray = [];
            const daysInTargetMonth = getDaysInMonth(currentMonth); // Počet dní v mesiaci, kam obnovujeme

            for (let i = dataStartIndex; i < rows.length; i++) {
                const row = rows[i];
                 // Predpokladaný formát riadku: [Deň č., Deň v týždni, Príchod, Odchod, Prestávka, Hrubá, Čistá]
                if (!row || typeof row[0] !== 'number' || row[0] < 1 || row[0] > daysInTargetMonth) {
                    // Koniec dát alebo neplatný riadok
                     break;
                }
                // Overíme, či máme dosť stĺpcov
                 if (row.length < 7) {
                     console.warn(`Riadok ${i} má menej ako 7 stĺpcov, môže byť nekompletný.`);
                     // Doplníme chýbajúce hodnoty ako prázdne reťazce
                     while(row.length < 7) row.push("");
                 }

                restoredDataArray.push({
                    // Hodnoty berieme ako stringy, validácia a formátovanie sa urobí pri aplikácii
                    start: row[2]?.toString() || "",
                    end: row[3]?.toString() || "",
                    breakTime: row[4]?.toString() || "",
                    gross: row[5]?.toString() || "0.00", // Default na 0.00 ak chýba
                    net: row[6]?.toString() || "0.00"   // Default na 0.00 ak chýba
                });

                // Zastavíme po načítaní správneho počtu dní pre cieľový mesiac
                if (restoredDataArray.length >= daysInTargetMonth) {
                     break;
                }
            }

             // Doplnenie prázdnych dní, ak záloha nemala všetky dni mesiaca
            while (restoredDataArray.length < daysInTargetMonth) {
                 restoredDataArray.push({ start: "", end: "", breakTime: "", gross: "0.00", net: "0.00"});
            }


            // --- Vytvorenie finálneho objektu pre uloženie ---
            const backupData = {
              data: restoredDataArray,
              // Použijeme obnovené nastavenia, ak boli nájdené, inak aktuálne
              hourlyWage: restoredSettings.hourlyWage ?? hourlyWage,
              taxRate: restoredSettings.taxRate ?? taxRate,
              employeeName: restoredSettings.employeeName ?? employeeName,
              decimalPlaces: restoredSettings.decimalPlaces ?? decimalPlaces,
              lastUpdated: new Date().toISOString() // Označíme čas obnovy
            };

            // --- Aplikácia dát ---
            // 1. Uložíme obnovené dáta do localStorage pre aktuálny mesiac/rok
            const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
            localStorage.setItem(localKey, JSON.stringify(backupData));

            // 2. Aplikujeme dáta do UI (parsovanie a zobrazenie)
            parseAndApplyData(JSON.stringify(backupData)); // parseAndApplyData aktualizuje aj UI nastavenia

            showSaveNotification('Záloha bola úspešne obnovená a načítaná.');

            // 3. Ak je užívateľ prihlásený a online, môžeme tieto obnovené dáta hneď poslať do cloudu
            if (currentUser && isOnline()) {
              // Odstránime flag čakajúcej synchronizácie (ak bol) a pošleme nové dáta
              localStorage.removeItem(getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX));
              saveToFirestore(backupData); // Pošle obnovené dáta do cloudu
            }

          } catch (error) {
            console.error('Chyba pri načítavaní zálohy z Excelu:', error);
            showErrorNotification('Chyba pri spracovaní zálohy: ' + error.message);
          }
        };
        reader.onerror = function() {
            showErrorNotification('Chyba pri čítaní súboru zálohy.');
        }
        reader.readAsArrayBuffer(file); // Čítame ako binárne dáta
      };
      input.click(); // Otvorí dialóg na výber súboru
    };


    // -------------------- ŠTART APLIKÁCIE --------------------
    initializeUI(); // Základné nastavenie UI

    // Listener na zmeny stavu autentifikácie
    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed. User:', user ? user.uid : 'None');
      currentUser = user;
      // Po zmene prihlásenia vždy obnovíme pohľad a dáta
      refreshDataAndView();
    });

  </script>

  <!-- Registrácia Service Workera (bez zmien) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
    }
  </script>
</body>
</html>
