<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon" />

  <!-- Lazy-loaded Libraries -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s infinite, textShadowPulse 2s infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      font-size: 1.2em;
      margin-top: -10px;
    }
    .settings {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .settings label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }
    .table-container {
      overflow-x: auto;
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
      table-layout: fixed;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      background-color: #ffffd0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: #4CAF50;
      outline: none;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
      color: #4CAF50;
    }
    .btn-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    .btn {
      padding: 10px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s, background-color 0.3s;
    }
    .btn:hover {
      transform: scale(1.05);
    }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; }
    .backup-btn:hover { background-color: #6a1bb2; }
    .highlight { background-color: #ffcc00; color: #333; }
    #totalSalary {
      font-size: 18px;
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background-color: #e6f3ff;
      border-radius: 8px;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
    body.dark-mode .container { background-color: #2d2d2d; }
    body.dark-mode table { background-color: #333; }
    body.dark-mode th { background-color: #444; }
    body.dark-mode td { background-color: #2d2d2d; }
    body.dark-mode input, body.dark-mode select {
      background-color: #555;
      color: #fff;
      border-color: #666;
    }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% { text-shadow: 0 0 10px rgba(255,255,255,0.5); }
      50% { text-shadow: 0 0 20px rgba(255,255,255,1); }
    }
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h1 { font-size: 2em; }
      table { min-width: 100%; }
      .btn { font-size: 14px; }
    }
    #notifications {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    .notification {
      padding: 10px 20px;
      border-radius: 5px;
      margin-top: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.5s;
    }
    .notification.show { opacity: 1; }
    .success { background-color: #4CAF50; color: white; }
    .error { background-color: #f44336; color: white; }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .tooltip {
      position: relative;
    }
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .tooltip:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <form id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Heslo" required />
        <button type="submit" class="btn export-btn">Prihlásiť sa</button>
        <button type="button" class="btn export-btn" onclick="register()">Registrovať</button>
      </form>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1>Bruno's Calculator</h1>
    <h2 id="subtitle"></h2>

    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno" />
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" />
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" />
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect"></select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinné miesta:</label>
        <select id="decimalPlacesSelect">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button class="btn highlight tooltip" onclick="toggleDarkMode()" data-tooltip="Prepne tmavý/jasný režim">Tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá mzda (€)</th>
            <th>Čistá mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn tooltip" onclick="exportToPDF()" data-tooltip="Exportuje do PDF">Export PDF</button>
      <button class="btn export-btn tooltip" onclick="sendPDF()" data-tooltip="Zdieľa PDF">Odoslať PDF</button>
      <button class="btn export-btn tooltip" onclick="restoreBackup()" data-tooltip="Obnoví zo súboru">Obnoviť zálohu</button>
      <button class="btn backup-btn tooltip" onclick="createBackup()" data-tooltip="Vytvorí Excel zálohu">Zálohovať</button>
      <button class="btn export-btn tooltip" onclick="loadFromFirestore()" data-tooltip="Načíta z cloudu">Načítať z Firebase</button>
    </div>
  </div>

  <div id="notifications"></div>

  <!-- Modular JavaScript -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.firebasestorage.app",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global State
    const state = {
      currentUser: null,
      currentMonth: new Date().getMonth(),
      currentYear: new Date().getFullYear(),
      decimalPlaces: parseInt(localStorage.getItem('decimalPlaces')) || 1,
      employeeName: localStorage.getItem('employeeName') || '',
      hourlyWage: 10,
      taxRate: 0.02,
      monthData: {},
      isOnline: navigator.onLine
    };

    // DOM Elements
    const elements = {
      workDays: document.getElementById('workDays'),
      totalSalary: document.getElementById('totalSalary'),
      hourlyWageInput: document.getElementById('hourlyWageInput'),
      taxRateInput: document.getElementById('taxRateInput'),
      monthSelect: document.getElementById('monthSelect'),
      yearSelect: document.getElementById('yearSelect'),
      decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
      employeeNameInput: document.getElementById('employeeNameInput'),
      loginForm: document.getElementById('login-form'),
      userInfo: document.getElementById('user-info'),
      userEmail: document.getElementById('user-email'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      notifications: document.getElementById('notifications'),
      subtitle: document.getElementById('subtitle')
    };

    // Utility Functions
    const showNotification = (message, type = 'success') => {
      const notification = document.createElement('div');
      notification.className = `notification ${type} show`;
      notification.textContent = message;
      elements.notifications.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    };

    const showLoading = (show) => {
      elements.loadingOverlay.style.display = show ? 'flex' : 'none';
    };

    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    };

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('sk-SK', { style: 'currency', currency: 'EUR' }).format(amount);
    };

    // Authentication
    const login = async (e) => {
      e.preventDefault();
      if (!state.isOnline) return showNotification('Offline: Prihlásenie vyžaduje internet.', 'error');
      showLoading(true);
      try {
        const userCredential = await signInWithEmailAndPassword(auth, elements.email.value, elements.password.value);
        state.currentUser = userCredential.user;
        updateUI();
      } catch (error) {
        showNotification(`Prihlásenie zlyhalo: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    };

    window.register = async () => {
      if (!state.isOnline) return showNotification('Offline: Registrácia vyžaduje internet.', 'error');
      showLoading(true);
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, elements.email.value, elements.password.value);
        state.currentUser = userCredential.user;
        await setDoc(doc(db, 'users', state.currentUser.uid), { email: state.currentUser.email, createdAt: new Date() });
        updateUI();
      } catch (error) {
        showNotification(`Registrácia zlyhala: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    };

    window.logout = async () => {
      await signOut(auth);
      state.currentUser = null;
      state.monthData = {};
      updateUI();
    };

    // UI Management
    const populateSelects = () => {
      const months = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      months.forEach((month, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = month;
        elements.monthSelect.appendChild(option);
      });
      for (let year = 2020; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        elements.yearSelect.appendChild(option);
      }
      elements.monthSelect.value = state.currentMonth;
      elements.yearSelect.value = state.currentYear;
      elements.decimalPlacesSelect.value = state.decimalPlaces;
    };

    const updateUI = async () => {
      elements.loginForm.style.display = state.currentUser ? 'none' : 'block';
      elements.userInfo.style.display = state.currentUser ? 'block' : 'none';
      if (state.currentUser) {
        elements.userEmail.textContent = state.currentUser.email;
        await loadData();
      } else {
        loadFromLocalStorage();
      }
      createTable();
      elements.subtitle.textContent = state.isOnline ? 'Online' : 'Offline';
    };

    // Data Management
    const saveData = debounce(async () => {
      const data = collectData();
      localStorage.setItem(`workData-${state.currentYear}-${state.currentMonth}`, JSON.stringify(data));
      if (state.currentUser && state.isOnline) {
        await setDoc(doc(db, 'users', state.currentUser.uid, 'workDays', `${state.currentYear}-${state.currentMonth}`), data);
        showNotification('Dáta synchronizované s cloudom.');
      } else {
        showNotification('Dáta uložené lokálne.');
      }
    }, 500);

    const loadData = async () => {
      const key = `workData-${state.currentYear}-${state.currentMonth}`;
      const localData = localStorage.getItem(key);
      if (localData) {
        applyData(JSON.parse(localData));
      } else if (state.currentUser && state.isOnline) {
        const docRef = doc(db, 'users', state.currentUser.uid, 'workDays', `${state.currentYear}-${state.currentMonth}`);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          localStorage.setItem(key, JSON.stringify(data));
          applyData(data);
        }
      }
    };

    const loadFromLocalStorage = () => {
      const key = `workData-${state.currentYear}-${state.currentMonth}`;
      const localData = localStorage.getItem(key);
      if (localData) applyData(JSON.parse(localData));
    };

    window.loadFromFirestore = async () => {
      if (!state.currentUser || !state.isOnline) return showNotification('Vyžaduje prihlásenie a internet.', 'error');
      if (confirm('Načítať dáta z cloudu? Lokálne zmeny budú prepísané.')) {
        showLoading(true);
        const docRef = doc(db, 'users', state.currentUser.uid, 'workDays', `${state.currentYear}-${state.currentMonth}`);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          localStorage.setItem(`workData-${state.currentYear}-${state.currentMonth}`, JSON.stringify(data));
          applyData(data);
          showNotification('Dáta načítané z cloudu.');
        } else {
          showNotification('Žiadne dáta v cloude.', 'error');
        }
        showLoading(false);
      }
    };

    const applyData = (data) => {
      state.monthData[state.currentYear] = state.monthData[state.currentYear] || {};
      state.monthData[state.currentYear][state.currentMonth] = data.data;
      state.hourlyWage = data.hourlyWage;
      state.taxRate = data.taxRate;
      state.employeeName = data.employeeName;
      state.decimalPlaces = data.decimalPlaces;
      elements.hourlyWageInput.value = state.hourlyWage;
      elements.taxRateInput.value = state.taxRate * 100;
      elements.employeeNameInput.value = state.employeeName;
      elements.decimalPlacesSelect.value = state.decimalPlaces;
      data.data.forEach((day, i) => {
        const dayNum = i + 1;
        const start = document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${dayNum}`);
        const end = document.getElementById(`end-${state.currentYear}-${state.currentMonth}-${dayNum}`);
        const breakTime = document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${dayNum}`);
        if (start) start.value = day.start;
        if (end) end.value = day.end;
        if (breakTime) breakTime.value = day.breakTime;
        calculateRow(dayNum);
      });
      calculateTotal();
    };

    const collectData = () => ({
      data: Array.from({ length: getDaysInMonth() }, (_, i) => {
        const day = i + 1;
        return {
          start: document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '',
          end: document.getElementById(`end-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '',
          breakTime: document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '',
          gross: document.getElementById(`gross-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '0',
          net: document.getElementById(`net-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '0'
        };
      }),
      hourlyWage: state.hourlyWage,
      taxRate: state.taxRate,
      employeeName: state.employeeName,
      decimalPlaces: state.decimalPlaces,
      lastUpdated: new Date().toISOString()
    });

    // Table and Calculations
    const getDaysInMonth = () => new Date(state.currentYear, state.currentMonth + 1, 0).getDate();

    const createTable = () => {
      elements.workDays.innerHTML = '';
      const today = new Date();
      const days = getDaysInMonth();
      for (let i = 1; i <= days; i++) {
        const row = document.createElement('tr');
        const isToday = i === today.getDate() && state.currentMonth === today.getMonth() && state.currentYear === today.getFullYear();
        if (isToday) row.classList.add('current-day');
        const dayName = new Date(state.currentYear, state.currentMonth, i).toLocaleDateString('sk-SK', { weekday: 'long' });
        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td><input type="tel" id="start-${state.currentYear}-${state.currentMonth}-${i}" maxlength="5" placeholder="HH:MM" oninput="handleInput(this, 'end-${state.currentYear}-${state.currentMonth}-${i}')"></td>
          <td><input type="tel" id="end-${state.currentYear}-${state.currentMonth}-${i}" maxlength="5" placeholder="HH:MM" oninput="handleInput(this, 'break-${state.currentYear}-${state.currentMonth}-${i}')"></td>
          <td><input type="number" id="break-${state.currentYear}-${state.currentMonth}-${i}" min="0" step="0.5" placeholder="0" oninput="handleBreakInput(${i})"></td>
          <td id="total-${state.currentYear}-${state.currentMonth}-${i}">0h 0m (0.${'0'.repeat(state.decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${state.currentYear}-${state.currentMonth}-${i}" readonly></td>
          <td><input type="number" id="net-${state.currentYear}-${state.currentMonth}-${i}" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        elements.workDays.appendChild(row);
      }
    };

    window.handleInput = (input, nextId) => {
      formatTime(input);
      calculateAndSave();
      if (input.value.length === 5) moveNext(input, nextId);
    };

    window.handleBreakInput = (day) => {
      calculateRow(day);
      calculateAndSave();
    };

    const formatTime = (input) => {
      let value = input.value.replace(/[^\d:]/g, '');
      if (value.length === 2 && !value.includes(':')) value += ':';
      input.value = value.slice(0, 5);
      const [hours, minutes] = value.split(':');
      if (hours && minutes && (hours >= 24 || minutes >= 60)) {
        showNotification('Neplatný čas (HH:MM, 00-23:00-59).', 'error');
        input.value = '';
      }
    };

    const moveNext = (current, nextId) => {
      const next = document.getElementById(nextId);
      if (next) next.focus();
    };

    const calculateRow = (day) => {
      const start = document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${day}`);
      const end = document.getElementById(`end-${state.currentYear}-${state.currentMonth}-${day}`);
      const breakTime = document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${day}`);
      const total = document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${day}`);
      const gross = document.getElementById(`gross-${state.currentYear}-${state.currentMonth}-${day}`);
      const net = document.getElementById(`net-${state.currentYear}-${state.currentMonth}-${day}`);

      if (!start?.value || !end?.value) {
        total.textContent = `0h 0m (0.${'0'.repeat(state.decimalPlaces)} h)`;
        gross.value = '0';
        net.value = '0';
        return;
      }

      const [startH, startM] = start.value.split(':').map(Number);
      const [endH, endM] = end.value.split(':').map(Number);
      let minutes = (endH * 60 + endM) - (startH * 60 + startM);
      if (minutes < 0) minutes += 24 * 60;
      minutes -= (parseFloat(breakTime.value) || 0) * 60;
      if (minutes < 0) minutes = 0;

      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      const decimalHours = minutes / 60;
      total.textContent = `${hours}h ${mins}m (${decimalHours.toFixed(state.decimalPlaces)} h)`;
      const grossSalary = decimalHours * state.hourlyWage;
      gross.value = grossSalary.toFixed(state.decimalPlaces);
      net.value = (grossSalary * (1 - state.taxRate)).toFixed(state.decimalPlaces);
    };

    window.resetRow = (day) => {
      ['start', 'end', 'break'].forEach(type => {
        const el = document.getElementById(`${type}-${state.currentYear}-${state.currentMonth}-${day}`);
        if (el) el.value = '';
      });
      calculateRow(day);
      calculateAndSave();
    };

    const calculateTotal = () => {
      let totalMins = 0, totalGross = 0, totalNet = 0, daysCount = 0;
      for (let i = 1; i <= getDaysInMonth(); i++) {
        const gross = parseFloat(document.getElementById(`gross-${state.currentYear}-${state.currentMonth}-${i}`)?.value || 0);
        const net = parseFloat(document.getElementById(`net-${state.currentYear}-${state.currentMonth}-${i}`)?.value || 0);
        const start = document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${i}`)?.value;
        if (gross > 0 || start) {
          totalGross += gross;
          totalNet += net;
          totalMins += parseFloat(document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${i}`).textContent.match(/\(([^)]+)\)/)?.[1]) * 60 || 0;
          daysCount++;
        }
      }
      const hours = Math.floor(totalMins / 60);
      const mins = totalMins % 60;
      elements.totalSalary.innerHTML = `
        Počet dní: ${daysCount}<br>
        Celkový čas: ${hours}h ${mins}m (${(totalMins / 60).toFixed(state.decimalPlaces)} h)<br>
        Hrubá mzda: ${formatCurrency(totalGross)}<br>
        Čistá mzda: ${formatCurrency(totalNet)}<br>
        Priemer/den: ${formatCurrency(daysCount ? totalNet / daysCount : 0)}
      `;
    };

    const calculateAndSave = () => {
      for (let i = 1; i <= getDaysInMonth(); i++) calculateRow(i);
      calculateTotal();
      saveData();
    };

    // Export Functions
    window.exportToPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - ${elements.monthSelect.options[state.currentMonth].text} ${state.currentYear}`, 14, 20);
      doc.setFontSize(12);
      doc.text(`Pracovník: ${state.employeeName}`, 14, 30);
      const tableData = Array.from({ length: getDaysInMonth() }, (_, i) => {
        const day = i + 1;
        return [
          `Deň ${day}`,
          document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '',
          document.getElementById(`end-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '',
          document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '0',
          document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${day}`)?.textContent || '',
          document.getElementById(`gross-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '0',
          document.getElementById(`net-${state.currentYear}-${state.currentMonth}-${day}`)?.value || '0'
        ];
      }).filter(row => row[1] || row[2] || row[3]);
      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá (€)', 'Čistá (€)']],
        body: tableData,
        startY: 40
      });
      doc.text(elements.totalSalary.textContent, 14, doc.lastAutoTable.finalY + 10);
      doc.save(`brunos-calculator-${state.currentMonth + 1}-${state.currentYear}.pdf`);
    };

    window.sendPDF = () => {
      // Similar to exportToPDF, but with sharing (unchanged logic)
    };

    window.createBackup = () => {
      const data = collectData();
      const ws = XLSX.utils.json_to_sheet(data.data.map((d, i) => ({
        Deň: i + 1,
        Príchod: d.start,
        Odchod: d.end,
        Prestávka: d.breakTime,
        Hrubá: d.gross,
        Čistá: d.net
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Data');
      XLSX.writeFile(wb, `backup-${state.currentMonth + 1}-${state.currentYear}.xlsx`);
    };

    window.restoreBackup = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          const data = XLSX.read(ev.target.result, { type: 'array' });
          const sheet = data.Sheets[data.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          const restoredData = {
            data: json.map(row => ({
              start: row['Príchod'] || '',
              end: row['Odchod'] || '',
              breakTime: row['Prestávka'] || '',
              gross: row['Hrubá'] || '0',
              net: row['Čistá'] || '0'
            })),
            hourlyWage: state.hourlyWage,
            taxRate: state.taxRate,
            employeeName: state.employeeName,
            decimalPlaces: state.decimalPlaces
          };
          localStorage.setItem(`workData-${state.currentYear}-${state.currentMonth}`, JSON.stringify(restoredData));
          applyData(restoredData);
        };
        reader.readAsArrayBuffer(file);
      };
      input.click();
    };

    // Event Listeners
    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    };

    elements.loginForm.addEventListener('submit', login);
    elements.hourlyWageInput.addEventListener('input', () => { state.hourlyWage = parseFloat(elements.hourlyWageInput.value) || 0; calculateAndSave(); });
    elements.taxRateInput.addEventListener('input', () => { state.taxRate = (parseFloat(elements.taxRateInput.value) || 0) / 100; calculateAndSave(); });
    elements.employeeNameInput.addEventListener('input', () => { state.employeeName = elements.employeeNameInput.value; saveData(); });
    elements.monthSelect.addEventListener('change', () => { state.currentMonth = parseInt(elements.monthSelect.value); updateUI(); });
    elements.yearSelect.addEventListener('change', () => { state.currentYear = parseInt(elements.yearSelect.value); updateUI(); });
    elements.decimalPlacesSelect.addEventListener('change', () => { state.decimalPlaces = parseInt(elements.decimalPlacesSelect.value); calculateAndSave(); });

    window.addEventListener('online', () => { state.isOnline = true; elements.subtitle.textContent = 'Online'; saveData(); });
    window.addEventListener('offline', () => { state.isOnline = false; elements.subtitle.textContent = 'Offline'; });

    // Initialization
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
    populateSelects();
    onAuthStateChanged(auth, (user) => {
      state.currentUser = user;
      updateUI();
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
