<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator Pro</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></ aplik√°cie ‚ñº</button>
        <div id="settings-collapsible-content">
            <fieldset>
                <legend>Z√°kladn√© nastavenia</legend>
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="hourlyWageInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="text" inputmode="decimal" id="taxRateInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                      <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                    </select>
                </div>
            </fieldset>
             <fieldset>
                <legend>Navig√°cia v ƒçase</legend>
                <div>
                    <label for="monthSelect">Mesiac:</label>
                    <select id="monthSelect" onchange="changeMonth()"></select>
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
            </fieldset>
        </div>
    </div>svg>">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <meta name="theme-color" content="#7c3aed"/>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* CSS ≈°t√Ωly zost√°vaj√∫ rovnak√© ako vo va≈°om k√≥de */
    :root {
      --primary-bg-color: #f0f2f5;
      --secondary-bg-color: #ffffff;
      --primary-text-color: #1f2937;
      --secondary-text-color: #4b5563;
      --input-bg-color: #fefcbf;
      --input-note-bg-color: #e0f2fe;
      --table-header-bg-color: #f9fafb;
      --table-border-color: #e5e7eb;
      --current-day-bg-color: #7c3aed;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #2563eb;
      --btn-primary-hover-bg: #1d4ed8;
      --btn-secondary-bg: #7c3aed;
      --btn-secondary-hover-bg: #6d28d9;
      --btn-danger-bg: #dc2626;
      --btn-danger-hover-bg: #b91c1c;
      --btn-warning-bg: #f59e0b;
      --btn-warning-hover-bg: #d97706;
      --btn-highlight-bg: #f59e0b;
      --btn-text-color: #ffffff;
      --total-salary-bg: #eff6ff;
      --link-color: #2563

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite">V√Ωpoƒçet celkovej mzdy...</div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (s pozn.)</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (XLSX)</button>
        <button class="btn backup-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (XLSX)</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠ta≈• z Cloudu</button>
        <button class="btn warning-btn" onclick="clearMonthData()" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• Mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©.</div>
  <div id="errorNotification" role="alert" aria-live="assertive">Nastala chyba.</div>
  <div id="warningNotification" role="alert" aria-live="assertive">Upozornenie.</div>

  <script type="module">
    // Importy Firebase ... (zost√°vaj√∫ rovnak√©)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-autheb;
      --link-hover-color: #1d4ed8;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --box-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --base-font-size: 16px;
      --focus-outline-color: var(--btn-primary-bg);
      --transition-speed: 0.2s;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2') format('woff2');
      font-weight: 400 700;
      font-style: normal;
      font-display: swap;
    }

    html { font-size: var(--base-font-size); scroll-behavior: smooth; }
    body {
      font-family: var(--font-family); line-height: 1.6; margin: 0; padding: 12px;
      background-color: var(--primary-bg-color); color: var(--primary-text-color);
      font-size: 0.92rem; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    .content-hidden {
      display: none !important;
    }
    #app-loader {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 90vh;
      text-align: center;
    }
    .loader-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0,0,0,0.1);
        border-left-color: var(--btn-primary-bg);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    #app-loader p {
        font.js';
    import {
        initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED,
        collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, writeBatch
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Nahraƒète va≈°imi skutoƒçn√Ωmi kƒæ√∫ƒçmi
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    const app = initializeApp(firebaseConfig);
    try {
       const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) { console.warn("App Check initialization failed.", e); }
    const auth = getAuth(app);
    let db;
    try {
        db = initializeFirestore(app, { localCache: persistentLocalCache({ sizeBytes: CACHE_SIZE_UNLIMITED }) });
    } catch (error) {
        db = initializeFirestore(app, {});
        showErrorNotification("Chyba pri inicializ√°cii offline √∫lo≈æiska.");
    }

    // Defin√≠cie funkci√≠, ktor√© sa volaj√∫ skoro
    function loadAppSettingsFromLocalStorage() {
        appSettings.decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        appSettings.employeeName = localStorage.getItem('employeeName') || '';
        appSettings.hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        appSettings.taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
    }

    function updateUIForAuthStateChange() {
        const isLoggedIn = !!currentUser;
        if (uiRefs.loginFieldset) uiRefs.loginFieldset.style.display = isLoggedIn ? 'none' : 'block';
        if (uiRefs.userInfo) uiRefs.userInfo.style.display = isLoggedIn ? 'flex' : 'none';
        if (isLoggedIn && uiRefs.userEmailSpan) uiRefs.userEmailSpan.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;
        const logoutBtn = uiRefs.userInfo?.querySelector('.reset-btn');
        if (logoutBtn) setLoadingState(logoutBtn, false, "Odhl√°si≈• sa");
        updateAppBadge(getPendingSyncCount());
    }
    // Ostatn√© glob√°lne premenn√© a kon≈°tanty
    let currentUser = null;
    let currentListenerUnsubscribe = null;
    const uiRefs = { /* ... va≈°e uiRefs ... */ };
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let appSettings = { decimalPlaces: 2, employeeName: '', hourlyWage: 10, taxRate: 0.02, };
    const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
    const DAY_NAMES_SHORT = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];
    const PENDING_SYNC_MONTHS_LS_KEY = 'pendingSyncMonthsList';

    // Naƒç√≠tanie elementov pre loader a hlavn√© kontajnery - MUSIA BY≈§-size: 1.1em;
        color: var(--secondary-text-color);
    }

    /* ... (Zvy≈°ok v√°≈°ho CSS zost√°va rovnak√Ω, ako ste ho mali) ... */
    /* ... (Preskoƒçen√© pre struƒçnos≈•, ale vo va≈°om s√∫bore bude cel√Ω) ... */
     #saveNotification, #errorNotification, #warningNotification {
        display: none; position: fixed; bottom: 25px; right: 25px; padding: 15px 22px;
        border-radius: var(--border-radius); font-size: 0.95rem; box-shadow: var(--box-shadow-lg);
        z-index: 10000; opacity: 0; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        transform: translateY(30px); font-weight: 500;
    }
    #saveNotification.show, #errorNotification.show, #warningNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification { background-color: var(--btn-primary-bg); color: white; }
    #errorNotification { background-color: var(--btn-danger-bg); color: white; }
    #warningNotification { background-color: var(--btn-highlight-bg); color: var(--primary-text-color); }
    @media print {
      body { padding: 0; font-size: 10pt; color: #000; background-color: #fff; font-family: Arial, sans-serif;}
      #app-loader { display: none !important; }
      .container { max-width: 100%; margin: 0; padding: 10px; box-shadow: none; border: none;}
      #auth-container, .settings, .btn-container, #localStorageIndicator, #saveNotification, #errorNotification, #warningNotification, .time-btn, .reset-btn { display: none !important; }
      h1 { font-size: 18pt; margin-bottom: 5mm; background: none !important; -webkit-background-clip: unset !important; background-clip: unset !important; color: black !important;}
      h2 { font-size: 12pt; margin-bottom: 8mm; }
      .table-container { overflow: visible; border: 1px solid #ccc; }
      table { width: 100%; page-break-inside: auto; border-collapse: collapse;}
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      th, td { border: 1px solid #ccc !important; padding: 4px 6px; font-size: 9pt; background-color: #fff !important; color: #000 !important; }
      th { font-weight: bold; background-color: #f0f0f0 !important; }
      td input[type="number"][readonly], td input[type="tel"], td input[type="number"], td input[type="text"] {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; text-align: left; width: auto !important; font-size: 9pt !important;
      }
      textarea[id^="note-"] {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; min-height: auto !important; height: auto !important;
          overflow: visible !important; resize: none !important; font-size: 9pt !important; white-space: normal !important;
      }
      #totalSalary {
        margin-top: 10mm; padding: DEFINOVAN√â PRED onAuthStateChanged
    const appLoader = document.getElementById('app-loader');
    const authContainerElement = document.getElementById('auth-container'); // Premenovan√©, aby sa nem√Ωlilo s uiRefs.authContainer
    const mainAppContainerElement = document.querySelector('.container:not(#auth-container)'); // Premenovan√©


    // ... (v≈°etky va≈°e funkcie - Badging API, pomocn√©, UI, localStorage, Firestore, tabuƒæka, exporty, atƒè. - ich defin√≠cie sem)
    // D√¥le≈æit√© je, aby loadAppSettingsFromLocalStorage a updateUIForAuthStateChange boli definovan√© PRED ich prv√Ωm volan√≠m.
    // Ostatn√© funkcie, ak s√∫ definovan√© ako "function nazov() {}", m√¥≈æu by≈• definovan√© aj nesk√¥r vƒèaka hoistingu,
    // ale pre prehƒæadnos≈• je lep≈°ie ma≈• ich definovan√© pred prv√Ωm pou≈æit√≠m, ak je to mo≈æn√©.
    async function updateAppBadge(count) { /* ... k√≥d ... */ }
    function getPendingSyncMonths() { /* ... k√≥d ... */ }
    function savePendingSyncMonths(months) { /* ... k√≥d ... */ }
    function addMonthToPendingList(monthDocId) { /* ... k√≥d ... */ }
    function removeMonthFromPendingList(monthDocId) { /* ... k√≥d ... */ }
    function getPendingSyncCount() { /* ... k√≥d ... */ }
    if ('serviceWorker' in navigator) { navigator.serviceWorker.addEventListener('message', event => { if (event.data && event.data.type === 'NETWORK_STATUS_ONLINE') { console.log('[App] Received NETWORK_STATUS_ONLINE from SW.'); if (currentUser && navigator.onLine) { showNotification('saveNotification', 'Pripojenie obnoven√©. Sp√∫≈°≈•am synchroniz√°ciu...', 3000); syncPendingWorkData(); } } }); }
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') { 8px; border: 1px solid #ccc; background-color: #f9f9f9 !important;
        color: #000 !important; box-shadow: none; page-break-before: auto;
      }
      a { text-decoration: none; color: #000; }
      a[href^="http"]:after { content: " (" attr(href) ")"; font-size: 8pt; }
      .current-day, .current-day td, .current-day th, .current-day input, .current-day textarea {
          background-color: #fff !important; color: #000 !important; border-color: #ccc !important;
      }
      .current-day span[aria-hidden="true"], #workDays td:nth-child(1) span[aria-hidden="true"] { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="app-loader">
    <div class="loader-spinner"></div>
    <p>Naƒç√≠tavam aplik√°ciu...</p>
  </div>

  <div id="auth-container" class="content-hidden" style="margin-bottom: 20px;">
      <fieldset id="login-fieldset">
        <legend>Prihl√°senie / Registr√°cia</legend>
        <div id="login-form">
          <input type="email" id="email" placeholder="Email" aria-label="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Heslo" aria-label="Heslo" autocomplete="current-password">
          <button class="btn export-btn" onclick="loginUser()">Prihl√°si≈• sa</button>
          <button class="btn export-btn" onclick="registerUser()">Registrova≈•</button>
          <a href="#" onclick="resetUserPassword(); return false;">Zabudli ste heslo?</a>
        </div>
      </fieldset>
      <div id="user-info" style="display: none; justify-content: center; align-items: center; gap: 15px; margin-top:10px;">
        <span id="user-email" style="font-weight:500;"></span>
        <button class="btn reset-btn" onclick="logoutUser()" style="padding: 8px 15px; font-size: 0.85rem; margin:0;">Odhl√°si≈• sa</button>
      </div>
  </div>

  <div class="container content-hidden"> <!-- Hlavn√Ω kontajner aplik√°cie -->
    <!-- ... (Obsah hlavn√©ho kontajnera zost√°va rovnak√Ω) ... -->
    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <div class="settings">
        <button id="toggleSettingsBtn" class="btn" aria-expanded="false" aria-controls="settings-collapsible-content">Zobrazi≈• nastavenia aplik√°cie ‚ñº</button>
        <div id="settings-collapsible-content">
            <fieldset>
                <legend>Z√°kladn√© nastavenia</legend>
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                 console.log('[App] Tab became visible.'); if (currentUser && navigator.onLine) { if (getPendingSyncCount() > 0) { showNotification('saveNotification', 'Kontrolujem ƒçakaj√∫ce d√°ta...', 2000); } syncPendingWorkData(); } updateAppBadge(getPendingSyncCount()); } });
    function getDaysInMonth(month, year) { /* ... k√≥d ... */ }
    function getDayName(year, month, day) { /* ... k√≥d ... */ }
    function isWeekend(year, month, day) { /* ... k√≥d ... */ }
    const debounce = (func, wait) => { /* ... k√≥d ... */ };
    function isValidTimeFormat(timeString) { /* ... k√≥d ... */ }
    function showNotification(id, message, duration = 3500) { /* ... k√≥d ... */ }
    window.showSaveNotification = (message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©.') => showNotification('saveNotification', message);
    window.showErrorNotification = (message) => showNotification('errorNotification', message, 5000);
    window.showWarningNotification = (message) => showNotification('warningNotification', message, 4500);
    function setLoadingState(button, isLoading, originalText = "Sprac√∫vam...") { /* ... k√≥d ... */ }
    function saveAppSettingToLocalStorage(key, value) { /* ... k√≥d ... */ }
    async function saveAppSettingsToFirestore() { /* ... k√≥d ... */ }
    const debouncedSaveAppSettingsToFirestore = debounce(saveAppSettingsToFirestore, 1800);
    async function loadUserAppSettingsFromFirestore() { /* ... k√≥d ... */ }
    function updateSettingsUIInputs() { /* ... k√≥d ... */ }
    function initializeUIelements() {
        loadAppSettingsFromLocalStorage();
        MONTH_NAMES.forEach((name, index) => { const option = document.createElement('option'); option.value = index; option.textContent = name; uiRefs.monthSelect.appendChild(option); });
        const startYear = 2020, endYear = currentDate.getFullYear() + 5;
        for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; uiRefs.yearSelect.appendChild(option); }
        if(uiRefs.monthSelect && uiRefs.yearSelect) { // Pridan√° kontrola
            uiRefs.monthSelect.value = currentMonth;
            uiRefs.yearSelect.value = currentYear;
        }
        updateSettingsUIInputs();
        updateLocalStorageSizeIndicator();
    }
    window.updateEmployeeName = function() { /* ... k√≥d ... */ }
    window.handleNumericInput = function(inputElement) { /* ... k√≥d ... */ }
    window.handleWageOrTaxBlur = function(inputElement) { /* ... k√≥d ... */ }
    window.changeDecimalPlaces = function() { /* ... k√≥d ... */ }
    function recalculateAllRowsAndUpdateTotal() { /* ... k√≥d ... */ }
    function updatePageTitleAndGreeting() { /* ... k√≥d s emoji ... */ }
    function updateLocalStorageSizeIndicator() { /* ... k√≥d ... */ }
    const authErrorMap = { /* ... k√≥d ... */ };
    function mapFirebaseAuthError(code) { /* ... k√≥d ... */ }
    window.loginUser = async function() { /* ... k√≥d ... */ };
    window.registerUser = async function() { /* ... k√≥d ... */ };
    async function createUserCollectionAndSettings() { /* ... k√≥d ... */ }
    window.logoutUser = async function() { /* ... k√≥d ... */ };
    window.resetUserPassword = async function() { /* ... k√≥d ... */ };
    function setupFirestoreWorkDataListener() { /* ... k√≥d ... */ }
    const _debouncedSaveWorkDataAndSync = debounce(async () => { /* ... k√≥d ... */ }, 1200);
    window.debouncedSaveWorkDataAndSync = _debouncedSaveWorkDataAndSync;
    function getFirestoreDocId(year, month) { /* ... k√≥d ... */ }
    function getLocalStorageKeyForWorkData(docId) { /* ... k√≥d ... */ }
    function getPendingSyncKeyForMonth(docId) { /* ... k√≥d ... */ }
    function collectWorkDataForStorage() { /* ... k√≥d ... */ }
    async function saveWorkDataToFirestore(dataToSave, docId) { /* ... k√≥d ... */ }
    async function syncPendingWorkData() { /* ... k√≥d ... */ }
    window.loadFromFirestore = async function() { /* ... k√≥d ... */ };
    function loadWorkDataFromLocalStorage() { /* ... k√≥d ... */ }
    function parseAndApplyWorkData(dataString) { /* ... k√≥d ... */ }
    function resetTableInputsOnly() { /* ... k√≥d ... */ }
    function createTable() { /* ... k√≥d ... */ }
    window.setCurrentTime = function(inputId, day) { /* ... k√≥d ... */ }
    window.handleTimeInput = function(input, nextId, day) { /* ... k√≥d ... */ }
    window.validateAndFormatTimeBlur = function(input, day) { /* ... k√≥d ... */ }
    function formatTimeInputOnly(input) { /* ... k√≥d ... */ }
    window.handleBreakInput = function(day) { /* ... k√≥d ... */ }
    window.handleNoteInput = function(textarea) { /* ... k√≥d ... */ }
    </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="hourlyWageInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="text" inputmode="decimal" id="taxRateInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                      <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                    </select>
                </div>
            </fieldset>
             <fieldset>
                <legend>Navig√°cia v ƒçase</legend>
                <div>
                    <label for="monthSelect">Mesiac:</label>
                    <select id="monthSelect" onchange="changeMonth()"></select>
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite">V√Ωpoƒçet celkfunction autoResizeTextarea(textarea) { /* ... k√≥d ... */ }
    function calculateRow(day) { /* ... k√≥d ... */ }
    window.resetRow = function(day) { /* ... k√≥d ... */ }
    window.clearMonthData = async function() { /* ... k√≥d ... */ }
    function calculateTotal() { /* ... k√≥d ... */ }
    window.exportToPDF = async function() { /* ... k√≥d ... */ }
    window.sendPDF = async function() { /* ... k√≥d ... */ }
    window.createBackup = function() { /* ... k√≥d ... */ };
    window.restoreBackup = function() { /* ... k√≥d ... */ };
    window.changeMonth = function() { /* ... k√≥d ... */ }
    window.changeYear = function() { /* ... k√≥d ... */ }
    if(uiRefs.toggleSettingsBtn) uiRefs.toggleSettingsBtn.addEventListener('click', () => { /* ... k√≥d ... */ }); // Pridan√° kontrola
    window.addEventListener('online', () => { /* ... k√≥d ... */ });
    window.addEventListener('offline', () => { /* ... k√≥d ... */ });
    function handleOnlineStatusChange(online) { /* ... k√≥d ... */ }


    // Hlavn√° logika po naƒç√≠tan√≠ DOM a Firebase Auth
    onAuthStateChanged(auth, async (user) => {
        currentUser = user;

        // Najprv spracujeme, ktor√Ω kontajner m√° by≈• viditeƒæn√Ω
        if (user) {
            if (authContainerElement) authContainerElement.classList.add('content-hidden');
            if (mainAppContainerElement) mainAppContainerElement.classList.remove('content-hidden');
        } else {
            if (mainAppContainerElement) mainAppContainerElement.classList.add('content-hidden');
            if (authContainerElement) authContainerElement.classList.remove('content-hidden');
        }

        // Teraz vol√°me updateUIForAuthStateChange, ktor√° by u≈æ mala by≈• definovan√°
        updateUIForAuthStateChange();

        // Ostatn√° logika ≈°pecifick√° pre prihl√°sen√©ho/neprihl√°sen√©ho pou≈æ√≠vateƒæa
        if (user) {
            const settingsLoadedFromFS = await loadUserAppSettingsFromFirestore();
            if (!settingsLoadedFromFS) {
                loadAppSettingsFromLocalStorage();
                updateSettingsUIInputs();
                if (navigator.onLine) await saveAppSettingsToFirestore();
            }
            syncPendingWorkData();
        } else {
            loadAppSettingsFromLocalStorage();
            updateSettingsUIInputs();
            localStorage.removeItem(PENDING_SYNC_MONTHS_LS_KEY);
            updateAppBadge(0); // Vynulova≈• odznak pri odhl√°sen√≠
        }

        // Skryjeme loader a≈æ keƒè je v≈°etko pripraven√© na zobrazenie
        if (appLoader) appLoader.classList.add('content-hidden');

        // A≈æ teraz, keƒè je UI pripraven√©, vytvor√≠me tabuƒæku a naƒç√≠tame d√°ta
        if(uiRefs.workDaysTbody) { // Kontrola, ƒçi je tbody dostupn√©
            createTable();
            setupFirestoreWorkDataListener();
        }
        updatePageTitleAndGreeting();
    });

    initializeUIelements(); // Volanie z√°kladn√©ho UI setupu (napr. naplnenie selectov)

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigatorovej mzdy...</div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (s pozn.)</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (XLSX)</button>
        <button class="btn backup-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (XLSX)</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠ta≈• z Cloudu</button>
        <button class="btn warning-btn" onclick="clearMonthData()" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• Mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©.</div>
  <div id="errorNotification" role="alert" aria-live="assertive">Nastala chyba.</div>
  <div id="warningNotification" role="alert" aria-live="assertive">Upozornenie.</div>

  <script type="module">
    // Importy Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
        initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED,
        collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, writeBatch
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js';

    const firebaseConfig = { /* ... Va≈°a Firebase konfigur√°cia ... */ };
    const app = initializeApp(firebaseConfig);
    try {
       const appCheck = initializeAppCheck(app, { /* ... App Check konfigur√°cia ... */ });
    } catch (e) { console.warn("App Check initialization failed.", e); }
    const auth = getAuth(app);
    let db;
    try {
        db = initializeFirestore(app, { localCache: persistentLocalCache({ sizeBytes: CACHE_SIZE_UNLIMITED }) });
    } catch (error) {
        db = initializeFirestore(app, {});
        showErrorNotification("Chyba pri inicializ√°cii offline √∫lo≈æiska."); // showNotification mus√≠ by≈• definovan√° sk√¥r
    }

    // --- DEFIN√çCIE KƒΩ√öƒåOV√ùCH FUNKCI√ç (presunut√© sem) ---
    function loadAppSettingsFromLocalStorage() {
        appSettings.decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        appSettings.employeeName = localStorage.getItem('employeeName') || '';
        appSettings.hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        appSettings.taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
    }

    function updateUIForAuthStateChange() {
        const isLoggedIn = !!currentUser;
        if (uiRefs.loginFieldset) uiRefs.loginFieldset.style.display = isLoggedIn ? 'none' : 'block';
        if (uiRefs.userInfo) uiRefs.userInfo.style.display = isLoggedIn ? 'flex' : 'none';
        if (isLoggedIn && uiRefs.userEmailSpan) uiRefs.userEmailSpan.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;
        const logoutBtn = uiRefs.userInfo?.querySelector('.reset-btn');
        if (logoutBtn) setLoadingState(logoutBtn, false, "Odhl√°si≈• sa");
        updateAppBadge(getPendingSyncCount());
    }
    // --- KONIEC DEFIN√çCI√ç KƒΩ√öƒåOV√ùCH FUNKCI√ç ---

    let currentUser = null;
    let currentListenerUnsubscribe = null;
    const uiRefs = { /* ... Va≈°e uiRefs ... */ };
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let appSettings = { /* ... Va≈°e appSettings ... */ };
    const MONTH_NAMES = [/* ... */];
    const DAY_NAMES_SHORT = [/* ... */];
    const PENDING_SYNC_MONTHS_LS_KEY = 'pendingSyncMonthsList';

    const appLoader = document.getElementById('app-loader');
    const authContainer = document.getElementById('auth-container');
    const mainAppContainer = document.querySelector('.container:not(#auth-container)');

    async function updateAppBadge(count) { /* ... k√≥d ... */ }
    function getPendingSyncMonths() { /* ... k√≥d ... */ }
    function savePendingSyncMonths(months) { /* ... k√≥d ... */ }
    function addMonthToPendingList(monthDocId) { /* ... k√≥d ... */ }
    function removeMonthFromPendingList(monthDocId) { /* ... k√≥d ... */ }
    function getPendingSyncCount() { /* ... k√≥d ... */ }

    if ('serviceWorker' in navigator) { /* ... k√≥d SW listenera ... */ }
    document.addEventListener('visibilitychange', () => { /* ... k√≥d visibility listenera ... */ });

    function getDaysInMonth(month, year) { /* ... k√≥d ... */ }
    function getDayName(year, month, day) { /* ... k√≥d ... */ }
    function isWeekend(year, month, day) { /* ... k√≥d ... */ }
    const debounce = (func, wait) => { /* ... k√≥d ... */ };
    function isValidTimeFormat(timeString) { /* ... k√≥d ... */ }
    
    // Defin√≠cia showNotification mus√≠ by≈• pred jej prv√Ωm pou≈æit√≠m (napr. v catch bloku pre Firestore init)
    .serviceWorker.register('./service-worker.js')
          .then(reg => { /* console.log('SW registered.'); */ })
          .catch(err => { console.error('SW registration failed:', err); });
      });
    }
  </script>
</body>
</html>
