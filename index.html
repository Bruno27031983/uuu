<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Vylep≈°en√Ω titulok a popis pre SEO a zdieƒæanie -->
  <title>Bruno's Calculator | Evidencia doch√°dzky a miezd</title>
  <meta name="description" content="Jednoduch√° a efekt√≠vna kalkulaƒçka na sledovanie pracovnej doby a v√Ωpoƒçet hrubej/ƒçistej mzdy s mo≈ænos≈•ou exportu a online synchroniz√°cie.">
  <meta name="theme-color" content="#4CAF50"> <!-- Farba pre UI prehliadaƒça na mobile -->

  <!-- Odkaz na manifest (RELAT√çVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />
  <!-- Ikony pre PWA (Pr√≠klad - dopl≈àte si vlastn√©) -->
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" href="/icons/icon-192x192.png">

  <!-- Kni≈ænice pre export do PDF a Excelu (Zv√°≈æi≈• lok√°lnu k√≥piu alebo npm pre PWA offline) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js" integrity="sha512-ma4tP8ZgmhT0dku6vRkiL5B6Uj+NTrx+Ff0q0uA9vMzA2u5C+gC73t+uXy2fSTXp0y8o+34+F9rT/F94qZkS2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvCbOBVEZmKP+NuMncJMzVxjHCLP9HznAOQSgVU5lTwnAMCjCRaPVWIVruubqk9TQZePtv4bQ9PYAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> <!-- Nov≈°ia verzia XLSX -->

  <style>
    /* ----- Z√°kladn√© ≈°t√Ωly a premenn√© ----- */
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #8a2be2;
      --danger-color: #f44336;
      --warning-color: #ffcc00;
      --light-bg: #f4f4f4;
      --dark-bg: #333;
      --light-card-bg: white;
      --dark-card-bg: #444;
      --light-text: #333;
      --dark-text: #f4f4f4;
      --input-light-bg: #ffffd0;
      --input-dark-bg: #666;
      --border-color-light: #ddd;
      --border-color-dark: #555;
      --header-bg-light: #f2f2f2;
      --header-bg-dark: #666;
      --link-color: #007bff;
      --gradient-start: #ff0000;
      --gradient-mid1: #00ff00;
      --gradient-mid2: #0000ff;
      --gradient-mid3: #ffff00;
      --gradient-end: #ff00ff;

      --font-family: Arial, sans-serif;
      --base-font-size: 16px;
      --line-height: 1.6;
      --border-radius: 5px;
      --box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      --transition-speed: 0.3s;
    }

    body {
      font-family: var(--font-family);
      line-height: var(--line-height);
      margin: 0;
      padding: 10px;
      background-color: var(--light-bg);
      color: var(--light-text);
      font-size: var(--base-font-size);
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--light-card-bg);
      padding: 20px; /* Viac paddingu */
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    /* ----- Typografia ----- */
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, var(--gradient-start), var(--gradient-mid1), var(--gradient-mid2), var(--gradient-mid3), var(--gradient-end));
      background-size: 200% 200%; /* Pre plynulej≈°iu anim√°ciu */
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 5px;
    }

    h2 {
      text-align: center;
      color: #555;
      margin-top: 0;
      margin-bottom: 25px; /* Viac priestoru */
      font-size: 1.2em;
      font-weight: normal; /* Menej v√Ωrazn√Ω podnadpis */
    }

    /* ----- Nastavenia ----- */
    .settings {
      margin-bottom: 25px;
      display: grid; /* Pou≈æitie Gridu pre lep≈°ie zarovnanie */
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responz√≠vny grid */
      gap: 15px; /* Medzery medzi prvkami */
      align-items: end; /* Zarovnanie prvkov na spodok */
    }

    .settings > div {
      display: flex;
      flex-direction: column; /* Label nad inputom */
    }

    .settings label {
      margin-bottom: 5px;
      font-size: 0.9em;
      font-weight: bold;
      color: #666;
    }

    /* ----- Tabuƒæka ----- */
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color-light); /* Or√°movanie kontajnera */
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Zachovan√© pre horizont√°lne scrollovanie */
    }

    th, td {
      padding: 10px 12px; /* Viac paddingu */
      border: 1px solid var(--border-color-light);
      text-align: left;
      font-size: 0.95em; /* Trochu v√§ƒç≈°ie p√≠smo */
      vertical-align: middle; /* Vertik√°lne centrovanie */
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    th {
      background-color: var(--header-bg-light);
      font-weight: bold; /* Zd√¥raznenie hlaviƒçky */
      white-space: nowrap; /* Zabr√°ni l√°maniu textu v hlaviƒçke */
    }

    /* ≈†pecifick√© ≈°√≠rky stƒ∫pcov (zachovan√©, ale mo≈æno prehodnoti≈•) */
    th:nth-child(6), td:nth-child(6), /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { /* ƒåist√° Mzda */
        /* width: 20%; Rad≈°ej necha≈• auto alebo pou≈æi≈• relat√≠vne jednotky */
        min-width: 110px; /* Minim√°lna ≈°√≠rka */
    }
     th:nth-child(5), td:nth-child(5) { /* Odpracovan√© */
         min-width: 130px;
     }

    tbody tr:hover td {
        background-color: rgba(0, 0, 0, 0.03); /* Jemn√© zv√Ωraznenie pri hoveri */
    }

    /* ----- Formul√°rov√© prvky ----- */
    input[type="tel"],
    input[type="number"],
    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
      width: 100%;
      padding: 8px 10px; /* Viac paddingu */
      box-sizing: border-box;
      background-color: var(--input-light-bg);
      font-size: 1em; /* konzistentn√° veƒækos≈• */
      border: 1px solid var(--border-color-light);
      border-radius: calc(var(--border-radius) - 2px);
      transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
    }

    /* ≈†pecifick√© pre ƒç√≠seln√© vstupy v tabuƒæke */
    td input[type="number"] {
        background-color: transparent; /* Readonly polia bez ≈æltej */
        border: none; /* Readonly polia bez or√°movania */
        padding-left: 0;
        padding-right: 0;
        -moz-appearance: textfield; /* Skrytie ≈°√≠pok v Firefoxe */
    }
    td input[type="number"]::-webkit-outer-spin-button,
    td input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none; /* Skrytie ≈°√≠pok v Chrome/Safari */
        margin: 0;
    }

    /* ----- Tlaƒçidl√° ----- */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Centrovanie tlaƒçidiel */
      gap: 10px; /* Medzery medzi tlaƒçidlami */
      margin-top: 25px;
    }

    .btn {
      padding: 10px 20px;
      color: white;
      background-color: var(--primary-color); /* Predvolen√° farba */
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      text-align: center;
      transition: background-color var(--transition-speed) ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-flex; /* Pre zarovnanie ikon */
      align-items: center;
      justify-content: center;
      gap: 5px; /* Medzera medzi textom a ikonou */
    }
    .btn:hover {
      background-color: #388e3c; /* Stmavenie prim√°rnej farby */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px); /* Jemn√Ω posun hore */
    }
    .btn:active {
        transform: translateY(0); /* Sp√§≈• pri kliknut√≠ */
        box-shadow: none;
    }
    .btn:disabled { /* ≈†t√Ωl pre deaktivovan√© tlaƒçidl√° */
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .reset-btn { background-color: var(--danger-color); }
    .reset-btn:hover { background-color: #d32f2f; }

    .export-btn { background-color: var(--primary-color); } /* Zjednoten√© s .btn */
    .export-btn:hover { background-color: #388e3c; }

    .backup-btn { background-color: var(--secondary-color); }
    .backup-btn:hover { background-color: #6a1bb2; }

    .highlight-btn { background-color: var(--warning-color); color: var(--light-text); }
    .highlight-btn:hover { background-color: #e6b800; }

    /* Tlaƒçidlo pre vynulovanie riadku */
    td .reset-btn {
        padding: 5px 8px;
        font-size: 0.8em;
        min-width: 80px; /* Aby sa zmestil text */
    }


    /* ----- Celkov√© v√Ωsledky ----- */
    #totalSalary {
      font-size: 1.1em; /* Trochu v√§ƒç≈°√≠ */
      font-weight: bold;
      text-align: center;
      margin-top: 25px;
      padding: 15px;
      background-color: #e6f3ff;
      border-radius: var(--border-radius);
      border: 1px solid #cce0ff; /* Jemn√© or√°movanie */
      line-height: 1.8; /* Viac miesta medzi riadkami */
    }
    #totalSalary strong {
        color: var(--primary-color); /* Zd√¥raznenie priemeru */
    }

    /* ----- Veƒækos≈• d√°t (nepou≈æit√©, ale ≈°t√Ωly ponechan√©) ----- */
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: var(--primary-color); transition: width var(--transition-speed) ease; }

    /* ----- Zv√Ωraznenie aktu√°lneho d≈àa ----- */
    .current-day td { /* Zv√Ωraznenie cel√©ho riadku */
      background-color: #e8dff5; /* Jemnej≈°ia fialov√° */
    }
    .current-day td:first-child {
        font-weight: bold; /* Zd√¥raznenie n√°zvu d≈àa */
    }
    .current-day input { /* Inputy v aktu√°lnom dni */
      background-color: #f5f0fa;
      font-weight: bold; /* Mierne zd√¥raznenie textu v inpute */
    }

    /* ----- Tmav√Ω re≈æim ----- */
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    body.dark-mode .container { background-color: var(--dark-card-bg); }
    body.dark-mode h2 { color: #bbb; }
    body.dark-mode .settings label { color: #ccc; }
    body.dark-mode table { border-color: var(--border-color-dark); }
    body.dark-mode th { background-color: var(--header-bg-dark); border-color: var(--border-color-dark); }
    body.dark-mode td { border-color: var(--border-color-dark); }
    body.dark-mode tbody tr:hover td { background-color: rgba(255, 255, 255, 0.05); }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode input[type="email"],
    body.dark-mode input[type="password"],
    body.dark-mode select {
      background-color: var(--input-dark-bg);
      color: var(--dark-text);
      border-color: var(--border-color-dark);
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
      border-color: var(--secondary-color); /* In√° farba focusu v tmavom re≈æime */
      box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.4);
    }
    body.dark-mode #totalSalary {
        background-color: #2c3e50;
        border-color: #3b536d;
    }
    body.dark-mode #totalSalary strong { color: var(--warning-color); }
    body.dark-mode .current-day td { background-color: #4a0e8f; }
    body.dark-mode .current-day input { background-color: #5c1db3; }
    body.dark-mode .btn { /* Tmav√© tlaƒçidl√° s bielym textom */ color: white; }
    /* Farby tlaƒçidiel v tmavom re≈æime - m√¥≈æu zosta≈• rovnak√© alebo sa upravi≈• */
    body.dark-mode .reset-btn { background-color: #c62828; }
    body.dark-mode .reset-btn:hover { background-color: #a52020; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .export-btn:hover { background-color: #2a6d2d; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode .backup-btn:hover { background-color: #52158a; }
    body.dark-mode .highlight-btn { background-color: #e6b800; color: var(--dark-bg); }
    body.dark-mode .highlight-btn:hover { background-color: #cca300; }
    body.dark-mode ::-webkit-calendar-picker-indicator { filter: invert(1); } /* Lep≈°ia viditeƒænos≈• kalend√°ra */
    body.dark-mode .table-container { border-color: var(--border-color-dark); }


    /* ----- Anim√°cie ----- */
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 15px rgba(255, 255, 255, 0.2), 0 0 25px rgba(255, 255, 255, 0.1); }
      50% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.7), 0 0 35px rgba(255, 255, 255, 0.5); }
    }

    /* ----- Notifik√°cie ----- */
    .notification {
      display: none; /* Skryt√© defaultne, ovl√°dan√© JS */
      position: fixed;
      bottom: 20px;
      left: 50%; /* Centrovanie */
      transform: translateX(-50%); /* Presn√© centrovanie */
      padding: 12px 25px;
      border-radius: var(--border-radius);
      font-size: 0.95em;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1001; /* Nad ostatn√Ωmi prvkami */
      opacity: 0;
      transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out;
      min-width: 250px; /* Minim√°lna ≈°√≠rka */
      text-align: center;
    }
    .notification.show {
      display: block;
      opacity: 1;
      bottom: 30px; /* Posun hore pri zobrazen√≠ */
    }
    #saveNotification { background-color: var(--primary-color); color: white; }
    #errorNotification { background-color: var(--danger-color); color: white; }
    #syncNotification { background-color: var(--secondary-color); color: white; } /* Nov√° notifik√°cia pre sync */

    /* ----- Login formul√°r ----- */
    #login-form {
      display: none; /* Skryt√Ω defaultne */
      flex-direction: column;
      align-items: center;
      gap: 10px; /* Medzery medzi prvkami */
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid var(--border-color-light);
      border-radius: var(--border-radius);
      max-width: 300px; /* Obmedzenie ≈°√≠rky */
      margin-left: auto;
      margin-right: auto;
    }
    #login-form input { width: 100%; }
    #login-form .btn-group { display: flex; gap: 10px; } /* Tlaƒçidl√° vedƒæa seba */

    #user-info {
        display: none; /* Skryt√© defaultne */
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f0f0f0; /* Jemn√© pozadie */
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color-light);
        display: flex; /* Zarovnanie emailu a tlaƒçidla */
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    #user-info span { font-weight: bold; }
    #user-info .btn { padding: 8px 15px; font-size: 0.9em; } /* Men≈°ie odhlasovacie tlaƒçidlo */

    /* ----- Indik√°tor stavu pripojenia ----- */
    #connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: var(--border-radius);
        font-size: 0.8em;
        font-weight: bold;
        z-index: 1000;
        opacity: 0.8;
        transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }
    #connection-status.online { background-color: var(--primary-color); color: white; }
    #connection-status.offline { background-color: var(--danger-color); color: white; }
    #connection-status.syncing { background-color: var(--secondary-color); color: white; }

    /* ----- Loading indik√°tor ----- */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    body.dark-mode .loading-overlay {
        background-color: rgba(0, 0, 0, 0.7);
    }
    .loading-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .spinner { /* Jednoduch√Ω CSS spinner */
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s ease infinite;
    }
    body.dark-mode .spinner {
        border-left-color: var(--secondary-color);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ----- Pr√≠stupnos≈• ----- */
    /* Zv√Ωraznenie focusu pre kl√°vesnicov√∫ navig√°ciu */
    *:focus-visible {
        outline: 2px solid var(--secondary-color);
        outline-offset: 2px;
        box-shadow: none; /* Reset in√Ωch focus ≈°t√Ωlov */
    }
    body.dark-mode *:focus-visible {
         outline-color: var(--warning-color);
    }

    /* ----- Responzivita ----- */
    @media (max-width: 992px) {
        .settings {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Men≈°ie stƒ∫pce pre tablety */
        }
    }

    @media (max-width: 768px) {
      body { padding: 5px; font-size: 15px; }
      .container { padding: 15px; }
      h1 { font-size: 2em; }
      h2 { font-size: 1.1em; }
      .settings { grid-template-columns: 1fr 1fr; } /* Dva stƒ∫pce na men≈°√≠ch tabletoch */
      th, td { padding: 8px 10px; font-size: 0.9em; }
      .btn-container { flex-direction: column; align-items: stretch; } /* Tlaƒçidl√° pod sebou */
      .btn { font-size: 0.95em; }
      #totalSalary { font-size: 1em; padding: 12px; }
      .notification { width: 90%; left: 5%; transform: translateX(0); font-size: 0.9em; }
      #user-info { flex-direction: column; gap: 5px; }
    }

    @media (max-width: 480px) {
      body { font-size: 14px; }
      .container { padding: 10px; }
      h1 { font-size: 1.6em; }
      h2 { font-size: 1em; }
      .settings { grid-template-columns: 1fr; } /* Jeden stƒ∫pec na mobiloch */
      th, td { font-size: 0.8em; padding: 6px 8px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 0.9em; }
      .btn { font-size: 0.9em; padding: 10px 15px; }
      td .reset-btn { min-width: 70px; font-size: 0.75em; }
      #totalSalary { font-size: 0.95em; }
    }

  </style>
</head>
<body>
  <!-- Indik√°tor stavu pripojenia a synchroniz√°cie -->
  <div id="connection-status">Offline</div>

  <div class="container">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Autentifikaƒçn√© UI -->
    <div id="auth-container" style="margin-bottom: 20px;">
      <!-- Login/Register Form -->
      <form id="login-form" onsubmit="event.preventDefault();"> <!-- Pou≈æitie form pre lep≈°iu s√©mantiku -->
        <input type="email" id="email" placeholder="Email" required aria-label="Email">
        <input type="password" id="password" placeholder="Heslo" required aria-label="Heslo">
        <div class="btn-group">
            <button type="button" class="btn export-btn" onclick="login()" aria-label="Prihl√°si≈• sa">Prihl√°si≈• sa</button>
            <button type="button" class="btn export-btn" onclick="register()" aria-label="Registrova≈• sa">Registrova≈•</button>
        </div>
      </form>
      <!-- User Info and Logout -->
      <div id="user-info">
        Prihl√°sen√Ω ako: <span id="user-email" aria-live="polite"></span>
        <button class="btn reset-btn" onclick="logout()" aria-label="Odhl√°si≈• sa">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="subTitle">Evidencia doch√°dzky a v√Ωpoƒçet mzdy</h2> <!-- Pridan√Ω podnadpis -->

    <!-- Nastavenia -->
    <section aria-labelledby="settings-heading"> <!-- Sekcia pre pr√≠stupnos≈• -->
        <h3 id="settings-heading" class="visually-hidden">Nastavenia v√Ωpoƒçtu</h3> <!-- Skryt√Ω nadpis pre screen readery -->
        <div class="settings">
          <div>
            <label for="employeeNameInput">Meno pracovn√≠ka:</label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()" aria-label="Meno pracovn√≠ka">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()" aria-label="Hodinov√° mzda v eur√°ch">
          </div>
          <div>
            <label for="taxRateInput">Da≈àov√© percento (%):</label>
            <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()" aria-label="Da≈àov√© percento">
          </div>
          <div>
            <label for="monthSelect">Mesiac:</label>
            <select id="monthSelect" onchange="changeMonth()" aria-label="Vyberte mesiac">
              <option value="0">Janu√°r</option>
              <option value="1">Febru√°r</option>
              <option value="2">Marec</option>
              <option value="3">Apr√≠l</option>
              <option value="4">M√°j</option>
              <option value="5">J√∫n</option>
              <option value="6">J√∫l</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">Okt√≥ber</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok:</label>
            <select id="yearSelect" onchange="changeYear()" aria-label="Vyberte rok">
              <!-- Dynamicky generovan√© roky -->
            </select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Desatinn√© miesta:</label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()" aria-label="Poƒçet desatinn√Ωch miest pre zobrazenie">
              <option value="1">1</option>
              <option value="2" selected>2</option> <!-- Predvolen√© na 2 miesta -->
              <option value="3">3</option>
            </select>
          </div>
          <button onclick="toggleDarkMode()" class="btn highlight-btn" aria-label="Prep√≠naƒç tmav√©ho/svetl√©ho re≈æimu">
            <!-- Ikona (pr√≠klad - pou≈æi≈• SVG alebo font ikonu) -->
            ‚òÄÔ∏è/üåô Re≈æim
          </button>
        </div>
    </section>

    <!-- Tabuƒæka s d√°tami -->
    <section aria-labelledby="work-data-heading">
        <h3 id="work-data-heading" class="visually-hidden">Z√°znamy doch√°dzky</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th scope="col">De≈à</th>
                <th scope="col">Pr√≠chod</th>
                <th scope="col">Odchod</th>
                <th scope="col">Prest√°vka (h)</th>
                <th scope="col">Odpracovan√©</th>
                <th scope="col">Hrub√° Mzda (‚Ç¨)</th>
                <th scope="col">ƒåist√° Mzda (‚Ç¨)</th>
                <th scope="col">Akcia</th>
              </tr>
            </thead>
            <tbody id="workDays" aria-live="polite" aria-atomic="true">
              <!-- Riadky bud√∫ generovan√© cez JavaScript -->
            </tbody>
          </table>
        </div>
    </section>

    <!-- S√∫ƒçty -->
    <div id="totalSalary" aria-live="polite">
        <!-- S√∫ƒçty bud√∫ generovan√© cez JavaScript -->
        Naƒç√≠tavam s√∫ƒçty...
    </div>

    <!-- Kontajner s tlaƒçidlami akci√≠ -->
    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()" aria-label="Exportova≈• aktu√°lny mesiac do PDF">
          <!-- Ikona --> Export PDF
      </button>
      <button class="btn export-btn" onclick="sendPDF()" aria-label="Odosla≈• aktu√°lny mesiac ako PDF cez zdieƒæanie">
          <!-- Ikona --> Odosla≈• PDF
      </button>
      <button class="btn backup-btn" onclick="createBackup()" aria-label="Vytvori≈• z√°lohu aktu√°lneho mesiaca do Excel s√∫boru">
          <!-- Ikona --> Vytvori≈• z√°lohu (.xlsx)
      </button>
      <button class="btn backup-btn" onclick="triggerRestoreBackup()" aria-label="Obnovi≈• d√°ta pre aktu√°lny mesiac zo z√°lohy Excel">
           <!-- Ikona --> Obnovi≈• z√°lohu (.xlsx)
      </button>
      <input type="file" id="restoreFileInput" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display: none;" onchange="handleRestoreFile(event)">
      <button class="btn export-btn" onclick="loadFromFirestore()" aria-label="Naƒç√≠ta≈• d√°ta pre aktu√°lny mesiac z Firebase cloudu (prep√≠≈°e lok√°lne zmeny)">
          <!-- Ikona --> Naƒç√≠ta≈• z cloudu
      </button>
      <!-- Mo≈æno prida≈•: <button class="btn reset-btn" onclick="resetMonthConfirm()" aria-label="Vynulova≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• mesiac</button> -->
    </div>
  </div>

  <!-- Notifik√°cie -->
  <div id="saveNotification" class="notification" role="status" aria-live="polite"></div>
  <div id="errorNotification" class="notification" role="alert" aria-live="assertive"></div>
  <div id="syncNotification" class="notification" role="status" aria-live="polite"></div>

  <!-- Skryt√° trieda pre screen readery -->
  <style>.visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }</style>

  <!-- Hlavn√Ω JavaScript k√≥d + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, writeBatch, serverTimestamp, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGUR√ÅCIA Firebase --------------------
    // !!! BEZPEƒåNOSTN√â RIZIKO - NIKDY NENECH√ÅVA≈§ V K√ìDE NA KLIENTOVI V PRODUKCII !!!
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // <- Nahradi≈• bezpeƒçn√Ωm sp√¥sobom
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com", // Opraven√Ω storageBucket
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // -------------------- INICIALIZ√ÅCIA APLIK√ÅCIE --------------------
    let app;
    let auth;
    let db;
    let appCheck;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        // App Check - d√¥le≈æit√© pre ochranu backendu
        appCheck = initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // V√°≈° Site Key
          isTokenAutoRefreshEnabled: true
        });
        console.log("Firebase inicializovan√Ω √∫spe≈°ne.");
    } catch (error) {
        console.error("FATAL: Chyba pri inicializ√°cii Firebase:", error);
        showErrorNotification("Kritick√° chyba: Nepodarilo sa pripoji≈• k Firebase. Sk√∫ste obnovi≈• str√°nku.", true); // true = persistent
        // Tu by aplik√°cia mala prejs≈• do nejak√©ho n√∫dzov√©ho re≈æimu alebo informova≈• u≈æ√≠vateƒæa
    }

    // -------------------- KON≈†TANTY A GLOB√ÅLNE PREMENN√â --------------------
    const DOM = { // Objekt pre ƒæah≈°√≠ pr√≠stup k DOM elementom
        workDaysTableBody: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        mainTitle: document.getElementById('mainTitle'),
        subTitle: document.getElementById('subTitle'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        loginForm: document.getElementById('login-form'),
        userInfo: document.getElementById('user-info'),
        userEmailSpan: document.getElementById('user-email'),
        saveNotification: document.getElementById('saveNotification'),
        errorNotification: document.getElementById('errorNotification'),
        syncNotification: document.getElementById('syncNotification'),
        connectionStatus: document.getElementById('connection-status'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        restoreFileInput: document.getElementById('restoreFileInput'),
        // Tlaƒçidl√° pre pr√≠padn√© disabled stavy
        loginButton: document.querySelector('#login-form button[onclick="login()"]'),
        registerButton: document.querySelector('#login-form button[onclick="register()"]'),
        logoutButton: document.querySelector('#user-info button[onclick="logout()"]'),
        loadFromCloudButton: document.querySelector('button[onclick="loadFromFirestore()"]'),
        // ... prida≈• ƒèal≈°ie tlaƒçidl√° podƒæa potreby
    };

    const DEFAULT_DECIMAL_PLACES = 2;
    const SAVE_DEBOUNCE_MS = 1000; // Dlh≈°√≠ debounce pre menej ƒçast√© z√°pisy
    const NOTIFICATION_TIMEOUT_MS = 3000;
    const SYNC_NOTIFICATION_TIMEOUT_MS = 4000;
    const ERROR_NOTIFICATION_TIMEOUT_MS = 5000;

    let currentUser = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || DEFAULT_DECIMAL_PLACES;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10; // Naƒç√≠tanie aj z LS
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02; // Naƒç√≠tanie aj z LS
    let monthDataCache = {}; // Cache pre naƒç√≠tan√© d√°ta mesiacov
    let isOnline = navigator.onLine;
    let syncState = 'idle'; // 'idle', 'syncing', 'pending', 'error'
    let notificationTimeoutId = null;
    let debouncedSaveTimer = null;

    const dayNames = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"]; // Krat≈°ie n√°zvy dn√≠

    // -------------------- POMOCN√â FUNKCIE --------------------

    /** Zobraz√≠/skryje loading overlay */
    function setLoading(isLoading) {
        DOM.loadingOverlay.classList.toggle('show', isLoading);
        // Pr√≠padne deaktivova≈• d√¥le≈æit√© tlaƒçidl√° poƒças naƒç√≠tavania
        // Array.from(DOM.container.querySelectorAll('button')).forEach(btn => btn.disabled = isLoading);
    }

    /** Zobraz√≠ notifik√°ciu */
    function showNotification(element, message, isPersistent = false, timeout = NOTIFICATION_TIMEOUT_MS) {
        if (notificationTimeoutId) clearTimeout(notificationTimeoutId); // Zru≈°√≠ predch. timeout
        element.textContent = message;
        element.classList.add('show');
        if (!isPersistent) {
            notificationTimeoutId = setTimeout(() => {
                element.classList.remove('show');
            }, timeout);
        }
    }
    function showSaveNotification(message = 'D√°ta ulo≈æen√© lok√°lne.') { showNotification(DOM.saveNotification, message); }
    function showErrorNotification(message, isPersistent = false) { showNotification(DOM.errorNotification, message, isPersistent, ERROR_NOTIFICATION_TIMEOUT_MS); }
    function showSyncNotification(message) { showNotification(DOM.syncNotification, message, false, SYNC_NOTIFICATION_TIMEOUT_MS); }

    /** Debounce funkcia */
    function debounce(func, wait) {
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(debouncedSaveTimer);
          func(...args);
        };
        clearTimeout(debouncedSaveTimer);
        debouncedSaveTimer = setTimeout(later, wait);
      };
    }

    /** Form√°tuje ƒç√≠slo na dan√Ω poƒçet des. miest */
    function formatNumber(num) {
        return (typeof num === 'number' && !isNaN(num)) ? num.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
    }

    /** Z√≠ska poƒçet dn√≠ v mesiaci */
    function getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }

    /** Z√≠ska skratku d≈àa v t√Ω≈ædni */
    function getDayAbbreviation(year, month, day) { return dayNames[new Date(year, month, day).getDay()]; }

    /** Z√≠ska n√°zov mesiaca */
    function getMonthName(monthIndex) {
        const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
        return monthNames[monthIndex] ?? "Nezn√°my";
    }

    /** Regul√°rny v√Ωraz pre valid√°ciu ƒçasu HH:MM */
    const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

    /** Generuje unik√°tny kƒæ√∫ƒç pre localStorage a Firestore */
    function getDataKey(year, month) { return `workData-${year}-${month}`; }

    // -------------------- SPR√ÅVA STAVU PRIPOJENIA A SYNCHRONIZ√ÅCIE --------------------

    function updateOnlineStatus() {
        isOnline = navigator.onLine;
        if (isOnline) {
            DOM.connectionStatus.textContent = 'Online';
            DOM.connectionStatus.className = 'online';
            console.log('Stav: Online');
            if (db) enableNetwork(db).catch(console.warn); // Sk√∫si povoli≈• sie≈• pre Firestore
            if (currentUser) trySyncPendingData(); // Sk√∫si synchronizova≈• ƒçakaj√∫ce d√°ta po pripojen√≠
        } else {
            DOM.connectionStatus.textContent = 'Offline';
            DOM.connectionStatus.className = 'offline';
            console.log('Stav: Offline');
            setSyncState('idle'); // Reset sync state pri offline
            if (db) disableNetwork(db).catch(console.warn); // Sk√∫si explicitne vypn√∫≈• sie≈• pre Firestore
            showErrorNotification('Pracujete v offline re≈æime. Zmeny sa ukladaj√∫ lok√°lne.');
        }
    }

    function setSyncState(newState) {
        syncState = newState;
        // Aktualizova≈• UI podƒæa stavu synchroniz√°cie (napr. ikona, text)
        switch (syncState) {
            case 'syncing':
                DOM.connectionStatus.textContent = 'Synchronizujem...';
                DOM.connectionStatus.className = 'syncing';
                break;
            case 'pending':
                DOM.connectionStatus.textContent = 'ƒåak√° na synchroniz√°ciu';
                DOM.connectionStatus.className = 'offline'; // Alebo ≈°peci√°lna farba
                break;
            case 'error':
                 DOM.connectionStatus.textContent = 'Chyba synchroniz√°cie';
                 DOM.connectionStatus.className = 'offline'; // Alebo error farba
                 break;
            case 'idle':
            default:
                // Vr√°ti sa na Online/Offline stav
                 updateOnlineStatus();
                break;
        }
        console.log(`Sync state: ${syncState}`);
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // -------------------- UKLADANIE A NAƒå√çTANIE D√ÅT --------------------

    /** Zozbiera aktu√°lne d√°ta z UI a nastaven√≠ */
    function collectCurrentData() {
         const data = [];
         const daysInCurrentMonth = getDaysInMonth(currentYear, currentMonth);
         for (let i = 1; i <= daysInCurrentMonth; i++) {
            // Pou≈æitie optional chaining a nullish coalescing pre robustnos≈•
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value ?? '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value ?? '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value ?? '';
            // Uklad√°me *vypoƒç√≠tan√©* hodnoty, nie hodnoty z readonly inputov
            const { decimalHours } = calculateWorkHours(start, end, breakTime);
            const gross = calculateGrossSalary(decimalHours);
            const net = calculateNetSalary(gross);

            data.push({ start, end, breakTime, hours: decimalHours, gross, net }); // Uklad√°me aj hodiny pre jednoduch≈°√≠ v√Ωpoƒçet
         }

         return {
            data,
            hourlyWage,
            taxRate,
            employeeName,
            decimalPlaces,
            lastUpdated: serverTimestamp() // Pou≈æijeme serverov√Ω ƒças pri ukladan√≠ do Firestore
            // Alebo new Date().toISOString() pre localStorage
         };
    }

    /** Ulo≈æ√≠ d√°ta do localStorage */
    function saveToLocalStorage(dataObject) {
        const key = getDataKey(currentYear, currentMonth);
        try {
            // Pre localStorage potrebujeme konkr√©tny d√°tum, nie serverTimestamp
            const localData = { ...dataObject, lastUpdated: new Date().toISOString() };
            localStorage.setItem(key, JSON.stringify(localData));
            localStorage.setItem('hourlyWage', hourlyWage); // Ulo≈æ√≠me aj individu√°lne nastavenia
            localStorage.setItem('taxRate', taxRate);
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces);
            console.log(`D√°ta pre ${key} ulo≈æen√© do localStorage.`);
            showSaveNotification(); // Notifik√°cia o lok√°lnom ulo≈æen√≠
        } catch (error) {
            console.error(`Chyba pri ukladan√≠ do localStorage (${key}):`, error);
            showErrorNotification('Chyba pri lok√°lnom ukladan√≠ d√°t!');
            // Rie≈°enie pre pln√© localStorage?
            if (error.name === 'QuotaExceededError') {
                showErrorNotification('Lok√°lne √∫lo≈æisko je pln√©! Sk√∫ste vymaza≈• star√© d√°ta alebo z√°lohy.', true);
            }
        }
    }

    /** Debouncovan√° verzia saveToFirestore */
    const debouncedSaveToFirestore = debounce(async () => {
        if (!currentUser || !isOnline) {
            if (!isOnline) setSyncState('pending'); // Ak sme offline, oznaƒç√≠me ako ƒçakaj√∫ce
            console.log('Preskakujem ukladanie do Firestore (neprihl√°sen√Ω alebo offline).');
            return;
        }

        setSyncState('syncing');
        setLoading(true); // Zobrazi≈• indik√°tor naƒç√≠tania

        const saveData = collectCurrentData();
        const key = getDataKey(currentYear, currentMonth);
        const userRef = doc(db, 'users', currentUser.uid);
        const docRef = doc(userRef, 'workDays', key);

        try {
            await setDoc(docRef, saveData);
            localStorage.removeItem(`pendingSync-${key}`); // Odstr√°ni≈• pr√≠znak ƒçakaj√∫cej synchroniz√°cie
            setSyncState('idle');
            showSyncNotification('D√°ta synchronizovan√© s cloudom.');
            console.log(`D√°ta pre ${key} √∫spe≈°ne ulo≈æen√© do Firestore.`);
        } catch (error) {
            console.error(`Chyba pri ukladan√≠ do Firestore (${key}):`, error);
            showErrorNotification('Chyba pri synchroniz√°cii d√°t s cloudom.');
            localStorage.setItem(`pendingSync-${key}`, JSON.stringify(saveData)); // Oznaƒçi≈• ako ƒçakaj√∫ce na sync
            setSyncState('error');
        } finally {
            setLoading(false); // Skry≈• indik√°tor naƒç√≠tania
        }
    }, SAVE_DEBOUNCE_MS);


    /** Sp√∫≈°≈•aƒç ukladania (lok√°lne hneƒè, do cloudu debouncovane) */
    function triggerSave() {
        const currentData = collectCurrentData();
        saveToLocalStorage(currentData); // V≈ædy ulo≈æ√≠me lok√°lne okam≈æite
        debouncedSaveToFirestore();     // Pok√∫sime sa ulo≈æi≈• do cloudu (debouncovane)
    }

    /** Pok√∫si sa synchronizova≈• d√°ta oznaƒçen√© ako ƒçakaj√∫ce */
    async function trySyncPendingData() {
        if (!currentUser || !isOnline) return;

        const prefix = `pendingSync-workData-`;
        let syncedCount = 0;
        setLoading(true);
        setSyncState('syncing');

        try {
            const batch = writeBatch(db); // Pou≈æijeme batch z√°pis pre efektivitu
            const keysToRemove = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(prefix)) {
                    const dataString = localStorage.getItem(key);
                    if (dataString) {
                        try {
                            const dataToSync = JSON.parse(dataString);
                            // Spr√°vny dokument ID bez prefixu
                            const docId = key.substring(prefix.length);
                            const userRef = doc(db, 'users', currentUser.uid);
                            const docRef = doc(userRef, 'workDays', docId);
                            // Prid√°me do batch oper√°cie namiesto individu√°lneho setDoc
                            batch.set(docRef, { ...dataToSync, lastUpdated: serverTimestamp() }); // Aktualizujeme ƒças pri synchroniz√°cii
                            keysToRemove.push(key);
                            syncedCount++;
                            console.log(`Pripraven√© na synchroniz√°ciu: ${docId}`);
                        } catch (parseError) {
                            console.error(`Chyba pri parsovan√≠ ƒçakaj√∫cich d√°t pre kƒæ√∫ƒç ${key}:`, parseError);
                            localStorage.removeItem(key); // Odstr√°ni≈• po≈°koden√© d√°ta
                        }
                    }
                }
            }

            if (syncedCount > 0) {
                await batch.commit(); // Odo≈°leme v≈°etky zmeny naraz
                keysToRemove.forEach(key => localStorage.removeItem(key)); // Odstr√°nime kƒæ√∫ƒçe a≈æ po √∫spe≈°nom z√°pise
                console.log(`${syncedCount} z√°znamov √∫spe≈°ne synchronizovan√Ωch.`);
                showSyncNotification(`${syncedCount} offline z√°znamov synchronizovan√Ωch.`);
                setSyncState('idle');
                // Po √∫spe≈°nej synchroniz√°cii mo≈æno naƒç√≠ta≈• aktu√°lne d√°ta, ak sa zmenil mesiac medzit√Ωm
                // loadInitialData();
            } else {
                 console.log('≈Ωiadne ƒçakaj√∫ce d√°ta na synchroniz√°ciu.');
                 setSyncState('idle');
            }

        } catch (error) {
            console.error('Chyba pri synchroniz√°cii ƒçakaj√∫cich d√°t:', error);
            showErrorNotification('Nepodarilo sa synchronizova≈• offline zmeny.');
            setSyncState('error');
        } finally {
            setLoading(false);
        }
    }

    /** Naƒç√≠ta d√°ta pre aktu√°lny mesiac (priorita: cache -> localStorage -> Firestore) */
    async function loadInitialData() {
        const key = getDataKey(currentYear, currentMonth);
        console.log(`Naƒç√≠tavam d√°ta pre ${key}...`);
        setLoading(true);

        // 1. Skontrolova≈• cache
        if (monthDataCache[key]) {
            console.log("N√°jden√© v cache.");
            applyDataToUI(monthDataCache[key]);
            setLoading(false);
            trySyncPendingData(); // Skontrolova≈•, ƒçi nie s√∫ ƒçakaj√∫ce d√°ta pre tento mesiac
            return;
        }

        // 2. Skontrolova≈• localStorage
        const localDataString = localStorage.getItem(key);
        if (localDataString) {
            console.log("N√°jden√© v localStorage.");
            try {
                const localData = JSON.parse(localDataString);
                monthDataCache[key] = localData; // Ulo≈æi≈• do cache
                applyDataToUI(localData);
                // Ak sme online, skontrolujeme, ƒçi m√°me ƒçakaj√∫ce d√°ta alebo ƒçi sa cloud nel√≠≈°i
                if (isOnline && currentUser) {
                   const pendingKey = `pendingSync-${key}`;
                   if (localStorage.getItem(pendingKey)) {
                       console.log("Existuj√∫ ƒçakaj√∫ce d√°ta pre tento mesiac, neprepisujem z cloudu.");
                       setSyncState('pending');
                       showSyncNotification("M√°te neodoslan√© offline zmeny pre tento mesiac.");
                   } else {
                       // Voliteƒæne: Skontrolova≈•, ƒçi sa cloudov√© d√°ta nel√≠≈°ia (napr. podƒæa lastUpdated)
                       // checkForCloudUpdates(key, localData.lastUpdated);
                       trySyncPendingData(); // V≈°eobecn√° kontrola sync
                   }
                }
            } catch (error) {
                console.error(`Chyba pri parsovan√≠ d√°t z localStorage (${key}):`, error);
                localStorage.removeItem(key); // Odstr√°ni≈• po≈°koden√© d√°ta
                showErrorNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t. Sk√∫ste naƒç√≠ta≈• z cloudu.");
                createEmptyTable(); // Zobrazi≈• pr√°zdnu tabuƒæku
            } finally {
                setLoading(false);
            }
            return;
        }

        // 3. Skontrolova≈• Firestore (iba ak sme online a prihl√°sen√≠)
        if (isOnline && currentUser) {
            console.log("Hƒæad√°m v Firestore...");
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', key);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("N√°jden√© v Firestore.");
                    const cloudData = docSnap.data();
                     // Firestore vracia Timestamp, pre localStorage/cache je lep≈°ie ISO string
                    const dataToApply = {
                        ...cloudData,
                        lastUpdated: cloudData.lastUpdated?.toDate()?.toISOString() || new Date().toISOString()
                    };
                    monthDataCache[key] = dataToApply; // Ulo≈æi≈• do cache
                    localStorage.setItem(key, JSON.stringify(dataToApply)); // Ulo≈æi≈• aj do localStorage
                    applyDataToUI(dataToApply);
                } else {
                    console.log(`≈Ωiadne d√°ta v Firestore pre ${key}. Vytv√°ram pr√°zdnu tabuƒæku.`);
                    createEmptyTable(); // Ak nen√°jdeme nikde, vytvor√≠me pr√°zdnu
                }
            } catch (error) {
                console.error(`Chyba pri naƒç√≠tavan√≠ z Firestore (${key}):`, error);
                showErrorNotification('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu.');
                createEmptyTable(); // Zobrazi≈• pr√°zdnu tabuƒæku pri chybe
            } finally {
                 setLoading(false);
            }
        } else {
            // Offline a ≈æiadne lok√°lne d√°ta
            console.log("Offline a ≈æiadne lok√°lne d√°ta. Vytv√°ram pr√°zdnu tabuƒæku.");
            createEmptyTable();
            setLoading(false);
        }
    }

    /** Explicitn√© naƒç√≠tanie z Firestore (tlaƒçidlom) - prep√≠≈°e lok√°lne d√°ta! */
    window.loadFromFirestore = async function() {
        if (!currentUser) return showErrorNotification('Pre naƒç√≠tanie z cloudu sa mus√≠te prihl√°si≈•.');
        if (!isOnline) return showErrorNotification('Ste offline. Pripojte sa na internet pre naƒç√≠tanie z cloudu.');

        const key = getDataKey(currentYear, currentMonth);
        if (!confirm(`Naozaj chcete naƒç√≠ta≈• d√°ta z cloudu pre ${getMonthName(currentMonth)} ${currentYear}? Prep√≠≈°u sa t√Ωm v≈°etky aktu√°lne lok√°lne zmeny pre tento mesiac.`)) {
            return;
        }

        console.log(`Manu√°lne vy≈æiadan√© naƒç√≠tanie z Firestore pre ${key}...`);
        setLoading(true);
        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', key);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                const dataToApply = {
                    ...cloudData,
                    lastUpdated: cloudData.lastUpdated?.toDate()?.toISOString() || new Date().toISOString()
                };

                // Prep√≠sa≈• cache a localStorage
                monthDataCache[key] = dataToApply;
                localStorage.setItem(key, JSON.stringify(dataToApply));
                localStorage.removeItem(`pendingSync-${key}`); // Zmaza≈• pr√≠znak ƒçakaj√∫cej synchroniz√°cie

                applyDataToUI(dataToApply); // Aplikova≈• do UI
                showSaveNotification('D√°ta √∫spe≈°ne naƒç√≠tan√© z cloudu.');
                setSyncState('idle'); // Reset sync state
            } else {
                showErrorNotification(`Pre ${getMonthName(currentMonth)} ${currentYear} neboli v cloude n√°jden√© ≈æiadne d√°ta.`);
                // Mo≈æno by sme mali vymaza≈• aj lok√°lne d√°ta? Z√°le≈æ√≠ na po≈æiadavke.
                // createEmptyTable();
                // delete monthDataCache[key];
                // localStorage.removeItem(key);
                // triggerSave();
            }
        } catch (error) {
            console.error(`Chyba pri manu√°lnom naƒç√≠tavan√≠ z Firestore (${key}):`, error);
            showErrorNotification('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu.');
        } finally {
            setLoading(false);
        }
    }


    /** Aplikuje naƒç√≠tan√© d√°ta (z cache, LS alebo FS) do UI */
    function applyDataToUI(storedData) {
        console.log('Aplikujem d√°ta do UI:', storedData);

        // 1. Aktualizova≈• glob√°lne nastavenia a inputy
        hourlyWage = storedData.hourlyWage ?? 10;
        taxRate = storedData.taxRate ?? 0.02;
        employeeName = storedData.employeeName ?? '';
        decimalPlaces = storedData.decimalPlaces ?? DEFAULT_DECIMAL_PLACES;

        DOM.hourlyWageInput.value = hourlyWage;
        DOM.taxRateInput.value = (taxRate * 100).toFixed(1); // Zobrazi≈• ako percento
        DOM.employeeNameInput.value = employeeName;
        DOM.decimalPlacesSelect.value = decimalPlaces;

        // 2. Vytvori≈• ≈°trukt√∫ru tabuƒæky (ak e≈°te neexistuje alebo pre istotu)
        createTableStructure();

        // 3. Naplni≈• tabuƒæku d√°tami
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        if (storedData.data && storedData.data.length >= daysInMonth) {
             storedData.data.slice(0, daysInMonth).forEach((dayData, index) => {
                const day = index + 1;
                const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
                const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
                const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

                if (startEl && endEl && breakEl) {
                    startEl.value = dayData.start || '';
                    endEl.value = dayData.end || '';
                    breakEl.value = dayData.breakTime || '';
                    // Prepoƒç√≠tame riadok, aby sa aktualizovali aj vypoƒç√≠tan√© hodnoty (ƒças, mzdy)
                    calculateRow(day);
                } else {
                    // console.warn(`Elementy pre de≈à ${day} neboli n√°jden√© pri aplikovan√≠ d√°t.`);
                }
             });
        } else {
             console.warn(`Nedostatok d√°t v poli 'data' pre mesiac ${currentMonth + 1}/${currentYear}. Oƒçak√°van√Ωch: ${daysInMonth}, N√°jden√Ωch: ${storedData.data?.length ?? 0}`);
             // V tomto pr√≠pade by tabuƒæka zostala vyplnen√° len ƒçiastoƒçne alebo v√¥bec
        }

        // 4. Prepoƒç√≠ta≈• celkov√© s√∫ƒçty
        calculateTotal();

        console.log('D√°ta √∫spe≈°ne aplikovan√© do UI.');
    }


    // -------------------- TVORBA TABUƒΩKY A V√ùPOƒåTY --------------------

    /** Vytvor√≠ len ≈°trukt√∫ru tabuƒæky (riadky a inputy) */
    function createTableStructure() {
      console.log('Vytv√°ram ≈°trukt√∫ru tabuƒæky pre:', `${getMonthName(currentMonth)} ${currentYear}`);
      DOM.workDaysTableBody.innerHTML = ''; // Vyƒçist√≠me predch√°dzaj√∫ci obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);

      const fragment = document.createDocumentFragment(); // Optimaliz√°cia - prid√°vame do fragmentu

      for (let i = 1; i <= daysInSelectedMonth; i++) {
        const row = document.createElement('tr');
        const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
        if (isCurrentDay) {
          row.classList.add('current-day');
          row.setAttribute('aria-current', 'date'); // Pr√≠stupnos≈•
        }

        const dayAbbr = getDayAbbreviation(currentYear, currentMonth, i);
        const idBase = `${currentYear}-${currentMonth}-${i}`;

        // Optimalizovan√© vytvorenie buniek
        row.innerHTML = `
          <td>De≈à ${i} (${dayAbbr})</td>
          <td><input type="tel" id="start-${idBase}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'end-${idBase}')" aria-label="Pr√≠chod de≈à ${i}"></td>
          <td><input type="tel" id="end-${idBase}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'break-${idBase}')" aria-label="Odchod de≈à ${i}"></td>
          <td><input type="number" id="break-${idBase}" min="0" step="0.1" placeholder="hod." oninput="handleBreakInput(${i})" aria-label="Prest√°vka v hodin√°ch de≈à ${i}"></td>
          <td id="total-${idBase}" aria-label="Odpracovan√Ω ƒças de≈à ${i}">0h 0m (0.0 h)</td>
          <td><input type="number" id="gross-${idBase}" readonly tabindex="-1" aria-label="Hrub√° mzda de≈à ${i}"></td>
          <td><input type="number" id="net-${idBase}" readonly tabindex="-1" aria-label="ƒåist√° mzda de≈à ${i}"></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})" aria-label="Vynulova≈• z√°znam pre de≈à ${i}">Vynulova≈•</button></td>
        `;
        fragment.appendChild(row);
      }
      DOM.workDaysTableBody.appendChild(fragment); // Prid√°me cel√Ω fragment naraz
      console.log('≈†trukt√∫ra tabuƒæky vytvoren√°.');
    }

    /** Vytvor√≠ pr√°zdnu tabuƒæku a vynuluje s√∫ƒçty */
    function createEmptyTable() {
        createTableStructure();
        calculateTotal(); // Vynuluje s√∫ƒçty
    }


    /** Spracuje vstup ƒçasu a posunie focus */
    window.handleTimeInput = function(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, ''); // Povol√≠ len ƒç√≠sla a :

        // Automatick√© doplnenie ':'
        if (value.length === 2 && !value.includes(':')) {
            const hours = parseInt(value);
            if (hours >= 0 && hours < 24) { // Len ak s√∫ prv√© dve ƒç√≠sla platn√© hodiny
                 value += ':';
            }
        } else if (value.length === 3 && value.charAt(1) === ':') { // Pr√≠pad 1:30 -> 01:30
             value = '0' + value;
        } else if (value.length === 4 && value.charAt(2) !== ':') { // Pr√≠pad 1230 -> 12:30
             value = value.slice(0, 2) + ':' + value.slice(2);
        }

        // Obmedzenie dƒ∫≈æky a valid√°cia form√°tu HH:MM
        if (value.length > 5) value = value.slice(0, 5);
        input.value = value;

        // Valid√°cia a prepoƒçet
        if (timeRegex.test(value)) {
            input.setCustomValidity(''); // Platn√Ω form√°t
            const day = parseInt(input.id.split('-')[3]);
            calculateRow(day);
            triggerSave(); // Ulo≈æi≈• zmenu
            moveFocus(nextId);
        } else if (value.length > 0) {
            input.setCustomValidity('Neplatn√Ω form√°t ƒçasu (HH:MM)'); // Nastav√≠ neplatn√Ω stav pre CSS/JS
        } else {
             input.setCustomValidity(''); // Pr√°zdne pole je OK
             const day = parseInt(input.id.split('-')[3]);
             calculateRow(day); // Prepoƒç√≠ta≈•, ak sa ƒças vyma≈æe
             triggerSave(); // Ulo≈æi≈• zmenu
        }
        // input.reportValidity(); // Zobraz√≠ chybov√∫ hl√°≈°ku prehliadaƒça (voliteƒæn√©)
    }

    /** Spracuje vstup prest√°vky */
    window.handleBreakInput = function(day) {
        const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if (!input) return;

        // Povoli≈• len ƒç√≠sla a jednu desatinn√∫ bodku/ƒçiarku, nahradi≈• ƒçiarku bodkou
        let value = input.value.replace(',', '.').replace(/[^\d.]/g, '');
        // Zabr√°ni≈• viacer√Ωm bodk√°m
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        // Obmedzi≈• na napr. 1 desatinn√© miesto (hodnotu v hodin√°ch)
        if (parts[1] && parts[1].length > 1) {
            value = parseFloat(value).toFixed(1);
        }

        input.value = value; // Aktualizova≈• hodnotu v poli

        // Valid√°cia (mus√≠ by≈• ƒç√≠slo a nez√°porn√©)
        const breakHours = parseFloat(value);
        if (value === '' || (!isNaN(breakHours) && breakHours >= 0)) {
            input.setCustomValidity('');
            calculateRow(day); // Prepoƒç√≠ta riadok
            triggerSave();     // Ulo≈æ√≠ zmenu
             // Presun fokusu po zadan√≠ platnej hodnoty (voliteƒæn√©)
            // if (value !== '' && !isNaN(breakHours)) {
            //     const nextDay = day + 1;
            //     if (nextDay <= getDaysInMonth(currentYear, currentMonth)) {
            //         moveFocus(`start-${currentYear}-${currentMonth}-${nextDay}`);
            //     }
            // }
        } else {
            input.setCustomValidity('Prest√°vka mus√≠ by≈• nez√°porn√© ƒç√≠slo.');
        }
        // input.reportValidity();
    }

    /** Presunie focus na ƒèal≈°√≠ element */
    function moveFocus(elementId) {
        const nextElement = document.getElementById(elementId);
        if (nextElement) {
            nextElement.focus();
            // Voliteƒæne: Oznaƒçi≈• text v ƒèal≈°om poli
            if (nextElement.select) {
                 // Timeout, aby sa focus stihol presun√∫≈• pred selectom
                setTimeout(() => nextElement.select(), 0);
            }
        }
    }

    /** Vypoƒç√≠ta odpracovan√© hodiny pre dan√Ω riadok */
    function calculateWorkHours(startTime, endTime, breakTimeStr) {
        if (!timeRegex.test(startTime) || !timeRegex.test(endTime)) {
            return { totalMinutes: 0, decimalHours: 0, formatted: `0h 0m (0.0 h)` };
        }

        const breakHours = parseFloat(String(breakTimeStr).replace(',', '.')) || 0;
        const breakMinutes = Math.max(0, breakHours) * 60;

        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);

        // Pou≈æitie Date objektov pre jednoduch≈°√≠ prechod cez polnoc
        const startDate = new Date(2000, 0, 1, startHours, startMinutes);
        let endDate = new Date(2000, 0, 1, endHours, endMinutes);

        // Ak je koncov√Ω ƒças men≈°√≠ ako zaƒçiatoƒçn√Ω, predpoklad√°me pr√°cu cez polnoc
        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1); // Posun√∫≈• endDate o de≈à
        }

        const diffMillis = endDate.getTime() - startDate.getTime();
        let diffMinutes = diffMillis / (1000 * 60); // Rozdiel v min√∫tach

        // Odpoƒç√≠ta≈• prest√°vku
        diffMinutes -= breakMinutes;
        diffMinutes = Math.max(0, diffMinutes); // Nem√¥≈æe by≈• z√°porn√©

        const totalMinutesRounded = Math.round(diffMinutes); // Zaokr√∫hlenie na cel√© min√∫ty
        const hoursPart = Math.floor(totalMinutesRounded / 60);
        const minutesPart = totalMinutesRounded % 60;
        const decimalHours = diffMinutes / 60; // Desatinn√© hodiny (presnej≈°ie pre v√Ωplatu)

        return {
            totalMinutes: totalMinutesRounded, // Zaokr√∫hlen√© min√∫ty pre zobrazenie
            decimalHours: decimalHours,         // Desatinn√© hodiny pre v√Ωpoƒçet mzdy
            formatted: `${hoursPart}h ${minutesPart}m (${formatNumber(decimalHours)} h)`
        };
    }

     /** Vypoƒç√≠ta hrub√∫ mzdu */
    function calculateGrossSalary(decimalHours) {
        return Math.max(0, decimalHours * hourlyWage);
    }

    /** Vypoƒç√≠ta ƒçist√∫ mzdu */
    function calculateNetSalary(grossSalary) {
        return Math.max(0, grossSalary * (1 - taxRate));
    }


    /** Prepoƒç√≠ta cel√Ω riadok (ƒças, mzdy) */
    function calculateRow(day) {
        const idBase = `${currentYear}-${currentMonth}-${day}`;
        const startTime = document.getElementById(`start-${idBase}`)?.value ?? '';
        const endTime = document.getElementById(`end-${idBase}`)?.value ?? '';
        const breakTimeStr = document.getElementById(`break-${idBase}`)?.value ?? '';
        const totalCell = document.getElementById(`total-${idBase}`);
        const grossInput = document.getElementById(`gross-${idBase}`);
        const netInput = document.getElementById(`net-${idBase}`);

        if (!totalCell || !grossInput || !netInput) {
            // console.warn(`Ch√Ωbaj√∫ce elementy pre v√Ωpoƒçet d≈àa ${day}`);
            return; // Ak elementy neexistuj√∫, nerob√≠me niƒç
        }

        const { decimalHours, formatted } = calculateWorkHours(startTime, endTime, breakTimeStr);
        const grossSalary = calculateGrossSalary(decimalHours);
        const netSalary = calculateNetSalary(grossSalary);

        totalCell.textContent = formatted;
        grossInput.value = formatNumber(grossSalary);
        netInput.value = formatNumber(netSalary);

        // calculateTotal() sa vol√° externe po potrebn√Ωch calculateRow() alebo pri triggerSave()
    }

    /** Vynuluje jeden riadok */
    window.resetRow = function(day) {
        const idBase = `${currentYear}-${currentMonth}-${day}`;
        const startInput = document.getElementById(`start-${idBase}`);
        const endInput = document.getElementById(`end-${idBase}`);
        const breakInput = document.getElementById(`break-${idBase}`);

        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (breakInput) breakInput.value = '';

        // Reset validity a prepoƒçet
        [startInput, endInput, breakInput].forEach(input => input?.setCustomValidity(''));
        calculateRow(day); // Prepoƒç√≠ta na nulu
        triggerSave();     // Ulo≈æ√≠ zmeny
        startInput?.focus(); // Vr√°ti focus na zaƒçiatok riadku
    }

    /** Vypoƒç√≠ta a zobraz√≠ celkov√© s√∫ƒçty */
    function calculateTotal() {
        let totalMinutesSum = 0;
        let totalGrossSum = 0;
        let totalNetSum = 0;
        let daysWithValidEntries = 0; // Poƒç√≠tame len dni s platn√Ωm ƒçasom alebo prest√°vkou
        const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);

        for (let i = 1; i <= daysInSelectedMonth; i++) {
            const idBase = `${currentYear}-${currentMonth}-${i}`;
            const start = document.getElementById(`start-${idBase}`)?.value ?? '';
            const end = document.getElementById(`end-${idBase}`)?.value ?? '';
            const breakTimeStr = document.getElementById(`break-${idBase}`)?.value ?? '';

            const { totalMinutes, decimalHours } = calculateWorkHours(start, end, breakTimeStr);
            const gross = calculateGrossSalary(decimalHours);
            const net = calculateNetSalary(gross);

            totalMinutesSum += totalMinutes; // Sƒç√≠tavame zaokr√∫hlen√© min√∫ty pre zobrazenie celk. ƒçasu
            totalGrossSum += gross;
            totalNetSum += net;

            // Zapoƒç√≠ta≈• de≈à, ak m√° platn√Ω ƒçasov√Ω √∫daj ALEBO zadan√∫ prest√°vku
             if (decimalHours > 0 || (parseFloat(breakTimeStr.replace(',', '.')) || 0) > 0) {
                 daysWithValidEntries++;
             }
        }

        const totalHoursPart = Math.floor(totalMinutesSum / 60);
        const totalMinutesPart = totalMinutesSum % 60;
        const totalDecimalHours = totalMinutesSum / 60; // Celkov√© desatinn√© hodiny

        const avgNetSalary = daysWithValidEntries > 0 ? totalNetSum / daysWithValidEntries : 0;
        const avgMinutes = daysWithValidEntries > 0 ? totalMinutesSum / daysWithValidEntries : 0;
        const avgHoursPart = Math.floor(avgMinutes / 60);
        const avgMinutesPart = Math.round(avgMinutes % 60); // Priemer zaokr√∫hlime
        const avgDecimalHours = avgMinutes / 60;


        DOM.totalSalaryDiv.innerHTML = `
            Poƒçet zapoƒç√≠tan√Ωch dn√≠: <strong>${daysWithValidEntries}</strong><br>
            Celkov√Ω odpracovan√Ω ƒças: <strong>${totalHoursPart}h ${totalMinutesPart}m</strong> (${formatNumber(totalDecimalHours)} h)<br>
            Celkov√° hrub√° mzda: <strong>${formatNumber(totalGrossSum)} ‚Ç¨</strong><br>
            Celkov√° ƒçist√° mzda: <strong>${formatNumber(totalNetSum)} ‚Ç¨</strong><br>
            Priemern√° ƒçist√° mzda / de≈à: <strong>${formatNumber(avgNetSalary)} ‚Ç¨</strong><br>
            Priemern√Ω odpracovan√Ω ƒças / de≈à: <strong>${avgHoursPart}h ${avgMinutesPart}m</strong> (${formatNumber(avgDecimalHours)} h)
        `;
    }

    // -------------------- OBSLUHA UDALOST√ç UI --------------------

    /** Aktualizuje nastavenia (mzda, da≈à) a prepoƒç√≠ta v≈°etko */
    window.updateSettings = function() {
        const newHourlyWage = parseFloat(DOM.hourlyWageInput.value) || 0;
        const newTaxRatePercent = parseFloat(DOM.taxRateInput.value) || 0;
        const newTaxRate = Math.max(0, Math.min(100, newTaxRatePercent)) / 100; // Valid√°cia 0-100

        // Aktualizova≈• len ak sa hodnota zmenila, aby sa zbytoƒçne neprepoƒç√≠tavalo
        let changed = false;
        if (newHourlyWage !== hourlyWage) {
            hourlyWage = newHourlyWage;
            changed = true;
        }
        if (newTaxRate !== taxRate) {
            taxRate = newTaxRate;
            // Korekcia zobrazenia v inpute, ak zadal napr. viac ako 100
            DOM.taxRateInput.value = (newTaxRate * 100).toFixed(1);
            changed = true;
        }

        if (changed) {
            console.log('Aktualizovan√© nastavenia: Mzda=', hourlyWage, 'Da≈à=', taxRate);
            // Prepoƒç√≠ta≈• v≈°etky riadky a s√∫ƒçty
            const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInSelectedMonth; i++) calculateRow(i);
            calculateTotal();
            triggerSave(); // Ulo≈æi≈• zmeny (vr√°tane nov√Ωch nastaven√≠)
        }
    }

    /** Aktualizuje meno pracovn√≠ka */
    window.updateEmployeeName = function() {
        const newName = DOM.employeeNameInput.value.trim();
        if (newName !== employeeName) {
            employeeName = newName;
            console.log('Meno pracovn√≠ka aktualizovan√©:', employeeName);
            // Meno neovplyv≈àuje v√Ωpoƒçty, staƒç√≠ ulo≈æi≈•
            triggerSave();
        }
    }

    /** Zmena desatinn√Ωch miest */
    window.changeDecimalPlaces = function() {
        const newPlaces = parseInt(DOM.decimalPlacesSelect.value);
        if (newPlaces !== decimalPlaces) {
            decimalPlaces = newPlaces;
            console.log('Poƒçet desatinn√Ωch miest zmenen√Ω na:', decimalPlaces);
            // Prepoƒç√≠ta≈• zobrazenie v tabuƒæke a s√∫ƒçty
             const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInSelectedMonth; i++) calculateRow(i);
            calculateTotal();
            triggerSave(); // Ulo≈æi≈• zmenu nastavenia
        }
    }

    /** Zmena mesiaca */
    window.changeMonth = function() {
        const newMonth = parseInt(DOM.monthSelect.value);
        if (newMonth !== currentMonth) {
            currentMonth = newMonth;
            console.log(`Zmena mesiaca na: ${getMonthName(currentMonth)} (${currentMonth})`);
            // Vyƒçisti≈• cache pre istotu? Alebo necha≈•.
            // monthDataCache = {};
            loadInitialData(); // Naƒç√≠ta≈• d√°ta pre nov√Ω mesiac
             updatePageTitle();
        }
    }

    /** Zmena roku */
    window.changeYear = function() {
        const newYear = parseInt(DOM.yearSelect.value);
        if (newYear !== currentYear) {
            currentYear = newYear;
            console.log(`Zmena roku na: ${currentYear}`);
            // Vyƒçisti≈• cache pre istotu? Alebo necha≈•.
            // monthDataCache = {};
            loadInitialData(); // Naƒç√≠ta≈• d√°ta pre nov√Ω rok
            updatePageTitle();
        }
    }

    /** Prep√≠nanie tmav√©ho re≈æimu */
    window.toggleDarkMode = function() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDarkMode);
        console.log('Tmav√Ω re≈æim:', isDarkMode ? 'Zapnut√Ω' : 'Vypnut√Ω');
    }

     /** Aktualizuje titulok str√°nky */
     function updatePageTitle() {
         document.title = `Bruno's Calc - ${getMonthName(currentMonth)} ${currentYear}${employeeName ? ` | ${employeeName}` : ''}`;
         DOM.subTitle.textContent = `Evidencia za ${getMonthName(currentMonth)} ${currentYear}`;
     }

     /** Napln√≠ select pre roky */
    function populateYearSelect() {
        const startYear = 2020;
        const endYear = new Date().getFullYear() + 2; // P√°r rokov do bud√∫cnosti
        const fragment = document.createDocumentFragment();
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            fragment.appendChild(option);
        }
        DOM.yearSelect.appendChild(fragment);
    }

    // -------------------- AUTENTIFIK√ÅCIA Firebase --------------------

    window.login = async function() {
        if (!isOnline) return showErrorNotification('Ste offline. Prihl√°senie vy≈æaduje internetov√© pripojenie.');
        if (!db || !auth) return showErrorNotification('Chyba pripojenia k Firebase.');

        const email = DOM.loginForm.querySelector('#email').value;
        const password = DOM.loginForm.querySelector('#password').value;
        if (!email || !password) return showErrorNotification('Pros√≠m, zadajte email aj heslo.');

        setLoading(true);
        DOM.loginButton.disabled = true;
        DOM.registerButton.disabled = true;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            currentUser = userCredential.user;
            console.log('Prihl√°sen√Ω:', currentUser.email);
            updateAuthUI(); // Zobraz√≠ info, skryje formul√°r
            // Po prihl√°sen√≠ automaticky sk√∫sime naƒç√≠ta≈•/synchronizova≈• d√°ta
            loadInitialData();
        } catch (error) {
            console.error('Chyba pri prihl√°sen√≠:', error);
            showErrorNotification(`Chyba pri prihl√°sen√≠: ${mapFirebaseAuthError(error.code)}`);
            currentUser = null; // Reset u≈æ√≠vateƒæa pri chybe
            updateAuthUI();
        } finally {
             setLoading(false);
             DOM.loginButton.disabled = false;
             DOM.registerButton.disabled = false;
        }
    }

    window.register = async function() {
        if (!isOnline) return showErrorNotification('Ste offline. Registr√°cia vy≈æaduje internetov√© pripojenie.');
         if (!db || !auth) return showErrorNotification('Chyba pripojenia k Firebase.');

        const email = DOM.loginForm.querySelector('#email').value;
        const password = DOM.loginForm.querySelector('#password').value;
         if (!email || password.length < 6) return showErrorNotification('Pros√≠m, zadajte platn√Ω email a heslo (min. 6 znakov).');

        setLoading(true);
         DOM.loginButton.disabled = true;
         DOM.registerButton.disabled = true;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            currentUser = userCredential.user;
            console.log('Zaregistrovan√Ω a prihl√°sen√Ω:', currentUser.email);
            // Po √∫spe≈°nej registr√°cii m√¥≈æeme vytvori≈• z√°kladn√Ω dokument u≈æ√≠vateƒæa
            await createUserProfileIfNeeded(currentUser);
            updateAuthUI();
            // Po registr√°cii nie je ƒço naƒç√≠tava≈•, zobraz√≠me pr√°zdnu tabuƒæku
            createEmptyTable();
            triggerSave(); // Ulo≈æ√≠me pr√°zdny stav pre nov√©ho usera

        } catch (error) {
            console.error('Chyba pri registr√°cii:', error);
            showErrorNotification(`Chyba pri registr√°cii: ${mapFirebaseAuthError(error.code)}`);
            currentUser = null;
            updateAuthUI();
        } finally {
             setLoading(false);
             DOM.loginButton.disabled = false;
             DOM.registerButton.disabled = false;
        }
    }

    window.logout = async function() {
        if (!auth) return;
        setLoading(true);
        DOM.logoutButton.disabled = true;
        try {
            await signOut(auth);
            console.log('U≈æ√≠vateƒæ odhl√°sen√Ω.');
            currentUser = null;
            monthDataCache = {}; // Vymaza≈• cache po odhl√°sen√≠
            updateAuthUI();
            // Po odhl√°sen√≠ naƒç√≠tame d√°ta LEN z localStorage (ak nejak√© s√∫)
            loadInitialData(); // loadInitialData teraz spr√°vne handle-uje offline/neprihl√°sen√Ω stav
        } catch (error) {
            console.error('Chyba pri odhl√°sen√≠:', error);
            showErrorNotification('Chyba pri odhl√°sen√≠.');
            // UI zostane v stave prihl√°senia, ak sa nepodar√≠ odhl√°si≈•?
        } finally {
            setLoading(false);
             // Enable button again? Or rely on UI update? Re-enable in updateAuthUI maybe.
        }
    }

    /** Vytvor√≠ profil u≈æ√≠vateƒæa v DB, ak neexistuje */
    async function createUserProfileIfNeeded(user) {
        if (!user || !db) return;
        const userRef = doc(db, 'users', user.uid);
        try {
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                await setDoc(userRef, {
                    email: user.email,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });
                console.log(`Vytvoren√Ω profil pre ${user.email}`);
                // Vytvorenie podkolekcie 'workDays' nie je nutn√© vopred
            } else {
                 // Aktualizova≈• lastLogin pri existuj√∫com profile
                 await setDoc(userRef, { lastLogin: serverTimestamp() }, { merge: true });
                 console.log(`Aktualizovan√Ω lastLogin pre ${user.email}`);
            }
        } catch (error) {
            console.error(`Chyba pri vytv√°ran√≠/aktualiz√°cii profilu pre ${user.uid}:`, error);
            // Nejde o kritick√∫ chybu pre funkƒçnos≈• appky, len logujeme
        }
    }


    /** Mapuje Firebase Auth error k√≥dy na zrozumiteƒæn√© spr√°vy */
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatn√Ω form√°t emailu.';
            case 'auth/user-disabled': return 'Tento √∫ƒçet bol deaktivovan√Ω.';
            case 'auth/user-not-found': return '√öƒçet s t√Ωmto emailom neexistuje.';
            case 'auth/wrong-password': return 'Nespr√°vne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je u≈æ zaregistrovan√Ω.';
            case 'auth/weak-password': return 'Heslo je pr√≠li≈° slab√© (min. 6 znakov).';
            case 'auth/requires-recent-login': return 'T√°to oper√°cia vy≈æaduje ned√°vne prihl√°senie.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            default: return `Nezn√°ma chyba (${errorCode})`;
        }
    }

    /** Aktualizuje UI pre prihl√°senie/odhl√°senie */
    function updateAuthUI() {
        if (currentUser) {
            DOM.loginForm.style.display = 'none';
            DOM.userInfo.style.display = 'flex'; // Pou≈æ√≠vame flex pre layout
            DOM.userEmailSpan.textContent = currentUser.email;
            DOM.logoutButton.disabled = false;
            // Povol√≠me tlaƒçidlo Naƒç√≠ta≈• z cloudu
            if (DOM.loadFromCloudButton) DOM.loadFromCloudButton.disabled = false;
        } else {
            DOM.loginForm.style.display = 'flex'; // Pou≈æ√≠vame flex
            DOM.userInfo.style.display = 'none';
            DOM.userEmailSpan.textContent = '';
            // Vyƒçisti≈• formul√°r
            DOM.loginForm.querySelector('#email').value = '';
            DOM.loginForm.querySelector('#password').value = '';
            // Zak√°≈æeme tlaƒçidlo Naƒç√≠ta≈• z cloudu
            if (DOM.loadFromCloudButton) DOM.loadFromCloudButton.disabled = true;
        }
    }

    // Listener na zmeny stavu prihl√°senia
    onAuthStateChanged(auth, async (user) => {
        console.log('Stav autentifik√°cie zmenen√Ω. User:', user?.uid ?? 'None');
        setLoading(true);
        if (user) {
            currentUser = user;
            // Aktualizova≈• profil (lastLogin) asynchr√≥nne
            createUserProfileIfNeeded(user).catch(console.error);
        } else {
            currentUser = null;
            monthDataCache = {}; // Vymaza≈• cache pri odhl√°sen√≠
        }
        updateAuthUI();
        await loadInitialData(); // V≈ædy naƒç√≠ta≈• d√°ta po zmene stavu prihl√°senia
        setLoading(false);
        updatePageTitle();
    }, (error) => {
        // Chyba pri sledovan√≠ stavu prihl√°senia
        console.error("Chyba onAuthStateChanged:", error);
        showErrorNotification("Chyba pri komunik√°cii so serverom autentifik√°cie.", true);
        currentUser = null; // Pre istotu
        updateAuthUI();
        loadInitialData(); // Sk√∫si≈• naƒç√≠ta≈• aspo≈à lok√°lne d√°ta
    });


    // -------------------- EXPORT A Z√ÅLOHA --------------------

    /** Z√≠ska d√°ta pre export/z√°lohu (z aktu√°lneho UI stavu) */
    function getExportData() {
        const data = [
            // Hlaviƒçka
            ['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka (h)', 'Odpracovan√© (h:m)', 'Odpr. (dec. h)', 'Hrub√° Mzda (‚Ç¨)', 'ƒåist√° Mzda (‚Ç¨)']
        ];
        const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);
        let totalMinutesSum = 0, totalGrossSum = 0, totalNetSum = 0;

        for (let i = 1; i <= daysInSelectedMonth; i++) {
            const idBase = `${currentYear}-${currentMonth}-${i}`;
            const dayAbbr = getDayAbbreviation(currentYear, currentMonth, i);
            const start = document.getElementById(`start-${idBase}`)?.value ?? '';
            const end = document.getElementById(`end-${idBase}`)?.value ?? '';
            const breakTimeStr = document.getElementById(`break-${idBase}`)?.value ?? '';
            // Op√§tovn√Ω v√Ωpoƒçet pre presnos≈• exportu
            const { totalMinutes, decimalHours, formatted } = calculateWorkHours(start, end, breakTimeStr);
            const gross = calculateGrossSalary(decimalHours);
            const net = calculateNetSalary(gross);

            // Prid√°me riadok len ak je nejak√Ω z√°znam (ƒças alebo prest√°vka)
            if (start || end || (parseFloat(breakTimeStr.replace(',', '.')) || 0) > 0) {
                data.push([
                    `De≈à ${i} (${dayAbbr})`,
                    start,
                    end,
                    breakTimeStr.replace('.', ','), // Export s ƒçiarkou
                    formatted.split('(')[0].trim(), // Len H:M
                    formatNumber(decimalHours).replace('.',','), // Dec. hodiny s ƒçiarkou
                    formatNumber(gross).replace('.',','),
                    formatNumber(net).replace('.',',')
                ]);
            }
            totalMinutesSum += totalMinutes;
            totalGrossSum += gross;
            totalNetSum += net;
        }

        // Prida≈• s√∫ƒçty a nastavenia na koniec
        const totalHoursPart = Math.floor(totalMinutesSum / 60);
        const totalMinutesPart = totalMinutesSum % 60;
        const totalDecimalHours = totalMinutesSum / 60;

        const summary = [
            [], // Pr√°zdny riadok ako oddeƒæovaƒç
            ['', '', '', '', 'S√öHRN:', '', '', ''],
            ['Meno pracovn√≠ka:', employeeName, '', '', 'Celkov√Ω ƒças:', `${totalHoursPart}h ${totalMinutesPart}m`, `(${formatNumber(totalDecimalHours).replace('.',',')} h)`, ''],
            ['Hodinov√° mzda:', `${formatNumber(hourlyWage).replace('.',',')} ‚Ç¨`, '', '', 'Hrub√° mzda celkom:', `${formatNumber(totalGrossSum).replace('.',',')} ‚Ç¨`, '', ''],
            ['Da≈à (%):', `${(taxRate * 100).toFixed(1).replace('.',',')}`, '', '', 'ƒåist√° mzda celkom:', `${formatNumber(totalNetSum).replace('.',',')} ‚Ç¨`, '', '']
        ];

        return { tableData: data.concat(summary), rawTableData: data }; // Vr√°ti≈• aj ƒçist√© d√°ta pre PDF
    }

    /** Export do PDF */
    window.exportToPDF = function() {
        try {
            setLoading(true);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Pridanie fontu podporuj√∫ceho diakritiku (ak treba - Roboto ≈°tandardne m√° obmedzen√∫ podporu)
            // Rie≈°enie: Pou≈æi≈• ≈°tandardn√Ω font alebo vlo≈æi≈• vlastn√Ω .ttf
            // Pr√≠klad s vlastn√Ωm (treba ma≈• s√∫bor fontu):
            // doc.addFileToVFS("Roboto-Regular.ttf", robotoFontBase64); // font mus√≠ by≈• base64 string
            // doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
            doc.setFont('helvetica'); // ≈†tandardn√Ω font, ktor√Ω by mal by≈• OK

            const title = `V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`;
            doc.setFontSize(18);
            doc.text(title, 14, 20);
            if (employeeName) {
                doc.setFontSize(12);
                doc.text(`Pracovn√≠k: ${employeeName}`, 14, 27);
            }

            const { rawTableData } = getExportData(); // Z√≠ska≈• len d√°ta tabuƒæky bez s√∫hrnu
            const bodyData = rawTableData.slice(1).map(row => row.slice(0, 8)); // Odstr√°ni≈• hlaviƒçku a zobra≈• prv√Ωch 8 stƒ∫pcov

            doc.autoTable({
                head: [rawTableData[0].slice(0, 8)], // Hlaviƒçka
                body: bodyData,
                startY: 35,
                styles: { font: 'helvetica', fontSize: 9 }, // Men≈°ie p√≠smo pre PDF
                headStyles: { fillColor: [76, 175, 80], textColor: 255, fontStyle: 'bold' },
                theme: 'grid', // Alebo 'striped'
                didParseCell: function (data) { // Centrovanie ƒç√≠seln√Ωch stƒ∫pcov
                     const colIndex = data.column.index;
                     if (colIndex >= 3 && colIndex <= 7) { // Stƒ∫pce od Prest√°vka po ƒåist√° mzda
                          data.cell.styles.halign = 'right';
                     }
                 }
            });

            // Prida≈• s√∫ƒçty pod tabuƒæku
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            // Z√≠ska≈• text zo s√∫hrnn√©ho divu a vyƒçisti≈• HTML
            const totalText = DOM.totalSalaryDiv.innerText || DOM.totalSalaryDiv.textContent;
            doc.text(totalText, 14, finalY);

            doc.save(`vykaz-${employeeName ? employeeName.replace(/\s+/g, '_') + '-' : ''}${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`);
            showSaveNotification('PDF s√∫bor √∫spe≈°ne vygenerovan√Ω.');

        } catch (error) {
            console.error("Chyba pri generovan√≠ PDF:", error);
            showErrorNotification(`Chyba pri exporte do PDF: ${error.message}`);
        } finally {
            setLoading(false);
        }
    }

    /** Odoslanie PDF cez navigator.share */
    window.sendPDF = async function() {
        if (!navigator.share || !navigator.canShare) {
            return showErrorNotification('Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom alebo zariaden√≠m.');
        }

        try {
            setLoading(true);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('helvetica'); // Alebo in√Ω font

            const title = `V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`;
            doc.setFontSize(18);
            doc.text(title, 14, 20);
             if (employeeName) {
                 doc.setFontSize(12);
                 doc.text(`Pracovn√≠k: ${employeeName}`, 14, 27);
             }

            const { rawTableData } = getExportData();
            const bodyData = rawTableData.slice(1).map(row => row.slice(0, 8));

            doc.autoTable({
                head: [rawTableData[0].slice(0, 8)],
                body: bodyData,
                startY: 35,
                styles: { font: 'helvetica', fontSize: 9 },
                headStyles: { fillColor: [76, 175, 80], textColor: 255, fontStyle: 'bold' },
                theme: 'grid',
                 didParseCell: function (data) {
                      const colIndex = data.column.index;
                      if (colIndex >= 3 && colIndex <= 7) { data.cell.styles.halign = 'right'; }
                  }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            const totalText = DOM.totalSalaryDiv.innerText || DOM.totalSalaryDiv.textContent;
            doc.text(totalText, 14, finalY);

            const pdfBlob = doc.output('blob');
            const filename = `vykaz-${employeeName ? employeeName.replace(/\s+/g, '_') + '-' : ''}${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`;
            const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });

            if (navigator.canShare({ files: [pdfFile] })) {
                await navigator.share({
                    files: [pdfFile],
                    title: title,
                    text: `V√Ωkaz pr√°ce za ${getMonthName(currentMonth)} ${currentYear}${employeeName ? ` pre ${employeeName}` : ''}`
                });
                console.log('PDF √∫spe≈°ne odoslan√© cez Share API.');
            } else {
                showErrorNotification('Zdieƒæanie PDF s√∫borov nie je v tejto chv√≠li mo≈æn√©.');
            }
        } catch (error) {
             // Chyba "AbortError" je be≈æn√°, ak u≈æ√≠vateƒæ zru≈°√≠ zdieƒæanie
            if (error.name !== 'AbortError') {
                console.error('Chyba pri zdieƒæan√≠ PDF:', error);
                showErrorNotification(`Chyba pri zdieƒæan√≠ PDF: ${error.message}`);
            } else {
                console.log("Zdieƒæanie PDF zru≈°en√© u≈æ√≠vateƒæom.");
            }
        } finally {
            setLoading(false);
        }
    }


    /** Vytvorenie z√°lohy do Excelu */
    window.createBackup = function() {
        try {
            setLoading(true);
            const { tableData } = getExportData(); // Z√≠ska≈• d√°ta vr√°tane s√∫hrnu

            // Nahradi≈• pr√≠padn√© HTML entity v mene pracovn√≠ka
            const cleanEmployeeName = employeeName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Vytvorenie worksheet
            const ws = XLSX.utils.aoa_to_sheet(tableData);

            // Prisp√¥sobenie ≈°√≠rky stƒ∫pcov (voliteƒæn√©)
            const columnWidths = [
                { wch: 18 }, // De≈à
                { wch: 10 }, // Pr√≠chod
                { wch: 10 }, // Odchod
                { wch: 12 }, // Prest√°vka
                { wch: 15 }, // Odpracovan√© H:M
                { wch: 15 }, // Odpracovan√© Dec.
                { wch: 18 }, // Hrub√° Mzda
                { wch: 18 }  // ƒåist√° Mzda
            ];
            ws['!cols'] = columnWidths;

            // Vytvorenie workbooku
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)}`);

            // Generovanie a stiahnutie s√∫boru
            const filename = `zaloha-${cleanEmployeeName ? cleanEmployeeName.replace(/\s+/g, '_') + '-' : ''}${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, filename);
            showSaveNotification('Excel z√°loha √∫spe≈°ne vytvoren√°.');

        } catch (error) {
            console.error("Chyba pri vytv√°ran√≠ Excel z√°lohy:", error);
            showErrorNotification(`Chyba pri vytv√°ran√≠ z√°lohy: ${error.message}`);
        } finally {
            setLoading(false);
        }
    };

    /** Spust√≠ v√Ωber s√∫boru pre obnovu */
    window.triggerRestoreBackup = function() {
        DOM.restoreFileInput.click(); // Otvor√≠ dial√≥g na v√Ωber s√∫boru
    }

    /** Spracuje vybran√Ω s√∫bor z√°lohy */
    window.handleRestoreFile = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        setLoading(true);
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0]; // Predpoklad√°me prv√Ω list
                if (!sheetName) throw new Error("Z√°lo≈æn√Ω s√∫bor neobsahuje ≈æiadne listy.");

                const ws = workbook.Sheets[sheetName];
                // Sk√∫sime z√≠ska≈• d√°ta ako pole pol√≠ (lep≈°ie pre kontrolu ≈°trukt√∫ry)
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

                // -- Parsrovanie d√°t zo sheetu --
                let restoredDataArray = [];
                let restoredSettings = {};
                let dataParsingStarted = false;
                let headerRowFound = false;

                // Oƒçak√°van√© hlaviƒçky (flexibilnej≈°ie porovnanie)
                const expectedHeaders = ["de≈à", "pr√≠chod", "odchod", "prest√°vka", "hrub√° mzda", "ƒçist√° mzda"];

                for (const row of rows) {
                    if (!Array.isArray(row)) continue; // Ignorova≈• neplatn√© riadky

                    const firstCellLower = String(row[0]).toLowerCase().trim();

                    // Hƒæadanie hlaviƒçky
                    if (!headerRowFound && expectedHeaders.every(header => row.some(cell => String(cell).toLowerCase().trim().includes(header)))) {
                        headerRowFound = true;
                        dataParsingStarted = true;
                        continue; // Preskoƒçi≈• riadok hlaviƒçky
                    }

                    // Parsovanie d√°tov√Ωch riadkov (ak sme na≈°li hlaviƒçku a riadok vyzer√° ako d√°tov√Ω)
                    if (dataParsingStarted && firstCellLower.startsWith("de≈à")) {
                        // Predpoklad√°me poradie: De≈à, Pr√≠chod, Odchod, Prest√°vka, _, _, Hrub√°, ƒåist√°
                        // Indexy m√¥≈æu by≈• in√©, ale toto je z√°klad z exportu
                        restoredDataArray.push({
                            start: String(row[1] ?? ''), // Pr√≠chod
                            end: String(row[2] ?? ''),   // Odchod
                            breakTime: String(row[3] ?? '').replace(',', '.'), // Prest√°vka (sp√§≈• na bodku)
                            // Mzdy a hodiny sa dopoƒç√≠taj√∫ pri aplik√°cii
                        });
                    }
                    // Parsovanie nastaven√≠ (ak sme skonƒçili s d√°tami alebo nena≈°li hlaviƒçku)
                    else if (row.length >= 2) {
                        const key = firstCellLower.replace(':', '');
                        const value = String(row[1]).trim();

                        if (key.includes("hodinov√° mzda")) restoredSettings.hourlyWage = parseFloat(value.replace('‚Ç¨', '').replace(',', '.')) || undefined;
                        else if (key.includes("da≈à (%)")) restoredSettings.taxRate = (parseFloat(value.replace('%', '').replace(',', '.')) || 0) / 100;
                        else if (key.includes("meno pracovn√≠ka")) restoredSettings.employeeName = value;
                        // Desatinn√© miesta sa nenaƒç√≠tavaj√∫ zo z√°lohy, pou≈æij√∫ sa aktu√°lne
                    }
                }

                if (!headerRowFound && restoredDataArray.length === 0) {
                    throw new Error("Nepodarilo sa n√°js≈• rozpoznateƒæn√© d√°ta doch√°dzky v s√∫bore.");
                }

                // Potvrdenie od u≈æ√≠vateƒæa
                 if (!confirm(`Na≈°li sa d√°ta pre ${restoredDataArray.length} dn√≠. Naozaj chcete obnovi≈• tieto d√°ta a nastavenia? Aktu√°lne d√°ta pre tento mesiac bud√∫ prep√≠san√©.`)) {
                      DOM.restoreFileInput.value = ''; // Reset inputu
                      setLoading(false);
                      return;
                 }


                // Zostavenie objektu pre aplik√°ciu
                const backupData = {
                  data: restoredDataArray,
                  // Pou≈æi≈• obnoven√© nastavenia, ak existuj√∫, inak ponecha≈• aktu√°lne
                  hourlyWage: restoredSettings.hourlyWage ?? hourlyWage,
                  taxRate: restoredSettings.taxRate ?? taxRate,
                  employeeName: restoredSettings.employeeName ?? employeeName,
                  decimalPlaces: decimalPlaces, // Ponecha≈• aktu√°lne
                  lastUpdated: new Date().toISOString() // Oznaƒçi≈• ako pr√°ve obnoven√©
                };

                // Ulo≈æ√≠me obnoven√© d√°ta do localStorage a cache
                const dataKey = getDataKey(currentYear, currentMonth);
                localStorage.setItem(dataKey, JSON.stringify(backupData));
                monthDataCache[dataKey] = backupData;

                // Aplikujeme d√°ta do UI
                applyDataToUI(backupData);
                showSaveNotification('Z√°loha bola √∫spe≈°ne obnoven√°.');

                // Ak je u≈æ√≠vateƒæ prihl√°sen√Ω a online, automaticky ulo≈æ√≠me obnoven√© d√°ta do cloudu
                if (currentUser && isOnline) {
                  console.log("Uklad√°m obnoven√© d√°ta do Firestore...");
                  // Zavol√°me save priamo, nie debouncovan√∫ verziu, aby sa ulo≈æilo hneƒè
                  const saveData = collectCurrentData(); // Znova zozbiera≈•, teraz u≈æ s obnoven√Ωmi d√°tami
                  const userRef = doc(db, 'users', currentUser.uid);
                  const docRef = doc(userRef, 'workDays', dataKey);
                  setDoc(docRef, saveData).then(() => {
                       showSyncNotification("Obnoven√© d√°ta synchronizovan√© s cloudom.");
                       setSyncState('idle');
                       localStorage.removeItem(`pendingSync-${dataKey}`);
                  }).catch(err => {
                       console.error("Chyba pri ukladan√≠ obnoven√Ωch d√°t do Firestore:", err);
                       showErrorNotification("Chyba pri synchroniz√°cii obnoven√Ωch d√°t.");
                       localStorage.setItem(`pendingSync-${dataKey}`, JSON.stringify(saveData));
                       setSyncState('error');
                  });
                }

            } catch (error) {
                console.error('Chyba pri naƒç√≠tavan√≠ z√°lohy:', error);
                showErrorNotification(`Chyba pri spracovan√≠ z√°lohy: ${error.message}`);
            } finally {
                 DOM.restoreFileInput.value = ''; // Reset inputu pre mo≈ænos≈• nahra≈• rovnak√Ω s√∫bor znova
                 setLoading(false);
            }
        };

        reader.onerror = function() {
            showErrorNotification('Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.');
            DOM.restoreFileInput.value = '';
            setLoading(false);
        }

        reader.readAsArrayBuffer(file);
    };


    // -------------------- INICIALIZ√ÅCIA APLIK√ÅCIE --------------------
    function initializeAppUI() {
        console.log("Inicializujem UI...");
        // Naƒç√≠tanie preferencie tmav√©ho re≈æimu
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        // Naplnenie selectov
        populateYearSelect();
        // Nastavenie predvolen√Ωch hodn√¥t selectov a inputov z glob√°lnych premenn√Ωch
        DOM.monthSelect.value = currentMonth;
        DOM.yearSelect.value = currentYear;
        DOM.decimalPlacesSelect.value = decimalPlaces;
        DOM.hourlyWageInput.value = hourlyWage;
        DOM.taxRateInput.value = (taxRate * 100).toFixed(1);
        DOM.employeeNameInput.value = employeeName;

        updatePageTitle();
        updateOnlineStatus(); // Zisti≈• poƒçiatoƒçn√Ω stav pripojenia

        // Prvotn√© naƒç√≠tanie d√°t sa deje v onAuthStateChanged listeneri

        console.log("UI inicializovan√©.");
    }

    // Spustenie inicializ√°cie po naƒç√≠tan√≠ DOMu
    document.addEventListener('DOMContentLoaded', initializeAppUI);

    // Glob√°lne funkcie pr√≠stupn√© z HTML (kv√¥li type="module")
    // U≈æ s√∫ definovan√© vy≈°≈°ie s `window.` prefixom, tak≈æe toto nie je nutn√©,
    // ale m√¥≈æe sl√∫≈æi≈• ako prehƒæad dostupn√Ωch funkci√≠.
    // window.login = login;
    // window.register = register;
    // ... atƒè.

  </script>

  <!-- Registr√°cia Service Workera (pre PWA funkƒçnos≈•) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, ≈æe cesta je spr√°vna
          .then(registration => {
            console.log('Service Worker zaregistrovan√Ω √∫spe≈°ne, rozsah:', registration.scope);
            // Tu m√¥≈æete prida≈• logiku pre aktualiz√°ciu SW, ak je to potrebn√©
          })
          .catch(error => {
            console.error('Registr√°cia Service Workera zlyhala:', error);
          });
      });
       // Listener pre spr√°vy od Service Workera (napr. o dostupnosti aktualiz√°cie)
       navigator.serviceWorker.addEventListener('message', event => {
           console.log("Spr√°va od SW:", event.data);
           if (event.data && event.data.type === 'SKIP_WAITING_COMPLETE') {
                window.location.reload(); // Automaticky obnovi≈• str√°nku po aktiv√°cii nov√©ho SW
           } else if (event.data && event.data.type === 'CACHE_UPDATED') {
               // Informova≈• u≈æ√≠vateƒæa o aktualizovan√Ωch d√°tach na pozad√≠
               // showNotification(document.getElementById('syncNotification'), 'D√°ta na pozad√≠ aktualizovan√©.');
           }
       });
    }
  </script>
</body>
</html>
