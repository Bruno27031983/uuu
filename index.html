<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator Pro</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <meta name="theme-color" content="#7c3aed"/>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* CSS ≈°t√Ωly zost√°vaj√∫ rovnak√© ako vo va≈°om k√≥de */
    :root {
      --primary-bg-color: #f0f2f5;
      --secondary-bg-color: #ffffff;
      --primary-text-color: #1f2937;
      --secondary-text-color: #4b5563;
      --input-bg-color: #fefcbf;
      --input-note-bg-color: #e0f2fe;
      --table-header-bg-color: #f9fafb;
      --table-border-color: #e5e7eb;
      --current-day-bg-color: #7c3aed;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #2563eb;
      --btn-primary-hover-bg: #1d4ed8;
      --btn-secondary-bg: #7c3aed;
      --btn-secondary-hover-bg: #6d28d9;
      --btn-danger-bg: #dc2626;
      --btn-danger-hover-bg: #b91c1c;
      --btn-warning-bg: #f59e0b;
      --btn-warning-hover-bg: #d97706;
      --btn-highlight-bg: #f59e0b;
      --btn-text-color: #ffffff;
      --total-salary-bg: #eff6ff;
      --link-color: #2563eb;
      --link-hover-color: #1d4ed8;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --box-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --base-font-size: 16px;
      --focus-outline-color: var(--btn-primary-bg);
      --transition-speed: 0.2s;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2') format('woff2');
      font-weight: 400 700;
      font-style: normal;
      font-display: swap;
    }

    html { font-size: var(--base-font-size); scroll-behavior: smooth; }
    body {
      font-family: var(--font-family); line-height: 1.6; margin: 0; padding: 12px;
      background-color: var(--primary-bg-color); color: var(--primary-text-color);
      font-size: 0.92rem; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* NOV√â ≈†T√ùLY PRE LOADER A SKRYTIE OBSAHU */
    .content-hidden {
      display: none !important;
    }
    #app-loader {
      display: flex;
      flex-direction: column; /* Aby text bol pod spinnerom */
      justify-content: center;
      align-items: center;
      height: 90vh; /* V√§ƒç≈°ia ƒças≈• obrazovky */
      text-align: center;
    }
    .loader-spinner { /* Upraven√Ω spinner */
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0,0,0,0.1);
        border-left-color: var(--btn-primary-bg);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px; /* Medzera medzi spinnerom a textom */
    }
    #app-loader p {
        font-size: 1.1em;
        color: var(--secondary-text-color);
    }
    /* Koniec nov√Ωch ≈°t√Ωlov pre loader */

    .container {
      max-width: 1500px; margin: 20px auto; background: var(--secondary-bg-color);
      padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); position: relative;
    }
    h1 { text-align: center; font-size: 2rem; color: var(--primary-text-color); margin-bottom: 10px; font-weight: 700; }
    h1#mainTitle {
      background: linear-gradient(45deg, #7c3aed, #db2777, #f59e0b);
      -webkit-background-clip: text; background-clip: text; color: transparent; padding-bottom: 3px;
    }
    h2 {
      text-align: center; color: var(--secondary-text-color); margin-top: -5px;
      font-size: 1rem; font-weight: 500; margin-bottom: 20px;
    }
    /* ... zvy≈°ok va≈°ich existuj√∫cich CSS pravidiel ... (bez zmien) */
    /* ... (dlh√Ω blok CSS, ktor√Ω tu pre prehƒæadnos≈• vynech√°vam, ale vo va≈°om s√∫bore zostane) ... */
     #saveNotification, #errorNotification, #warningNotification {
        display: none; position: fixed; bottom: 25px; right: 25px; padding: 15px 22px;
        border-radius: var(--border-radius); font-size: 0.95rem; box-shadow: var(--box-shadow-lg);
        z-index: 10000; opacity: 0; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        transform: translateY(30px); font-weight: 500;
    }
    #saveNotification.show, #errorNotification.show, #warningNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification { background-color: var(--btn-primary-bg); color: white; }
    #errorNotification { background-color: var(--btn-danger-bg); color: white; }
    #warningNotification { background-color: var(--btn-highlight-bg); color: var(--primary-text-color); }
    @media print {
      body { padding: 0; font-size: 10pt; color: #000; background-color: #fff; font-family: Arial, sans-serif;}
      #app-loader { display: none !important; } /* Skry≈• loader pri tlaƒçi */
      .container { max-width: 100%; margin: 0; padding: 10px; box-shadow: none; border: none;}
      #auth-container, .settings, .btn-container, #localStorageIndicator, #saveNotification, #errorNotification, #warningNotification, .time-btn, .reset-btn { display: none !important; }
      h1 { font-size: 18pt; margin-bottom: 5mm; background: none !important; -webkit-background-clip: unset !important; background-clip: unset !important; color: black !important;}
      h2 { font-size: 12pt; margin-bottom: 8mm; }
      .table-container { overflow: visible; border: 1px solid #ccc; }
      table { width: 100%; page-break-inside: auto; border-collapse: collapse;}
      tr { page-break-inside: avoid; page-break-after: auto; }
      thead { display: table-header-group; }
      th, td { border: 1px solid #ccc !important; padding: 4px 6px; font-size: 9pt; background-color: #fff !important; color: #000 !important; }
      th { font-weight: bold; background-color: #f0f0f0 !important; }
      td input[type="number"][readonly], td input[type="tel"], td input[type="number"], td input[type="text"] {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; text-align: left; width: auto !important; font-size: 9pt !important;
      }
      textarea[id^="note-"] {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; min-height: auto !important; height: auto !important;
          overflow: visible !important; resize: none !important; font-size: 9pt !important; white-space: normal !important;
      }
      #totalSalary {
        margin-top: 10mm; padding: 8px; border: 1px solid #ccc; background-color: #f9f9f9 !important;
        color: #000 !important; box-shadow: none; page-break-before: auto;
      }
      a { text-decoration: none; color: #000; }
      a[href^="http"]:after { content: " (" attr(href) ")"; font-size: 8pt; }
      .current-day, .current-day td, .current-day th, .current-day input, .current-day textarea {
          background-color: #fff !important; color: #000 !important; border-color: #ccc !important;
      }
      .current-day span[aria-hidden="true"], #workDays td:nth-child(1) span[aria-hidden="true"] { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="app-loader">
    <div class="loader-spinner"></div>
    <p>Naƒç√≠tavam aplik√°ciu...</p>
  </div>

  <div id="auth-container" class="content-hidden" style="margin-bottom: 20px;">
      <fieldset id="login-fieldset">
        <legend>Prihl√°senie / Registr√°cia</legend>
        <div id="login-form">
          <input type="email" id="email" placeholder="Email" aria-label="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Heslo" aria-label="Heslo" autocomplete="current-password">
          <button class="btn export-btn" onclick="loginUser()">Prihl√°si≈• sa</button>
          <button class="btn export-btn" onclick="registerUser()">Registrova≈•</button>
          <a href="#" onclick="resetUserPassword(); return false;">Zabudli ste heslo?</a>
        </div>
      </fieldset>
      <div id="user-info" style="display: none; justify-content: center; align-items: center; gap: 15px; margin-top:10px;">
        <span id="user-email" style="font-weight:500;"></span>
        <button class="btn reset-btn" onclick="logoutUser()" style="padding: 8px 15px; font-size: 0.85rem; margin:0;">Odhl√°si≈• sa</button>
      </div>
  </div>

  <div class="container content-hidden"> <!-- Pridan√° trieda content-hidden -->
    <!-- ... zvy≈°ok v√°≈°ho hlavn√©ho kontajnera aplik√°cie ... (bez zmien) -->
    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <div class="settings">
        <button id="toggleSettingsBtn" class="btn" aria-expanded="false" aria-controls="settings-collapsible-content">Zobrazi≈• nastavenia aplik√°cie ‚ñº</button>
        <div id="settings-collapsible-content">
            <fieldset>
                <legend>Z√°kladn√© nastavenia</legend>
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="hourlyWageInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="text" inputmode="decimal" id="taxRateInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxBlur(this)">
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                      <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                    </select>
                </div>
            </fieldset>
             <fieldset>
                <legend>Navig√°cia v ƒçase</legend>
                <div>
                    <label for="monthSelect">Mesiac:</label>
                    <select id="monthSelect" onchange="changeMonth()"></select>
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite">V√Ωpoƒçet celkovej mzdy...</div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (s pozn.)</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (XLSX)</button>
        <button class="btn backup-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (XLSX)</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠ta≈• z Cloudu</button>
        <button class="btn warning-btn" onclick="clearMonthData()" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• Mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©.</div>
  <div id="errorNotification" role="alert" aria-live="assertive">Nastala chyba.</div>
  <div id="warningNotification" role="alert" aria-live="assertive">Upozornenie.</div>

  <script type="module">
    // ... (v≈°etky importy Firebase zost√°vaj√∫ rovnak√©) ...
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
        initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED,
        collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, writeBatch
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js';

   const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Nahraƒète va≈°imi skutoƒçn√Ωmi kƒæ√∫ƒçmi
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    const app = initializeApp(firebaseConfig);
    try {
       const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // V√°≈° reCAPTCHA v3 site key
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("App Check initialization failed. This might happen if reCAPTCHA script is blocked or fails to load. App will continue without App Check.", e);
    }
    const auth = getAuth(app);

    let db;
    try {
        db = initializeFirestore(app, {
            localCache: persistentLocalCache({ sizeBytes: CACHE_SIZE_UNLIMITED })
        });
    } catch (error) {
        db = initializeFirestore(app, {});
        showErrorNotification("Chyba pri inicializ√°cii offline √∫lo≈æiska. Offline re≈æim nemus√≠ by≈• dostupn√Ω.");
    }

    // Glob√°lne Premenn√© a Kon≈°tanty
    // ... (v≈°etky va≈°e glob√°lne premenn√© zost√°vaj√∫) ...
    let currentUser = null;
    let currentListenerUnsubscribe = null;

    const uiRefs = { /* ... zost√°va rovnak√© ... */ };
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let appSettings = { /* ... zost√°va rovnak√© ... */ };
    const MONTH_NAMES = [/* ... */];
    const DAY_NAMES_SHORT = [/* ... */];
    const PENDING_SYNC_MONTHS_LS_KEY = 'pendingSyncMonthsList';


    // Naƒç√≠tanie elementov pre loader a hlavn√© kontajnery
    const appLoader = document.getElementById('app-loader');
    const authContainer = document.getElementById('auth-container');
    const mainAppContainer = document.querySelector('.container:not(#auth-container)'); // Presnej≈°√≠ selektor pre hlavn√Ω kontajner

    // ... (v≈°etky va≈°e funkcie ako updateAppBadge, getPendingSyncMonths, atƒè. zost√°vaj√∫ rovnak√©) ...
    // ... (v≈°etky pomocn√© funkcie getDaysInMonth, isValidTimeFormat, atƒè. zost√°vaj√∫ rovnak√©) ...
    // ... (v≈°etky UI funkcie showNotification, setLoadingState, atƒè. zost√°vaj√∫ rovnak√©) ...
    // ... (v≈°etky funkcie pre pr√°cu s localStorage a Firestore appSettings zost√°vaj√∫ rovnak√©) ...

    // --- Badging API Funkcie ---
    async function updateAppBadge(count) { /* ... k√≥d funkcie ... */ }
    function getPendingSyncMonths() { /* ... k√≥d funkcie ... */ }
    function savePendingSyncMonths(months) { /* ... k√≥d funkcie ... */ }
    function addMonthToPendingList(monthDocId) { /* ... k√≥d funkcie ... */ }
    function removeMonthFromPendingList(monthDocId) { /* ... k√≥d funkcie ... */ }
    function getPendingSyncCount() { /* ... k√≥d funkcie ... */ }
    // --- Koniec Badging API Funkci√≠ ---

    if ('serviceWorker' in navigator) { /* ... k√≥d pre SW message listener ... */ }
    document.addEventListener('visibilitychange', () => { /* ... k√≥d pre visibilitychange listener ... */ });


    function initializeUIelements() { // Premenovan√° z initializeUI, aby sa nem√Ωlila s logikou v onAuthStateChanged
        loadAppSettingsFromLocalStorage();
        MONTH_NAMES.forEach((name, index) => { const option = document.createElement('option'); option.value = index; option.textContent = name; uiRefs.monthSelect.appendChild(option); });
        const startYear = 2020, endYear = currentDate.getFullYear() + 5;
        for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; uiRefs.yearSelect.appendChild(option); }
        uiRefs.monthSelect.value = currentMonth;
        uiRefs.yearSelect.value = currentYear;
        updateSettingsUIInputs();
        updateLocalStorageSizeIndicator();
        // updatePageTitleAndGreeting() a updateAppBadge() sa zavolaj√∫ a≈æ v onAuthStateChanged
    }


    // ... (v≈°etky va≈°e funkcie pre updateEmployeeName, handleNumericInput, atƒè. zost√°vaj√∫ rovnak√©) ...
    // ... (updatePageTitleAndGreeting - k√≥d funkcie s √∫pravou pre emoji) ...
    function updatePageTitleAndGreeting() {
        const wavingHand = "üëã";
        const namePart = appSettings.employeeName ? `${appSettings.employeeName.split(' ')[0]}` : "";
        const textGreetingPart = `Vitaj${namePart ? ' ' + namePart : ''}`;
        
        if (uiRefs.mainTitle) {
            uiRefs.mainTitle.innerHTML = `${textGreetingPart} <span class="emoji-in-title">${wavingHand}</span>`;
        }

        const monthName = MONTH_NAMES[currentMonth];
        const titleNamePart = appSettings.employeeName ? `${appSettings.employeeName} - ` : "";
        document.title = `${titleNamePart}${monthName} ${currentYear} | Bruno's Calc Pro`;
        if (uiRefs.subTitle) {
            uiRefs.subTitle.textContent = `${monthName} ${currentYear}`;
        }
    }
    // ... (authErrorMap, mapFirebaseAuthError, loginUser, registerUser, createUserCollectionAndSettings, logoutUser, resetUserPassword zost√°vaj√∫ rovnak√©) ...
    // ... (updateUIForAuthStateChange - vol√° sa a≈æ v onAuthStateChanged) ...

    // ... (setupFirestoreWorkDataListener, _debouncedSaveWorkDataAndSync, getFirestoreDocId, atƒè. zost√°vaj√∫ rovnak√©) ...
    // ... (collectWorkDataForStorage, saveWorkDataToFirestore, syncPendingWorkData zost√°vaj√∫ rovnak√©) ...
    // ... (loadFromFirestore, loadWorkDataFromLocalStorage, parseAndApplyWorkData, resetTableInputsOnly zost√°vaj√∫ rovnak√©) ...
    // ... (createTable a v≈°etky funkcie pre pr√°cu s tabuƒækou a v√Ωpoƒçty zost√°vaj√∫ rovnak√©) ...
    // ... (exportToPDF, sendPDF, createBackup, restoreBackup zost√°vaj√∫ rovnak√©) ...
    // ... (changeMonth, changeYear, toggleSettingsBtn listener, window online/offline listeners zost√°vaj√∫ rovnak√©) ...

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;

        if (user) {
            // Pou≈æ√≠vateƒæ je prihl√°sen√Ω
            if (authContainer) authContainer.classList.add('content-hidden');
            if (mainAppContainer) mainAppContainer.classList.remove('content-hidden');
            
            updateUIForAuthStateChange(); // Aktualizuje user-info a odznak

            const settingsLoadedFromFS = await loadUserAppSettingsFromFirestore();
            if (!settingsLoadedFromFS) {
                loadAppSettingsFromLocalStorage(); // Naƒç√≠ta z LS, ak nie s√∫ v FS
                updateSettingsUIInputs();        // Aplikuje na UI
                if (navigator.onLine) await saveAppSettingsToFirestore(); // A ulo≈æ√≠ do FS
            }
            // Ak boli nastavenia naƒç√≠tan√© z FS, updateSettingsUIInputs() u≈æ bolo volan√© v loadUserAppSettingsFromFirestore

            syncPendingWorkData(); // Sk√∫s synchronizova≈•
        } else {
            // Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω
            if (mainAppContainer) mainAppContainer.classList.add('content-hidden');
            if (authContainer) authContainer.classList.remove('content-hidden');
            
            updateUIForAuthStateChange(); // Aktualizuje user-info (skryje ho) a odznak

            loadAppSettingsFromLocalStorage(); // Naƒç√≠taj aspo≈à defaultn√©/posledn√© lok√°lne nastavenia
            updateSettingsUIInputs();        // Aplikuj ich na UI
            localStorage.removeItem(PENDING_SYNC_MONTHS_LS_KEY);
            updateAppBadge(0);
        }

        if (appLoader) appLoader.classList.add('content-hidden'); // Skry loader

        // A≈æ teraz, keƒè je jasn√©, ƒço zobrazi≈• a nastavenia s√∫ naƒç√≠tan√©, inicializujeme zvy≈°ok UI
        createTable();
        setupFirestoreWorkDataListener(); // Nastav√≠ listener pre aktu√°lny mesiac (a m√¥≈æe spusti≈• sync)
        updatePageTitleAndGreeting(); // Nastav√≠ titulky
    });

    initializeUIelements(); // Zavol√°me len z√°kladn√© nastavenie UI elementov, ktor√© nez√°visia od prihl√°senia

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => { /* console.log('Service Worker registered.', reg); */ })
          .catch(err => { console.error('Service Worker registration failed:', err); });
      });
    }
  </script>
</body>
</html>
