<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELAT√çVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Kni≈ænice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Z√°kladn√© ≈°t√Ωly - bez zmien okrem h1 */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    /* --- ZMENEN√ù ≈†T√ùL PRE h1 --- */
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black; /* Statick√° ƒçierna farba */
      /* Odstr√°nen√©: background, background-clip, -webkit-background-clip, animation */
      margin-bottom: 10px;
    }
    /* --- KONIEC ZMENY PRE h1 --- */

    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      /* Zmenen√©: zarovnanie na zaƒçiatok pre lep≈°ie zobrazenie tlaƒçidla */
      align-items: flex-start;
      /* Odstr√°nen√© justify-content, flex riadi ≈°√≠rku */
    }
    /* --- √öPRAVA PRE TESNEJ≈†IE ROZLO≈ΩENIE --- */
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
       /* Aplikujeme margin na v≈°etky priame deti .settings */
      margin: 2px 5px;
    }
    .settings > div {
      flex: 1 1 200px; /* Ponech√°me flex pre input divy */
    }
     /* Tlaƒçidl√° v settings maj√∫ pevn√∫ ≈°√≠rku alebo sa prisp√¥sobia obsahu */
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%; /* Tlaƒçidlo na rozbalenie zaberie cel√∫ ≈°√≠rku */
      margin-bottom: 10px; /* V√§ƒç≈°√≠ odstup pod tlaƒçidlom */
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px 12px;
    }
    body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
    }
     .settings > button.highlight {
       /* Ponech√°me flex: 1 1 150px; ako bolo definovan√© v .btn */
       flex: 1 1 150px;
       /* Pr√≠padne pevn√° ≈°√≠rka */
       /* width: auto; */
       /* min-width: 150px; */
     }


    .settings label {
      display: block;
      margin-bottom: 2px; /* Zmen≈°en√Ω margin pod labelom (bol 5px) */
    }
    /* --- KONIEC √öPRAVY PRE TESNEJ≈†IE ROZLO≈ΩENIE --- */

    /* --- NOV√â ≈†T√ùLY PRE SKR√ùVANIE --- */
    #settings-collapsible-content {
        display: flex; /* Pou≈æijeme flex pre vn√∫torn√© elementy */
        flex-wrap: wrap; /* Umo≈æn√≠ zalamovanie */
        width: 100%; /* Zaberie cel√∫ ≈°√≠rku */
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
        /* Odstr√°nen√© justify-content, flex na de≈•och to riadi */
    }
    #settings-collapsible-content.visible {
        max-height: 400px; /* Dostatoƒçne veƒæk√° hodnota, upravte podƒæa potreby */
        opacity: 1;
        /* Prid√°me mal√Ω odstup zhora, keƒè je viditeƒæn√Ω */
        margin-top: 5px;
    }
    #settings-collapsible-content > div {
         flex: 1 1 200px; /* Zachov√°me flex pre vn√∫torn√© divy */
         margin: 2px 5px; /* Zachov√°me marginy */
    }
     /* --- KONIEC NOV√ùCH ≈†T√ùLOV PRE SKR√ùVANIE --- */

    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      /* Vertik√°lne zarovnanie na stred pre konzistentnej≈°√≠ vzhƒæad */
      vertical-align: middle;
    }
    th {
      background-color: #f2f2f2;
      vertical-align: middle;
    }
    /* --- ODSTR√ÅNEN√â --- ≈°√≠rky boli presunut√© do columnStyles v PDF exporte
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) { ... }
    th:nth-child(1), td:nth-child(1), ... { ... }
    */
    input[type="tel"], input[type="number"], input[type="text"], select { /* Pridan√Ω select pre konzistenciu */
      /* --- ZMENA: width u≈æ nie je 100% kv√¥li ikone vedƒæa --- */
      /* width: 100%; */
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle; /* Pom√°ha zarovnaniu s labelom */
    }
    input[type="number"] {
        /* ƒå√≠seln√© polia m√¥≈æu zabra≈• cel√∫ ≈°√≠rku bunky */
        width: 100%;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    /* Opraven√Ω tmav√Ω re≈æim: selektory sa teraz vz≈•ahuj√∫ na prvky v r√°mci body.dark-mode */
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    /* --- ≈†T√ùL PRE h1 V TMAVOM RE≈ΩIME --- */
    body.dark-mode h1 {
        color: #f4f4f4; /* Svetl√° farba pre tmav√Ω re≈æim */
    }
    /* --- KONIEC ≈†T√ùLU PRE h1 V TMAVOM RE≈ΩIME --- */
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select { /* Pridan√Ω select */
      background-color: #666;
      color: white;
      border-color: #555; /* Trochu tmav≈°√≠ okraj pre kontrast */
    }
    body.dark-mode .btn {
      color: #f4f4f4; /* Svetlej≈°√≠ text na tmav√Ωch tlaƒçidl√°ch */
    }
    body.dark-mode .reset-btn {
      background-color: #d32f2f;
    }
    body.dark-mode .export-btn {
      background-color: #388e3c;
    }
    body.dark-mode .backup-btn {
      background-color: #6a1bb2;
    }
    body.dark-mode #totalSalary {
      background-color: #2c3e50;
    }
    body.dark-mode .current-day {
      background-color: #4a0e8f;
      color: #fff;
    }
    body.dark-mode .current-day input {
      background-color: #5c1db3;
      color: #fff;
    }
    /* Odstr√°nen√© anim√°cie, lebo u≈æ nie s√∫ potrebn√© */
    /*
    @keyframes gradientText { ... }
    @keyframes textShadowPulse { ... }
    */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1em;
      }
      .settings {
        flex-direction: column; /* Toto u≈æ je, ale potvrdzujeme */
        align-items: stretch; /* Zarovn√°me polo≈æky na ≈°√≠rku */
      }
      .settings > div {
        flex-basis: auto; /* Resetujeme flex-basis pre vn√∫torn√© divy */
        width: 100%; /* V≈°etky divy na 100% ≈°√≠rky */
        margin: 5px 0; /* Upraven√Ω margin pre mobiln√© zobrazenie */
      }
       .settings > button#toggleSettingsBtn {
           flex-basis: auto; /* Reset */
           width: 100%;
           margin-bottom: 10px;
       }
       .settings > button.highlight {
           flex-basis: auto; /* Reset */
           width: 100%;
           margin: 5px 0;
       }
       /* Vn√∫tro collapsible kontajnera na mobiloch */
       #settings-collapsible-content {
            flex-direction: column; /* Pod sebou */
            align-items: stretch;
       }
       #settings-collapsible-content > div {
           flex-basis: auto;
           width: 100%; /* Ka≈æd√Ω input na 100% ≈°√≠rky */
           margin: 5px 0;
       }
       #settings-collapsible-content.visible {
           max-height: 600px; /* Zv√Ω≈°en√° max-height pre mobil */
       }


      table {
        min-width: 800px;
      }
      th, td {
        padding: 6px;
        font-size: 0.8em;
      }
      .btn-container {
        flex-direction: column;
        align-items: stretch;
      }
      .btn {
        flex: 1 1 auto;
        font-size: 14px;
        padding: 8px 16px;
        margin: 5px 0;
      }
      .backup-btn {
        padding: 15px 16px;
      }
      #totalSalary {
        font-size: 16px;
      }
      #dataSizeContainer {
        font-size: 12px;
      }
      .table-container {
        overflow-x: auto;
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.7em;
      }
      .btn {
        font-size: 12px;
        padding: 6px 12px;
      }
      .backup-btn {
        padding: 15px 12px;
      }
      .settings label {
        font-size: 0.9em;
      }
      input[type="tel"], input[type="number"], input[type="text"], select { /* Pridan√Ω select */
        font-size: 12px;
      }
      table {
        min-width: 800px;
      }
      /* Oprava pre najmen≈°ie obrazovky, aby tlaƒçidl√° mali nejak√Ω margin */
       .settings > button#toggleSettingsBtn,
       .settings > button.highlight {
           margin: 5px 0;
       }
       #settings-collapsible-content > div {
          margin: 5px 0;
       }
       #settings-collapsible-content.visible {
           max-height: 700px; /* E≈°te v√§ƒç≈°ia v√Ω≈°ka pre istotu */
       }

    }
    #saveNotification, #errorNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show {
      display: block;
      opacity: 1;
    }
    #saveNotification {
      background-color: #4CAF50;
      color: white;
    }
    #errorNotification {
      background-color: #f44336;
      color: white;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 200px;
      margin: 5px auto;
      display: block;
    }
    #login-form .btn {
      width: 120px;
      margin: 5px 2px;
    }
    /* --- NOV√ù ≈†T√ùL pre odkaz na obnovu hesla --- */
    #login-form a {
        margin-top: 10px;
        display: block;
        font-size: 0.9em;
        color: #007bff; /* Modr√° farba odkazu */
        text-decoration: none;
    }
    #login-form a:hover {
        text-decoration: underline;
    }
    body.dark-mode #login-form a {
        color: #6bbaff; /* Svetlej≈°ia modr√° v tmavom re≈æime */
    }

    /* --- ODSTR√ÅNEN√â: Nepotrebn√© ≈°t√Ωly pre checkbox a jeho kontajner --- */
    /*
    .time-input-container { ... }
    .autofill-toggle { ... }
    body.dark-mode .autofill-toggle { ... }
    */

    /* --- NOV√â: ≈†t√Ωly pre wrapper a ikonu hod√≠n --- */
    .time-input-wrapper {
        display: flex;
        align-items: center; /* Vertik√°lne zarovnanie */
        gap: 5px; /* Medzera medzi inputom a ikonou */
    }

    .time-input-wrapper input[type="tel"] {
        flex-grow: 1; /* Input zaberie dostupn√Ω priestor */
        min-width: 50px; /* Minim√°lna ≈°√≠rka */
    }

    .clock-icon {
        flex-shrink: 0; /* Ikona sa nebude zmen≈°ova≈• */
        cursor: pointer;
        font-size: 1.3em; /* Trochu v√§ƒç≈°ia ikona */
        user-select: none; /* Zabr√°ni oznaƒçeniu textu ikony */
        transition: transform 0.2s ease; /* Jemn√° anim√°cia pri kliknut√≠ */
        padding: 2px; /* Mal√Ω klikateƒæn√Ω priestor okolo */
    }
    .clock-icon:hover {
        opacity: 0.8;
    }
    .clock-icon:active {
       transform: scale(0.9); /* Efekt stlaƒçenia */
    }
    body.dark-mode .clock-icon {
        /* V tmavom re≈æime m√¥≈æe by≈• emoji lep≈°ie vidno, ale m√¥≈æeme prida≈• filter, ak by nebolo */
        /* filter: brightness(1.2); */
    }
    /* --- KONIEC NOV√ùCH ≈†T√ùLOV --- */
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikaƒçn√© UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1> <!-- Nadpis sa aktualizuje cez JS -->
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobrazi≈• nastavenia ‚ñº</button>
      <div id="settings-collapsible-content">
          <div>
            <label for="employeeNameInput">Meno pracovn√≠ka: </label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="taxRateInput">Da≈àov√© percento (%): </label>
            <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
              <option value="0">Janu√°r</option>
              <option value="1">Febru√°r</option>
              <option value="2">Marec</option>
              <option value="3">Apr√≠l</option>
              <option value="4">M√°j</option>
              <option value="5">J√∫n</option>
              <option value="6">J√∫l</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">Okt√≥ber</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok: </label>
            <select id="yearSelect" onchange="changeYear()">
              <!-- Dynamicky generovan√© roky -->
            </select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
      </div> <!-- Koniec settings-collapsible-content -->
       <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div> <!-- Koniec settings -->


    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky bud√∫ generovan√© cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button> <!-- Toto tlaƒçidlo teraz generuje zjednodu≈°en√© PDF -->
      <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <!-- Hlavn√Ω JavaScript k√≥d + Firebase -->
  <script type="module">
    // Naƒç√≠tanie preferencie tmav√©ho re≈æimu z localStorage
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    // Funkcia pre prep√≠nanie tmav√©ho re≈æimu
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGUR√ÅCIA Firebase --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Pozor: Verejn√Ω kƒæ√∫ƒç
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.appspot.com", // Opraven√Ω storage bucket
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializ√°cia Firebase
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Pozor: Verejn√Ω kƒæ√∫ƒç ReCaptcha
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------------------- GLOB√ÅLNE PREMENN√â --------------------
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');


    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(hourlyWageInput.value) || 10;
    let taxRate = (parseFloat(taxRateInput.value) || 2) / 100;
    let monthData = {}; // Nepou≈æ√≠va sa priamo

    function updateGreeting() {
      if (employeeName) {
        const firstName = employeeName.split(' ')[0];
        mainTitle.textContent = `Ahoj ${firstName}`;
      } else {
        mainTitle.textContent = 'Ahoj';
      }
    }

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }
    populateYearSelect();

    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1);

    updateGreeting();

    if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
            const isVisible = settingsCollapsibleContent.classList.toggle('visible');
            toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
        });
    }

    // -------------------- MONITOROVANIE ONLINE/OFFLINE --------------------
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { /* ... (k√≥d bez zmeny) ... */ }
    function showErrorNotification(message) { /* ... (k√≥d bez zmeny) ... */ }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- AUTENTIFIK√ÅCIA (bez zmien v logike) --------------------
    window.login = async function() { /* ... (k√≥d bez zmeny) ... */ }
    window.register = async function() { /* ... (k√≥d bez zmeny) ... */ }
    window.logout = async function() { /* ... (k√≥d bez zmeny) ... */ }
    window.resetPassword = async function() { /* ... (k√≥d bez zmeny) ... */ }
    function mapFirebaseAuthError(errorCode) { /* ... (k√≥d bez zmeny) ... */ }
    async function createUserCollection() { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- UI Update a Logika Naƒç√≠tania (bez zmien v logike) --------------------
    function updateUI() { /* ... (k√≥d bez zmeny) ... */ }
    async function loadInitialData() { /* ... (k√≥d bez zmeny) ... */ }
    async function loadFromFirestoreAndApply() { /* ... (k√≥d bez zmeny) ... */ }
    function loadFromLocalStorageOnly() { /* ... (k√≥d bez zmeny) ... */ }
    function parseAndApplyData(dataString) { /* ... (k√≥d bez zmeny) ... */ }


    // -------------------- Ukladanie do Firestore a localStorage s debounce (bez zmien v logike) --------------------
    function debounce(func, wait) { /* ... (k√≥d bez zmeny) ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);
    function collectCurrentData() { /* ... (k√≥d bez zmeny) ... */ }
    async function saveToFirestore() { /* ... (k√≥d bez zmeny) ... */ }
    async function syncWithFirebase() { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- Naƒç√≠tanie z Firestore (explicitne tlaƒçidlom - bez zmien v logike) --------------------
    window.loadFromFirestore = async function() { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- Tvorba tabuƒæky a v√Ωpoƒçty --------------------
    function getDayName(year, month, day) { /* ... (k√≥d bez zmeny) ... */ }

    // --- ODSTR√ÅNEN√â: Funkcia toggleAutoFillPreference u≈æ nie je potrebn√° ---
    // window.toggleAutoFillPreference = function(...) { ... }

    // --- ODSTR√ÅNEN√â: Funkcia autoFillTime u≈æ nie je potrebn√° (nahraden√° insertCurrentTime) ---
    // window.autoFillTime = function(...) { ... }

    // --- NOV√Å FUNKCIA: Vlo≈æenie aktu√°lneho ƒçasu po kliknut√≠ na ikonu ---
    window.insertCurrentTime = function(inputId) {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;

            inputElement.value = currentTime; // Vlo≈æ√≠me/prep√≠≈°eme ƒças

            // Po vlo≈æen√≠ ƒçasu mus√≠me spusti≈• prepoƒçty a ukladanie
            // Najprv zavol√°me formatAndMoveNext, aby sa ƒças validoval a pr√≠padne posunul kurzor (hoci tu kurzor nepos√∫vame)
            // Potom calculateAndUpdateTotals (ktor√© sa vol√° z handleInput)
            handleInput(inputElement, ''); // Zavol√°me handleInput na prepoƒçet a ulo≈æenie, druh√Ω arg m√¥≈æe by≈• pr√°zdny, lebo nepres√∫vame
            // inputElement.focus(); // Voliteƒæne m√¥≈æeme vr√°ti≈• fokus na pole po kliknut√≠ na ikonu
        }
    }
    // --- KONIEC NOVEJ FUNKCIE ---

    function createTable() {
      console.log(`Vytv√°ram ≈°trukt√∫ru tabuƒæky pre ${getMonthName(currentMonth)} ${currentYear}`);
      workDays.innerHTML = ''; // Vyƒçist√≠me predch√°dzaj√∫ci obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
         // Zv√Ωraznenie aktu√°lneho d≈àa
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        // --- ZMENA: Upraven√© generovanie HTML pre Pr√≠chod a Odchod s ikonou ---
        const startInputId = `start-${currentYear}-${currentMonth}-${i}`;
        const endInputId = `end-${currentYear}-${currentMonth}-${i}`;
        const breakInputId = `break-${currentYear}-${currentMonth}-${i}`;

        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td>
              <div class="time-input-wrapper">
                  <input type="tel" id="${startInputId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"
                         oninput="handleInput(this, '${endInputId}')"> {/* Odstr√°nen√Ω onfocus */}
                  <span class="clock-icon" onclick="insertCurrentTime('${startInputId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span>
              </div>
          </td>
          <td>
              <div class="time-input-wrapper">
                  <input type="tel" id="${endInputId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"
                         oninput="handleInput(this, '${breakInputId}')"> {/* Odstr√°nen√Ω onfocus */}
                  <span class="clock-icon" onclick="insertCurrentTime('${endInputId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span>
              </div>
          </td>
          <td><input type="number" id="${breakInputId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        // --- KONIEC ZMENY ---
        workDays.appendChild(row);
      }
      console.log('≈†trukt√∫ra tabuƒæky vytvoren√°.');
    }

    window.handleInput = function(input, nextId) {
      formatAndMoveNext(input, nextId); // Form√°tovanie a pr√≠padn√Ω presun
      calculateAndUpdateTotals(); // V≈ædy prepoƒç√≠ta a ulo≈æ√≠ zmenu
    }

    window.handleBreakInput = function(day) { /* ... (k√≥d bez zmeny) ... */ }

    // Hlavn√° funkcia pre ukladanie d√°t po akejkoƒævek zmene
    function calculateAndUpdateTotals() { /* ... (k√≥d bez zmeny) ... */ }

    // --- Pomocn√° funkcia pre valid√°ciu ƒçasu ---
    function isValidTimeFormat(timeString) { /* ... (k√≥d bez zmeny) ... */ }

    // --- UPRAVEN√Å FUNKCIA pre form√°tovanie a presun ---
    function formatAndMoveNext(input, nextId) {
        // ... (k√≥d pre form√°tovanie hodnoty - bez zmien) ...
        let value = input.value.replace(/[^\d:]/g, '');
        let originalValue = input.value;
        let cursorPosition = input.selectionStart;

        if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = value + ':'; }
        else if (value.length === 4 && !value.includes(':')) { value = value.substring(0, 2) + ':' + value.substring(2); }
        else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = value.substring(0, 2) + ':' + value.substring(2); }

        value = value.replace(/^:/, '');
        if ((value.match(/:/g) || []).length > 1) { const parts = value.split(':'); value = parts[0] + ':' + parts.slice(1).join(''); }
        if (value.length > 5) { value = value.slice(0, 5); }

        if (input.value !== value) {
            input.value = value;
            try {
                 if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); }
                 else { input.setSelectionRange(cursorPosition, cursorPosition); }
            } catch (e) { /* Ignorujeme chyby */ }
        }

        // --- V√Ωpoƒçet a presun fokusu (bez zmien v logike) ---
        const day = parseInt(input.id.split('-')[3]);
        if (value.length === 5) {
            if (isValidTimeFormat(value)) {
                calculateRow(day);
                // Presun fokusu len ak nextId nie je pr√°zdny (pri volan√≠ z insertCurrentTime je pr√°zdny)
                if (nextId) {
                    moveNext(input, nextId);
                }
            } else {
                calculateRow(day);
            }
        } else {
             calculateRow(day);
        }
    }


    function moveNext(currentElement, nextId) { /* ... (k√≥d bez zmeny) ... */ }
    function calculateRow(day) { /* ... (k√≥d bez zmeny) ... */ }
    function updateNetSalary(day) { /* ... (k√≥d bez zmeny) ... */ }

    // --- VYNULOVANIE RIADKU (bez zmien v logike okrem odstr√°nenia checkboxov) ---
    window.resetRow = function(day, saveChanges = true) {
      const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

      if(startInput) startInput.value = '';
      if(endInput) endInput.value = '';
      if(breakInput) breakInput.value = '';
      // Odstr√°nen√© resetovanie checkboxov a data-atributov

      calculateRow(day); // Prepoƒç√≠ta riadok (v√Ωsledkom bud√∫ nuly)

      if (saveChanges) {
          calculateAndUpdateTotals(); // Ulo≈æ√≠ zmeny, len ak je to po≈æadovan√©
      }
    }

    // --- V√ùPOƒåET CELKOV√ùCH S√öƒåTOV --- (bez zmien v logike)
    function calculateTotal() { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- EXPORT DO PDF (bez zmien v logike) --------------------
    function getMonthName(month) { /* ... (k√≥d bez zmeny) ... */ }
    window.exportToPDF = function() { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- ODOSLANIE PDF (bez zmien v logike) --------------------
    window.sendPDF = function() { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- OSTATN√â NASTAVENIA (bez zmien v logike) --------------------
    window.changeDecimalPlaces = function() { /* ... (k√≥d bez zmeny) ... */ }
    window.updateEmployeeName = function() { /* ... (k√≥d bez zmeny) ... */ }
    window.updateSettings = function() { /* ... (k√≥d bez zmeny) ... */ }
    window.changeMonth = function() { /* ... (k√≥d bez zmeny) ... */ }
    window.changeYear = function() { /* ... (k√≥d bez zmeny) ... */ }
    function getDaysInMonth(month) { /* ... (k√≥d bez zmeny) ... */ }

    // -------------------- INIT (bez zmien v logike) --------------------
    onAuthStateChanged(auth, (user) => { /* ... (k√≥d bez zmeny) ... */ });

    // -------------------- FUNKCIE PRE Z√ÅLOHU A OBNOVU DO EXCELU (bez zmien v logike) --------------------
    window.createBackup = function() { /* ... (k√≥d bez zmeny) ... */ };
    window.restoreBackup = function() { /* ... (k√≥d bez zmeny) ... */ };

  </script>

  <!-- Registr√°cia Service Workera (BEZ ZMIEN) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, ≈æe cesta k service-worker.js je spr√°vna
          .then(registration => {
            console.log('Service Worker zaregistrovan√Ω √∫spe≈°ne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registr√°cia Service Workera zlyhala:', error);
          });
      });
    }
  </script>
</body>
</html>
