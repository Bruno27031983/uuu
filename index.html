<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">
  
  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Pridaný skript pre Firebase App Check -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>
  
  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    body { 
      font-family: 'Roboto', sans-serif; 
      line-height: 1.6; 
      margin: 0; 
      padding: 10px; 
      background-color: #f4f4f4; 
      color: #333; 
    }
    .container { 
      max-width: 1200px; 
      margin: auto; 
      background: white; 
      padding: 15px; 
      border-radius: 5px; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
      position: relative; 
    }
    .autor-info { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      font-size: 14px; 
      font-style: italic; 
      color: #666; 
    }
    h1 { 
      text-align: center; 
      font-size: 2.5em; 
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); 
      background-clip: text; 
      -webkit-background-clip: text; 
      color: transparent; 
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; 
      margin-bottom: 10px; 
    }
    h2 { 
      text-align: center; 
      color: #555; 
      margin-top: -10px; 
      font-size: 1.2em; 
    }
    .settings { 
      margin-bottom: 20px; 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: space-between; 
      align-items: center; 
    }
    .settings > div { 
      flex: 1 1 200px; 
      margin: 5px; 
    }
    .settings label { 
      display: block; 
      margin-bottom: 5px; 
    }
    .table-container { 
      overflow-x: auto; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 20px; 
      min-width: 800px; 
    }
    th, td { 
      padding: 8px; 
      border: 1px solid #ddd; 
      text-align: left; 
      font-size: 0.9em; 
    }
    th { 
      background-color: #f2f2f2; 
    }
    input[type="tel"], input[type="number"], input[type="text"] { 
      width: 100%; 
      padding: 5px; 
      box-sizing: border-box; 
      background-color: #ffffd0; 
      font-size: 14px; 
      border: 1px solid #ccc; 
      border-radius: 3px; 
    }
    .btn-container { 
      display: flex; 
      flex-direction: column; 
      width: 100%; 
      gap: 15px; 
      margin-top: 20px; 
    }
    .btn { 
      width: 100%; 
      padding: 15px 20px; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 16px; 
      transition: background-color 0.3s ease; 
      text-align: center; 
    }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; }
    .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; }
    .backup-btn:hover { background-color: #E68900; }
    .highlight { 
      background-color: #ffcc00; 
      color: #333; 
      font-weight: bold; 
      border: 2px solid #ffcc00; 
    }
    #totalSalary { 
      font-size: 18px; 
      font-weight: bold; 
      text-align: center; 
      margin-top: 20px; 
      padding: 10px; 
      background-color: #e6f3ff; 
      border-radius: 5px; 
    }
    #dataSizeContainer { 
      margin-top: 10px; 
      text-align: center; 
    }
    #dataSizeText { 
      margin-bottom: 5px; 
      font-size: 14px; 
      color: #555; 
    }
    #dataSizeBar { 
      width: 80%; 
      height: 20px; 
      background-color: #ddd; 
      border-radius: 10px; 
      margin: 0 auto; 
      overflow: hidden; 
    }
    #dataSizeFill { 
      height: 100%; 
      width: 0%; 
      background-color: #4CAF50; 
      transition: width 0.3s ease; 
    }
    .current-day { 
      background-color: #8a2be2; 
      color: white; 
    }
    .current-day input { 
      background-color: #9932cc; 
      color: white; 
    }
    @keyframes gradientText { 
      0% { background-position: 0% 50%; } 
      50% { background-position: 100% 50%; } 
      100% { background-position: 0% 50%; } 
    }
    @keyframes textShadowPulse { 
      0%, 100% { 
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 
                     0 0 20px rgba(255, 255, 255, 0.3), 
                     0 0 30px rgba(255, 255, 255, 0.2); 
      } 
      50% { 
        text-shadow: 0 0 20px rgba(255, 255, 255, 1), 
                     0 0 30px rgba(255, 255, 255, 0.9), 
                     0 0 40px rgba(255, 255, 255, 0.7); 
      } 
    }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { 
      max-width: 400px; 
      margin: 20px auto; 
      background: #fff; 
      padding: 20px; 
      border-radius: 5px; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1); 
      text-align: center; 
    }
    #auth-container input { 
      width: 90%; 
      padding: 10px; 
      margin: 5px 0; 
      border: 1px solid #ccc; 
      border-radius: 3px; 
    }
    #auth-container button { 
      width: 95%; 
      padding: 10px; 
      margin: 10px 0; 
      border: none; 
      background-color: #4CAF50; 
      color: #fff; 
      font-size: 16px; 
      border-radius: 3px; 
      cursor: pointer; 
    }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background-color: #4CAF50; 
      color: white; 
      padding: 10px 20px; 
      border-radius: 5px; 
      display: none; 
      z-index: 1000; 
    }
    #saveNotification.show { display: block; }
  </style>
</head>
<body>
  <div id="auth-container">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
    </div>
    <button onclick="logout()">Odhlásiť sa</button>
  </div>

  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril a financoval Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2></h2>
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Veľkosť dát: 0 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirebase()">Načítať dáta z Firebase</button>
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // -----------------------
    // 1) Konfigurácia Firebase
    // -----------------------
    const firebaseConfig = {
       apiKey : "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk" , 
  authDomain : "uuuuu-f7ef9.firebaseapp.com" , 
  projectId : "uuuuu-f7ef9" , 
  storageBucket : "uuuuu-f7ef9.firebasestorage.app" , 
  messagingSenderId : "456105865458" , 
  appId : "1:456105865458:web:101f0a4dcb455f174b606b" , 
    };
    firebase.initializeApp(firebaseConfig);
    firebase.appCheck().activate('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v');
    const db = firebase.firestore();
    const auth = firebase.auth();

    // -----------------------
    // 2) Globálne premenné
    // -----------------------
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate, monthData;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // -----------------------
    // 3) Prihlásenie / odhlásenie
    // -----------------------
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Registrovaný:", userCredential.user);
          alert("Registrácia úspešná!");
        })
        .catch((error) => {
          console.error("Chyba pri registrácii:", error.message);
          alert("Chyba: " + error.message);
        });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Prihlásený:", userCredential.user);
          alert("Prihlásenie úspešné!");
        })
        .catch((error) => {
          console.error("Chyba pri prihlásení:", error.message);
          alert("Chyba: " + error.message);
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Odhlásený.");
          alert("Odhlásenie úspešné!");
        })
        .catch((error) => {
          console.error("Chyba pri odhlásení:", error.message);
          alert("Chyba: " + error.message);
        });
    }

    auth.onAuthStateChanged(async (user) => {
      const authMessage = document.getElementById('auth-message');
      const authContainer = document.getElementById('auth-container');
      const calculatorContainer = document.getElementById('calculator-container');
      if (user) {
        authMessage.textContent = "Prihlásený: " + user.email;
        authContainer.style.display = "none";
        calculatorContainer.style.display = "block";
        const uid = user.uid;
        const userDocRef = db.collection("users").doc(uid);
        const userDocSnap = await userDocRef.get();
        if (!userDocSnap.exists) {
          await userDocRef.set({ email: user.email, createdAt: new Date().toISOString() });
          console.log("Vytvorený dokument pre:", uid);
        }
        loadFromFirebase(); // Načítanie dát po prihlásení
      } else {
        authMessage.textContent = "Žiadny používateľ nie je prihlásený.";
        authContainer.style.display = "block";
        calculatorContainer.style.display = "none";
      }
    });

    // -----------------------
    // 4) Funkcie pre ukladanie
    // -----------------------
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 300);

    function showSaveNotification(message) {
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 2000);
    }

    async function saveToFirebase() {
      try {
        const dataToSave = {
          workDaysData: JSON.stringify(monthData),
          hourlyWage: JSON.stringify(hourlyWage),
          taxRate: JSON.stringify(taxRate * 100),
          darkMode: JSON.stringify(document.body.classList.contains('dark-mode')),
          decimalPlaces: JSON.stringify(decimalPlaces),
          employeeName: JSON.stringify(employeeName),
          timestamp: new Date().toISOString()
        };
        const yearMonthDoc = `${currentYear}-${currentMonth}`;
        const uid = auth.currentUser?.uid || "unknown";
        await db.collection("users").doc(uid)
          .collection("calculatorData").doc(yearMonthDoc).set(dataToSave);
        console.log("Uložené do Firebase:", uid, yearMonthDoc);
        showSaveNotification("Dáta uložené do Firebase");
      } catch (error) {
        console.error("Chyba pri ukladaní do Firebase:", error);
        alert("Chyba pri ukladaní do Firebase: " + error.message);
      }
    }

    function saveToLocalStorage() {
      try {
        const data = [];
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
          const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
          const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
          const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0.00';
          const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0.00';
          data.push({ start, end, breakTime, gross, net });
        }
        if (!monthData[currentYear]) monthData[currentYear] = {};
        monthData[currentYear][currentMonth] = data;
        const serializedData = JSON.stringify(monthData);
        const totalData = serializedData + JSON.stringify(hourlyWage) + JSON.stringify(taxRate) +
          JSON.stringify(document.body.classList.contains('dark-mode')) +
          JSON.stringify(decimalPlaces) + JSON.stringify(employeeName);
        const bytes = new Blob([totalData]).size;
        if (bytes > MAX_DATA_SIZE) {
          alert(`Prekročili ste maximálnu veľkosť dát (${MAX_DATA_SIZE_KB} KB).`);
          return;
        }
        localStorage.setItem('workDaysData', serializedData);
        localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
        localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
        localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
        localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
        localStorage.setItem('employeeName', JSON.stringify(employeeName));
        updateDataSize();
        saveToFirebase();
      } catch (error) {
        console.error('Chyba pri ukladaní do localStorage:', error);
        alert("Chyba pri ukladaní z localStorage: " + error.message);
      }
    }

    async function loadFromFirebase() {
      try {
        const uid = auth.currentUser?.uid;
        if (!uid) {
          console.log("Nikto nie je prihlásený.");
          return;
        }
        const docRef = db.collection("users").doc(uid)
          .collection("calculatorData").doc(`${currentYear}-${currentMonth}`);
        const docSnap = await docRef.get();
        if (docSnap.exists) {
          const data = docSnap.data();
          console.log("Načítané z Firebase:", data);
          monthData = JSON.parse(data.workDaysData || '{}');
          hourlyWage = parseFloat(JSON.parse(data.hourlyWage)) || 10;
          taxRate = parseFloat(JSON.parse(data.taxRate)) / 100 || 0.02;
          decimalPlaces = parseInt(JSON.parse(data.decimalPlaces)) || 1;
          employeeName = JSON.parse(data.employeeName) || '';
          const darkMode = JSON.parse(data.darkMode) || false;
          localStorage.setItem('workDaysData', JSON.stringify(monthData));
          localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
          localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
          localStorage.setItem('darkMode', JSON.stringify(darkMode));
          localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
          localStorage.setItem('employeeName', JSON.stringify(employeeName));
          hourlyWageInput.value = hourlyWage;
          taxRateInput.value = taxRate * 100;
          decimalPlacesSelect.value = decimalPlaces;
          employeeNameInput.value = employeeName;
          createTable();
          const monthDays = (monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
          monthDays.forEach((day, index) => {
            const i = index + 1;
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
            if (startElement && endElement && breakElement && grossElement && netElement) {
              startElement.value = day.start || '';
              endElement.value = day.end || '';
              breakElement.value = day.breakTime || '';
              grossElement.value = day.gross || '0.00';
              netElement.value = day.net || '0.00';
              calculateRow(i);
            }
          });
          calculateTotal();
          updateDataSize();
          if (darkMode) toggleDarkMode();
          showSaveNotification("Dáta načítané z Firebase");
        } else {
          console.log("Žiadne dáta na Firebase pre:", `${currentYear}-${currentMonth}`);
          loadFromLocalStorage();
        }
      } catch (error) {
        console.error("Chyba pri načítavaní z Firebase:", error);
        alert("Chyba pri načítavaní z Firebase: " + error.message);
        loadFromLocalStorage();
      }
    }

    function loadFromLocalStorage() {
      try {
        monthData = JSON.parse(localStorage.getItem('workDaysData')) || {};
        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
        hourlyWageInput.value = hourlyWage;
        taxRateInput.value = taxRate * 100;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        createTable();
        const data = (monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
        data.forEach((day, index) => {
          const i = index + 1;
          const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
          const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
          const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
          const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
          const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
          if (startElement && endElement && breakElement && grossElement && netElement) {
            startElement.value = day.start || '';
            endElement.value = day.end || '';
            breakElement.value = day.breakTime || '';
            grossElement.value = day.gross || '0.00';
            netElement.value = day.net || '0.00';
            calculateRow(i);
          }
        });
        calculateTotal();
        updateDataSize();
        if (darkMode) toggleDarkMode();
      } catch (error) {
        console.error('Chyba pri načítavaní z localStorage:', error);
        alert("Chyba pri načítavaní z localStorage: " + error.message);
      }
    }

    // -----------------------
    // 5) Vytváranie tabuľky
    // -----------------------
    function getDayName(year, month, day) {
      const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
      return daysOfWeek[new Date(year, month, day).getDay()];
    }

    function createTable() {
      workDays.innerHTML = '';
      const currentDate = new Date();
      const currentDay = currentDate.getDate();
      const currentMonthIndex = currentDate.getMonth();
      const currentYearValue = currentDate.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDay && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }
        const dayName = getDayName(currentYear, currentMonth, i);
        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        workDays.appendChild(row);
      }
    }

    function handleInput(input, nextId) {
      formatAndMoveNext(input, nextId);
      calculateAndUpdateTotals();
    }

    function handleBreakInput(day) {
      calculateRow(day);
      const nextDay = day + 1;
      if (nextDay <= getDaysInMonth(currentMonth)) {
        moveNext(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`), `start-${currentYear}-${currentMonth}-${nextDay}`);
      }
      calculateAndUpdateTotals();
    }

    function calculateAndUpdateTotals() {
      calculateTotal();
      debouncedSaveToLocalStorage();
    }

    function formatAndMoveNext(input, nextId) {
      let value = input.value.replace(/[^\d:]/g, '');
      if (value.length === 4 && !value.includes(':')) {
        value = value.slice(0, 2) + ':' + value.slice(2);
      }
      input.value = value;
      if (value.length === 5) {
        const [hours, minutes] = value.split(':').map(Number);
        if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
          const day = parseInt(input.id.split('-')[3]);
          calculateRow(day);
          moveNext(input, nextId);
        } else {
          alert("Neplatný čas. Použite rozsah 00:00 - 23:59.");
          input.value = '';
        }
      }
    }

    function moveNext(currentElement, nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) nextElement.focus();
    }

    function calculateRow(day) {
      const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
      const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
      const breakTime = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value) || 0;
      const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      if (!startTime || !endTime || !totalCell || !grossElement || !netElement) return;
      const [startHours, startMinutes] = startTime.split(':').map(Number);
      const [endHours, endMinutes] = endTime.split(':').map(Number);
      const startDate = new Date(0, 0, 0, startHours, startMinutes);
      const endDate = new Date(0, 0, 0, endHours, endMinutes);
      let diff = (endDate - startDate) / 60000 - (breakTime * 60);
      if (diff < 0) diff += 24 * 60;
      const hours = Math.floor(diff / 60);
      const minutes = Math.round(diff % 60);
      const decimalHours = (diff / 60).toFixed(decimalPlaces);
      totalCell.textContent = `${hours}h ${minutes}m (${decimalHours} h)`;
      const grossSalary = (diff / 60) * hourlyWage;
      grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces) : '0.00';
      const netSalary = grossSalary * (1 - taxRate);
      netElement.value = isFinite(netSalary) ? netSalary.toFixed(decimalPlaces) : '0.00';
    }

    function resetRow(day) {
      const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      if (start && end && breakTime && total && gross && net) {
        start.value = '';
        end.value = '';
        breakTime.value = '';
        total.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
        gross.value = '0.00';
        net.value = '0.00';
        calculateAndUpdateTotals();
      }
    }

    function resetAll() {
      if (confirm('Ste si istý, že chcete resetovať dáta pre aktuálny mesiac?')) {
        if (monthData[currentYear]) delete monthData[currentYear][currentMonth];
        localStorage.setItem('workDaysData', JSON.stringify(monthData));
        createTable();
        calculateTotal();
      }
    }

    function calculateTotal() {
      let totalMinutes = 0;
      let totalGrossSalary = 0;
      let totalNetSalary = 0;
      let daysWithEntries = 0;
      workDays.querySelectorAll('tr').forEach(row => {
        const totalCell = row.children[4];
        const grossInput = row.children[5]?.querySelector('input');
        const netInput = row.children[6]?.querySelector('input');
        if (totalCell && grossInput && netInput) {
          const totalText = totalCell.textContent;
          const match = totalText.match(/(\d+)h (\d+)m \(([\d.]+) h\)/);
          if (match) {
            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            totalMinutes += hours * 60 + minutes;
            const grossSalary = parseFloat(grossInput.value) || 0;
            totalGrossSalary += grossSalary;
            const netSalary = parseFloat(netInput.value) || 0;
            totalNetSalary += netSalary;
            if (grossSalary > 0 || netSalary > 0) {
              daysWithEntries += 1;
            }
          }
        }
      });
      const totalHours = Math.floor(totalMinutes / 60);
      const totalMinutesRemainder = Math.round(totalMinutes % 60);
      const totalDecimalHours = (totalMinutes / 60).toFixed(decimalPlaces);
      const averageNetSalary = daysWithEntries > 0 ? (totalNetSalary / daysWithEntries).toFixed(decimalPlaces) : 0;
      const averageWorkedMinutes = daysWithEntries > 0 ? totalMinutes / daysWithEntries : 0;
      const averageHours = Math.floor(averageWorkedMinutes / 60);
      const averageMinutes = Math.round(averageWorkedMinutes % 60);
      const averageDecimalHours = (averageWorkedMinutes / 60).toFixed(decimalPlaces);
      totalSalaryDiv.innerHTML = `
        Počet odpracovaných dní: ${daysWithEntries}<br>
        Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours} h)<br>
        Celková hrubá mzda: ${totalGrossSalary.toFixed(decimalPlaces)}€<br>
        Celková čistá mzda: ${totalNetSalary.toFixed(decimalPlaces)}€<br>
        Priemerná čistá mzda: ${averageNetSalary}€<br>
        <strong>Priemerný odpracovaný čas: ${averageHours}h ${averageMinutes}m (${averageDecimalHours} h)</strong>
      `;
    }

    // -----------------------
    // 7) Export do PDF so načítavaním fontu z URL
    // -----------------------
    function getMonthName(month) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[month];
    }

    function exportToPDF() {
      if (!window.jspdf) {
        alert("Knižnica jsPDF nie je načítaná.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Načítavame font Roboto z URL pre správnu podporu diakritiky
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');
      
      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
      doc.setFontSize(14);
      doc.text(`Meno: ${employeeName}`, 14, 25);
      
      const tableData = [];
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
        const dayName = getDayName(currentYear, currentMonth, i);
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const total = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || '';
        const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '';
        if (start || end || breakTime) {
          tableData.push([`Deň ${i} (${dayName})`, start, end, breakTime, total, gross, net]);
        }
      }
      
      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']],
        body: tableData,
        startY: 30
      });
      
      const totalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(12);
      doc.text(totalSalaryDiv.innerText, 14, totalY);
      doc.save(`brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`);
    }

    function sendPDF() {
      if (!window.jspdf) {
        alert("Knižnica jsPDF nie je načítaná.");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Načítavame font Roboto z URL pre podporu diakritiky
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');
      
      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
      doc.setFontSize(14);
      doc.text(`Meno: ${employeeName}`, 14, 25);
      
      const tableData = [];
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
        const dayName = getDayName(currentYear, currentMonth, i);
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const total = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || '';
        const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '';
        if (start || end || breakTime) {
          tableData.push([`Deň ${i} (${dayName})`, start, end, breakTime, total, gross, net]);
        }
      }
      
      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']],
        body: tableData,
        startY: 30
      });
      
      const totalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(12);
      doc.text(totalSalaryDiv.innerText, 14, totalY);
      
      const pdfBlob = doc.output('blob');
      const pdfFile = new File(
        [pdfBlob],
        `brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`,
        { type: 'application/pdf' }
      );
      
      if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
        navigator.share({
          files: [pdfFile],
          title: `Bruno's Calculator Report`,
          text: `Výkaz za ${getMonthName(currentMonth)} ${currentYear}`
        }).then(() => console.log('PDF odoslané'))
          .catch(error => {
            console.error('Chyba pri odosielaní:', error);
            alert('Chyba pri odosielaní PDF: ' + error.message);
          });
      } else {
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`;
        a.click();
        URL.revokeObjectURL(url);
        alert("Zdieľanie nie je podporované. Súbor stiahnutý.");
      }
    }

    // -----------------------
    // 8) Ostatné nastavenia
    // -----------------------
    function changeDecimalPlaces() {
      decimalPlaces = parseInt(decimalPlacesSelect.value);
      localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) calculateRow(i);
      calculateTotal();
      debouncedSaveToLocalStorage();
    }

    function updateEmployeeName() {
      employeeName = employeeNameInput.value.trim();
      localStorage.setItem('employeeName', JSON.stringify(employeeName));
      debouncedSaveToLocalStorage();
    }

    function updateSettings() {
      hourlyWage = parseFloat(hourlyWageInput.value) || 10;
      taxRate = parseFloat(taxRateInput.value) / 100 || 0.02;
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) calculateRow(i);
      calculateAndUpdateTotals();
    }

    function changeMonth() {
      currentMonth = parseInt(monthSelect.value);
      createTable();
      loadFromFirebase();
    }

    function changeYear() {
      currentYear = parseInt(yearSelect.value);
      createTable();
      loadFromFirebase();
    }

    function getDaysInMonth(month) {
      return new Date(currentYear, month + 1, 0).getDate();
    }

    function updateDataSize() {
      const totalData = Object.values(localStorage).join('');
      const bytes = new Blob([totalData]).size;
      const kilobytes = (bytes / 1024).toFixed(2);
      const percentageUsed = Math.min(((bytes / MAX_DATA_SIZE) * 100).toFixed(2), 100);
      dataSizeText.textContent = `Veľkosť dát: ${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
      dataSizeFill.style.width = `${percentageUsed}%`;
      dataSizeFill.style.backgroundColor = percentageUsed > 80 ? '#f44336' : percentageUsed > 50 ? '#ff9800' : '#4CAF50';
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      document.querySelector('.container').classList.toggle('dark-mode');
      document.querySelectorAll('table, th, td, input').forEach(el => el.classList.toggle('dark-mode'));
      document.querySelectorAll('.btn').forEach(btn => btn.classList.toggle('dark-mode'));
      totalSalaryDiv.classList.toggle('dark-mode');
      const currentDayRow = document.querySelector('.current-day');
      if (currentDayRow) currentDayRow.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
      updateDataSize();
      debouncedSaveToLocalStorage();
    }

    // -----------------------
    // 9) Zálohovanie a obnova
    // -----------------------
    function createBackup() {
      const backup = {
        workDaysData: localStorage.getItem('workDaysData'),
        hourlyWage: localStorage.getItem('hourlyWage'),
        taxRate: localStorage.getItem('taxRate'),
        darkMode: localStorage.getItem('darkMode'),
        decimalPlaces: localStorage.getItem('decimalPlaces'),
        employeeName: localStorage.getItem('employeeName')
      };
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreBackup() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json';
      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            Object.keys(backup).forEach(key => localStorage.setItem(key, backup[key]));
            loadFromLocalStorage();
            alert("Záloha obnovená.");
          } catch (error) {
            console.error("Chyba pri obnove zálohy:", error);
            alert("Chyba pri obnove zálohy.");
          }
        };
        reader.readAsText(file);
      };
      fileInput.click();
    }

    // -----------------------
    // 10) Inicializácia
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      const currentDate = new Date();
      currentMonth = currentDate.getMonth();
      currentYear = currentDate.getFullYear();
      decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
      employeeName = localStorage.getItem('employeeName') || '';
      hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
      taxRate = parseFloat(localStorage.getItem('taxRate')) / 100 || 0.02;
      monthData = JSON.parse(localStorage.getItem('workDaysData')) || {};
      populateYearSelect();
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;
      decimalPlacesSelect.value = decimalPlaces;
      employeeNameInput.value = employeeName;
      hourlyWageInput.value = hourlyWage;
      taxRateInput.value = taxRate * 100;
      createTable();
      calculateTotal();
      updateDataSize();
    });

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }
  </script>
</body>
</html>
