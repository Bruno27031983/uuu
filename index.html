<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- CSS --- (BEZ ZMIEN oproti tvojmu kódu) --- */
    /* Základné štýly - bez zmien */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    /* Špeciálny štýl pre info o používateľovi a odhlásenie */
    #user-session-info {
        flex-basis: 100%; /* Zaberie celú šírku riadku */
        text-align: right; /* Zarovnanie doprava */
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee; /* Jemný oddeľovač */
        display: flex; /* Použijeme flexbox pre zarovnanie */
        justify-content: flex-end; /* Zarovná obsah doprava */
        align-items: center; /* Zarovná vertikálne na stred */
    }
    #user-session-info span {
        margin-right: 15px; /* Odsadenie emailu od tlačidla */
        font-size: 0.9em;
        color: #555;
    }
     /* Zmenšíme tlačidlo odhlásenia, aby sa zmestilo */
    #user-session-info .btn {
        flex-grow: 0; /* Nebude rásť */
        flex-shrink: 0; /* Nebude sa zmenšovať */
        padding: 5px 10px; /* Menšie padding */
        font-size: 14px; /* Menší font */
        margin: 0; /* Odstrániť margin */
    }

    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) {
      width: 25%;
    }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8) {
      width: 8.33%;
    }
    input[type="tel"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    .container.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    table.dark-mode {
      background-color: #555;
      color: #f4f4f4;
    }
    th.dark-mode {
      background-color: #666;
    }
    td.dark-mode { /* Upravené pre dark mode */
        background-color: #555; /* Tmavší podklad pre bunky */
        color: #f4f4f4;
        border: 1px solid #777; /* Tmavší okraj */
    }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode {
      background-color: #666;
      color: white;
      border: 1px solid #888;
    }
    .btn.dark-mode {
       /* Farba textu pre dark mode tlačidlá môže zostať biela, ak pozadie je tmavé */
    }
    .reset-btn.dark-mode {
      background-color: #c62828; /* Trochu tmavšia červená */
    }
     .reset-btn.dark-mode:hover {
      background-color: #b71c1c;
    }
    .export-btn.dark-mode {
      background-color: #2e7d32; /* Trochu tmavšia zelená */
    }
    .export-btn.dark-mode:hover {
      background-color: #1b5e20;
    }
    .backup-btn.dark-mode {
      background-color: #5e35b1; /* Trochu tmavšia fialová */
    }
    .backup-btn.dark-mode:hover {
       background-color: #4527a0;
    }
     .highlight.dark-mode {
        background-color: #f9a825; /* Trochu tmavšia žltá */
        color: #212121; /* Tmavý text na žltom pozadí */
        border: 2px solid #f9a825;
    }
    #totalSalary.dark-mode {
      background-color: #2c3e50;
      color: #e0e0e0; /* Svetlejší text */
    }
    .current-day.dark-mode {
      background-color: #6a1b9a; /* Tmavšia fialová pre aktuálny deň */
      color: #fff;
    }
    .current-day.dark-mode input {
      background-color: #7b1fa2;
      color: #fff;
      border: 1px solid #9c27b0;
    }
     #user-session-info.dark-mode {
         border-top: 1px solid #555; /* Tmavší oddeľovač */
     }
     #user-session-info.dark-mode span {
         color: #ccc; /* Svetlejší text emailu */
     }
     /* Tlačidlo odhlásenia v tmavom režime - špecifické */
     #user-session-info .btn.reset-btn.dark-mode {
         background-color: #c62828;
     }
     #user-session-info .btn.reset-btn.dark-mode:hover {
         background-color: #b71c1c;
     }

    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                     0 0 20px rgba(255, 255, 255, 0.3),
                     0 0 30px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 255, 255, 1),
                     0 0 30px rgba(255, 255, 255, 0.9),
                     0 0 40px rgba(255, 255, 255, 0.7);
      }
    }
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1em;
      }
      .settings {
        flex-direction: column; /* Zmena na stĺpec */
        align-items: stretch; /* Roztiahnuť položky */
      }
      .settings > div:not(#user-session-info) { /* Všetky okrem user info */
        flex: 1 1 auto;
        margin: 10px 0; /* Väčší vertikálny margin */
        width: 100%; /* Plná šírka */
      }
       #user-session-info {
           order: 99; /* Posunieme na koniec v stĺpcovom zobrazení */
           text-align: center; /* Centrovanie na mobiloch */
           justify-content: center; /* Centrovanie obsahu */
           margin-top: 15px;
           padding-top: 15px;
       }
       #user-session-info span {
           margin-right: 10px;
           display: block; /* Email na samostatný riadok */
           margin-bottom: 5px;
           text-align: center;
       }

      table {
        min-width: 800px; /* Nechať min-width pre skrolovanie */
      }
      th, td {
        padding: 6px;
        font-size: 0.8em;
      }
      .btn-container {
        flex-direction: column;
        align-items: stretch;
      }
      .btn {
        flex: 1 1 auto;
        font-size: 14px;
        padding: 10px 16px; /* Upravený padding */
        margin: 5px 0;
      }
      .backup-btn {
        padding: 15px 16px;
      }
      #totalSalary {
        font-size: 16px;
      }
      #dataSizeContainer {
        font-size: 12px;
      }
      .table-container {
        overflow-x: auto;
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.7em;
      }
      .btn {
        font-size: 12px;
        padding: 8px 12px; /* Menší padding */
      }
       #user-session-info .btn {
           font-size: 12px;
           padding: 5px 8px; /* Ešte menšie */
       }
      .backup-btn {
        padding: 15px 12px;
      }
      .settings label {
        font-size: 0.9em;
      }
      input[type="tel"], input[type="number"], input[type="text"] {
        font-size: 12px;
      }
      table {
        min-width: 800px; /* Nechať min-width */
      }
    }
    #saveNotification, #errorNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show {
      display: block;
      opacity: 1;
    }
    #saveNotification {
      background-color: #4CAF50;
      color: white;
    }
    #errorNotification {
      background-color: #f44336;
      color: white;
    }
    #login-form {
      /* Štýly pre login formu zostávajú, ale display bude riadený JS */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px; /* Pridaný padding pre lepší vzhľad */
      border: 1px solid #ccc; /* Okraj pre oddelenie */
      border-radius: 5px;
      background-color: #fff; /* Biele pozadie */
      max-width: 300px; /* Maximálna šírka */
      margin: 20px auto; /* Centrovanie */
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 100%; /* Plná šírka v rámci kontajnera */
      margin: 8px 0; /* Väčší margin */
      padding: 10px; /* Väčší padding */
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #login-form .btn {
      width: auto; /* Automatická šírka */
      padding: 10px 20px; /* Štandardný padding */
      margin: 10px 5px 0 5px; /* Margin hore a po stranách */
      flex-basis: auto; /* Reset flex basis */
    }
     /* Kontajner pre login/register tlačidlá */
     #login-form div {
         display: flex;
         justify-content: center;
         width: 100%;
     }

    /* Skrytie elementov na začiatku */
    .initially-hidden {
        display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI - Pôvodne skryté, aby neblikalo -->
    <div id="auth-container" style="display: none;">
      <div id="login-form" style="display: none;"> <!-- display riadi JS -->
        <input type="email" id="email" placeholder="Email" autocomplete="username">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div> <!-- Kontajner pre tlačidlá -->
            <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
            <button class="btn export-btn" onclick="register()">Registrovať</button>
        </div>
      </div>
      <!-- Pôvodný user-info blok odstránený -->
    </div>

    <!-- Hlavný obsah - Skrytý ak používateľ nie je prihlásený -->
    <div id="main-content" class="initially-hidden">
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2></h2>

        <!-- Nastavenia -->
        <div class="settings">
          <div>
            <label for="employeeNameInput">Meno pracovníka: </label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinová mzda (€): </label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="taxRateInput">Daňové percento (%): </label>
            <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
              <option value="0">Január</option>
              <option value="1">Február</option>
              <option value="2">Marec</option>
              <option value="3">Apríl</option>
              <option value="4">Máj</option>
              <option value="5">Jún</option>
              <option value="6">Júl</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">Október</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok: </label>
            <select id="yearSelect" onchange="changeYear()">
              <!-- Dynamicky generované roky -->
            </select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Počet desatinných miest: </label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>

           <!-- NOVÝ BLOK: Informácie o prihlásenom používateľovi a odhlásenie -->
           <div id="user-session-info" style="display: none;">
               <span id="user-email-display"></span>
               <button id="logout-button" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
           </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Deň</th>
                <th>Príchod</th>
                <th>Odchod</th>
                <th>Prestávka</th>
                <th>Odpracované</th>
                <th>Hrubá Mzda (€)</th>
                <th>Čistá Mzda (€)</th>
                <th>Akcia</th>
              </tr>
            </thead>
            <tbody id="workDays">
              <!-- Riadky budú generované cez JavaScript -->
            </tbody>
          </table>
        </div>

        <div id="totalSalary"></div>

        <div class="btn-container">
          <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
          <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
          <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
          <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
        </div>
    </div> <!-- Koniec #main-content -->

  </div> <!-- Koniec .container -->

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js'; // Pridané setPersistence a browserLocalPersistence
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Stále odporúčam zvážiť bezpečnejšie riešenie
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.appspot.com", // Opravená doména storageBucket
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    // AppCheck inicializácia - Pozor na Recaptcha kľúč, mal by byť chránený
    try {
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
            isTokenAutoRefreshEnabled: true
        });
        console.log("Firebase AppCheck initialized.");
    } catch (e) {
        console.error("Error initializing Firebase AppCheck:", e);
    }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Nastavenie persistencie prihlásenia na 'local'
    // Toto by malo pomôcť udržať používateľa prihláseného aj po zatvorení prehliadača/karty
    setPersistence(auth, browserLocalPersistence)
      .then(() => {
        console.log("Firebase Auth persistence set to 'local'.");
      })
      .catch((error) => {
        console.error("Error setting Firebase Auth persistence:", error);
      });


    // -------------------- GLOBÁLNE PREMENNÉ a DOM Elementy --------------------
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');

    // DOM elementy pre UI
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login-form');
    const mainContent = document.getElementById('main-content');
    const userSessionInfo = document.getElementById('user-session-info');
    const userEmailDisplay = document.getElementById('user-email-display');
    const logoutButton = document.getElementById('logout-button'); // Tlačidlo je už v userSessionInfo

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    // Načítanie nastavení per-user alebo default
    let decimalPlaces = 1;
    let employeeName = '';
    let hourlyWage = 10;
    let taxRate = 0.02;
    let monthData = {}; // Objekt na uchovávanie dát pre načítané mesiace

    // -------------------- FUNKCIE PRE ROKY (select) --------------------
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = ''; // Vyčistiť pre prípadné opätovné volanie
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      // Nastavenie aktuálneho roka sa robí po načítaní používateľských dát alebo v loadData
    }
    populateYearSelect(); // Naplniť roky hneď

    // Predvolené hodnoty sa nastavia v loadUserSettings alebo loadData

    // -------------------- MONITOROVANIE ONLINE/OFFLINE a Notifikácie --------------------
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => {
        console.log('Zariadenie je online');
        showStatusNotification('Spojenie obnovené', 'green');
        if (currentUser) syncWithFirebase(); // Pokus o synchronizáciu pri prechode do online
    });
    window.addEventListener('offline', () => {
        console.log('Zariadenie je offline');
        showStatusNotification('Spojenie prerušené', 'red');
    });
    function showStatusNotification(message, color, duration = 3000) {
        // Jednoduchá implementácia, môžeme vylepšiť, ak máme viac notifikácií naraz
        const existingNotification = document.getElementById('status-notification');
        if (existingNotification) existingNotification.remove();

        const notification = document.createElement('div');
        notification.id = 'status-notification';
        notification.textContent = message;
        Object.assign(notification.style, {
            position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
            padding: '10px 20px', borderRadius: '5px', backgroundColor: color,
            color: 'white', zIndex: '1001', boxShadow: '0 2px 5px rgba(0,0,0,0.2)',
            textAlign: 'center'
        });
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), duration);
    }
    function showErrorNotification(message) {
        const notification = document.getElementById('errorNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') {
        const notification = document.getElementById('saveNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 2000);
    }

    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    window.login = async function() {
        if (!isOnline()) {
            showErrorNotification('Ste offline. Prihlásenie je možné iba online.');
            return;
        }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) {
             showErrorNotification('Zadajte email aj heslo.');
             return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Úspešné prihlásenie spracuje onAuthStateChanged
            console.log("Login successful (handled by onAuthStateChanged).");
        } catch (error) {
            console.error("Login error:", error);
            let message = 'Chyba pri prihlásení.';
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = 'Nesprávny email alebo heslo.';
            } else if (error.code === 'auth/invalid-email') {
                 message = 'Neplatný formát emailu.';
            }
            showErrorNotification(message);
        }
    }

    window.register = async function() {
        if (!isOnline()) {
            showErrorNotification('Ste offline. Registrácia je možná iba online.');
            return;
        }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
         if (!email || !password) {
             showErrorNotification('Zadajte email aj heslo.');
             return;
        }
         if (password.length < 6) {
             showErrorNotification('Heslo musí mať aspoň 6 znakov.');
             return;
         }
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            // Úspešnú registráciu (a prihlásenie) spracuje onAuthStateChanged
            // Vytvoríme počiatočnú štruktúru v DB pre nového používateľa
            await createUserCollection(userCredential.user);
            console.log("Registration successful (handled by onAuthStateChanged).");
        } catch (error) {
            console.error("Registration error:", error);
             let message = 'Chyba pri registrácii.';
             if (error.code === 'auth/email-already-in-use') {
                 message = 'Tento email je už zaregistrovaný.';
             } else if (error.code === 'auth/weak-password') {
                 message = 'Heslo je príliš slabé (min. 6 znakov).';
             } else if (error.code === 'auth/invalid-email') {
                 message = 'Neplatný formát emailu.';
             }
            showErrorNotification(message);
        }
    }

    window.logout = async function() {
        try {
            await signOut(auth);
            // Úspešné odhlásenie spracuje onAuthStateChanged
             console.log("Logout successful (handled by onAuthStateChanged).");
             // Vyčistíme lokálne premenné a UI hneď
             currentUser = null;
             monthData = {};
             updateUI(); // Manuálne zavoláme updateUI na okamžité prekreslenie
        } catch (error) {
            console.error("Logout error:", error);
            showErrorNotification('Chyba pri odhlásení: ' + error.message);
        }
    }

    async function createUserCollection(user) {
        if (user) {
            const userRef = doc(db, 'users', user.uid);
            await setDoc(userRef, {
                email: user.email,
                createdAt: new Date().toISOString() // Ukladáme ako ISO string
            }, { merge: true });
            console.log(`Firestore user document for ${user.uid} created/updated.`);
            // Nepotrebujeme vytvárať podkolekciu alebo 'initial' dokument,
            // vytvorí sa automaticky pri prvom zápise dát mesiaca.
        }
    }

    // --- KĽÚČOVÁ FUNKCIA PRE RIADENIE ZOBRAZENIA ---
    function updateUI() {
        if (currentUser) {
            // Používateľ je prihlásený
            authContainer.style.display = 'none';     // Skryť prihlasovací blok
            mainContent.style.display = 'block';      // Zobraziť hlavný obsah
            mainContent.classList.remove('initially-hidden'); // Odstrániť triedu pre istotu
            userSessionInfo.style.display = 'flex';   // Zobraziť info o userovi a odhlásenie
            userEmailDisplay.textContent = `${currentUser.email}`; // Zobraziť email
            logoutButton.style.display = 'inline-block'; // Zobraziť tlačidlo

            // Aplikovať tmavý režim, ak je zapnutý a elementy už existujú
            applyDarkModeStyles(localStorage.getItem('darkMode') === 'enabled');

            console.log('UI updated for logged-in user.');
        } else {
            // Používateľ NIE JE prihlásený
            authContainer.style.display = 'block';    // Zobraziť prihlasovací blok
            loginForm.style.display = 'flex';       // Zobraziť formu v ňom
            mainContent.style.display = 'none';       // Skryť hlavný obsah
            userSessionInfo.style.display = 'none';   // Skryť info o userovi
            logoutButton.style.display = 'none';      // Skryť tlačidlo
            userEmailDisplay.textContent = '';

            console.log('UI updated for logged-out user.');
            if (!isOnline()) {
                // Zobraziť notifikáciu len ak sme offline a zobrazujeme login formu
                 showStatusNotification('Ste offline. Funkcie môžu byť obmedzené.', 'orange');
            }
        }
    }


    // -------------------- Ukladanie, Načítanie, Synchronizácia --------------------
    // Debounce funkcia (bez zmien)
    function debounce(func, wait) { /* ... kód debounce ... */
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    const debouncedSaveData = debounce(saveData, 1500); // Ukladanie s debounce

    // Zjednotená funkcia saveData (bez podstatných zmien, len drobné logovanie)
    async function saveData() { /* ... kód saveData z predchádzajúcej odpovede ... */
         if (!currentUser) {
             console.warn("Pokus o uloženie dát bez prihláseného používateľa.");
             return;
         }

        const dataToSave = {
            data: [],
            // Ukladáme aktuálne hodnoty nastavení do dát mesiaca
            hourlyWage: parseFloat(hourlyWageInput.value),
            taxRate: parseFloat(taxRateInput.value) / 100,
            employeeName: employeeNameInput.value,
            decimalPlaces: parseInt(decimalPlacesSelect.value),
            lastUpdated: new Date().toISOString() // Vždy aktuálny timestamp
        };

        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

            if (startElement && endElement && breakElement && grossElement && netElement) {
                dataToSave.data.push({
                    start: startElement.value || '',
                    end: endElement.value || '',
                    breakTime: breakElement.value || '',
                    gross: grossElement.value || '0.00', // Ukladáme ako string
                    net: netElement.value || '0.00'   // Ukladáme ako string
                });
            } else {
                 // Ak element neexistuje (čo by sa nemalo stať po `createTable`), pridáme prázdny záznam
                 dataToSave.data.push({ start: '', end: '', breakTime: '', gross: '0.00', net: '0.00' });
            }
        }

        const storageKey = `workData-${currentUser.uid}-${currentYear}-${currentMonth}`;
        const pendingKey = `pendingSync-${currentUser.uid}-${currentYear}-${currentMonth}`;

        try {
            const dataString = JSON.stringify(dataToSave);
            localStorage.setItem(storageKey, dataString);
            console.log(`Data saved to localStorage: ${storageKey}`);

            if (isOnline()) {
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, dataToSave);
                console.log('Data saved to Firestore');
                localStorage.removeItem(pendingKey); // Úspešne uložené online, odstrániť pending flag
                // showSaveNotification('Dáta uložené online'); // Môže byť príliš časté
            } else {
                localStorage.setItem(pendingKey, dataString);
                console.log('Offline: Data marked for sync');
                showSaveNotification('Dáta uložené lokálne (offline)');
            }
             // Uložíme aj globálne nastavenia do localStorage (pre rýchlejšie načítanie pri ďalšom štarte)
             saveUserSettings();

        } catch (error) {
            console.error('Chyba pri ukladaní dát:', error);
            showErrorNotification('Chyba pri ukladaní dát: ' + error.message);
             // V prípade chyby označíme ako pending, aby sa skúsilo znova synchronizovať
             localStorage.setItem(pendingKey, JSON.stringify(dataToSave));
        }
    }

    // Funkcia syncWithFirebase (bez zmien)
    async function syncWithFirebase() { /* ... kód syncWithFirebase z predchádzajúcej odpovede ... */
        if (!currentUser || !isOnline()) return;

        console.log('Checking for pending data to sync...');
        let syncedCount = 0;
        const keysToRemove = []; // Zbierame kľúče na odstránenie

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(`pendingSync-${currentUser.uid}-`)) {
                const pendingDataString = localStorage.getItem(key);
                if (pendingDataString) {
                    try {
                        const dataToSync = JSON.parse(pendingDataString);
                        const keyParts = key.split('-');
                        const year = keyParts[keyParts.length - 2];
                        const month = keyParts[keyParts.length - 1];
                        const firestoreDocId = `${year}-${month}`;

                        // Overíme, či máme platné údaje
                         if (!isNaN(year) && !isNaN(month) && dataToSync && dataToSync.data) {
                            const userRef = doc(db, 'users', currentUser.uid);
                            await setDoc(doc(userRef, 'workDays', firestoreDocId), dataToSync);
                            console.log(`Data for ${firestoreDocId} synced with Firestore.`);
                            keysToRemove.push(key); // Pridať kľúč na odstránenie po úspechu
                            // Aktualizujeme aj hlavný storage kľúč
                            const storageKey = `workData-${currentUser.uid}-${year}-${month}`;
                            localStorage.setItem(storageKey, pendingDataString);
                            syncedCount++;
                         } else {
                             console.warn(`Invalid data or key format found for pending sync: ${key}. Removing.`);
                             keysToRemove.push(key); // Odstrániť neplatný kľúč
                         }

                    } catch (error) {
                        console.error(`Error syncing data for key ${key}:`, error);
                        // Necháme kľúč v localStorage pre ďalší pokus, ak nejde o chybu parsovania
                         if (error instanceof SyntaxError) {
                             console.error(`Corrupted data in ${key}. Removing.`);
                             keysToRemove.push(key); // Odstrániť poškodené dáta
                         } else {
                            showErrorNotification(`Chyba pri synchronizácii (${key.split('-').slice(-2).join('-')}): ${error.message}`);
                         }
                    }
                } else {
                    // Ak je hodnota null/undefined, kľúč odstránime
                    keysToRemove.push(key);
                }
            }
        }

        // Odstránime spracované kľúče
        keysToRemove.forEach(key => localStorage.removeItem(key));

        if (syncedCount > 0) {
            showSaveNotification(`${syncedCount} mesiac(ov) dát úspešne synchronizovaných.`);
        } else {
            console.log('No pending data found or synced.');
        }
    }


    // Funkcia loadData (bez podstatných zmien, len prispôsobenie logovaniu a UI)
    async function loadData() { /* ... kód loadData z predchádzajúcej odpovede ... */
        if (!currentUser) {
            console.log('User not logged in, cannot load data.');
            updateUI(); // Zobrazí login formu
            return;
        }

        console.log(`Loading data for ${currentUser.uid} - ${currentYear}-${currentMonth}`);
        const storageKey = `workData-${currentUser.uid}-${currentYear}-${currentMonth}`;
        const pendingKey = `pendingSync-${currentUser.uid}-${currentYear}-${currentMonth}`;
        const firestoreDocId = `${currentYear}-${currentMonth}`;

        let dataToLoad = null;
        let loadedFrom = 'N/A';
        let firestoreTimestamp = null;
        let localTimestamp = null;

        // 1. Skontrolujeme pending (najaktuálnejšie lokálne)
        const pendingDataString = localStorage.getItem(pendingKey);
        if (pendingDataString) {
            try {
                dataToLoad = JSON.parse(pendingDataString);
                localTimestamp = dataToLoad.lastUpdated;
                loadedFrom = 'pending localStorage';
            } catch (e) { console.error("Error parsing pending data", e); localStorage.removeItem(pendingKey); }
        }

        // 2. Ak nie pending, skontrolujeme hlavný localStorage
        if (!dataToLoad) {
            const localDataString = localStorage.getItem(storageKey);
            if (localDataString) {
                try {
                    dataToLoad = JSON.parse(localDataString);
                    localTimestamp = dataToLoad.lastUpdated;
                    loadedFrom = 'localStorage';
                } catch (e) { console.error("Error parsing local data", e); localStorage.removeItem(storageKey); }
            }
        }

        // 3. Skontrolujeme Firestore, ak sme online
        if (isOnline()) {
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', firestoreDocId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const firestoreData = docSnap.data();
                    firestoreTimestamp = firestoreData.lastUpdated;

                    // Porovnanie timestampov
                    if (!localTimestamp || (firestoreTimestamp && firestoreTimestamp > localTimestamp)) {
                        dataToLoad = firestoreData;
                        loadedFrom = `Firestore (newer: ${firestoreTimestamp} > ${localTimestamp || 'null'})`;
                        localStorage.setItem(storageKey, JSON.stringify(firestoreData)); // Aktualizovať local storage
                        localStorage.removeItem(pendingKey); // Odstrániť pending flag, ak existoval
                    } else {
                         loadedFrom += ` (local newer/equal: ${localTimestamp} >= ${firestoreTimestamp || 'null'})`;
                    }
                } else {
                     loadedFrom += ' (no Firestore doc)';
                     // Ak nemáme ani lokálne dáta, nastavíme prázdne pole
                     if (!dataToLoad) dataToLoad = { data: [], lastUpdated: null }; // Inicializujeme
                }
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                showErrorNotification('Chyba pri online načítaní dát: ' + error.message);
                loadedFrom += ' (Firestore error)';
            }
        } else {
             loadedFrom += ' (offline)';
        }

        console.log(`Data loaded from: ${loadedFrom}`);

        // Aplikujeme dáta (alebo default, ak sa nič nenašlo)
        if (dataToLoad && dataToLoad.data) {
            // Nastavenia berieme primárne z načítaných dát pre daný mesiac
            hourlyWageInput.value = dataToLoad.hourlyWage !== undefined ? dataToLoad.hourlyWage : (loadUserSetting('hourlyWage', 10));
            taxRateInput.value = dataToLoad.taxRate !== undefined ? (dataToLoad.taxRate * 100).toFixed(1) : (loadUserSetting('taxRate', 0.02) * 100).toFixed(1);
            employeeNameInput.value = dataToLoad.employeeName !== undefined ? dataToLoad.employeeName : loadUserSetting('employeeName', '');
            decimalPlacesSelect.value = dataToLoad.decimalPlaces !== undefined ? dataToLoad.decimalPlaces : loadUserSetting('decimalPlaces', 1);

            // Aktualizujeme globálne premenné
            updateGlobalSettingsFromInputs();

            monthData[`${currentYear}-${currentMonth}`] = dataToLoad.data; // Uložíme dáta mesiaca
        } else {
            // Žiadne dáta pre tento mesiac - použijeme uložené globálne nastavenia alebo default
            loadUserSettings(); // Načíta globálne nastavenia do inputov
            updateGlobalSettingsFromInputs(); // Aktualizuje globálne premenné
            monthData[`${currentYear}-${currentMonth}`] = []; // Prázdne dáta pre mesiac
            console.log("No specific data found for this month, using user/default settings.");
        }

         // Nastavíme selecty pre mesiac a rok
         monthSelect.value = currentMonth;
         yearSelect.value = currentYear;


        // Vytvoríme tabuľku s načítanými alebo prázdnymi dátami
        createTable();
        // UI sa aktualizuje (zobrazí/skryje obsah) na konci onAuthStateChanged
    }

    // -------------------- Tvorba tabuľky a Výpočty --------------------
    // Funkcia getDayName (bez zmien)
    function getDayName(year, month, day) { /* ... kód getDayName ... */
        const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
    }

    // Funkcia createTable (mierne upravená pre načítané dáta)
    function createTable() { /* ... kód createTable z predchádzajúcej odpovede ... */
         console.log(`Creating table for ${currentYear}-${currentMonth}`);
        workDays.innerHTML = ''; // Vyčistiť predchádzajúci obsah
        if (!currentUser) {
            console.warn("Cannot create table, user not logged in.");
            return;
        }

        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();
        const daysInMonth = getDaysInMonth(currentMonth);

        const dataForMonth = monthData[`${currentYear}-${currentMonth}`] || [];

        console.log(`Days in month: ${daysInMonth}, Data records: ${dataForMonth.length}`);


        for (let i = 1; i <= daysInMonth; i++) {
             // Získame dáta pre deň (index i-1). Ak chýbajú, použijeme default.
            const dayData = dataForMonth[i - 1] || { start: '', end: '', breakTime: '', gross: '0.00', net: '0.00' };
            const row = document.createElement('tr');
            row.dataset.dayIndex = i; // Pridáme data atribút pre ľahší prístup

            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                row.classList.add('current-day');
            }

            const dayName = getDayName(currentYear, currentMonth, i);
            row.innerHTML = `
                <td>Deň ${i} (${dayName})</td>
                <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" value="${dayData.start || ''}" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
                <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" value="${dayData.end || ''}" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
                <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka (h)" value="${dayData.breakTime || ''}" oninput="handleBreakInput(${i})"></td>
                <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (0.0 h)</td>
                <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" value="${dayData.gross || '0.00'}" readonly></td>
                <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" value="${dayData.net || '0.00'}" readonly></td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
            `;
            workDays.appendChild(row);
            calculateRow(i); // Prepočítame hneď po vytvorení
        }
        console.log('Table created.');
        calculateTotal(); // Celkové súčty po vytvorení tabuľky
         // Aplikujeme tmavý režim na novú tabuľku, ak je aktívny
        applyDarkModeStyles(localStorage.getItem('darkMode') === 'enabled');
    }


    // Funkcie handleInput, handleBreakInput (bez podstatných zmien)
    window.handleInput = function(input, nextId) { /* ... kód handleInput z predchádzajúcej odpovede ... */
         formatAndMoveNext(input, nextId);
         debouncedSaveData(); // Uložíme dáta s oneskorením
    }
    window.handleBreakInput = function(day) { /* ... kód handleBreakInput z predchádzajúcej odpovede ... */
        const inputElement = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        calculateRow(day);
        calculateTotal(); // Prepočítame hneď

        // Posun na ďalšie pole (začiatok ďalšieho dňa) len ak je hodnota zadaná
        const nextDay = day + 1;
        if (inputElement.value && nextDay <= getDaysInMonth(currentMonth)) {
            moveNext(inputElement, `start-${currentYear}-${currentMonth}-${nextDay}`);
        }
        debouncedSaveData(); // Uložíme dáta s oneskorením
    }


    // Funkcia formatAndMoveNext (bez podstatných zmien)
    function formatAndMoveNext(input, nextId) { /* ... kód formatAndMoveNext ... */
        let value = input.value.replace(/[^\d:]/g, '');

        if (value.length === 2 && !input.value.includes(':')) {
             // Ak užívateľ píše tretie číslo, pridaj dvôbodku
             if (event && event.inputType === 'insertText' && /\d/.test(event.data)) {
                  value += ':';
             }
        } else if (value.length >= 3 && value.charAt(2) !== ':') {
             value = value.slice(0, 2) + ':' + value.slice(2);
        }
        if (value.length > 5) {
            value = value.slice(0, 5);
        }
        input.value = value;

        const day = parseInt(input.id.split('-')[3]);
        calculateRow(day); // Prepočítať vždy pri zmene
        calculateTotal(); // Aj celok

        if (value.length === 5) {
            const [hours, minutes] = value.split(':').map(Number);
            if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
                moveNext(input, nextId);
            } else {
                // Nepresúvaj focus, ak čas nie je platný, nech ho opraví
                showErrorNotification("Neplatný čas (HH:MM).");
            }
        }
    }

    // Funkcia moveNext (bez zmien)
    function moveNext(currentElement, nextId) { /* ... kód moveNext ... */
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
            nextElement.focus();
            nextElement.select();
        }
    }

    // Funkcia calculateRow (bez podstatných zmien)
    function calculateRow(day) { /* ... kód calculateRow z predchádzajúcej odpovede ... */
        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return;

        const startTime = startInput.value;
        const endTime = endInput.value;
        const breakTimeHours = parseFloat(breakInput.value) || 0;

        let diffMinutes = 0;
        let decimalHours = 0;
        let hours = 0;
        let minutes = 0;

        if (startTime.length === 5 && endTime.length === 5) {
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);

            if (!isNaN(startH) && !isNaN(startM) && !isNaN(endH) && !isNaN(endM)) {
                const startDate = new Date(0, 0, 0, startH, startM, 0); // Použijeme len časovú časť
                let endDate = new Date(0, 0, 0, endH, endM, 0);

                if (endDate < startDate) { // Prechod cez polnoc
                    endDate.setDate(endDate.getDate() + 1);
                }

                diffMinutes = (endDate - startDate) / 60000;
                diffMinutes -= (breakTimeHours * 60);
                if (diffMinutes < 0) diffMinutes = 0;

                hours = Math.floor(diffMinutes / 60);
                minutes = Math.round(diffMinutes % 60);
                decimalHours = diffMinutes / 60;
            }
        }

        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

        const grossSalary = decimalHours * hourlyWage;
        grossInput.value = isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces) : '0.00';

        const netSalary = grossSalary * (1 - taxRate);
        netInput.value = isFinite(netSalary) ? netSalary.toFixed(decimalPlaces) : '0.00';
    }

    // Funkcia resetRow (bez podstatných zmien)
    window.resetRow = function(day) { /* ... kód resetRow ... */
         document.getElementById(`start-${currentYear}-${currentMonth}-${day}`).value = '';
         document.getElementById(`end-${currentYear}-${currentMonth}-${day}`).value = '';
         document.getElementById(`break-${currentYear}-${currentMonth}-${day}`).value = '';
         calculateRow(day); // Prepočíta na 0
         calculateTotal();
         debouncedSaveData(); // Uloží zmeny
    }

    // Funkcia calculateTotal (bez podstatných zmien)
    function calculateTotal() { /* ... kód calculateTotal z predchádzajúcej odpovede ... */
        if (!currentUser) return;

        let totalMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithEntries = 0;

        const daysInMonth = getDaysInMonth(currentMonth);
        for(let i = 1; i <= daysInMonth; i++) {
             const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`);
             const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
             const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

             if (totalCell && grossInput && netInput) {
                 const totalText = totalCell.textContent;
                 const match = totalText.match(/(\d+)h (\d+)m/); // Získame hodiny a minúty
                  const decimalMatch = totalText.match(/\(([\d.]+) h\)/); // Získame desatinné hodiny

                 if (match) {
                     const hours = parseInt(match[1]) || 0;
                     const minutes = parseInt(match[2]) || 0;
                     const currentMinutes = hours * 60 + minutes;

                      // Počítame deň len ak má odpracované minúty ALEBO zadanú mzdu (manuálne)
                     const grossSalary = parseFloat(grossInput.value) || 0;
                     const netSalary = parseFloat(netInput.value) || 0;

                      if(currentMinutes > 0 || grossSalary > 0) {
                           daysWithEntries++;
                      }

                     totalMinutes += currentMinutes;
                     totalGrossSalary += grossSalary;
                     totalNetSalary += netSalary;
                 }
             }
        }

        const totalHours = Math.floor(totalMinutes / 60);
        const totalMinutesRemainder = Math.round(totalMinutes % 60);
        const totalDecimalHours = (totalMinutes / 60).toFixed(decimalPlaces);

        const averageNetSalary = daysWithEntries > 0 ? (totalNetSalary / daysWithEntries) : 0;
        const averageWorkedMinutes = daysWithEntries > 0 ? (totalMinutes / daysWithEntries) : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = (averageWorkedMinutes / 60).toFixed(decimalPlaces);

        totalSalaryDiv.innerHTML = `
            Počet odpracovaných dní: ${daysWithEntries}<br>
            Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours} h)<br>
            Celková hrubá mzda: ${totalGrossSalary.toFixed(decimalPlaces)} €<br>
            Celková čistá mzda: ${totalNetSalary.toFixed(decimalPlaces)} €<br>
            Priemerná čistá mzda / deň: ${averageNetSalary.toFixed(decimalPlaces)} €<br>
            <strong>Priemerný odpracovaný čas / deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours} h)</strong>
        `;
    }

    // -------------------- EXPORT a ZDIEĽANIE --------------------
    // Funkcia getMonthName (bez zmien)
    function getMonthName(month) { /* ... kód getMonthName ... */
        const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
        return monthNames[month];
    }
    // Funkcia exportToPDF (bez podstatných zmien)
    window.exportToPDF = function() { /* ... kód exportToPDF z predchádzajúcej odpovede ... */
         if (!currentUser) { showErrorNotification("Pre export musíte byť prihlásený."); return; }
         const { jsPDF } = window.jspdf;
         const doc = new jsPDF();
         try { /* ... pridanie fontu Roboto ... */
            if (!doc.getFontList().hasOwnProperty('Roboto')) {
                doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
            }
             doc.setFont('Roboto');
         } catch (e) { console.error("PDF Font Error:", e); /* ... fallback ... */ }

         doc.setFontSize(16);
         doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
         doc.setFontSize(12);
         doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 28);
         doc.text(`Hodinová mzda: ${hourlyWage.toFixed(decimalPlaces)} €`, 14, 34);
         doc.text(`Sadzba dane: ${(taxRate * 100).toFixed(1)} %`, 14, 40);

         const tableData = [];
         let hasData = false;
         const daysInMonth = getDaysInMonth(currentMonth);
         for (let i = 1; i <= daysInMonth; i++) { /* ... naplnenie tableData ... */
            const dayName = getDayName(currentYear, currentMonth, i);
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakH = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const totalText = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || '';
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '';

             if (start || end || breakH || parseFloat(gross) > 0) {
                 hasData = true;
                 const totalDecimalMatch = totalText.match(/\(([\d.]+) h\)/);
                 const totalDecimalHours = totalDecimalMatch ? totalDecimalMatch[1] : '0.0';
                 tableData.push([
                     `Deň ${i} (${dayName})`, start, end,
                     breakH ? `${breakH} h` : '',
                     `${totalDecimalHours} h`,
                     `${gross} €`, `${net} €`
                 ]);
             }
         }
         if (!hasData) { showErrorNotification("Nie sú údaje pre export."); return; }

         doc.autoTable({ /* ... nastavenia autoTable ... */
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpr. (h)', 'Hrubá (€)', 'Čistá (€)']],
            body: tableData,
            startY: 48,
            styles: { font: 'Roboto', fontSize: 9 },
            headStyles: { font: 'Roboto', fillColor: [220, 220, 220], textColor: [0, 0, 0], fontSize: 10 },
            alternateRowStyles: { fillColor: [245, 245, 245] },
            theme: 'grid'
         });

         const totalY = doc.lastAutoTable.finalY + 10;
         doc.setFontSize(10);
         const totalTextForPDF = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
         doc.text(totalTextForPDF, 14, totalY);

         doc.save(`vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`);
    }

    // Funkcia sendPDF (bez podstatných zmien)
    window.sendPDF = async function() { /* ... kód sendPDF z predchádzajúcej odpovede ... */
         if (!currentUser) { showErrorNotification("Pre zdieľanie musíte byť prihlásený."); return; }
         if (!navigator.canShare) { alert('Zdieľanie súborov nie je podporované.'); return; }

         // --- Generovanie PDF (rovnaké ako export) ---
         const { jsPDF } = window.jspdf;
         const doc = new jsPDF();
         try { /* ... font ... */
            if (!doc.getFontList().hasOwnProperty('Roboto')) {
                doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
            }
             doc.setFont('Roboto');
         } catch(e) { console.error("PDF Font Error:", e); }
         /* ... hlavička PDF ... */
         doc.setFontSize(16); doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
         doc.setFontSize(12); doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 28);
         doc.text(`Hodinová mzda: ${hourlyWage.toFixed(decimalPlaces)} €`, 14, 34);
         doc.text(`Sadzba dane: ${(taxRate * 100).toFixed(1)} %`, 14, 40);
         /* ... tabuľka ... */
         const tableData = []; let hasData = false;
         const daysInMonth = getDaysInMonth(currentMonth);
         for (let i = 1; i <= daysInMonth; i++) { /* ... naplnenie tableData ... */
            const dayName = getDayName(currentYear, currentMonth, i);
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakH = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const totalText = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || '';
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '';
             if (start || end || breakH || parseFloat(gross) > 0) {
                 hasData = true;
                 const totalDecimalMatch = totalText.match(/\(([\d.]+) h\)/);
                 const totalDecimalHours = totalDecimalMatch ? totalDecimalMatch[1] : '0.0';
                 tableData.push([
                     `Deň ${i} (${dayName})`, start, end,
                     breakH ? `${breakH} h` : '',
                     `${totalDecimalHours} h`,
                     `${gross} €`, `${net} €`
                 ]);
             }
         }
         if (!hasData) { showErrorNotification("Nie sú údaje pre zdieľanie."); return; }
         doc.autoTable({ /* ... nastavenia autoTable ... */
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpr. (h)', 'Hrubá (€)', 'Čistá (€)']],
            body: tableData, startY: 48, styles: { font: 'Roboto', fontSize: 9 },
            headStyles: { font: 'Roboto', fillColor: [220, 220, 220], textColor: [0, 0, 0], fontSize: 10 },
            alternateRowStyles: { fillColor: [245, 245, 245] }, theme: 'grid'
         });
         /* ... súhrn ... */
         const totalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(10);
         const totalTextForPDF = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
         doc.text(totalTextForPDF, 14, totalY);
         // --- Koniec generovania PDF ---

         try {
             const pdfBlob = doc.output('blob');
             const pdfFileName = `vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
             const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

             if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                 await navigator.share({
                     files: [pdfFile],
                     title: `Výkaz práce ${getMonthName(currentMonth)} ${currentYear}`,
                     text: `Výkaz práce pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}`
                 });
                 console.log('PDF shared successfully.');
             } else {
                 alert('Zdieľanie PDF nie je možné. Použite export.');
             }
         } catch (error) { /* ... ošetrenie chyby zdieľania ... */
             if (error.name === 'AbortError') { console.log('Sharing cancelled.'); }
             else { console.error('Error sharing PDF:', error); alert('Chyba pri zdieľaní: ' + error.message); }
         }
    }

    // -------------------- OSTATNÉ NASTAVENIA a Pomocné funkcie --------------------
    // Ukladanie a načítanie globálnych nastavení používateľa
    function saveUserSettings() {
        if (!currentUser) return;
        localStorage.setItem(`settings-${currentUser.uid}-hourlyWage`, hourlyWageInput.value);
        localStorage.setItem(`settings-${currentUser.uid}-taxRate`, (parseFloat(taxRateInput.value) / 100).toString()); // Uložiť ako desatinné číslo
        localStorage.setItem(`settings-${currentUser.uid}-employeeName`, employeeNameInput.value);
        localStorage.setItem(`settings-${currentUser.uid}-decimalPlaces`, decimalPlacesSelect.value);
        console.log("User settings saved to localStorage.");
    }

    function loadUserSetting(key, defaultValue) {
        if (!currentUser) return defaultValue;
        const value = localStorage.getItem(`settings-${currentUser.uid}-${key}`);
         // Špeciálne pre čísla, aby sme vrátili číslo, nie string
        if (key === 'hourlyWage' || key === 'taxRate' || key === 'decimalPlaces') {
             return value !== null ? parseFloat(value) : defaultValue;
        }
        return value !== null ? value : defaultValue;
    }

     function loadUserSettings() {
        if (!currentUser) return;
        hourlyWageInput.value = loadUserSetting('hourlyWage', 10);
        // Načítame desatinné číslo a konvertujeme na percentá pre input
        taxRateInput.value = (loadUserSetting('taxRate', 0.02) * 100).toFixed(1);
        employeeNameInput.value = loadUserSetting('employeeName', '');
        decimalPlacesSelect.value = loadUserSetting('decimalPlaces', 1);
        console.log("User settings loaded from localStorage.");
        // Aktualizujeme globálne premenné
        updateGlobalSettingsFromInputs();
    }

    // Aktualizuje globálne JS premenné z hodnôt v inputoch
    function updateGlobalSettingsFromInputs() {
        hourlyWage = parseFloat(hourlyWageInput.value) || 10;
        taxRate = (parseFloat(taxRateInput.value) || 2) / 100;
        employeeName = employeeNameInput.value || '';
        decimalPlaces = parseInt(decimalPlacesSelect.value) || 1;
    }

    // Handlery pre zmenu nastavení
    window.changeDecimalPlaces = function() {
        updateGlobalSettingsFromInputs(); // Načítať aktuálnu hodnotu
        saveUserSettings(); // Uložiť globálne nastavenie
        // Prepočítať zobrazenie
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) calculateRow(i);
        calculateTotal();
        debouncedSaveData(); // Uložiť zmeny aj do dát mesiaca
    }
    window.updateEmployeeName = function() {
        updateGlobalSettingsFromInputs();
        saveUserSettings();
        debouncedSaveData();
    }
    window.updateSettings = function() { // Pre hodinovú mzdu a daň
        // Validácia
        const newWage = parseFloat(hourlyWageInput.value);
        const newTaxPercent = parseFloat(taxRateInput.value);
        if (isNaN(newWage) || newWage < 0) { showErrorNotification("Neplatná mzda."); hourlyWageInput.value = hourlyWage; return; }
        if (isNaN(newTaxPercent) || newTaxPercent < 0) { showErrorNotification("Neplatná daň."); taxRateInput.value = (taxRate*100).toFixed(1); return; }

        updateGlobalSettingsFromInputs();
        saveUserSettings();
        // Prepočítať tabuľku a súčty
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) calculateRow(i);
        calculateTotal();
        debouncedSaveData();
    }

    // Zmena mesiaca/roka
    window.changeMonth = function() {
        const newMonth = parseInt(monthSelect.value);
        if (newMonth !== currentMonth) {
             currentMonth = newMonth;
             loadData(); // Načíta dáta pre nový mesiac
        }
    }
    window.changeYear = function() {
         const newYear = parseInt(yearSelect.value);
         if (newYear !== currentYear) {
              currentYear = newYear;
              loadData(); // Načíta dáta pre nový rok
         }
    }

    // Funkcia getDaysInMonth (bez zmien)
    function getDaysInMonth(month) { /* ... kód getDaysInMonth ... */
        return new Date(currentYear, month + 1, 0).getDate();
    }

     // Funkcia pre tmavý režim
     window.toggleDarkMode = function() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        applyDarkModeStyles(isDarkMode); // Aplikuje štýly na dynamické elementy
        if (isDarkMode) {
            localStorage.setItem('darkMode', 'enabled');
        } else {
            localStorage.removeItem('darkMode');
        }
        console.log(`Dark mode ${isDarkMode ? 'enabled' : 'disabled'}`);
    }

     // Pomocná funkcia na aplikovanie/odstránenie dark mode tried
     function applyDarkModeStyles(enable) {
         const action = enable ? 'add' : 'remove';
         document.body.classList[action]('dark-mode'); // Telo vždy
         document.querySelector('.container')?.classList[action]('dark-mode');
         document.querySelector('table')?.classList[action]('dark-mode');
         document.querySelectorAll('th').forEach(th => th.classList[action]('dark-mode'));
         document.querySelectorAll('td').forEach(td => td.classList[action]('dark-mode')); // Pridané pre TD
         document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"]').forEach(input => input.classList[action]('dark-mode'));
         document.querySelectorAll('.btn').forEach(btn => btn.classList[action]('dark-mode')); // Všetky tlačidlá
         document.getElementById('totalSalary')?.classList[action]('dark-mode');
         document.getElementById('user-session-info')?.classList[action]('dark-mode');
         // Aktuálny deň
         const currentDayRow = document.querySelector('tr.current-day');
         if (currentDayRow) {
             currentDayRow.classList[action]('dark-mode');
             currentDayRow.querySelectorAll('input').forEach(input => input.classList[action]('dark-mode'));
         }
     }

    // -------------------- ZÁLOHA / OBNOVA (Excel) --------------------
    // Funkcia createBackup (bez podstatných zmien)
    window.createBackup = function() { /* ... kód createBackup z predchádzajúcej odpovede ... */
        if (!currentUser) { showErrorNotification("Pre zálohu musíte byť prihlásený."); return; }
        const storageKey = `workData-${currentUser.uid}-${currentYear}-${currentMonth}`;
        const dataString = localStorage.getItem(storageKey);
        if (!dataString) { showErrorNotification('Lokálne dáta pre zálohu neboli nájdené.'); return; }

        try {
            const dataObj = JSON.parse(dataString);
            const ws_data = [ /* ... hlavička a nastavenia pre Excel ... */
                 ["Typ zálohy", "Bruno's Calculator Monthly Data"], ["Verzia formátu", "1.1"],
                 ["Používateľ UID (info)", currentUser.uid], ["Mesiac (0-11)", currentMonth], ["Rok", currentYear], [],
                 ["Nastavenie", "Hodnota"],
                 ["Hodinová mzda", dataObj.hourlyWage], ["Daňové percento", dataObj.taxRate * 100],
                 ["Meno pracovníka", dataObj.employeeName], ["Počet desatinných miest", dataObj.decimalPlaces],
                 ["Posledná aktualizácia (ISO)", dataObj.lastUpdated], [],
                 ["Deň index (0..)", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"]
            ];
            dataObj.data.forEach((row, index) => { /* ... pridanie riadkov dát ... */
                ws_data.push([ index, row.start || "", row.end || "", row.breakTime || "", row.gross || "0.00", row.net || "0.00" ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:25}, {wch:25} ]; // Šírka stĺpcov
            XLSX.utils.book_append_sheet(wb, ws, `Data-${getMonthName(currentMonth)}-${currentYear}`);
            XLSX.writeFile(wb, `brunos_calculator_backup_${currentYear}_${String(currentMonth+1).padStart(2,'0')}.xlsx`);
            showSaveNotification('Záloha vytvorená.');
        } catch (error) { console.error("Backup Error:", error); showErrorNotification('Chyba pri zálohe: ' + error.message); }
    };

    // Funkcia restoreBackup (bez podstatných zmien)
    window.restoreBackup = function() { /* ... kód restoreBackup z predchádzajúcej odpovede ... */
        if (!currentUser) { showErrorNotification("Pre obnovu musíte byť prihlásený."); return; }
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.xlsx';
        input.onchange = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: true });

                    // --- Parsovanie a validácia ---
                    let backupMonth = -1, backupYear = -1, settings = {}, dataStartIndex = -1;
                    let settingsHeaderFound = false, dataHeaderFound = false;
                    for (let i = 0; i < rows.length; i++) { /* ... parsovanie hlavičky, nastavení, hľadanie dát ... */
                        const row = rows[i]; if (!row || row.length === 0) continue;
                        const key = row[0]?.toString().trim(); const value = row[1];
                        if (key === "Mesiac (0-11)") backupMonth = parseInt(value);
                        if (key === "Rok") backupYear = parseInt(value);
                        if (key === "Nastavenie" && value === "Hodnota") { settingsHeaderFound = true; continue; }
                        if (settingsHeaderFound && key) {
                             if (key === "Hodinová mzda") settings.hourlyWage = parseFloat(value);
                             else if (key === "Daňové percento") settings.taxRate = parseFloat(value) / 100;
                             else if (key === "Meno pracovníka") settings.employeeName = value?.toString() || "";
                             else if (key === "Počet desatinných miest") settings.decimalPlaces = parseInt(value);
                             else if (key === "Posledná aktualizácia (ISO)") settings.lastUpdated = value?.toString() || new Date().toISOString();
                             else if (!key) settingsHeaderFound = false; // Koniec bloku nastavení
                        }
                        if (key === "Deň index (0..)") { dataHeaderFound = true; dataStartIndex = i + 1; break; }
                    }
                    // --- Validácia ---
                    if (isNaN(backupMonth) || backupMonth < 0 || backupMonth > 11 || isNaN(backupYear) || backupYear < 2000) throw new Error("Neplatné info o mesiaci/roku.");
                    if (!dataHeaderFound || dataStartIndex === -1) throw new Error("Nenájdená hlavička dát.");
                    // Doplnenie chýbajúcich nastavení
                    settings.hourlyWage = settings.hourlyWage || loadUserSetting('hourlyWage', 10);
                    settings.taxRate = settings.taxRate || loadUserSetting('taxRate', 0.02);
                    settings.employeeName = settings.employeeName ?? loadUserSetting('employeeName', ''); // Použiť ?? pre undefined/null
                    settings.decimalPlaces = settings.decimalPlaces || loadUserSetting('decimalPlaces', 1);
                    settings.lastUpdated = settings.lastUpdated || new Date().toISOString();

                    // --- Potvrdenie, ak mesiac/rok nesedí ---
                    if (backupMonth !== currentMonth || backupYear !== currentYear) {
                         if (!confirm(`Záloha je pre ${getMonthName(backupMonth)} ${backupYear}. Chcete obnoviť tieto dáta (prepíšu aktuálne zobrazený mesiac)?`)) return;
                         currentMonth = backupMonth; currentYear = backupYear;
                    }

                    // --- Parsovanie dát dní ---
                    let dataArray = [];
                    const expectedDays = getDaysInMonth(currentMonth);
                    for (let i = dataStartIndex; i < rows.length; i++) { /* ... parsovanie riadkov dát ... */
                        const row = rows[i]; if (!row || row.length < 6 || row[0] === null || row[0] === undefined) break;
                        const dayIndex = parseInt(row[0]); if (isNaN(dayIndex) || dayIndex < 0) continue;
                        while(dataArray.length <= dayIndex) dataArray.push({ start:'', end:'', breakTime:'', gross:'0.00', net:'0.00' });
                        dataArray[dayIndex] = { start: row[1]?.toString() || "", end: row[2]?.toString() || "", breakTime: row[3]?.toString() || "", gross: row[4]?.toString() || "0.00", net: row[5]?.toString() || "0.00" };
                    }
                    while (dataArray.length < expectedDays) dataArray.push({ start:'', end:'', breakTime:'', gross:'0.00', net:'0.00' }); // Doplnenie
                    if (dataArray.length > expectedDays) dataArray = dataArray.slice(0, expectedDays); // Orezanie

                    // --- Uloženie a obnova UI ---
                    const restoredData = { data: dataArray, ...settings, lastUpdated: new Date().toISOString() }; // Použiť rozbalenie pre nastavenia
                    const storageKey = `workData-${currentUser.uid}-${currentYear}-${currentMonth}`;
                    const pendingKey = `pendingSync-${currentUser.uid}-${currentYear}-${currentMonth}`;
                    localStorage.setItem(storageKey, JSON.stringify(restoredData));
                    localStorage.setItem(pendingKey, JSON.stringify(restoredData)); // Označiť na synchronizáciu

                    loadData().then(() => { // Načíta práve uložené dáta a prekreslí UI
                       showSaveNotification('Záloha obnovená.');
                       if (isOnline()) syncWithFirebase();
                    });

                } catch (error) { console.error("Restore Error:", error); showErrorNotification('Chyba pri obnove: ' + error.message); }
            };
            reader.onerror = (e) => { console.error("File Read Error:", e); showErrorNotification('Chyba pri čítaní súboru.'); };
            reader.readAsArrayBuffer(file);
        };
        input.click();
    };


    // -------------------- INICIALIZÁCIA APLIKÁCIE --------------------

    // Listener na zmenu stavu prihlásenia - centrálny bod logiky
    onAuthStateChanged(auth, async (user) => {
        console.log("Auth state changed. User:", user ? user.uid : 'null');
        const previousUser = currentUser; // Zapamätáme si predchádzajúci stav
        currentUser = user;

        if (user) {
            // Používateľ je prihlásený (alebo sa práve prihlásil/zaregistroval)
            if (!previousUser) { // Ak predtým nebol prihlásený
                 console.log("User logged in.");
                 loadUserSettings(); // Načítať globálne nastavenia
                 await loadData();   // Načítať dáta pre aktuálny mesiac/rok (a vytvorí tabuľku)
                 updateUI();         // Aktualizovať UI (zobrazí obsah)
                 syncWithFirebase(); // Skúsiť synchronizáciu
            } else {
                 // Používateľ bol už prihlásený (napr. obnovenie stránky)
                 // loadUserSettings a loadData by už mali byť zavolané alebo sa volajú znova pre istotu
                 console.log("User already logged in, ensuring UI is up-to-date.");
                  if (!document.getElementById(`start-${currentYear}-${currentMonth}-1`)) {
                      // Ak tabuľka ešte neexistuje, načítame dáta
                      await loadData();
                  }
                 updateUI(); // Len prekreslíme UI, ak by bolo treba
            }
        } else {
            // Používateľ nie je prihlásený (alebo sa práve odhlásil)
            console.log("User logged out or not logged in.");
            monthData = {}; // Vyčistiť dáta v pamäti
            updateUI(); // Aktualizuje UI (zobrazí login, skryje obsah)
            // Globálne nastavenia sa neresetujú, načítajú sa znova po prihlásení
        }
    });

    // Aplikovanie tmavého režimu hneď na začiatku pre statické časti
    applyDarkModeStyles(localStorage.getItem('darkMode') === 'enabled');

    // Prvotné načítanie - onAuthStateChanged sa spustí automaticky
    console.log("App initialization started, waiting for Auth state...");

  </script>
</body>
</html>
