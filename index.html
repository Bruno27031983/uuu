<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator Pro</title>

  <!-- Meta tagy pre PWA -->
  <meta name="theme-color" content="#8a2be2"/>
  <meta name="description" content="Pokroƒçil√° kalkulaƒçka mzdy s offline podporou a synchroniz√°ciou."/>
  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json" />
  <!-- Ikona -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="images/icon-192x192.png">

  <!-- ====== CDN Kni≈ænice BEZ defer a type="module" ====== -->
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Toastify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js"></script>

  <!-- ====== ≈†t√Ωly CSS ====== -->
  <style>
    :root {
      --primary-color: #8a2be2;
      --primary-dark: #6a1bb2;
      --secondary-color: #4CAF50;
      --secondary-dark: #388e3c;
      --danger-color: #f44336;
      --danger-dark: #d32f2f;
      --warning-color: #ff9800;
      --warning-dark: #e68a00;
      --info-color: #2196F3;
      --info-dark: #1976d2;
      --light-bg: #f4f7f6;
      --light-card-bg: white;
      --light-text: #333;
      --dark-bg: #2c3e50;
      --dark-card-bg: #34495e;
      --dark-text: #ecf0f1;
      --border-color: #ddd;
      --dark-border-color: #555;
      --input-bg: #ffffff;
      --input-border: #ccc;
      --dark-input-bg: #555;
      --dark-input-text: white;
      --dark-input-border: #777;
      --current-day-bg: #e6e6fa;
      --dark-current-day-bg: #5a4a8c;
      --readonly-bg: #eee;
      --dark-readonly-bg: #444;
      --readonly-text: #777;
      --dark-readonly-text: #aaa;
      --weekend-bg: rgba(0, 0, 0, 0.03);
      --dark-weekend-bg: rgba(255, 255, 255, 0.05);
      --invalid-border: var(--danger-color);
      --invalid-bg: #ffebee;
      --dark-invalid-bg: #5a2d33;
      --focus-shadow: rgba(138, 43, 226, 0.2);
      --dark-focus-shadow: rgba(138, 43, 226, 0.3);
      --toastify-color-success: linear-gradient(to right, #00b09b, #96c93d);
      --toastify-color-error: linear-gradient(to right, #ff5f6d, #ffc371);
      --toastify-color-warning: linear-gradient(to right, #f7b733, #fc4a1a);
      --toastify-color-info: linear-gradient(to right, #00d2ff, #3a7bd5);
    }

    *, *::before, *::after {
        box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--light-bg);
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .container {
      max-width: 1300px;
      margin: 15px auto;
      background: var(--light-card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }
    h1 {
      text-align: center;
      font-size: 2.8em;
      font-weight: 700;
      background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #00ff00, #0000ff, var(--primary-color));
      background-size: 200% 200%;
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 6s ease-in-out infinite, textShadowPulse 2.5s ease-in-out infinite;
      margin-bottom: 5px;
      line-height: 1.2;
    }
    h2 {
      text-align: center;
      color: #777;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.3em;
      font-weight: 400;
    }
    .settings {
      margin-bottom: 25px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }
    .settings > div { margin: 0; }
    .settings label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95em;
      color: var(--light-text);
    }
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      margin-bottom: 25px;
      transition: border-color 0.3s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    th {
      background-color: #e9ecef;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      color: var(--light-text);
    }
     td:last-child, th:last-child {
       text-align: center;
       width: 110px;
     }
     td:nth-child(1) { width: 80px; }
     td:nth-child(5) { width: 130px; }

    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 8px 10px;
      box-sizing: border-box;
      background-color: var(--input-bg);
      color: var(--light-text);
      font-size: 14px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--focus-shadow);
    }
    input[readonly] {
      background-color: var(--readonly-bg);
      color: var(--readonly-text);
      cursor: default;
      border-color: #ddd;
    }
    input.invalid {
        border-color: var(--invalid-border) !important;
        background-color: var(--invalid-bg);
    }

    #totalSalary {
      font-size: 1.1em;
      font-weight: 500;
      text-align: left;
      margin-top: 25px;
      padding: 15px 20px;
      background-color: #e9ecef;
      border-radius: 5px;
      line-height: 1.8;
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #totalSalary strong {
      color: var(--primary-dark);
      font-weight: 700;
    }

    /* Aktu√°lny de≈à, v√≠kendy */
    tr.weekend td { background-color: var(--weekend-bg); }
    tr.current-day td {
      background-color: var(--current-day-bg) !important;
      font-weight: bold;
      color: #333;
    }
    tr.current-day input:not([readonly]) {
      background-color: #fffacd;
      font-weight: bold;
    }

    /* Tlaƒçidl√° */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 25px;
    }
    .btn {
      padding: 10px 18px;
      color: white;
      background-color: var(--primary-color);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover {
      opacity: 0.9;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
    }
    .btn-primary { background-color: var(--primary-color); }
    .btn-secondary { background-color: var(--secondary-color); }
    .btn-danger { background-color: var(--danger-color); }
    .btn-warning { background-color: var(--warning-color); color: #333; }
    .btn-info { background-color: var(--info-color); }
    .btn-sm {
      padding: 4px 8px;
      font-size: 14px;
      margin: 0 2px;
      box-shadow: none;
    }

    /* Tmav√Ω re≈æim */
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    body.dark-mode .container {
      background-color: var(--dark-card-bg);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    body.dark-mode h2 { color: #bdc3c7; }
    body.dark-mode label { color: var(--dark-text); }
    body.dark-mode .table-container { border-color: var(--dark-border-color); }
    body.dark-mode th {
      background-color: #4a627a;
      border-color: var(--dark-border-color);
      color: var(--dark-text);
    }
    body.dark-mode td { border-color: var(--dark-border-color); }
    body.dark-mode tr.weekend td { background-color: var(--dark-weekend-bg); }
    body.dark-mode tr.current-day td { background-color: var(--dark-current-day-bg) !important; color: var(--dark-text); }
    body.dark-mode tr.current-day input:not([readonly]) { background-color: #7061a0; }
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode select {
      background-color: var(--dark-input-bg);
      color: var(--dark-input-text);
      border-color: var(--dark-input-border);
    }
    body.dark-mode input[readonly] {
        background-color: var(--dark-readonly-bg);
        color: var(--dark-readonly-text);
        border-color: #555;
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--dark-focus-shadow);
    }
    body.dark-mode input.invalid {
      background-color: var(--dark-invalid-bg);
      border-color: var(--danger-dark) !important;
    }
    body.dark-mode #totalSalary {
      background-color: #2c3e50;
      color: var(--dark-text);
    }
    body.dark-mode #totalSalary strong { color: #a569bd; }
    body.dark-mode .btn-warning { color: white; background-color: var(--warning-dark); }
    body.dark-mode .btn-warning:hover { background-color: #b36b00; }

    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4); }
      50% { text-shadow: 0 0 16px rgba(255, 255, 255, 0.8); }
    }

    /* Responsivita */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 15px; margin: 10px auto; }
      h1 { font-size: 2.2em; }
      h2 { font-size: 1.1em; }
      .settings { grid-template-columns: 1fr; gap: 10px; }
      th, td { padding: 8px; font-size: 0.85em; }
      .btn-container { justify-content: stretch; }
      .btn { font-size: 14px; flex-grow: 1; }
      #totalSalary { font-size: 1em; padding: 12px 15px; }
      table { min-width: 800px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.8em; }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn { font-size: 13px; padding: 8px 12px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 13px; padding: 6px 8px; }
      table { min-width: 700px; }
      td:last-child, th:last-child { width: 90px; }
      .btn-sm { padding: 3px 6px; font-size: 12px; }
    }

    /* Indik√°tor aktivity */
    #activityIndicator {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    #activityIndicator.show {
        display: block;
        opacity: 1;
    }

    /* ≈†√≠pky pre mesiac/rok */
    .month-year-nav {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .nav-arrow {
        background: none;
        border: none;
        font-size: 1.5em;
        line-height: 1;
        cursor: pointer;
        color: var(--primary-color);
        padding: 0 5px;
        transition: color 0.2s ease;
    }
    .nav-arrow:hover { color: var(--primary-dark); }
    .nav-arrow:disabled { color: #ccc; cursor: not-allowed; }

    /* Prihlasovac√≠ formul√°r */
    #auth-container {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 25px;
        transition: border-color 0.3s ease;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 250px;
      max-width: 90%;
      margin: 0;
      text-align: center;
    }
    #login-form .btn-group {
        display: flex;
        gap: 10px;
    }
    #login-form .btn {
      width: auto;
      padding: 8px 15px;
    }
    #user-info {
        font-size: 0.95em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    #user-info span {
        font-weight: 500;
        word-break: break-all;
    }

    /* Toastify */
    .toastify {
        padding: 12px 20px;
        color: #fff;
        display: inline-block;
        box-shadow: 0 3px 6px -1px rgba(0, 0, 0, 0.12), 0 10px 36px -4px rgba(77, 96, 232, 0.3);
        background: -webkit-linear-gradient(315deg, #73a5ff, #5477f5);
        background: linear-gradient(135deg, #73a5ff, #5477f5);
        position: fixed;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        max-width: calc(50% - 20px);
        z-index: 2147483647;
    }
    .toastify.on { opacity: 1; }
  </style>
</head>
<body>
  <!-- Indik√°tor aktivity -->
  <div id="activityIndicator">Spracov√°vam...</div>

  <div class="container">
    <!-- Autentifikaƒçn√© UI -->
    <div id="auth-container">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" autocomplete="email">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div class="btn-group">
            <button class="btn btn-secondary" id="loginBtn">Prihl√°si≈• sa</button>
            <button class="btn btn-info" id="registerBtn">Registrova≈•</button>
        </div>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn btn-danger" id="logoutBtn">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator Pro</h1>
    <h2 id="subTitle">V√Ωkaz pr√°ce a v√Ωpoƒçet mzdy</h2>

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovn√≠ka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.01">
      </div>
      <div>
        <label for="taxRateInput">Da≈à (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <div class="month-year-nav">
            <button class="nav-arrow" id="prevMonthBtn" aria-label="Predch√°dzaj√∫ci mesiac"><</button>
            <select id="monthSelect">
              <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
              <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
              <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
              <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
            <button class="nav-arrow" id="nextMonthBtn" aria-label="Nasleduj√∫ci mesiac">></button>
        </div>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
         <div class="month-year-nav">
            <button class="nav-arrow" id="prevYearBtn" aria-label="Predch√°dzaj√∫ci rok"><</button>
            <select id="yearSelect">
              <!-- Dynamicky generovan√© roky -->
            </select>
            <button class="nav-arrow" id="nextYearBtn" aria-label="Nasleduj√∫ci rok">></button>
        </div>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinn√© miesta:</label>
        <select id="decimalPlacesSelect">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
        </select>
      </div>
      <button id="darkModeToggleBtn" class="btn btn-warning">Tmav√Ω/Svetl√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka (h)</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky bud√∫ generovan√© JavaScriptom -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary">Celkov√© s√∫ƒçty bud√∫ vypoƒç√≠tan√© tu...</div>

    <div class="btn-container">
      <button id="exportPdfBtn" class="btn btn-secondary">Export PDF</button>
      <button id="sharePdfBtn" class="btn btn-secondary">Zdieƒæa≈• PDF</button>
      <button id="backupBtn" class="btn btn-info">Z√°lohova≈• (.xlsx)</button>
      <button id="restoreBtn" class="btn btn-warning">Obnovi≈• zo z√°lohy</button>
      <button id="loadCloudBtn" class="btn btn-primary">Naƒç√≠ta≈• z Cloudu</button>
      <button id="resetMonthBtn" class="btn btn-danger">Resetova≈• Mesiac</button>
    </div>
  </div>

  <!-- ====== Hlavn√Ω skript (u≈æ m√° pr√≠stup k naƒç√≠tan√Ωm kni≈æniciam) ====== -->
  <script>
  (async () => {
    "use strict";

    /* ========================
       1) Konfigur√°cia Firebase
    ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.appspot.com",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const appCheckProvider = new firebase.appCheck.ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v');
    const appCheck = firebase.appCheck();
    appCheck.activate(appCheckProvider, true);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Povolenie offline perzistencie Firestore
    try {
      await db.enablePersistence();
      console.log("Firestore offline perzistencia povolen√°.");
    } catch (err) {
      if (err.code === 'failed-precondition') {
          console.warn("Viac otvoren√Ωch tabov ‚Äì offline perzistencia povolen√° len v prvom.");
      } else if (err.code === 'unimplemented') {
          console.warn("Offline perzistencia nepodporovan√° v tomto prehliadaƒçi.");
      } else {
          console.error("Chyba pri povoƒæovan√≠ offline perzistencie:", err);
      }
    }

    /* ===========================
       2) DOM prvky & Premenn√©
    ============================ */
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const subTitle = document.getElementById('subTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const activityIndicator = document.getElementById('activityIndicator');
    const loginForm = document.getElementById('login-form');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    // Tlaƒçidl√°
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    const darkModeToggleBtn = document.getElementById('darkModeToggleBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const sharePdfBtn = document.getElementById('sharePdfBtn');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const loadCloudBtn = document.getElementById('loadCloudBtn');
    const resetMonthBtn = document.getElementById('resetMonthBtn');

    // Glob√°lny stav
    let currentUser = null;
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let minYear = 2020;
    let maxYear = currentDate.getFullYear() + 2;
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
    let monthDataCache = {};
    let dataChangedSinceLoad = false;
    let copiedRowData = null;

    /* ===========================
       3) Pomocn√© funkcie
    ============================ */
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const context = this;
        const later = () => {
          timeout = null;
          func.apply(context, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showToast(message, type = 'info', duration = 3000) {
      if (typeof Toastify !== 'function') {
        console.log(`Toastify fallback: [${type}] ${message}`);
        return;
      }
      let bg;
      switch (type) {
        case 'success': bg = "var(--toastify-color-success)"; break;
        case 'error': bg = "var(--toastify-color-error)"; break;
        case 'warning': bg = "var(--toastify-color-warning)"; break;
        default: bg = "var(--toastify-color-info)";
      }
      Toastify({
        text: message,
        duration,
        gravity: "bottom",
        position: "right",
        stopOnFocus: true,
        style: { background: bg },
      }).showToast();
    }

    function showActivity(message = "Spracov√°vam...") {
      activityIndicator.textContent = message;
      activityIndicator.classList.add('show');
    }

    function hideActivity() {
      activityIndicator.classList.remove('show');
    }

    function getMonthName(monthIndex) {
      const monthNames = ["Janu√°r","Febru√°r","Marec","Apr√≠l","M√°j","J√∫n","J√∫l","August","September","Okt√≥ber","November","December"];
      return monthNames[monthIndex] || '';
    }

    function getDayName(year, month, day) {
      const daysOfWeek = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];
      const date = new Date(year, month, day);
      return daysOfWeek[date.getDay()];
    }

    function getDaysInMonth(year, month) {
      return new Date(year, month+1, 0).getDate();
    }

    function formatCurrency(value) {
      return (Math.max(0, parseFloat(value) || 0)).toFixed(decimalPlaces);
    }

    function mapFirebaseAuthError(errorCode) {
      switch (errorCode) {
        case 'auth/invalid-email': return 'Neplatn√Ω form√°t emailu.';
        case 'auth/user-not-found': return 'Pou≈æ√≠vateƒæ s t√Ωmto emailom neexistuje.';
        case 'auth/wrong-password': return 'Nespr√°vne heslo.';
        case 'auth/email-already-in-use': return 'Tento email je u≈æ zaregistrovan√Ω.';
        case 'auth/weak-password': return 'Heslo mus√≠ ma≈• aspo≈à 6 znakov.';
        case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
        case 'auth/too-many-requests': return 'Pr√≠li≈° veƒæa ne√∫spe≈°n√Ωch pokusov. Sk√∫ste nesk√¥r.';
        case 'auth/operation-not-allowed': return 'Prihl√°senie emailom/heslom nie je povolen√©.';
        default:
          console.error("Nezn√°ma chyba Firebase Auth:", errorCode);
          return `Nezn√°ma chyba (${errorCode})`;
      }
    }

    /* ===========================
       4) Tmav√Ω re≈æim
    ============================ */
    function applyDarkModePreference() {
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      showToast(`Re≈æim zobrazenia: ${isDarkMode ? 'Tmav√Ω' : 'Svetl√Ω'}`, 'info', 1500);
      updateWeekendStyles();
    }

    function updateWeekendStyles() {
      const weekendColor = document.body.classList.contains('dark-mode')
        ? 'var(--dark-weekend-bg)'
        : 'var(--weekend-bg)';
      workDaysTbody.querySelectorAll('.weekend').forEach(row => {
        row.style.backgroundColor = weekendColor;
      });
    }

    /* ===========================
       5) Navig√°cia Mesiac / Rok
    ============================ */
    function populateYearSelect() {
      yearSelect.innerHTML = '';
      for (let y = minYear; y <= maxYear; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }
      updateNavigationButtons();
    }

    function updateNavigationButtons() {
      prevMonthBtn.disabled = (currentYear === minYear && currentMonth === 0);
      nextMonthBtn.disabled = (currentYear === maxYear && currentMonth === 11);
      prevYearBtn.disabled = (currentYear <= minYear);
      nextYearBtn.disabled = (currentYear >= maxYear);
    }

    function navigateMonth(direction) {
      let newMonth = currentMonth + direction;
      let newYear = currentYear;
      if (newMonth > 11) { newMonth = 0; newYear++; }
      if (newMonth < 0)  { newMonth = 11; newYear--; }
      if (newYear < minYear || newYear > maxYear) {
        showToast("Rok mimo povolen√©ho rozsahu.", "warning");
        return;
      }
      yearSelect.value = newYear;
      currentYear = newYear;
      monthSelect.value = newMonth;
      currentMonth = newMonth;
      updateNavigationButtons();
      initializeAppSettings();
      loadAndDisplayData();
    }

    function navigateYear(direction) {
      let newYear = currentYear + direction;
      if (newYear < minYear || newYear > maxYear) {
        showToast("Rok mimo povolen√©ho rozsahu.", "warning");
        return;
      }
      yearSelect.value = newYear;
      currentYear = newYear;
      updateNavigationButtons();
      initializeAppSettings();
      loadAndDisplayData();
    }

    /* ===========================
       6) Autentifik√°cia
    ============================ */
    loginBtn.addEventListener('click', async () => {
      if (!navigator.onLine) {
        return showToast('Ste offline. Prihl√°senie je mo≈æn√© iba online.', 'error');
      }
      const emailVal = emailInput.value;
      const passwordVal = passwordInput.value;
      if (!emailVal || !passwordVal) {
        return showToast('Pros√≠m, zadajte email aj heslo.', 'warning');
      }
      showActivity('Prihlasujem...');
      try {
        const userCredential = await auth.signInWithEmailAndPassword(emailVal, passwordVal);
        showToast(`Vitajte sp√§≈•, ${userCredential.user.email}!`, 'success');
      } catch (error) {
        console.error('Chyba pri prihl√°sen√≠:', error);
        showToast(`Chyba pri prihl√°sen√≠: ${mapFirebaseAuthError(error.code)}`, 'error', 4000);
      } finally {
        hideActivity();
      }
    });

    registerBtn.addEventListener('click', async () => {
      if (!navigator.onLine) {
        return showToast('Ste offline. Registr√°cia je mo≈æn√° iba online.', 'error');
      }
      const emailVal = emailInput.value;
      const passwordVal = passwordInput.value;
      if (!emailVal || !passwordVal) {
        return showToast('Pros√≠m, zadajte email aj heslo.', 'warning');
      }
      if (passwordVal.length < 6) {
        return showToast('Heslo mus√≠ ma≈• aspo≈à 6 znakov.', 'warning');
      }
      showActivity('Registrujem...');
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(emailVal, passwordVal);
        await createUserDocument(userCredential.user);
        showToast(`Registr√°cia √∫spe≈°n√°! Vitajte, ${userCredential.user.email}!`, 'success');
      } catch (error) {
        console.error('Chyba pri registr√°cii:', error);
        showToast(`Chyba pri registr√°cii: ${mapFirebaseAuthError(error.code)}`, 'error', 4000);
      } finally {
        hideActivity();
      }
    });

    logoutBtn.addEventListener('click', async () => {
      showActivity('Odhlasujem...');
      try {
        await auth.signOut();
        monthDataCache = {};
        showToast('Boli ste √∫spe≈°ne odhl√°sen√Ω.', 'info');
      } catch (error) {
        console.error('Chyba pri odhl√°sen√≠:', error);
        showToast('Chyba pri odhl√°sen√≠.', 'error');
      } finally {
        hideActivity();
      }
    });

    async function createUserDocument(user) {
      if (!user) return;
      const userRef = db.collection('users').doc(user.uid);
      try {
        await userRef.set({
          email: user.email,
          createdAt: new Date()
        }, { merge: true });
        console.log('User dokument vytvoren√Ω/aktualizovan√Ω pre:', user.uid);
      } catch (error) {
        console.error('Chyba pri vytv√°ran√≠ user dokumentu:', error);
      }
    }

    function updateAuthUI() {
      if (currentUser) {
        loginForm.style.display = 'none';
        userInfo.style.display = 'flex';
        userEmail.textContent = currentUser.email;
        loadCloudBtn.disabled = false;
        resetMonthBtn.title = "Resetova≈• mesiac (aj v cloude)";
      } else {
        loginForm.style.display = 'flex';
        userInfo.style.display = 'none';
        userEmail.textContent = '';
        emailInput.value = '';
        passwordInput.value = '';
        loadCloudBtn.disabled = true;
        resetMonthBtn.title = "Resetova≈• mesiac (lok√°lne)";
      }
    }

    /* ===========================
       7) Naƒç√≠tanie & UI
    ============================ */
    function initializeAppSettings() {
      hourlyWageInput.value = hourlyWage.toFixed(2);
      taxRateInput.value = (taxRate * 100).toFixed(1);
      decimalPlacesSelect.value = decimalPlaces;
      employeeNameInput.value = employeeName;
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;
      const monthName = getMonthName(currentMonth);
      subTitle.textContent = `V√Ωkaz pr√°ce za ${monthName} ${currentYear}`;
      mainTitle.textContent = employeeName ? `${employeeName} - Kalkulaƒçka` : "Bruno's Calculator Pro";
      updateNavigationButtons();
    }

    async function loadAndDisplayData() {
      showActivity('Naƒç√≠tavam d√°ta...');
      const dataKey = `${currentYear}-${currentMonth}`;
      let dataToApply = null;
      let loadedFrom = "≈æiadny zdroj";

      if (monthDataCache[dataKey]) {
        dataToApply = monthDataCache[dataKey];
        loadedFrom = "Cache";
      } else {
        if (currentUser) {
          try {
            const userRef = db.collection('users').doc(currentUser.uid)
              .collection('workDays').doc(dataKey);
            const docSnap = await userRef.get();
            if (docSnap.exists) {
              dataToApply = docSnap.data();
              loadedFrom = "Firestore";
              localStorage.setItem(`workData-${dataKey}`, JSON.stringify(dataToApply));
            } else {
              const localData = localStorage.getItem(`workData-${dataKey}`);
              if (localData) {
                try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (po FS)"; } catch (e) { }
            } }
          } catch (error) {
            console.error('Chyba pri naƒç√≠tavan√≠ z Firestore:', error);
            showToast('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu.', 'error');
            const localData = localStorage.getItem(`workData-${dataKey}`);
            if (localData) {
              try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (po chybe FS)"; } catch (e) { }
          } }
        } else {
          const localData = localStorage.getItem(`workData-${dataKey}`);
          if (localData) {
            try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (neprihl√°sen√Ω)"; } catch (e) { }
        } }
      }

      applyDataToUI(dataToApply);
      if (dataToApply && loadedFrom !== "Cache") {
        monthDataCache[dataKey] = dataToApply;
      }
      hideActivity();
    }

    function applyDataToUI(storedData) {
      if (storedData) {
        hourlyWage = storedData.hourlyWage !== undefined ? parseFloat(storedData.hourlyWage) : hourlyWage;
        taxRate = storedData.taxRate !== undefined ? parseFloat(storedData.taxRate) : taxRate;
        employeeName = storedData.employeeName !== undefined ? String(storedData.employeeName) : employeeName;
        decimalPlaces = storedData.decimalPlaces !== undefined ? parseInt(storedData.decimalPlaces) : decimalPlaces;
      }
      initializeAppSettings();
      createTableStructure();
      if (storedData && storedData.data && Array.isArray(storedData.data)) {
        storedData.data.forEach((day, idx) => {
          const i = idx + 1;
          const startEl = document.getElementById(`start-${i}`);
          const endEl = document.getElementById(`end-${i}`);
          const breakEl = document.getElementById(`break-${i}`);
          if (startEl && endEl && breakEl) {
            startEl.value = day.start || '';
            endEl.value = day.end || '';
            breakEl.value = day.breakTime !== undefined ? String(day.breakTime).replace('.', ',') : '';
            validateTimeInput(startEl);
            validateTimeInput(endEl);
          }
        });
      }
      recalculateAllRowsAndTotal();
      dataChangedSinceLoad = false;
    }

    /* ===========================
       8) Ukladanie
    ============================ */
    function collectCurrentData() {
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const dayDataArray = [];
      for (let i = 1; i <= daysInMonth; i++) {
        const startEl = document.getElementById(`start-${i}`);
        const endEl = document.getElementById(`end-${i}`);
        const breakEl = document.getElementById(`break-${i}`);
        const grossEl = document.getElementById(`gross-${i}`);
        const netEl = document.getElementById(`net-${i}`);
        dayDataArray.push({
          start: startEl ? startEl.value : '',
          end: endEl ? endEl.value : '',
          breakTime: breakEl ? String(breakEl.value).replace(',', '.') : '0',
          gross: grossEl ? grossEl.value : '0.00',
          net: netEl ? netEl.value : '0.00'
        });
      }
      return {
        data: dayDataArray,
        hourlyWage,
        taxRate,
        employeeName,
        decimalPlaces,
        lastUpdated: new Date().toISOString()
      };
    }

    function handleDataChange() {
      dataChangedSinceLoad = true;
      saveToLocalStorage();
      scheduleSaveToFirestore();
    }

    const saveToLocalStorage = debounce(() => {
      if (!dataChangedSinceLoad) return;
      const currentData = collectCurrentData();
      const dataKey = `${currentYear}-${currentMonth}`;
      try {
        localStorage.setItem(`workData-${dataKey}`, JSON.stringify(currentData));
        localStorage.setItem('hourlyWage', hourlyWage.toString());
        localStorage.setItem('taxRate', taxRate.toString());
        localStorage.setItem('employeeName', employeeName);
        localStorage.setItem('decimalPlaces', decimalPlaces.toString());
      } catch (e) {
        console.error("Chyba pri ukladan√≠ do localStorage:", e);
        showToast('Chyba pri lok√°lnom ukladan√≠ d√°t!', 'error');
      }
    }, 500);

    const scheduleSaveToFirestore = debounce(async () => {
      if (!currentUser || !dataChangedSinceLoad) return;
      const currentData = collectCurrentData();
      const dataKey = `${currentYear}-${currentMonth}`;
      showActivity('Synchronizujem s cloudom...');
      try {
        const userRef = db.collection('users').doc(currentUser.uid)
          .collection('workDays').doc(dataKey);
        await userRef.set(currentData);
        showToast('D√°ta synchronizovan√© s cloudom.', 'success', 1500);
        dataChangedSinceLoad = false;
        monthDataCache[dataKey] = currentData;
      } catch (error) {
        console.error('Chyba pri ukladan√≠ do Firestore:', error);
        showToast('Chyba pri synchroniz√°cii s cloudom.', 'error');
      } finally {
        setTimeout(hideActivity, 500);
      }
    }, 2000);

    /* ===========================
       9) Naƒç√≠tanie z Cloudu
    ============================ */
    loadCloudBtn.addEventListener('click', async () => {
      if (!currentUser) {
        return showToast('Pre naƒç√≠tanie z cloudu sa mus√≠te prihl√°si≈•.', 'warning');
      }
      if (!navigator.onLine) {
        showToast('Ste offline. Naƒç√≠tavaj√∫ sa posledn√© lok√°lne synchronizovan√© d√°ta.', 'warning');
      }
      if (dataChangedSinceLoad && !confirm('M√°te neulo≈æen√© lok√°lne zmeny. Naozaj chcete naƒç√≠ta≈• d√°ta z Cloudu a prep√≠sa≈• ich?')) {
        return;
      }
      showActivity('Naƒç√≠tavam z cloudu...');
      const dataKey = `${currentYear}-${currentMonth}`;
      try {
        const userRef = db.collection('users').doc(currentUser.uid)
          .collection('workDays').doc(dataKey);
        const docSnap = await userRef.get();
        if (docSnap.exists) {
          const storedData = docSnap.data();
          localStorage.setItem(`workData-${dataKey}`, JSON.stringify(storedData));
          applyDataToUI(storedData);
          monthDataCache[dataKey] = storedData;
          showToast('D√°ta boli √∫spe≈°ne naƒç√≠tan√© z cloudu.', 'success');
        } else {
          showToast('Pre tento mesiac neboli v cloude n√°jden√© ≈æiadne d√°ta.', 'info');
        }
      } catch (error) {
        console.error('Chyba pri naƒç√≠tavan√≠ z Firestore:', error);
        showToast('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu.', 'error');
      } finally {
        hideActivity();
      }
    });

    resetMonthBtn.addEventListener('click', async () => {
      const monthName = getMonthName(currentMonth);
      const msg = currentUser
        ? `Naozaj chcete vymaza≈• v≈°etky z√°znamy pre ${monthName} ${currentYear} (lok√°lne aj v cloude)? T√°to akcia je nevratn√°!`
        : `Naozaj chcete vymaza≈• v≈°etky lok√°lne z√°znamy pre ${monthName} ${currentYear}? T√°to akcia je nevratn√°!`;
      if (!confirm(msg)) return;
      showActivity('Resetujem mesiac...');
      const dataKey = `${currentYear}-${currentMonth}`;
      applyDataToUI(null);
      delete monthDataCache[dataKey];
      localStorage.removeItem(`workData-${dataKey}`);
      if (currentUser) {
        try {
          const userRef = db.collection('users').doc(currentUser.uid)
            .collection('workDays').doc(dataKey);
          await userRef.delete();
          showToast('D√°ta pre aktu√°lny mesiac boli √∫spe≈°ne vymazan√©.', 'success');
        } catch (error) {
          console.error('Chyba pri mazan√≠ d√°t z Firestore:', error);
          showToast('Chyba pri mazan√≠ d√°t z cloudu.', 'error');
        }
      } else {
        showToast('Lok√°lne d√°ta pre aktu√°lny mesiac boli vymazan√©.', 'success');
      }
      dataChangedSinceLoad = false;
      hideActivity();
    });

    /* ===========================
       10) Tvorba tabuƒæky + Eventy
    ============================ */
    function createTableStructure() {
      workDaysTbody.innerHTML = '';
      const today = new Date();
      const currentDay = today.getDate();
      const isCurrentMonthAndYear = (today.getMonth() === currentMonth && today.getFullYear() === currentYear);
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const frag = document.createDocumentFragment();
      const isDarkMode = document.body.classList.contains('dark-mode');

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        const dayDate = new Date(currentYear, currentMonth, i);
        const dayOfWeek = dayDate.getDay();
        const dayName = getDayName(currentYear, currentMonth, i);
        row.dataset.day = i;
        if (isCurrentMonthAndYear && i === currentDay) {
          row.classList.add('current-day');
        }
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          row.classList.add('weekend');
          row.style.backgroundColor = isDarkMode ? 'var(--dark-weekend-bg)' : 'var(--weekend-bg)';
        }
        row.innerHTML = `
          <td>${i}. (${dayName})</td>
          <td><input type="tel" id="start-${i}" data-day="${i}" class="time-input" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
          <td><input type="tel" id="end-${i}" data-day="${i}" class="time-input" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
          <td><input type="text" id="break-${i}" data-day="${i}" class="break-input" inputmode="decimal" placeholder="hod."></td>
          <td id="total-${i}">0h 0m (0.0 h)</td>
          <td><input type="text" id="gross-${i}" class="salary-output" placeholder="0.00" readonly></td>
          <td><input type="text" id="net-${i}" class="salary-output" placeholder="0.00" readonly></td>
          <td class="action-buttons">
            <button class="btn btn-danger btn-sm reset-row-btn" data-day="${i}" title="Vynulova≈• riadok">‚úñ</button>
            <button class="btn btn-info btn-sm copy-row-btn" data-day="${i}" title="Kop√≠rova≈• / Vlo≈æi≈• ƒças">üìÑ</button>
          </td>
        `;
        frag.appendChild(row);
      }
      workDaysTbody.appendChild(frag);
    }

    workDaysTbody.addEventListener('input', (e) => {
      const t = e.target;
      if (t.matches('.time-input')) {
        handleTimeInput(t);
      } else if (t.matches('.break-input')) {
        handleBreakInput(t);
      }
    });

    workDaysTbody.addEventListener('focusout', (e) => {
      if (e.target.matches('.time-input')) {
        validateTimeInput(e.target);
      } else if (e.target.matches('.break-input')) {
        validateBreakInput(e.target);
      }
    });

    workDaysTbody.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const day = parseInt(btn.dataset.day);
      if (isNaN(day)) return;
      if (btn.classList.contains('reset-row-btn')) {
        resetRow(day);
      } else if (btn.classList.contains('copy-row-btn')) {
        handleCopyPasteClick(day);
      }
    });

    function handleTimeInput(input) {
      const day = parseInt(input.dataset.day);
      formatTimeInput(input);
      validateTimeInput(input);
      calculateRow(day);
      handleDataChange();
    }

    function handleBreakInput(input) {
      const day = parseInt(input.dataset.day);
      input.value = input.value.replace(/[^0-9.,]/g, '');
      calculateRow(day);
      handleDataChange();
    }

    function formatTimeInput(input) {
      let val = input.value.replace(/[^\d]/g, '');
      if (val.length > 2) val = val.slice(0,2) + ':' + val.slice(2,4);
      if (val.length > 5) val = val.slice(0,5);
      input.value = val;
    }

    function validateTimeInput(input) {
      const val = input.value;
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (val && !timeRegex.test(val)) {
        input.classList.add('invalid');
      } else {
        input.classList.remove('invalid');
      }
    }

    function validateBreakInput(input) {
      const val = input.value.replace(',', '.').trim();
      if (val && (isNaN(parseFloat(val)) || parseFloat(val) < 0)) {
        input.classList.add('invalid');
        showToast(`Neplatn√° hodnota prest√°vky: ${input.value}`, 'warning', 2000);
      } else {
        input.classList.remove('invalid');
      }
    }

    function resetRow(day) {
      ['start','end','break'].forEach(type => {
        const el = document.getElementById(`${type}-${day}`);
        if (el) {
          el.value = '';
          el.classList.remove('invalid');
        }
      });
      calculateRow(day);
      handleDataChange();
      showToast(`Riadok ${day} vynulovan√Ω.`, 'info', 1500);
    }

    function handleCopyPasteClick(day) {
      if (copiedRowData) {
        pasteRowData(day);
      } else {
        copyRowData(day);
      }
    }

    function copyRowData(day) {
      const start = document.getElementById(`start-${day}`)?.value || '';
      const end = document.getElementById(`end-${day}`)?.value || '';
      const breakTime = document.getElementById(`break-${day}`)?.value || '';
      if (start || end || breakTime) {
        copiedRowData = { start, end, breakTime };
        showToast(`ƒåasy z d≈àa ${day} skop√≠rovan√©. Kliknite na üìÑ v inom riadku pre vlo≈æenie.`, 'success', 3000);
      } else {
        showToast(`Niet ƒço kop√≠rova≈• z d≈àa ${day}.`, 'info', 1500);
      }
    }

    function pasteRowData(day) {
      if (!copiedRowData) return;
      const startInput = document.getElementById(`start-${day}`);
      const endInput = document.getElementById(`end-${day}`);
      const breakInput = document.getElementById(`break-${day}`);
      if (startInput && endInput && breakInput) {
        startInput.value = copiedRowData.start;
        endInput.value = copiedRowData.end;
        breakInput.value = copiedRowData.breakTime;
        validateTimeInput(startInput);
        validateTimeInput(endInput);
        validateBreakInput(breakInput);
        calculateRow(day);
        handleDataChange();
        showToast(`ƒåasy vlo≈æen√© do d≈àa ${day}.`, 'success', 1500);
      }
    }

    /* ===========================
       11) V√Ωpoƒçty
    ============================ */
    function calculateRow(day) {
      const startTimeInput = document.getElementById(`start-${day}`);
      const endTimeInput = document.getElementById(`end-${day}`);
      const breakTimeInput = document.getElementById(`break-${day}`);
      const totalCell = document.getElementById(`total-${day}`);
      const grossInput = document.getElementById(`gross-${day}`);
      const netInput = document.getElementById(`net-${day}`);
      if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) return;

      const startTime = startTimeInput.value;
      const endTime = endTimeInput.value;
      const breakTime = parseFloat(String(breakTimeInput.value).replace(',', '.')) || 0;
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      let decimalHours = 0, hours = 0, minutes = 0;

      if (
        timeRegex.test(startTime) &&
        timeRegex.test(endTime) &&
        !startTimeInput.classList.contains('invalid') &&
        !endTimeInput.classList.contains('invalid') &&
        !breakTimeInput.classList.contains('invalid')
      ) {
        const [startH, startM] = startTime.split(':').map(Number);
        const [endH, endM] = endTime.split(':').map(Number);
        let startTotal = startH*60 + startM;
        let endTotal = endH*60 + endM;
        if (endTotal < startTotal) endTotal += 24*60;
        let diffMinutes = endTotal - startTotal - (breakTime*60);
        if (diffMinutes < 0) diffMinutes = 0;
        const totalRounded = Math.round(diffMinutes);
        hours = Math.floor(totalRounded/60);
        minutes = totalRounded % 60;
        decimalHours = diffMinutes / 60;
      }

      totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;
      const grossSalary = decimalHours * hourlyWage;
      const netSalary = grossSalary * (1 - taxRate);
      grossInput.value = formatCurrency(grossSalary);
      netInput.value = formatCurrency(netSalary);
    }

    function recalculateAllRowsAndTotal() {
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      for (let i = 1; i <= daysInMonth; i++) calculateRow(i);
      calculateTotal();
    }

    function calculateTotal() {
      let totalMinutesPrecise = 0, totalGrossSalary = 0, totalNetSalary = 0;
      let daysWithValid = 0, totalBreakMinutes = 0;
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

      for (let i = 1; i <= daysInMonth; i++) {
        const startInput = document.getElementById(`start-${i}`);
        const endInput = document.getElementById(`end-${i}`);
        const breakInput = document.getElementById(`break-${i}`);
        if (!startInput || !endInput || !breakInput) continue;
        const startTime = startInput.value;
        const endTime = endInput.value;
        const breakTime = parseFloat(String(breakInput.value).replace(',', '.')) || 0;
        let dayDecimalHours = 0;
        let validEntry = false;
        const isValidBreak = !breakInput.classList.contains('invalid');
        const isValidStart = !startInput.classList.contains('invalid');
        const isValidEnd = !endInput.classList.contains('invalid');

        if (timeRegex.test(startTime) && timeRegex.test(endTime) && isValidStart && isValidEnd && isValidBreak) {
          const [startH, startM] = startTime.split(':').map(Number);
          const [endH, endM] = endTime.split(':').map(Number);
          let startTotal = startH*60 + startM;
          let endTotal = endH*60 + endM;
          if (endTotal < startTotal) endTotal += 24*60;
          let diffMinutes = endTotal - startTotal - (breakTime*60);
          if (diffMinutes < 0) diffMinutes = 0;
          totalMinutesPrecise += diffMinutes;
          totalBreakMinutes += breakTime*60;
          dayDecimalHours = diffMinutes/60;
          validEntry = true;
        } else if (breakTime>0 && isValidBreak) {
          totalBreakMinutes += breakTime*60;
        }
        const dayGross = dayDecimalHours * hourlyWage;
        const dayNet = dayGross * (1 - taxRate);
        totalGrossSalary += Math.max(0, dayGross);
        totalNetSalary += Math.max(0, dayNet);
        if (validEntry) daysWithValid++;
      }

      const totalMinRounded = Math.round(totalMinutesPrecise);
      const totalH = Math.floor(totalMinRounded/60);
      const totalM = totalMinRounded % 60;
      const totalDecH = totalMinutesPrecise/60;
      const totalBreakH = Math.floor(totalBreakMinutes/60);
      const totalBreakM = Math.round(totalBreakMinutes%60);
      const avgNet = daysWithValid>0 ? totalNetSalary/daysWithValid : 0;
      const avgMin = daysWithValid>0 ? totalMinutesPrecise/daysWithValid : 0;
      const avgMinRounded = Math.round(avgMin);
      const avgH = Math.floor(avgMinRounded/60);
      const avgM = avgMinRounded%60;
      const avgDecH = avgMin/60;

      totalSalaryDiv.innerHTML = `
        Zapoƒç√≠tan√Ωch (kompletn√Ωch) dn√≠: ${daysWithValid}<br>
        Celkov√Ω odpracovan√Ω ƒças: <strong>${totalH}h ${totalM}m</strong> (${totalDecH.toFixed(decimalPlaces)} h)<br>
        Celkov√° hrub√° mzda: <strong>${formatCurrency(totalGrossSalary)} ‚Ç¨</strong><br>
        Celkov√° ƒçist√° mzda: <strong>${formatCurrency(totalNetSalary)} ‚Ç¨</strong><br>
        Celkov√Ω ƒças prest√°vok: ${totalBreakH}h ${totalBreakM}m<br>
        Priemern√° ƒçist√° mzda / de≈à: ${formatCurrency(avgNet)} ‚Ç¨<br>
        Priemern√Ω odprac. ƒças / de≈à: ${avgH}h ${avgM}m (${avgDecH.toFixed(decimalPlaces)} h)
      `;
    }

    /* ===========================
       12) Export & Z√°loha
    ============================ */
    exportPdfBtn.addEventListener('click', () => {
      if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.autoTable) {
        return showToast("Kni≈ænica pre PDF sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
      }
      showActivity('Generujem PDF...');
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(18);
        doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 28);
        doc.text(`Hodinov√° mzda: ${hourlyWage.toFixed(2)} ‚Ç¨`, 14, 34);
        doc.text(`Sadzba dane: ${(taxRate*100).toFixed(1)} %`, 100, 34);

        const tableData = [];
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
          const dayName = getDayName(currentYear, currentMonth, i);
          const startTime = document.getElementById(`start-${i}`)?.value || '';
          const endTime = document.getElementById(`end-${i}`)?.value || '';
          const breakTime = document.getElementById(`break-${i}`)?.value || '0';
          const totalTimeText = document.getElementById(`total-${i}`)?.textContent || '';
          const grossSalary = document.getElementById(`gross-${i}`)?.value || '0.00';
          const netSalary = document.getElementById(`net-${i}`)?.value || '0.00';
          if (startTime || endTime || (parseFloat(String(breakTime).replace(',','.'))>0)) {
            tableData.push([`${i}. (${dayName})`, startTime, endTime, breakTime, totalTimeText, grossSalary+' ‚Ç¨', netSalary+' ‚Ç¨']);
          }
        }

        doc.autoTable({
          head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest. (h)', 'Odpracovan√©', 'Hrub√° Mzda', 'ƒåist√° Mzda']],
          body: tableData,
          startY: 40,
          styles: { font: 'helvetica', fontSize: 9 },
          headStyles: { fillColor: [74,98,122], textColor: 255, fontStyle: 'bold' },
          alternateRowStyles: { fillColor: [245,245,245] },
        });
        const totalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        const totalTextContent = totalSalaryDiv.innerText.replace(/<strong>|<\/strong>/g, '');
        doc.text(totalTextContent, 14, totalY);
        doc.save(`Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`);
        showToast('PDF √∫spe≈°ne vygenerovan√©.', 'success');
      } catch (error) {
        console.error("Chyba pri generovan√≠ PDF:", error);
        showToast('Chyba pri generovan√≠ PDF.', 'error');
      } finally {
        hideActivity();
      }
    });

    sharePdfBtn.addEventListener('click', async () => {
      if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.autoTable) {
        return showToast("Kni≈ænica pre PDF sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
      }
      showActivity('Pripravujem PDF na zdieƒæanie...');
      let doc;
      try {
        const { jsPDF } = window.jspdf;
        doc = new jsPDF();
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(18);
        doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 28);
        doc.text(`Hodinov√° mzda: ${hourlyWage.toFixed(2)} ‚Ç¨`, 14, 34);
        doc.text(`Sadzba dane: ${(taxRate*100).toFixed(1)} %`, 100, 34);

        const tableData = [];
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
          const dayName = getDayName(currentYear, currentMonth, i);
          const startTime = document.getElementById(`start-${i}`)?.value || '';
          const endTime = document.getElementById(`end-${i}`)?.value || '';
          const breakTime = document.getElementById(`break-${i}`)?.value || '0';
          const totalTimeText = document.getElementById(`total-${i}`)?.textContent || '';
          const grossSalary = document.getElementById(`gross-${i}`)?.value || '0.00';
          const netSalary = document.getElementById(`net-${i}`)?.value || '0.00';
          if (startTime || endTime || (parseFloat(String(breakTime).replace(',','.'))>0)) {
            tableData.push([`${i}. (${dayName})`, startTime, endTime, breakTime, totalTimeText, grossSalary+' ‚Ç¨', netSalary+' ‚Ç¨']);
          }
        }

        doc.autoTable({
          head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest. (h)', 'Odpracovan√©', 'Hrub√° Mzda', 'ƒåist√° Mzda']],
          body: tableData,
          startY: 40,
          styles: { font: 'helvetica', fontSize: 9 },
          headStyles: { fillColor: [74,98,122], textColor: 255, fontStyle: 'bold' },
          alternateRowStyles: { fillColor: [245,245,245] },
        });
        const totalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        const totalTextContent = totalSalaryDiv.innerText.replace(/<strong>|<\/strong>/g, '');
        doc.text(totalTextContent, 14, totalY);

        const pdfBlob = doc.output('blob');
        const fileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
        const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
          await navigator.share({
            files: [pdfFile],
            title: `V√Ωkaz pr√°ce ${getMonthName(currentMonth)} ${currentYear}`,
            text: `V√Ωkaz pr√°ce pre ${employeeName || 'pracovn√≠ka'}...`
          });
          showToast('PDF pripraven√© na zdieƒæanie.', 'success');
        } else {
          showToast('Zdieƒæanie s√∫borov nie je podporovan√©. PDF bolo stiahnut√©.', 'warning', 4000);
          doc.save(fileName);
        }
      } catch (error) {
        console.error('Chyba pri zdieƒæan√≠ PDF:', error);
        showToast('Chyba pri zdieƒæan√≠ PDF.', 'error');
        if (doc) {
          try { doc.save(`Vykaz-chyba-${Date.now()}.pdf`); } catch(e){}
        }
      } finally {
        hideActivity();
      }
    });

    backupBtn.addEventListener('click', () => {
      if (typeof XLSX === 'undefined') {
        return showToast("Kni≈ænica pre Excel sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
      }
      showActivity('Vytv√°ram z√°lohu...');
      try {
        const currentData = collectCurrentData();
        if (!currentData?.data?.length) {
          showToast('Nie s√∫ d√°ta na z√°lohovanie.', 'warning');
          hideActivity();
          return;
        }
        const ws_data = [
          ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Hrub√° Mzda (‚Ç¨)", "ƒåist√° Mzda (‚Ç¨)"]
        ];
        currentData.data.forEach((row, idx) => {
          const day = idx+1;
          ws_data.push([
            `${day}. (${getDayName(currentYear, currentMonth, day)})`,
            row.start,
            row.end,
            parseFloat(row.breakTime) || 0,
            parseFloat(row.gross) || 0,
            parseFloat(row.net) || 0
          ]);
        });
        ws_data.push([]);
        ws_data.push(["--- Nastavenia ---"]);
        ws_data.push(["Pracovn√≠k:", currentData.employeeName]);
        ws_data.push(["Hodinov√° mzda (‚Ç¨):", currentData.hourlyWage]);
        ws_data.push(["Sadzba dane (%):", currentData.taxRate*100]);
        ws_data.push(["Desatinn√© miesta:", currentData.decimalPlaces]);
        ws_data.push(["Posledn√° aktualiz√°cia:", currentData.lastUpdated ? new Date(currentData.lastUpdated).toLocaleString('sk-SK') : 'Nezn√°ma']);

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [{wch:15},{wch:10},{wch:10},{wch:12},{wch:15},{wch:15}];
        XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)}`);
        const fileName = `Zaloha-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast('Z√°loha bola √∫spe≈°ne vytvoren√°.', 'success');
      } catch (error) {
        console.error('Chyba pri vytv√°ran√≠ z√°lohy:', error);
        showToast('Chyba pri vytv√°ran√≠ z√°lohy.', 'error');
      } finally {
        hideActivity();
      }
    });

    restoreBtn.addEventListener('click', () => {
      if (typeof XLSX === 'undefined') {
        return showToast("Kni≈ænica pre Excel sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
      }
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm(`Naozaj obnovi≈• d√°ta zo s√∫boru "${file.name}" pre ${getMonthName(currentMonth)} ${currentYear}?`)) {
          return;
        }
        showActivity(`Spracov√°vam z√°lohu...`);
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const sheetName = workbook.SheetNames[0];
            const ws = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });

            let headerRowIndex = rows.findIndex(r => String(r[0]).toLowerCase().includes("de≈à"));
            if (headerRowIndex === -1) throw new Error("Hlaviƒçka tabuƒæky ('De≈à') nebola n√°jden√°.");

            const dataStartIndex = headerRowIndex+1;
            const restoredDayData = [];
            let settings = {};
            const daysInTargetMonth = getDaysInMonth(currentYear, currentMonth);
            let readingData = true;

            for (let i = dataStartIndex; i < rows.length; i++) {
              const row = rows[i];
              if (!row || !row.some(cell => cell !== "")) {
                readingData = false;
                continue;
              }
              const firstCellLower = String(row[0]).toLowerCase().trim();
              if (readingData && (firstCellLower.startsWith("de≈à") || /^\d+\.?/.test(firstCellLower))) {
                if (restoredDayData.length < daysInTargetMonth) {
                  restoredDayData.push({
                    start: String(row[1] || ""),
                    end: String(row[2] || ""),
                    breakTime: String(row[3] || "0").replace(',','.')
                  });
                }
              } else {
                readingData = false;
                if (row.length>1 && row[0]) {
                  const key = String(row[0]).toLowerCase().trim().replace(':','');
                  const val = String(row[1]||"").trim();
                  if (key.includes("pracovn√≠k")) settings.employeeName = val;
                  else if (key.includes("hodinov√° mzda")) settings.hourlyWage = parseFloat(val.replace(/[^\d.,]/g,'').replace(',','.'))||undefined;
                  else if (key.includes("sadzba dane")) settings.taxRate = (parseFloat(val.replace(/[^\d.,]/g,'').replace(',','.'))||0)/100;
                  else if (key.includes("desatinn√© miesta")) settings.decimalPlaces = parseInt(val)||undefined;
                }
              }
            }

            while (restoredDayData.length<daysInTargetMonth) {
              restoredDayData.push({ start:"", end:"", breakTime:"" });
            }

            const backupData = {
              data: restoredDayData,
              hourlyWage: settings.hourlyWage ?? hourlyWage,
              taxRate: settings.taxRate ?? taxRate,
              employeeName: settings.employeeName ?? employeeName,
              decimalPlaces: settings.decimalPlaces ?? decimalPlaces,
              lastUpdated: new Date().toISOString()
            };

            applyDataToUI(backupData);
            monthDataCache[`${currentYear}-${currentMonth}`] = backupData;
            handleDataChange();
            showToast('Z√°loha bola √∫spe≈°ne obnoven√°.', 'success');
          } catch (error) {
            console.error('Chyba pri naƒç√≠tavan√≠ z√°lohy:', error);
            showToast(`Chyba pri naƒç√≠tavan√≠ z√°lohy: ${error.message}`, 'error', 5000);
          } finally {
            hideActivity();
          }
        };
        reader.onerror = () => { showToast('Chyba pri ƒç√≠tan√≠ s√∫boru.', 'error'); hideActivity(); }
        reader.readAsArrayBuffer(file);
      };
      input.click();
    });

    /* ===========================
       13) Ostatn√© Listenery
    ============================ */
    employeeNameInput.addEventListener('input', debounce(e => {
      employeeName = e.target.value.trim();
      mainTitle.textContent = employeeName ? `${employeeName} - Kalkulaƒçka` : "Bruno's Calculator Pro";
      handleDataChange();
    }, 500));

    hourlyWageInput.addEventListener('input', debounce(e => {
      hourlyWage = parseFloat(String(e.target.value).replace(',', '.'))||0;
      recalculateAllRowsAndTotal();
      handleDataChange();
    }, 500));

    taxRateInput.addEventListener('input', debounce(e => {
      taxRate = (parseFloat(String(e.target.value).replace(',', '.'))||0)/100;
      if (taxRate<0) taxRate=0; if (taxRate>1) taxRate=1;
      recalculateAllRowsAndTotal();
      handleDataChange();
    }, 500));

    decimalPlacesSelect.addEventListener('change', e => {
      decimalPlaces = parseInt(e.target.value);
      recalculateAllRowsAndTotal();
      handleDataChange();
    });

    monthSelect.addEventListener('change', () => {
      currentMonth = parseInt(monthSelect.value);
      updateNavigationButtons();
      initializeAppSettings();
      loadAndDisplayData();
    });

    yearSelect.addEventListener('change', () => {
      currentYear = parseInt(yearSelect.value);
      updateNavigationButtons();
      initializeAppSettings();
      loadAndDisplayData();
    });

    prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
    nextMonthBtn.addEventListener('click', () => navigateMonth(1));
    prevYearBtn.addEventListener('click', () => navigateYear(-1));
    nextYearBtn.addEventListener('click', () => navigateYear(1));
    darkModeToggleBtn.addEventListener('click', toggleDarkMode);

    /* ===========================
       14) Inicializ√°cia Aplik√°cie
    ============================ */
    function initAppUI() {
      applyDarkModePreference();
      populateYearSelect();
      initializeAppSettings();
      updateAuthUI();
      loadAndDisplayData();
    }

    auth.onAuthStateChanged(user => {
      const wasLoggedIn = !!currentUser;
      currentUser = user;
      updateAuthUI();
      if (wasLoggedIn !== !!currentUser) {
        monthDataCache = {};
        loadAndDisplayData();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      initAppUI();
      if (!navigator.onLine) {
        showToast("Aplik√°cia je v re≈æime offline.", "warning");
      }
      window.addEventListener('online', () => showToast('Pripojenie k internetu obnoven√©.', 'success', 2000));
      window.addEventListener('offline', () => showToast('Ste offline. Zmeny sa ulo≈æia lok√°lne.', 'warning', 4000));
    });

    /* ===========================
       15) Service Worker
    ============================ */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker zaregistrovan√Ω:', registration.scope);
            registration.onupdatefound = () => {
              const installingWorker = registration.installing;
              if (installingWorker) {
                installingWorker.onstatechange = () => {
                  if (installingWorker.state === 'installed') {
                    if (navigator.serviceWorker.controller) {
                      console.log('Nov√Ω obsah je dostupn√Ω, pros√≠m obnovte str√°nku.');
                      if (typeof showToast === 'function') {
                        showToast('Je dostupn√° nov√° verzia aplik√°cie. Obnovte str√°nku.', 'info', 10000);
                      }
                    } else {
                      console.log('Obsah je cachovan√Ω pre offline pou≈æitie.');
                      if (typeof showToast === 'function') {
                        showToast('Aplik√°cia je pripraven√° na offline pou≈æitie.', 'success', 3000);
                      }
                    }
                  }
                };
              }
            };
          })
          .catch(error => {
            console.error('Registr√°cia Service Workera zlyhala:', error);
          });

        navigator.serviceWorker.oncontrollerchange = () => {
          console.log('Nov√Ω Service Worker prevzal kontrolu. Odpor√∫ƒça sa obnovi≈• str√°nku.');
          if (typeof showToast === 'function') {
            showToast('Aplik√°cia bola aktualizovan√°. Obnovte str√°nku pre najnov≈°ie funkcie.', 'info', 10000);
          }
        };
      });
    }
  })();
  </script>
</body>
</html>
