<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doch√°dzka</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="icons/icon-192x192.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#5c67f2">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 16px;
    }
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-size: 1.2em;
        color: #555;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .settings > div,
    .settings > details {
        flex: 1 1 200px;
        margin: 0;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9em;
    }
    .collapsible-settings summary {
        cursor: pointer;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        background-color: #f8f8f8;
        display: list-item;
        transition: background-color 0.2s ease;
        font-weight: bold;
    }
    .collapsible-settings summary:hover {
        background-color: #eee;
    }
    .collapsible-content {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 5px 5px 5px;
        border-top: 1px solid #eee;
        margin-top: 5px;
    }
    .collapsible-content > div {
        flex: 1 1 200px;
        margin: 0;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 950px;
      table-layout: fixed;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: top;
      word-wrap: break-word;
       position: relative;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    th:nth-child(1), td:nth-child(1) { width: 40px; }
    th:nth-child(2), td:nth-child(2) { width: 110px; }
    th:nth-child(3), td:nth-child(3) { width: 110px; }
    th:nth-child(4), td:nth-child(4) { width: 90px; text-align: center; }
    th:nth-child(5), td:nth-child(5) { width: 130px;}
    th:nth-child(6), td:nth-child(6) { width: 150px;}
    th:nth-child(7), td:nth-child(7) { width: 100px; text-align: right;}
    th:nth-child(8), td:nth-child(8) { width: 100px; text-align: right;}
    th:nth-child(9), td:nth-child(9) { width: 70px; text-align: center; }

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 7px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }
    textarea {
        resize: vertical;
        min-height: 38px;
    }
    td:nth-child(6) textarea {
        min-height: 38px;
        max-height: 100px;
        overflow-y: auto;
    }

     .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
        position: relative;
    }
    .time-input-wrapper input[type="tel"] {
        flex-grow: 1;
        min-width: 45px;
        padding-right: 30px;
    }
    .clock-icon {
       position: absolute;
       right: 8px;
       top: 50%;
       transform: translateY(-50%);
       cursor: pointer;
       font-size: 1.4em;
       color: #555;
       user-select: none;
       z-index: 2;
    }
    .clock-icon:hover {
      color: #007bff;
      opacity: 0.8;
    }
    .btn-container {
       display: flex;
       flex-wrap: wrap;
       gap: 10px;
       justify-content: center;
       margin-top: 20px;
    }
    .btn {
      padding: 12px 18px;
      border: none;
      border-radius: 4px;
      color: white;
      background-color: #5c67f2;
      cursor: pointer;
      font-size: 1.0em;
      transition: background-color 0.3s ease;
      text-align: center;
      flex: 1 1 150px;
      max-width: 200px;
      box-sizing: border-box;
    }
    .btn:hover { background-color: #4a54e0; }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; padding: 18px 22px; }
    .backup-btn:hover { background-color: #6a1bb2; }
    #totalSalary {
      margin-top: 20px;
      padding: 18px;
      background-color: #e9ecef;
      border-radius: 4px;
      font-size: 1.1em;
      line-height: 1.6;
      border: 1px solid #dee2e6;
      text-align: center;
    }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day select, .current-day textarea {
        background-color: #9932cc;
        color: white;
    }
    .logout-section {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        text-align: center;
    }
    #user-info, #login-form {
        display: none; /* Predvolene skryt√© */
    }
    #user-info span {
        font-size: 0.95em;
        color: #333;
    }
    #user-info .btn {
        min-width: 150px;
        width: auto;
        flex-grow: 0;
        padding: 8px 16px;
        font-size: 0.9em;
        max-width: 200px;
    }

    #installAppButton {
        padding: 12px 18px;
        border: none;
        border-radius: 4px;
        color: white;
        background-color: #28a745;
        cursor: pointer;
        font-size: 1.0em;
        transition: background-color 0.3s ease;
        text-align: center;
        flex: 1 1 150px;
        max-width: 200px;
        box-sizing: border-box;
        margin-top: 5px;
    }
    #installAppButton:hover {
        background-color: #218838;
    }

    @media (max-width: 768px) {
      body { padding: 5px; font-size: 15px; }
      .container { padding: 12px; max-width: 100%; }
      h1 { font-size: 2.0em; }
      h2 { font-size: 1.1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div, .settings > details { width: 100%; margin: 5px 0; flex-basis: auto; }
      .collapsible-content { flex-direction: column; align-items: stretch; }
      .collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; }
      table { min-width: 750px; }
      th, td { padding: 8px; font-size: 1.0em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea {
           font-size: 1.0em;
           padding: 8px;
      }
      .clock-icon { font-size: 1.5em; }
      .btn-container {
          flex-direction: column;
          align-items: center;
      }
      .btn, #installAppButton {
          max-width: none;
          font-size: 1.05em;
          width: 95%;
          margin-left: auto;
          margin-right: auto;
          margin-top: 0;
          margin-bottom: 5px;
          box-sizing: border-box;
          height: 44px;
          padding: 0 20px;
          flex: none;
      }
       .backup-btn {
           padding: 0 22px;
       }
       #user-info .btn {
           width: 80%;
           font-size: 0.95em;
           padding: 10px 16px;
           height: auto;
           margin-bottom: 0;
       }
      #totalSalary { font-size: 1.0em; padding: 15px; }
    }

    @media (max-width: 480px) {
      body { font-size: 14px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1.0em; }
      th, td { font-size: 0.9em; padding: 7px; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea {
           font-size: 0.95em;
           padding: 8px;
      }
      .settings label { font-size: 1.0em; }
      .clock-icon { font-size: 1.6em; }
      .btn, #installAppButton {
          font-size: 0.95em;
          width: 95%;
          height: 42px;
          padding: 0 15px;
          flex: none;
          margin-bottom: 4px;
      }
      .backup-btn {
          padding: 0 15px;
      }
       #user-info .btn {
           width: 85%;
           padding: 10px 16px;
           height: auto;
           margin-bottom: 0;
       }
      table { min-width: 600px; }
      #totalSalary { font-size: 0.95em; padding: 12px; }
    }

    #saveNotification, #errorNotification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        text-align: center;
        font-size: 0.9em;
    }
    #saveNotification.show, #errorNotification.show {
        opacity: 1;
        visibility: visible;
    }
    #saveNotification { background-color: #4CAF50; }
    #errorNotification { background-color: #f44336; }

    #login-form {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 100%;
        max-width: 300px;
        padding: 8px;
        margin-bottom: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        box-sizing: border-box;
        font-size: 1em;
    }
    #login-form .btn {
        width: auto;
        max-width: 150px;
        padding: 10px 22px;
        margin: 5px 0;
        font-size: 1em;
        height: auto;
        flex: initial;
        background-color: #4CAF50;
        color: white;
    }
     #login-form .btn:hover {
         background-color: #388e3c;
     }
    #login-form a { color: #007bff; text-decoration: none; font-size: 0.9em; }
    #login-form a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <div id="loader">Naƒç√≠tavam aplik√°ciu...</div>

  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
    </div>

    <h1 id="mainTitle">Doch√°dzka üëã</h1>
    <h2></h2>

    <div class="settings">
       <div>
         <label for="monthSelect">Mesiac: </label>
         <select id="monthSelect" onchange="changeMonth()">
           <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
           <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
           <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
           <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
         </select>
       </div>
       <details class="collapsible-settings">
         <summary>ƒéal≈°ie nastavenia</summary>
         <div class="collapsible-content">
           <div>
             <label for="employeeNameInput">Meno pracovn√≠ka: </label>
             <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
           </div>
           <div>
             <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
             <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
           </div>
           <div>
             <label for="taxRateInput">Da≈àov√© percento (%): </label>
             <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
           </div>
           <div> <label for="yearSelect">Rok: </label>
             <select id="yearSelect" onchange="changeYear()"></select>
           </div>
           <div>
             <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
             <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
               <option value="1">1</option>
               <option value="2">2</option>
             </select>
           </div>
         </div>
       </details>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mky</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>

    <div class="logout-section">
        <div id="user-info">
          <span id="user-email"></span>
          <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
        </div>
    </div>

  </div>
  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    const app = initializeApp(firebaseConfig);
    try {
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) { console.warn("Firebase App Check failed to initialize.", e); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    const workDaysTableBody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitleElement = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const loaderElement = document.getElementById('loader');
    const loginFormElement = document.getElementById('login-form');
    const userInfoElement = document.getElementById('user-info');
    const userEmailElement = document.getElementById('user-email');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = 10;
    let taxRate = 0.02;

    // === IndexedDB Pomocn√© Funkcie ===
    const DB_NAME = 'bruno-calculator-db';
    const DB_VERSION = 1;
    const PENDING_SYNC_STORE_NAME = 'pendingSync';
    const USER_STORE_NAME = 'userProfile';
    let dbPromise;

    function openDB() { /* ... (k√≥d z predch√°dzaj√∫cej odpovede) ... */ }
    async function dbGet(storeName, key) { /* ... (k√≥d z predch√°dzaj√∫cej odpovede) ... */ }
    async function dbSet(storeName, key, value) { /* ... (k√≥d z predch√°dzaj√∫cej odpovede) ... */ }
    async function dbDelete(storeName, key) { /* ... (k√≥d z predch√°dzaj√∫cej odpovede) ... */ }
    // (Obsah t√Ωchto funkci√≠ je rovnak√Ω ako v mojej predch√°dzaj√∫cej odpovedi, kde sme rie≈°ili DataError)
    // === Koniec IndexedDB Pomocn√Ωch Funkci√≠ ===

    // --- Defin√≠cia Debounce ---
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
    // --- Koniec Debounce ---

    // --- Deklar√°cie v≈°etk√Ωch ostatn√Ωch funkci√≠ ---
    // (Tu bud√∫ defin√≠cie v≈°etk√Ωch va≈°ich funkci√≠, ako updateGreeting, populateYearSelect, atƒè. a≈æ po getDaysInMonth)
    // ... (Vlo≈æte sem KOMPLETN√â defin√≠cie va≈°ich funkci√≠ z predch√°dzaj√∫ceho KOMPLETN√âHO k√≥du) ...
    // Pre ilustr√°ciu sem vlo≈æ√≠m _resetRowInternal a tie, ktor√© sa zmenili kv√¥li syncu

    function _resetRowInternal(day, save = true, promptUser = true) { if (promptUser) { if (!confirm("Naozaj chcete vynulova≈• √∫daje pre tento de≈à?")) { return; } } const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); if(start) start.value = ''; if(end) end.value = ''; if(breakEl) breakEl.value = ''; if(noteEl) noteEl.value = ''; calculateRow(day); if (save) { window.calculateAndUpdateTotals(); } }
    // ... (Vlo≈æte sem KOMPLETN√â defin√≠cie: updateGreeting, populateYearSelect, loadInitialSettings, isOnline, notifikaƒçn√© funkcie, mapFirebaseAuthError, createUserCollection, loadInitialData, loadFromFirestoreAndApply, loadFromLocalStorageOnly, parseAndApplyData, collectCurrentData, getDayName, createTable, isValidTimeFormat, formatAndMoveNext, moveNext, calculateRow, updateNetSalary, calculateTotal, getMonthName, getDaysInMonth) ...

    async function saveDataAndRequestSync() { const saveData = collectCurrentData(); const localKey = `workData-${currentYear}-${currentMonth}`; const pendingDbKey = `pendingSync-${currentYear}-${currentMonth}`; localStorage.setItem(localKey, JSON.stringify(saveData)); console.log(`D√°ta pre ${localKey} ulo≈æen√© do localStorage pre UI.`); try { await dbSet(PENDING_SYNC_STORE_NAME, pendingDbKey, saveData); console.log(`D√°ta pre ${pendingDbKey} ulo≈æen√© do IndexedDB.`); } catch (dbError) { console.error('Chyba pri ukladan√≠ do IndexedDB pre sync:', dbError); showErrorNotification('Chyba pri pr√≠prave d√°t na synchroniz√°ciu na pozad√≠.'); } if ('serviceWorker' in navigator && 'SyncManager' in window) { try { const swRegistration = await navigator.serviceWorker.ready; await swRegistration.sync.register(pendingDbKey); console.log(`Background sync zaregistrovan√Ω pre tag: ${pendingDbKey}`); showSaveNotification('D√°ta ulo≈æen√©, synchroniz√°cia prebehne na pozad√≠.'); } catch (syncErr) { console.error('Background sync zlyhal pri registr√°cii:', syncErr); showErrorNotification('Synchroniz√°cia na pozad√≠ sa nepodarila zaregistrova≈•. D√°ta s√∫ ulo≈æen√© lok√°lne.'); if (isOnline() && currentUser) { console.log("Pokus o okam≈æit√∫ synchroniz√°ciu, keƒè≈æe registr√°cia sync zlyhala."); await attemptSyncNow(currentYear, currentMonth); } } } else { console.log('Background Sync nie je podporovan√Ω.'); if (isOnline() && currentUser) { await attemptSyncNow(currentYear, currentMonth); } else { showSaveNotification('Ste offline. D√°ta ulo≈æen√© lok√°lne.'); } } }
    const debouncedSaveDataAndRequestSync = debounce(saveDataAndRequestSync, 2000);
    function triggerSave() { const currentData = collectCurrentData(); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(currentData)); debouncedSaveDataAndRequestSync(); }
    async function attemptSyncNow(year, month) { console.log(`Pokus o okam≈æit√∫ synchroniz√°ciu pre ${year}-${month}`); if (!currentUser) { console.log("Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, okam≈æit√° synchroniz√°cia preskoƒçen√°."); return; } if (!isOnline()) { console.log("Nie je online, okam≈æit√° synchroniz√°cia preskoƒçen√°."); return; } const dbKey = `pendingSync-${year}-${month}`; try { const dataToSync = await dbGet(PENDING_SYNC_STORE_NAME, dbKey); if (dataToSync) { console.log("N√°jden√© d√°ta v IndexedDB na synchroniz√°ciu:", dataToSync); const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${year}-${month}`); await setDoc(docRef, dataToSync, { merge: true }); await dbDelete(PENDING_SYNC_STORE_NAME, dbKey); showSaveNotification(`D√°ta pre ${getMonthName(month)} ${year} √∫spe≈°ne synchronizovan√©.`); console.log(`D√°ta pre ${dbKey} √∫spe≈°ne synchronizovan√© a odstr√°nen√© z IndexedDB.`); } else { console.log(`≈Ωiadne d√°ta na okam≈æit√∫ synchroniz√°ciu pre ${dbKey}.`); } } catch (error) { console.error(`Chyba pri okam≈æitej synchroniz√°cii pre ${dbKey}:`, error); showErrorNotification('Chyba pri synchroniz√°cii d√°t.'); } }


    // --- Priradenie funkci√≠ k window objektu (event handlery z HTML) ---
    // (Skontrolujte, ƒçi s√∫ tu V≈†ETKY funkcie, ktor√© vol√°te z HTML)
    window.login = async () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie) ... */ };
    window.register = async () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie) ... */ };
    window.logout = async () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie) ... */ };
    window.resetPassword = async () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie) ... */ };
    window.changeMonth = () => { currentMonth = parseInt(monthSelect.value); localStorage.setItem('currentMonth', currentMonth); initializeAppStateForMonthChange(); };
    window.changeYear = () => { currentYear = parseInt(yearSelect.value); localStorage.setItem('currentYear', currentYear); initializeAppStateForMonthChange(); };
    window.insertCurrentTime = (inputId) => { const inputElement = document.getElementById(inputId); if (inputElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); inputElement.value = `${hours}:${minutes}`; window.handleInput(inputElement, ''); } };
    window.handleInput = (input, nextId) => { formatAndMoveNext(input, nextId); window.calculateAndUpdateTotals(); };
    window.handleBreakInput = (day) => { const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if (breakInput) { let breakValue = parseFloat(breakInput.value); if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; } } calculateRow(day); window.calculateAndUpdateTotals(); };
    window.resetRow = _resetRowInternal;
    window.calculateAndUpdateTotals = () => { calculateTotal(); triggerSave(); };
    window.exportToPDF = () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie s upraven√Ωm safeName) ... */ };
    window.sendPDF = () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie s upraven√Ωm safeName) ... */ };
    window.restoreBackup = () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie, upravte dbSet pre pendingSync) ... */ };
    window.createBackup = () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie s upraven√Ωm safeName) ... */ };
    window.loadFromFirestore = async () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie, upravte dbSet pre pendingSync) ... */ };
    window.updateEmployeeName = () => { if(!employeeNameInput) return; employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); window.calculateAndUpdateTotals(); };
    window.updateSettings = () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie) ... */ };
    window.changeDecimalPlaces = () => { /* ... (skop√≠rujte z predch√°dzaj√∫cej kompletnej verzie) ... */ };

    // Hlavn√° inicializaƒçn√° funkcia volan√° raz po overen√≠ stavu Firebase
    function initializeAppUI() {
        populateYearSelect();
        loadInitialSettings();
        updateGreeting();
        
        if (workDaysTableBody) workDaysTableBody.innerHTML = '';
        createTable();

        if (loginFormElement) loginFormElement.style.display = 'none';
        if (userInfoElement) userInfoElement.style.display = 'none';

        if (currentUser) {
            if (userInfoElement) userInfoElement.style.display = 'flex';
            if (userEmailElement) userEmailElement.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;
            loadInitialData();
            if (isOnline()) {
                attemptSyncNow(currentYear, currentMonth);
            }
        } else {
            if (loginFormElement) loginFormElement.style.display = 'flex';
            loadFromLocalStorageOnly();
            if (!isOnline()) showErrorNotification('Ste offline.');
        }
    }
    
    function initializeAppStateForMonthChange() {
        if (loaderElement) loaderElement.style.display = 'flex';
        loadInitialSettings(); 
        updateGreeting();
        if (workDaysTableBody) workDaysTableBody.innerHTML = '';
        createTable();

        if (loginFormElement) loginFormElement.style.display = 'none';
        if (userInfoElement) userInfoElement.style.display = 'none';

        if (currentUser) {
            if (userInfoElement) userInfoElement.style.display = 'flex';
            if (userEmailElement) userEmailElement.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;
            loadInitialData();
        } else {
            if (loginFormElement) loginFormElement.style.display = 'flex';
            loadFromLocalStorageOnly();
        }
        if (loaderElement) loaderElement.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (loaderElement) loaderElement.style.display = 'flex';
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                await dbSet(USER_STORE_NAME, 'currentUserProfile', { uid: user.uid, email: user.email });
            } else {
                await dbDelete(USER_STORE_NAME, 'currentUserProfile');
            }
            initializeAppUI();
            if (loaderElement) loaderElement.style.display = 'none';
        });
    });

    // PWA in≈°talaƒçn√° logika
    let deferredPrompt;
    const installButtonContainer = document.querySelector('.btn-container');
    window.addEventListener('beforeinstallprompt', (e) => { /* ... (k√≥d z predch√°dzaj√∫cej odpovede) ... */ });
    window.addEventListener('appinstalled', () => { /* ... (k√≥d z predch√°dzaj√∫cej odpovede) ... */ });
    window.addEventListener('online', () => { 
        showStatusNotification('Online', 'green'); 
        if (currentUser) {
            attemptSyncNow(currentYear, currentMonth); 
        }
    });

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => { console.log('ServiceWorker registr√°cia √∫spe≈°n√°: ', registration.scope); })
          .catch(error => { console.log('ServiceWorker registr√°cia zlyhala: ', error); });
      });
    }
  </script>
</body>
</html>
