<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- Základné štýly --- */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
     h2 {
       text-align: center;
       color: #555;
       margin-top: -10px;
       font-size: 1.2em;
     }
     .settings {
       margin-bottom: 20px;
       display: flex;
       flex-wrap: wrap;
       align-items: flex-start;
     }
     .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
       margin: 2px 5px;
     }
     .settings > div {
       flex: 1 1 200px;
     }
     .settings > button#toggleSettingsBtn {
       flex-basis: 100%;
       margin-bottom: 10px;
       background-color: #eee;
       color: #333;
       border: 1px solid #ccc;
       text-align: left;
       padding: 8px 12px;
     }
     body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
     }
      .settings > button.highlight {
        flex: 1 1 150px;
      }
     .settings label {
       display: block;
       margin-bottom: 2px;
     }
     #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
     }
     #settings-collapsible-content.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 5px;
     }
     #settings-collapsible-content > div {
        flex: 1 1 200px;
        margin: 2px 5px;
     }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 1000px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
    }
    th {
      background-color: #f2f2f2;
    }

    /* --- Štýly pre input bunky a časové tlačidlá --- */
    td .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 4px;
    }
     td .time-input-wrapper input[type="tel"] {
        flex-grow: 1;
        min-width: 60px;
     }
     td .time-input-wrapper .time-btn {
        font-size: 1.1em;
        cursor: pointer;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 3px;
        line-height: 1;
        background: none;
        color: #555;
        user-select: none;
     }
      td .time-input-wrapper .time-btn:hover {
         background-color: #eee;
         border-color: #ccc;
      }
      body.dark-mode td .time-input-wrapper .time-btn {
         color: #bbb;
      }
      body.dark-mode td .time-input-wrapper .time-btn:hover {
         background-color: #555;
         border-color: #777;
         color: #fff;
      }


    /* --- Šírky stĺpcov --- */
    th:nth-child(7), td:nth-child(7), /* Hrubá Mzda */
    th:nth-child(8), td:nth-child(8) { /* Čistá Mzda */
      width: 14%;
    }
    th:nth-child(6), td:nth-child(6) { /* Poznámka */
       width: 20%;
    }
    th:nth-child(1), td:nth-child(1) { /* Deň */ width: 7%; }
    th:nth-child(2), td:nth-child(2) { /* Príchod */ width: 10%; }
    th:nth-child(3), td:nth-child(3) { /* Odchod */ width: 10%; }
    th:nth-child(4), td:nth-child(4) { /* Prestávka */ width: 7%; }
    th:nth-child(5), td:nth-child(5) { /* Odpracované */ width: 10%; }
    th:nth-child(9), td:nth-child(9) { /* Akcia */ width: 8%; }

    /* --- Spoločné štýly pre input, select a textarea --- */
    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
      font-family: Arial, sans-serif;
    }

    /* --- Špecifický štýl pre textarea poznámky --- */
    textarea[id^="note-"] {
       background-color: #e6faff;
       resize: vertical;
       min-height: 30px;
       line-height: 1.4;
       overflow-y: auto;
    }

    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
      text-align: center;
    }
    .reset-btn {
      background-color: #f44336;
      padding: 5px 10px;
      font-size: 14px;
      flex: 0 0 auto;
      min-width: 35px;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
     #dataSizeContainer { }
     #dataSizeText { }
     #dataSizeBar { }
     #dataSizeFill { }
     .current-day {
       background-color: #8a2be2 !important;
       color: white;
     }
     /* --- Zvýraznenie aktuálneho dňa aj pre textarea --- */
     .current-day input, .current-day select, .current-day textarea {
       background-color: #9932cc !important;
       color: white !important;
       border-color: #b366ff !important;
     }
     .current-day textarea[id^="note-"] {
        background-color: #aa44dd !important;
     }
     .current-day .time-btn {
        color: white !important;
     }
     .current-day .time-btn:hover {
        background-color: #7a1fb4 !important;
        border-color: #9932cc !important;
     }

    /* --- Tmavý režim --- */
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode h1 {
       color: #f4f4f4;
    }
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
      border-color: #555;
    }
    /* --- Tmavý režim pre input, select a textarea --- */
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #666;
      color: white;
      border-color: #555;
    }
    /* --- Tmavý režim špecificky pre textarea poznámky --- */
    body.dark-mode textarea[id^="note-"] {
       background-color: #5a5a7a;
       border-color: #4a4a6a;
    }
    body.dark-mode .btn { color: #f4f4f4; }
    body.dark-mode .reset-btn { background-color: #d32f2f; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f !important; color: #fff; }
    /* --- Tmavý režim pre current-day input, select, textarea --- */
    body.dark-mode .current-day input,
    body.dark-mode .current-day select,
    body.dark-mode .current-day textarea {
      background-color: #5c1db3 !important;
      color: #fff !important;
      border-color: #7e4bd7 !important;
    }
     body.dark-mode .current-day textarea[id^="note-"] {
        background-color: #6c2fc7 !important;
     }
     body.dark-mode .current-day .time-btn { color: #fff !important; }
     body.dark-mode .current-day .time-btn:hover {
        background-color: #4a0e8f !important;
        border-color: #5c1db3 !important;
     }

    /* --- Responzivita (Media Queries) --- */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#toggleSettingsBtn { flex-basis: auto; width: 100%; margin-bottom: 10px; }
      .settings > button.highlight { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 1000px; }
      th, td { padding: 6px; font-size: 0.8em; }
       td .time-input-wrapper .time-btn { font-size: 1em; padding: 1px 3px; }
       textarea { min-height: 28px; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; }
      .backup-btn { padding: 15px 16px; }
      #totalSalary { font-size: 16px; }
      #dataSizeContainer { font-size: 12px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 12px; }
      textarea { min-height: 26px; }
      table { min-width: 1000px; }
      .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 5px 0; }
      #settings-collapsible-content > div { margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 700px; }
       td .time-input-wrapper .time-btn { font-size: 0.9em; padding: 1px 2px; }
    }

    /* --- Notifikácie --- */
    #saveNotification, #errorNotification {
        display: none; position: fixed; bottom: 20px; right: 20px;
        padding: 10px 20px; border-radius: 5px; font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 1000;
        opacity: 0; transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show { display: block; opacity: 1; }
    #saveNotification { background-color: #4CAF50; color: white; }
    #errorNotification { background-color: #f44336; color: white; }

    /* --- Prihlasovanie --- */
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 200px; margin: 5px auto; display: block;
    }
    #login-form .btn { width: 120px; margin: 5px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.9em; color: #007bff; text-decoration: none; }
    #login-form a:hover { text-decoration: underline; }
    body.dark-mode #login-form a { color: #6bbaff; }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <!-- ZMENA: Počiatočný text a odstránené "Ahoj" -->
    <h1 id="mainTitle">Vitaj 👋</h1>
    <h2></h2>

    <div class="settings">
       <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button>
       <div id="settings-collapsible-content">
           <div>
               <label for="employeeNameInput">Meno pracovníka: </label>
               <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
           </div>
           <div>
               <label for="hourlyWageInput">Hodinová mzda (€): </label>
               <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
           </div>
           <div>
               <label for="taxRateInput">Daňové percento (%): </label>
               <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
           </div>
           <div>
               <label for="monthSelect">Mesiac: </label>
               <select id="monthSelect" onchange="changeMonth()">
                 <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
                 <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
                 <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
                 <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
               </select>
           </div>
           <div>
               <label for="yearSelect">Rok: </label>
               <select id="yearSelect" onchange="changeYear()"></select>
           </div>
           <div>
               <label for="decimalPlacesSelect">Počet desatinných miest: </label>
               <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                  <option value="1">1</option> <option value="2">2</option>
               </select>
           </div>
       </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Poznámka</th> <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky generované JavaScriptom -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
        <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Načítanie preferencie tmavého režimu
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    // Funkcia pre prepínanie tmavého režimu
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // ----------------------- IMPORTY Firebase (pridaný onSnapshot) -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
     const firebaseConfig = {
         apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // POZOR: Verejný API kľúč
         authDomain: "uuuuu-f7ef9.firebaseapp.com",
         projectId: "uuuuu-f7ef9",
         storageBucket: "uuuuu-f7ef9.appspot.com",
         messagingSenderId: "456105865458",
         appId: "1:456105865458:web:101f0a4dcb455f174b606b",
     };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    try {
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // POZOR: Verejný kľúč reCAPTCHA
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("App Check initialization failed:", e);
    }
    const auth = getAuth(app);
    const db = getFirestore(app);


    // -------------------- GLOBÁLNE PREMENNÉ (pridaná currentListenerUnsubscribe) --------------------
    let currentUser = null;
    let currentListenerUnsubscribe = null; // Na uloženie funkcie pre odhlásenie listenera
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    // Načítanie hodnôt z localStorage s predvolenými hodnotami
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02; // Ukladáme ako desatinné číslo (2% = 0.02)


    // --- Funkcie pre UI, Nastavenia, Online/Offline, Notifikácie ---
    // ZMENA: Funkcia na aktualizáciu pozdravu
    function updateGreeting() {
        const wavingHand = " 👋"; // Emoji s medzerou pred
        if (employeeName) {
            const firstName = employeeName.split(' ')[0]; // Získa prvé meno
            mainTitle.textContent = `Vitaj ${firstName}${wavingHand}`;
        } else {
            mainTitle.textContent = `Vitaj${wavingHand}`; // Ak nie je meno, len "Vitaj 👋"
        }
    }

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
     }
    populateYearSelect();

    // Nastavenie počiatočných hodnôt UI
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1); // Prevod na percentá pre zobrazenie
    // ZMENA: Volanie updateGreeting pri inicializácii
    updateGreeting();

    // Skrývanie nastavení
     if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
           const isVisible = settingsCollapsibleContent.classList.toggle('visible');
           toggleSettingsBtn.textContent = isVisible ? 'Skryť nastavenia ▲' : 'Zobraziť nastavenia ▼';
        });
     }

    // Online/Offline monitoring a notifikácie
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { console.log('Online'); showStatusNotification('Online', 'green'); syncWithFirebase(); updateUI(); }); // UpdateUI môže (re)aktivovať listener
    window.addEventListener('offline', () => { console.log('Offline'); showStatusNotification('Offline', 'red'); updateUI(); }); // UpdateUI spracuje offline stav
    function showStatusNotification(message, color) {
      // Optimalizácia: Nezobrazovať opakované notifikácie
      const existingNotifications = document.querySelectorAll('.status-notification');
      let shouldShow = true;
      existingNotifications.forEach(notif => {
          if (notif.textContent === message) {
              shouldShow = false; // Už je zobrazená rovnaká notifikácia
          }
          notif.remove(); // Odstráň staré pre istotu
      });

      if (!shouldShow) return;

      const notification = document.createElement('div');
      notification.textContent = message;
      notification.classList.add('status-notification'); // Pridanie triedy pre identifikáciu
      Object.assign(notification.style, { position: 'fixed', top: '20px', right: '20px', padding: '10px 20px', borderRadius: '5px', backgroundColor: color, color: 'white', zIndex: '1000', boxShadow: '0 2px 5px rgba(0,0,0,0.2)' });
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
    function showErrorNotification(message) {
        const notification = document.getElementById('errorNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 4000);
    }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') {
        const notification = document.getElementById('saveNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }


    // --- Autentifikácia ---
    window.login = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Prihlásenie je možné iba online.'); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Prosím, zadajte email aj heslo.'); return; }
        try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error('Chyba pri prihlásení:', error); showErrorNotification('Chyba pri prihlásení: ' + mapFirebaseAuthError(error.code)); }
    };
    window.register = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Registrácia je možná iba online.'); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Prosím, zadajte email aj heslo.'); return; }
        if (password.length < 6) { showErrorNotification('Heslo musí mať aspoň 6 znakov.'); return; }
        try { await createUserWithEmailAndPassword(auth, email, password); await createUserCollection(); } catch (error) { console.error('Chyba pri registrácii:', error); showErrorNotification('Chyba pri registrácii: ' + mapFirebaseAuthError(error.code)); }
    };
    window.logout = async function() {
        // Odhlásenie listenera pred odhlásením používateľa
        if (currentListenerUnsubscribe) {
            console.log('Detaching Firestore listener due to logout.');
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
        }
        try {
            await signOut(auth);
            // Po úspešnom odhlásení resetujeme meno pracovníka, ak bolo naviazané na používateľa
            // Ak chcete meno zachovať aj po odhlásení, odstráňte nasledujúce riadky
            // employeeName = '';
            // localStorage.removeItem('employeeName');
            // employeeNameInput.value = '';
        } catch (error) {
            console.error('Chyba pri odhlásení:', error);
            showErrorNotification('Chyba pri odhlásení: ' + error.message);
        }
        // updateUI() sa zavolá automaticky cez onAuthStateChanged
    };
    window.resetPassword = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Obnova hesla je možná iba online.'); return; }
        const emailInput = document.getElementById('email'); const email = emailInput.value;
        if (!email) { emailInput.style.border = '1px solid red'; showErrorNotification('Prosím, zadajte váš email do poľa "Email" pre obnovu hesla.'); setTimeout(() => { emailInput.style.border = ''; }, 3000); return; }
        emailInput.style.border = '';
        try { await sendPasswordResetEmail(auth, email); showSaveNotification(`Email na obnovu hesla bol odoslaný na ${email}. Skontrolujte si poštu (aj spam).`); } catch (error) { console.error('Chyba pri obnove hesla:', error); showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code)); }
     };
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatný formát emailu.';
            case 'auth/user-not-found': return 'Používateľ s týmto emailom nebol nájdený.';
            case 'auth/wrong-password': return 'Nesprávne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je už zaregistrovaný.';
            case 'auth/weak-password': return 'Heslo je príliš slabé (min. 6 znakov).';
            case 'auth/requires-recent-login': return 'Táto operácia vyžaduje nedávne prihlásenie.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            case 'auth/missing-email': return 'Prosím, zadajte emailovú adresu.';
            default: return errorCode;
        }
     }
    async function createUserCollection() {
        if (auth.currentUser) {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            try {
                // Vytvor základné informácie o používateľovi
                await setDoc(userRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true });
                // Vytvor subkolekciu a prvý dokument, aby existovala
                const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup');
                await setDoc(initialDocRef, { setupComplete: true });
                console.log('User collection and initial workDays doc created for:', auth.currentUser.email);
            } catch (error) { console.error('Error creating user collection:', error); }
        }
    }


    // --- Hlavná logika UI, Načítania a Synchronizácie ---
    // ZMENA: Upravená funkcia updateUI pre lepšie offline správanie prihláseného používateľa
    function updateUI() {
        console.log("Updating UI...");
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');

        // 1. Vždy odhlásime starý listener (ak existuje)
        if (currentListenerUnsubscribe) {
            console.log("Detaching previous Firestore listener.");
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
        }

        // 2. Vytvoríme štruktúru tabuľky (zatiaľ bez dát)
        createTable(); // Vytvorí alebo vyčistí tabuľku

        // 3. Rozhodneme sa podľa stavu prihlásenia
        if (currentUser) {
            // Používateľ je prihlásený (bez ohľadu na online stav)
            loginForm.style.display = 'none'; // Skry login formulár VŽDY ak je user prihlásený
            userInfo.style.display = 'block'; // Zobraz info o používateľovi VŽDY ak je prihlásený
            userEmail.textContent = currentUser.email;

            if (isOnline()) {
                // Prihlásený a ONLINE: Pripoj listener a synchronizuj
                console.log(`Attaching Firestore listener for user ${currentUser.uid}, month ${currentYear}-${currentMonth}`);
                const docId = `${currentYear}-${currentMonth}`;
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', docId);

                currentListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                     console.log(`Firestore snapshot received for ${docId}. Exists: ${docSnap.exists()}`);
                     const localKey = `workData-${currentYear}-${currentMonth}`;
                     if (docSnap.exists()) {
                         const firestoreData = docSnap.data();
                         const firestoreDataString = JSON.stringify(firestoreData);
                         const localDataString = localStorage.getItem(localKey);

                         // Optimalizácia: Aplikuj dáta len ak sa líšia od lokálnych
                         if (firestoreDataString !== localDataString) {
                             console.log("Firestore data differs from local, applying update.");
                             localStorage.setItem(localKey, firestoreDataString); // Aktualizuj LS
                             parseAndApplyData(firestoreDataString); // Aplikuj na UI
                         } else {
                             console.log("Firestore data matches local, skipping UI update.");
                             // Ak sa dáta zhodujú, pre istotu prepočítame súčty (mohli sa zmeniť nastavenia)
                             // calculateTotal(); // ZMENA: Odstránené, volá sa na konci updateUI
                         }
                     } else {
                         // Dokument neexistuje vo Firestore
                         console.log(`Document ${docId} does not exist in Firestore. Clearing local data if exists.`);
                         if (localStorage.getItem(localKey)) {
                             localStorage.removeItem(localKey); // Odstráň z LS
                             parseAndApplyData(null); // Vyčisti UI
                         } else {
                             // Ak už lokálne nie sú dáta, len prepočítaj súčty (vynuluje ich)
                             // calculateTotal(); // ZMENA: Odstránené, volá sa na konci updateUI
                         }
                     }
                }, (error) => {
                    console.error(`Firestore listener error for ${docId}:`, error);
                    showErrorNotification(`Chyba pri počúvaní zmien: ${error.message}. Zobrazujem lokálne dáta.`);
                    // Pri chybe listenera sa vrátime k lokálnym dátam, ak existujú
                    loadFromLocalStorageOnly();
                });

                // Po pripojení listenera skontroluj, či nemáme lokálne dáta čakajúce na odoslanie
                syncWithFirebase();

            } else {
                // Prihlásený a OFFLINE: Načítaj len z LS a zobraz notifikáciu
                console.log("User logged in but offline. Loading from localStorage only.");
                // ZMENA: Používame showErrorNotification pre výraznejšie upozornenie
                showErrorNotification('Ste offline. Zobrazujú sa lokálne uložené dáta. Zmeny sa synchronizujú po pripojení.');
                loadFromLocalStorageOnly();
            }
        } else {
            // Používateľ NIE je prihlásený
            loginForm.style.display = 'flex'; // Zobraz login formulár
            userInfo.style.display = 'none'; // Skry info o používateľovi
            console.log("User not logged in. Loading from localStorage only (if any).");
            loadFromLocalStorageOnly(); // Načíta lokálne dáta (ak existujú, inak vyčistí)
            if (!isOnline()) {
                // ZMENA: Špecifickejšia správa pre neprihláseného offline používateľa
                showErrorNotification('Ste offline. Pre prístup k cloudovým dátam a funkciám sa prihláste, keď budete online.');
            }
        }
         // ZMENA: Volanie updateGreeting a calculateTotal na konci updateUI pre zaručenie aktuálnosti
         updateGreeting();
         calculateTotal();
    }

    // Ukladanie (Debounce)
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1500); // 1.5 sekundy debounce

    // Zber dát z tabuľky
    function collectCurrentData() {
        const saveData = {
            data: [],
            // Nastavenia sa pridajú nižšie
        };
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
             const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
             const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
             const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
             const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
             // const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`); // Už sa nečíta na uloženie
             // const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`); // Už sa nečíta na uloženie
             const start = startElement ? startElement.value : '';
             const end = endElement ? endElement.value : '';
             const breakTime = breakElement ? breakElement.value : '';
             const note = noteElement ? noteElement.value : '';
             // Mzdy sa už neukladajú priamo, prepočítavajú sa vždy nanovo
             saveData.data.push({ start, end, breakTime, note });
        }
        // Aktualizuj nastavenia v ukladanom objekte
        saveData.hourlyWage = hourlyWage;
        saveData.taxRate = taxRate;
        saveData.employeeName = employeeName;
        saveData.decimalPlaces = decimalPlaces;
        saveData.lastUpdated = new Date().toISOString(); // Vždy aktualizuj čas poslednej lokálnej zmeny
        return saveData;
    }


    // Ukladanie do Firestore
    async function saveToFirestore() {
        if (!currentUser) {
            console.log("Cannot save to Firestore: User not logged in.");
            return;
        }
         // Získaj najaktuálnejšie dáta z UI pred ukladaním
         const saveData = collectCurrentData();
         const localKey = `workData-${currentYear}-${currentMonth}`;
         const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;


        if (isOnline()) {
            try {
                console.log(`Attempting to save/sync to Firestore: ${currentYear}-${currentMonth}`);
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, saveData, { merge: true }); // Použi merge pre istotu
                localStorage.removeItem(pendingSyncKey); // Odstráň flag čakajúcej synchronizácie
                // Neukladáme do LS tu, listener sa postará o aktualizáciu z FS->LS
                console.log(`Data successfully saved to Firestore: ${currentYear}-${currentMonth}`);
                 // showSaveNotification(); // Optional: Notifikácia o úspešnom uložení do cloudu
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                showErrorNotification('Chyba pri ukladaní dát do cloudu: ' + error.message);
                // Ak zlyhá zápis, označ dáta ako čakajúce na synchronizáciu (a ulož ich lokálne)
                localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
                localStorage.setItem(localKey, JSON.stringify(saveData)); // Ulož aj do hlavného LS pre offline
            }
        } else {
            console.log('Offline: Marking data for later synchronization and saving locally.');
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
            localStorage.setItem(localKey, JSON.stringify(saveData)); // Ulož do hlavného LS pre offline
            showSaveNotification('Ste offline, dáta uložené lokálne.');
        }
    }

    // Synchronizácia offline dát
    async function syncWithFirebase() {
        if (!currentUser || !isOnline()) return;
        console.log('Checking for pending data to sync...');
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingDataString = localStorage.getItem(pendingSyncKey);

        if (pendingDataString) {
            console.log('Found pending data, syncing with Firestore...');
            try {
                const dataToSync = JSON.parse(pendingDataString);
                dataToSync.lastUpdated = new Date().toISOString(); // Aktualizuj čas pred odoslaním
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, dataToSync, { merge: true });
                console.log('Pending data synced to Firestore.');
                // Po úspešnej synchronizácii odstránime pending flag
                localStorage.removeItem(pendingSyncKey);
                // Nie je nutné explicitne ukladať do LS ani volať parseAndApplyData,
                // listener by mal dostať túto zmenu a aktualizovať LS a UI.
                showSaveNotification('Offline dáta boli synchronizované.');
            } catch (error) {
                console.error('Error syncing pending data:', error);
                showErrorNotification('Chyba pri synchronizácii offline dát: ' + error.message);
                // Ak synchronizácia zlyhá, pending flag zostáva.
            }
        } else {
            console.log('No pending data to sync.');
        }
    }

    // Manuálne načítanie z Firestore (ako fallback)
    window.loadFromFirestore = async function() {
         if (!currentUser) { showErrorNotification('Pre načítanie z Firebase sa musíte prihlásiť.'); return; }
         if (!isOnline()) { showErrorNotification('Ste offline. Načítanie z Firebase vyžaduje internet.'); return; }
         if (!confirm('Naozaj chcete manuálne načítať dáta z Firebase? Prepíšu sa tým aktuálne lokálne dáta pre tento mesiac.')) { return; }
         console.log(`Manual load from Firestore initiated for ${currentYear}-${currentMonth}`);
         try {
             const userRef = doc(db, 'users', currentUser.uid);
             const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
             const docSnap = await getDoc(docRef);
             const localKey = `workData-${currentYear}-${currentMonth}`;
             if (docSnap.exists()) {
                 const storedData = docSnap.data();
                 const dataString = JSON.stringify(storedData);
                 console.log('Manual load successful, applying data.');
                 // Pri manuálnom načítaní prepíšeme LS a aplikujeme dáta priamo
                 localStorage.setItem(localKey, dataString);
                 localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); // Odstránime pending flag
                 parseAndApplyData(dataString); // Aplikujeme manuálne načítané dáta
                 showSaveNotification('Dáta boli úspešne načítané z Firebase.');
             } else {
                 console.log('Manual load: No data found in Firestore.');
                 // Ak v cloude nič nie je, vymažeme aj lokálne dáta a UI
                 localStorage.removeItem(localKey);
                 localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`);
                 parseAndApplyData(null); // Vyčistíme UI
                 showErrorNotification('Pre tento mesiac neboli vo Firebase nájdené žiadne dáta.');
             }
             // ZMENA: Prepočítať súčty a aktualizovať pozdrav po manuálnom načítaní
             updateGreeting();
             calculateTotal();
         } catch (error) {
             console.error('Chyba pri manuálnom načítavaní z Firestore:', error);
             showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message);
         }
     };

    // Načítanie LEN z localStorage (pre offline/odhlásený stav)
    // ZMENA: Zjednodušená, parseAndApplyData(null) sa nahradí čistením riadkov
    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        console.log(`Loading from localStorage only for key: ${localKey}. Data found: ${!!localData}`);
        if (localData) {
            parseAndApplyData(localData); // Aplikuj lokálne dáta
        } else {
            // Ak nie sú lokálne dáta, vyčisti UI riadky, ale nechaj nastavenia z LS
            console.log("No local data found. Clearing table rows.");
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                     resetRow(i, false); // false = neukladať, len vyčisti UI
                }
            }
             // Nastavenia (mzda, daň, meno, ...) zostávajú z LS alebo default
             // Súčty a pozdrav sa aktualizujú na konci updateUI
        }
    }


    // Spracovanie JSON a aplikovanie dát (zvládne null vstup)
    // ZMENA: Odstránené volania updateGreeting a calculateTotal
    function parseAndApplyData(dataString) {
        // Ak dataString je null alebo undefined, vyčistí tabuľku
        if (!dataString) {
            console.log("parseAndApplyData received null/undefined, clearing table rows.");
            const daysInMonth = getDaysInMonth(currentMonth);
            // Vyčisti len UI riadky, neukladaj túto zmenu
            for (let i = 1; i <= daysInMonth; i++) {
                if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                     resetRow(i, false); // false = neukladať
                }
            }
            // Nastavenia (mzda, daň, meno, ...) necháme, ako boli naposledy uložené v LS
            // Súčty a pozdrav sa aktualizujú na konci updateUI
            return;
        }

        try {
            const storedData = JSON.parse(dataString);
            console.log("Parsing and applying data from source (LS or FS):", storedData);

            // Aktualizácia globálnych nastavení z načítaných dát
            // Ak hodnota v storedData chýba, použije sa aktuálna globálna hodnota
            hourlyWage = storedData.hourlyWage !== undefined ? storedData.hourlyWage : hourlyWage;
            taxRate = storedData.taxRate !== undefined ? storedData.taxRate : taxRate;
            employeeName = storedData.employeeName !== undefined ? storedData.employeeName : employeeName;
            decimalPlaces = storedData.decimalPlaces !== undefined ? storedData.decimalPlaces : decimalPlaces;

            // Aktualizujeme UI prvky nastavení, aby odrážali načítané hodnoty
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;
            // updateGreeting(); // Odstránené, volá sa na konci updateUI

            // Uložíme tieto (potenciálne aktualizované) nastavenia do localStorage
            // aby boli perzistentné aj po obnovení stránky
            localStorage.setItem('hourlyWage', hourlyWage);
            localStorage.setItem('taxRate', taxRate);
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces);

            // Aplikácia dát do tabuľky
            const daysInMonth = getDaysInMonth(currentMonth);
            if (storedData.data && Array.isArray(storedData.data)) {
                const dataFromSource = storedData.data;
                // Aplikuj dáta pre každý deň
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayIndex = i - 1;
                    const dayData = dataFromSource[dayIndex]; // Získaj dáta pre tento deň (môžu byť undefined)

                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                    const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);

                    if (startElement && endElement && breakElement && noteElement) {
                        if (dayData) {
                            // Ak máme dáta pre tento deň, vyplň polia
                            startElement.value = dayData.start || '';
                            endElement.value = dayData.end || '';
                            breakElement.value = dayData.breakTime || '';
                            noteElement.value = dayData.note || '';
                        } else {
                            // Ak pre tento deň nie sú dáta v poli, vynuluj polia
                            startElement.value = '';
                            endElement.value = '';
                            breakElement.value = '';
                            noteElement.value = '';
                        }
                        // Prepočítaj hodnoty pre tento riadok (Odpracované, Hrubá, Čistá)
                        calculateRow(i); // Toto zostáva pre každý riadok
                    }
                }
            } else {
                // Ak pole `storedData.data` chýba alebo nie je pole, vyčisti celú tabuľku
                console.warn("Stored data is missing or has incorrect format (.data array). Clearing table.");
                for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); } // false = neukladať
            }
            // Nakoniec prepočítaj celkové súčty
            // calculateTotal(); // Odstránené, volá sa na konci updateUI
        } catch (error) {
            console.error('Chyba pri parsovaní alebo aplikovaní dát:', error, "Data string:", dataString);
            showErrorNotification('Chyba pri spracovaní uložených dát: ' + error.message);
            // V prípade chyby parsovania radšej vyčisti UI
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); } // false = neukladať
            // calculateTotal(); // Odstránené, volá sa na konci updateUI
        }
    }


    // --- Tvorba tabuľky a Výpočty ---
    function getDayName(year, month, day) {
        const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"];
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
     }

    function createTable() {
      workDays.innerHTML = ''; // Vyčisti predchádzajúci obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        // Zvýraznenie aktuálneho dňa
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        const startId = `start-${currentYear}-${currentMonth}-${i}`;
        const endId = `end-${currentYear}-${currentMonth}-${i}`;
        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
        const noteId = `note-${currentYear}-${currentMonth}-${i}`;
        const totalId = `total-${currentYear}-${currentMonth}-${i}`;
        const grossId = `gross-${currentYear}-${currentMonth}-${i}`;
        const netId = `net-${currentYear}-${currentMonth}-${i}`;

        // Generovanie HTML riadku s textarea pre poznámku
        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td>
            <div class="time-input-wrapper">
              <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}')">
              <span class="time-btn" onclick="setCurrentTime('${startId}')" title="Zadať aktuálny čas">🕒</span>
            </div>
          </td>
          <td>
            <div class="time-input-wrapper">
              <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}')">
              <span class="time-btn" onclick="setCurrentTime('${endId}')" title="Zadať aktuálny čas">🕒</span>
            </div>
          </td>
          <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
          <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><textarea id="${noteId}" placeholder="Poznámka..." oninput="calculateAndUpdateTotals()" rows="1"></textarea></td>
          <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        workDays.appendChild(row);
      }
     }

    window.setCurrentTime = function(inputId) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const currentTime = `${hours}:${minutes}`;
        const targetInput = document.getElementById(inputId);
        if (targetInput) {
            targetInput.value = currentTime;
            const day = parseInt(inputId.split('-')[3]);
            if (!isNaN(day)) {
                calculateRow(day); // Prepočítaj riadok
                calculateAndUpdateTotals(); // Prepočítaj súčty a ulož dáta
            }
        }
    }

    window.handleInput = function(input, nextId) {
        formatAndMoveNext(input, nextId); // Formátuje, prepočíta riadok a presunie focus
        calculateAndUpdateTotals(); // Prepočítaj súčty a ulož dáta
    }
    window.handleBreakInput = function(day) {
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        // Tu môže byť validácia hodnoty prestávky
        calculateRow(day); // Prepočítaj riadok
        calculateAndUpdateTotals(); // Prepočítaj súčty a ulož dáta
    }

    // Hlavná funkcia pre ukladanie dát po akejkoľvek zmene v tabuľke alebo nastaveniach
    function calculateAndUpdateTotals() {
        // 1. Prepočítaj vizuálne súčty na stránke
        calculateTotal(); // Najprv prepočítaj a zobraz súčty

        // 2. Získaj aktuálny stav všetkých dát z UI (vrátane poznámok a nastavení)
        const saveData = collectCurrentData();

        // 3. Ihneď ulož aktuálny stav do localStorage (pre offline a rýchlosť)
        const localKey = `workData-${currentYear}-${currentMonth}`;
        localStorage.setItem(localKey, JSON.stringify(saveData));

        // 4. Spusti debounced zápis do Firestore (ak sme online a prihlásení)
        debouncedSaveToFirestore();
    }

    // Pomocné funkcie (formátovanie času, presun fokusu)
    function isValidTimeFormat(timeString) {
        if (!timeString) return false;
        return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString);
    }
    function formatAndMoveNext(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, '');
        let originalValue = input.value;
        let cursorPosition = input.selectionStart;
        // Automatické pridanie ':'
        if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value += ':'; }
        else if (value.length === 4 && !value.includes(':')) { value = value.substring(0, 2) + ':' + value.substring(2); }
        else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d:]/g, '').length) { value = value.substring(0, 2) + ':' + value.substring(2); }
        // Opravy formátu
        value = value.replace(/^:/, ''); // Odstráni ':' na začiatku
        if ((value.match(/:/g) || []).length > 1) { // Ponechá len prvú ':'
             const parts = value.split(':'); value = parts[0] + ':' + parts.slice(1).join('');
        }
        if (value.length > 5) { value = value.slice(0, 5); } // Maximálna dĺžka

        if (input.value !== value) {
            input.value = value;
             try { // Nastavenie pozície kurzora
                 if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); }
                 else { input.setSelectionRange(cursorPosition, cursorPosition); }
             } catch (e) {/* Ignoruj chybu, ak element nie je fokusovateľný */}
        }

        const day = parseInt(input.id.split('-')[3]);
        calculateRow(day); // Vždy prepočítaj riadok pri zmene času
        // Presuň sa ďalej len pri platnom a kompletnom čase HH:MM
        if (value.length === 5 && isValidTimeFormat(value)) {
             moveNext(input, nextId);
        }
    }
    function moveNext(currentElement, nextId) {
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
             nextElement.focus();
             // Ak je to input (nie number), označ text
             if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') {
                 nextElement.select();
             }
        }
    }

    // Výpočet jedného riadku (čas a mzdy)
    function calculateRow(day) {
        const startId = `start-${currentYear}-${currentMonth}-${day}`;
        const endId = `end-${currentYear}-${currentMonth}-${day}`;
        const breakId = `break-${currentYear}-${currentMonth}-${day}`;
        const totalId = `total-${currentYear}-${currentMonth}-${day}`;
        const grossId = `gross-${currentYear}-${currentMonth}-${day}`;
        const netId = `net-${currentYear}-${currentMonth}-${day}`;

        const startTimeInput = document.getElementById(startId);
        const endTimeInput = document.getElementById(endId);
        const breakTimeInput = document.getElementById(breakId);
        const totalCell = document.getElementById(totalId);
        const grossInput = document.getElementById(grossId);
        const netInput = document.getElementById(netId);

        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) {
             console.warn(`Missing element for row ${day}`); return; // Chýba element, nerob nič
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const breakTime = parseFloat(breakTimeInput.value) || 0; // Prestávka v hodinách

        // Ak časy nie sú platné, vynuluj výsledky
        if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
            grossInput.value = (0).toFixed(decimalPlaces);
            netInput.value = (0).toFixed(decimalPlaces);
            return;
        }

        // Prevod časov na minúty
        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);
        const startDate = new Date(2000, 0, 1, startHours, startMinutes); // Dátum je irelevantný
        const endDate = new Date(2000, 0, 1, endHours, endMinutes);

        // Rozdiel v milisekundách, zohľadnenie prechodu cez polnoc
        let diffMillis = endDate.getTime() - startDate.getTime();
        if (diffMillis < 0) { // Ak čas odchodu je menší (napr. 22:00 -> 06:00)
            diffMillis += 24 * 60 * 60 * 1000; // Pripočítaj 24 hodín
        }

        // Prevod na minúty a odpočítanie prestávky (v minútach)
        let diffMinutes = diffMillis / (60 * 1000);
        const breakMinutes = breakTime * 60;
        diffMinutes -= breakMinutes;

        // Výsledný čas nesmie byť záporný
        if (diffMinutes < 0) diffMinutes = 0;

        // Výpočet hodnôt pre zobrazenie
        const decimalHours = diffMinutes / 60; // Celkový čas v desatinnom tvare
        const totalMinutesRounded = Math.round(diffMinutes); // Celkový čas v minútach (zaokrúhlený)
        const hours = Math.floor(totalMinutesRounded / 60); // Celé hodiny
        const minutes = totalMinutesRounded % 60; // Zvyšné minúty

        // Zobrazenie odpracovaného času
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

        // Výpočet a zobrazenie hrubej mzdy
        const grossSalary = decimalHours * hourlyWage;
        grossInput.value = Math.max(0, grossSalary).toFixed(decimalPlaces);

        // Výpočet a zobrazenie čistej mzdy
        updateNetSalary(day);
     }

    // Výpočet čistej mzdy pre riadok
    function updateNetSalary(day) {
        const grossId = `gross-${currentYear}-${currentMonth}-${day}`;
        const netId = `net-${currentYear}-${currentMonth}-${day}`;
        const grossSalaryInput = document.getElementById(grossId);
        const netSalaryInput = document.getElementById(netId);
        if (!grossSalaryInput || !netSalaryInput) return;

        const grossSalary = parseFloat(grossSalaryInput.value) || 0;
        const netSalary = grossSalary * (1 - taxRate); // taxRate je 0.02 pre 2%
        netSalaryInput.value = Math.max(0, netSalary).toFixed(decimalPlaces);
     }

    // Vynulovanie riadku
    window.resetRow = function(day, saveChanges = true) {
        console.log(`Resetting row ${day}, saveChanges: ${saveChanges}`);
        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const noteInput = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);

        if(startInput) startInput.value = '';
        if(endInput) endInput.value = '';
        if(breakInput) breakInput.value = '';
        if(noteInput) noteInput.value = '';

        calculateRow(day); // Prepočíta UI riadku (na nuly)

        if (saveChanges) {
            calculateAndUpdateTotals(); // Uloží zmeny (vynulovanie) do LS a spustí sync
        }
    }

    // Výpočet celkových súčtov
    function calculateTotal() {
        let totalMinutesPrecise = 0;
        let totalGrossSalaryPrecise = 0;
        let totalNetSalaryPrecise = 0;
        let daysWithEntries = 0;
        const daysInMonth = getDaysInMonth(currentMonth);

        for (let i = 1; i <= daysInMonth; i++) {
            const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const noteInput = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`); // Zahrnieme poznámku
            if (!startInput || !endInput || !breakInput) continue; // Ak chýba základný prvok, preskoč

            const startTime = startInput.value;
            const endTime = endInput.value;
            const breakTime = parseFloat(breakInput.value) || 0;
            const noteValue = noteInput ? noteInput.value : ''; // Získaj hodnotu poznámky
            let dayMinutes = 0; let dayGrossSalary = 0; let dayNetSalary = 0; let hasEntry = false;

            // Výpočet času a miezd, ak sú časy platné
            if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                const [startHours, startMinutes] = startTime.split(':').map(Number);
                const [endHours, endMinutes] = endTime.split(':').map(Number);
                const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                const endDate = new Date(2000, 0, 1, endHours, endMinutes);
                let diffMillis = endDate.getTime() - startDate.getTime();
                if (diffMillis < 0) diffMillis += 24 * 60 * 60 * 1000;
                let diffMinutes = diffMillis / (60 * 1000);
                const breakMinutes = breakTime * 60;
                diffMinutes -= breakMinutes;
                if (diffMinutes < 0) diffMinutes = 0;

                dayMinutes = diffMinutes; // Ulož presné minúty
                const dayDecimalHours = diffMinutes / 60;
                dayGrossSalary = Math.max(0, dayDecimalHours * hourlyWage);
                dayNetSalary = Math.max(0, dayGrossSalary * (1 - taxRate));
                if (dayMinutes > 0) { hasEntry = true; } // Ak bol odpracovaný čas > 0
            }

            // Deň sa počíta ako započítaný, ak má vyplnený čas, nenulovú prestávku ALEBO poznámku
            if (startTime || endTime || (breakTime && breakTime > 0) || noteValue) {
                hasEntry = true;
            }

            // Pripočítanie k celkovým sumám
            totalMinutesPrecise += dayMinutes;
            totalGrossSalaryPrecise += dayGrossSalary;
            totalNetSalaryPrecise += dayNetSalary;
            if (hasEntry) { daysWithEntries++; }
        }

        // Výpočet priemerov
        const totalMinutesRounded = Math.round(totalMinutesPrecise);
        const totalHours = Math.floor(totalMinutesRounded / 60);
        const totalMinutesRemainder = totalMinutesRounded % 60;
        const totalDecimalHoursPrecise = totalMinutesPrecise / 60;
        const averageNetSalaryPrecise = daysWithEntries > 0 ? totalNetSalaryPrecise / daysWithEntries : 0;
        const averageWorkedMinutesPrecise = daysWithEntries > 0 ? totalMinutesPrecise / daysWithEntries : 0;
        const averageMinutesRounded = Math.round(averageWorkedMinutesPrecise);
        const averageHours = Math.floor(averageMinutesRounded / 60);
        const averageMinutes = averageMinutesRounded % 60;
        const averageDecimalHoursPrecise = averageWorkedMinutesPrecise / 60;

        // Zobrazenie súhrnu
        totalSalaryDiv.innerHTML = `
           Započítaných dní: ${daysWithEntries}<br>
           Celkový čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHoursPrecise.toFixed(decimalPlaces)} h)<br>
           Hrubá mzda: ${totalGrossSalaryPrecise.toFixed(decimalPlaces)} €<br>
           Čistá mzda: ${totalNetSalaryPrecise.toFixed(decimalPlaces)} €<br>
           Priem. čistá mzda/deň: ${averageNetSalaryPrecise.toFixed(decimalPlaces)} €<br>
           <strong>Priem. čas/deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHoursPrecise.toFixed(decimalPlaces)} h)</strong>
         `;
     }

    // Pomocná funkcia pre názov mesiaca
    function getMonthName(month) {
        const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
        if (month >= 0 && month < monthNames.length) { return monthNames[month]; }
        return "Neznámy mesiac";
    }


    // --- Exporty a Zálohy ---
    window.exportToPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      // Pridanie fontu s fallbackom
      try {
          // Pokus o pridanie Roboto fontu (musí byť dostupný na ceste)
          // Ak používate vlastný build alebo inú cestu, upravte URL
          // doc.addFileToVFS('Roboto-Regular.ttf', /* Base64 encoded font */); // Alternatíva s vkladaním
          doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
          doc.setFont('Roboto');
      } catch (e) {
          console.warn("Roboto font not found or failed to load, using default helvetica.");
          doc.setFont('helvetica', 'normal'); // Fallback font
      }

      doc.setFontSize(16);
      doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22);
      doc.setFontSize(12);
      doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30);

      const tableData = [];
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
        const dayName = getDayName(currentYear, currentMonth, i);
        const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const note = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const totalTimeCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`);
        const totalTimeText = totalTimeCell ? totalTimeCell.textContent.trim() : '';
        const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
        const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';

        // Zahrň riadok, len ak má nejaký záznam (čas, nenulová prestávka alebo poznámka)
        if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) || note) {
          tableData.push([
            `${i}. ${dayName}`,
            startTime,
            endTime,
            breakTime || '0',
            totalTimeText,
            note,
            `${parseFloat(grossSalary).toFixed(decimalPlaces)} €`,
            `${parseFloat(netSalary).toFixed(decimalPlaces)} €`
          ]);
        }
      }

      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Poznámka', 'Hrubá Mzda', 'Čistá Mzda']],
        body: tableData,
        startY: 38,
        theme: 'grid',
        styles: { font: doc.getFont().fontName, fontSize: 9, cellPadding: 2, valign: 'middle' }, // Použi aktuálne nastavený font
        headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold', fontSize: 10, halign: 'center' },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        columnStyles: {
           0: { cellWidth: 18, halign: 'left' },    // Deň
           1: { cellWidth: 15, halign: 'center' }, // Príchod
           2: { cellWidth: 15, halign: 'center' }, // Odchod
           3: { cellWidth: 18, halign: 'center' }, // Prestávka
           4: { cellWidth: 25, halign: 'center' }, // Odpracované
           5: { cellWidth: 35, halign: 'left' },   // Poznámka
           6: { cellWidth: 23, halign: 'right' },  // Hrubá Mzda
           7: { cellWidth: 23, halign: 'right' }   // Čistá Mzda
        },
        didDrawPage: function (data) { /* Možnosť pridať pätičku */ }
      });

      // Súhrn na konci
      const totalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(11);
      const totalTextContent = totalSalaryDiv.innerHTML
        .replace(/<br\s*\/?>/gi, '\n') // Nahraď <br> za nový riadok
        .replace(/<\/?strong>/gi, '') // Odstráň <strong> tagy
        .replace(/ /g, ' ')     // Nahraď   medzerou
        .replace(/€/g, ' EUR');       // Nahraď € symbolom EUR
      doc.text(totalTextContent, 14, totalY);

      // Uloženie PDF
      const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane';
      doc.save(`Vykaz_prace_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`);
    }

    window.sendPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        try {
            doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
            doc.setFont('Roboto');
        } catch (e) { doc.setFont('helvetica', 'normal'); }

        doc.setFontSize(16); doc.text(`Záznam dochádzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22);
        doc.setFontSize(12); doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30);
        const tableData = []; const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const dayName = getDayName(currentYear, currentMonth, i);
            const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
            // Zahrň len riadky s časovými údajmi alebo prestávkou
            if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) {
                tableData.push([`${i}. ${dayName}`, startTime, endTime, breakTime || '0']);
            }
        }
        doc.autoTable({
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)']], body: tableData, startY: 38, theme: 'grid',
            styles: { font: doc.getFont().fontName, fontSize: 10, cellPadding: 3, valign: 'middle' },
            headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold', fontSize: 11, halign: 'center' },
            alternateRowStyles: { fillColor: [245, 245, 245] },
            columnStyles: { 0: { cellWidth: 50, halign: 'left' }, 1: { cellWidth: 40, halign: 'center' }, 2: { cellWidth: 40, halign: 'center' }, 3: { cellWidth: 40, halign: 'center' } }
        });
        try {
            const pdfBlob = doc.output('blob');
            const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane';
            const pdfFileName = `Dochadzka_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`;
            const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                navigator.share({ files: [pdfFile], title: `Dochádzka ${getMonthName(currentMonth)} ${currentYear}`, text: `Záznam dochádzky pre ${employeeName} za ${getMonthName(currentMonth)} ${currentYear}.` })
                .then(() => console.log('PDF (dochádzka) zdieľané'))
                .catch(error => { if (error.name !== 'AbortError') { console.error('Chyba zdieľania:', error); showErrorNotification('Chyba pri zdieľaní PDF: ' + error.message); } else { console.log('Zdieľanie zrušené'); } });
            } else { showErrorNotification('Zdieľanie súborov nie je podporované.'); doc.save(pdfFileName); }
        } catch (error) { console.error('Chyba generovania PDF na zdieľanie:', error); showErrorNotification('Chyba pri príprave PDF: ' + error.message); }
    }

    window.createBackup = function() {
      // Získaj aktuálne dáta z UI (najistejší spôsob)
      const backupData = collectCurrentData();
      const key = `workData-${currentYear}-${currentMonth}`; // Pre kontrolu, či vôbec máme čo zálohovať

      if (localStorage.getItem(key) || backupData.data.some(d => d.start || d.end || d.breakTime || d.note)) { // Zálohuj, ak sú dáta v LS alebo aspoň nejaký záznam v UI
          try {
              const ws_data = [
                  // Hlavička
                  ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Poznámka" /*, "Hrubá Mzda (€)", "Čistá Mzda (€)" */] // Mzdy sa neukladajú, rátajú sa
              ];
              if (backupData.data && Array.isArray(backupData.data)) {
                  const daysInMonth = getDaysInMonth(currentMonth);
                  const dataToExport = backupData.data.slice(0, daysInMonth);
                  dataToExport.forEach((row, index) => {
                      const dayNum = index + 1;
                      const dayName = getDayName(currentYear, currentMonth, dayNum);
                      ws_data.push([
                          `${dayNum}. ${dayName}`,
                          row.start || "", row.end || "", row.breakTime || "",
                          row.note || "",
                          // row.gross ? parseFloat(row.gross) : 0, // Už neukladáme
                          // row.net ? parseFloat(row.net) : 0   // Už neukladáme
                      ]);
                  });
              }
              // Pridanie nastavení
              ws_data.push([]); ws_data.push(["Nastavenia:", "Hodnota"]);
              ws_data.push(["Hodinová mzda", backupData.hourlyWage]);
              ws_data.push(["Daňové percento (%)", backupData.taxRate * 100]);
              ws_data.push(["Meno pracovníka", backupData.employeeName]);
              ws_data.push(["Počet desatinných miest", backupData.decimalPlaces]);
              ws_data.push(["Posledná aktualizácia", backupData.lastUpdated ? new Date(backupData.lastUpdated).toLocaleString('sk-SK') : "Neznáma"]);

              const wb = XLSX.utils.book_new();
              const ws = XLSX.utils.aoa_to_sheet(ws_data);
              // Formáty pre čas a prestávku
              const timeFormat = "hh:mm"; const breakFormat = "0.0";
              const dataEndRow = (backupData.data ? backupData.data.length : 0) + 1; // +1 kvôli hlavičke
              for (let R = 1; R < dataEndRow; ++R) { // Riadky od 1 (po hlavičke)
                  // Stĺpce B (Príchod) a C (Odchod)
                  if(ws[XLSX.utils.encode_cell({c:1, r:R})]) ws[XLSX.utils.encode_cell({c:1, r:R})].z = timeFormat;
                  if(ws[XLSX.utils.encode_cell({c:2, r:R})]) ws[XLSX.utils.encode_cell({c:2, r:R})].z = timeFormat;
                  // Stĺpec D (Prestávka)
                  if(ws[XLSX.utils.encode_cell({c:3, r:R})]) ws[XLSX.utils.encode_cell({c:3, r:R})].z = breakFormat;
              }
              // Šírky stĺpcov
              ws['!cols'] = [ { wch: 12 }, { wch: 8 }, { wch: 8 }, { wch: 10 }, { wch: 25 } /*, { wch: 14 }, { wch: 14 } */ ]; // Poznámka širšia
              const settingsRowIndex = ws_data.findIndex(row => row[0] === "Nastavenia:");
              if (settingsRowIndex !== -1) { ws['!cols'][0].wch = Math.max(ws['!cols'][0].wch, 25); } // Rozšír prvý stĺpec pre nastavenia

              XLSX.utils.book_append_sheet(wb, ws, `Výkaz ${getMonthName(currentMonth)}`);
              const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane';
              XLSX.writeFile(wb, `Zaloha_BrunoCalc_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`);
              showSaveNotification('Záloha bola úspešne vytvorená.');
          } catch(error) {
              console.error('Chyba pri vytváraní zálohy:', error);
              showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message);
          }
      } else {
          showErrorNotification('Nie sú dostupné žiadne dáta na zálohu pre tento mesiac.');
      }
    };
    window.restoreBackup = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: false, cellNF: true }); // cellDates: false - spracujeme formátovanie manuálne
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    // Získaj dáta ako pole polí, zachovaj formátovanie z Excelu
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });

                    const headerRowIndex = rows.findIndex(row => row && row[0]?.toString().toLowerCase().includes("deň"));
                    if (headerRowIndex === -1) throw new Error("Hlavička tabuľky ('Deň', ...) nebola nájdená.");

                    const header = rows[headerRowIndex];
                    // Nájdi indexy stĺpcov
                    const dayIndex = header.findIndex(h => h?.toString().toLowerCase().includes("deň"));
                    const startIndex = header.findIndex(h => h?.toString().toLowerCase().includes("príchod"));
                    const endIndex = header.findIndex(h => h?.toString().toLowerCase().includes("odchod"));
                    const breakIndex = header.findIndex(h => h?.toString().toLowerCase().includes("prestávka"));
                    const noteIndex = header.findIndex(h => h?.toString().toLowerCase().includes("poznámka")); // Poznámka je voliteľná

                    if (dayIndex === -1 || startIndex === -1 || endIndex === -1 || breakIndex === -1) {
                        throw new Error("Nepodarilo sa nájsť povinné stĺpce: Deň, Príchod, Odchod, Prestávka.");
                    }

                    let dataArray = []; let settings = {}; let i = headerRowIndex + 1;

                    // Načítanie dát riadkov
                    for (; i < rows.length; i++) {
                        const row = rows[i];
                        // Zastav, ak riadok nezačína číslom dňa alebo je prázdny/nevalidný
                        if (!row || row.length === 0 || !(row[dayIndex]?.toString().match(/^\d+\./i))) { break; }

                        // Získaj hodnoty buniek a ich formáty pre čas
                        const startCell = ws[XLSX.utils.encode_cell({c:startIndex, r:i})];
                        const endCell = ws[XLSX.utils.encode_cell({c:endIndex, r:i})];
                        const breakCell = ws[XLSX.utils.encode_cell({c:breakIndex, r:i})];

                        let startTimeStr = startCell?.w || startCell?.v?.toString() || ""; // Preferuj formátovaný text (.w), inak hodnotu (.v)
                        let endTimeStr = endCell?.w || endCell?.v?.toString() || "";
                        let breakTimeStr = breakCell?.w || breakCell?.v?.toString() || "";

                        // Konverzia Excel času (ak je číslo) na HH:MM
                        if (startCell?.t === 'n' && startCell.z && startCell.z.includes('h')) { startTimeStr = XLSX.SSF.format('hh:mm', startCell.v); }
                        if (endCell?.t === 'n' && endCell.z && endCell.z.includes('h')) { endTimeStr = XLSX.SSF.format('hh:mm', endCell.v); }

                        dataArray.push({
                            start: startTimeStr,
                            end: endTimeStr,
                            breakTime: breakTimeStr.replace(',', '.'), // Nahraď desatinnú čiarku bodkou
                            note: (noteIndex !== -1 && row[noteIndex] !== undefined) ? row[noteIndex].toString() : "",
                            // gross a net sa prepočítajú pri aplikovaní dát
                        });
                    }

                    // Načítanie nastavení
                    for (; i < rows.length; i++) {
                         const row = rows[i];
                         if (row && row.length > 1 && row[0] && typeof row[0] === 'string') {
                             const key = row[0].toString().trim().toLowerCase();
                             const value = row[1]?.toString().trim() || "";
                             if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined;
                             else if (key.includes("daňové percento")) settings.taxRate = (parseFloat(value.replace(',', '.').replace('%', '')) || undefined) / 100;
                             else if (key.includes("meno pracovníka")) settings.employeeName = value || undefined;
                             else if (key.includes("počet desatinných miest")) settings.decimalPlaces = parseInt(value) || undefined;
                         }
                    }

                    // Zostavenie finálneho objektu pre uloženie a aplikáciu
                    const backupData = {
                         data: dataArray,
                         // Použi hodnoty z backupu, ak sú platné, inak použi aktuálne globálne hodnoty ako fallback
                         hourlyWage: settings.hourlyWage !== undefined ? settings.hourlyWage : hourlyWage,
                         taxRate: settings.taxRate !== undefined ? settings.taxRate : taxRate,
                         employeeName: settings.employeeName !== undefined ? settings.employeeName : employeeName,
                         decimalPlaces: settings.decimalPlaces !== undefined ? settings.decimalPlaces : decimalPlaces,
                         lastUpdated: new Date().toISOString() // Čas obnovy
                    };

                    if (!confirm(`Načítaná záloha obsahuje ${dataArray.length} dní. Naozaj chcete prepísať aktuálne dáta pre ${getMonthName(currentMonth)} ${currentYear}?`)) { return; }

                    // Uloženie a aplikovanie dát
                    const localKey = `workData-${currentYear}-${currentMonth}`;
                    const backupDataString = JSON.stringify(backupData);
                    localStorage.setItem(localKey, backupDataString);
                    localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); // Odstránime pending flag
                    parseAndApplyData(backupDataString); // Aplikuje dáta vrátane poznámok a nastavení
                    showSaveNotification('Záloha bola úspešne obnovená a načítaná.');

                    // ZMENA: Prepočítať súčty a aktualizovať pozdrav po obnovení zálohy
                    updateGreeting();
                    calculateTotal();

                    // Synchronizácia s cloudom, ak sme prihlásení a online
                    if (currentUser && isOnline()) {
                         saveToFirestore(); // Odošli obnovené dáta do Firestore
                    }
                } catch (error) {
                    console.error('Chyba pri načítavaní zálohy:', error);
                    showErrorNotification('Chyba pri načítavaní zálohy: ' + error.message);
                }
            };
            reader.onerror = function() { showErrorNotification('Chyba pri čítaní súboru.'); }
            reader.readAsArrayBuffer(file);
        };
        input.click();
    };


    // --- Správa nastavení ---
    window.changeDecimalPlaces = function() {
        decimalPlaces = parseInt(decimalPlacesSelect.value);
        localStorage.setItem('decimalPlaces', decimalPlaces);
        // Prepočítaj zobrazenie v tabuľke a súčty
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); } }
        calculateAndUpdateTotals(); // Uloží aj nové nastavenie počtu miest
     }
    window.updateEmployeeName = function() {
        employeeName = employeeNameInput.value.trim();
        localStorage.setItem('employeeName', employeeName);
        updateGreeting(); // ZMENA: Aktualizuj pozdrav
        calculateAndUpdateTotals(); // Uloží aj nové meno
    }
    window.updateSettings = function() { // Mzda a Daň
        const newHourlyWage = parseFloat(hourlyWageInput.value);
        const newTaxRatePercent = parseFloat(taxRateInput.value);

        // Validácia a aktualizácia hodinovej mzdy
        if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
             hourlyWage = newHourlyWage;
        } else {
             hourlyWageInput.value = hourlyWage; // Vráť na pôvodnú hodnotu pri neplatnom vstupe
        }
        // Validácia a aktualizácia daňového percenta
        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) {
             taxRate = newTaxRatePercent / 100; // Ulož ako desatinné číslo
        } else {
             taxRateInput.value = (taxRate * 100).toFixed(1); // Vráť na pôvodnú hodnotu
        }

        // Ulož aktuálne platné hodnoty do LS
        localStorage.setItem('hourlyWage', hourlyWage);
        localStorage.setItem('taxRate', taxRate);

        // Prepočítaj všetky riadky a súčty s novými sadzbami
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
             if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); }
        }
        calculateAndUpdateTotals(); // Uloží aj nové nastavenia mzdy/dane
    }
    window.changeMonth = function() {
        const oldMonth = currentMonth;
        currentMonth = parseInt(monthSelect.value);
        console.log(`Changing month from ${getMonthName(oldMonth)} to ${getMonthName(currentMonth)}`);
        updateUI(); // updateUI sa postará o odhlásenie starého a prihlásenie nového listenera/načítanie LS
    }
    window.changeYear = function() {
        const oldYear = currentYear;
        currentYear = parseInt(yearSelect.value);
        console.log(`Changing year from ${oldYear} to ${currentYear}`);
        updateUI(); // updateUI sa postará o odhlásenie starého a prihlásenie nového listenera/načítanie LS
    }
    function getDaysInMonth(month) {
        if (month < 0 || month > 11) return 31; // Fallback pre neplatný mesiac
        // Správne získanie počtu dní v mesiaci pre daný rok
        return new Date(currentYear, month + 1, 0).getDate();
    }

    // --- Inicializácia ---
    // Listener pre zmeny stavu autentifikácie
    onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed. User:', user ? user.email : 'None');
        currentUser = user;
        updateUI(); // Kľúčová funkcia pre aktualizáciu UI a dátového listenera
    });

  </script>

  <script>
    // Service Worker registrácia
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
          .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
          .catch(error => { console.error('ServiceWorker registration failed: ', error); });
      });
    }
  </script>
</body>
</html>
