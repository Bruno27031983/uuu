<!DOCTYPE html>
<html lang="sk" data-theme="light"> <!-- Pridan√Ω data-theme atrib√∫t -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Content Security Policy - ochrana proti XSS a neautorizovan√Ωm zdrojom -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com https://www.gstatic.com https://apis.google.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob: https:;
    connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com wss://*.firebaseio.com;
    frame-src 'self' https://*.firebaseapp.com https://www.google.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <title>Bruno's Calculator Pro</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <meta name="theme-color" content="#7c3aed"/> <!-- Bude dynamicky menen√© JS pre tmav√Ω re≈æim -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js" defer></script>

  <style>
    :root {
      --primary-bg-color: #f0f2f5;
      --secondary-bg-color: #ffffff;
      --primary-text-color: #1f2937;
      --secondary-text-color: #4b5563;
      --input-bg-color: #fefcbf; /* ≈Ωlt√° pre lep≈°iu viditeƒænos≈• vstupov */
      --input-note-bg-color: #e0f2fe; /* Svetlo modr√° pre pozn√°mky */
      --input-project-bg-color: #e0fef2; /* Svetlo zelen√° pre projekty */
      --table-header-bg-color: #f9fafb;
      --table-border-color: #e5e7eb;
      --current-day-bg-color: #7c3aed;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #2563eb;
      --btn-primary-hover-bg: #1d4ed8;
      --btn-secondary-bg: #7c3aed; /* Fialov√° pre sekund√°rne akcie */
      --btn-secondary-hover-bg: #6d28d9;
      --btn-danger-bg: #dc2626;
      --btn-danger-hover-bg: #b91c1c;
      --btn-warning-bg: #f59e0b;
      --btn-warning-hover-bg: #d97706;
      --btn-highlight-bg: #f59e0b; /* Oran≈æov√° pre upozornenia */
      --btn-text-color: #ffffff;
      --total-salary-bg: #eff6ff;
      --link-color: #2563eb;
      --link-hover-color: #1d4ed8;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --box-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --base-font-size: 16px;
      --focus-outline-color: var(--btn-primary-bg);
      --transition-speed: 0.2s;
      --theme-color-meta: #7c3aed; /* Default theme color for meta tag */
    }

    html[data-theme='dark'] {
      --primary-bg-color: #111827; /* Tmavo≈°ed√° skoro ƒçierna */
      --secondary-bg-color: #1f2937; /* Tmavo≈°ed√° */
      --primary-text-color: #f3f4f6; /* Veƒæmi svetlo ≈°ed√° */
      --secondary-text-color: #9ca3af; /* Svetlo ≈°ed√° */
      --input-bg-color: #374151; /* Tmav≈°ia ≈°ed√° pre vstupy */
      --input-note-bg-color: #2c3a4b; /* Tmav≈°ia modro≈°ed√° pre pozn√°mky */
      --input-project-bg-color: #2c4b3a; /* Tmav≈°ia zeleno≈°ed√° pre projekty */
      --table-header-bg-color: #374151;
      --table-border-color: #4b5563;
      --current-day-bg-color: #8b5cf6; /* Svetlej≈°ia fialov√° pre kontrast */
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #3b82f6; /* Svetlej≈°ia modr√° */
      --btn-primary-hover-bg: #2563eb;
      --btn-secondary-bg: #8b5cf6; /* Svetlej≈°ia fialov√° */
      --btn-secondary-hover-bg: #7c3aed;
      --btn-danger-bg: #ef4444; /* Svetlej≈°ia ƒçerven√° */
      --btn-danger-hover-bg: #dc2626;
      --btn-warning-bg: #f97316; /* Svetlej≈°ia oran≈æov√° */
      --btn-warning-hover-bg: #ea580c;
      --btn-highlight-bg: #f97316;
      --total-salary-bg: #374151;
      --link-color: #60a5fa; /* Svetlej≈°ia modr√° pre odkazy */
      --link-hover-color: #3b82f6;
      --focus-outline-color: var(--btn-primary-bg);
      --theme-color-meta: #1f2937;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2') format('woff2');
      font-weight: 400 700;
      font-style: normal;
      font-display: swap;
    }

    html { font-size: var(--base-font-size); scroll-behavior: smooth; }
    body {
      font-family: var(--font-family); line-height: 1.6; margin: 0; padding: 12px;
      background-color: var(--primary-bg-color); color: var(--primary-text-color);
      font-size: 0.92rem; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    #app-loader {
      display: flex; justify-content: center; align-items: center; height: 100vh;
      font-size: 1.2em; color: var(--secondary-text-color); text-align: center;
      flex-direction: column; background-color: var(--primary-bg-color);
    }
    #app-loader p { margin: 5px 0; }
    #app-loader .loader-emoji { font-size: 2em; margin-bottom: 10px; }

    .container {
      max-width: 1600px; margin: 20px auto; background: var(--secondary-bg-color);
      padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); position: relative;
      transition: background-color var(--transition-speed);
    }
    h1 { text-align: center; font-size: 2rem; color: var(--primary-text-color); margin-bottom: 10px; font-weight: 700; }
    h1#mainTitle {
      background: linear-gradient(45deg, #7c3aed, #db2777, #f59e0b);
      -webkit-background-clip: text; background-clip: text; color: transparent; padding-bottom: 3px;
    }
    h2 {
      text-align: center; color: var(--secondary-text-color); margin-top: -5px;
      font-size: 1rem; font-weight: 500; margin-bottom: 20px;
    }
    fieldset { border: 1px solid var(--table-border-color); border-radius: var(--border-radius); padding: 15px; margin-bottom: 20px; }
    legend { font-weight: 600; color: var(--primary-text-color); padding: 0 8px; font-size: 0.95rem; }
    *:focus-visible { outline: 3px solid var(--focus-outline-color); outline-offset: 2px; box-shadow: 0 0 0 5px rgba(37, 99, 235, 0.2); }
    input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible { outline: 2px solid var(--focus-outline-color); outline-offset: 1px; }
    
    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
    #themeToggleBtn { font-size: 1.3rem; padding: 6px 10px; line-height: 1; background-color: var(--secondary-bg-color); color: var(--primary-text-color); border: 1px solid var(--table-border-color); }
    #themeToggleBtn:hover { background-color: var(--primary-bg-color); }


    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > button#toggleSettingsBtn { margin: 0; }
    .settings > div { flex: 1 1 220px; }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%; margin-bottom: 10px; background-color: var(--secondary-bg-color); color: var(--primary-text-color);
      border: 1px solid var(--table-border-color); text-align: left; padding: 10px 15px; font-size: 0.95rem;
      font-weight: 500; cursor: pointer; border-radius: var(--border-radius);
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
    }
    .settings > button#toggleSettingsBtn:hover { background-color: var(--primary-bg-color); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
    .settings label { display: block; margin-bottom: 5px; font-size: 0.875rem; font-weight: 500; color: var(--secondary-text-color); }
    #settings-collapsible-content {
      display: flex; flex-wrap: wrap; width: 100%; max-height: 0; opacity: 0; overflow: hidden;
      transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out; gap: 10px 12px;
    }
    #settings-collapsible-content.visible { max-height: 800px; opacity: 1; margin-top: 10px; } /* Zv√Ω≈°en√° max-height pre nov√© pole */
    #settings-collapsible-content > fieldset { display: contents; }
    #settings-collapsible-content > fieldset > div { flex: 1 1 220px; margin: 0; }
    
    .table-container {
      overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;
      border: 1px solid var(--table-border-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 10px 12px; border: 1px solid var(--table-border-color); text-align: left;
      font-size: 0.875rem; vertical-align: middle; transition: background-color var(--transition-speed);
    }
    thead tr { border-bottom: 2px solid #d1d5db; }
    th { background-color: var(--table-header-bg-color); font-weight: 600; color: var(--primary-text-color); position: sticky; top: 0; z-index: 10; }
    tr.weekend-day td:first-child { background-color: #f3f4f6; font-style: normal; color: var(--secondary-text-color); }
    html[data-theme='dark'] tr.weekend-day td:first-child { background-color: #374151; color: var(--secondary-text-color); }

    td .time-input-wrapper { display: flex; align-items: center; gap: 5px; }
    td .time-input-wrapper input[type="tel"] { flex-grow: 1; min-width: 65px; padding: 8px 6px; font-size: 0.875rem; }
    td .time-input-wrapper .time-btn {
      font-size: 1.1rem; cursor: pointer; padding: 4px 5px; border: 1px solid transparent;
      border-radius: var(--border-radius); line-height: 1; background: none; color: var(--secondary-text-color);
      user-select: none; transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
    }
    td .time-input-wrapper .time-btn:hover { background-color: #e5e7eb; border-color: #d1d5db; color: var(--primary-text-color); }
    html[data-theme='dark'] td .time-input-wrapper .time-btn:hover { background-color: #4b5563; border-color: #6b7280; color: var(--primary-text-color); }

    /* √öprava ≈°√≠rok stƒ∫pcov pre nov√Ω stƒ∫pec "Projekt" */
    th:nth-child(1), td:nth-child(1) { width: 95px;} /* De≈à */
    th:nth-child(2), td:nth-child(2) { width: 105px;} /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { width: 105px;} /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 85px;} /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { width: 110px;} /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 150px; width: auto; } /* Projekt - nov√Ω stƒ∫pec */
    th:nth-child(7), td:nth-child(7) { min-width: 200px; width: auto; } /* Pozn√°mka */
    th:nth-child(8), td:nth-child(8) { width: 90px;} /* Hrub√° Mzda */
    th:nth-child(9), td:nth-child(9) { width: 90px;} /* ƒåist√° Mzda */
    th:nth-child(10), td:nth-child(10) { width: 45px; text-align: center;} /* Akcie */

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%; padding: 9px 12px; box-sizing: border-box; background-color: var(--input-bg-color);
      font-size: 0.9rem; border: 1px solid var(--table-border-color); border-radius: var(--border-radius); vertical-align: middle;
      font-family: var(--font-family); transition: border-color var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed); color: var(--primary-text-color);
    }
    input[type="tel"]:focus, input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
        border-color: var(--focus-outline-color); box-shadow: 0 0 0 1px var(--focus-outline-color);
    }
    input[type="tel"].invalid-time, input[type="number"].invalid-value, input[type="text"].invalid-value {
        border-color: var(--btn-danger-bg) !important; box-shadow: 0 0 0 1px var(--btn-danger-bg) !important;
    }
    td input[type="number"] { min-width: 60px; }
    td input[type="text"].project-input { background-color: var(--input-project-bg-color); } /* ≈†pecifick√© pozadie pre projekt */
    td input[type="number"][readonly] {
      background-color: var(--table-header-bg-color) !important; /* D√¥le≈æit√© pre tmav√Ω re≈æim */
      border: none; padding-left: 2px; padding-right: 2px;
      color: var(--secondary-text-color); font-weight: 500;
    }
    textarea[id^="note-"] {
      background-color: var(--input-note-bg-color); resize: vertical; min-height: 38px; line-height: 1.5;
      overflow-y: hidden; white-space: pre-wrap; word-wrap: break-word;
    }
    .btn-container { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 25px; gap: 12px; }
    .btn {
      flex: 0 1 auto; padding: 10px 20px; color: var(--btn-text-color); border: none;
      border-radius: var(--border-radius); cursor: pointer; font-size: 0.92rem; font-weight: 500;
      margin: 0; transition: background-color var(--transition-speed) ease, transform 0.1s ease, box-shadow var(--transition-speed) ease;
      text-align: center; box-shadow: var(--box-shadow);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 7px 10px -3px rgba(0,0,0,0.1), 0 4px 5px -2px rgba(0,0,0,0.06); }
    .btn:active { transform: translateY(0px); box-shadow: var(--box-shadow); }
    .btn.is-loading { pointer-events: none; position: relative; }
    .btn.is-loading::before {
        content: ""; position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.6);
        border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    html[data-theme='dark'] .btn.is-loading::before {
        border: 2px solid rgba(255,255,255,0.4);
        border-top-color: var(--primary-text-color);
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    .reset-btn { background-color: var(--btn-danger-bg); }
    .reset-btn:hover { background-color: var(--btn-danger-hover-bg); }
    .btn.warning-btn { background-color: var(--btn-warning-bg); color: var(--primary-text-color); }
    html[data-theme='dark'] .btn.warning-btn { color: var(--primary-bg-color); } /* Lep≈°√≠ kontrast pre warning v tmavom re≈æime */
    .btn.warning-btn:hover { background-color: var(--btn-warning-hover-bg); }
    .export-btn { background-color: var(--btn-primary-bg); }
    .export-btn:hover { background-color: var(--btn-primary-hover-bg); }
    .backup-btn { background-color: var(--btn-secondary-bg); }
    .backup-btn:hover { background-color: var(--btn-secondary-hover-bg); }
    #totalSalary {
      font-size: 1rem; font-weight: 500; text-align: center; margin-top: 25px; padding: 15px;
      background-color: var(--total-salary-bg); border-radius: var(--border-radius); line-height: 1.8;
      color: var(--primary-text-color); box-shadow: var(--box-shadow);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    #totalSalary .goal-progress { font-size: 0.9em; margin-top: 8px; color: var(--secondary-text-color); }
    #totalSalary .goal-progress.good { color: #10b981; } /* Zelen√° pre dobr√Ω progres */
    #totalSalary .goal-progress.medium { color: #f59e0b; } /* Oran≈æov√° pre stredn√Ω progres */
    #totalSalary .goal-progress.low { color: #ef4444; } /* ƒåerven√° pre n√≠zky progres */
    html[data-theme='dark'] #totalSalary .goal-progress.good { color: #34d399; }
    html[data-theme='dark'] #totalSalary .goal-progress.medium { color: #f97316; }
    html[data-theme='dark'] #totalSalary .goal-progress.low { color: #f87171; }


    #localStorageIndicator { font-size: 0.8rem; text-align: right; margin-top: 8px; color: #9ca3af; }
    html[data-theme='dark'] #localStorageIndicator { color: var(--secondary-text-color); }

    .current-day { background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color); }
    .current-day td, .current-day th {
        background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color) !important;
        border-color: rgba(255,255,255,0.3) !important;
    }
    .current-day input, .current-day select, .current-day textarea, .current-day input.project-input {
      background-color: rgba(255,255,255,0.15) !important; color: var(--current-day-text-color) !important;
      border-color: rgba(255,255,255,0.4) !important;
    }
    .current-day input::placeholder, .current-day textarea::placeholder { color: rgba(255,255,255,0.7); }
    .current-day textarea[id^="note-"] { background-color: rgba(255,255,255,0.2) !important; }
    .current-day input[id^="project-"] { background-color: rgba(200,255,200,0.2) !important; } /* Svetlej≈°ia zelen√° pre projekt v current-day */
    .current-day .time-btn { color: var(--current-day-text-color) !important; }
    .current-day .time-btn:hover { background-color: rgba(255,255,255,0.25) !important; border-color: rgba(255,255,255,0.5) !important; }

    #auth-container { margin-bottom: 20px; }
    #auth-container fieldset { width: 100%; max-width: 380px; margin-left:auto; margin-right:auto; }
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
      width: 100%; margin: 8px 0; display: block; padding: 10px; font-size: 0.95rem; box-sizing: border-box;
    }
    #login-form .btn {
      width: 100%; margin: 8px 0 0 0; padding: 10px 15px; font-size: 0.95rem;
      flex-grow: 0; flex-shrink: 0; flex-basis: auto; min-width: auto; max-width: none;
    }
    #login-form .btn + .btn { margin-top: 10px; }
    #login-form a { margin-top: 15px; display: block; font-size: 0.9rem; color: var(--link-color); text-decoration: none; }
    #login-form a:hover { text-decoration: underline; color: var(--link-hover-color); }
    #user-info { align-items: center; }
    @media (max-width: 768px) {
      body { padding: 8px; font-size: 0.9rem; }
      .container { padding: 15px; margin: 10px auto; }
      .header-controls { justify-content: center; }
      #themeToggleBtn { order: -1; /* Posunie tlaƒçidlo na zaƒçiatok v mobilnom zobrazen√≠ */ }
      h1 { font-size: 1.8rem; } h2 { font-size: 0.95rem; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; }
      #settings-collapsible-content.visible { max-height: 950px; } /* Zv√Ω≈°en√° pre mobil */
      th, td { padding: 8px; font-size: 0.85rem; }
      textarea[id^="note-"] { min-height: 40px; }
      .btn-container .btn { font-size: 0.9rem; padding: 12px 18px; margin: 5px 0; min-width: 180px; max-width: 300px; }
      .btn-container .btn[title*="Vymaza≈• mesiac"] { max-width: 240px; }
      #login-form input[type="email"], #login-form input[type="password"] { font-size: 0.9rem; padding: 10px;}
      #login-form .btn { font-size: 0.92rem !important; padding-top: 11px !important; padding-bottom: 11px !important;}
      #login-form a { margin-top: 18px !important; font-size: 0.88rem; }
    }
    @media (max-width: 480px) {
      body { padding: 6px; } .container { padding: 10px; }
      h1 { font-size: 1.6rem; } h2 { font-size: 0.9rem; }
      th, td { padding: 7px; font-size: 0.82rem; }
      textarea[id^="note-"] { min-height: 42px; }
      #settings-collapsible-content.visible { max-height: 1100px; } /* Zv√Ω≈°en√° pre mobil */
      .btn-container .btn { font-size: 0.88rem; padding: 11px 16px; min-width: 100%; max-width: 280px; }
      #login-form input[type="email"], #login-form input[type="password"],
      #login-form .btn { font-size: 0.88rem !important; }
    }
    #saveNotification, #errorNotification, #warningNotification {
        display: none; position: fixed; bottom: 25px; right: 25px; padding: 15px 22px;
        border-radius: var(--border-radius); font-size: 0.95rem; box-shadow: var(--box-shadow-lg);
        z-index: 10000; opacity: 0; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        transform: translateY(30px); font-weight: 500;
    }
    #saveNotification.show, #errorNotification.show, #warningNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification { background-color: var(--btn-primary-bg); color: white; }
    #errorNotification { background-color: var(--btn-danger-bg); color: white; }
    #warningNotification { background-color: var(--btn-highlight-bg); color: var(--primary-text-color); }
    html[data-theme='dark'] #warningNotification { color: var(--primary-bg-color); }

    @media print {
      /* Print styles exist, no major changes needed for new features unless specifically requested */
      /* Project column will be printed as a normal text column */
      /* Dark mode styles should not affect print */
      html[data-theme='dark'] body { background-color: #fff !important; color: #000 !important; }
      html[data-theme='dark'] th, html[data-theme='dark'] td { background-color: #fff !important; color: #000 !important; border-color: #ccc !important; }
      /* Hide theme toggle button in print */
      #themeToggleBtn { display: none !important; }
      /* Ensure project input is visible */
      td input[type="text"].project-input {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; text-align: left; width: auto !important; font-size: 9pt !important;
      }
    }
  </style>
</head>
<body>
  <div id="app-loader">
    <p class="loader-emoji">üßÆ</p>
    <p>Bruno's Calculator Pro+</p> <!-- Mal√° zmena n√°zvu -->
    <p style="font-size: 0.8em;">Naƒç√≠tavam aplik√°ciu...</p>
  </div>

  <div class="container" style="display: none;">
    <div id="auth-container">
      <fieldset id="login-fieldset">
        <legend>Prihl√°senie / Registr√°cia</legend>
        <div id="login-form">
          <input type="email" id="email" placeholder="Email" aria-label="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Heslo" aria-label="Heslo" autocomplete="current-password">
          <button class="btn export-btn" onclick="loginUser()">Prihl√°si≈• sa</button>
          <button class="btn export-btn" onclick="registerUser()">Registrova≈•</button>
          <a href="#" onclick="resetUserPassword(); return false;">Zabudli ste heslo?</a>
        </div>
      </fieldset>
      <div class="header-controls"> <!-- Kontajner pre user-info a theme toggle -->
        <div id="user-info" style="display: none; justify-content: flex-start; align-items: center; gap: 15px; margin-top:10px; flex-grow: 1;">
            <span id="user-email" style="font-weight:500;"></span>
            <button class="btn reset-btn" onclick="logoutUser()" style="padding: 8px 15px; font-size: 0.85rem; margin:0;">Odhl√°si≈• sa</button>
        </div>
        <button id="themeToggleBtn" class="btn" title="Prepn√∫≈• svetl√Ω/tmav√Ω re≈æim" style="margin-left: auto; background-color: var(--btn-secondary-bg); padding: 8px 12px;">
            <span id="themeIcon">üåô</span> <!-- Ikona sa bude meni≈• JS -->
        </button>
      </div>
    </div>

    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <div class="settings">
        <button id="toggleSettingsBtn" class="btn" aria-expanded="false" aria-controls="settings-collapsible-content">Zobrazi≈• nastavenia aplik√°cie ‚ñº</button>
        <div id="settings-collapsible-content">
            <fieldset>
                <legend>Z√°kladn√© nastavenia</legend>
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="hourlyWageInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxOrGoalBlur(this)">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="text" inputmode="decimal" id="taxRateInput" oninput="handleNumericInput(this)" onblur="handleWageOrTaxOrGoalBlur(this)">
                </div>
                <div> <!-- NOV√â: Mesaƒçn√Ω cieƒæ -->
                    <label for="monthlyGoalInput">Mesaƒçn√Ω cieƒæ z√°robku (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="monthlyGoalInput" placeholder="Napr. 1500" oninput="handleNumericInput(this)" onblur="handleWageOrTaxOrGoalBlur(this)">
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                      <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                    </select>
                </div>
            </fieldset>
             <fieldset>
                <legend>Navig√°cia v ƒçase</legend>
                <div>
                    <label for="monthSelect">Mesiac:</label>
                    <select id="monthSelect" onchange="changeMonth()"></select>
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Projekt/√öloha</th> <!-- NOV√ù STƒπPEC -->
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite">V√Ωpoƒçet celkovej mzdy...</div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (s pozn.)</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (XLSX)</button>
        <button class="btn backup-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (XLSX)</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠ta≈• z Cloudu</button>
        <button class="btn warning-btn" onclick="clearMonthData()" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• Mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©.</div>
  <div id="errorNotification" role="alert" aria-live="assertive">Nastala chyba.</div>
  <div id="warningNotification" role="alert" aria-live="assertive">Upozornenie.</div>

  <script type="module">
    // Importy Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
        initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED,
        collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, writeBatch
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js';

    // POZN√ÅMKA: TOTO S√ö PLACEHOLDER KƒΩ√öƒåE. Nahraƒète va≈°imi skutoƒçn√Ωmi kƒæ√∫ƒçmi pre produkciu.
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };
    // POZN√ÅMKA: TOTO JE PLACEHOLDER KƒΩ√öƒå. Nahraƒète va≈°im skutoƒçn√Ωm kƒæ√∫ƒçom pre produkciu.
    const RECAPTCHA_V3_SITE_KEY ="6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v";


    const app = initializeApp(firebaseConfig);
    try {
       const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider(RECAPTCHA_V3_SITE_KEY),
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("App Check initialization failed.", e);
        showWarningNotification("Inicializ√°cia App Check zlyhala. Niektor√© funkcie m√¥≈æu by≈• obmedzen√©.");
    }
    const auth = getAuth(app);

    let db;
    try {
        db = initializeFirestore(app, {
            localCache: persistentLocalCache({ sizeBytes: CACHE_SIZE_UNLIMITED })
        });
    } catch (error) {
        console.warn("Failed to initialize Firestore with persistent cache. Falling back to in-memory cache.", error);
        showWarningNotification("Chyba pri inicializ√°cii offline √∫lo≈æiska. D√°ta nebud√∫ dostupn√© offline.");
        db = initializeFirestore(app, {}); // Fallback to default (in-memory) cache
    }

    let currentUser = null;
    let currentListenerUnsubscribe = null;

    const uiRefs = {
        workDaysTbody: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        mainTitle: document.getElementById('mainTitle'),
        subTitle: document.getElementById('subTitle'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthlyGoalInput: document.getElementById('monthlyGoalInput'), // NOV√â UI REF
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        toggleSettingsBtn: document.getElementById('toggleSettingsBtn'),
        settingsCollapsibleContent: document.getElementById('settings-collapsible-content'),
        localStorageIndicator: document.getElementById('localStorageIndicator'),
        loginForm: document.getElementById('login-form'),
        loginFieldset: document.getElementById('login-fieldset'),
        userInfo: document.getElementById('user-info'),
        userEmailSpan: document.getElementById('user-email'),
        appLoader: document.getElementById('app-loader'),
        mainContainer: document.querySelector('.container'),
        themeToggleBtn: document.getElementById('themeToggleBtn'), // NOV√â UI REF
        themeIcon: document.getElementById('themeIcon'), // NOV√â UI REF
        themeMeta: document.querySelector('meta[name="theme-color"]'), // NOV√â UI REF
    };

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    let appSettings = { // Roz≈°√≠ren√© appSettings
        decimalPlaces: 2, employeeName: '', hourlyWage: 10, taxRate: 0.02,
        theme: 'light', // NOV√â: 'light' alebo 'dark'
        monthlyEarningsGoal: null // NOV√â: cieƒæov√° suma alebo null
    };

    const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
    const DAY_NAMES_SHORT = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];
    const PENDING_SYNC_MONTHS_LS_KEY = 'pendingSyncMonthsList';

    // --- Theme Manager ---
    const ThemeManager = {
        init: () => {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                appSettings.theme = storedTheme;
            } else {
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                appSettings.theme = prefersDark ? 'dark' : 'light';
            }
            ThemeManager.applyTheme(appSettings.theme);
            uiRefs.themeToggleBtn.onclick = ThemeManager.toggleTheme;
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    appSettings.theme = e.matches ? 'dark' : 'light';
                    ThemeManager.applyTheme(appSettings.theme);
                }
            });
        },
        applyTheme: (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            uiRefs.themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            appSettings.theme = theme;
            if (uiRefs.themeMeta) {
                uiRefs.themeMeta.content = getComputedStyle(document.documentElement).getPropertyValue('--theme-color-meta').trim();
            }
        },
        toggleTheme: () => {
            const newTheme = appSettings.theme === 'light' ? 'dark' : 'light';
            ThemeManager.applyTheme(newTheme);
            saveAppSettingToLocalStorage('theme', newTheme);
            debouncedSaveAppSettingsToFirestore();
        }
    };

    async function updateAppBadge(count) {
      if ('setAppBadge' in navigator) {
        try {
          if (count > 0) { await navigator.setAppBadge(count); }
          else { await navigator.clearAppBadge(); }
        } catch (error) { console.error('Failed to set app badge:', error); }
      }
    }

    function getPendingSyncMonths() { const stored = localStorage.getItem(PENDING_SYNC_MONTHS_LS_KEY); return stored ? JSON.parse(stored) : []; }
    function savePendingSyncMonths(months) { localStorage.setItem(PENDING_SYNC_MONTHS_LS_KEY, JSON.stringify(months)); updateAppBadge(months.length); }
    function addMonthToPendingList(monthDocId) { if (!currentUser) return; let pendingMonths = getPendingSyncMonths(); if (!pendingMonths.includes(monthDocId)) { pendingMonths.push(monthDocId); savePendingSyncMonths(pendingMonths); } }
    function removeMonthFromPendingList(monthDocId) { let pendingMonths = getPendingSyncMonths(); const index = pendingMonths.indexOf(monthDocId); if (index > -1) { pendingMonths.splice(index, 1); savePendingSyncMonths(pendingMonths); } }
    function getPendingSyncCount() { if (!currentUser) return 0; return getPendingSyncMonths().length; }
    function getDaysInMonth(month, year) { return new Date(year, month + 1, 0).getDate(); }
    function getDayName(year, month, day) { return DAY_NAMES_SHORT[new Date(year, month, day).getDay()]; }
    function isWeekend(year, month, day) { const d = new Date(year, month, day).getDay(); return d === 0 || d === 6; }
    const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; };
    function isValidTimeFormat(timeString) { return typeof timeString === 'string' && /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }

    // Valid√°cia hesla - bezpeƒçnostn√© po≈æiadavky
    function validatePassword(password) {
        if (!password || password.length < 8) {
            return 'Heslo mus√≠ ma≈• aspo≈à 8 znakov.';
        }
        if (!/[A-Z]/.test(password)) {
            return 'Heslo mus√≠ obsahova≈• aspo≈à jedno veƒæk√© p√≠smeno.';
        }
        if (!/[a-z]/.test(password)) {
            return 'Heslo mus√≠ obsahova≈• aspo≈à jedno mal√© p√≠smeno.';
        }
        if (!/\d/.test(password)) {
            return 'Heslo mus√≠ obsahova≈• aspo≈à jedno ƒç√≠slo.';
        }
        // Voliteƒæn√©: kontrola ≈°peci√°lnych znakov
        // if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        //     return 'Heslo mus√≠ obsahova≈• aspo≈à jeden ≈°peci√°lny znak.';
        // }
        return null; // Heslo je platn√©
    }

    function showNotification(id, message, duration = 3500) { const notification = document.getElementById(id); if (!notification) { console.warn(`Notification element with ID '${id}' not found.`); return; } notification.textContent = message; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), duration); }
    window.showSaveNotification = (message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©.') => showNotification('saveNotification', message);
    window.showErrorNotification = (message) => showNotification('errorNotification', message, 5000);
    window.showWarningNotification = (message) => showNotification('warningNotification', message, 4500);

    function setLoadingState(button, isLoading, textParam = "Sprac√∫vam...") {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            if (!button.dataset.originalText) { button.dataset.originalText = button.textContent; }
            const spinnerSpan = document.createElement('span'); spinnerSpan.className = 'spinner'; spinnerSpan.setAttribute('role', 'status'); spinnerSpan.setAttribute('aria-hidden', 'true');
            button.textContent = ''; button.appendChild(spinnerSpan); button.appendChild(document.createTextNode(` ${textParam}`)); button.classList.add('is-loading');
        } else {
            button.disabled = false;
            if (button.dataset.originalText) { button.textContent = button.dataset.originalText; delete button.dataset.originalText; }
            else { button.textContent = textParam; }
            button.classList.remove('is-loading');
        }
    }

    function loadAppSettingsFromLocalStorage() {
        appSettings.decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        appSettings.employeeName = localStorage.getItem('employeeName') || '';
        appSettings.hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        appSettings.taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
        appSettings.theme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        appSettings.monthlyEarningsGoal = localStorage.getItem('monthlyEarningsGoal') ? parseFloat(localStorage.getItem('monthlyEarningsGoal')) : null;
    }
    function saveAppSettingToLocalStorage(key, value) { localStorage.setItem(key, value); appSettings[key] = value; }
    async function saveAppSettingsToFirestore() { if (!currentUser || !navigator.onLine) return; const userDocRef = doc(db, 'users', currentUser.uid); try { await setDoc(userDocRef, { appSettings: appSettings }, { merge: true }); } catch (error) { console.error("Error saving app settings to Firestore:", error); showErrorNotification("Nepodarilo sa ulo≈æi≈• nastavenia aplik√°cie do cloudu."); } }
    const debouncedSaveAppSettingsToFirestore = debounce(saveAppSettingsToFirestore, 1800);

    async function loadUserAppSettingsFromFirestore() {
        if (!currentUser || !navigator.onLine) return Promise.resolve(false);
        const userDocRef = doc(db, 'users', currentUser.uid);
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists() && docSnap.data().appSettings) {
                const fsSettings = docSnap.data().appSettings;
                Object.keys(appSettings).forEach(key => {
                    if (fsSettings.hasOwnProperty(key) && fsSettings[key] !== undefined) {
                        if (key === 'decimalPlaces') appSettings[key] = parseInt(fsSettings[key]);
                        else if (key === 'hourlyWage' || key === 'taxRate' || key === 'monthlyEarningsGoal') appSettings[key] = parseFloat(fsSettings[key]);
                        else if (key === 'theme' && (fsSettings[key] === 'light' || fsSettings[key] === 'dark')) appSettings[key] = fsSettings[key];
                        else appSettings[key] = fsSettings[key];
                    }
                });
                if (isNaN(appSettings.monthlyEarningsGoal)) appSettings.monthlyEarningsGoal = null;
                Object.entries(appSettings).forEach(([key, value]) => { if (value !== undefined) localStorage.setItem(key, value); });
                updateSettingsUIInputs();
                ThemeManager.applyTheme(appSettings.theme);
                return true;
            }
        } catch (error) { console.error("Error loading app settings from Firestore:", error); showErrorNotification("Chyba naƒç√≠tania nastaven√≠ aplik√°cie z cloudu."); }
        return false;
    }

    function updateSettingsUIInputs() {
        uiRefs.decimalPlacesSelect.value = appSettings.decimalPlaces;
        uiRefs.employeeNameInput.value = appSettings.employeeName;
        const wage = typeof appSettings.hourlyWage === 'number' ? appSettings.hourlyWage : parseFloat(appSettings.hourlyWage) || 0;
        uiRefs.hourlyWageInput.value = wage.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
        const tax = typeof appSettings.taxRate === 'number' ? appSettings.taxRate : parseFloat(appSettings.taxRate) || 0;
        uiRefs.taxRateInput.value = (tax * 100).toFixed(1);
        if (appSettings.monthlyEarningsGoal !== null && !isNaN(appSettings.monthlyEarningsGoal)) {
            uiRefs.monthlyGoalInput.value = appSettings.monthlyEarningsGoal.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 0);
        } else {
            uiRefs.monthlyGoalInput.value = '';
        }
    }

    function initializeUI() {
        loadAppSettingsFromLocalStorage();
        ThemeManager.init();
        MONTH_NAMES.forEach((name, index) => { const option = document.createElement('option'); option.value = index; option.textContent = name; uiRefs.monthSelect.appendChild(option); });
        const startYear = 2020, endYear = currentDate.getFullYear() + 5;
        for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; uiRefs.yearSelect.appendChild(option); }
        uiRefs.monthSelect.value = currentMonth; uiRefs.yearSelect.value = currentYear;
        updateSettingsUIInputs(); updatePageTitleAndGreeting(); updateLocalStorageSizeIndicator();
        updateAppBadge(getPendingSyncCount());
    }

    window.updateEmployeeName = function() { saveAppSettingToLocalStorage('employeeName', uiRefs.employeeNameInput.value.trim()); updatePageTitleAndGreeting(); debouncedSaveAppSettingsToFirestore(); }
    window.handleNumericInput = function(inputElement) { let value = inputElement.value; value = value.replace(',', '.'); value = value.replace(/[^\d.]/g, '').replace(/(\..*)\./g, '$1'); inputElement.value = value; }
    
    window.handleWageOrTaxOrGoalBlur = function(inputElement) {
        let valueString = inputElement.value.replace(',', '.'); let value = parseFloat(valueString);
        const id = inputElement.id; let validChange = true;
        inputElement.classList.remove('invalid-value');
        if (id === 'hourlyWageInput') {
            if (!isNaN(value) && value >= 0) {
                appSettings.hourlyWage = value; inputElement.value = value.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
                saveAppSettingToLocalStorage('hourlyWage', appSettings.hourlyWage);
            } else { inputElement.value = (appSettings.hourlyWage || 0).toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1); showErrorNotification("Neplatn√° hodinov√° mzda."); inputElement.classList.add('invalid-value'); validChange = false; }
        } else if (id === 'taxRateInput') {
            if (!isNaN(value) && value >= 0 && value <= 100) {
                appSettings.taxRate = value / 100; inputElement.value = value.toFixed(1);
                saveAppSettingToLocalStorage('taxRate', appSettings.taxRate);
            } else { inputElement.value = ((appSettings.taxRate || 0) * 100).toFixed(1); showErrorNotification("Neplatn√© da≈àov√© percento."); inputElement.classList.add('invalid-value'); validChange = false; }
        } else if (id === 'monthlyGoalInput') {
            if (valueString === '') {
                appSettings.monthlyEarningsGoal = null; inputElement.value = '';
                saveAppSettingToLocalStorage('monthlyEarningsGoal', null);
            } else if (!isNaN(value) && value >= 0) {
                appSettings.monthlyEarningsGoal = value;
                inputElement.value = value.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 0);
                saveAppSettingToLocalStorage('monthlyEarningsGoal', appSettings.monthlyEarningsGoal);
            } else {
                inputElement.value = appSettings.monthlyEarningsGoal ? appSettings.monthlyEarningsGoal.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 0) : '';
                showErrorNotification("Neplatn√Ω mesaƒçn√Ω cieƒæ. Mus√≠ by≈• kladn√© ƒç√≠slo."); inputElement.classList.add('invalid-value'); validChange = false;
            }
        }
        if (validChange) { recalculateAllRowsAndUpdateTotal(); debouncedSaveAppSettingsToFirestore(); }
    }

    window.changeDecimalPlaces = function() {
        saveAppSettingToLocalStorage('decimalPlaces', parseInt(uiRefs.decimalPlacesSelect.value));
        const currentWage = typeof appSettings.hourlyWage === 'number' ? appSettings.hourlyWage : 0;
        uiRefs.hourlyWageInput.value = currentWage.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 1);
        if (appSettings.monthlyEarningsGoal !== null) {
           uiRefs.monthlyGoalInput.value = appSettings.monthlyEarningsGoal.toFixed(appSettings.decimalPlaces > 0 ? appSettings.decimalPlaces : 0);
        }
        recalculateAllRowsAndUpdateTotal(); debouncedSaveAppSettingsToFirestore();
    }
    function recalculateAllRowsAndUpdateTotal() { const days = getDaysInMonth(currentMonth, currentYear); for (let i = 1; i <= days; i++) calculateRow(i); calculateTotal(); }

    function updatePageTitleAndGreeting() {
        const wavingHand = "üëã"; const namePart = appSettings.employeeName ? `${appSettings.employeeName.split(' ')[0]}` : "";
        uiRefs.mainTitle.textContent = `Vitaj${namePart ? ' ' + namePart : ''} ${wavingHand}`;
        const monthName = MONTH_NAMES[currentMonth]; const titleNamePart = appSettings.employeeName ? `${appSettings.employeeName} - ` : "";
        document.title = `${titleNamePart}${monthName} ${currentYear} | Bruno's Calc Pro+`; uiRefs.subTitle.textContent = `${monthName} ${currentYear}`;
    }
    function updateLocalStorageSizeIndicator() {
        let total = 0; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); total += (key.length + (localStorage.getItem(key)?.length || 0)) * 2; }
        uiRefs.localStorageIndicator.textContent = `Lok√°lne ulo≈æen√©: ~${(total / 1024).toFixed(1)}KB`;
    }

    const authErrorMap = {
        'auth/invalid-email': 'Neplatn√Ω form√°t emailu.', 'auth/user-disabled': 'Tento √∫ƒçet bol deaktivovan√Ω.',
        'auth/user-not-found': 'Pou≈æ√≠vateƒæ s t√Ωmto emailom nebol n√°jden√Ω.', 'auth/wrong-password': 'Nespr√°vne heslo.',
        'auth/email-already-in-use': 'Tento email je u≈æ zaregistrovan√Ω.', 'auth/weak-password': 'Heslo je pr√≠li≈° slab√© (mus√≠ ma≈• aspo≈à 6 znakov).',
        'auth/requires-recent-login': 'Vy≈æaduje sa ned√°vne prihl√°senie. Odhl√°ste sa a prihl√°ste znova.',
        'auth/network-request-failed': 'Chyba sie≈•ov√©ho pripojenia. Skontrolujte internetov√© pripojenie.',
        'auth/too-many-requests': 'Pr√≠li≈° veƒæa ne√∫spe≈°n√Ωch pokusov o prihl√°senie. Sk√∫ste nesk√¥r.', 'auth/missing-email': 'Pros√≠m, zadajte emailov√∫ adresu.',
    };
    function mapFirebaseAuthError(code) { return authErrorMap[code] || `Nezn√°ma chyba (${code}). Sk√∫ste pros√≠m znova.`; }
    window.loginUser = async function() {
        const btn = event.target; setLoadingState(btn, true, "Prihlasujem...");
        if (!navigator.onLine) { showErrorNotification('Ste offline. Prihl√°senie je mo≈æn√© iba v online re≈æime.'); setLoadingState(btn, false, "Prihl√°si≈• sa"); return; }
        const email = document.getElementById('email').value; const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); setLoadingState(btn, false, "Prihl√°si≈• sa"); return; }
        try { await signInWithEmailAndPassword(auth, email, password); showSaveNotification('√öspe≈°ne prihl√°sen√Ω.'); }
        catch (error) { showErrorNotification('Chyba pri prihl√°sen√≠: ' + mapFirebaseAuthError(error.code)); }
        finally { setLoadingState(btn, false, "Prihl√°si≈• sa"); }
    };
    window.registerUser = async function() {
        const btn = event.target; setLoadingState(btn, true, "Registrujem...");
        if (!navigator.onLine) { showErrorNotification('Ste offline. Registr√°cia je mo≈æn√° iba v online re≈æime.'); setLoadingState(btn, false, "Registrova≈•"); return; }
        const email = document.getElementById('email').value; const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); setLoadingState(btn, false, "Registrova≈•"); return; }
        const passwordError = validatePassword(password);
        if (passwordError) { showErrorNotification(passwordError); setLoadingState(btn, false, "Registrova≈•"); return; }
        try {
            await createUserWithEmailAndPassword(auth, email, password); await createUserCollectionAndSettings();
            showSaveNotification('√öspe≈°ne zaregistrovan√Ω a prihl√°sen√Ω.');
        } catch (error) { showErrorNotification('Chyba pri registr√°cii: ' + mapFirebaseAuthError(error.code)); }
        finally { setLoadingState(btn, false, "Registrova≈•"); }
    };
    async function createUserCollectionAndSettings() {
         if (auth.currentUser) {
            const userDocRef = doc(db, 'users', auth.currentUser.uid);
            const initialMonthDocId = getFirestoreDocId(currentYear, currentMonth);
            const initialMonthDocRef = doc(db, 'users', auth.currentUser.uid, 'workData', initialMonthDocId);
            const batch = writeBatch(db);
            batch.set(userDocRef, { email: auth.currentUser.email, createdAt: new Date().toISOString(), appSettings: appSettings }, { merge: true });
            batch.set(initialMonthDocRef, { data: [], lastUpdated: new Date().toISOString() }, {merge: true});
            try { await batch.commit(); }
            catch (error) { console.error("Error creating user collection/settings:", error); showErrorNotification('Nepodarilo sa inicializova≈• pou≈æ√≠vateƒæsk√© d√°ta v cloude.');}
        }
    }
    window.logoutUser = async function() {
        const btn = event.target; setLoadingState(btn, true, "Odhlasujem...");
        if (currentListenerUnsubscribe) { currentListenerUnsubscribe(); currentListenerUnsubscribe = null; }
        try { await signOut(auth); showSaveNotification('√öspe≈°ne odhl√°sen√Ω.'); }
        catch (error) { showErrorNotification('Chyba pri odhl√°sen√≠: ' + error.message); }
        finally { setLoadingState(btn, false, "Odhl√°si≈• sa");}
    };
    window.resetUserPassword = async function() {
        if (!navigator.onLine) { showErrorNotification('Ste offline. Obnova hesla je mo≈æn√° iba v online re≈æime.'); return; }
        const emailInput = document.getElementById('email'); const email = emailInput.value;
        if (!email) { emailInput.style.border = '1px solid red'; showErrorNotification('Pros√≠m, zadajte Va≈°u emailov√∫ adresu pre obnovu hesla.'); setTimeout(() => { emailInput.style.border = ''; }, 3000); return; }
        emailInput.style.border = '';
        try { await sendPasswordResetEmail(auth, email); showSaveNotification(`Email na obnovu hesla bol odoslan√Ω na adresu ${email}. Skontrolujte si doruƒçen√∫ po≈°tu.`); }
        catch (error) { showErrorNotification('Chyba pri odosielan√≠ emailu na obnovu hesla: ' + mapFirebaseAuthError(error.code)); }
    };
    function updateUIForAuthStateChange() {
        const isLoggedIn = !!currentUser;
        if (uiRefs.loginFieldset) uiRefs.loginFieldset.style.display = isLoggedIn ? 'none' : 'block';
        uiRefs.userInfo.style.display = isLoggedIn ? 'flex' : 'none';
        if (isLoggedIn && uiRefs.userEmailSpan) uiRefs.userEmailSpan.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;
        const logoutBtn = uiRefs.userInfo.querySelector('.reset-btn');
        if (logoutBtn && logoutBtn.classList.contains('is-loading')) { setLoadingState(logoutBtn, false, "Odhl√°si≈• sa"); }
        updateAppBadge(getPendingSyncCount());
    }

    function setupFirestoreWorkDataListener() {
        if (currentListenerUnsubscribe) currentListenerUnsubscribe();
        if (!currentUser) { loadWorkDataFromLocalStorage(); return; }
        if (!navigator.onLine) { loadWorkDataFromLocalStorage(); showWarningNotification("Ste offline. Zobrazujem lok√°lne d√°ta. Synchroniz√°cia prebehne po pripojen√≠."); return; }
        const docId = getFirestoreDocId(currentYear, currentMonth);
        const docRef = doc(db, 'users', currentUser.uid, 'workData', docId);
        currentListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
            const localKey = getLocalStorageKeyForWorkData(docId);
            if (docSnap.exists()) {
                const firestoreData = docSnap.data(); const firestoreDataString = JSON.stringify(firestoreData);
                if (!docSnap.metadata.hasPendingWrites || firestoreDataString !== localStorage.getItem(localKey)) {
                    localStorage.setItem(localKey, firestoreDataString);
                    if (!docSnap.metadata.hasPendingWrites) { removeMonthFromPendingList(docId); const pendingKey = getPendingSyncKeyForMonth(docId); if(pendingKey) localStorage.removeItem(pendingKey); }
                    parseAndApplyWorkData(firestoreDataString);
                } else { calculateTotal(); }
            } else {
                if (localStorage.getItem(localKey)) localStorage.removeItem(localKey);
                const pendingKey = getPendingSyncKeyForMonth(docId); if(pendingKey) localStorage.removeItem(pendingKey);
                removeMonthFromPendingList(docId); parseAndApplyWorkData(null);
            }
        }, (error) => { console.error("Firestore listener error:", error); showErrorNotification(`Chyba synchroniz√°cie d√°t s cloudom: ${error.message}. Zobrazujem lok√°lne ulo≈æen√© d√°ta.`); loadWorkDataFromLocalStorage(); });
        syncPendingWorkData();
    }
    function getFirestoreDocId(year, month) { return `${year}-${String(month + 1).padStart(2, '0')}`; }
    function getLocalStorageKeyForWorkData(docId) { return currentUser ? `workData-${currentUser.uid}-${docId}` : `workData-guest-${docId}`; }
    function getPendingSyncKeyForMonth(docId) { return currentUser ? `pendingSync-workData-${currentUser.uid}-${docId}` : null; }

    const _debouncedSaveWorkDataAndSync = debounce(async () => {
        const dataToSave = collectWorkDataForStorage(); const docId = getFirestoreDocId(currentYear, currentMonth);
        const localKey = getLocalStorageKeyForWorkData(docId); const dataToSaveString = JSON.stringify(dataToSave);
        localStorage.setItem(localKey, dataToSaveString); updateLocalStorageSizeIndicator();
        if (currentUser) {
            const pendingKey = getPendingSyncKeyForMonth(docId);
            if (navigator.onLine) {
                try { await saveWorkDataToFirestore(dataToSave, docId); removeMonthFromPendingList(docId); if(pendingKey) localStorage.removeItem(pendingKey); }
                catch (error) { addMonthToPendingList(docId); if(pendingKey) localStorage.setItem(pendingKey, dataToSaveString); }
            } else { addMonthToPendingList(docId); if(pendingKey) localStorage.setItem(pendingKey, dataToSaveString); }
        }
        calculateTotal();
    }, 1200);
    window.debouncedSaveWorkDataAndSync = _debouncedSaveWorkDataAndSync;

    function collectWorkDataForStorage() {
        const saveData = { data: [] }; const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) {
            saveData.data.push({
                start: document.getElementById(`start-${i}`)?.value || '',
                end: document.getElementById(`end-${i}`)?.value || '',
                breakTime: document.getElementById(`break-${i}`)?.value || '',
                projectTag: document.getElementById(`project-${i}`)?.value || '',
                note: document.getElementById(`note-${i}`)?.value || ''
            });
        }
        saveData.lastUpdated = new Date().toISOString(); return saveData;
    }

    async function saveWorkDataToFirestore(dataToSave, docId) {
        if (!currentUser) return Promise.reject(new Error("User not logged in."));
        if (!navigator.onLine) return Promise.reject(new Error("Cannot save to Firestore: App is offline."));
        const docRef = doc(db, 'users', currentUser.uid, 'workData', docId);
        try { await setDoc(docRef, dataToSave, { merge: true }); }
        catch (error) { console.error(`Error saving work data to Firestore for doc ${docId}:`, error); throw error; }
    }

    async function syncPendingWorkData() {
        if (!currentUser || !navigator.onLine) { updateAppBadge(getPendingSyncCount()); return; }
        const pendingMonths = getPendingSyncMonths(); if (pendingMonths.length === 0) { updateAppBadge(0); return; }
        showNotification('saveNotification', `Synchronizujem ${pendingMonths.length} mesiac(ov) s cloudom...`, 2000);
        const successfullySyncedMonths = []; const failedMonths = [];
        for (const monthId of pendingMonths) {
            const pendingKey = getPendingSyncKeyForMonth(monthId); if (!pendingKey) continue;
            const pendingDataString = localStorage.getItem(pendingKey);
            if (pendingDataString) {
                try { const dataToSync = JSON.parse(pendingDataString); dataToSync.lastUpdated = new Date().toISOString(); await saveWorkDataToFirestore(dataToSync, monthId); localStorage.removeItem(pendingKey); successfullySyncedMonths.push(monthId); }
                catch (error) { console.error(`Chyba synchroniz√°cie d√°t pre mesiac ${monthId}:`, error); failedMonths.push(monthId); }
            } else { successfullySyncedMonths.push(monthId); }
        }
        if (successfullySyncedMonths.length > 0) { let currentPendingList = getPendingSyncMonths(); currentPendingList = currentPendingList.filter(id => !successfullySyncedMonths.includes(id)); savePendingSyncMonths(currentPendingList); }
        const finalPendingCount = getPendingSyncCount();
        if (pendingMonths.length > 0 && finalPendingCount === 0 && failedMonths.length === 0) { showSaveNotification('V≈°etky lok√°lne zmeny boli √∫spe≈°ne synchronizovan√© s cloudom.'); }
        else if (finalPendingCount > 0 || failedMonths.length > 0) { showWarningNotification(`Niektor√© d√°ta sa nepodarilo synchronizova≈•. Zost√°va ${finalPendingCount} mesiac(ov) na synchroniz√°ciu.`); }
        updateAppBadge(finalPendingCount);
    }

    window.loadFromFirestore = async function() {
        const btn = event.target; setLoadingState(btn, true, "Naƒç√≠tavam z cloudu...");
        if (!currentUser) { showErrorNotification('Pre naƒç√≠tanie d√°t z cloudu mus√≠te by≈• prihl√°sen√Ω.'); setLoadingState(btn, false, "Naƒç√≠ta≈• z Cloudu"); return; }
        if (!navigator.onLine) { showErrorNotification('Ste offline. Naƒç√≠tanie z cloudu vy≈æaduje internetov√© pripojenie.'); setLoadingState(btn, false, "Naƒç√≠ta≈• z Cloudu"); return; }
        if (!confirm('Naozaj chcete prep√≠sa≈• lok√°lne d√°ta pre tento mesiac d√°tami z cloudu? Va≈°e neulo≈æen√© lok√°lne zmeny m√¥≈æu by≈• straten√©.')) { setLoadingState(btn, false, "Naƒç√≠ta≈• z Cloudu"); return; }
        const docId = getFirestoreDocId(currentYear, currentMonth); const docRef = doc(db, 'users', currentUser.uid, 'workData', docId);
        try {
            const docSnap = await getDoc(docRef); const localKey = getLocalStorageKeyForWorkData(docId); const pendingKey = getPendingSyncKeyForMonth(docId);
            if (docSnap.exists()) {
                const storedData = docSnap.data(); const dataString = JSON.stringify(storedData); localStorage.setItem(localKey, dataString);
                if (pendingKey) localStorage.removeItem(pendingKey); removeMonthFromPendingList(docId); parseAndApplyWorkData(dataString);
                showSaveNotification('D√°ta boli √∫spe≈°ne naƒç√≠tan√© z cloudu.');
            } else {
                localStorage.removeItem(localKey); if (pendingKey) localStorage.removeItem(pendingKey); removeMonthFromPendingList(docId); parseAndApplyWorkData(null);
                showWarningNotification('Pre tento mesiac neboli v cloude n√°jden√© ≈æiadne d√°ta.');
            }
        } catch (error) { console.error("Error loading from Firestore:", error); showErrorNotification('Chyba pri naƒç√≠tan√≠ d√°t z cloudu: ' + error.message); }
        finally { setLoadingState(btn, false, "Naƒç√≠ta≈• z Cloudu"); }
    };

    function loadWorkDataFromLocalStorage() { const docId = getFirestoreDocId(currentYear, currentMonth); const localKey = getLocalStorageKeyForWorkData(docId); const localData = localStorage.getItem(localKey); parseAndApplyWorkData(localData); }

    function parseAndApplyWorkData(dataString) {
        if (dataString) {
            try {
                const storedWorkData = JSON.parse(dataString);
                if (storedWorkData.data && Array.isArray(storedWorkData.data)) {
                    const daysInTable = getDaysInMonth(currentMonth, currentYear);
                    storedWorkData.data.slice(0, daysInTable).forEach((dayData, index) => {
                        const dayNum = index + 1;
                        const startEl = document.getElementById(`start-${dayNum}`); if (startEl) startEl.value = dayData.start || '';
                        const endEl = document.getElementById(`end-${dayNum}`); if (endEl) endEl.value = dayData.end || '';
                        const breakEl = document.getElementById(`break-${dayNum}`); if (breakEl) breakEl.value = dayData.breakTime || '';
                        const projectEl = document.getElementById(`project-${dayNum}`); if (projectEl) projectEl.value = dayData.projectTag || '';
                        const noteEl = document.getElementById(`note-${dayNum}`); if (noteEl) { noteEl.value = dayData.note || ''; autoResizeTextarea(noteEl); }
                        calculateRow(dayNum);
                    });
                } else { resetTableInputsOnly(); }
            } catch (error) { console.error("Error parsing work data:", error); showErrorNotification('Chyba pri spracovan√≠ ulo≈æen√Ωch d√°t: ' + error.message); resetTableInputsOnly(); }
        } else { resetTableInputsOnly(); }
        calculateTotal();
    }
    function resetTableInputsOnly() {
        const daysInTable = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= daysInTable; i++) {
            const startEl = document.getElementById(`start-${i}`); if (startEl) startEl.value = '';
            const endEl = document.getElementById(`end-${i}`); if (endEl) endEl.value = '';
            const breakEl = document.getElementById(`break-${i}`); if (breakEl) breakEl.value = '';
            const projectEl = document.getElementById(`project-${i}`); if (projectEl) projectEl.value = '';
            const noteEl = document.getElementById(`note-${i}`); if (noteEl) { noteEl.value = ''; autoResizeTextarea(noteEl); }
            calculateRow(i);
        }
    }

    function createTable() {
        uiRefs.workDaysTbody.innerHTML = ''; const fragment = document.createDocumentFragment();
        const today = new Date(); const currentDayInMonth = today.getDate(), currentMonthIdx = today.getMonth(), currentFullYear = today.getFullYear();
        const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) {
            const row = document.createElement('tr'); const dayStr = String(i);
            const isCurrDay = (i === currentDayInMonth && currentMonth === currentMonthIdx && currentYear === currentFullYear);
            if (isCurrDay) row.classList.add('current-day');
            if (isWeekend(currentYear, currentMonth, i)) row.classList.add('weekend-day');
            row.innerHTML = `
                <td>${i}. ${getDayName(currentYear, currentMonth, i)} ${isCurrDay ? '<span aria-hidden="true" style="font-style: normal; filter: grayscale(0.1) brightness(1.3);"> ‚≠ê</span>': ''}</td>
                <td><div class="time-input-wrapper">
                    <input type="tel" id="start-${dayStr}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" aria-label="Pr√≠chod d≈àa ${dayStr}" onblur="validateAndFormatTimeBlur(this, ${i}); debouncedSaveWorkDataAndSync();">
                    <button class="time-btn" onclick="setCurrentTime('start-${dayStr}', ${i})" title="Zada≈• aktu√°lny ƒças" aria-label="Zada≈• aktu√°lny ƒças pre pr√≠chod d≈àa ${dayStr}">üïí</button>
                </div></td>
                <td><div class="time-input-wrapper">
                    <input type="tel" id="end-${dayStr}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" aria-label="Odchod d≈àa ${dayStr}" onblur="validateAndFormatTimeBlur(this, ${i}); debouncedSaveWorkDataAndSync();">
                    <button class="time-btn" onclick="setCurrentTime('end-${dayStr}', ${i})" title="Zada≈• aktu√°lny ƒças" aria-label="Zada≈• aktu√°lny ƒças pre odchod d≈àa ${dayStr}">üïí</button>
                </div></td>
                <td><input type="text" inputmode="decimal" id="break-${dayStr}" placeholder="hod." aria-label="Prest√°vka v hodin√°ch d≈àa ${dayStr}" oninput="handleNumericInput(this); handleBreakLiveInput(this, ${i});" onblur="validateBreakInputOnBlur(${i}); debouncedSaveWorkDataAndSync();"></td>
                <td id="total-${dayStr}">0h 0m (${(0).toFixed(appSettings.decimalPlaces)} h)</td>
                <td><input type="text" id="project-${dayStr}" class="project-input" placeholder="Projekt/√öloha" aria-label="Projekt alebo √∫loha pre de≈à ${dayStr}" oninput="debouncedSaveWorkDataAndSync()" onblur="debouncedSaveWorkDataAndSync()"></td>
                <td><textarea id="note-${dayStr}" placeholder="Pozn√°mka..." aria-label="Pozn√°mka ku d≈àu ${dayStr}" oninput="handleNoteInput(this)" onblur="debouncedSaveWorkDataAndSync()"></textarea></td>
                <td><input type="number" id="gross-${dayStr}" readonly aria-label="Hrub√° mzda d≈àa ${dayStr}" step="0.01"></td>
                <td><input type="number" id="net-${dayStr}" readonly aria-label="ƒåist√° mzda d≈àa ${dayStr}" step="0.01"></td>
                <td style="text-align:center;"><button class="btn reset-btn" style="padding:4px 6px; font-size:0.8rem;" onclick="resetRow(${dayStr})" aria-label="Resetova≈• √∫daje pre de≈à ${dayStr}">X</button></td>`;
            fragment.appendChild(row);
            const startInput = row.querySelector(`#start-${dayStr}`);
            const endInput = row.querySelector(`#end-${dayStr}`);
            if(startInput) startInput.oninput = (e) => handleTimeInput(e.target, `end-${dayStr}`, i);
            if(endInput) endInput.oninput = (e) => handleTimeInput(e.target, `break-${dayStr}`, i);
        }
        uiRefs.workDaysTbody.appendChild(fragment);
    }
    window.setCurrentTime = function(inputId, day) {
        const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0');
        const targetInput = document.getElementById(inputId);
        if (targetInput) { targetInput.value = `${hours}:${minutes}`; targetInput.dispatchEvent(new Event('input', { bubbles: true })); targetInput.dispatchEvent(new Event('blur', { bubbles: true })); }
    }
    window.handleTimeInput = function(input, nextId, day) {
        formatTimeInputOnly(input);
        if (input.value.length === 5 && isValidTimeFormat(input.value)) {
            calculateRow(day);
            const nextElement = document.getElementById(nextId);
            if (nextElement && document.activeElement === input) { if (!nextId.startsWith('break-')) { nextElement.focus(); if (typeof nextElement.select === 'function') { nextElement.select(); } } }
        } else if (input.value.length < 5) { calculateRow(day); }
    }
    window.validateAndFormatTimeBlur = function(input, day) {
        formatTimeInputOnly(input); const isValid = isValidTimeFormat(input.value);
        const isDefaultSettingInput = input.id.startsWith('default');
        if (isDefaultSettingInput) { input.classList.toggle('invalid-time', input.value.length > 0 && !isValid); }
        else { input.classList.toggle('invalid-time', input.value.length > 0 && !isValid); if (input.value.length > 0 && !isValid && day) { showWarningNotification(`Neplatn√Ω form√°t ƒçasu pre ${input.id.startsWith('start') ? 'pr√≠chod' : 'odchod'} d≈àa ${day}. Pou≈æite form√°t HH:MM.`); } if(day) { calculateRow(day); } }
    }
    function formatTimeInputOnly(input) {
        const rawValue = input.value; let digits = rawValue.replace(/[^\d]/g, ''); let formattedValue = "";
        if (digits.length >= 2) { formattedValue = `${digits.substring(0,2)}:`; if (digits.length > 2) { formattedValue += digits.substring(2,4); } else if (rawValue.endsWith(':') && digits.length === 2) { /* keep "12:" */ } else if (rawValue.length === 2 && digits.length === 2) { formattedValue = digits; } }
        else { formattedValue = digits; }
        if (input.value !== formattedValue && formattedValue.length <= 5) input.value = formattedValue;
    }
    window.handleBreakLiveInput = function(inputElement, day) { calculateRow(day); }
    window.validateBreakInputOnBlur = function(day) {
        const breakInput = document.getElementById(`break-${day}`); let value = breakInput.value.replace(',', '.'); const numericValue = parseFloat(value); breakInput.classList.remove('invalid-value');
        if (value === '' || (!isNaN(numericValue) && numericValue >= 0)) { /* valid */ }
        else { breakInput.value = ''; breakInput.classList.add('invalid-value'); showWarningNotification(`Neplatn√° hodnota pre prest√°vku d≈àa ${day}.`); }
        calculateRow(day);
    }
    window.handleNoteInput = function(textarea) { autoResizeTextarea(textarea); }
    function autoResizeTextarea(textarea) { textarea.style.height = 'auto'; textarea.style.height = Math.max(38, textarea.scrollHeight) + 'px'; }

    function calculateRow(day) {
        const startInput = document.getElementById(`start-${day}`); const endTimeInput = document.getElementById(`end-${day}`);
        const breakTimeInput = document.getElementById(`break-${day}`); const totalCell = document.getElementById(`total-${day}`);
        const grossInput = document.getElementById(`gross-${day}`); const netInput = document.getElementById(`net-${day}`);
        if (!totalCell || !grossInput || !netInput) return;
        if(startInput) startInput.classList.remove('invalid-time'); if(endTimeInput) endTimeInput.classList.remove('invalid-time'); if(breakTimeInput) breakTimeInput.classList.remove('invalid-value');
        const startTime = startInput?.value; const endTime = endTimeInput?.value;
        const breakTimeHoursRaw = breakTimeInput?.value.replace(',', '.'); const breakTimeHours = parseFloat(breakTimeHoursRaw) || 0;
        let decimalHours = 0;
        if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
            const [sH, sM] = startTime.split(':').map(Number); const [eH, eM] = endTime.split(':').map(Number);
            let startDate = new Date(2000,0,1,sH,sM,0); let endDate = new Date(2000,0,1,eH,eM,0);
            if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
            if (!isNaN(breakTimeHours) && breakTimeHours >=0) { let diffMillis = endDate.getTime() - startDate.getTime(); let totalWorkMinutes = diffMillis / (1000 * 60); totalWorkMinutes -= (breakTimeHours * 60); if (totalWorkMinutes < 0) totalWorkMinutes = 0; decimalHours = totalWorkMinutes / 60; }
            else { if(breakTimeInput && breakTimeHoursRaw.length > 0) breakTimeInput.classList.add('invalid-value'); }
        } else { if (startInput && startTime && startTime.length > 0 && !isValidTimeFormat(startTime)) startInput.classList.add('invalid-time'); if (endTimeInput && endTime && endTime.length > 0 && !isValidTimeFormat(endTime)) endTimeInput.classList.add('invalid-time'); if (breakTimeInput && breakTimeHoursRaw.length > 0 && (isNaN(breakTimeHours) || breakTimeHours < 0)) breakTimeInput.classList.add('invalid-value'); }
        const hoursPart = Math.floor(decimalHours); const minutesPart = Math.round((decimalHours - hoursPart) * 60);
        totalCell.textContent = `${hoursPart}h ${minutesPart}m (${decimalHours.toFixed(appSettings.decimalPlaces)} h)`;
        const currentHourlyWage = typeof appSettings.hourlyWage === 'number' ? appSettings.hourlyWage : 0;
        const currentTaxRate = typeof appSettings.taxRate === 'number' ? appSettings.taxRate : 0;
        const grossSalary = decimalHours * currentHourlyWage; grossInput.value = Math.max(0, grossSalary).toFixed(appSettings.decimalPlaces);
        const netSalary = grossSalary * (1 - currentTaxRate); netInput.value = Math.max(0, netSalary).toFixed(appSettings.decimalPlaces);
    }
    window.resetRow = function(day) {
        if (!confirm(`Naozaj chcete vymaza≈• z√°znam pre ${day}. de≈à? T√°to akcia je nezvratn√°.`)) return;
        const dayStr = String(day); const startEl = document.getElementById(`start-${dayStr}`); if(startEl) startEl.value = '';
        const endEl = document.getElementById(`end-${dayStr}`); if(endEl) endEl.value = '';
        const breakEl = document.getElementById(`break-${dayStr}`); if(breakEl) breakEl.value = '';
        const projectEl = document.getElementById(`project-${dayStr}`); if(projectEl) projectEl.value = '';
        const noteEl = document.getElementById(`note-${dayStr}`); if (noteEl) { noteEl.value = ''; autoResizeTextarea(noteEl); }
        calculateRow(day); debouncedSaveWorkDataAndSync(); showSaveNotification(`Z√°znam pre ${day}. de≈à bol √∫spe≈°ne vymazan√Ω.`);
    }
    window.clearMonthData = async function() {
        const btn = event.target; if (!confirm(`Naozaj chcete vymaza≈• V≈†ETKY d√°ta pre mesiac ${MONTH_NAMES[currentMonth]} ${currentYear}? T√°to akcia je nezvratn√°!`)) return;
        setLoadingState(btn, true, "Mazanie d√°t..."); resetTableInputsOnly();
        const emptyMonthData = { data: [], lastUpdated: new Date().toISOString() };
        const docId = getFirestoreDocId(currentYear, currentMonth); const localKey = getLocalStorageKeyForWorkData(docId);
        const emptyDataString = JSON.stringify(emptyMonthData); localStorage.setItem(localKey, emptyDataString); updateLocalStorageSizeIndicator();
        const pendingKey = getPendingSyncKeyForMonth(docId);
        if (currentUser) {
            if (navigator.onLine) { try { await saveWorkDataToFirestore(emptyMonthData, docId); removeMonthFromPendingList(docId); if (pendingKey) localStorage.removeItem(pendingKey); } catch (error) { showErrorNotification('Chyba pri mazan√≠ d√°t v cloude: ' + error.message); addMonthToPendingList(docId); if (pendingKey) localStorage.setItem(pendingKey, emptyDataString); } }
            else { addMonthToPendingList(docId); if (pendingKey) localStorage.setItem(pendingKey, emptyDataString); }
        }
        showSaveNotification(`V≈°etky d√°ta pre mesiac ${MONTH_NAMES[currentMonth]} ${currentYear} boli √∫spe≈°ne vymazan√©.`);
        setLoadingState(btn, false, "Vymaza≈• Mesiac");
    }

    // UPREVEN√Å FUNKCIA calculateTotal()
    function calculateTotal() {
        let totalExactDecimalHours = 0; 
        let totalGrossSalaryCalculated; 
        let totalNetSalaryCalculated;   
        let daysWithEntries = 0;

        const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) {
            const startTime = document.getElementById(`start-${i}`)?.value;
            const endTime = document.getElementById(`end-${i}`)?.value;
            const breakTimeStr = document.getElementById(`break-${i}`)?.value;
            const noteValue = document.getElementById(`note-${i}`)?.value || "";
            const projectValue = document.getElementById(`project-${i}`)?.value || "";

            let dayDecimalHours = 0; 

            if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                const [sH, sM] = startTime.split(':').map(Number);
                const [eH, eM] = endTime.split(':').map(Number);
                let sDate = new Date(2000, 0, 1, sH, sM);
                let eDate = new Date(2000, 0, 1, eH, eM);
                if (eDate < sDate) eDate.setDate(eDate.getDate() + 1);

                let diffMillis = eDate.getTime() - sDate.getTime();
                let dayWorkMinutes = diffMillis / (1000 * 60);
                const breakHours = parseFloat(breakTimeStr?.replace(',', '.')) || 0;
                if (!isNaN(breakHours) && breakHours >= 0) dayWorkMinutes -= (breakHours * 60);
                if (dayWorkMinutes < 0) dayWorkMinutes = 0;
                dayDecimalHours = dayWorkMinutes / 60; 
            }

            totalExactDecimalHours += dayDecimalHours; 

            const dailyGrossFromInput = parseFloat(document.getElementById(`gross-${i}`)?.value) || 0;
            if ((isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) || dayDecimalHours > 0 || dailyGrossFromInput > 0 || noteValue.trim() !== "" || projectValue.trim() !== "") {
                daysWithEntries++;
            }
        }

        const currentHourlyWage = typeof appSettings.hourlyWage === 'number' ? appSettings.hourlyWage : 0;
        const currentTaxRate = typeof appSettings.taxRate === 'number' ? appSettings.taxRate : 0;

        totalGrossSalaryCalculated = totalExactDecimalHours * currentHourlyWage;
        totalNetSalaryCalculated = totalGrossSalaryCalculated * (1 - currentTaxRate);

        const totalHoursPart = Math.floor(totalExactDecimalHours); 
        const totalMinutesPart = Math.round((totalExactDecimalHours - totalHoursPart) * 60); 

        const avgNetSalary = daysWithEntries > 0 ? totalNetSalaryCalculated / daysWithEntries : 0;
        const avgWorkMinutes = daysWithEntries > 0 ? (totalExactDecimalHours * 60) / daysWithEntries : 0; 
        const avgHoursPart = Math.floor(avgWorkMinutes / 60);
        const avgMinutesPart = Math.round(avgWorkMinutes % 60);
        const avgDecimalHours = avgWorkMinutes / 60;

        // Bezpeƒçn√© vytv√°ranie DOM elementov (XSS prevencia)
        const createTextWithStrong = (text, strongValue, suffix = '') => {
            const fragment = document.createDocumentFragment();
            fragment.appendChild(document.createTextNode(text));
            const strong = document.createElement('strong');
            strong.textContent = strongValue;
            fragment.appendChild(strong);
            if (suffix) fragment.appendChild(document.createTextNode(suffix));
            return fragment;
        };

        // Vyƒçistenie a naplnenie totalSalaryDiv bezpeƒçn√Ωm sp√¥sobom
        uiRefs.totalSalaryDiv.textContent = '';

        // Riadok 1: Zapoƒç√≠tan√© dni
        uiRefs.totalSalaryDiv.appendChild(createTextWithStrong('Zapoƒç√≠tan√Ωch dn√≠ s aktivitou: ', String(daysWithEntries)));
        uiRefs.totalSalaryDiv.appendChild(document.createElement('br'));

        // Riadok 2: Celkov√Ω ƒças
        uiRefs.totalSalaryDiv.appendChild(createTextWithStrong('Celkov√Ω odpracovan√Ω ƒças: ', `${totalHoursPart}h ${totalMinutesPart}m`, ` (${totalExactDecimalHours.toFixed(appSettings.decimalPlaces)} h)`));
        uiRefs.totalSalaryDiv.appendChild(document.createElement('br'));

        // Riadok 3: Mzdy
        uiRefs.totalSalaryDiv.appendChild(createTextWithStrong('Celkov√° hrub√° mzda: ', `${totalGrossSalaryCalculated.toFixed(appSettings.decimalPlaces)} ‚Ç¨`, ' | '));
        uiRefs.totalSalaryDiv.appendChild(createTextWithStrong('Celkov√° ƒçist√° mzda: ', `${totalNetSalaryCalculated.toFixed(appSettings.decimalPlaces)} ‚Ç¨`));
        uiRefs.totalSalaryDiv.appendChild(document.createElement('br'));

        // Riadok 4: Priemery
        uiRefs.totalSalaryDiv.appendChild(createTextWithStrong('Priemern√° ƒçist√° mzda na de≈à: ', `${avgNetSalary.toFixed(appSettings.decimalPlaces)} ‚Ç¨`, ' | '));
        uiRefs.totalSalaryDiv.appendChild(createTextWithStrong('Priemern√Ω ƒças na de≈à: ', `${avgHoursPart}h ${avgMinutesPart}m`, ` (${avgDecimalHours.toFixed(appSettings.decimalPlaces)} h)`));

        // Mesaƒçn√Ω cieƒæ (ak je nastaven√Ω)
        if (appSettings.monthlyEarningsGoal !== null && appSettings.monthlyEarningsGoal > 0) {
            const goal = appSettings.monthlyEarningsGoal;
            const percentage = goal > 0 ? (totalNetSalaryCalculated / goal) * 100 : 0;
            let progressClass = 'low';
            if (percentage >= 100) progressClass = 'good';
            else if (percentage >= 50) progressClass = 'medium';

            const goalDiv = document.createElement('div');
            goalDiv.className = `goal-progress ${progressClass}`;
            goalDiv.appendChild(createTextWithStrong('Mesaƒçn√Ω cieƒæ: ', `${totalNetSalaryCalculated.toFixed(appSettings.decimalPlaces)} ‚Ç¨`, ` / ${goal.toFixed(appSettings.decimalPlaces)} ‚Ç¨ (`));
            goalDiv.appendChild(createTextWithStrong('Splnen√© na ', `${percentage.toFixed(1)}%`, ')'));
            uiRefs.totalSalaryDiv.appendChild(goalDiv);
        }
    }
    // KONIEC UPRAVENEJ FUNKCIE calculateTotal()


    window.exportToPDF = async function() {
        const btn = event.target; setLoadingState(btn, true, "Exportujem PDF..."); calculateTotal();
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        try {
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); }
            catch (e) { console.warn("Roboto font not loaded for PDF, using helvetica."); doc.setFont('helvetica'); }
            doc.setFontSize(16); doc.text(`V√Ωkaz pr√°ce - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
            doc.setFontSize(12); doc.text(`Pracovn√≠k: ${appSettings.employeeName || 'Nezadan√©'}`, 14, 30);
            const currentHourlyWage = typeof appSettings.hourlyWage === 'number' ? appSettings.hourlyWage : 0;
            const currentTaxRate = typeof appSettings.taxRate === 'number' ? appSettings.taxRate : 0;
            doc.setFontSize(10); doc.text(`Hodinov√° mzda: ${currentHourlyWage.toFixed(appSettings.decimalPlaces)} ‚Ç¨/h, Da≈àov√© percento: ${(currentTaxRate * 100).toFixed(1)}%`, 14, 36);
            const tableData = []; const days = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= days; i++) {
                const dayName = getDayName(currentYear, currentMonth, i); const startTime = document.getElementById(`start-${i}`)?.value || '';
                const endTime = document.getElementById(`end-${i}`)?.value || ''; const breakTime = document.getElementById(`break-${i}`)?.value || '';
                const projectTag = document.getElementById(`project-${i}`)?.value || '';
                const note = document.getElementById(`note-${i}`)?.value || ''; const totalTimeText = document.getElementById(`total-${i}`)?.textContent.trim() || '';
                const grossSalary = parseFloat(document.getElementById(`gross-${i}`)?.value || '0').toFixed(appSettings.decimalPlaces);
                const netSalary = parseFloat(document.getElementById(`net-${i}`)?.value || '0').toFixed(appSettings.decimalPlaces);
                if (startTime || endTime || (breakTime && parseFloat(breakTime.replace(',','.')) > 0) || projectTag.trim() !== '' || note.trim() !== "") {
                    tableData.push([`${i}. ${dayName}`, startTime, endTime, breakTime || '0', totalTimeText, projectTag, note, `${grossSalary} ‚Ç¨`, `${netSalary} ‚Ç¨`]);
                }
            }
            doc.autoTable({
                head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka (h)', 'Odpracovan√©', 'Projekt', 'Pozn√°mka', 'Hrub√° (‚Ç¨)', 'ƒåist√° (‚Ç¨)']],
                body: tableData, startY: 42, theme: 'grid',
                styles: { font: doc.getFont().fontName || 'helvetica', fontSize: 7, cellPadding: 1, valign: 'middle' },
                headStyles: { fillColor: [230,230,230], textColor: [0,0,0], fontStyle: 'bold', fontSize: 7.5, halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 14, halign: 'left' }, 1: { cellWidth: 11, halign: 'center' }, 2: { cellWidth: 11, halign: 'center' },
                    3: { cellWidth: 12, halign: 'center' }, 4: { cellWidth: 18, halign: 'center' },
                    5: { cellWidth: 25, halign: 'left' }, 6: { cellWidth: 'auto', halign: 'left' },
                    7: { cellWidth: 14, halign: 'right' }, 8: { cellWidth: 14, halign: 'right' }
                },
                didParseCell: (data) => { if ((data.column.index === 5 || data.column.index === 6) && data.cell.section === 'body') data.cell.styles.cellWidth = 'wrap'; }
            });
            const totalY = doc.lastAutoTable.finalY + 8; doc.setFontSize(9);
            const totalTextContent = uiRefs.totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<div class="goal-progress.*?>.*?<\/div>/gi, '').replace(/<\/?strong>/gi, '').replace(/&nbsp;/g, ' ').replace(/‚Ç¨/g, 'EUR');
            doc.text(totalTextContent, 14, totalY);
            const safeName = (appSettings.employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
            doc.save(`Vykaz_Prace_${safeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`); showSaveNotification('PDF s√∫bor bol √∫spe≈°ne vygenerovan√Ω.');
        } catch (error) { console.error("Error exporting to PDF:", error); showErrorNotification("Nastala chyba pri exporte do PDF: " + error.message); }
        finally { setLoadingState(btn, false, "Exportova≈• do PDF"); }
    }
    window.sendPDF = async function() {
        const btn = event.target; setLoadingState(btn, true, "Pripravujem PDF na odoslanie..."); calculateTotal();
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        try {
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); }
            catch (e) { console.warn("Roboto font not loaded for PDF, using helvetica."); doc.setFont('helvetica'); }
            doc.setFontSize(16); doc.text(`Prehƒæad doch√°dzky - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
            doc.setFontSize(12); doc.text(`Pracovn√≠k: ${appSettings.employeeName || 'Nezadan√©'}`, 14, 30);
            const workedDaysMatch = (uiRefs.totalSalaryDiv.textContent || "").match(/Zapoƒç√≠tan√Ωch dn√≠ s aktivitou:\s*(\d+)/i);
            const workedDaysCount = workedDaysMatch && workedDaysMatch[1] ? parseInt(workedDaysMatch[1]) : 0;
            doc.setFontSize(10); doc.text(`Celkov√Ω poƒçet dn√≠ s aktivitou: ${workedDaysCount}`, 14, 36);
            const tableData = []; const days = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= days; i++) {
                const dayName = getDayName(currentYear, currentMonth, i); const startTime = document.getElementById(`start-${i}`)?.value || '';
                const endTime = document.getElementById(`end-${i}`)?.value || ''; const breakTime = document.getElementById(`break-${i}`)?.value || '';
                const projectTag = document.getElementById(`project-${i}`)?.value || '';
                const note = document.getElementById(`note-${i}`)?.value || '';
                if (startTime || endTime || (breakTime && parseFloat(breakTime.replace(',','.')) > 0) || projectTag.trim() !== '' || note.trim() !== "") {
                    tableData.push([`${i}. ${dayName}`, startTime, endTime, breakTime || '0', projectTag, note]);
                }
            }
            doc.autoTable({
                head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka (h)', 'Projekt', 'Pozn√°mka']],
                body: tableData, startY: 42, theme: 'grid',
                styles: { font: doc.getFont().fontName || 'helvetica', fontSize: 8, cellPadding: 1.5, valign: 'middle' },
                headStyles: { fillColor: [230,230,230], textColor: [0,0,0], fontStyle: 'bold', fontSize: 8.5, halign: 'center'},
                columnStyles: {
                    0: { cellWidth: 22 }, 1: { cellWidth: 18, halign: 'center' }, 2: { cellWidth: 18, halign: 'center' },
                    3: { cellWidth: 18, halign: 'center' }, 4: { cellWidth: 30 }, 5: { cellWidth: 'auto' }
                },
                didParseCell: (data) => { if ((data.column.index === 4 || data.column.index === 5) && data.cell.section === 'body') data.cell.styles.cellWidth = 'wrap'; }
            });
            const pdfBlob = doc.output('blob'); const safeName = (appSettings.employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
            const pdfFileName = `Dochadzka_${safeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                await navigator.share({ files: [pdfFile], title: `Doch√°dzka ${MONTH_NAMES[currentMonth]} ${currentYear}`, text: `Z√°znam doch√°dzky pre pracovn√≠ka ${appSettings.employeeName || 'Nezadan√©'}.` });
            } else { showWarningNotification('Zdieƒæanie s√∫borov nie je podporovan√©. S√∫bor sa stiahne.'); doc.save(pdfFileName); }
        } catch (error) { if (error.name !== 'AbortError') { console.error("Error sharing PDF:", error); showErrorNotification('Nastala chyba pri zdieƒæan√≠ PDF: ' + error.message); } }
        finally { setLoadingState(btn, false, "Odosla≈• PDF (s pozn.)"); }
    }

    window.createBackup = function() {
        const btn = event.target; setLoadingState(btn, true, "Vytv√°ram z√°lohu..."); const workData = collectWorkDataForStorage();
        if (!workData.data.some(d => d.start || d.end || d.breakTime || d.projectTag || d.note) && !appSettings.employeeName && Object.values(appSettings).every(val => val === '' || val === 0 || val === 2 || val === null || val === 'light') ) {
            showWarningNotification('Nie s√∫ zadan√© ≈æiadne d√°ta na vytvorenie z√°lohy.'); setLoadingState(btn, false, "Vytvori≈• z√°lohu (XLSX)"); return;
        }
        try {
            const wb = XLSX.utils.book_new();
            const settings_ws_data = [["Nastavenie", "Hodnota"]];
            Object.entries(appSettings).forEach(([key, value]) => settings_ws_data.push([key, value === null ? "" : value]));
            const settings_ws = XLSX.utils.aoa_to_sheet(settings_ws_data); settings_ws['!cols'] = [{wch:25}, {wch:30}]; XLSX.utils.book_append_sheet(wb, settings_ws, "NastaveniaAplikacie");
            
            const work_ws_data = [["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Projekt/√öloha", "Pozn√°mka"]];
            if (workData.data && Array.isArray(workData.data)) {
                workData.data.forEach((row, index) => work_ws_data.push([`${index + 1}. ${getDayName(currentYear, currentMonth, index + 1)}`, row.start || "", row.end || "", row.breakTime || "", row.projectTag || "", row.note || ""]));
            }
            work_ws_data.push([]); work_ws_data.push(["Mesiac z√°lohy (index 0-11)", currentMonth]); work_ws_data.push(["Rok z√°lohy", currentYear]);
            const work_ws = XLSX.utils.aoa_to_sheet(work_ws_data); work_ws['!cols'] = [{wch:15}, {wch:10}, {wch:10}, {wch:15}, {wch:30}, {wch:40}]; XLSX.utils.book_append_sheet(wb, work_ws, `Vykaz ${MONTH_NAMES[currentMonth]} ${currentYear}`);
            
            const safeName = (appSettings.employeeName || 'VseobecnaZaloha').replace(/[^a-zA-Z0-9]/g, '_');
            XLSX.writeFile(wb, `Zaloha_BrunoCalcPro_${safeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.xlsx`); showSaveNotification('Z√°loha bola √∫spe≈°ne vytvoren√° a stiahnut√°.');
        } catch(error) { console.error("Error creating backup:", error); showErrorNotification('Nastala chyba pri vytv√°ran√≠ z√°lohy: ' + error.message); }
        finally { setLoadingState(btn, false, "Vytvori≈• z√°lohu (XLSX)"); }
    };
    window.restoreBackup = function() {
        const btn = event.target; const input = document.createElement('input'); input.type = 'file'; input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        input.onchange = async (event) => {
            setLoadingState(btn, true, "Sprac√∫vam s√∫bor z√°lohy..."); const file = event.target.files[0];
            if (!file) { setLoadingState(btn, false, "Obnovi≈• z√°lohu (XLSX)"); return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const fileData = new Uint8Array(e.target.result); const workbook = XLSX.read(fileData, {type:'array'});
                    let restoredAppSettings = {}, restoredWorkDataArray = [], backupMonth = currentMonth, backupYear = currentYear;

                    const settingsSheetName = workbook.SheetNames.find(name => name.toLowerCase().includes("nastaveniaaplikacie"));
                    if (settingsSheetName) {
                        const ws = workbook.Sheets[settingsSheetName]; const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i]; if (row && row[0] !== undefined && appSettings.hasOwnProperty(row[0])) {
                                const key = row[0]; let value = row[1];
                                if (key === 'hourlyWage' || key === 'taxRate' || key === 'monthlyEarningsGoal') value = (value === "" || value === null) ? null : parseFloat(value);
                                else if (key === 'decimalPlaces') value = parseInt(value);
                                else if (key === 'theme' && (value === 'light' || value === 'dark')) { /* value is already string */ }
                                else if (key === 'employeeName') value = String(value);
                                
                                if ( (typeof value === 'number' && !isNaN(value)) || typeof value === 'string' || value === null) {
                                    restoredAppSettings[key] = value;
                                }
                            }
                        }
                         if (restoredAppSettings.monthlyEarningsGoal !== undefined && isNaN(restoredAppSettings.monthlyEarningsGoal)) restoredAppSettings.monthlyEarningsGoal = null;

                    } else showWarningNotification("List 'NastaveniaAplikacie' nebol n√°jden√Ω. Nastavenia nebud√∫ obnoven√©.");

                    const workSheetName = workbook.SheetNames.find(name => name.toLowerCase().startsWith("vykaz"));
                    if (workSheetName) {
                        const ws = workbook.Sheets[workSheetName]; const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                        const headerRowIndex = jsonData.findIndex(row => row && row[0] && row[0].toString().toLowerCase().includes("de≈à"));
                        if (headerRowIndex !== -1) {
                            const colMap = { day: 0, start: 1, end: 2, break: 3, project: 4, note: 5 };
                            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (!row || !row[colMap.day] || !row[colMap.day].toString().match(/^\d+\./)) {
                                    if (row && row[0] && row[0].toString().toLowerCase().includes("mesiac z√°lohy")) backupMonth = parseInt(row[1]);
                                    if (row && row[0] && row[0].toString().toLowerCase().includes("rok z√°lohy")) backupYear = parseInt(row[1]);
                                    if (isNaN(backupMonth) || backupMonth < 0 || backupMonth > 11) backupMonth = currentMonth;
                                    if (isNaN(backupYear) || backupYear < 2000) backupYear = currentYear;
                                    continue;
                                }
                                restoredWorkDataArray.push({ start: row[colMap.start] || "", end: row[colMap.end] || "", breakTime: row[colMap.break] ? row[colMap.break].toString().replace(',', '.') : "", projectTag: row[colMap.project] || "", note: row[colMap.note] || ""});
                            }
                        } else showWarningNotification(`List '${workSheetName}' nem√° spr√°vnu hlaviƒçku. D√°ta mesiaca nebud√∫ obnoven√©.`);
                    } else showWarningNotification("List s d√°tami mesiaca ('Vykaz...') nebol n√°jden√Ω. D√°ta nebud√∫ obnoven√©.");

                    if (Object.keys(restoredAppSettings).length === 0 && restoredWorkDataArray.length === 0 && !workSheetName && !settingsSheetName) { showErrorNotification("Z√°loha neobsahuje platn√© d√°ta alebo m√° nespr√°vny form√°t."); setLoadingState(btn, false, "Obnovi≈• z√°lohu (XLSX)"); return; }
                    const confirmMsg = `Obnovi≈• d√°ta? ${Object.keys(restoredAppSettings).length > 0 ? 'Nastavenia bud√∫ aktualizovan√©. ' : ''}${restoredWorkDataArray.length > 0 || workSheetName ? `D√°ta pre ${MONTH_NAMES[backupMonth]} ${backupYear} bud√∫ obnoven√© (${restoredWorkDataArray.length} dn√≠). ` : ''}Neulo≈æen√© zmeny m√¥≈æu by≈• prep√≠san√©.`;
                    if (!confirm(confirmMsg)) { setLoadingState(btn, false, "Obnovi≈• z√°lohu (XLSX)"); return; }

                    let settingsChanged = false;
                    if (Object.keys(restoredAppSettings).length > 0) {
                        Object.assign(appSettings, restoredAppSettings);
                        Object.entries(appSettings).forEach(([key, value]) => localStorage.setItem(key, value));
                        updateSettingsUIInputs();
                        if (restoredAppSettings.theme) ThemeManager.applyTheme(restoredAppSettings.theme);
                        settingsChanged = true;
                        if (currentUser) debouncedSaveAppSettingsToFirestore();
                    }

                    let monthDataRestored = false;
                    if (restoredWorkDataArray.length > 0 || (workSheetName && restoredWorkDataArray.length === 0 )) {
                        monthDataRestored = true;
                        if (backupMonth !== currentMonth || backupYear !== currentYear) {
                            currentMonth = backupMonth; currentYear = backupYear;
                            uiRefs.monthSelect.value = currentMonth; uiRefs.yearSelect.value = currentYear;
                            if (parseInt(uiRefs.yearSelect.value) !== backupYear) changeYear();
                            else if (parseInt(uiRefs.monthSelect.value) !== backupMonth) changeMonth();
                            else { createTable(); setupFirestoreWorkDataListener(); updatePageTitleAndGreeting(); }
                        } else { createTable(); if (currentListenerUnsubscribe) currentListenerUnsubscribe(); setupFirestoreWorkDataListener(); }
                        
                        const workDataToApply = { data: restoredWorkDataArray, lastUpdated: new Date().toISOString() };
                        const workDataString = JSON.stringify(workDataToApply);
                        const restoreMonthDocId = getFirestoreDocId(currentYear, currentMonth);
                        localStorage.setItem(getLocalStorageKeyForWorkData(restoreMonthDocId), workDataString);
                        parseAndApplyWorkData(workDataString);
                        const pendingKey = getPendingSyncKeyForMonth(restoreMonthDocId);
                        if (currentUser) {
                            if (navigator.onLine) { try { await saveWorkDataToFirestore(workDataToApply, restoreMonthDocId); removeMonthFromPendingList(restoreMonthDocId); if (pendingKey) localStorage.removeItem(pendingKey); } catch (error) { addMonthToPendingList(restoreMonthDocId); if (pendingKey) localStorage.setItem(pendingKey, workDataString); } }
                            else { addMonthToPendingList(restoreMonthDocId); if (pendingKey) localStorage.setItem(pendingKey, workDataString); }
                        }
                    } else if (settingsChanged) { recalculateAllRowsAndUpdateTotal(); }
                    showSaveNotification('Z√°loha bola √∫spe≈°ne obnoven√°.');
                } catch (error) { console.error("Error restoring backup:", error); showErrorNotification('Chyba pri obnove z√°lohy: ' + error.message); }
                finally { setLoadingState(btn, false, "Obnovi≈• z√°lohu (XLSX)"); input.value = ''; }
            };
            reader.onerror = () => { showErrorNotification('Chyba pri ƒç√≠tan√≠ s√∫boru.'); setLoadingState(btn, false, "Obnovi≈• z√°lohu (XLSX)"); }
            reader.readAsArrayBuffer(file);
        };
        input.click();
    };

    window.changeMonth = function() { currentMonth = parseInt(uiRefs.monthSelect.value); createTable(); setupFirestoreWorkDataListener(); updatePageTitleAndGreeting(); }
    window.changeYear = function() { currentYear = parseInt(uiRefs.yearSelect.value); createTable(); setupFirestoreWorkDataListener(); updatePageTitleAndGreeting(); }

    uiRefs.toggleSettingsBtn.addEventListener('click', () => { const isVisible = uiRefs.settingsCollapsibleContent.classList.toggle('visible'); uiRefs.toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia aplik√°cie ‚ñ≤' : 'Zobrazi≈• nastavenia aplik√°cie ‚ñº'; uiRefs.toggleSettingsBtn.setAttribute('aria-expanded', isVisible); });
    window.addEventListener('online', () => { handleOnlineStatusChange(true); if(currentUser) { syncPendingWorkData(); debouncedSaveAppSettingsToFirestore(); } });
    window.addEventListener('offline', () => { handleOnlineStatusChange(false); });
    function handleOnlineStatusChange(online) { const message = online ? 'Ste op√§≈• online. Synchroniz√°cia d√°t m√¥≈æe prebieha≈•.' : 'Ste offline. Zmeny sa bud√∫ uklada≈• lok√°lne a synchronizuj√∫ sa po pripojen√≠.'; showNotification(online ? 'saveNotification' : 'warningNotification', message, online ? 3000: 4000); }

    onAuthStateChanged(auth, async (user) => {
        currentUser = user; updateUIForAuthStateChange();
        const authContainerElement = document.getElementById('auth-container');
        if (authContainerElement) { authContainerElement.style.display = 'block'; }
        if (user) {
            const settingsLoadedFromFS = await loadUserAppSettingsFromFirestore();
            if (!settingsLoadedFromFS) {
                loadAppSettingsFromLocalStorage();
                updateSettingsUIInputs();
                ThemeManager.applyTheme(appSettings.theme);
                if (navigator.onLine) await saveAppSettingsToFirestore();
            }
            await syncPendingWorkData();
        } else {
            loadAppSettingsFromLocalStorage(); updateSettingsUIInputs();
            ThemeManager.applyTheme(appSettings.theme);
            localStorage.removeItem(PENDING_SYNC_MONTHS_LS_KEY); updateAppBadge(0);
        }
        createTable(); setupFirestoreWorkDataListener(); updatePageTitleAndGreeting();
        if (uiRefs.appLoader) uiRefs.appLoader.style.display = 'none';
        if (uiRefs.mainContainer) uiRefs.mainContainer.style.display = 'block';
    });

    initializeUI();

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => { /* console.log('Service Worker registered successfully', reg); */ })
          .catch(err => { console.error('Service Worker registration failed:', err); });
      });
    }
  </script>
</body>
</html>
