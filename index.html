<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- Z√°kladn√© ≈°t√Ωly --- */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
     h2 {
       text-align: center;
       color: #555;
       margin-top: -10px;
       font-size: 1.2em;
     }
     .settings {
       margin-bottom: 20px;
       display: flex;
       flex-wrap: wrap;
       align-items: flex-start;
     }
     .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 2px 5px; }
     .settings > div { flex: 1 1 200px; }
     .settings > button#toggleSettingsBtn { /* ... bez zmien ... */ }
     body.dark-mode .settings > button#toggleSettingsBtn { /* ... bez zmien ... */ }
     .settings > button.highlight { flex: 1 1 150px; }
     .settings label { display: block; margin-bottom: 2px; }
     #settings-collapsible-content { /* ... bez zmien ... */ }
     #settings-collapsible-content.visible { /* ... bez zmien ... */ }
     #settings-collapsible-content > div { /* ... bez zmien ... */ }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 1000px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: middle; }
    th { background-color: #f2f2f2; }

    /* ≈†t√Ωly pre ƒçasov√© tlaƒçidl√° */
    td .time-input-wrapper { display: flex; align-items: center; gap: 4px; }
    td .time-input-wrapper input[type="tel"] { flex-grow: 1; min-width: 60px; }
    td .time-input-wrapper .time-btn { /* ... bez zmien ... */ }
    td .time-input-wrapper .time-btn:hover { /* ... bez zmien ... */ }
    body.dark-mode td .time-input-wrapper .time-btn { /* ... bez zmien ... */ }
    body.dark-mode td .time-input-wrapper .time-btn:hover { /* ... bez zmien ... */ }

    /* ≈†√≠rky stƒ∫pcov */
    th:nth-child(7), td:nth-child(7), /* Hrub√° Mzda */
    th:nth-child(8), td:nth-child(8) { width: 14%; } /* ƒåist√° Mzda */
    th:nth-child(6), td:nth-child(6) { width: 20%; } /* Pozn√°mka */
    th:nth-child(1), td:nth-child(1) { width: 7%; } /* De≈à */
    th:nth-child(2), td:nth-child(2) { width: 10%; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { width: 10%; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 7%; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { width: 10%; } /* Odpracovan√© */
    th:nth-child(9), td:nth-child(9) { width: 8%; text-align: center; } /* Akcia */

    /* V≈°eobecn√© ≈°t√Ωly pre inputy a select */
    input[type="tel"], input[type="number"], input[type="text"], select, textarea { /* Pridan√° textarea */
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      font-size: 14px; /* Zjednoten√° veƒækos≈• p√≠sma */
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
      font-family: inherit; /* Preberie font z body */
    }
    input[type="tel"], input[type="number"], input[type="text"], select {
       background-color: #ffffd0; /* ≈Ωlt√© pozadie pre tieto typy */
    }

    /* === NOV√â / UPRAVEN√â: ≈†pecifick√© ≈°t√Ωly pre textarea pozn√°mky === */
    textarea[id^="note-"] {
        background-color: #e6faff; /* Svetlomodr√© pozadie */
        height: 45px; /* Fixn√° v√Ω≈°ka (cca 2 riadky) */
        line-height: 1.4; /* Mierne v√§ƒç≈°√≠ riadkov√Ω rozostup */
        overflow-y: auto; /* Zobraz√≠ vertik√°lny scrollbar ak je text dlh≈°√≠ */
        resize: none; /* Zak√°≈æe pou≈æ√≠vateƒæovi meni≈• veƒækos≈• */
        vertical-align: top; /* Lep≈°ie zarovnanie pre viacriadkov√Ω text */
    }
    /* Uprav√≠me aj zarovnanie bunky s textareou */
    td:has(textarea[id^="note-"]) {
         vertical-align: top;
     }

    /* Tlaƒçidl√° a ostatn√© prvky */
    .result { /* Bez zmien */ }
    .btn-container { /* Bez zmien */ }
    .btn { /* Bez zmien */ }
    .reset-btn { /* Bez zmien */ }
    .reset-btn:hover { /* Bez zmien */ }
    .export-btn { /* Bez zmien */ }
    .export-btn:hover { /* Bez zmien */ }
    .backup-btn { /* Bez zmien */ }
    .backup-btn:hover { /* Bez zmien */ }
    .highlight { /* Bez zmien */ }
    #totalSalary { /* Bez zmien */ }
    #dataSizeContainer { /* Bez zmien */ } /* ... atƒè ... */

    /* Zv√Ωraznenie aktu√°lneho d≈àa */
    .current-day { background-color: #8a2be2 !important; color: white; }
    .current-day input, .current-day select, .current-day textarea { /* Pridan√° textarea */
        background-color: #9932cc !important; color: white !important; border-color: #b366ff !important;
    }
    .current-day input::placeholder, .current-day textarea::placeholder { /* Pridan√° textarea */
        color: #e0c0ff !important; opacity: 1; /* Opacity pre Firefox */
    }
    /* ≈†pecifick√° farba pozadia pre textareu v aktu√°lnom dni */
    .current-day textarea[id^="note-"] {
         background-color: #aa44dd !important;
    }
    .current-day .time-btn { color: white !important; }
    .current-day .time-btn:hover { background-color: #7a1fb4 !important; border-color: #9932cc !important; }

    /* --- Tmav√Ω re≈æim --- */
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    body.dark-mode .container { background-color: #444; color: #f4f4f4; }
    body.dark-mode h1 { color: #f4f4f4; }
    body.dark-mode h2 { color: #bbb; }
    body.dark-mode table { background-color: #555; color: #f4f4f4; }
    body.dark-mode th { background-color: #666; }
    body.dark-mode td { background-color: #444; color: #f4f4f4; border-color: #555; }
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"],
    body.dark-mode input[type="text"], body.dark-mode select, body.dark-mode textarea { /* Pridan√° textarea */
      background-color: #666; color: white; border-color: #555;
    }
    body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { /* Pridan√° textarea */
      color: #aaa; opacity: 1;
    }
    /* === NOV√â / UPRAVEN√â: Tmav√Ω re≈æim pre textarea pozn√°mky === */
    body.dark-mode textarea[id^="note-"] {
        background-color: #5a5a7a; /* Tmavomodro≈°ed√° */
        border-color: #4a4a6a;
        color: #f0f0f0; /* Svetlej≈°√≠ text */
    }
    /* Ostatn√© tmav√© ≈°t√Ωly ... bez zmien ... */
    body.dark-mode .btn { color: #f4f4f4; }
    body.dark-mode .reset-btn { background-color: #d32f2f; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode #login-form a { color: #6bbaff; }
    /* === UPRAVEN√â: Aktu√°lny de≈à v tmavom re≈æime pre textarea === */
    body.dark-mode .current-day { background-color: #4a0e8f !important; color: #fff; }
    body.dark-mode .current-day input, body.dark-mode .current-day select, body.dark-mode .current-day textarea { /* Pridan√° textarea */
        background-color: #5c1db3 !important; color: #fff !important; border-color: #7e4bd7 !important;
    }
    body.dark-mode .current-day input::placeholder, body.dark-mode .current-day textarea::placeholder { /* Pridan√° textarea */
        color: #c5a5f5 !important; opacity: 1;
    }
    /* ≈†pecifick√° farba pozadia pre textareu v aktu√°lnom dni v tmavom re≈æime */
    body.dark-mode .current-day textarea[id^="note-"] {
         background-color: #6c2fc7 !important;
     }
     body.dark-mode .current-day .time-btn { /* Bez zmien */ }
     body.dark-mode .current-day .time-btn:hover { /* Bez zmien */ }

    /* --- Responzivita (Media Queries) --- */
    @media (max-width: 768px) { /* Bez zmien v ≈°trukt√∫re, len veƒækosti */
      body { padding: 5px; } .container { padding: 10px; }
      h1 { font-size: 1.8em; } h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#toggleSettingsBtn { flex-basis: auto; width: 100%; margin-bottom: 10px; }
      .settings > button.highlight { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 1000px; } th, td { padding: 6px; font-size: 0.8em; }
      td .time-input-wrapper .time-btn { font-size: 1em; padding: 1px 3px; }
      /* === NOV√â: V√Ω≈°ka textarey na men≈°√≠ch obrazovk√°ch === */
      textarea[id^="note-"] { height: 40px; font-size: 0.8em; } /* Trochu men≈°ia */
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; }
      .backup-btn { padding: 15px 16px; } #totalSalary { font-size: 16px; }
      #dataSizeContainer { font-size: 12px; }
    }
    @media (max-width: 480px) { /* Bez zmien v ≈°trukt√∫re, len veƒækosti */
      h1 { font-size: 1.5em; } th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; } .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea { /* Pridan√° textarea */
        font-size: 12px;
      }
      table { min-width: 1000px; }
      .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 5px 0; }
      #settings-collapsible-content > div { margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 700px; }
      td .time-input-wrapper .time-btn { font-size: 0.9em; padding: 1px 2px; }
      /* === NOV√â: V√Ω≈°ka textarey na najmen≈°√≠ch obrazovk√°ch === */
      textarea[id^="note-"] { height: 35px; font-size: 0.7em; } /* E≈°te men≈°ia */
    }

    /* Notifik√°cie */
    #saveNotification, #errorNotification { /* ... Bez zmien ... */ }
    #saveNotification.show, #errorNotification.show { /* ... Bez zmien ... */ }
    #saveNotification { /* ... Bez zmien ... */ }
    #errorNotification { /* ... Bez zmien ... */ }

    /* Prihlasovanie */
    #login-form { /* ... Bez zmien ... */ }
    #login-form input[type="email"], #login-form input[type="password"] { /* ... Bez zmien ... */ }
    #login-form .btn { /* ... Bez zmien ... */ }
    #login-form a { /* ... Bez zmien ... */ }
    #login-form a:hover { /* ... Bez zmien ... */ }

  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2></h2>

    <div class="settings">
        <button id="toggleSettingsBtn" class="btn">Zobrazi≈• nastavenia ‚ñº</button>
        <div id="settings-collapsible-content">
            <div> <label for="employeeNameInput">Meno pracovn√≠ka: </label> <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()"> </div>
            <div> <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label> <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"> </div>
            <div> <label for="taxRateInput">Da≈àov√© percento (%): </label> <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"> </div>
            <div> <label for="monthSelect">Mesiac: </label> <select id="monthSelect" onchange="changeMonth()"> <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option> <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option> <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option> <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option> </select> </div>
            <div> <label for="yearSelect">Rok: </label> <select id="yearSelect" onchange="changeYear()"></select> </div>
            <div> <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label> <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"> <option value="1">1</option> <option value="2">2</option> </select> </div>
        </div>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
       <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
        <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Tmav√Ω re≈æim, Firebase importy, Firebase config, Firebase init ... bez zmien ...
     if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
     window.toggleDarkMode = function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }
     import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
     import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
     import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
     import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';
     const firebaseConfig = { apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", authDomain: "uuuuu-f7ef9.firebaseapp.com", projectId: "uuuuu-f7ef9", storageBucket: "uuuuu-f7ef9.appspot.com", messagingSenderId: "456105865458", appId: "1:456105865458:web:101f0a4dcb455f174b606b" };
     const app = initializeApp(firebaseConfig);
     try { const appCheck = initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), isTokenAutoRefreshEnabled: true }); } catch (e) { console.warn("App Check init failed:", e); }
     const auth = getAuth(app); const db = getFirestore(app);

    // Glob√°lne premenn√© ... bez zmien ...
    let currentUser = null; const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const mainTitle = document.getElementById('mainTitle'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const toggleSettingsBtn = document.getElementById('toggleSettingsBtn'); const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');
    const currentDate = new Date(); let currentMonth = currentDate.getMonth(); let currentYear = currentDate.getFullYear(); let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1; let employeeName = localStorage.getItem('employeeName') || ''; let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10; let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;

    // Aktualiz√°cia pozdravu (upraven√°)
    function updateGreeting() { /* ... k√≥d UPRAVEN√ù v predch√°dzaj√∫cej odpovedi ... */
         if (employeeName) { const firstName = employeeName.split(' ')[0]; mainTitle.textContent = `Vitaj ${firstName} üëã`; }
         else { mainTitle.textContent = 'Vitaj üëã'; }
    }

    // Popul√°cia rokov ... bez zmien ...
    function populateYearSelect() { /* ... k√≥d bez zmeny ... */ }
    populateYearSelect();

    // Nastavenie poƒçiatoƒçn√Ωch hodn√¥t UI ... bez zmien ...
    monthSelect.value = currentMonth; yearSelect.value = currentYear; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName; hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1);
    updateGreeting();

    // Skr√Ωvanie nastaven√≠ ... bez zmien ...
     if (toggleSettingsBtn && settingsCollapsibleContent) { /* ... k√≥d bez zmeny ... */ }

    // Online/Offline monitoring a notifik√°cie ... bez zmien ...
    function isOnline() { return navigator.onLine; } /* ... zvy≈°ok k√≥du bez zmeny ... */
    window.addEventListener('online', () => { console.log('Online'); showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { console.log('Offline'); showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { /* ... k√≥d bez zmeny ... */ }
    function showErrorNotification(message) { /* ... k√≥d bez zmeny ... */ }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') { /* ... k√≥d bez zmeny ... */ }

    // Autentifik√°cia ... bez zmien ...
    window.login = async function() { /* ... k√≥d bez zmeny ... */ }; window.register = async function() { /* ... k√≥d bez zmeny ... */ }; window.logout = async function() { /* ... k√≥d bez zmeny ... */ }; window.resetPassword = async function() { /* ... k√≥d bez zmeny ... */ }; function mapFirebaseAuthError(errorCode) { /* ... k√≥d bez zmeny ... */ } async function createUserCollection() { /* ... k√≥d bez zmeny ... */ }

    // UI Update a Logika Naƒç√≠tania ... bez zmien ...
    function updateUI() { /* ... k√≥d bez zmeny ... */ } async function loadInitialData() { /* ... k√≥d bez zmeny ... */ } async function loadFromFirestoreAndApply() { /* ... k√≥d bez zmeny ... */ }

    // Ukladanie (Debounce) ... bez zmien ...
    function debounce(func, wait) { /* ... k√≥d bez zmeny ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);

    // Zber d√°t z tabuƒæky (s textarea) - logika rovnak√°
    function collectCurrentData() { /* ... k√≥d bez ZMENY oproti predch√°dzaj√∫cej verzii s pozn√°mkou ... */
        const saveData = { data: [], hourlyWage, taxRate, employeeName, decimalPlaces, lastUpdated: new Date().toISOString() };
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const note = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value || ''; // St√°le ƒç√≠tame .value
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            saveData.data.push({ start, end, breakTime, note, gross, net });
        } return saveData;
    }

    // Ukladanie do Firestore ... bez zmien ...
    async function saveToFirestore() { /* ... k√≥d bez zmeny ... */ }
    // Synchroniz√°cia ... bez zmien ...
    async function syncWithFirebase() { /* ... k√≥d bez zmeny ... */ }
    // Manu√°lne naƒç√≠tanie z Firestore ... bez zmien ...
    window.loadFromFirestore = async function() { /* ... k√≥d bez zmeny ... */ };
    // Naƒç√≠tanie LEN z localStorage ... bez zmien ...
    function loadFromLocalStorageOnly() { /* ... k√≥d bez zmeny ... */ }

    // Spracovanie JSON a aplikovanie d√°t (s textarea) - logika rovnak√°
    function parseAndApplyData(dataString) { /* ... k√≥d bez ZMENY oproti predch√°dzaj√∫cej verzii s pozn√°mkou ... */
        try {
            const storedData = JSON.parse(dataString);
            // ... (naƒç√≠tanie nastaven√≠ ako predt√Ωm) ...
            hourlyWage = storedData.hourlyWage !== undefined ? storedData.hourlyWage : hourlyWage; taxRate = storedData.taxRate !== undefined ? storedData.taxRate : taxRate; employeeName = storedData.employeeName !== undefined ? storedData.employeeName : employeeName; decimalPlaces = storedData.decimalPlaces !== undefined ? storedData.decimalPlaces : decimalPlaces;
            hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1); employeeNameInput.value = employeeName; decimalPlacesSelect.value = decimalPlaces; updateGreeting();
            localStorage.setItem('hourlyWage', hourlyWage); localStorage.setItem('taxRate', taxRate); localStorage.setItem('employeeName', employeeName); localStorage.setItem('decimalPlaces', decimalPlaces);

            if (storedData.data && Array.isArray(storedData.data)) {
                const daysInMonth = getDaysInMonth(currentMonth);
                const daysToProcess = Math.min(daysInMonth, storedData.data.length);
                for (let index = 0; index < daysToProcess; index++) {
                    const day = storedData.data[index]; const i = index + 1;
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                    const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
                    if (startElement && endElement && breakElement && noteElement) {
                        startElement.value = day.start || ''; endElement.value = day.end || '';
                        breakElement.value = day.breakTime || ''; noteElement.value = day.note || ''; // St√°le nastavujeme .value
                        calculateRow(i);
                    }
                }
                for (let i = daysToProcess + 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { resetRow(i, false); } }
            } else { const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); } }
            calculateTotal();
        } catch (error) { console.error('Chyba parseAndApplyData:', error); /* ... error handling ... */ }
    }

    // Tvorba tabuƒæky a v√Ωpoƒçty
    function getDayName(year, month, day) { /* ... k√≥d bez zmeny ... */ }

    // === UPRAVEN√â: Tvorba tabuƒæky (s textarea) ===
    function createTable() {
        console.log(`Vytv√°ram ≈°trukt√∫ru tabuƒæky pre ${getMonthName(currentMonth)} ${currentYear}`);
        workDays.innerHTML = ''; const today = new Date();
        const currentDayOfMonth = today.getDate(); const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) { row.classList.add('current-day'); }
            const dayName = getDayName(currentYear, currentMonth, i);
            const startId = `start-${currentYear}-${currentMonth}-${i}`; const endId = `end-${currentYear}-${currentMonth}-${i}`;
            const breakId = `break-${currentYear}-${currentMonth}-${i}`; const noteId = `note-${currentYear}-${currentMonth}-${i}`;
            // Pou≈æitie <textarea> namiesto <input> pre pozn√°mku
            row.innerHTML = `<td>${i}. ${dayName}</td>
                <td><div class="time-input-wrapper"><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}')"><span class="time-btn" onclick="setCurrentTime('${startId}')" title="Zada≈• aktu√°lny ƒças">üïí</span></div></td>
                <td><div class="time-input-wrapper"><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}')"><span class="time-btn" onclick="setCurrentTime('${endId}')" title="Zada≈• aktu√°lny ƒças">üïí</span></div></td>
                <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
                <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
                <td><textarea id="${noteId}" placeholder="Pozn√°mka..." rows="1" oninput="calculateAndUpdateTotals()"></textarea></td>
                <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
                <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>`;
            workDays.appendChild(row);
        } console.log('≈†trukt√∫ra tabuƒæky vytvoren√°.');
    }

    // Z√°pis aktu√°lneho ƒçasu ... bez zmien ...
    window.setCurrentTime = function(inputId) { /* ... k√≥d bez zmeny ... */ };

    // Handler pre inputy ... bez zmien ...
    window.handleInput = function(input, nextId) { formatAndMoveNext(input, nextId); calculateAndUpdateTotals(); }
    window.handleBreakInput = function(day) { /* ... valid√°cia ... */ calculateRow(day); calculateAndUpdateTotals(); }

    // Hlavn√° funkcia pre ukladanie d√°t ... bez zmien ...
    function calculateAndUpdateTotals() { calculateTotal(); const saveData = collectCurrentData(); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(saveData)); debouncedSaveToFirestore(); }

    // Pomocn√© funkcie ... bez zmien ...
    function isValidTimeFormat(timeString) { /* ... k√≥d bez zmeny ... */ } function formatAndMoveNext(input, nextId) { /* ... k√≥d bez zmeny ... */ } function moveNext(currentElement, nextId) { /* ... k√≥d bez zmeny ... */ }

    // V√Ωpoƒçet riadku ... bez zmien ...
    function calculateRow(day) { /* ... k√≥d bez zmeny ... */ }
    // V√Ωpoƒçet ƒçistej mzdy ... bez zmien ...
    function updateNetSalary(day) { /* ... k√≥d bez zmeny ... */ }

    // Vynulovanie riadku (s textarea) - logika rovnak√°
    window.resetRow = function(day, saveChanges = true) { /* ... k√≥d bez ZMENY oproti predch√°dzaj√∫cej verzii s pozn√°mkou ... */
        document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.setAttribute('value', '');
        document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.setAttribute('value', '');
        document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.setAttribute('value', '');
        document.getElementById(`note-${currentYear}-${currentMonth}-${day}`)?.setAttribute('value', ''); // St√°le atrib√∫t
        document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value = '';
        document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value = '';
        document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value = '';
        document.getElementById(`note-${currentYear}-${currentMonth}-${day}`)?.value = ''; // St√°le .value
        calculateRow(day); if (saveChanges) { calculateAndUpdateTotals(); }
    }

    // V√Ωpoƒçet celkov√Ωch s√∫ƒçtov ... bez zmien ...
    function calculateTotal() { /* ... k√≥d bez zmeny ... */ }
    // Pomocn√° funkcia pre n√°zov mesiaca ... bez zmien ...
    function getMonthName(month) { /* ... k√≥d bez zmeny ... */ }

    // Export do PDF (s textarea) - logika rovnak√°
    window.exportToPDF = function() { /* ... k√≥d bez ZMENY oproti predch√°dzaj√∫cej verzii s pozn√°mkou ... */ };
    // Odoslanie zjednodu≈°en√©ho PDF ... bez zmien ...
    window.sendPDF = function() { /* ... k√≥d bez zmeny ... */ };

    // Ostatn√© nastavenia ... bez zmien ...
    window.changeDecimalPlaces = function() { /* ... k√≥d bez zmeny ... */ }; window.updateEmployeeName = function() { /* ... k√≥d bez zmeny ... */ }; window.updateSettings = function() { /* ... k√≥d bez zmeny ... */ }; window.changeMonth = function() { /* ... k√≥d bez zmeny ... */ }; window.changeYear = function() { /* ... k√≥d bez zmeny ... */ }; function getDaysInMonth(month) { /* ... k√≥d bez zmeny ... */ }

    // Init ... bez zmien ...
    onAuthStateChanged(auth, (user) => { console.log('Auth state changed:', user?.email); currentUser = user; updateUI(); });

    // Funkcie pre z√°lohu a obnovu (s textarea) - logika rovnak√°
    window.createBackup = function() { /* ... k√≥d bez ZMENY oproti predch√°dzaj√∫cej verzii s pozn√°mkou ... */ };
    window.restoreBackup = function() { /* ... k√≥d bez ZMENY oproti predch√°dzaj√∫cej verzii s pozn√°mkou ... */ };

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Skontrolujte cestu!
          .then(registration => { console.log('SW zaregistrovan√Ω:', registration.scope); })
          .catch(error => { console.error('SW registr√°cia zlyhala:', error); });
      });
    }
  </script>
</body>
</html>
