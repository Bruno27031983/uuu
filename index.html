<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script> <!-- Updated AutoTable Version -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- Updated XLSX Version -->

  <!-- Pridanie fontu Roboto pre PDF (ak je to možné) -->
  <!-- jsPDF neumožňuje jednoduché pridanie fontu z CDN pre autotable, použijeme vstavaný Helvetica, ktorý má základnú podporu -->

  <style>
    /* Základné štýly */
    :root {
      --primary-bg: #f4f4f4;
      --secondary-bg: white;
      --text-color: #333;
      --input-bg: #ffffd0;
      --input-text: #333;
      --border-color: #ddd;
      --header-bg: #f2f2f2;
      --highlight-bg: #ffcc00;
      --highlight-text: #333;
      --total-bg: #e6f3ff;
      --current-day-bg: #8a2be2;
      --current-day-text: white;
      --current-day-input-bg: #9932cc;
      --current-day-input-text: white;
      --btn-reset-bg: #f44336;
      --btn-reset-hover: #d32f2f;
      --btn-export-bg: #4CAF50;
      --btn-export-hover: #388e3c;
      --btn-backup-bg: #8a2be2;
      --btn-backup-hover: #6a1bb2;
      --notification-save-bg: #4CAF50;
      --notification-error-bg: #f44336;
      --notification-text: white;
      --status-online-bg: #4CAF50;
      --status-offline-bg: #f44336;
      --status-text: white;
      --data-bar-bg: #ddd;
      --data-bar-fill: #4CAF50;
    }

    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--primary-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--secondary-bg);
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-size: 200% 200%; /* Needed for animation */
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px; /* Added gap for better spacing */
    }
    .settings > div {
      flex: 1 1 200px; /* Allow growing and shrinking */
      min-width: 150px; /* Prevent excessive shrinking */
      margin: 5px 0; /* Adjusted margin */
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9em; /* Slightly smaller label */
    }
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Ensure minimum width for layout */
    }
    th, td {
      padding: 8px;
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 0.9em;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    th {
      background-color: var(--header-bg);
      white-space: nowrap; /* Prevent header text wrapping */
    }
    /* Column Widths - Simplified */
    td:nth-child(1), th:nth-child(1) { width: 15%; } /* Day */
    td:nth-child(2), th:nth-child(2) { width: 10%; } /* Príchod */
    td:nth-child(3), th:nth-child(3) { width: 10%; } /* Odchod */
    td:nth-child(4), th:nth-child(4) { width: 10%; } /* Prestávka */
    td:nth-child(5), th:nth-child(5) { width: 20%; } /* Odpracované */
    td:nth-child(6), th:nth-child(6) { width: 12.5%; } /* Hrubá */
    td:nth-child(7), th:nth-child(7) { width: 12.5%; } /* Čistá */
    td:nth-child(8), th:nth-child(8) { width: 10%; } /* Akcia */

    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 6px; /* Adjusted padding */
      box-sizing: border-box;
      background-color: var(--input-bg);
      color: var(--input-text);
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    input[readonly] {
      background-color: #eee; /* Visually distinct readonly fields */
      cursor: not-allowed;
    }

    .result { /* No longer used, replaced by #totalSalary */ }

    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Center buttons */
      gap: 10px; /* Space between buttons */
      margin-top: 20px;
    }
    .btn {
      flex: 0 1 auto; /* Don't grow, allow shrinking, auto basis */
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px; /* Slightly adjusted font size */
      transition: background-color 0.3s ease, transform 0.1s ease;
      text-align: center;
    }
    .btn:active {
      transform: scale(0.98); /* Click feedback */
    }
    .reset-btn { background-color: var(--btn-reset-bg); }
    .reset-btn:hover { background-color: var(--btn-reset-hover); }
    .export-btn { background-color: var(--btn-export-bg); }
    .export-btn:hover { background-color: var(--btn-export-hover); }
    .backup-btn { background-color: var(--btn-backup-bg); }
    .backup-btn:hover { background-color: var(--btn-backup-hover); }
    .toggle-btn { /* Style for dark mode toggle if needed */
        background-color: var(--highlight-bg);
        color: var(--highlight-text);
    }
    .toggle-btn:hover {
       filter: brightness(90%);
    }

    #totalSalary {
      font-size: 16px; /* Adjusted size */
      font-weight: normal; /* Normal weight, use bold inside if needed */
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background-color: var(--total-bg);
      border-radius: 5px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }
    #totalSalary strong {
        font-weight: bold;
    }

    /* Data Size Removed - Often causes more confusion than help */
    /* #dataSizeContainer, #dataSizeBar, #dataSizeFill removed */

    .current-day {
      background-color: var(--current-day-bg) !important; /* Ensure override */
      color: var(--current-day-text) !important;
      font-weight: bold;
    }
    .current-day input, .current-day select {
      background-color: var(--current-day-input-bg) !important;
      color: var(--current-day-input-text) !important;
      border-color: var(--current-day-bg) !important;
    }
    .current-day .btn { /* Style reset button in current day row */
        background-color: var(--btn-reset-hover);
        color: white;
    }

    /* Dark Mode */
    body.dark-mode {
      --primary-bg: #2c3e50; /* Dark blueish grey */
      --secondary-bg: #34495e; /* Slightly lighter dark blueish grey */
      --text-color: #ecf0f1; /* Light grey/white */
      --input-bg: #4a6178; /* Darker input background */
      --input-text: #ecf0f1;
      --border-color: #56708a; /* Darker border */
      --header-bg: #4a6178; /* Darker header */
      --highlight-bg: #f39c12; /* Orange for highlight */
      --highlight-text: #2c3e50;
      --total-bg: #2c3e50; /* Match primary */
      --current-day-bg: #9b59b6; /* Purple */
      --current-day-text: #ecf0f1;
      --current-day-input-bg: #8e44ad; /* Darker Purple */
      --current-day-input-text: #ecf0f1;
      --btn-reset-bg: #e74c3c; /* Red */
      --btn-reset-hover: #c0392b;
      --btn-export-bg: #2ecc71; /* Green */
      --btn-export-hover: #27ae60;
      --btn-backup-bg: #9b59b6; /* Purple */
      --btn-backup-hover: #8e44ad;
      --notification-save-bg: #2ecc71;
      --notification-error-bg: #e74c3c;
      --notification-text: #fff;
      --status-online-bg: #2ecc71;
      --status-offline-bg: #e74c3c;
      --status-text: #fff;
    }

     body.dark-mode input[readonly] {
        background-color: #526d86; /* Darker readonly */
     }


    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4); }
      50% { text-shadow: 0 0 16px rgba(255, 255, 255, 0.8); }
    }

    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .btn-container { justify-content: stretch; } /* Stretch buttons on mobile */
      .btn { flex-grow: 1; font-size: 14px; padding: 10px 15px; }
      #totalSalary { font-size: 14px; padding: 10px; }
      th, td { font-size: 0.85em; padding: 6px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 13px; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.6em; }
      th, td { font-size: 0.8em; padding: 5px; }
      .btn { font-size: 13px; padding: 8px 12px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 12px; }
    }

    /* Notifications */
    #notification-area {
      position: fixed;
      bottom: 15px;
      right: 15px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .notification {
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      color: var(--notification-text);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .notification.save { background-color: var(--notification-save-bg); }
    .notification.error { background-color: var(--notification-error-bg); }
    .notification.status { background-color: grey; /* Default status color */ }

    /* Login Form */
    #auth-container {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background-color: var(--primary-bg); /* Match body background */
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 100%;
      max-width: 250px; /* Limit width on larger screens */
      margin: 0 auto;
      display: block;
    }
     #login-form .button-group {
        display: flex;
        gap: 10px;
     }
    #login-form .btn {
      width: auto; /* Let buttons size naturally */
      min-width: 100px;
      margin: 5px 0; /* Vertical margin only */
    }
    #user-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      font-size: 0.9em;
    }
    #user-email {
      font-weight: bold;
      word-break: break-all; /* Prevent long emails breaking layout */
    }
    #user-info .btn {
       padding: 5px 10px; /* Smaller logout button */
       font-size: 13px;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" autocomplete="username">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div class="button-group">
            <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
            <button class="btn backup-btn" onclick="register()">Registrovať</button> <!-- Changed color -->
        </div>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="subTitle">Výkaz Práce</h2> <!-- Added subtitle -->

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daň (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Dynamicky generované roky -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Des. miesta:</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2" selected>2</option> <!-- Default to 2 decimal places -->
        </select>
      </div>
       <div> <!-- Moved toggle button here -->
        <label> </label> <!-- Placeholder label for alignment -->
        <button onclick="toggleDarkMode()" class="btn toggle-btn">Tmavý/Svetlý režim</button>
       </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th> <!-- Clarified unit -->
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary">Načítavam súhrn...</div> <!-- Initial placeholder -->

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu (Excel)</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu (Excel)</button>
    </div>
  </div>

  <div id="notification-area">
      <!-- Notifications will be added here -->
  </div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js'; // Added network control
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // *** VLOŽTE SVOJU KONFIGURÁCIU SEM ***
    const firebaseConfig = {
     apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // POZOR: Tento kľúč je viditeľný v klientovi. Zabezpečte pravidlami Firestore.
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.firebasestorage.app",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };
    // *** KONIEC KONFIGURÁCIE ***

    // Inicializácia Firebase
    let app, appCheck, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        // AppCheck - dôležité pre bezpečnosť, vyžaduje konfiguráciu v Google Cloud Console
        appCheck = initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Vymeňte za VÁŠ SITE KEY reCAPTCHA v3
          isTokenAutoRefreshEnabled: true
        });
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase inicializovaný úspešne.");
    } catch (error) {
        console.error("Chyba pri inicializácii Firebase:", error);
        showNotification('Chyba pripojenia k databáze. Skúste obnoviť stránku.', 'error');
    }

    // -------------------- GLOBÁLNE PREMENNÉ A KONŠTANTY --------------------
    let currentUser = null;
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const subTitle = document.getElementById('subTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const notificationArea = document.getElementById('notification-area');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('brunoCalc_decimalPlaces') || '2'); // Default 2
    let employeeName = localStorage.getItem('brunoCalc_employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('brunoCalc_hourlyWage') || '10'); // Load from LS
    let taxRate = parseFloat(localStorage.getItem('brunoCalc_taxRatePercent') || '2') / 100; // Load from LS
    let isDarkMode = localStorage.getItem('brunoCalc_darkMode') === 'true';
    // monthData nie je potrebné globálne, načítavame priamo pre mesiac

    const SAVE_DEBOUNCE_MS = 1500; // Dlhší debounce pre menej časté ukladanie
    const MONTH_NAMES = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
    const DAY_NAMES = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; // Krátke názvy

    // -------------------- POMOCNÉ FUNKCIE --------------------
    const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
    const getDayNameShort = (year, month, day) => DAY_NAMES[new Date(year, month, day).getDay()];
    const formatCurrency = (value) => value.toFixed(decimalPlaces);
    const formatHours = (value) => value.toFixed(decimalPlaces);
    const getLocalStorageKey = (year, month) => `brunoCalc_workData_${year}-${month}`;
    const getFirestoreDocId = (year, month) => `${year}-${String(month + 1).padStart(2, '0')}`; // Firestore ID YYYY-MM


    // -------------------- FUNKCIE PRE ROKY (select) --------------------
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = currentDate.getFullYear() + 5; // Show future years
      yearSelect.innerHTML = ''; // Clear previous options
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }

    // -------------------- UI AKTUALIZÁCIE --------------------
    function applyDarkMode(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
        localStorage.setItem('brunoCalc_darkMode', isDark);
        isDarkMode = isDark;
    }
    window.toggleDarkMode = () => applyDarkMode(!isDarkMode);

    function updateUIBasedOnAuthState() {
      const loginForm = document.getElementById('login-form');
      const userInfo = document.getElementById('user-info');
      const userEmailSpan = document.getElementById('user-email');
      const authContainer = document.getElementById('auth-container');

      if (currentUser) {
        loginForm.style.display = 'none';
        userInfo.style.display = 'flex'; // Use flex for alignment
        userEmailSpan.textContent = currentUser.email;
        authContainer.style.borderColor = 'var(--status-online-bg)'; // Green border when logged in
      } else {
        loginForm.style.display = 'flex'; // Use flex
        userInfo.style.display = 'none';
        userEmailSpan.textContent = '';
         authContainer.style.borderColor = 'var(--border-color)'; // Default border
      }
      // Vždy zavolaj createTable pre aktualizáciu/načítanie dát pre aktuálny stav (prihlásený/odhlásený)
      createTable();
    }

    // -------------------- NOTIFIKÁCIE --------------------
    function showNotification(message, type = 'save', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`; // save, error, status
        notification.textContent = message;
        notificationArea.appendChild(notification);

        // Trigger fade in animation
        setTimeout(() => notification.classList.add('show'), 50);

        // Automatically remove after duration
        setTimeout(() => {
            notification.classList.remove('show');
            // Remove from DOM after transition ends
            notification.addEventListener('transitionend', () => notification.remove(), { once: true });
        }, duration);
    }

    // -------------------- MONITOROVANIE ONLINE/OFFLINE --------------------
    function updateOnlineStatus(online) {
        if (!db) return; // Ak Firebase nebol inicializovaný
        const statusMessage = online ? 'Pripojenie obnovené' : 'Ste offline';
        const statusType = online ? 'save' : 'error'; // Použijeme save pre zelenú, error pre červenú
        showNotification(statusMessage, statusType, online ? 2000 : 5000);

        if (online) {
            enableNetwork(db).then(() => {
                console.log("Firebase network enabled.");
                syncPendingData(); // Skús synchronizovať čakajúce dáta
            }).catch(err => console.error("Error enabling network:", err));
        } else {
            disableNetwork(db).then(() => {
                console.log("Firebase network disabled.");
            }).catch(err => console.error("Error disabling network:", err));
        }
    }
    window.addEventListener('online', () => updateOnlineStatus(true));
    window.addEventListener('offline', () => updateOnlineStatus(false));


    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    window.login = async function() {
      if (!navigator.onLine) {
        showNotification('Ste offline. Prihlásenie je možné iba online.', 'error');
        return;
      }
      if (!auth) {
        showNotification('Autentifikačná služba nie je dostupná.', 'error');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) {
          showNotification('Zadajte email aj heslo.', 'error');
          return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged sa postará o zvyšok (updateUI, načítanie dát)
        showNotification('Prihlásenie úspešné.', 'save');
      } catch (error) {
        console.error("Login Error:", error);
        showNotification(`Chyba pri prihlásení: ${error.code || error.message}`, 'error');
      }
    }

    window.register = async function() {
      if (!navigator.onLine) {
        showNotification('Ste offline. Registrácia je možná iba online.', 'error');
        return;
      }
       if (!auth || !db) {
        showNotification('Registračná služba nie je dostupná.', 'error');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
       if (!email || !password) {
          showNotification('Zadajte email aj heslo.', 'error');
          return;
      }
       if (password.length < 6) {
           showNotification('Heslo musí mať aspoň 6 znakov.', 'error');
           return;
       }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // Vytvor počiatočný dokument pre používateľa
        const userRef = doc(db, 'users', userCredential.user.uid);
        await setDoc(userRef, {
          email: userCredential.user.email,
          createdAt: new Date()
        }, { merge: true }); // Merge in case it somehow exists
        // onAuthStateChanged sa postará o zvyšok
         showNotification('Registrácia úspešná. Boli ste prihlásený.', 'save');
      } catch (error) {
         console.error("Registration Error:", error);
         showNotification(`Chyba pri registrácii: ${error.code || error.message}`, 'error');
      }
    }

    window.logout = async function() {
      if (!auth) return;
      try {
        await signOut(auth);
        // onAuthStateChanged sa postará o zvyšok (currentUser=null, updateUI)
        showNotification('Boli ste odhlásený.', 'save');
      } catch (error) {
        console.error("Logout Error:", error);
        showNotification('Chyba pri odhlásení.', 'error');
      }
    }

    // Listener na zmeny stavu prihlásenia
    if (auth) {
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          console.log("Auth state changed. User:", user ? user.uid : 'None');
          updateUIBasedOnAuthState(); // Znovu vykreslí tabuľku a načíta dáta pre prihláseného/odhláseného usera
        });
    }


    // -------------------- UKLADANIE DÁT (Debounce, LocalStorage, Firestore, Pending Sync) --------------------
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    const saveData = async () => {
        const lsKey = getLocalStorageKey(currentYear, currentMonth);
        const pendingKey = `brunoCalc_pendingSync_${currentYear}-${currentMonth}`;
        let dataToSave;

        try {
            dataToSave = {
                settings: { // Ukladaj nastavenia spolu s dátami mesiaca
                    hourlyWage: hourlyWage,
                    taxRatePercent: taxRate * 100, // Uložíme %
                    employeeName: employeeName,
                    decimalPlaces: decimalPlaces,
                },
                days: {}, // Objekt namiesto poľa pre jednoduchší prístup
                lastUpdated: new Date().toISOString()
            };

            const rows = workDaysTbody.querySelectorAll('tr');
            rows.forEach(row => {
                const day = parseInt(row.dataset.day); // Získame deň z data-day atribútu
                if (!isNaN(day)) {
                    const start = row.querySelector(`#start-${currentYear}-${currentMonth}-${day}`).value || '';
                    const end = row.querySelector(`#end-${currentYear}-${currentMonth}-${day}`).value || '';
                    const breakTime = row.querySelector(`#break-${currentYear}-${currentMonth}-${day}`).value || ''; // Bude string
                    // Hodnoty Odpracované, Hrubá, Čistá sa neukladajú, vždy sa prepočítajú

                     // Uložíme len ak je aspoň nejaký vstup pre daný deň
                    if (start || end || breakTime) {
                        dataToSave.days[day] = { start, end, breakTime };
                    }
                }
            });

            // 1. Uložiť do LocalStorage vždy
            localStorage.setItem(lsKey, JSON.stringify(dataToSave));
            console.log(`Data saved to LocalStorage: ${lsKey}`);

            // 2. Uložiť do Firestore, ak sme online a prihlásení
            if (currentUser && navigator.onLine && db) {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const monthDocRef = doc(collection(userDocRef, 'workData'), getFirestoreDocId(currentYear, currentMonth));
                await setDoc(monthDocRef, dataToSave);
                console.log(`Data saved to Firestore: ${getFirestoreDocId(currentYear, currentMonth)}`);
                localStorage.removeItem(pendingKey); // Ak úspešne uložené, odstrániť pending flag
                 showNotification('Dáta uložené a synchronizované.', 'save', 1500);
            }
            // 3. Ak sme offline alebo neprihlásení, označiť pre neskoršiu synchronizáciu
            else if (currentUser && !navigator.onLine) {
                localStorage.setItem(pendingKey, 'true'); // Stačí flag
                 showNotification('Dáta uložené lokálne (offline).', 'save', 1500);
                console.log(`Data marked for sync: ${pendingKey}`);
            } else {
                 showNotification('Dáta uložené lokálne.', 'save', 1500); // Neprihlásený používateľ
            }

        } catch (error) {
            console.error('Chyba pri ukladaní dát:', error);
            showNotification(`Chyba pri ukladaní dát: ${error.message}`, 'error');
            // Ak chyba nastala pri Firestore zápise a sme online, označíme ako pending
            if (currentUser && navigator.onLine) {
                 localStorage.setItem(pendingKey, 'true');
                 console.log(`Data marked for sync due to Firestore error: ${pendingKey}`);
            }
        }
    };
    // Vytvoríme debounced verziu funkcie ukladania
    const debouncedSaveData = debounce(saveData, SAVE_DEBOUNCE_MS);

    // Synchronizácia dát označených ako 'pending'
    async function syncPendingData() {
        if (!currentUser || !navigator.onLine || !db) return;
        console.log("Checking for pending data to sync...");

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('brunoCalc_pendingSync_')) {
                const [,,, year, month] = key.split('_'); // Získame rok a mesiac z kľúča
                const dataKey = `brunoCalc_workData_${year}-${month}`;
                const dataString = localStorage.getItem(dataKey);

                if (dataString) {
                    try {
                        const dataToSync = JSON.parse(dataString);
                        const userDocRef = doc(db, 'users', currentUser.uid);
                        const monthDocRef = doc(collection(userDocRef, 'workData'), getFirestoreDocId(parseInt(year), parseInt(month))); // Firestore YYYY-MM

                        await setDoc(monthDocRef, dataToSync);
                        console.log(`Successfully synced pending data for ${year}-${month}`);
                        localStorage.removeItem(key); // Odstrániť pending flag po úspešnej synchronizácii
                        showNotification(`Dáta za ${MONTH_NAMES[parseInt(month)]} ${year} synchronizované.`, 'save');
                    } catch (error) {
                        console.error(`Error syncing pending data for ${year}-${month}:`, error);
                        showNotification(`Chyba synchronizácie pre ${year}-${month}.`, 'error');
                        // Neodstraňujeme pending flag, skúsime znova neskôr
                    }
                } else {
                    // Ak neexistujú dáta pre pending flag, odstránime flag
                    localStorage.removeItem(key);
                    console.warn(`Removed pending flag for ${year}-${month} as no corresponding data found.`);
                }
            }
        }
    }


    // -------------------- NAČÍTANIE DÁT (Priorita: Firestore -> LocalStorage) --------------------
    async function loadDataForMonth() {
        const lsKey = getLocalStorageKey(currentYear, currentMonth);
        const fsDocId = getFirestoreDocId(currentYear, currentMonth);
        let loadedData = null;
        let loadedFrom = 'Nič'; // 'Firestore', 'LocalStorage'

        // 1. Skúsiť načítať z Firestore (ak sme online a prihlásení)
        if (currentUser && navigator.onLine && db) {
            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const monthDocRef = doc(collection(userDocRef, 'workData'), fsDocId);
                const docSnap = await getDoc(monthDocRef);
                if (docSnap.exists()) {
                    loadedData = docSnap.data();
                    loadedFrom = 'Firestore';
                    // Uložíme do localStorage pre offline prístup
                    localStorage.setItem(lsKey, JSON.stringify(loadedData));
                    console.log(`Data loaded from Firestore: ${fsDocId}`);
                     // Ak existoval pending flag, odstránime ho, keďže sme načítali novšie dáta z FS
                    localStorage.removeItem(`brunoCalc_pendingSync_${currentYear}-${currentMonth}`);
                }
            } catch (error) {
                console.error(`Error loading data from Firestore (${fsDocId}):`, error);
                 showNotification('Chyba pri načítaní dát zo servera.', 'error');
                 // Ak chyba pri načítaní z FS, skúsime LS
            }
        }

        // 2. Ak nenájdené vo Firestore (alebo offline/neprihlásený), skúsiť LocalStorage
        if (!loadedData) {
            const localDataString = localStorage.getItem(lsKey);
            if (localDataString) {
                try {
                    loadedData = JSON.parse(localDataString);
                    loadedFrom = 'LocalStorage';
                    console.log(`Data loaded from LocalStorage: ${lsKey}`);
                } catch (error) {
                    console.error(`Error parsing data from LocalStorage (${lsKey}):`, error);
                    showNotification('Chyba pri načítaní lokálnych dát.', 'error');
                    localStorage.removeItem(lsKey); // Odstrániť poškodené dáta
                }
            }
        }

        console.log(`Data loaded from: ${loadedFrom}`);
        return loadedData; // Vráti načítané dáta alebo null
    }


    // -------------------- TVORBA TABUĽKY A VÝPOČTY --------------------
    async function createTable() {
        console.log(`Creating table for ${MONTH_NAMES[currentMonth]} ${currentYear}`);
        subTitle.textContent = `Výkaz Práce - ${MONTH_NAMES[currentMonth]} ${currentYear}`; // Update subtitle
        workDaysTbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Načítavam dáta...</td></tr>'; // Show loading state

        const loadedMonthData = await loadDataForMonth(); // Počkáme na načítanie dát

        // Aktualizuj globálne nastavenia z načítaných dát (ak existujú)
        if (loadedMonthData?.settings) {
            hourlyWage = parseFloat(loadedMonthData.settings.hourlyWage ?? hourlyWageInput.value);
            taxRate = parseFloat(loadedMonthData.settings.taxRatePercent ?? taxRateInput.value) / 100;
            employeeName = loadedMonthData.settings.employeeName ?? employeeNameInput.value;
            decimalPlaces = parseInt(loadedMonthData.settings.decimalPlaces ?? decimalPlacesSelect.value);

            // Update input fields to reflect loaded settings
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1); // Display as percentage
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;
        } else {
             // Ak žiadne dáta neboli načítané, zabezpečíme, že globálne premenné zodpovedajú inputom
             updateSettingsFromInputs();
        }


        workDaysTbody.innerHTML = ''; // Clear loading state or previous table
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        const today = new Date();
        const isCurrentMonthAndYear = currentMonth === today.getMonth() && currentYear === today.getFullYear();
        const currentDayOfMonth = today.getDate();

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            row.dataset.day = i; // Store day number for easier access
            const isToday = isCurrentMonthAndYear && i === currentDayOfMonth;
            if (isToday) {
                row.classList.add('current-day');
            }

            const dayData = loadedMonthData?.days?.[i] || { start: '', end: '', breakTime: '' }; // Získaj dáta pre deň i alebo prázdny objekt

            row.innerHTML = `
              <td>${i}. ${getDayNameShort(currentYear, currentMonth, i)}</td>
              <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" value="${dayData.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
              <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" value="${dayData.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
              <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" value="${dayData.breakTime}" min="0" step="0.1" placeholder="hod." oninput="handleNumericInput(this)"></td>
              <td id="total-${currentYear}-${currentMonth}-${i}">-</td>
              <td><input type="text" id="gross-${currentYear}-${currentMonth}-${i}" value="-" readonly></td>
              <td><input type="text" id="net-${currentYear}-${currentMonth}-${i}" value="-" readonly></td>
              <td><button class="btn reset-btn" onclick="resetRow(${i})">Reset</button></td>
            `;
            workDaysTbody.appendChild(row);
            calculateRow(i); // Vypočítaj hodnoty pre riadok hneď po vytvorení
        }
        calculateTotal(); // Vypočítaj celkový súhrn po vytvorení všetkých riadkov
        console.log("Table created and populated.");
    }

    window.handleTimeInput = function(input, nextId) {
        formatTimeInput(input); // Format HH:MM
        calculateRow(parseInt(input.id.split('-')[3])); // Recalculate row
        calculateTotal(); // Recalculate total
        debouncedSaveData(); // Trigger save
        // Move focus if format is complete
        if (input.value.length === 5 && input.checkValidity()) {
           moveFocusToNext(nextId);
        }
    }
     window.handleNumericInput = function(input) {
        // Allow only numbers and one decimal point
        input.value = input.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
        calculateRow(parseInt(input.id.split('-')[3])); // Recalculate row
        calculateTotal(); // Recalculate total
        debouncedSaveData(); // Trigger save
        // Optionally move focus if needed, e.g., on Enter key press
    }

    function formatTimeInput(input) {
      let value = input.value.replace(/[^0-9]/g, ''); // Remove non-digits first
      if (value.length > 4) value = value.substring(0, 4);

      if (value.length >= 3) {
          // Insert colon automatically: 123 -> 12:3, 1234 -> 12:34
          value = value.slice(0, 2) + ':' + value.slice(2);
      }
      input.value = value;

      // Basic validation (optional, could be more robust)
       if (value.length === 5) {
            const [h, m] = value.split(':').map(Number);
            if (h < 0 || h > 23 || m < 0 || m > 59) {
                input.setCustomValidity('Neplatný čas (HH:MM)'); // Set validation message
                 // Optionally clear if invalid input.value = '';
            } else {
                 input.setCustomValidity(''); // Clear validation message
            }
       } else if (value.length > 0) {
            input.setCustomValidity('Neúplný čas (HH:MM)');
       } else {
            input.setCustomValidity(''); // Clear if empty
       }
       // input.reportValidity(); // Show validation message bubble (can be annoying)
    }

    function moveFocusToNext(nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) {
        nextElement.focus();
        nextElement.select(); // Select content for easy overwrite
      }
    }

    function parseTime(timeString) {
        if (!timeString || !/^\d{2}:\d{2}$/.test(timeString)) return null;
        const [hours, minutes] = timeString.split(':').map(Number);
        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return null;
        // Vráti celkový počet minút od polnoci
        return hours * 60 + minutes;
    }

    function calculateRow(day) {
        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return; // Element not found

        const startTimeMinutes = parseTime(startInput.value);
        const endTimeMinutes = parseTime(endInput.value);
        const breakHours = parseFloat(breakInput.value) || 0; // Hodiny prestávky
        const breakMinutes = Math.round(breakHours * 60); // Prestávka v minútach

        let workedMinutes = 0;
        let decimalHours = 0;
        let grossSalary = 0;
        let netSalary = 0;

        if (startTimeMinutes !== null && endTimeMinutes !== null) {
            let diff = endTimeMinutes - startTimeMinutes;
            // Handle overnight work
            if (diff < 0) {
                diff += 24 * 60; // Add 24 hours in minutes
            }
            workedMinutes = Math.max(0, diff - breakMinutes); // Ensure non-negative
            decimalHours = workedMinutes / 60;
            grossSalary = decimalHours * hourlyWage;
            netSalary = grossSalary * (1 - taxRate);

            const hours = Math.floor(workedMinutes / 60);
            const minutes = workedMinutes % 60;
            totalCell.textContent = `${hours}h ${minutes}m (${formatHours(decimalHours)} h)`;
            grossInput.value = formatCurrency(grossSalary);
            netInput.value = formatCurrency(netSalary);
        } else {
            // Reset if times are invalid or incomplete
            totalCell.textContent = '-';
            grossInput.value = '-';
            netInput.value = '-';
        }
    }

    window.resetRow = function(day) {
      document.getElementById(`start-${currentYear}-${currentMonth}-${day}`).value = '';
      document.getElementById(`end-${currentYear}-${currentMonth}-${day}`).value = '';
      document.getElementById(`break-${currentYear}-${currentMonth}-${day}`).value = '';
      calculateRow(day); // Recalculate to reset display values
      calculateTotal();
      debouncedSaveData(); // Save the reset state
      // Optionally move focus back to the start input of the reset row
       const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
       if(startInput) startInput.focus();
    }

    function calculateTotal() {
        let totalWorkedMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithEntries = 0;

        const rows = workDaysTbody.querySelectorAll('tr');
        rows.forEach(row => {
            const day = parseInt(row.dataset.day);
            if (isNaN(day)) return; // Skip if row doesn't have a valid day

            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
            const breakVal = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value;

            const startTimeMinutes = parseTime(start);
            const endTimeMinutes = parseTime(end);
            const breakHours = parseFloat(breakVal) || 0;
            const breakMinutes = Math.round(breakHours * 60);

            if (startTimeMinutes !== null && endTimeMinutes !== null) {
                let diff = endTimeMinutes - startTimeMinutes;
                if (diff < 0) diff += 24 * 60;
                const workedMinutes = Math.max(0, diff - breakMinutes);

                if (workedMinutes > 0) {
                    daysWithEntries++;
                    totalWorkedMinutes += workedMinutes;
                    const decimalHours = workedMinutes / 60;
                    totalGrossSalary += decimalHours * hourlyWage;
                    totalNetSalary += (decimalHours * hourlyWage) * (1 - taxRate);
                }
            }
             // Count day even if only break time is entered? Decide based on requirements.
             // Example: Count if break > 0 even without start/end?
             // else if (breakMinutes > 0) { daysWithEntries++; }
        });

        const totalHours = Math.floor(totalWorkedMinutes / 60);
        const totalMinutesRemainder = totalWorkedMinutes % 60;
        const totalDecimalHours = totalWorkedMinutes / 60;

        const averageWorkedMinutes = daysWithEntries > 0 ? totalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = averageWorkedMinutes / 60;
        const averageNetSalary = daysWithEntries > 0 ? totalNetSalary / daysWithEntries : 0;

        totalSalaryDiv.innerHTML = `
          Odpracovaných dní: <strong>${daysWithEntries}</strong><br>
          Celkový čas: <strong>${totalHours}h ${totalMinutesRemainder}m</strong> (${formatHours(totalDecimalHours)} h)<br>
          Priemerný čas / deň: <strong>${averageHours}h ${averageMinutes}m</strong> (${formatHours(averageDecimalHours)} h)<br>
          Hrubá mzda: <strong>${formatCurrency(totalGrossSalary)} €</strong><br>
          Čistá mzda: <strong>${formatCurrency(totalNetSalary)} €</strong><br>
          Priemerná čistá mzda / deň: <strong>${formatCurrency(averageNetSalary)} €</strong>
        `;
    }

    // -------------------- EXPORT DO PDF --------------------
    window.exportToPDF = function() {
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
             showNotification('Chyba: PDF knižnica (jsPDF) nebola načítaná.', 'error');
             return;
        }
        const { jsPDF } = window.jspdf;
         if (typeof jsPDF.API.autoTable !== 'function') {
            showNotification('Chyba: PDF knižnica (jsPDF AutoTable) nebola načítaná.', 'error');
            return;
        }
        const doc = new jsPDF();

        // --- Fonty a Diakritika ---
        // jsPDF má obmedzenú vstavanú podporu UTF-8. Helvetica (predvolený) zvládne základnú diakritiku.
        // Pre plnú podporu by bolo treba vkladať vlastné .ttf fonty, čo je zložitejšie.
        // Použijeme Helvetica a nastavíme kódovanie tam, kde je to možné.
         doc.setFont('helvetica', 'normal'); // Alebo times, courier

        // --- Hlavička ---
        doc.setFontSize(18);
        doc.text(`Výkaz práce - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
        doc.setFontSize(12);
        const employeeText = `Pracovník: ${employeeName || 'Nezadané'}`;
        doc.text(employeeText, 14, 30);
        const settingsText = `Mzda: ${formatCurrency(hourlyWage)} €/h, Daň: ${(taxRate * 100).toFixed(1)} %`;
        doc.text(settingsText, 14, 36);

        // --- Tabuľka ---
        const tableColumn = ["Deň", "Príchod", "Odchod", "Prest.", "Odprac.", "Hrubá (€)", "Čistá (€)"];
        const tableRows = [];
        const rows = workDaysTbody.querySelectorAll('tr');
        let hasData = false;

        rows.forEach(row => {
            const day = parseInt(row.dataset.day);
            if (isNaN(day)) return;

            const dayStr = `${day}. ${getDayNameShort(currentYear, currentMonth, i)}`;
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value || '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value || '';
            let totalTime = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`)?.textContent || '-';
            let gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`)?.value || '-';
            let net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`)?.value || '-';

            // Zobrazíme riadok len ak má nejaké dáta (okrem defaultných "-")
            if (start || end || breakTime || (totalTime !== '-' && totalTime !== '0h 0m (0.00 h)')) {
                hasData = true;
                // Skrátime formát odpracovaného času pre PDF
                 const totalMatch = totalTime.match(/(\d+h \d+m)/);
                 totalTime = totalMatch ? totalMatch[1] : totalTime;

                tableRows.push([dayStr, start, end, breakTime, totalTime, gross, net]);
            }
        });

        if (!hasData) {
            showNotification("Nie sú žiadne dáta na export.", "error");
            return;
        }

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 42,
            theme: 'grid', // Alebo 'striped', 'plain'
            styles: {
                font: 'helvetica', // Použije vstavaný font
                fontSize: 9,
                cellPadding: 2,
            },
            headStyles: {
                fillColor: [220, 220, 220], // Svetlo šedá hlavička
                textColor: [50, 50, 50],
                fontStyle: 'bold',
            },
            columnStyles: { // Zarovnanie stĺpcov
                 0: { cellWidth: 25 }, // Deň
                 1: { halign: 'center', cellWidth: 20 }, // Príchod
                 2: { halign: 'center', cellWidth: 20 }, // Odchod
                 3: { halign: 'right', cellWidth: 15 }, // Prest.
                 4: { halign: 'center', cellWidth: 30 }, // Odprac.
                 5: { halign: 'right', cellWidth: 25 }, // Hrubá
                 6: { halign: 'right', cellWidth: 25 }, // Čistá
             },
             didParseCell: function (data) {
                // Skúsiť opraviť diakritiku manuálne pre základné znaky (obmedzené riešenie)
                // Toto je veľmi základné a nemusí fungovať pre všetky znaky/fonty
                const replacements = { 'á': 'a', 'č': 'c', 'ď': 'd', 'é': 'e', 'í': 'i', 'ľ': 'l', 'ň': 'n', 'ó': 'o', 'ř': 'r', 'š': 's', 'ť': 't', 'ú': 'u', 'ý': 'y', 'ž': 'z', /* ... veľké písmená ... */ };
                if (typeof data.cell.text === 'string') {
                    // data.cell.text = data.cell.text.replace(/[áčďéíľňóřšťúýž]/g, char => replacements[char] || char);
                }
            }
        });

        // --- Súhrn ---
        const finalY = doc.lastAutoTable.finalY || 60; // Kde skončila tabuľka
        doc.setFontSize(10);
        // Získame text zo súhrnného divu a rozdelíme ho na riadky
        const summaryLines = totalSalaryDiv.innerHTML
                                .replace(/<strong>(.*?)<\/strong>/g, '$1') // Odstrániť strong tagy
                                .replace(/<br\s*\/?>/g, '\n') // Nahradiť <br> za nový riadok
                                .split('\n');
        doc.text(summaryLines, 14, finalY + 10);

        // --- Uloženie ---
        const filename = `Vykaz_Prace_${employeeName || 'Zamestnanec'}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`;
        doc.save(filename);
         showNotification('PDF exportované.', 'save');
    }

    // -------------------- ODOSLANIE PDF (cez Web Share API) --------------------
     window.sendPDF = async function() {
         if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
             showNotification('Chyba: PDF knižnica (jsPDF) nebola načítaná.', 'error');
             return;
         }
         const { jsPDF } = window.jspdf;
         if (typeof jsPDF.API.autoTable !== 'function') {
            showNotification('Chyba: PDF knižnica (jsPDF AutoTable) nebola načítaná.', 'error');
            return;
         }
         const doc = new jsPDF(); // Vytvoríme nový dokument
         // ... (rovnaký kód na generovanie PDF ako v exportToPDF) ...

         doc.setFont('helvetica', 'normal');
         doc.setFontSize(18);
         doc.text(`Výkaz práce - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
         doc.setFontSize(12);
         doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30);
         doc.text(`Mzda: ${formatCurrency(hourlyWage)} €/h, Daň: ${(taxRate * 100).toFixed(1)} %`, 14, 36);

         const tableColumn = ["Deň", "Príchod", "Odchod", "Prest.", "Odprac.", "Hrubá (€)", "Čistá (€)"];
         const tableRows = [];
         let hasData = false;
         // ... (rovnaké načítanie dát z tabuľky ako v exportToPDF) ...
         const rows = workDaysTbody.querySelectorAll('tr');
         rows.forEach(row => {
            const day = parseInt(row.dataset.day); if (isNaN(day)) return;
            const dayStr = `${day}. ${getDayNameShort(currentYear, currentMonth, day)}`; // Používame day z dataset
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value || '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value || '';
            let totalTime = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`)?.textContent || '-';
            let gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`)?.value || '-';
            let net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`)?.value || '-';
            if (start || end || breakTime || (totalTime !== '-' && totalTime !== '0h 0m (0.00 h)')) {
                hasData = true;
                const totalMatch = totalTime.match(/(\d+h \d+m)/);
                totalTime = totalMatch ? totalMatch[1] : totalTime;
                tableRows.push([dayStr, start, end, breakTime, totalTime, gross, net]);
            }
        });

         if (!hasData) { showNotification("Nie sú žiadne dáta na odoslanie.", "error"); return; }

         doc.autoTable({
             head: [tableColumn], body: tableRows, startY: 42, theme: 'grid',
             styles: { font: 'helvetica', fontSize: 9, cellPadding: 2 },
             headStyles: { fillColor: [220, 220, 220], textColor: [50, 50, 50], fontStyle: 'bold' },
             columnStyles: { 0: { cellWidth: 25 }, 1: { halign: 'center', cellWidth: 20 }, 2: { halign: 'center', cellWidth: 20 }, 3: { halign: 'right', cellWidth: 15 }, 4: { halign: 'center', cellWidth: 30 }, 5: { halign: 'right', cellWidth: 25 }, 6: { halign: 'right', cellWidth: 25 } }
         });

         const finalY = doc.lastAutoTable.finalY || 60;
         doc.setFontSize(10);
         const summaryLines = totalSalaryDiv.innerHTML.replace(/<strong>(.*?)<\/strong>/g, '$1').replace(/<br\s*\/?>/g, '\n').split('\n');
         doc.text(summaryLines, 14, finalY + 10);

         // --- Zdieľanie ---
         try {
             const pdfBlob = doc.output('blob');
             const filename = `Vykaz_Prace_${employeeName || 'Zamestnanec'}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`;
             const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });

             if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                 await navigator.share({
                     files: [pdfFile],
                     title: `Výkaz práce ${MONTH_NAMES[currentMonth]} ${currentYear}`,
                     text: `Výkaz práce pre ${employeeName || 'zamestnanca'} za ${MONTH_NAMES[currentMonth]} ${currentYear}.`
                 });
                 console.log('PDF úspešne zdieľané.');
                 showNotification('PDF pripravené na odoslanie.', 'save');
             } else {
                 showNotification('Váš prehliadač nepodporuje priame zdieľanie súborov.', 'error');
                 // Fallback: ponúknuť stiahnutie
                 doc.save(filename);
             }
         } catch (error) {
             console.error('Chyba pri zdieľaní PDF:', error);
             // Ignorovať AbortError, ktorý nastane, ak používateľ zruší zdieľanie
             if (error.name !== 'AbortError') {
                showNotification(`Chyba pri zdieľaní: ${error.message}`, 'error');
                // Fallback: ponúknuť stiahnutie pri chybe
                doc.save(filename);
             }
         }
    }

    // -------------------- ZÁLOHA A OBNOVA (Excel) --------------------
    window.createBackup = function() {
        if (typeof XLSX === 'undefined') {
            showNotification('Chyba: Knižnica pre Excel (XLSX) nebola načítaná.', 'error');
            return;
        }
        const lsKey = getLocalStorageKey(currentYear, currentMonth);
        const dataString = localStorage.getItem(lsKey);

        if (!dataString) {
            showNotification('Nie sú žiadne lokálne dáta na zálohovanie pre tento mesiac.', 'error');
            return;
        }

        try {
            const dataObj = JSON.parse(dataString);
            const daysData = dataObj.days || {};
            const settingsData = dataObj.settings || {};

            // --- Dáta pre Excel ---
            const ws_data = [
                // Hlavička
                ["Deň", "Príchod", "Odchod", "Prestávka (h)"] // Ukladáme len vstupy
            ];

            // Riadky s dátami
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                 const dayInfo = daysData[i] || { start: '', end: '', breakTime: '' };
                 // Pridáme riadok len ak existuje nejaký záznam pre daný deň v zálohe
                 if (dayInfo.start || dayInfo.end || dayInfo.breakTime) {
                    ws_data.push([
                        `${i}. ${getDayNameShort(currentYear, currentMonth, i)}`, // Deň
                        dayInfo.start,
                        dayInfo.end,
                        dayInfo.breakTime
                    ]);
                 }
            }

            // Pridáme riadok s nastaveniami na koniec
             ws_data.push([]); // Prázdny riadok ako oddeľovač
             ws_data.push(["--- Nastavenia ---"]); // Označenie sekcie
             ws_data.push(["Meno pracovníka", settingsData.employeeName ?? employeeName]);
             ws_data.push(["Hodinová mzda (€)", settingsData.hourlyWage ?? hourlyWage]);
             ws_data.push(["Daň (%)", settingsData.taxRatePercent ?? (taxRate * 100)]);
             ws_data.push(["Desatinné miesta", settingsData.decimalPlaces ?? decimalPlaces]);
             ws_data.push(["Posledná aktualizácia", dataObj.lastUpdated || 'Neznáma']);


            // --- Vytvorenie Excel súboru ---
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Nastavenie šírky stĺpcov (voliteľné)
            ws['!cols'] = [ { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 15 } ];

            XLSX.utils.book_append_sheet(wb, ws, `${MONTH_NAMES[currentMonth]} ${currentYear}`);
            const filename = `BrunoCalc_Zaloha_${employeeName || 'Zamestnanec'}_${MONTH_NAMES[currentMonth]}_${currentYear}.xlsx`;
            XLSX.writeFile(wb, filename);
            showNotification('Záloha do Excelu bola úspešne vytvorená.', 'save');

        } catch (error) {
            console.error("Excel backup error:", error);
            showNotification(`Chyba pri vytváraní Excel zálohy: ${error.message}`, 'error');
        }
    };

    window.restoreBackup = function() {
        if (typeof XLSX === 'undefined') {
            showNotification('Chyba: Knižnica pre Excel (XLSX) nebola načítaná.', 'error');
            return;
        }
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    // Predpokladáme, že dáta sú na prvom liste
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    // Konvertujeme na pole polí (Array of Arrays)
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

                    const restoredData = {
                         settings: {},
                         days: {},
                         lastUpdated: new Date().toISOString() // Nový timestamp obnovy
                    };
                    let readingSettings = false;

                    // Prechádzame riadky zo sheetu
                    for (let i = 1; i < rows.length; i++) { // Začíname od 1 (preskočíme hlavičku)
                        const row = rows[i];
                        if (!row || row.length === 0) continue; // Preskočiť prázdne riadky

                        // Detekcia sekcie nastavení
                        if (row[0] === "--- Nastavenia ---") {
                            readingSettings = true;
                            continue; // Preskočiť riadok s oddeľovačom
                        }

                        if (readingSettings) {
                            // Spracovanie nastavení
                            const key = row[0];
                            const value = row[1];
                            if (key === "Meno pracovníka") restoredData.settings.employeeName = value;
                            else if (key === "Hodinová mzda (€)") restoredData.settings.hourlyWage = parseFloat(value) || 10;
                            else if (key === "Daň (%)") restoredData.settings.taxRatePercent = parseFloat(value) || 2;
                            else if (key === "Desatinné miesta") restoredData.settings.decimalPlaces = parseInt(value) || 2;
                            // lastUpdated zo zálohy ignorujeme, nastavíme nový
                        } else {
                            // Spracovanie denných dát
                            const dayMatch = String(row[0]).match(/^(\d+)\./); // Hľadáme číslo dňa na začiatku (napr. "1.")
                            if (dayMatch) {
                                const dayNum = parseInt(dayMatch[1]);
                                if (dayNum >= 1 && dayNum <= 31) {
                                     restoredData.days[dayNum] = {
                                        start: String(row[1]), // Príchod
                                        end: String(row[2]),   // Odchod
                                        breakTime: String(row[3]) // Prestávka
                                     };
                                }
                            }
                        }
                    }

                     // Uloženie obnovených dát do LocalStorage pre AKTUÁLNE zvolený mesiac/rok
                    const lsKey = getLocalStorageKey(currentYear, currentMonth);
                    localStorage.setItem(lsKey, JSON.stringify(restoredData));

                    // Označiť ako pending, ak sme offline a prihlásení, aby sa synchronizovalo
                     if (currentUser && !navigator.onLine) {
                         localStorage.setItem(`brunoCalc_pendingSync_${currentYear}-${currentMonth}`, 'true');
                     }

                     showNotification('Záloha úspešne obnovená pre aktuálny mesiac.', 'save');
                     createTable(); // Znovu načíta tabuľku s obnovenými dátami z LS

                } catch (error) {
                    console.error("Excel restore error:", error);
                    showNotification(`Chyba pri obnove zo zálohy: ${error.message}`, 'error');
                } finally {
                    // Vyčistenie inputu pre prípad, že by používateľ chcel nahrať rovnaký súbor znova
                    input.value = '';
                }
            };
            reader.onerror = function() {
                 showNotification('Chyba pri čítaní súboru.', 'error');
                 input.value = '';
            };
            reader.readAsArrayBuffer(file);
        };
        input.click(); // Otvorí dialóg na výber súboru
    };


    // -------------------- OBSLUHA ZMIEN NASTAVENÍ --------------------
    window.updateEmployeeName = function() {
      employeeName = employeeNameInput.value.trim();
      localStorage.setItem('brunoCalc_employeeName', employeeName); // Uložíme samostatne pre perzistenciu
      debouncedSaveData(); // Uložíme aj do dát mesiaca
    }

    window.updateSettings = function() {
        updateSettingsFromInputs();
        // Prepočítaj všetky riadky a celkový súhrn
        const rows = workDaysTbody.querySelectorAll('tr');
        rows.forEach(row => {
             const day = parseInt(row.dataset.day);
             if (!isNaN(day)) calculateRow(day);
        });
        calculateTotal();
        debouncedSaveData(); // Uložíme zmeny
    }

     function updateSettingsFromInputs() {
         hourlyWage = parseFloat(hourlyWageInput.value) || 0;
         taxRate = (parseFloat(taxRateInput.value) || 0) / 100;
         // Uložíme aj samostatne do LS
         localStorage.setItem('brunoCalc_hourlyWage', hourlyWage);
         localStorage.setItem('brunoCalc_taxRatePercent', taxRate * 100);
     }

    window.changeDecimalPlaces = function() {
      decimalPlaces = parseInt(decimalPlacesSelect.value);
      localStorage.setItem('brunoCalc_decimalPlaces', decimalPlaces);
      // Prepočítať len zobrazenie, nie základné dáta
      createTable(); // Najjednoduchší spôsob je prekresliť tabuľku
      // calculateTotal(); // Prepočítať aj súhrn s novým formátovaním
      // debouncedSaveData(); // Uložiť zmenu nastavenia
    }

    window.changeMonth = function() {
      currentMonth = parseInt(monthSelect.value);
      console.log("Month changed to:", currentMonth);
      createTable(); // Prekreslí tabuľku a načíta dáta pre nový mesiac
    }

    window.changeYear = function() {
      currentYear = parseInt(yearSelect.value);
      console.log("Year changed to:", currentYear);
      createTable(); // Prekreslí tabuľku a načíta dáta pre nový rok
    }

    // -------------------- INIT APLIKÁCIE --------------------
    function initializeAppUI() {
        console.log("Initializing App UI...");
        populateYearSelect();

        // Nastavenie počiatočných hodnôt selectov a inputov
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        hourlyWageInput.value = hourlyWage;
        taxRateInput.value = (taxRate * 100).toFixed(1); // Zobraziť ako percentá

        applyDarkMode(isDarkMode); // Aplikuj tmavý režim z LS

        // Zobraziť počiatočný online/offline stav
        updateOnlineStatus(navigator.onLine);

        // Počiatočné vytvorenie tabuľky (onAuthStateChanged sa zavolá neskôr a môže ju prekresliť)
        // createTable(); // Toto sa teraz volá v onAuthStateChanged a updateUIBasedOnAuthState

        console.log("App UI Initialized.");
    }

    // Spustíme inicializáciu UI hneď po načítaní skriptu
    initializeAppUI();

  </script>

  <!-- Registrácia Service Workera -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
             // Zobraziť chybu používateľovi, ak je to dôležité
             // document.getElementById('errorNotification').textContent = 'Offline funkčnosť nemusí byť dostupná (SW Error).';
             // document.getElementById('errorNotification').classList.add('show');
             // setTimeout(() => document.getElementById('errorNotification').classList.remove('show'), 5000);
          });
      });
    }
  </script>
</body>
</html>
