<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator Pro</title>

  <!-- Meta tagy pre PWA -->
  <meta name="theme-color" content="#8a2be2"/>
  <meta name="description" content="Pokroƒçil√° kalkulaƒçka mzdy s offline podporou a synchroniz√°ciou."/>
  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json" />
  <!-- Ikona -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="images/icon-192x192.png">

  <!-- ====== Naƒç√≠tanie kni≈æn√≠c (CDN) ====== -->
  <!-- jsPDF a AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Toastify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <!-- Firebase compat kni≈ænice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"></script>

  <!-- ====== ≈†t√Ωly CSS ====== -->
  <style>
    /* Z√°kladn√© farebn√© premenn√© */
    :root {
      --primary-color: #8a2be2;
      --primary-dark: #6a1bb2;
      --secondary-color: #4CAF50;
      --secondary-dark: #388e3c;
      --danger-color: #f44336;
      --danger-dark: #d32f2f;
      --warning-color: #ff9800;
      --warning-dark: #e68a00;
      --info-color: #2196F3;
      --info-dark: #1976d2;
      --light-bg: #f4f7f6;
      --light-card-bg: white;
      --light-text: #333;
      --dark-bg: #2c3e50;
      --dark-card-bg: #34495e;
      --dark-text: #ecf0f1;
      --border-color: #ddd;
      --dark-border-color: #555;
      --input-bg: #ffffff;
      --input-border: #ccc;
      --dark-input-bg: #555;
      --dark-input-text: white;
      --dark-input-border: #777;
      --current-day-bg: #e6e6fa;
      --dark-current-day-bg: #5a4a8c;
      --readonly-bg: #eee;
      --dark-readonly-bg: #444;
      --readonly-text: #777;
      --dark-readonly-text: #aaa;
      --weekend-bg: rgba(0, 0, 0, 0.03);
      --dark-weekend-bg: rgba(255, 255, 255, 0.05);
      --invalid-border: var(--danger-color);
      --invalid-bg: #ffebee;
      --dark-invalid-bg: #5a2d33;
      --focus-shadow: rgba(138, 43, 226, 0.2);
      --dark-focus-shadow: rgba(138, 43, 226, 0.3);
      --toastify-color-success: linear-gradient(to right, #00b09b, #96c93d);
      --toastify-color-error: linear-gradient(to right, #ff5f6d, #ffc371);
      --toastify-color-warning: linear-gradient(to right, #f7b733, #fc4a1a);
      --toastify-color-info: linear-gradient(to right, #00d2ff, #3a7bd5);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--light-bg);
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .container {
      max-width: 1300px;
      margin: 15px auto;
      background: var(--light-card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }
    h1 {
      text-align: center;
      font-size: 2.8em;
      font-weight: 700;
      background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #00ff00, #0000ff, var(--primary-color));
      background-size: 200% 200%;
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 6s ease-in-out infinite, textShadowPulse 2.5s ease-in-out infinite;
      margin-bottom: 5px;
      line-height: 1.2;
    }
    h2 {
      text-align: center;
      color: #777;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.3em;
      font-weight: 400;
    }
    .settings {
      margin-bottom: 25px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }
    .settings > div { margin: 0; }
    .settings label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.95em;
      color: var(--light-text);
    }
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      margin-bottom: 25px;
      transition: border-color 0.3s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    th {
      background-color: #e9ecef;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      color: var(--light-text);
    }
    td:last-child, th:last-child {
      text-align: center;
      width: 110px;
    }
    td:nth-child(1) { width: 80px; }
    td:nth-child(5) { width: 130px; }
    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 8px 10px;
      box-sizing: border-box;
      background-color: var(--input-bg);
      color: var(--light-text);
      font-size: 14px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--focus-shadow);
    }
    input[readonly] {
      background-color: var(--readonly-bg);
      color: var(--readonly-text);
      cursor: default;
      border-color: #ddd;
    }
    input.invalid {
      border-color: var(--invalid-border) !important;
      background-color: var(--invalid-bg);
    }
    #totalSalary {
      font-size: 1.1em;
      font-weight: 500;
      text-align: left;
      margin-top: 25px;
      padding: 15px 20px;
      background-color: #e9ecef;
      border-radius: 5px;
      line-height: 1.8;
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #totalSalary strong {
      color: var(--primary-dark);
      font-weight: 700;
    }
    tr.weekend td { background-color: var(--weekend-bg); }
    tr.current-day td {
      background-color: var(--current-day-bg) !important;
      font-weight: bold;
      color: #333;
    }
    tr.current-day input:not([readonly]) {
      background-color: #fffacd;
      font-weight: bold;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 25px;
    }
    .btn {
      padding: 10px 18px;
      color: white;
      background-color: var(--primary-color);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover { opacity: 0.9; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; box-shadow: none; }
    .btn-secondary { background-color: var(--secondary-color); }
    .btn-info { background-color: var(--info-color); }
    .btn-danger { background-color: var(--danger-color); }
    .btn-warning { background-color: var(--warning-color); color: #333; }
    .btn-sm {
      padding: 4px 8px;
      font-size: 14px;
      margin: 0 2px;
      box-shadow: none;
    }
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    body.dark-mode .container {
      background-color: var(--dark-card-bg);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    body.dark-mode h2 { color: #bdc3c7; }
    body.dark-mode label { color: var(--dark-text); }
    body.dark-mode .table-container { border-color: var(--dark-border-color); }
    body.dark-mode th { background-color: #4a627a; border-color: var(--dark-border-color); color: var(--dark-text); }
    body.dark-mode td { border-color: var(--dark-border-color); }
    body.dark-mode tr.weekend td { background-color: var(--dark-weekend-bg); }
    body.dark-mode tr.current-day td { background-color: var(--dark-current-day-bg) !important; color: var(--dark-text); }
    body.dark-mode tr.current-day input:not([readonly]) { background-color: #7061a0; }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select {
      background-color: var(--dark-input-bg);
      color: var(--dark-input-text);
      border-color: var(--dark-input-border);
    }
    body.dark-mode input[readonly] {
      background-color: var(--dark-readonly-bg);
      color: var(--dark-readonly-text);
      border-color: #555;
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--dark-focus-shadow);
    }
    body.dark-mode input.invalid {
      background-color: var(--dark-invalid-bg);
      border-color: var(--danger-dark) !important;
    }
    body.dark-mode #totalSalary {
      background-color: #2c3e50;
      color: var(--dark-text);
    }
    body.dark-mode #totalSalary strong { color: #a569bd; }
    body.dark-mode .btn-warning { color: white; background-color: var(--warning-dark); }
    body.dark-mode .btn-warning:hover { background-color: #b36b00; }
    .month-year-nav {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .nav-arrow {
      background: none;
      border: none;
      font-size: 1.5em;
      line-height: 1;
      cursor: pointer;
      color: var(--primary-color);
      padding: 0 5px;
      transition: color 0.2s ease;
    }
    .nav-arrow:hover { color: var(--primary-dark); }
    .nav-arrow:disabled { color: #ccc; cursor: not-allowed; }
    #auth-container {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
      margin-bottom: 25px;
      transition: border-color 0.3s ease;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 250px;
      max-width: 90%;
      text-align: center;
    }
    #login-form .btn-group {
      display: flex;
      gap: 10px;
    }
    #login-form .btn { width: auto; padding: 8px 15px; }
    #user-info {
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #user-info span { font-weight: 500; word-break: break-all; }
    .toastify {
      padding: 12px 20px;
      color: #fff;
      display: inline-block;
      box-shadow: 0 3px 6px -1px rgba(0,0,0,0.12), 0 10px 36px -4px rgba(77,96,232,0.3);
      background: linear-gradient(135deg, #73a5ff, #5477f5);
      position: fixed;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.215,0.61,0.355,1);
      border-radius: 4px;
      cursor: pointer;
      max-width: calc(50% - 20px);
      z-index: 2147483647;
    }
    .toastify.on { opacity: 1; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%,100% { text-shadow: 0 0 8px rgba(255,255,255,0.4); } 50% { text-shadow: 0 0 16px rgba(255,255,255,0.8); } }
    @media (max-width:768px) {
      body { padding: 5px; }
      .container { padding: 15px; margin: 10px auto; }
      h1 { font-size: 2.2em; }
      h2 { font-size: 1.1em; }
      .settings { grid-template-columns: 1fr; gap: 10px; }
      th, td { padding: 8px; font-size: 0.85em; }
      .btn-container { justify-content: stretch; }
      .btn { font-size: 14px; flex-grow: 1; }
      #totalSalary { font-size: 1em; padding: 12px 15px; }
      table { min-width: 800px; }
    }
    @media (max-width:480px) {
      h1 { font-size: 1.8em; }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn { font-size: 13px; padding: 8px 12px; }
      input, select { font-size: 13px; padding: 6px 8px; }
      table { min-width: 700px; }
      td:last-child, th:last-child { width: 90px; }
      .btn-sm { padding: 3px 6px; font-size: 12px; }
    }
    #activityIndicator {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    #activityIndicator.show { display: block; opacity: 1; }
  </style>
</head>
<body>
  <!-- Indik√°tor aktivity -->
  <div id="activityIndicator">Spracov√°vam...</div>
  <div class="container">
    <!-- Autentifikaƒçn√© UI -->
    <div id="auth-container">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" autocomplete="email">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div class="btn-group">
          <button class="btn btn-secondary" id="loginBtn">Prihl√°si≈• sa</button>
          <button class="btn btn-info" id="registerBtn">Registrova≈•</button>
        </div>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn btn-danger" id="logoutBtn">Odhl√°si≈• sa</button>
      </div>
    </div>
    <h1 id="mainTitle">Bruno's Calculator Pro</h1>
    <h2 id="subTitle">V√Ωkaz pr√°ce a v√Ωpoƒçet mzdy</h2>
    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovn√≠ka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.01">
      </div>
      <div>
        <label for="taxRateInput">Da≈à (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <div class="month-year-nav">
          <button class="nav-arrow" id="prevMonthBtn" aria-label="Predch√°dzaj√∫ci mesiac"><</button>
          <select id="monthSelect">
            <option value="0">Janu√°r</option>
            <option value="1">Febru√°r</option>
            <option value="2">Marec</option>
            <option value="3">Apr√≠l</option>
            <option value="4">M√°j</option>
            <option value="5">J√∫n</option>
            <option value="6">J√∫l</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">Okt√≥ber</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
          <button class="nav-arrow" id="nextMonthBtn" aria-label="Nasleduj√∫ci mesiac">></button>
        </div>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <div class="month-year-nav">
          <button class="nav-arrow" id="prevYearBtn" aria-label="Predch√°dzaj√∫ci rok"><</button>
          <select id="yearSelect"><!-- Dynamicky generovan√© roky --></select>
          <button class="nav-arrow" id="nextYearBtn" aria-label="Nasleduj√∫ci rok">></button>
        </div>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinn√© miesta:</label>
        <select id="decimalPlacesSelect">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
        </select>
      </div>
      <button id="darkModeToggleBtn" class="btn btn-warning">Tmav√Ω/Svetl√Ω re≈æim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka (h)</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky bud√∫ generovan√© JavaScriptom -->
        </tbody>
      </table>
    </div>
    <div id="totalSalary">Celkov√© s√∫ƒçty bud√∫ vypoƒç√≠tan√© tu...</div>
    <div class="btn-container">
      <button id="exportPdfBtn" class="btn btn-secondary">Export PDF</button>
      <button id="sharePdfBtn" class="btn btn-secondary">Zdieƒæa≈• PDF</button>
      <button id="backupBtn" class="btn btn-info">Z√°lohova≈• (.xlsx)</button>
      <button id="restoreBtn" class="btn btn-warning">Obnovi≈• zo z√°lohy</button>
      <button id="loadCloudBtn" class="btn btn-primary">Naƒç√≠ta≈• z Cloudu</button>
      <button id="resetMonthBtn" class="btn btn-danger">Resetova≈• Mesiac</button>
    </div>
  </div>

  <!-- ====== Hlavn√Ω skript ====== -->
  <script>
    (async () => {
      "use strict";
      /* ------------------------------
         1) Firebase konfigur√°cia
      ------------------------------- */
      const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b"
      };
      firebase.initializeApp(firebaseConfig);
      // Aktiv√°cia App Check
      const appCheckProvider = new firebase.appCheck.ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v');
      firebase.appCheck().activate(appCheckProvider, true);
      const auth = firebase.auth();
      const db = firebase.firestore();

      try {
        await db.enablePersistence();
        console.log("Firestore offline perzistencia povolen√°.");
      } catch (err) {
        if (err.code === 'failed-precondition') {
          console.warn("Viac otvoren√Ωch tabov ‚Äì offline perzistencia povolen√° len v prvom.");
        } else if (err.code === 'unimplemented') {
          console.warn("Offline perzistencia nepodporovan√° v tomto prehliadaƒçi.");
        } else {
          console.error("Chyba pri povoƒæovan√≠ offline perzistencie:", err);
        }
      }

      /* ------------------------------
         2) DOM prvky & glob√°lny stav
      ------------------------------- */
      const workDaysTbody = document.getElementById('workDays');
      const totalSalaryDiv = document.getElementById('totalSalary');
      const mainTitle = document.getElementById('mainTitle');
      const subTitle = document.getElementById('subTitle');
      const hourlyWageInput = document.getElementById('hourlyWageInput');
      const taxRateInput = document.getElementById('taxRateInput');
      const monthSelect = document.getElementById('monthSelect');
      const yearSelect = document.getElementById('yearSelect');
      const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
      const employeeNameInput = document.getElementById('employeeNameInput');
      const activityIndicator = document.getElementById('activityIndicator');
      const loginForm = document.getElementById('login-form');
      const userInfo = document.getElementById('user-info');
      const userEmail = document.getElementById('user-email');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');

      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const prevMonthBtn = document.getElementById('prevMonthBtn');
      const nextMonthBtn = document.getElementById('nextMonthBtn');
      const prevYearBtn = document.getElementById('prevYearBtn');
      const nextYearBtn = document.getElementById('nextYearBtn');
      const darkModeToggleBtn = document.getElementById('darkModeToggleBtn');
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      const sharePdfBtn = document.getElementById('sharePdfBtn');
      const backupBtn = document.getElementById('backupBtn');
      const restoreBtn = document.getElementById('restoreBtn');
      const loadCloudBtn = document.getElementById('loadCloudBtn');
      const resetMonthBtn = document.getElementById('resetMonthBtn');

      let currentUser = null;
      const currentDate = new Date();
      let currentMonth = currentDate.getMonth();
      let currentYear = currentDate.getFullYear();
      let minYear = 2020;
      let maxYear = currentDate.getFullYear() + 2;
      let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
      let employeeName = localStorage.getItem('employeeName') || '';
      let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
      let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
      let monthDataCache = {};
      let dataChangedSinceLoad = false;
      let copiedRowData = null;

      /* ------------------------------
         3) Pomocn√© funkcie
      ------------------------------- */
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      function showToast(message, type = 'info', duration = 3000) {
        if (typeof Toastify !== 'function') {
          console.log(`[${type.toUpperCase()}] ${message}`);
          return;
        }
        let bg;
        switch (type) {
          case 'success': bg = "var(--toastify-color-success)"; break;
          case 'error': bg = "var(--toastify-color-error)"; break;
          case 'warning': bg = "var(--toastify-color-warning)"; break;
          default: bg = "var(--toastify-color-info)";
        }
        Toastify({
          text: message,
          duration,
          gravity: "bottom",
          position: "right",
          stopOnFocus: true,
          style: { background: bg },
        }).showToast();
      }

      function showActivity(message = "Spracov√°vam...") {
        activityIndicator.textContent = message;
        activityIndicator.classList.add('show');
      }
      function hideActivity() { activityIndicator.classList.remove('show'); }

      function getMonthName(idx) {
        const names = ["Janu√°r","Febru√°r","Marec","Apr√≠l","M√°j","J√∫n","J√∫l","August","September","Okt√≥ber","November","December"];
        return names[idx] || '';
      }
      function getDayName(y, m, d) {
        const days = ["Ne","Po","Ut","St","≈†t","Pi","So"];
        return days[new Date(y, m, d).getDay()];
      }
      function getDaysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }
      function formatCurrency(val) {
        return (Math.max(0, parseFloat(val) || 0)).toFixed(decimalPlaces);
      }
      function mapFirebaseAuthError(code) {
        switch (code) {
          case 'auth/invalid-email': return 'Neplatn√Ω form√°t emailu.';
          case 'auth/user-not-found': return 'Pou≈æ√≠vateƒæ s t√Ωmto emailom neexistuje.';
          case 'auth/wrong-password': return 'Nespr√°vne heslo.';
          case 'auth/email-already-in-use': return 'Tento email je u≈æ zaregistrovan√Ω.';
          case 'auth/weak-password': return 'Heslo mus√≠ ma≈• aspo≈à 6 znakov.';
          case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
          case 'auth/too-many-requests': return 'Pr√≠li≈° veƒæa ne√∫spe≈°n√Ωch pokusov. Sk√∫ste nesk√¥r.';
          case 'auth/operation-not-allowed': return 'Prihl√°senie emailom/heslom nie je povolen√©.';
          default:
            console.error("Nezn√°ma chyba Firebase Auth:", code);
            return `Nezn√°ma chyba (${code})`;
        }
      }

      /* ------------------------------
         4) Tmav√Ω re≈æim
      ------------------------------- */
      function applyDarkModePreference() {
        if (localStorage.getItem('darkMode') === 'true') {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
      }
      function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDark);
        showToast(`Re≈æim zobrazenia: ${isDark ? 'Tmav√Ω' : 'Svetl√Ω'}`, 'info', 1500);
        updateWeekendStyles();
      }
      function updateWeekendStyles() {
        const color = document.body.classList.contains('dark-mode') ? 'var(--dark-weekend-bg)' : 'var(--weekend-bg)';
        workDaysTbody.querySelectorAll('.weekend').forEach(row => { row.style.backgroundColor = color; });
      }

      /* ------------------------------
         5) Navig√°cia Mesiac / Rok
      ------------------------------- */
      function populateYearSelect() {
        yearSelect.innerHTML = '';
        for (let y = minYear; y <= maxYear; y++) {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        }
        updateNavigationButtons();
      }
      function updateNavigationButtons() {
        prevMonthBtn.disabled = (currentYear === minYear && currentMonth === 0);
        nextMonthBtn.disabled = (currentYear === maxYear && currentMonth === 11);
        prevYearBtn.disabled = (currentYear <= minYear);
        nextYearBtn.disabled = (currentYear >= maxYear);
      }
      function navigateMonth(dir) {
        let newMonth = currentMonth + dir;
        let newYear = currentYear;
        if (newMonth > 11) { newMonth = 0; newYear++; }
        if (newMonth < 0)  { newMonth = 11; newYear--; }
        if (newYear < minYear || newYear > maxYear) { showToast("Rok mimo povolen√©ho rozsahu.", "warning"); return; }
        yearSelect.value = newYear; currentYear = newYear;
        monthSelect.value = newMonth; currentMonth = newMonth;
        updateNavigationButtons(); initializeAppSettings(); loadAndDisplayData();
      }
      function navigateYear(dir) {
        let newYear = currentYear + dir;
        if (newYear < minYear || newYear > maxYear) { showToast("Rok mimo povolen√©ho rozsahu.", "warning"); return; }
        yearSelect.value = newYear; currentYear = newYear;
        updateNavigationButtons(); initializeAppSettings(); loadAndDisplayData();
      }

      /* ------------------------------
         6) Autentifik√°cia
      ------------------------------- */
      loginBtn.addEventListener('click', async () => {
        if (!navigator.onLine) return showToast('Ste offline. Prihl√°senie je mo≈æn√© iba online.', 'error');
        const emailVal = emailInput.value;
        const passwordVal = passwordInput.value;
        if (!emailVal || !passwordVal) return showToast('Pros√≠m, zadajte email aj heslo.', 'warning');
        showActivity('Prihlasujem...');
        try {
          const userCredential = await auth.signInWithEmailAndPassword(emailVal, passwordVal);
          showToast(`Vitajte sp√§≈•, ${userCredential.user.email}!`, 'success');
        } catch (error) {
          console.error('Chyba pri prihl√°sen√≠:', error);
          showToast(`Chyba pri prihl√°sen√≠: ${mapFirebaseAuthError(error.code)}`, 'error', 4000);
        } finally { hideActivity(); }
      });
      registerBtn.addEventListener('click', async () => {
        if (!navigator.onLine) return showToast('Ste offline. Registr√°cia je mo≈æn√° iba online.', 'error');
        const emailVal = emailInput.value;
        const passwordVal = passwordInput.value;
        if (!emailVal || !passwordVal) return showToast('Pros√≠m, zadajte email aj heslo.', 'warning');
        if (passwordVal.length < 6) return showToast('Heslo mus√≠ ma≈• aspo≈à 6 znakov.', 'warning');
        showActivity('Registrujem...');
        try {
          const userCredential = await auth.createUserWithEmailAndPassword(emailVal, passwordVal);
          await createUserDocument(userCredential.user);
          showToast(`Registr√°cia √∫spe≈°n√°! Vitajte, ${userCredential.user.email}!`, 'success');
        } catch (error) {
          console.error('Chyba pri registr√°cii:', error);
          showToast(`Chyba pri registr√°cii: ${mapFirebaseAuthError(error.code)}`, 'error', 4000);
        } finally { hideActivity(); }
      });
      logoutBtn.addEventListener('click', async () => {
        showActivity('Odhlasujem...');
        try {
          await auth.signOut();
          monthDataCache = {};
          showToast('Boli ste √∫spe≈°ne odhl√°sen√Ω.', 'info');
        } catch (error) {
          console.error('Chyba pri odhl√°sen√≠:', error);
          showToast('Chyba pri odhl√°sen√≠.', 'error');
        } finally { hideActivity(); }
      });
      async function createUserDocument(user) {
        if (!user) return;
        const userRef = db.collection('users').doc(user.uid);
        try {
          await userRef.set({ email: user.email, createdAt: new Date() }, { merge: true });
          console.log('User dokument vytvoren√Ω/aktualizovan√Ω pre:', user.uid);
        } catch (error) { console.error('Chyba pri vytv√°ran√≠ user dokumentu:', error); }
      }
      function updateAuthUI() {
        if (currentUser) {
          loginForm.style.display = 'none';
          userInfo.style.display = 'flex';
          userEmail.textContent = currentUser.email;
          loadCloudBtn.disabled = false;
          resetMonthBtn.title = "Resetova≈• mesiac (aj v cloude)";
        } else {
          loginForm.style.display = 'flex';
          userInfo.style.display = 'none';
          userEmail.textContent = '';
          emailInput.value = '';
          passwordInput.value = '';
          loadCloudBtn.disabled = true;
          resetMonthBtn.title = "Resetova≈• mesiac (lok√°lne)";
        }
      }

      /* ------------------------------
         7) Naƒç√≠tanie d√°t a UI
      ------------------------------- */
      function initializeAppSettings() {
        hourlyWageInput.value = hourlyWage.toFixed(2);
        taxRateInput.value = (taxRate * 100).toFixed(1);
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        const mName = getMonthName(currentMonth);
        subTitle.textContent = `V√Ωkaz pr√°ce za ${mName} ${currentYear}`;
        mainTitle.textContent = employeeName ? `${employeeName} - Kalkulaƒçka` : "Bruno's Calculator Pro";
        updateNavigationButtons();
      }
      async function loadAndDisplayData() {
        showActivity('Naƒç√≠tavam d√°ta...');
        const dataKey = `${currentYear}-${currentMonth}`;
        let dataToApply = null;
        let loadedFrom = "≈æiadny zdroj";
        if (monthDataCache[dataKey]) {
          dataToApply = monthDataCache[dataKey];
          loadedFrom = "Cache";
        } else {
          if (currentUser) {
            try {
              const userDoc = db.collection('users').doc(currentUser.uid)
                .collection('workDays').doc(dataKey);
              const docSnap = await userDoc.get();
              if (docSnap.exists) {
                dataToApply = docSnap.data();
                loadedFrom = "Firestore";
                localStorage.setItem(`workData-${dataKey}`, JSON.stringify(dataToApply));
              } else {
                const localData = localStorage.getItem(`workData-${dataKey}`);
                if (localData) {
                  try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (po FS)"; } catch (e) { console.error(e); }
                }
              }
            } catch (error) {
              console.error('Chyba pri naƒç√≠tavan√≠ z Firestore:', error);
              showToast('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu.', 'error');
              const localData = localStorage.getItem(`workData-${dataKey}`);
              if (localData) {
                try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (po chybe FS)"; } catch (e) { console.error(e); }
              }
            }
          } else {
            const localData = localStorage.getItem(`workData-${dataKey}`);
            if (localData) {
              try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (neprihl√°sen√Ω)"; } catch (e) { console.error(e); }
            }
          }
        }
        console.log(`D√°ta naƒç√≠tan√© z: ${loadedFrom}`);
        applyDataToUI(dataToApply);
        if (dataToApply && loadedFrom !== "Cache") {
          monthDataCache[dataKey] = dataToApply;
        }
        hideActivity();
      }
      function applyDataToUI(storedData) {
        if (storedData) {
          hourlyWage = storedData.hourlyWage !== undefined ? parseFloat(storedData.hourlyWage) : hourlyWage;
          taxRate = storedData.taxRate !== undefined ? parseFloat(storedData.taxRate) : taxRate;
          employeeName = storedData.employeeName !== undefined ? String(storedData.employeeName) : employeeName;
          decimalPlaces = storedData.decimalPlaces !== undefined ? parseInt(storedData.decimalPlaces) : decimalPlaces;
        }
        initializeAppSettings();
        createTableStructure();
        if (storedData && storedData.data && Array.isArray(storedData.data)) {
          storedData.data.forEach((day, idx) => {
            const i = idx + 1;
            const sEl = document.getElementById(`start-${i}`);
            const eEl = document.getElementById(`end-${i}`);
            const bEl = document.getElementById(`break-${i}`);
            if (sEl && eEl && bEl) {
              sEl.value = day.start || '';
              eEl.value = day.end || '';
              bEl.value = day.breakTime !== undefined ? String(day.breakTime).replace('.', ',') : '';
              validateTimeInput(sEl);
              validateTimeInput(eEl);
            }
          });
        } else if (storedData) {
          console.warn("Pole 'data' ch√Ωba alebo nie je pole v ulo≈æen√Ωch d√°tach.");
        }
        recalculateAllRowsAndTotal();
        dataChangedSinceLoad = false;
      }

      /* ------------------------------
         8) Ukladanie d√°t
      ------------------------------- */
      function collectCurrentData() {
        const days = getDaysInMonth(currentYear, currentMonth);
        const arr = [];
        for (let i = 1; i <= days; i++) {
          const s = document.getElementById(`start-${i}`);
          const e = document.getElementById(`end-${i}`);
          const b = document.getElementById(`break-${i}`);
          const g = document.getElementById(`gross-${i}`);
          const n = document.getElementById(`net-${i}`);
          arr.push({
            start: s ? s.value : '',
            end: e ? e.value : '',
            breakTime: b ? String(b.value).replace(',', '.') : '0',
            gross: g ? g.value : '0.00',
            net: n ? n.value : '0.00'
          });
        }
        return {
          data: arr,
          hourlyWage,
          taxRate,
          employeeName,
          decimalPlaces,
          lastUpdated: new Date().toISOString()
        };
      }
      function handleDataChange() {
        dataChangedSinceLoad = true;
        saveToLocalStorage();
        scheduleSaveToFirestore();
      }
      const saveToLocalStorage = debounce(() => {
        if (!dataChangedSinceLoad) return;
        const currentData = collectCurrentData();
        const key = `${currentYear}-${currentMonth}`;
        try {
          localStorage.setItem(`workData-${key}`, JSON.stringify(currentData));
          localStorage.setItem('hourlyWage', hourlyWage.toString());
          localStorage.setItem('taxRate', taxRate.toString());
          localStorage.setItem('employeeName', employeeName);
          localStorage.setItem('decimalPlaces', decimalPlaces.toString());
        } catch (e) {
          console.error("Chyba pri ukladan√≠ do localStorage:", e);
          showToast('Chyba pri lok√°lnom ukladan√≠ d√°t!', 'error');
        }
      }, 500);
      const scheduleSaveToFirestore = debounce(async () => {
        if (!currentUser || !dataChangedSinceLoad) return;
        const currentData = collectCurrentData();
        const key = `${currentYear}-${currentMonth}`;
        showActivity('Synchronizujem s cloudom...');
        try {
          const userDoc = db.collection('users').doc(currentUser.uid)
            .collection('workDays').doc(key);
          await userDoc.set(currentData);
          showToast('D√°ta synchronizovan√© s cloudom.', 'success', 1500);
          dataChangedSinceLoad = false;
          monthDataCache[key] = currentData;
        } catch (error) {
          console.error('Chyba pri ukladan√≠ do Firestore:', error);
          showToast('Chyba pri synchroniz√°cii s cloudom.', 'error');
        } finally {
          setTimeout(hideActivity, 500);
        }
      }, 2000);

      /* ------------------------------
         9) Naƒç√≠tanie d√°t z Cloudu
      ------------------------------- */
      loadCloudBtn.addEventListener('click', async () => {
        if (!currentUser) return showToast('Pre naƒç√≠tanie z cloudu sa mus√≠te prihl√°si≈•.', 'warning');
        if (!navigator.onLine) showToast('Ste offline. Naƒç√≠tavaj√∫ sa posledn√© lok√°lne synchronizovan√© d√°ta.', 'warning');
        if (dataChangedSinceLoad && !confirm('M√°te neulo≈æen√© lok√°lne zmeny. Naozaj chcete naƒç√≠ta≈• d√°ta z Cloudu a prep√≠sa≈• ich?')) return;
        showActivity('Naƒç√≠tavam z cloudu...');
        const key = `${currentYear}-${currentMonth}`;
        try {
          const userDoc = db.collection('users').doc(currentUser.uid)
            .collection('workDays').doc(key);
          const snap = await userDoc.get();
          if (snap.exists) {
            const storedData = snap.data();
            localStorage.setItem(`workData-${key}`, JSON.stringify(storedData));
            applyDataToUI(storedData);
            monthDataCache[key] = storedData;
            showToast('D√°ta boli √∫spe≈°ne naƒç√≠tan√© z cloudu.', 'success');
          } else {
            showToast('Pre tento mesiac neboli v cloude n√°jden√© ≈æiadne d√°ta.', 'info');
          }
        } catch (error) {
          console.error('Chyba pri naƒç√≠tavan√≠ z Firestore:', error);
          showToast('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu.', 'error');
        } finally { hideActivity(); }
      });

      resetMonthBtn.addEventListener('click', async () => {
        const mName = getMonthName(currentMonth);
        const msg = currentUser
          ? `Naozaj chcete vymaza≈• v≈°etky z√°znamy pre ${mName} ${currentYear} (lok√°lne aj v cloude)? T√°to akcia je nevratn√°!`
          : `Naozaj chcete vymaza≈• v≈°etky lok√°lne z√°znamy pre ${mName} ${currentYear}? T√°to akcia je nevratn√°!`;
        if (!confirm(msg)) return;
        showActivity('Resetujem mesiac...');
        const key = `${currentYear}-${currentMonth}`;
        applyDataToUI(null);
        delete monthDataCache[key];
        localStorage.removeItem(`workData-${key}`);
        if (currentUser) {
          try {
            const userDoc = db.collection('users').doc(currentUser.uid)
              .collection('workDays').doc(key);
            await userDoc.delete();
            showToast('D√°ta pre aktu√°lny mesiac boli √∫spe≈°ne vymazan√©.', 'success');
          } catch (error) {
            console.error('Chyba pri mazan√≠ d√°t z Firestore:', error);
            showToast('Chyba pri mazan√≠ d√°t z cloudu.', 'error');
          }
        } else {
          showToast('Lok√°lne d√°ta pre aktu√°lny mesiac boli vymazan√©.', 'success');
        }
        dataChangedSinceLoad = false;
        hideActivity();
      });

      /* ------------------------------
         10) Tvorba tabuƒæky a event listenery
      ------------------------------- */
      function createTableStructure() {
        workDaysTbody.innerHTML = '';
        const today = new Date();
        const curDay = today.getDate();
        const isCur = (today.getMonth() === currentMonth && today.getFullYear() === currentYear);
        const days = getDaysInMonth(currentYear, currentMonth);
        const frag = document.createDocumentFragment();
        const isDark = document.body.classList.contains('dark-mode');
        for (let i = 1; i <= days; i++) {
          const row = document.createElement('tr');
          const dayDate = new Date(currentYear, currentMonth, i);
          const dayOfWeek = dayDate.getDay();
          const dName = getDayName(currentYear, currentMonth, i);
          row.dataset.day = i;
          if (isCur && i === curDay) row.classList.add('current-day');
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            row.classList.add('weekend');
            row.style.backgroundColor = isDark ? 'var(--dark-weekend-bg)' : 'var(--weekend-bg)';
          }
          row.innerHTML = `
            <td>${i}. (${dName})</td>
            <td><input type="tel" id="start-${i}" data-day="${i}" class="time-input" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
            <td><input type="tel" id="end-${i}" data-day="${i}" class="time-input" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
            <td><input type="text" id="break-${i}" data-day="${i}" class="break-input" inputmode="decimal" placeholder="hod."></td>
            <td id="total-${i}">0h 0m (0.0 h)</td>
            <td><input type="text" id="gross-${i}" class="salary-output" placeholder="0.00" readonly></td>
            <td><input type="text" id="net-${i}" class="salary-output" placeholder="0.00" readonly></td>
            <td class="action-buttons">
              <button class="btn btn-danger btn-sm reset-row-btn" data-day="${i}" title="Vynulova≈• riadok">‚úñ</button>
              <button class="btn btn-info btn-sm copy-row-btn" data-day="${i}" title="Kop√≠rova≈• / Vlo≈æi≈• ƒças">üìÑ</button>
            </td>
          `;
          frag.appendChild(row);
        }
        workDaysTbody.appendChild(frag);
      }

      workDaysTbody.addEventListener('input', e => {
        const t = e.target;
        if (t.matches('.time-input')) {
          handleTimeInput(t);
        } else if (t.matches('.break-input')) {
          handleBreakInput(t);
        }
      });
      workDaysTbody.addEventListener('focusout', e => {
        if (e.target.matches('.time-input')) { validateTimeInput(e.target); }
        else if (e.target.matches('.break-input')) { validateBreakInput(e.target); }
      });
      workDaysTbody.addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const day = parseInt(btn.dataset.day);
        if (isNaN(day)) return;
        if (btn.classList.contains('reset-row-btn')) { resetRow(day); }
        else if (btn.classList.contains('copy-row-btn')) { handleCopyPasteClick(day); }
      });

      function handleTimeInput(input) {
        const day = parseInt(input.dataset.day);
        formatTimeInput(input);
        validateTimeInput(input);
        calculateRow(day);
        handleDataChange();
      }
      function handleBreakInput(input) {
        const day = parseInt(input.dataset.day);
        input.value = input.value.replace(/[^0-9.,]/g, '');
        calculateRow(day);
        handleDataChange();
      }
      function formatTimeInput(input) {
        let val = input.value.replace(/[^\d]/g, '');
        if (val.length > 2) val = val.slice(0,2) + ':' + val.slice(2,4);
        if (val.length > 5) val = val.slice(0,5);
        input.value = val;
      }
      function validateTimeInput(input) {
        const val = input.value;
        const reg = /^([01]\d|2[0-3]):([0-5]\d)$/;
        if (val && !reg.test(val)) { input.classList.add('invalid'); }
        else { input.classList.remove('invalid'); }
      }
      function validateBreakInput(input) {
        const val = input.value.replace(',', '.').trim();
        if (val && (isNaN(parseFloat(val)) || parseFloat(val) < 0)) {
          input.classList.add('invalid');
          showToast(`Neplatn√° hodnota prest√°vky: ${input.value}`, 'warning', 2000);
        } else { input.classList.remove('invalid'); }
      }
      function resetRow(day) {
        ['start','end','break'].forEach(t => {
          const el = document.getElementById(`${t}-${day}`);
          if (el) { el.value = ''; el.classList.remove('invalid'); }
        });
        calculateRow(day);
        handleDataChange();
        showToast(`Riadok ${day} vynulovan√Ω.`, 'info', 1500);
      }
      function handleCopyPasteClick(day) {
        if (copiedRowData) { pasteRowData(day); }
        else { copyRowData(day); }
      }
      function copyRowData(day) {
        const s = document.getElementById(`start-${day}`)?.value || '';
        const e = document.getElementById(`end-${day}`)?.value || '';
        const b = document.getElementById(`break-${day}`)?.value || '';
        if (s || e || b) {
          copiedRowData = { start: s, end: e, breakTime: b };
          showToast(`ƒåasy z d≈àa ${day} skop√≠rovan√©. Kliknite na üìÑ v inom riadku pre vlo≈æenie.`, 'success', 3000);
        } else { showToast(`Niet ƒço kop√≠rova≈• z d≈àa ${day}.`, 'info', 1500); }
      }
      function pasteRowData(day) {
        if (!copiedRowData) return;
        const sEl = document.getElementById(`start-${day}`);
        const eEl = document.getElementById(`end-${day}`);
        const bEl = document.getElementById(`break-${day}`);
        if (sEl && eEl && bEl) {
          sEl.value = copiedRowData.start;
          eEl.value = copiedRowData.end;
          bEl.value = copiedRowData.breakTime;
          validateTimeInput(sEl);
          validateTimeInput(eEl);
          validateBreakInput(bEl);
          calculateRow(day);
          handleDataChange();
          showToast(`ƒåasy vlo≈æen√© do d≈àa ${day}.`, 'success', 1500);
        }
      }

      function calculateRow(day) {
        const sEl = document.getElementById(`start-${day}`);
        const eEl = document.getElementById(`end-${day}`);
        const bEl = document.getElementById(`break-${day}`);
        const totEl = document.getElementById(`total-${day}`);
        const grossEl = document.getElementById(`gross-${day}`);
        const netEl = document.getElementById(`net-${day}`);
        if (!sEl || !eEl || !bEl || !totEl || !grossEl || !netEl) return;
        const sTime = sEl.value, eTime = eEl.value;
        const bTime = parseFloat(String(bEl.value).replace(',', '.')) || 0;
        const reg = /^([01]\d|2[0-3]):([0-5]\d)$/;
        let decH = 0, h = 0, m = 0;
        if (reg.test(sTime) && reg.test(eTime) &&
            !sEl.classList.contains('invalid') && !eEl.classList.contains('invalid') && !bEl.classList.contains('invalid')) {
          const [sH,sM] = sTime.split(':').map(Number);
          const [eH,eM] = eTime.split(':').map(Number);
          let sTot = sH*60 + sM, eTot = eH*60 + eM;
          if (eTot < sTot) eTot += 24*60;
          let diff = eTot - sTot - (bTime*60);
          if (diff < 0) diff = 0;
          const diffRounded = Math.round(diff);
          h = Math.floor(diffRounded/60);
          m = diffRounded % 60;
          decH = diff / 60;
        }
        totEl.textContent = `${h}h ${m}m (${decH.toFixed(decimalPlaces)} h)`;
        const gross = decH * hourlyWage;
        const net = gross * (1 - taxRate);
        grossEl.value = formatCurrency(gross);
        netEl.value = formatCurrency(net);
      }

      function recalculateAllRowsAndTotal() {
        const days = getDaysInMonth(currentYear, currentMonth);
        for (let i = 1; i <= days; i++) calculateRow(i);
        calculateTotal();
      }

      function calculateTotal() {
        let totalMin = 0, totalGross = 0, totalNet = 0, validDays = 0, totalBreak = 0;
        const days = getDaysInMonth(currentYear, currentMonth);
        const reg = /^([01]\d|2[0-3]):([0-5]\d)$/;
        for (let i = 1; i <= days; i++) {
          const sEl = document.getElementById(`start-${i}`);
          const eEl = document.getElementById(`end-${i}`);
          const bEl = document.getElementById(`break-${i}`);
          if (!sEl || !eEl || !bEl) continue;
          const sTime = sEl.value, eTime = eEl.value;
          const bTime = parseFloat(String(bEl.value).replace(',', '.')) || 0;
          let dayDecH = 0;
          let valid = false;
          const validS = !sEl.classList.contains('invalid');
          const validE = !eEl.classList.contains('invalid');
          const validB = !bEl.classList.contains('invalid');
          if (reg.test(sTime) && reg.test(eTime) && validS && validE && validB) {
            const [sH,sM] = sTime.split(':').map(Number);
            const [eH,eM] = eTime.split(':').map(Number);
            let sTot = sH*60 + sM, eTot = eH*60 + eM;
            if (eTot < sTot) eTot += 24*60;
            let diff = eTot - sTot - (bTime*60);
            if (diff < 0) diff = 0;
            totalMin += diff;
            totalBreak += bTime*60;
            dayDecH = diff/60;
            valid = true;
          } else if (bTime>0 && validB) {
            totalBreak += bTime*60;
          }
          const dayGross = dayDecH * hourlyWage;
          const dayNet = dayGross * (1 - taxRate);
          totalGross += Math.max(0, dayGross);
          totalNet += Math.max(0, dayNet);
          if (valid) validDays++;
        }
        const totMinRounded = Math.round(totalMin);
        const totH = Math.floor(totMinRounded/60);
        const totM = totMinRounded % 60;
        const totDecH = totalMin/60;
        const breakH = Math.floor(totalBreak/60);
        const breakM = Math.round(totalBreak%60);
        const avgNet = validDays>0 ? totalNet/validDays : 0;
        const avgMin = validDays>0 ? totalMin/validDays : 0;
        const avgMinRounded = Math.round(avgMin);
        const avgH = Math.floor(avgMinRounded/60);
        const avgM = avgMinRounded % 60;
        const avgDecH = avgMin/60;
        totalSalaryDiv.innerHTML = `
          Zapoƒç√≠tan√Ωch (kompletn√Ωch) dn√≠: ${validDays}<br>
          Celkov√Ω odpracovan√Ω ƒças: <strong>${totH}h ${totM}m</strong> (${totDecH.toFixed(decimalPlaces)} h)<br>
          Celkov√° hrub√° mzda: <strong>${formatCurrency(totalGross)} ‚Ç¨</strong><br>
          Celkov√° ƒçist√° mzda: <strong>${formatCurrency(totalNet)} ‚Ç¨</strong><br>
          Celkov√Ω ƒças prest√°vok: ${breakH}h ${breakM}m<br>
          Priemern√° ƒçist√° mzda / de≈à: ${formatCurrency(avgNet)} ‚Ç¨<br>
          Priemern√Ω odprac. ƒças / de≈à: ${avgH}h ${avgM}m (${avgDecH.toFixed(decimalPlaces)} h)
        `;
      }

      /* ------------------------------
         12) Export PDF a Z√°loha
      ------------------------------- */
      exportPdfBtn.addEventListener('click', () => {
        if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.autoTable) {
          return showToast("Kni≈ænica pre PDF sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
        }
        showActivity('Generujem PDF...');
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(18);
          doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
          doc.setFontSize(12);
          doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 28);
          doc.text(`Hodinov√° mzda: ${hourlyWage.toFixed(2)} ‚Ç¨`, 14, 34);
          doc.text(`Sadzba dane: ${(taxRate*100).toFixed(1)} %`, 100, 34);
          const tableData = [];
          const days = getDaysInMonth(currentYear, currentMonth);
          for (let i = 1; i <= days; i++) {
            const dName = getDayName(currentYear, currentMonth, i);
            const sTime = document.getElementById(`start-${i}`)?.value || '';
            const eTime = document.getElementById(`end-${i}`)?.value || '';
            const bTime = document.getElementById(`break-${i}`)?.value || '0';
            const totText = document.getElementById(`total-${i}`)?.textContent || '';
            const gross = document.getElementById(`gross-${i}`)?.value || '0.00';
            const net = document.getElementById(`net-${i}`)?.value || '0.00';
            if (sTime || eTime || (parseFloat(String(bTime).replace(',','.'))>0)) {
              tableData.push([`${i}. (${dName})`, sTime, eTime, bTime, totText, gross+' ‚Ç¨', net+' ‚Ç¨']);
            }
          }
          doc.autoTable({
            head: [['De≈à','Pr√≠chod','Odchod','Prest. (h)','Odpracovan√©','Hrub√° Mzda','ƒåist√° Mzda']],
            body: tableData,
            startY: 40,
            styles: { font: 'helvetica', fontSize: 9 },
            headStyles: { fillColor: [74,98,122], textColor: 255, fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [245,245,245] },
          });
          const totalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(10);
          const totText = totalSalaryDiv.innerText.replace(/<strong>|<\/strong>/g, '');
          doc.text(totText, 14, totalY);
          doc.save(`Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`);
          showToast('PDF √∫spe≈°ne vygenerovan√©.', 'success');
        } catch (error) {
          console.error("Chyba pri generovan√≠ PDF:", error);
          showToast('Chyba pri generovan√≠ PDF.', 'error');
        } finally { hideActivity(); }
      });

      sharePdfBtn.addEventListener('click', async () => {
        if (!window.jspdf || !window.jspdf.jsPDF || !window.jspdf.jsPDF.autoTable) {
          return showToast("Kni≈ænica pre PDF sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
        }
        showActivity('Pripravujem PDF na zdieƒæanie...');
        let doc;
        try {
          const { jsPDF } = window.jspdf;
          doc = new jsPDF();
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(18);
          doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
          doc.setFontSize(12);
          doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 28);
          doc.text(`Hodinov√° mzda: ${hourlyWage.toFixed(2)} ‚Ç¨`, 14, 34);
          doc.text(`Sadzba dane: ${(taxRate*100).toFixed(1)} %`, 100, 34);
          const tableData = [];
          const days = getDaysInMonth(currentYear, currentMonth);
          for (let i = 1; i <= days; i++) {
            const dName = getDayName(currentYear, currentMonth, i);
            const sTime = document.getElementById(`start-${i}`)?.value || '';
            const eTime = document.getElementById(`end-${i}`)?.value || '';
            const bTime = document.getElementById(`break-${i}`)?.value || '0';
            const totText = document.getElementById(`total-${i}`)?.textContent || '';
            const gross = document.getElementById(`gross-${i}`)?.value || '0.00';
            const net = document.getElementById(`net-${i}`)?.value || '0.00';
            if (sTime || eTime || (parseFloat(String(bTime).replace(',','.'))>0)) {
              tableData.push([`${i}. (${dName})`, sTime, eTime, bTime, totText, gross+' ‚Ç¨', net+' ‚Ç¨']);
            }
          }
          doc.autoTable({
            head: [['De≈à','Pr√≠chod','Odchod','Prest. (h)','Odpracovan√©','Hrub√° Mzda','ƒåist√° Mzda']],
            body: tableData,
            startY: 40,
            styles: { font: 'helvetica', fontSize: 9 },
            headStyles: { fillColor: [74,98,122], textColor: 255, fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [245,245,245] },
          });
          const totalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(10);
          const totText = totalSalaryDiv.innerText.replace(/<strong>|<\/strong>/g, '');
          doc.text(totText, 14, totalY);
          const pdfBlob = doc.output('blob');
          const fileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
          const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
            await navigator.share({
              files: [pdfFile],
              title: `V√Ωkaz pr√°ce ${getMonthName(currentMonth)} ${currentYear}`,
              text: `V√Ωkaz pr√°ce pre ${employeeName || 'pracovn√≠ka'}...`
            });
            showToast('PDF pripraven√© na zdieƒæanie.', 'success');
          } else {
            showToast('Zdieƒæanie s√∫borov nie je podporovan√©. PDF bolo stiahnut√©.', 'warning', 4000);
            doc.save(fileName);
          }
        } catch (error) {
          console.error('Chyba pri zdieƒæan√≠ PDF:', error);
          showToast('Chyba pri zdieƒæan√≠ PDF.', 'error');
          if (doc) { try { doc.save(`Vykaz-chyba-${Date.now()}.pdf`); } catch(e) {} }
        } finally { hideActivity(); }
      });

      backupBtn.addEventListener('click', () => {
        if (typeof XLSX === 'undefined') {
          return showToast("Kni≈ænica pre Excel sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
        }
        showActivity('Vytv√°ram z√°lohu...');
        try {
          const currentData = collectCurrentData();
          if (!currentData?.data?.length) { showToast('Nie s√∫ d√°ta na z√°lohovanie.', 'warning'); hideActivity(); return; }
          const ws_data = [["De≈à","Pr√≠chod","Odchod","Prest√°vka (h)","Hrub√° Mzda (‚Ç¨)","ƒåist√° Mzda (‚Ç¨)"]];
          currentData.data.forEach((row, idx) => {
            const day = idx+1;
            ws_data.push([
              `${day}. (${getDayName(currentYear, currentMonth, day)})`,
              row.start, row.end,
              parseFloat(row.breakTime) || 0,
              parseFloat(row.gross) || 0,
              parseFloat(row.net) || 0
            ]);
          });
          ws_data.push([]);
          ws_data.push(["--- Nastavenia ---"]);
          ws_data.push(["Pracovn√≠k:", currentData.employeeName]);
          ws_data.push(["Hodinov√° mzda (‚Ç¨):", currentData.hourlyWage]);
          ws_data.push(["Sadzba dane (%):", currentData.taxRate*100]);
          ws_data.push(["Desatinn√© miesta:", currentData.decimalPlaces]);
          ws_data.push(["Posledn√° aktualiz√°cia:", currentData.lastUpdated ? new Date(currentData.lastUpdated).toLocaleString('sk-SK') : 'Nezn√°ma']);
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          ws['!cols'] = [{wch:15},{wch:10},{wch:10},{wch:12},{wch:15},{wch:15}];
          XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)}`);
          const fileName = `Zaloha-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.xlsx`;
          XLSX.writeFile(wb, fileName);
          showToast('Z√°loha bola √∫spe≈°ne vytvoren√°.', 'success');
        } catch (error) {
          console.error('Chyba pri vytv√°ran√≠ z√°lohy:', error);
          showToast('Chyba pri vytv√°ran√≠ z√°lohy.', 'error');
        } finally { hideActivity(); }
      });

      restoreBtn.addEventListener('click', () => {
        if (typeof XLSX === 'undefined') {
          return showToast("Kni≈ænica pre Excel sa e≈°te nenaƒç√≠tala, sk√∫ste o chv√≠ƒæu.", "warning");
        }
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls';
        input.onchange = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          if (!confirm(`Naozaj obnovi≈• d√°ta zo s√∫boru "${file.name}" pre ${getMonthName(currentMonth)} ${currentYear}?`)) return;
          showActivity(`Spracov√°vam z√°lohu...`);
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array', cellDates: true });
              const sheetName = workbook.SheetNames[0];
              const ws = workbook.Sheets[sheetName];
              const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });
              let headerRowIndex = rows.findIndex(r => String(r[0]).toLowerCase().includes("de≈à"));
              if (headerRowIndex === -1) throw new Error("Hlaviƒçka tabuƒæky ('De≈à') nebola n√°jden√°.");
              const dataStartIndex = headerRowIndex+1;
              const restoredDayData = [];
              let settings = {};
              const targetDays = getDaysInMonth(currentYear, currentMonth);
              let readingData = true;
              for (let i = dataStartIndex; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row.some(cell => cell !== "")) { readingData = false; continue; }
                const firstCell = String(row[0]).toLowerCase().trim();
                if (readingData && (firstCell.startsWith("de≈à") || /^\d+\.?/.test(firstCell))) {
                  if (restoredDayData.length < targetDays) {
                    restoredDayData.push({
                      start: String(row[1] || ""),
                      end: String(row[2] || ""),
                      breakTime: String(row[3] || "0").replace(',','.')
                    });
                  }
                } else {
                  readingData = false;
                  if (row.length > 1 && row[0]) {
                    const key = String(row[0]).toLowerCase().trim().replace(':','');
                    const val = String(row[1] || "").trim();
                    if (key.includes("pracovn√≠k")) settings.employeeName = val;
                    else if (key.includes("hodinov√° mzda")) settings.hourlyWage = parseFloat(val.replace(/[^\d.,]/g,'').replace(',','.')) || undefined;
                    else if (key.includes("sadzba dane")) settings.taxRate = (parseFloat(val.replace(/[^\d.,]/g,'').replace(',','.')) || 0) / 100;
                    else if (key.includes("desatinn√© miesta")) settings.decimalPlaces = parseInt(val) || undefined;
                  }
                }
              }
              while (restoredDayData.length < targetDays) {
                restoredDayData.push({ start:"", end:"", breakTime:"" });
              }
              const backupData = {
                data: restoredDayData,
                hourlyWage: settings.hourlyWage ?? hourlyWage,
                taxRate: settings.taxRate ?? taxRate,
                employeeName: settings.employeeName ?? employeeName,
                decimalPlaces: settings.decimalPlaces ?? decimalPlaces,
                lastUpdated: new Date().toISOString()
              };
              applyDataToUI(backupData);
              monthDataCache[`${currentYear}-${currentMonth}`] = backupData;
              handleDataChange();
              showToast('Z√°loha bola √∫spe≈°ne obnoven√°.', 'success');
            } catch (error) {
              console.error('Chyba pri naƒç√≠tavan√≠ z√°lohy:', error);
              showToast(`Chyba pri naƒç√≠tavan√≠ z√°lohy: ${error.message}`, 'error', 5000);
            } finally { hideActivity(); }
          };
          reader.onerror = () => { showToast('Chyba pri ƒç√≠tan√≠ s√∫boru.', 'error'); hideActivity(); }
          reader.readAsArrayBuffer(file);
        };
        input.click();
      });

      /* ------------------------------
         13) Ostatn√© listenery
      ------------------------------- */
      employeeNameInput.addEventListener('input', debounce(e => {
        employeeName = e.target.value.trim();
        mainTitle.textContent = employeeName ? `${employeeName} - Kalkulaƒçka` : "Bruno's Calculator Pro";
        handleDataChange();
      }, 500));
      hourlyWageInput.addEventListener('input', debounce(e => {
        hourlyWage = parseFloat(String(e.target.value).replace(',', '.')) || 0;
        recalculateAllRowsAndTotal();
        handleDataChange();
      }, 500));
      taxRateInput.addEventListener('input', debounce(e => {
        taxRate = (parseFloat(String(e.target.value).replace(',', '.')) || 0) / 100;
        if (taxRate < 0) taxRate = 0; if (taxRate > 1) taxRate = 1;
        recalculateAllRowsAndTotal();
        handleDataChange();
      }, 500));
      decimalPlacesSelect.addEventListener('change', e => {
        decimalPlaces = parseInt(e.target.value);
        recalculateAllRowsAndTotal();
        handleDataChange();
      });
      monthSelect.addEventListener('change', () => {
        currentMonth = parseInt(monthSelect.value);
        updateNavigationButtons();
        initializeAppSettings();
        loadAndDisplayData();
      });
      yearSelect.addEventListener('change', () => {
        currentYear = parseInt(yearSelect.value);
        updateNavigationButtons();
        initializeAppSettings();
        loadAndDisplayData();
      });
      prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
      nextMonthBtn.addEventListener('click', () => navigateMonth(1));
      prevYearBtn.addEventListener('click', () => navigateYear(-1));
      nextYearBtn.addEventListener('click', () => navigateYear(1));
      darkModeToggleBtn.addEventListener('click', toggleDarkMode);

      /* ------------------------------
         14) Inicializ√°cia aplik√°cie
      ------------------------------- */
      function initAppUI() {
        applyDarkModePreference();
        populateYearSelect();
        initializeAppSettings();
        updateAuthUI();
        loadAndDisplayData();
      }
      auth.onAuthStateChanged(user => {
        const wasLoggedIn = !!currentUser;
        currentUser = user;
        updateAuthUI();
        if (wasLoggedIn !== !!currentUser) { monthDataCache = {}; loadAndDisplayData(); }
      });
      document.addEventListener('DOMContentLoaded', () => {
        initAppUI();
        if (!navigator.onLine) { showToast("Aplik√°cia je v re≈æime offline.", "warning"); }
        window.addEventListener('online', () => showToast('Pripojenie k internetu obnoven√©.', 'success', 2000));
        window.addEventListener('offline', () => showToast('Ste offline. Zmeny sa ulo≈æia lok√°lne.', 'warning', 4000));
      });

      /* ------------------------------
         15) Service Worker
      ------------------------------- */
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(reg => {
              console.log('Service Worker zaregistrovan√Ω:', reg.scope);
              reg.onupdatefound = () => {
                const iw = reg.installing;
                if (iw) {
                  iw.onstatechange = () => {
                    if (iw.state === 'installed') {
                      if (navigator.serviceWorker.controller) {
                        console.log('Nov√Ω obsah je dostupn√Ω, pros√≠m obnovte str√°nku.');
                        showToast('Je dostupn√° nov√° verzia aplik√°cie. Obnovte str√°nku.', 'info', 10000);
                      } else {
                        console.log('Obsah je cachovan√Ω pre offline pou≈æitie.');
                        showToast('Aplik√°cia je pripraven√° na offline pou≈æitie.', 'success', 3000);
                      }
                    }
                  };
                }
              };
            })
            .catch(error => { console.error('Registr√°cia Service Workera zlyhala:', error); });
          navigator.serviceWorker.oncontrollerchange = () => {
            console.log('Nov√Ω Service Worker prevzal kontrolu. Odpor√∫ƒça sa obnovi≈• str√°nku.');
            showToast('Aplik√°cia bola aktualizovan√°. Obnovte str√°nku pre najnov≈°ie funkcie.', 'info', 10000);
          };
        });
      }
    })();
  </script>
</body>
</html>
