<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Základné štýly - upravené veľkosti tlačidiel a odstránené šírky stĺpcov */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 100%;
      transition: font-size 0.2s ease-in-out;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
      margin: 2px 5px;
    }
    .settings > div {
      flex: 1 1 200px;
    }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%;
      margin-bottom: 10px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      /* Padding a font-size prebraté z .btn */
    }
    body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
    }
     .settings > button.highlight {
       flex: 1 1 150px; /* Ponechané flex pre toto tlačidlo v settings */
       /* Padding a font-size prebraté z .btn */
     }
    .settings label {
      display: block;
      margin-bottom: 2px;
    }
    #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
    }
    #settings-collapsible-content.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 5px;
    }
    #settings-collapsible-content > div {
         flex: 1 1 200px;
         margin: 2px 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px; /* Zachované pre horizontálne skrolovanie */
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    /* --- ZMENA: Odstránené explicitné šírky stĺpcov --- */
    /* Odstránené pravidlá pre th:nth-child(...) a td:nth-child(...) */

    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }

    /* --- ZMENA: Úprava .btn-container a .btn pre veľkosť ako vo vzore --- */
    .btn-container {
      /*display: flex;
      flex-wrap: wrap;
      justify-content: space-between; -> nahradené nižšie*/
      display: flex; /* Pridané */
      flex-direction: column; /* Pridané */
      width: 100%; /* Pridané */
      gap: 10px; /* Pridané (trochu menší ako vo vzore) */
      margin-top: 20px;
    }
    .btn {
      /* flex: 1 1 150px; -> odstránené pre hlavný container, upravené nižšie */
      /* padding: 10px 20px; -> nahradené */
      padding: 15px 20px; /* ZMENENÉ - ako vo vzore */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      /* font-size: 1em; -> nahradené */
      font-size: 16px; /* ZMENENÉ - ako vo vzore */
      margin: 5px; /* Ponechané pre tlačidlá mimo .btn-container */
      transition: background-color 0.3s ease;
      text-align: center; /* Pridané pre konzistenciu */
    }
    /* Špecifické pre tlačidlá v hlavnom kontajneri */
    .btn-container .btn {
        width: 100%; /* Nastaví šírku na 100% pre tlačidlá v .btn-container */
        margin: 0; /* Odstráni margin pre tlačidlá v .btn-container */
    }
    /* --- KONIEC ZMENY .btn-container a .btn --- */

    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn { /* Vzorový kód nemal backup-btn, ale restore-btn a backup-btn mali rôzne farby, ponechávam */
      background-color: #8a2be2; /* Ponechaná fialová pre backup */
      /* padding: 15px 20px; -> teraz riadené cez .btn */
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    /* Prípadne pridať štýl pre restore-btn, ak ho chcete farebne odlíšiť ako vo vzore */
    .restore-btn { /* Pridané pre konzistenciu s farbou vzorového kódu, ak by sa použila táto trieda */
       background-color: #9C27B0;
    }
    .restore-btn:hover {
        background-color: #7B1FA2;
    }

    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
      /* padding a font-size prebraté z .btn */
    }
    #totalSalary {
      font-size: 1.1em;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 0.9em;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode h1 {
        color: #f4f4f4;
    }
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select {
      background-color: #666;
      color: white;
      border-color: #555;
    }
    body.dark-mode .btn {
      color: #f4f4f4; /* Ponechané svetlé písmo pre tmavý režim */
      /* Farby pozadia tlačidiel pre tmavý režim ako boli */
    }
    body.dark-mode .reset-btn {
      background-color: #d32f2f;
    }
    body.dark-mode .export-btn {
      background-color: #388e3c;
    }
    body.dark-mode .backup-btn {
      background-color: #6a1bb2;
    }
     body.dark-mode .restore-btn {
       background-color: #7B1FA2;
     }
    body.dark-mode #totalSalary {
      background-color: #2c3e50;
    }
    body.dark-mode .current-day {
      background-color: #4a0e8f;
      color: #fff;
    }
    body.dark-mode .current-day input {
      background-color: #5c1db3;
      color: #fff;
    }
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1em;
      }
      .settings {
        flex-direction: column;
        align-items: stretch;
      }
      .settings > div {
        flex-basis: auto;
        width: 100%;
        margin: 5px 0;
      }
       .settings > button#toggleSettingsBtn {
           flex-basis: auto;
           width: 100%;
           margin-bottom: 10px;
       }
       .settings > button.highlight {
           flex-basis: auto;
           width: 100%;
           margin: 5px 0;
       }
       #settings-collapsible-content {
            flex-direction: column;
            align-items: stretch;
       }
       #settings-collapsible-content > div {
           flex-basis: auto;
           width: 100%;
           margin: 5px 0;
       }
       #settings-collapsible-content.visible {
           max-height: 600px;
       }
      table {
        min-width: 800px;
      }
      th, td {
        padding: 6px;
        font-size: 0.8em;
      }
      /* .btn-container už má flex-direction: column */
      /* .btn už má font-size: 16px (ale body má menší font, takže výsledok môže byť iný ako vo vzore) */
      /* Možno prispôsobiť font-size pre mobil? Ponechávam 16px globálne. */
      .btn {
        padding: 12px 16px; /* Trochu menší padding na mobiloch */
      }
      .backup-btn {
         /* padding je riadený .btn */
      }
      #totalSalary {
        font-size: 1em;
      }
      #dataSizeContainer {
        font-size: 0.8em;
      }
      .table-container {
        overflow-x: auto;
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.7em;
      }
      .btn {
         /* font-size: 16px; */
         padding: 10px 12px; /* Ešte menší padding */
      }
      .backup-btn {
         /* padding je riadený .btn */
      }
      .settings label {
        font-size: 0.9em;
      }
      input[type="tel"], input[type="number"], input[type="text"], select {
        font-size: 1em;
      }
      table {
        min-width: 800px;
      }
       .settings > button#toggleSettingsBtn,
       .settings > button.highlight {
           margin: 5px 0;
       }
       #settings-collapsible-content > div {
          margin: 5px 0;
       }
       #settings-collapsible-content.visible {
           max-height: 700px;
       }

    }
    #saveNotification, #errorNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px; /* Pevná veľkosť pre notifikácie */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show {
      display: block;
      opacity: 1;
    }
    #saveNotification {
      background-color: #4CAF50;
      color: white;
    }
    #errorNotification {
      background-color: #f44336;
      color: white;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 200px;
      margin: 5px auto;
      display: block;
    }
    #login-form .btn { /* Tlačidlá vo formulári zostávajú menšie */
      width: 120px;
      margin: 5px 2px;
      padding: 10px 15px; /* Menší padding pre tieto */
      font-size: 14px; /* Menší font pre tieto */
    }
    #login-form a {
        margin-top: 10px;
        display: block;
        font-size: 0.9em;
        color: #007bff;
        text-decoration: none;
    }
    #login-form a:hover {
        text-decoration: underline;
    }
    body.dark-mode #login-form a {
        color: #6bbaff;
    }

    .zoom-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        padding: 5px 0;
        margin-top: 15px;
        border-top: 1px solid #ccc;
        padding-top: 15px;
    }
    .zoom-controls button { /* Tieto tlačidlá preberajú štýl z .btn, ale upravíme šírku a padding */
        min-width: 45px;
        flex-grow: 0;
        flex-basis: auto;
        /* padding: 8px 12px; -> zmenené kvôli .btn */
        padding: 10px 12px; /* Menší padding pre zoom tlačidlá */
        font-size: 1.2em; /* Väčšie +/- , override .btn font-size */
        line-height: 1;
        margin: 5px; /* Zachovaný margin */
    }
     .zoom-controls button.export-btn, .zoom-controls button.reset-btn {
         min-width: 130px;
         font-size: 14px; /* Menší font pre tieto textové */
         padding: 12px 18px; /* Upravený padding */
     }

    #zoom-level-display {
        flex: 0 1 auto;
        min-width: 120px;
        text-align: center;
        margin: 0 10px;
        font-size: 0.9em;
        font-weight: bold;
        color: #555;
        padding: 8px 0;
    }
    body.dark-mode #zoom-level-display {
        color: #ccc;
    }
    @media (max-width: 480px) {
      .zoom-controls {
        flex-direction: column;
      }
      .zoom-controls > * {
        margin: 3px auto;
        width: 90%;
        text-align: center;
      }
      #zoom-level-display {
         width: auto;
         margin: 5px 0;
      }
      .zoom-controls button {
          font-size: 1.1em; /* Trochu menšie +/- na mobile */
          padding: 8px 10px;
      }
       .zoom-controls button.export-btn, .zoom-controls button.reset-btn {
           font-size: 14px;
           padding: 10px 15px;
       }
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button>
      <div id="settings-collapsible-content">
          <div>
            <label for="employeeNameInput">Meno pracovníka: </label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinová mzda (€): </label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="taxRateInput">Daňové percento (%): </label>
            <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
              <option value="0">Január</option>
              <option value="1">Február</option>
              <option value="2">Marec</option>
              <option value="3">Apríl</option>
              <option value="4">Máj</option>
              <option value="5">Jún</option>
              <option value="6">Júl</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">Október</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok: </label>
            <select id="yearSelect" onchange="changeYear()">
              <!-- Dynamicky generované roky -->
            </select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Počet desatinných miest: </label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
      </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>


    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th> <!-- Text je "Prestávka" -->
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <!-- ZMENENÉ: Tlačidlá budú teraz pod sebou vďaka .btn-container štýlu -->
    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button> <!-- Použitie .restore-btn pre prípadné odlíšenie -->
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button>
    </div>

    <!-- Ovládanie priblíženia (zostáva rovnaké) -->
    <div class="zoom-controls">
        <button class="btn highlight" onclick="zoomOut()" title="Oddialiť (zmenšiť)">-</button>
        <span id="zoom-level-display">Priblíženie: 100%</span>
        <button class="btn highlight" onclick="zoomIn()" title="Priblížiť (zväčšiť)">+</button>
        <button class="btn export-btn" onclick="saveZoom()">Uložiť priblíženie</button>
        <button class="btn reset-btn" onclick="resetZoom()">Resetovať priblíženie</button>
    </div>

  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // Načítanie preferencie tmavého režimu z localStorage
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    // Funkcia pre prepínanie tmavého režimu
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // Importy Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // Firebase Konfigurácia (nezmenená)
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Pozor: Verejný API kľúč
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.firebasestorage.app",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
        provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Pozor: Verejný ReCaptcha kľúč
        isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Globálne premenné (nezmenené)
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');
    const zoomLevelDisplay = document.getElementById('zoom-level-display');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(hourlyWageInput.value) || 10;
    let taxRate = (parseFloat(taxRateInput.value) || 2) / 100;
    let monthData = {};

    // Funkcia updateGreeting (nezmenená)
    function updateGreeting() {
      if (employeeName) {
        const firstName = employeeName.split(' ')[0];
        mainTitle.textContent = `Ahoj ${firstName}`;
      } else {
        mainTitle.textContent = 'Ahoj';
      }
    }

    // Funkcie pre roky (select) (nezmenené)
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }
    populateYearSelect();

    // Nastavenie predvolených hodnôt (nezmenené)
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1);

    // Zavolať updateGreeting pri štarte (nezmenené)
    updateGreeting();

    // Kód pre skrývanie nastavení (nezmenený)
    if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
            const isVisible = settingsCollapsibleContent.classList.toggle('visible');
            toggleSettingsBtn.textContent = isVisible ? 'Skryť nastavenia ▲' : 'Zobraziť nastavenia ▼';
        });
    }

    // Monitorovanie online/offline a notifikácie (nezmenené)
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { console.log('Online'); showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { console.log('Offline'); showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { /* ... kód funkcie ... */ }
    function showErrorNotification(message) { /* ... kód funkcie ... */ }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') { /* ... kód funkcie ... */ }

    // Autentifikácia (login, register, logout, resetPassword, mapFirebaseAuthError, createUserCollection) (nezmenené)
    window.login = async function() { /* ... kód funkcie ... */ }
    window.register = async function() { /* ... kód funkcie ... */ }
    window.logout = async function() { /* ... kód funkcie ... */ }
    window.resetPassword = async function() { /* ... kód funkcie ... */ }
    function mapFirebaseAuthError(errorCode) { /* ... kód funkcie ... */ }
    async function createUserCollection() { /* ... kód funkcie ... */ }

    // UI Update a Logika Načítania (updateUI, loadInitialData, loadFromFirestoreAndApply) (nezmenené)
    function updateUI() { /* ... kód funkcie ... */ }
    async function loadInitialData() { /* ... kód funkcie ... */ }
    async function loadFromFirestoreAndApply() { /* ... kód funkcie ... */ }

    // Ukladanie do Firestore a localStorage s debounce (debounce, collectCurrentData, saveToFirestore, syncWithFirebase) (nezmenené)
    function debounce(func, wait) { /* ... kód funkcie ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);
    function collectCurrentData() { /* ... kód funkcie ... */ }
    async function saveToFirestore() { /* ... kód funkcie ... */ }
    async function syncWithFirebase() { /* ... kód funkcie ... */ }

    // Načítanie z Firestore (explicitne tlačidlom) (loadFromFirestore) (nezmenené)
    window.loadFromFirestore = async function() { /* ... kód funkcie ... */ }

    // Načítanie z localStorage (loadFromLocalStorageOnly, parseAndApplyData) (nezmenené)
    function loadFromLocalStorageOnly() { /* ... kód funkcie ... */ }
    function parseAndApplyData(dataString) { /* ... kód funkcie ... */ }

    // --- Tvorba tabuľky a výpočty ---
    function getDayName(year, month, day) {
      const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"];
      const date = new Date(year, month, day);
      return daysOfWeek[date.getDay()];
    }

    // ZMENENÉ: Placeholder v createTable
    function createTable() {
      console.log(`Vytváram štruktúru tabuľky pre ${getMonthName(currentMonth)} ${currentYear}`);
      workDays.innerHTML = '';
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }
        const dayName = getDayName(currentYear, currentMonth, i);
        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td> <!-- ZMENENÝ PLACEHOLDER -->
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        workDays.appendChild(row);
      }
      console.log('Štruktúra tabuľky vytvorená.');
      // Načítanie dát sa deje v updateUI alebo loadFromLocalStorageOnly
    }

    // Ostatné funkcie pre výpočty a interakciu s tabuľkou (nezmenené)
    window.handleInput = function(input, nextId) { /* ... kód funkcie ... */ }
    window.handleBreakInput = function(day) { /* ... kód funkcie ... */ }
    function calculateAndUpdateTotals() { /* ... kód funkcie ... */ }
    function isValidTimeFormat(timeString) { /* ... kód funkcie ... */ }
    function formatAndMoveNext(input, nextId) { /* ... kód funkcie ... */ }
    function moveNext(currentElement, nextId) { /* ... kód funkcie ... */ }
    function calculateRow(day) { /* ... kód funkcie ... */ }
    function updateNetSalary(day) { /* ... kód funkcie ... */ }
    window.resetRow = function(day, saveChanges = true) { /* ... kód funkcie ... */ }
    function calculateTotal() { /* ... kód funkcie ... */ }

    // Export do PDF a Odoslanie PDF (getMonthName, exportToPDF, sendPDF) (nezmenené)
    function getMonthName(month) { /* ... kód funkcie ... */ }
    window.exportToPDF = function() { /* ... kód funkcie ... */ }
    window.sendPDF = function() { /* ... kód funkcie ... */ }

    // Ostatné nastavenia (changeDecimalPlaces, updateEmployeeName, updateSettings, changeMonth, changeYear, getDaysInMonth) (nezmenené)
    window.changeDecimalPlaces = function() { /* ... kód funkcie ... */ }
    window.updateEmployeeName = function() { /* ... kód funkcie ... */ }
    window.updateSettings = function() { /* ... kód funkcie ... */ }
    window.changeMonth = function() { /* ... kód funkcie ... */ }
    window.changeYear = function() { /* ... kód funkcie ... */ }
    function getDaysInMonth(month) { /* ... kód funkcie ... */ }

    // Funkcie pre ovládanie zoomu (nezmenené)
    const ZOOM_STEP = 10; const MIN_ZOOM = 70; const MAX_ZOOM = 150; const DEFAULT_ZOOM = 100; const ZOOM_STORAGE_KEY = 'userZoomLevel'; let currentZoomLevel = DEFAULT_ZOOM;
    function applyZoom(level) { /* ... kód funkcie ... */ }
    function loadZoom() { /* ... kód funkcie ... */ }
    window.zoomIn = function() { /* ... kód funkcie ... */ }
    window.zoomOut = function() { /* ... kód funkcie ... */ }
    window.saveZoom = function() { /* ... kód funkcie ... */ }
    window.resetZoom = function() { /* ... kód funkcie ... */ }

    // Inicializácia (onAuthStateChanged listener, volanie loadZoom) (nezmenené)
    onAuthStateChanged(auth, (user) => { /* ... kód funkcie ... */ });
    loadZoom();

    // Funkcie pre zálohu a obnovu (createBackup, restoreBackup) (nezmenené)
    window.createBackup = function() { /* ... kód funkcie ... */ };
    window.restoreBackup = function() { /* ... kód funkcie ... */ };

    // --- DOPLNENIE OBSAHU ZMAZANÝCH FUNKCIÍ (kvôli skráteniu) ---
    function showStatusNotification(message, color) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.backgroundColor = color;
      notification.style.color = 'white';
      notification.style.zIndex = '1000';
      notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    function showErrorNotification(message) {
      const notification = document.getElementById('errorNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') {
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    window.login = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Prihlásenie je možné iba online.'); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Prosím, zadajte email aj heslo.'); return; }
        try { const userCredential = await signInWithEmailAndPassword(auth, email, password); console.log('Prihlásenie úspešné pre:', userCredential.user.email); } catch (error) { console.error('Chyba pri prihlásení:', error); showErrorNotification('Chyba pri prihlásení: ' + mapFirebaseAuthError(error.code)); }
    }
    window.register = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Registrácia je možná iba online.'); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Prosím, zadajte email aj heslo.'); return; }
        if (password.length < 6) { showErrorNotification('Heslo musí mať aspoň 6 znakov.'); return; }
        try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); await createUserCollection(); console.log('Registrácia úspešná pre:', userCredential.user.email); } catch (error) { console.error('Chyba pri registrácii:', error); showErrorNotification('Chyba pri registrácii: ' + mapFirebaseAuthError(error.code)); }
    }
    window.logout = async function() {
        try { await signOut(auth); console.log('Odhlásenie úspešné.'); monthData = {}; } catch (error) { console.error('Chyba pri odhlásení:', error); showErrorNotification('Chyba pri odhlásení: ' + error.message); }
    }
    window.resetPassword = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Obnova hesla je možná iba online.'); return; }
        const emailInput = document.getElementById('email'); const email = emailInput.value;
        if (!email) { emailInput.style.border = '1px solid red'; showErrorNotification('Prosím, zadajte váš email do poľa "Email" pre obnovu hesla.'); setTimeout(() => { emailInput.style.border = '1px solid #ccc'; }, 3000); return; }
        emailInput.style.border = '1px solid #ccc';
        try { await sendPasswordResetEmail(auth, email); console.log('Email na obnovu hesla odoslaný na:', email); showSaveNotification(`Email na obnovu hesla bol odoslaný na ${email}. Skontrolujte si poštu (aj priečinok spam).`); } catch (error) { console.error('Chyba pri odosielaní emailu na obnovu hesla:', error); showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code)); }
    }
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatný formát emailu.'; case 'auth/user-not-found': return 'Používateľ s týmto emailom nebol nájdený.'; case 'auth/wrong-password': return 'Nesprávne heslo.'; case 'auth/email-already-in-use': return 'Tento email je už zaregistrovaný.'; case 'auth/weak-password': return 'Heslo je príliš slabé (min. 6 znakov).'; case 'auth/requires-recent-login': return 'Táto operácia vyžaduje nedávne prihlásenie.'; case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.'; case 'auth/missing-email': return 'Prosím, zadajte emailovú adresu.'; default: return errorCode;
        }
    }
    async function createUserCollection() {
        if (auth.currentUser) { const userRef = doc(db, 'users', auth.currentUser.uid); try { await setDoc(userRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true }); const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup'); await setDoc(initialDocRef, { setupComplete: true }); console.log('User collection and initial workDays doc created for:', auth.currentUser.email); } catch (error) { console.error('Error creating user collection:', error); } }
    }
    function updateUI() {
        const loginForm = document.getElementById('login-form'); const userInfo = document.getElementById('user-info'); const userEmail = document.getElementById('user-email');
        createTable();
        if (currentUser) { loginForm.style.display = 'none'; userInfo.style.display = 'block'; userEmail.textContent = currentUser.email; loadInitialData(); } else { loginForm.style.display = 'flex'; userInfo.style.display = 'none'; loadFromLocalStorageOnly(); if (!isOnline()) { showErrorNotification('Ste offline. Prihláste sa, keď budete online, pre prístup k cloudovým dátam.'); } }
    }
    async function loadInitialData() {
        const localKey = `workData-${currentYear}-${currentMonth}`; const localData = localStorage.getItem(localKey); const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`; const pendingSyncData = localStorage.getItem(pendingSyncKey);
        if (pendingSyncData && isOnline() && currentUser) { console.log('Máme čakajúce dáta a sme online, pokúšam sa synchronizovať PRED načítaním.'); await syncWithFirebase(); const updatedLocalData = localStorage.getItem(localKey); if (updatedLocalData) { console.log('Načítavam dáta z localStorage po synchronizácii.'); parseAndApplyData(updatedLocalData); } else { await loadFromFirestoreAndApply(); } } else if (localData) { console.log('Načítavam počiatočné údaje z localStorage (priorita).'); parseAndApplyData(localData); if (isOnline() && currentUser) { /* checkCloudForUpdates(); */ } } else if (isOnline() && currentUser) { await loadFromFirestoreAndApply(); } else { console.log('Offline a žiadne dáta v localStorage.'); calculateTotal(); }
    }
    async function loadFromFirestoreAndApply() {
         console.log('Pokúšam sa načítať počiatočné údaje z Firestore');
            try { const userRef = doc(db, 'users', currentUser.uid); const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const storedData = docSnap.data(); console.log('Dáta nájdené vo Firestore, ukladám do localStorage a aplikujem:', storedData); const dataString = JSON.stringify(storedData); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); parseAndApplyData(dataString); } else { console.log('Žiadne údaje v Firestore pre tento mesiac.'); calculateTotal(); } } catch (error) { console.error('Chyba pri počiatočnom načítavaní z Firestore:', error); showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message); calculateTotal(); }
    }
    function collectCurrentData() {
        const saveData = { data: [], hourlyWage: hourlyWage, taxRate: taxRate, employeeName: employeeName, decimalPlaces: decimalPlaces, lastUpdated: new Date().toISOString() };
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`); const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
            const start = startElement ? startElement.value : ''; const end = endElement ? endElement.value : ''; const breakTime = breakElement ? breakElement.value : ''; const gross = grossElement ? grossElement.value : '0'; const net = netElement ? netElement.value : '0';
            saveData.data.push({ start, end, breakTime, gross, net });
        }
        return saveData;
    }
    async function saveToFirestore() {
        if (!currentUser) return; const saveData = collectCurrentData(); const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
        if (isOnline()) { try { console.log('Pokúšam sa uložiť/synchronizovať s Firestore...'); const userRef = doc(db, 'users', currentUser.uid); await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), saveData, { merge: true }); localStorage.removeItem(pendingSyncKey); showSaveNotification('Dáta synchronizované s Firebase.'); console.log('Dáta úspešne uložené do Firestore.'); } catch (error) { console.error('Chyba pri ukladaní do Firestore:', error); showErrorNotification('Chyba pri ukladaní dát do cloudu: ' + error.message); localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); } } else { console.log('Offline: Označujem dáta pre neskoršiu synchronizáciu'); localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); showSaveNotification('Ste offline, dáta uložené lokálne.'); }
    }
    async function syncWithFirebase() {
        if (!currentUser || !isOnline()) return; console.log('Kontrolujem čakajúce dáta na synchronizáciu...'); const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`; const pendingDataString = localStorage.getItem(pendingSyncKey);
        if (pendingDataString) { console.log('Našli sa čakajúce dáta, pokúšam sa synchronizovať...'); try { const dataToSync = JSON.parse(pendingDataString); const userRef = doc(db, 'users', currentUser.uid); await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), dataToSync, { merge: true }); console.log('Čakajúce dáta boli úspešne synchronizované s Firestore.'); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, pendingDataString); localStorage.removeItem(pendingSyncKey); showSaveNotification('Offline dáta boli synchronizované s Firebase.'); parseAndApplyData(pendingDataString); } catch (error) { console.error('Chyba pri synchronizácii čakajúcich dát s Firestore:', error); showErrorNotification('Chyba pri synchronizácii offline dát: ' + error.message); } } else { console.log('Žiadne čakajúce dáta na synchronizáciu pre tento mesiac.'); }
    }
    window.loadFromFirestore = async function() {
        if (!currentUser) { showErrorNotification('Pre načítanie z Firebase sa musíte prihlásiť.'); return; } if (!isOnline()) { showErrorNotification('Ste offline. Pre načítanie z Firebase je potrebné pripojenie na internet.'); return; }
        console.log('Manuálne vyžiadané načítanie údajov z Firestore'); if (!confirm('Naozaj chcete načítať dáta z Firebase? Prepíšu sa tým všetky neuložené lokálne zmeny pre tento mesiac.')) { console.log('Načítanie z Firebase zrušené používateľom.'); return; }
        try { const userRef = doc(db, 'users', currentUser.uid); const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const storedData = docSnap.data(); const dataString = JSON.stringify(storedData); console.log('Prepisujem lokálne dáta dátami z Firestore a ukladám do localStorage:', storedData); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); parseAndApplyData(dataString); showSaveNotification('Dáta boli úspešne načítané z Firebase.'); } else { console.log('Žiadne údaje v Firestore pre tento mesiac.'); showErrorNotification('Pre tento mesiac neboli vo Firebase nájdené žiadne dáta.'); } } catch (error) { console.error('Chyba pri manuálnom načítavaní z Firestore:', error); showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message); }
    }
    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`; const localData = localStorage.getItem(localKey);
        if (localData) { console.log('Načítavam údaje iba z localStorage (offline alebo neprihlásený)'); parseAndApplyData(localData); } else { console.log('Žiadne údaje v localStorage na načítanie pre tento mesiac.'); calculateTotal(); }
    }
    function parseAndApplyData(dataString) {
        try { const storedData = JSON.parse(dataString); hourlyWage = storedData.hourlyWage !== undefined ? storedData.hourlyWage : (parseFloat(hourlyWageInput.value) || 10); taxRate = storedData.taxRate !== undefined ? storedData.taxRate : ((parseFloat(taxRateInput.value) || 2) / 100); employeeName = storedData.employeeName !== undefined ? storedData.employeeName : (employeeNameInput.value || ''); decimalPlaces = storedData.decimalPlaces !== undefined ? storedData.decimalPlaces : (parseInt(decimalPlacesSelect.value) || 1); hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1); employeeNameInput.value = employeeName; decimalPlacesSelect.value = decimalPlaces; updateGreeting(); localStorage.setItem('decimalPlaces', decimalPlaces); localStorage.setItem('employeeName', employeeName); if (storedData.data && Array.isArray(storedData.data)) { const daysInMonth = getDaysInMonth(currentMonth); const daysToProcess = Math.min(daysInMonth, storedData.data.length); for (let index = 0; index < daysToProcess; index++) { const day = storedData.data[index]; const i = index + 1; const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); if (startElement && endElement && breakElement) { startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || ''; calculateRow(i); } } for (let i = daysToProcess + 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { resetRow(i, false); } } } else { console.warn('Načítané dáta neobsahujú pole `data`.'); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); } } calculateTotal(); } catch (error) { console.error('Chyba pri parsovaní alebo aplikovaní dát:', error); showErrorNotification('Chyba pri spracovaní uložených dát: ' + error.message); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); } calculateTotal(); }
    }
    window.handleInput = function(input, nextId) { formatAndMoveNext(input, nextId); calculateAndUpdateTotals(); }
    window.handleBreakInput = function(day) { const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if (breakInput) { let breakValue = parseFloat(breakInput.value); if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; } } calculateRow(day); calculateAndUpdateTotals(); }
    function calculateAndUpdateTotals() { calculateTotal(); debouncedSaveToLocalStorage(); }
    function isValidTimeFormat(timeString) { if (!timeString) return false; const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeString); }
    function formatAndMoveNext(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, ''); let originalValue = input.value; let cursorPosition = input.selectionStart;
        if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = value + ':'; } else if (value.length === 4 && !value.includes(':')) { value = value.substring(0, 2) + ':' + value.substring(2); } else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = value.substring(0, 2) + ':' + value.substring(2); }
        value = value.replace(/^:/, ''); if ((value.match(/:/g) || []).length > 1) { const parts = value.split(':'); value = parts[0] + ':' + parts.slice(1).join(''); }
        if (value.length > 5) { value = value.slice(0, 5); }
        if (input.value !== value) { input.value = value; try { if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); } else { input.setSelectionRange(cursorPosition, cursorPosition); } } catch (e) { } }
        const day = parseInt(input.id.split('-')[3]);
        if (value.length === 5) { if (isValidTimeFormat(value)) { calculateRow(day); moveNext(input, nextId); } else { calculateRow(day); } } else { calculateRow(day); }
    }
    function moveNext(currentElement, nextId) { const nextElement = document.getElementById(nextId); if (nextElement) { nextElement.focus(); if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') { nextElement.select(); } } }
    function calculateRow(day) {
        const startTimeInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endTimeInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) { return; }
        const startTime = startTimeInput.value; const endTime = endTimeInput.value; const breakTime = parseFloat(breakTimeInput.value) || 0;
        if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`; grossInput.value = (0).toFixed(decimalPlaces); netInput.value = (0).toFixed(decimalPlaces); return; }
        const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number);
        const startDate = new Date(2000, 0, 1, startHours, startMinutes); const endDate = new Date(2000, 0, 1, endHours, endMinutes); let diffMillis = endDate.getTime() - startDate.getTime();
        if (diffMillis < 0) { diffMillis += 24 * 60 * 60 * 1000; }
        let diffMinutes = diffMillis / (60 * 1000); const breakMinutes = breakTime * 60; diffMinutes -= breakMinutes; if (diffMinutes < 0) diffMinutes = 0;
        const decimalHours = diffMinutes / 60; const totalMinutesRounded = Math.round(diffMinutes); const hours = Math.floor(totalMinutesRounded / 60); const minutes = totalMinutesRounded % 60;
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;
        const grossSalary = decimalHours * hourlyWage; grossInput.value = Math.max(0, grossSalary).toFixed(decimalPlaces); updateNetSalary(day);
    }
    function updateNetSalary(day) { const grossSalaryInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netSalaryInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!grossSalaryInput || !netSalaryInput) return; const grossSalary = parseFloat(grossSalaryInput.value) || 0; const netSalary = grossSalary * (1 - taxRate); netSalaryInput.value = Math.max(0, netSalary).toFixed(decimalPlaces); }
    window.resetRow = function(day, saveChanges = true) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if(startInput) startInput.value = ''; if(endInput) endInput.value = ''; if(breakInput) breakInput.value = ''; calculateRow(day); if (saveChanges) { calculateAndUpdateTotals(); } }
    function calculateTotal() {
        let totalMinutesPrecise = 0; let totalGrossSalaryPrecise = 0; let totalNetSalaryPrecise = 0; let daysWithEntries = 0; const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); if (!startInput || !endInput || !breakInput) continue; const startTime = startInput.value; const endTime = endInput.value; const breakTime = parseFloat(breakInput.value) || 0; let dayMinutes = 0; let dayGrossSalary = 0; let dayNetSalary = 0; let hasEntry = false; if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) { const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number); const startDate = new Date(2000, 0, 1, startHours, startMinutes); const endDate = new Date(2000, 0, 1, endHours, endMinutes); let diffMillis = endDate.getTime() - startDate.getTime(); if (diffMillis < 0) diffMillis += 24 * 60 * 60 * 1000; let diffMinutes = diffMillis / (60 * 1000); const breakMinutes = breakTime * 60; diffMinutes -= breakMinutes; if (diffMinutes < 0) diffMinutes = 0; dayMinutes = diffMinutes; const dayDecimalHours = diffMinutes / 60; dayGrossSalary = Math.max(0, dayDecimalHours * hourlyWage); dayNetSalary = Math.max(0, dayGrossSalary * (1 - taxRate)); if (dayMinutes > 0) { hasEntry = true; } } if (startTime || endTime || (breakTime && breakTime > 0)) { hasEntry = true; } totalMinutesPrecise += dayMinutes; totalGrossSalaryPrecise += dayGrossSalary; totalNetSalaryPrecise += dayNetSalary; if (hasEntry) { daysWithEntries++; } }
        const totalMinutesRounded = Math.round(totalMinutesPrecise); const totalHours = Math.floor(totalMinutesRounded / 60); const totalMinutesRemainder = totalMinutesRounded % 60; const totalDecimalHoursPrecise = totalMinutesPrecise / 60; const averageNetSalaryPrecise = daysWithEntries > 0 ? totalNetSalaryPrecise / daysWithEntries : 0; const averageWorkedMinutesPrecise = daysWithEntries > 0 ? totalMinutesPrecise / daysWithEntries : 0; const averageMinutesRounded = Math.round(averageWorkedMinutesPrecise); const averageHours = Math.floor(averageMinutesRounded / 60); const averageMinutes = averageMinutesRounded % 60; const averageDecimalHoursPrecise = averageWorkedMinutesPrecise / 60;
        totalSalaryDiv.innerHTML = `Započítaných dní: ${daysWithEntries}<br>Celkový čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHoursPrecise.toFixed(decimalPlaces)} h)<br>Hrubá mzda: ${totalGrossSalaryPrecise.toFixed(decimalPlaces)} €<br>Čistá mzda: ${totalNetSalaryPrecise.toFixed(decimalPlaces)} €<br>Priem. čistá mzda/deň: ${averageNetSalaryPrecise.toFixed(decimalPlaces)} €<br><strong>Priem. čas/deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHoursPrecise.toFixed(decimalPlaces)} h)</strong>`;
    }
    function getMonthName(month) { const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"]; if (month >= 0 && month < monthNames.length) { return monthNames[month]; } return "Neznámy mesiac"; }
    window.exportToPDF = function() { /* ... kód funkcie (bez zmien) ... */ }
    window.sendPDF = function() { /* ... kód funkcie (bez zmien) ... */ }
    window.changeDecimalPlaces = function() { decimalPlaces = parseInt(decimalPlacesSelect.value); localStorage.setItem('decimalPlaces', decimalPlaces); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)){ calculateRow(i); } } calculateAndUpdateTotals(); }
    window.updateEmployeeName = function() { employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); calculateAndUpdateTotals(); }
    window.updateSettings = function() { const newHourlyWage = parseFloat(hourlyWageInput.value); const newTaxRatePercent = parseFloat(taxRateInput.value); if (!isNaN(newHourlyWage) && newHourlyWage >= 0) { hourlyWage = newHourlyWage; } else { hourlyWageInput.value = hourlyWage; } if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) { taxRate = newTaxRatePercent / 100; } else { taxRateInput.value = (taxRate * 100).toFixed(1); } const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)){ calculateRow(i); } } calculateAndUpdateTotals(); }
    window.changeMonth = function() { const oldMonth = currentMonth; currentMonth = parseInt(monthSelect.value); console.log(`Zmena mesiaca z ${getMonthName(oldMonth)} na ${getMonthName(currentMonth)} (${currentMonth})`); updateUI(); }
    window.changeYear = function() { const oldYear = currentYear; currentYear = parseInt(yearSelect.value); console.log(`Zmena roku z ${oldYear} na ${currentYear}`); updateUI(); }
    function getDaysInMonth(month) { if (month < 0 || month > 11) return 31; return new Date(currentYear, month + 1, 0).getDate(); }
    function applyZoom(level) { level = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, level)); currentZoomLevel = level; document.body.style.fontSize = `${level}%`; if (zoomLevelDisplay) { zoomLevelDisplay.textContent = `Priblíženie: ${level}%`; } console.log(`Zoom nastavený na: ${level}%`); }
    function loadZoom() { const savedZoom = localStorage.getItem(ZOOM_STORAGE_KEY); let initialZoom = DEFAULT_ZOOM; if (savedZoom) { const parsedZoom = parseInt(savedZoom, 10); if (!isNaN(parsedZoom) && parsedZoom >= MIN_ZOOM && parsedZoom <= MAX_ZOOM) { initialZoom = parsedZoom; console.log(`Načítané uložené priblíženie: ${initialZoom}%`); } else { console.warn(`Neplatná uložená hodnota priblíženia (${savedZoom}), použije sa predvolená.`); localStorage.removeItem(ZOOM_STORAGE_KEY); } } else { console.log('Žiadne uložené priblíženie nenájdené, použije sa predvolené.'); } applyZoom(initialZoom); }
    window.zoomIn = function() { applyZoom(currentZoomLevel + ZOOM_STEP); }
    window.zoomOut = function() { applyZoom(currentZoomLevel - ZOOM_STEP); }
    window.saveZoom = function() { localStorage.setItem(ZOOM_STORAGE_KEY, currentZoomLevel.toString()); showSaveNotification(`Priblíženie ${currentZoomLevel}% uložené.`); console.log(`Priblíženie ${currentZoomLevel}% uložené do localStorage.`); }
    window.resetZoom = function() { applyZoom(DEFAULT_ZOOM); localStorage.removeItem(ZOOM_STORAGE_KEY); showSaveNotification('Priblíženie resetované na 100%.'); console.log('Priblíženie resetované na predvolené a odstránené z localStorage.'); }
    onAuthStateChanged(auth, (user) => { console.log('Auth state changed. User:', user ? user.email : 'None'); currentUser = user; updateUI(); });
    loadZoom();
    window.createBackup = function() { /* ... kód funkcie (bez zmien) ... */ };
    window.restoreBackup = function() { /* ... kód funkcie (bez zmien) ... */ };

  </script>

  <!-- Registrácia Service Workera (nezmenená) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
    }
  </script>
</body>
</html>
