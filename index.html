<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- Základné štýly --- */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 { /* ... bez zmien ... */ }
    h2 { /* ... bez zmien ... */ }
    .settings { /* ... bez zmien ... */ }
    .settings > div { /* ... bez zmien ... */ }
    .settings > button#toggleSettingsBtn { /* ... bez zmien ... */ }
    body.dark-mode .settings > button#toggleSettingsBtn { /* ... bez zmien ... */ }
    .settings > button.highlight { /* ... bez zmien ... */ }
    .settings label { /* ... bez zmien ... */ }
    #settings-collapsible-content { /* ... bez zmien ... */ }
    #settings-collapsible-content.visible { /* ... bez zmien ... */ }
    #settings-collapsible-content > div { /* ... bez zmien ... */ }
    .table-container { /* ... bez zmien ... */ }
    table { /* ... bez zmien ... */ }

    /* --- Štýly buniek a hlavičky --- */
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle; /* Ponechané middle */
    }
    th {
      background-color: #f2f2f2;
    }

    /* --- Štýly pre wrapper času --- */
    td .time-input-wrapper { /* ... bez zmien ... */ }
    td .time-input-wrapper input[type="tel"] { /* ... bez zmien ... */ }
    td .time-input-wrapper .time-btn { /* ... bez zmien ... */ }
    td .time-input-wrapper .time-btn:hover { /* ... bez zmien ... */ }
    body.dark-mode td .time-input-wrapper .time-btn { /* ... bez zmien ... */ }
    body.dark-mode td .time-input-wrapper .time-btn:hover { /* ... bez zmien ... */ }


    /* --- Šírky stĺpcov --- */
    /* 1: Deň, 2: Príchod, 3: Odchod, 4: Prestávka, 5: Odpracované, 6: Poznámka, 7: Hrubá, 8: Čistá, 9: Akcia */
    th:nth-child(7), td:nth-child(7), /* Hrubá Mzda */
    th:nth-child(8), td:nth-child(8) { /* Čistá Mzda */ width: 14%; }
    th:nth-child(6), td:nth-child(6) { /* Poznámka */ width: 20%; }
    th:nth-child(1), td:nth-child(1) { /* Deň */ width: 7%; }
    th:nth-child(2), td:nth-child(2) { /* Príchod */ width: 10%; }
    th:nth-child(3), td:nth-child(3) { /* Odchod */ width: 10%; }
    th:nth-child(4), td:nth-child(4) { /* Prestávka */ width: 7%; }
    th:nth-child(5), td:nth-child(5) { /* Odpracované */ width: 10%; }
    th:nth-child(9), td:nth-child(9) { /* Akcia */ width: 8%; }

    /* --- Globálne štýly pre input a select --- */
    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      font-family: inherit;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle; /* Ponechané middle */
      /* line-height: 1.4; */ /* Odstránené */
    }

    /* --- Špecifický štýl pre input poznámky (NOVÝ PRÍSTUP) --- */
    td:nth-child(6) { /* Zameranie na bunku TD poznámky */
       max-height: 5em; /* Obmedzenie výšky samotnej bunky (cca 3 riadky) */
       overflow: hidden; /* Skrytie obsahu, ktorý presahuje bunku */
       /* vertical-align: top; */ /* Môže byť potrebné, ak `middle` spôsobuje problémy */
    }

    input[id^="note-"] {
        background-color: #e6faff; /* Špecifická farba */
        height: auto;      /* Výška sa prispôsobí obsahu */
        min-height: 2.4em; /* Minimálna výška (cca 1 riadok + padding) */
        display: block;    /* Pre správne fungovanie výšky a overflow */
        width: 100%;       /* Zaberie celú šírku bunky */
        overflow-y: auto;  /* SKROLLOVANIE vnútri inputu */
        white-space: normal; /* Povolenie zalamovania textu */
        resize: none;      /* Inputy nemajú resize */
        /* Uistiť sa, že padding a border sú započítané */
        box-sizing: border-box;
        padding: 5px;
        border: none; /* Odstránime border inputu, keďže TD má border */
        /* Ak je border odstránený, pozadie sa môže dediť, tak ho nastavíme znova */
        background-color: #e6faff;
    }
    /* Odstránime padding bunky, aby input vyplnil celú výšku/šírku */
    td:nth-child(6) {
      padding: 0 !important; /* Odstránenie paddingu bunky poznámky */
    }
    /* A pridáme padding späť do inputu, ale musíme zohľadniť box-sizing */
    input[id^="note-"] {
        /* ... (ostatné štýly pre input[id^="note-"]) ... */
        padding: 5px;
        /* Border je už none */
    }


    .result { /* ... bez zmien ... */ }
    .btn-container { /* ... bez zmien ... */ }
    /* ... ostatné štýly tlačidiel ... */
    #totalSalary { /* ... bez zmien ... */ }
    #dataSizeContainer { /* Bez zmien */ }
    #dataSizeText { /* Bez zmien */ }
    #dataSizeBar { /* Bez zmien */ }
    #dataSizeFill { /* Bez zmien */ }

    /* --- Zvýraznenie aktuálneho dňa --- */
    .current-day { /* ... bez zmien ... */ }
    .current-day input, .current-day select { /* ... bez zmien ... */ }
    /* Štýl pre input poznámky v aktuálnom dni */
    .current-day input[id^="note-"] {
        background-color: #aa44dd !important; /* Trochu iná farba */
        color: white !important;
        /* border: none !important; */ /* Border je už none */
    }
    /* Ak by sme chceli border v aktuálny deň */
    /* .current-day td:nth-child(6) {
        border-color: #b366ff !important;
    } */
    .current-day .time-btn { /* ... bez zmien ... */ }
    .current-day .time-btn:hover { /* ... bez zmien ... */ }

    /* --- Tmavý režim --- */
    body.dark-mode { /* ... bez zmien ... */ }
    body.dark-mode .container { /* ... bez zmien ... */ }
    body.dark-mode h1 { /* ... bez zmien ... */ }
    body.dark-mode table { /* ... bez zmien ... */ }
    body.dark-mode th { /* ... bez zmien ... */ }
    body.dark-mode td { /* ... bez zmien ... */ }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select { /* Bez `textarea` */
        background-color: #666;
        color: white;
        border-color: #555;
    }
    /* Tmavý režim pre input poznámky */
    body.dark-mode input[id^="note-"] {
        background-color: #5a5a7a !important; /* Dôležité na prebitie špecifickosti */
        color: white;
        border: none; /* Zdedí border z TD */
    }
    /* Tmavý režim pre bunku poznámky */
    body.dark-mode td:nth-child(6) {
        background-color: #444; /* Zabezpečí pozadie bunky, keď input nemá border */
        border-color: #555;
    }

    /* Zvyšok tmavého režimu */
    body.dark-mode .btn { /* ... bez zmien ... */ }
    /* ... ostatné tmavé štýly ... */
    body.dark-mode .current-day input[id^="note-"] {
       background-color: #6c2fc7 !important;
       /* border: none !important; */
    }
    body.dark-mode .current-day td:nth-child(6) {
       background-color: #5c1db3 !important; /* Pozadie bunky v aktuálnom dni */
       border-color: #7e4bd7 !important; /* Border bunky v aktuálnom dni */
    }

    /* --- Responzivita --- */
    @media (max-width: 768px) {
        /* ... ostatné responzívne pravidlá ... */
        th, td { font-size: 0.8em; } /* Zachované */
        input[type="tel"], input[type="number"], input[type="text"], select {
            font-size: 13px; /* Trochu menšie pre konzistenciu */
        }
        input[id^="note-"] {
            font-size: 13px; /* Rovnaké ako ostatné */
            min-height: 2.2em;
        }
        td:nth-child(6) { /* Bunka poznámky */
           max-height: 4.5em; /* Menšia maximálna výška */
        }
    }
    @media (max-width: 480px) {
        /* ... ostatné responzívne pravidlá ... */
        th, td { font-size: 0.7em; } /* Zachované */
        input[type="tel"], input[type="number"], input[type="text"], select, input[id^="note-"] { /* Všetky inputy */
            font-size: 12px; /* Ešte menšie */
        }
        input[id^="note-"] {
            min-height: 2em;
        }
         td:nth-child(6) { /* Bunka poznámky */
           max-height: 4em; /* Ešte menšia maximálna výška */
        }
    }

    /* --- Notifikácie --- */
    /* ... bez zmien ... */

    /* --- Prihlasovanie --- */
    /* ... bez zmien ... */
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
        <div id="login-form" style="display: none;"> <input type="email" id="email" placeholder="Email"> <input type="password" id="password" placeholder="Heslo"> <button class="btn export-btn" onclick="login()">Prihlásiť sa</button> <button class="btn export-btn" onclick="register()">Registrovať</button> <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a> </div> <div id="user-info" style="display: none;"> <span id="user-email"></span> <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button> </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <div class="settings"> <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button> <div id="settings-collapsible-content"> <div> <label for="employeeNameInput">Meno pracovníka: </label> <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"> </div> <div> <label for="hourlyWageInput">Hodinová mzda (€): </label> <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"> </div> <div> <label for="taxRateInput">Daňové percento (%): </label> <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"> </div> <div> <label for="monthSelect">Mesiac: </label> <select id="monthSelect" onchange="changeMonth()"> <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option> <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option> <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option> <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option> </select> </div> <div> <label for="yearSelect">Rok: </label> <select id="yearSelect" onchange="changeYear()"></select> </div> <div> <label for="decimalPlacesSelect">Počet desatinných miest: </label> <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"> <option value="1">1</option> <option value="2">2</option> </select> </div> </div> <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button> </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Poznámka</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container"> <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button> <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button> <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button> <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button> <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button> </div>
  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <script type="module">
    // --- Prepínanie tmavého režimu --- (bez zmien)
    if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
    window.toggleDarkMode = function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }

    // --- IMPORTY Firebase --- (bez zmien)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // --- KONFIGURÁCIA Firebase --- (bez zmien)
     const firebaseConfig = { /* ... vaša konfigurácia ... */ };

    // --- Inicializácia Firebase --- (bez zmien)
    const app = initializeApp(firebaseConfig);
    try { /* ... App Check ... */ } catch (e) { console.warn("App Check failed:", e); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- GLOBÁLNE PREMENNÉ --- (bez zmien)
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    /* ... ostatné globálne premenné ... */
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;

    // --- Funkcie pre UI, Auth, Dáta, Výpočty, Pomocné --- (bez zmien oproti pôvodnej verzii s inputom)
    function updateGreeting() { /* ... bez zmien ... */ }
    function populateYearSelect() { /* ... bez zmien ... */ }
    /* ... Nastavenie počiatočných hodnôt ... */
    /* ... Skrývanie nastavení ... */
    /* ... Online/Offline + Notifikácie ... */
    window.login = async function() { /* ... bez zmien ... */ };
    window.register = async function() { /* ... bez zmien ... */ };
    window.logout = async function() { /* ... bez zmien ... */ };
    window.resetPassword = async function() { /* ... bez zmien ... */ };
    function mapFirebaseAuthError(errorCode) { /* ... bez zmien ... */ }
    async function createUserCollection() { /* ... bez zmien ... */ }
    function updateUI() { /* ... bez zmien ... */ }
    async function loadInitialData() { /* ... bez zmien ... */ }
    async function loadFromFirestoreAndApply() { /* ... bez zmien ... */ }
    function debounce(func, wait) { /* ... bez zmien ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);
    function collectCurrentData() { /* ... bez zmien (používa .value) ... */ }
    async function saveToFirestore() { /* ... bez zmien ... */ }
    async function syncWithFirebase() { /* ... bez zmien ... */ }
    window.loadFromFirestore = async function() { /* ... bez zmien ... */ };
    function loadFromLocalStorageOnly() { /* ... bez zmien ... */ }
    function parseAndApplyData(dataString) { /* ... bez zmien (používa .value) ... */ }
    function getDayName(year, month, day) { /* ... bez zmien ... */ }

    // --- ZMENENÉ: createTable používa opäť input type="text" ---
    function createTable() {
      console.log(`Vytváram štruktúru tabuľky pre ${getMonthName(currentMonth)} ${currentYear}`);
      workDays.innerHTML = '';
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        const startId = `start-${currentYear}-${currentMonth}-${i}`;
        const endId = `end-${currentYear}-${currentMonth}-${i}`;
        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
        const noteId = `note-${currentYear}-${currentMonth}-${i}`; // Späť na input
        const grossId = `gross-${currentYear}-${currentMonth}-${i}`;
        const netId = `net-${currentYear}-${currentMonth}-${i}`;
        const totalId = `total-${currentYear}-${currentMonth}-${i}`;

        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td>
            <div class="time-input-wrapper">
              <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}')">
              <span class="time-btn" onclick="setCurrentTime('${startId}')" title="Zadať aktuálny čas">🕒</span>
            </div>
          </td>
          <td>
            <div class="time-input-wrapper">
              <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}')">
              <span class="time-btn" onclick="setCurrentTime('${endId}')" title="Zadať aktuálny čas">🕒</span>
            </div>
          </td>
          <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
          <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="text" id="${noteId}" placeholder="Poznámka..." oninput="calculateAndUpdateTotals()"></td> {/* VRÁTENÉ: input type="text" */}
          <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        workDays.appendChild(row);
      }
      console.log('Štruktúra tabuľky vytvorená.');
    }

    // --- Ostatné JS funkcie --- (bez zmien oproti pôvodnej verzii s inputom)
    window.setCurrentTime = function(inputId) { /* ... bez zmien ... */ }
    window.handleInput = function(input, nextId) { /* ... bez zmien ... */ }
    window.handleBreakInput = function(day) { /* ... bez zmien ... */ }
    function calculateAndUpdateTotals() { /* ... bez zmien ... */ }
    function isValidTimeFormat(timeString) { /* ... bez zmien ... */ }
    function formatAndMoveNext(input, nextId) { /* ... bez zmien ... */ }
    function moveNext(currentElement, nextId) { /* ... bez zmien ... */ }
    function calculateRow(day) { /* ... bez zmien ... */ }
    function updateNetSalary(day) { /* ... bez zmien ... */ }
    window.resetRow = function(day, saveChanges = true) { /* ... bez zmien (používa .value) ... */ }
    function calculateTotal() { /* ... bez zmien ... */ }
    function getMonthName(month) { /* ... bez zmien ... */ }
    window.exportToPDF = function() { /* ... bez zmien (používa .value) ... */ }
    window.sendPDF = function() { /* ... bez zmien ... */ }
    window.changeDecimalPlaces = function() { /* ... bez zmien ... */ }
    window.updateEmployeeName = function() { /* ... bez zmien ... */ }
    window.updateSettings = function() { /* ... bez zmien ... */ }
    window.changeMonth = function() { /* ... bez zmien ... */ }
    window.changeYear = function() { /* ... bez zmien ... */ }
    function getDaysInMonth(month) { /* ... bez zmien ... */ }
    onAuthStateChanged(auth, (user) => { /* ... bez zmien ... */ });
    window.createBackup = function() { /* ... bez zmien (používa .value) ... */ };
    window.restoreBackup = function() { /* ... bez zmien (používa .value) ... */ };

  </script>

  <script>
    // --- Service Worker --- (bez zmien)
    if ('serviceWorker' in navigator) { /* ... bez zmien ... */ }
  </script>
</body>
</html>
