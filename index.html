<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Základné štýly - bez zmien */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) {
      width: 25%;
    }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8) {
      width: 8.33%;
    }
    input[type="tel"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    .container.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    table.dark-mode {
      background-color: #555;
      color: #f4f4f4;
    }
    th.dark-mode {
      background-color: #666;
    }
    td.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode {
      background-color: #666;
      color: white;
    }
    .btn.dark-mode {
      color: #333;
    }
    .reset-btn.dark-mode {
      background-color: #d32f2f;
    }
    .export-btn.dark-mode {
      background-color: #388e3c;
    }
    .backup-btn.dark-mode {
      background-color: #6a1bb2;
    }
    #totalSalary.dark-mode {
      background-color: #2c3e50;
    }
    .current-day.dark-mode {
      background-color: #4a0e8f;
      color: #fff;
    }
    .current-day.dark-mode input {
      background-color: #5c1db3;
      color: #fff;
    }
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                     0 0 20px rgba(255, 255, 255, 0.3),
                     0 0 30px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 255, 255, 1),
                     0 0 30px rgba(255, 255, 255, 0.9),
                     0 0 40px rgba(255, 255, 255, 0.7);
      }
    }
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1em;
      }
      .settings {
        flex-direction: column;
        align-items: stretch;
      }
      .settings > div {
        flex: 1 1 auto;
        margin: 10px 0;
      }
      table {
        min-width: 800px;
      }
      th, td {
        padding: 6px;
        font-size: 0.8em;
      }
      .btn-container {
        flex-direction: column;
        align-items: stretch;
      }
      .btn {
        flex: 1 1 auto;
        font-size: 14px;
        padding: 8px 16px;
        margin: 5px 0;
      }
      .backup-btn {
        padding: 15px 16px;
      }
      #totalSalary {
        font-size: 16px;
      }
      #dataSizeContainer {
        font-size: 12px;
      }
      .table-container {
        overflow-x: auto;
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.7em;
      }
      .btn {
        font-size: 12px;
        padding: 6px 12px;
      }
      .backup-btn {
        padding: 15px 12px;
      }
      .settings label {
        font-size: 0.9em;
      }
      input[type="tel"], input[type="number"], input[type="text"] {
        font-size: 12px;
      }
      table {
        min-width: 800px;
      }
    }
    #saveNotification, #errorNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show {
      display: block;
      opacity: 1;
    }
    #saveNotification {
      background-color: #4CAF50;
      color: white;
    }
    #errorNotification {
      background-color: #f44336;
      color: white;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 200px;
      margin: 5px auto;
      display: block;
    }
    #login-form .btn {
      width: 120px;
      margin: 5px 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Dynamicky generované roky -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
    </div>
  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.firebasestorage.app",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------------------- GLOBÁLNE PREMENNÉ --------------------
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(hourlyWageInput.value);
    let taxRate = parseFloat(taxRateInput.value) / 100;
    let monthData = {};

    // -------------------- FUNKCIE PRE ROKY (select) --------------------
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }
    populateYearSelect();

    // Nastavenie predvolených hodnôt
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;

    // -------------------- MONITOROVANIE ONLINE/OFFLINE --------------------
    function isOnline() {
      return navigator.onLine;
    }
    window.addEventListener('online', () => {
      console.log('Zariadenie je online');
      showStatusNotification('Online', 'green');
      syncWithFirebase();
    });
    window.addEventListener('offline', () => {
      console.log('Zariadenie je offline');
      showStatusNotification('Offline', 'red');
    });
    function showStatusNotification(message, color) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.backgroundColor = color;
      notification.style.color = 'white';
      notification.style.zIndex = '1000';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    function showErrorNotification(message) {
      const notification = document.getElementById('errorNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') {
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 2000);
    }

    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    window.login = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Prihlásenie je možné iba online.');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        updateUI();
      } catch (error) {
        showErrorNotification('Chyba pri prihlásení: ' + error.message);
      }
    }

    window.register = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Registrácia je možná iba online.');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        await createUserCollection();
        updateUI();
      } catch (error) {
        showErrorNotification('Chyba pri registrácii: ' + error.message);
      }
    }

    window.logout = async function() {
      try {
        await signOut(auth);
        currentUser = null;
        updateUI();
        monthData = {};
        createTable();
      } catch (error) {
        showErrorNotification('Chyba pri odhlásení: ' + error.message);
      }
    }

    async function createUserCollection() {
      if (currentUser) {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          email: currentUser.email,
          createdAt: new Date()
        }, { merge: true });

        const initialDocRef = doc(collection(userRef, 'workDays'), 'initial');
        await setDoc(initialDocRef, { created: true });
      }
    }

    function updateUI() {
      const loginForm = document.getElementById('login-form');
      const userInfo = document.getElementById('user-info');
      const userEmail = document.getElementById('user-email');

      if (currentUser) {
        loginForm.style.display = 'none';
        userInfo.style.display = 'block';
        userEmail.textContent = currentUser.email;
        createTable();
        loadFromFirestore();
      } else {
        loginForm.style.display = 'block';
        userInfo.style.display = 'none';
        createTable();
        if (!isOnline()) {
          showErrorNotification('Ste offline. Prihláste sa, keď budete online.');
        }
      }
    }

    // -------------------- Ukladanie do Firestore a localStorage s debounce --------------------
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 300);

    async function saveToFirestore() {
      if (!currentUser) return;
      try {
        const saveData = {
          data: [],
          hourlyWage: hourlyWage,
          taxRate: taxRate,
          employeeName: employeeName,
          decimalPlaces: decimalPlaces,
          lastUpdated: new Date().toISOString()
        };

        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
          const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
          const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
          const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
          const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

          // Ukladajú sa hodnoty zobrazené v poliach (zaokrúhlené)
          const start = startElement ? startElement.value : '';
          const end = endElement ? endElement.value : '';
          const breakTime = breakElement ? breakElement.value : '';
          const gross = grossElement ? grossElement.value : (0).toFixed(decimalPlaces);
          const net = netElement ? netElement.value : (0).toFixed(decimalPlaces);

          saveData.data.push({ start, end, breakTime, gross, net });
        }

        console.log('Ukladám dáta do localStorage:', saveData);
        localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(saveData));

        if (isOnline()) {
          const userRef = doc(db, 'users', currentUser.uid);
          await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), saveData);
          showSaveNotification();
        } else {
          console.log('Offline: Ukladám dáta do localStorage pre synchronizáciu');
          localStorage.setItem(`pendingSync-${currentYear}-${currentMonth}`, JSON.stringify(saveData));
          showSaveNotification();
        }
      } catch (error) {
        console.error('Chyba pri ukladaní:', error);
        showErrorNotification('Chyba pri ukladaní dát: ' + error.message);
      }
    }

    async function syncWithFirebase() {
      if (!currentUser) return;
      try {
        const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingData = localStorage.getItem(pendingKey);

        if (pendingData) {
          const dataToSync = JSON.parse(pendingData);
          const userRef = doc(db, 'users', currentUser.uid);
          await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), dataToSync);
          console.log('Dáta boli synchronizované s Firestore');
          localStorage.removeItem(pendingKey);
          showSaveNotification();
        }
      } catch (error) {
        console.error('Chyba pri synchronizácii s Firestore:', error);
        showErrorNotification('Chyba pri synchronizácii dát: ' + error.message);
      }
    }

    // -------------------- Načítanie z Firestore a localStorage --------------------
    async function loadFromFirestore() {
      if (!currentUser) {
        console.log('Žiadny prihlásený používateľ, načítavam iba z localStorage');
      }

      try {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        let dataToLoad = null;

        if (localData) {
            console.log('Načítavam údaje z localStorage:', localKey);
            try {
                dataToLoad = JSON.parse(localData);
            } catch (error) {
                console.error('Chyba pri parsovaní localStorage:', error);
                showErrorNotification('Chyba pri načítavaní dát z localStorage');
                localStorage.removeItem(localKey); // Odstrániť poškodené dáta
            }
        } else if (isOnline() && currentUser) {
            console.log('Načítavam údaje z Firestore');
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                dataToLoad = docSnap.data();
                // Uložíme načítané dáta z Firestore aj do localStorage
                localStorage.setItem(localKey, JSON.stringify(dataToLoad));
            } else {
                console.log('Žiadne údaje v Firestore');
            }
        } else {
            console.log('Žiadne údaje v localStorage a offline režim alebo neprihlásený používateľ');
        }

        if (dataToLoad) {
            monthData[currentYear] = monthData[currentYear] || {};
            monthData[currentYear][currentMonth] = dataToLoad.data || []; // Uistiť sa, že data je pole

            hourlyWage = parseFloat(dataToLoad.hourlyWage) || parseFloat(hourlyWageInput.value);
            taxRate = parseFloat(dataToLoad.taxRate) || parseFloat(taxRateInput.value) / 100;
            employeeName = dataToLoad.employeeName || '';
            decimalPlaces = parseInt(dataToLoad.decimalPlaces) || 1;

            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;

            const daysInTable = getDaysInMonth(currentMonth);
            (dataToLoad.data || []).forEach((day, index) => {
                const i = index + 1;
                // Načítavame len pre dni, ktoré existujú v aktuálnej tabuľke
                if (i <= daysInTable) {
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

                    if (startElement && endElement && breakElement) {
                        startElement.value = day.start || '';
                        endElement.value = day.end || '';
                        breakElement.value = day.breakTime || '';
                        // Hodnoty mzdy sa neobnovujú priamo, prepočítajú sa cez calculateRow
                        calculateRow(i);
                    } else {
                        console.warn(`Elementy pre deň ${i} neboli nájdené pri načítavaní`);
                    }
                }
            });
            calculateTotal(); // Prepočíta celkové súčty po načítaní všetkých riadkov
        } else {
             // Ak sa nenačítali žiadne dáta, zabezpečíme, že tabuľka je prázdna a súčty sú 0
             createTable(); // Vytvorí prázdnu tabuľku
             calculateTotal(); // Vypočíta (nulové) súčty
        }

      } catch (error) {
        console.error('Chyba pri načítavaní:', error);
        showErrorNotification('Chyba pri načítavaní dát: ' + error.message);
      }
    }

    // -------------------- Tvorba tabuľky a výpočty --------------------
    function getDayName(year, month, day) {
      const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
      const date = new Date(year, month, day);
      return daysOfWeek[date.getDay()];
    }

    function createTable() {
      console.log('Vytváram tabuľku pre mesiac:', currentMonth, 'rok:', currentYear);
      workDays.innerHTML = '';
      const currentDay = new Date().getDate();
      const currentMonthIndex = new Date().getMonth();
      const currentYearValue = new Date().getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      console.log('Počet dní v mesiaci:', daysInMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDay && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        // Nastavíme východzie hodnoty pre mzdy na 0.00 (alebo 0.0 podľa decimalPlaces)
        const initialSalaryValue = (0).toFixed(decimalPlaces);
        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" value="${initialSalaryValue}" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" value="${initialSalaryValue}" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        workDays.appendChild(row);
      }
      console.log('Tabuľka vytvorená, načítavam údaje...');
      loadFromFirestore(); // Načítanie dát po vytvorení štruktúry tabuľky
    }

    window.handleInput = function(input, nextId) {
      formatAndMoveNext(input, nextId);
      // calculateAndUpdateTotals už je volané v rámci calculateRow -> formatAndMoveNext
    }
    window.handleBreakInput = function(day) {
      calculateRow(day); // Prepočíta aktuálny riadok
      calculateAndUpdateTotals(); // Prepočíta celkové sumy a spustí ukladanie
      // Presun kurzora nie je nutný, používateľ môže chcieť zadať ďalšiu prestávku
      // const nextDay = day + 1;
      // if (nextDay <= getDaysInMonth(currentMonth)) {
      //   moveNext(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`), `start-${currentYear}-${currentMonth}-${nextDay}`);
      // }
    }

    function calculateAndUpdateTotals() {
      calculateTotal(); // Najprv prepočítať celkové súčty s novými presnými hodnotami
      debouncedSaveToFirestore(); // Potom spustiť ukladanie (ktoré ukladá zobrazené hodnoty)
    }

    function formatAndMoveNext(input, nextId) {
      let value = input.value.replace(/[^\d:]/g, '');
      // Automatické doplnenie ":" ak sú zadané 4 číslice
      if (value.length === 4 && !value.includes(':')) {
        value = value.slice(0, 2) + ':' + value.slice(2);
      }
      // Oprava, ak používateľ zadá viac ako 5 znakov alebo neplatný formát
      if (value.length > 5) {
         value = value.slice(0, 5);
      }
      input.value = value;

      // Skontrolujeme formát a platnosť až keď je 5 znakov
      if (value.length === 5) {
          const parts = value.split(':');
          if (parts.length === 2) {
              const hours = parseInt(parts[0], 10);
              const minutes = parseInt(parts[1], 10);
              if (hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
                  // Čas je platný, prepočítame riadok
                  const day = parseInt(input.id.split('-')[3]);
                  calculateRow(day);
                  calculateAndUpdateTotals(); // Prepočítame súčty a uložíme
                  moveNext(input, nextId); // Presunieme kurzor
              } else {
                  showErrorNotification("Neplatný čas. Hodiny 0-23, minúty 0-59.");
                  // Necháme neplatnú hodnotu, aby ju používateľ opravil, alebo ju vymažeme? Radšej necháme.
                  // input.value = '';
              }
          } else {
              // Neplatný formát (napr. 123:4)
              showErrorNotification("Neplatný formát času. Použite HH:MM.");
          }
      } else if (value.length < 5 && value.length > 0) {
         // Ak používateľ upravuje čas a nie je kompletný, prepočítame riadok (výsledok bude 0)
         const day = parseInt(input.id.split('-')[3]);
         calculateRow(day);
         calculateAndUpdateTotals(); // Prepočítame súčty a uložíme
      } else if (value.length === 0) {
         // Ak používateľ vymazal čas
         const day = parseInt(input.id.split('-')[3]);
         calculateRow(day);
         calculateAndUpdateTotals();
      }
    }

    function moveNext(currentElement, nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) {
        // Použijeme setTimeout, aby sa focus presunul až po dokončení aktuálnych eventov
        setTimeout(() => nextElement.focus(), 0);
      }
    }

    // Pomocná funkcia na resetovanie dát a zobrazenia riadku
    function resetRowData(row, day) {
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        // Zabezpečíme, že prvky existujú pred prístupom k nim
        if (totalCell) totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
        if (grossInput) grossInput.value = (0).toFixed(decimalPlaces);
        if (netInput) netInput.value = (0).toFixed(decimalPlaces);

        // Vymažeme aj presné hodnoty z datasetu, ak riadok existuje
        if (row && row.dataset) {
            delete row.dataset.preciseMinutes;
            delete row.dataset.preciseGross;
            delete row.dataset.preciseNet;
        } else if (row === null && totalCell) {
            // Ak sa row nepodarilo získať (čo by nemalo nastať, ak totalCell existuje), skúsime ho získať znova
            const currentRow = totalCell.closest('tr');
            if (currentRow && currentRow.dataset) {
                delete currentRow.dataset.preciseMinutes;
                delete currentRow.dataset.preciseGross;
                delete currentRow.dataset.preciseNet;
            }
        }
    }


    function calculateRow(day) {
        const startTimeInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endTimeInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInputElement = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

        // Ak niektorý z elementov neexistuje, ukončíme funkciu
        if (!startTimeInput || !endTimeInput || !breakInputElement) {
            console.warn(`Chýbajúce elementy pre deň ${day}. Výpočet preskočený.`);
            return;
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const breakTime = parseFloat(breakInputElement.value) || 0; // Prestávka v hodinách

        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        const row = totalCell ? totalCell.closest('tr') : null; // Získame nadradený riadok TR

        // Ak sa nepodarilo nájsť bunku alebo riadok, ukončíme
        if (!totalCell || !grossInput || !netInput || !row) {
             console.warn(`Chýbajúce elementy tabuľky pre deň ${day}. Výpočet preskočený.`);
             // Aj tak skúsime resetovať dáta, ak by boli nekonzistentné
             if(row) resetRowData(row, day);
             return;
        }

        // Overíme, či sú oba časy zadané a majú správnu dĺžku
        if (startTime && endTime && startTime.length === 5 && endTime.length === 5) {
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);

            // Skontrolujeme platnosť hodnôt (robustnejšia kontrola NaN)
            if (isNaN(startHours) || isNaN(startMinutes) || isNaN(endHours) || isNaN(endMinutes) ||
                startHours < 0 || startHours >= 24 || startMinutes < 0 || startMinutes >= 60 ||
                endHours < 0 || endHours >= 24 || endMinutes < 0 || endMinutes >= 60) {
                // Ak sú časy neplatné, resetujeme dáta riadku a ukončíme
                console.warn(`Neplatný čas pre deň ${day}. Resetujem hodnoty.`);
                resetRowData(row, day);
                return;
            }

            const startDate = new Date();
            startDate.setHours(startHours, startMinutes, 0, 0);
            const endDate = new Date();
            endDate.setHours(endHours, endMinutes, 0, 0);

            // Rozdiel v milisekundách
            let diffMs = endDate.getTime() - startDate.getTime(); // Použijeme getTime() pre istotu

            // Ak je čas odchodu menší ako čas príchodu, predpokladáme prácu cez polnoc
            if (diffMs < 0) {
                diffMs += 24 * 60 * 60 * 1000; // Pridáme 24 hodín v milisekundách
            }

            // Rozdiel v minútach
            let totalWorkMinutes = diffMs / 60000;

            // Odpočítanie prestávky (breakTime je v hodinách, prepočítame na minúty)
            const breakMinutes = breakTime * 60;
            let netWorkMinutes = totalWorkMinutes - breakMinutes;

            // Zaistenie, aby čistý čas nebol záporný
            if (netWorkMinutes < 0) netWorkMinutes = 0;

            // Výpočet hodín a minút pre zobrazenie (zaokrúhlené na najbližšiu minútu)
            const displayHours = Math.floor(netWorkMinutes / 60);
            const displayMinutes = Math.round(netWorkMinutes % 60);

            // Správne zobrazenie, ak sa minúty zaokrúhlia na 60
            let finalDisplayHours = displayHours;
            let finalDisplayMinutes = displayMinutes;
            if (finalDisplayMinutes === 60) {
                finalDisplayHours += 1;
                finalDisplayMinutes = 0;
            }

            // Výpočet desatinných hodín pre zobrazenie
            const displayDecimalHours = (netWorkMinutes / 60).toFixed(decimalPlaces);

            // Zobrazenie odpracovaného času
            totalCell.textContent = `${finalDisplayHours}h ${finalDisplayMinutes}m (${displayDecimalHours} h)`;

            // --- PRESNÉ VÝPOČTY ---
            // Používame netWorkMinutes, čo je presný počet odpracovaných minút
            const preciseHours = netWorkMinutes / 60.0; // Použijeme float delenie
            const preciseGrossSalary = preciseHours * hourlyWage;
            const preciseNetSalary = preciseGrossSalary * (1.0 - taxRate);

            // Uloženie presných hodnôt do datasetu pre neskoršie sčítanie
            // Ukladáme ako čísla, parseFloat ich potom načíta správne
            row.dataset.preciseMinutes = netWorkMinutes;
            row.dataset.preciseGross = preciseGrossSalary;
            row.dataset.preciseNet = preciseNetSalary;

            // Zobrazenie zaokrúhlených hodnôt v input poliach
            grossInput.value = isFinite(preciseGrossSalary) ? preciseGrossSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
            netInput.value = isFinite(preciseNetSalary) ? preciseNetSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);

        } else {
            // Ak chýba čas príchodu alebo odchodu, alebo nie sú v správnom formáte, resetujeme hodnoty
            resetRowData(row, day);
        }
    }


    window.resetRow = function(day) {
        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (breakInput) breakInput.value = '';

        // Získame riadok a zavoláme pomocnú funkciu na reset
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const row = totalCell ? totalCell.closest('tr') : null;
        if (row) {
            resetRowData(row, day); // Použijeme funkciu na resetovanie dát a zobrazenia
        } else {
            console.warn(`Nepodarilo sa nájsť riadok pre deň ${day} pri resete.`);
        }

        calculateAndUpdateTotals(); // Prepočítame celkové súčty a spustíme ukladanie
    }

    function calculateTotal() {
        // Použijeme presnejšie hodnoty uložené v datasete
        let totalPreciseMinutes = 0;
        let totalPreciseGrossSalary = 0;
        let totalPreciseNetSalary = 0;
        let daysWithEntries = 0; // Počítame dni s odpracovaným časom > 0 minút

        workDays.querySelectorAll('tr').forEach(row => {
            // Načítame presné hodnoty z datasetu
            // Ak dataset neexistuje alebo je hodnota NaN, použije sa 0
            const preciseMinutes = parseFloat(row.dataset.preciseMinutes) || 0;
            const preciseGross = parseFloat(row.dataset.preciseGross) || 0;
            const preciseNet = parseFloat(row.dataset.preciseNet) || 0;

            // Sčítame hodnoty bez ohľadu na to, či sú > 0, parseFloat sa postará o NaN
            totalPreciseMinutes += preciseMinutes;
            totalPreciseGrossSalary += preciseGross;
            totalPreciseNetSalary += preciseNet;

            // Započítame deň, ak má viac ako 0 odpracovaných minút
            // Pridáme malú toleranciu pre prípadné drobné nepresnosti float výpočtov
            if (preciseMinutes > 0.001) {
                daysWithEntries++;
            }
        });

        // --- VÝPOČET CELKOVÝCH HODÍN A MINÚT Z PRESNÝCH MINÚT ---
        const totalHours = Math.floor(totalPreciseMinutes / 60);
        // Zaokrúhlime zvyšné minúty pre zobrazenie
        const totalMinutesRemainder = Math.round(totalPreciseMinutes % 60);

        // Správne zobrazenie, ak sa minúty zaokrúhlia na 60
        let finalTotalHours = totalHours;
        let finalTotalMinutesRemainder = totalMinutesRemainder;
        if (finalTotalMinutesRemainder === 60) {
            finalTotalHours += 1;
            finalTotalMinutesRemainder = 0;
        }
        // Desatinné hodiny pre zobrazenie
        const totalDecimalHours = (totalPreciseMinutes / 60).toFixed(decimalPlaces);

        // --- VÝPOČET PRIEMEROV Z PRESNÝCH SÚČTOV ---
        let averageNetSalary = 0;
        if (daysWithEntries > 0 && isFinite(totalPreciseNetSalary)) {
            averageNetSalary = (totalPreciseNetSalary / daysWithEntries);
        }

        let averageWorkedMinutes = 0;
        if (daysWithEntries > 0 && isFinite(totalPreciseMinutes)) {
            averageWorkedMinutes = totalPreciseMinutes / daysWithEntries;
        }
        // Vypočítame priemerné hodiny a minúty
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60); // Zaokrúhlime priemerné minúty

        // Správne zobrazenie priemerných hodín/minút pri zaokrúhlení na 60
        let finalAverageHours = averageHours;
        let finalAverageMinutes = averageMinutes;
        if (finalAverageMinutes === 60) {
            finalAverageHours += 1;
            finalAverageMinutes = 0;
        }
        // Desatinné priemerné hodiny
        const averageDecimalHours = (averageWorkedMinutes / 60).toFixed(decimalPlaces);

        // --- ZOBRAZENIE VÝSLEDKOV S POUŽITÍM .toFixed() AŽ NA KONCI ---
        totalSalaryDiv.innerHTML = `
            Počet odpracovaných dní: ${daysWithEntries}<br>
            Celkový odpracovaný čas: ${finalTotalHours}h ${finalTotalMinutesRemainder}m (${totalDecimalHours} h)<br>
            Celková hrubá mzda: ${isFinite(totalPreciseGrossSalary) ? totalPreciseGrossSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces)}€<br>
            Celková čistá mzda: ${isFinite(totalPreciseNetSalary) ? totalPreciseNetSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces)}€<br>
            Priemerná čistá mzda: ${isFinite(averageNetSalary) ? averageNetSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces)}€<br>
            <strong>Priemerný odpracovaný čas: ${finalAverageHours}h ${finalAverageMinutes}m (${averageDecimalHours} h)</strong>
        `;
    }


    // -------------------- EXPORT DO PDF (upravené pre diakritiku v tabuľke) --------------------
    function getMonthName(month) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[month];
    }

    window.exportToPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Načítanie fontu Roboto pre správnu podporu diakritiky
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');

      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - Výkaz práce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);

      doc.setFontSize(14);
      doc.text(`Meno pracovníka: ${employeeName}`, 14, 25);

      const tableData = [];
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
        const dayName = getDayName(currentYear, currentMonth, i);
        const startTimeEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
        const endTimeEl = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
        const breakTimeEl = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
        const totalTimeEl = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`);
        const grossSalaryEl = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
        const netSalaryEl = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

        // Získavame hodnoty len ak elementy existujú
        const startTime = startTimeEl ? startTimeEl.value : '';
        const endTime = endTimeEl ? endTimeEl.value : '';
        const breakTime = breakTimeEl ? breakTimeEl.value : '';
        const totalTime = totalTimeEl ? totalTimeEl.textContent : '';
        const grossSalary = grossSalaryEl ? grossSalaryEl.value : '';
        const netSalary = netSalaryEl ? netSalaryEl.value : '';


        // Pridáme riadok do PDF len ak je zadaný aspoň jeden čas alebo nenulová prestávka
        if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) {
          tableData.push([`Deň ${i} (${dayName})`, startTime, endTime, breakTime, totalTime, grossSalary, netSalary]);
        }
      }

      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']],
        body: tableData,
        startY: 30,
        // Tu je kľúčové nastavenie fontu pre text v tabuľke
        styles: { font: 'Roboto', cellPadding: 2, fontSize: 8 },
        headStyles: { font: 'Roboto', fillColor: [220, 220, 220], textColor: [0, 0, 0], fontSize: 9 },
        columnStyles: {
             0: { cellWidth: 35 }, // Deň
             1: { cellWidth: 18 }, // Príchod
             2: { cellWidth: 18 }, // Odchod
             3: { cellWidth: 20 }, // Prestávka
             4: { cellWidth: 40 }, // Odpracované
             5: { cellWidth: 25 }, // Hrubá
             6: { cellWidth: 25 }  // Čistá
         },
         didParseCell: function (data) {
            // Centrovanie textu v bunkách okrem prvého stĺpca
            if (data.column.index > 0) {
                data.cell.styles.halign = 'center';
            }
         }
      });

      const totalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10); // Menšie písmo pre súhrn
      // Nahradíme <br> za nové riadky v PDF
      const totalText = totalSalaryDiv.innerHTML.replace(/<br\s*[\/]?>/gi, "\n").replace(/<strong>(.*?)<\/strong>/gi, "$1");
      doc.text(totalText, 14, totalY);

      doc.save(`brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`);
    }

    window.sendPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Načítanie fontu Roboto pre podporu diakritiky
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');

      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - Výkaz práce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);

      doc.setFontSize(14);
      doc.text(`Meno pracovníka: ${employeeName}`, 14, 25);

      const tableData = [];
       for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
           const dayName = getDayName(currentYear, currentMonth, i);
           const startTimeEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
           const endTimeEl = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
           const breakTimeEl = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
           const totalTimeEl = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`);
           const grossSalaryEl = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
           const netSalaryEl = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

           const startTime = startTimeEl ? startTimeEl.value : '';
           const endTime = endTimeEl ? endTimeEl.value : '';
           const breakTime = breakTimeEl ? breakTimeEl.value : '';
           const totalTime = totalTimeEl ? totalTimeEl.textContent : '';
           const grossSalary = grossSalaryEl ? grossSalaryEl.value : '';
           const netSalary = netSalaryEl ? netSalaryEl.value : '';

           if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) {
             tableData.push([`Deň ${i} (${dayName})`, startTime, endTime, breakTime, totalTime, grossSalary, netSalary]);
           }
       }


      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']],
        body: tableData,
        startY: 30,
        // Nastavenie fontu aj pre tabuľku
        styles: { font: 'Roboto', cellPadding: 2, fontSize: 8 },
        headStyles: { font: 'Roboto', fillColor: [220, 220, 220], textColor: [0, 0, 0], fontSize: 9 },
         columnStyles: {
             0: { cellWidth: 35 },
             1: { cellWidth: 18 },
             2: { cellWidth: 18 },
             3: { cellWidth: 20 },
             4: { cellWidth: 40 },
             5: { cellWidth: 25 },
             6: { cellWidth: 25 }
         },
         didParseCell: function (data) {
            if (data.column.index > 0) {
                data.cell.styles.halign = 'center';
            }
         }
      });

      const totalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      const totalText = totalSalaryDiv.innerHTML.replace(/<br\s*[\/]?>/gi, "\n").replace(/<strong>(.*?)<\/strong>/gi, "$1");
      doc.text(totalText, 14, totalY);

      const pdfBlob = doc.output('blob');
      const pdfFile = new File(
        [pdfBlob],
        `brunos-calculator-report-${getMonthName(currentMonth)}-${currentYear}.pdf`,
        { type: 'application/pdf' }
      );

      if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
        navigator.share({
          files: [pdfFile],
          title: `Bruno's Calculator Report`,
          text: `Pozrite si výkaz práce za ${getMonthName(currentMonth)} ${currentYear}`
        })
        .then(() => console.log('PDF bolo úspešne odoslané'))
        .catch(error => {
          // Ignorovať AbortError, ktorý sa často vyskytuje, ak používateľ zruší zdieľanie
          if (error.name !== 'AbortError') {
              console.error('Chyba pri odosielaní PDF:', error);
              alert('Chyba pri odosielaní PDF: ' + error.message);
          } else {
              console.log('Zdieľanie PDF bolo zrušené používateľom.');
          }
        });
      } else {
        alert('Funkcia zdieľania súborov nie je podporovaná vo vašom prehliadači alebo bolo zdieľanie blokované.');
      }
    }

    // -------------------- OSTATNÉ NASTAVENIA --------------------
    window.changeDecimalPlaces = function() {
      const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
      if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 0 && newDecimalPlaces <= 2) { // Obmedzenie na 0-2 miesta
          decimalPlaces = newDecimalPlaces;
          localStorage.setItem('decimalPlaces', decimalPlaces); // Ukladáme ako číslo
          // Prepočítať a zobraziť všetky riadky a celkové súčty
          for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
            calculateRow(i);
          }
          calculateAndUpdateTotals(); // Aktualizuje súčty a spustí uloženie
      } else {
          showErrorNotification("Neplatný počet desatinných miest.");
          // Vrátim select na pôvodnú hodnotu
          decimalPlacesSelect.value = decimalPlaces;
      }
    }


    window.updateEmployeeName = function() {
      employeeName = employeeNameInput.value.trim();
      localStorage.setItem('employeeName', employeeName); // Ukladáme priamo string
      debouncedSaveToFirestore(); // Uloží zmenu mena (ostatné dáta sa tiež uložia)
    }

    window.updateSettings = function() {
        const newHourlyWage = parseFloat(hourlyWageInput.value);
        const newTaxRatePercent = parseFloat(taxRateInput.value);

        // Validácia vstupov
        if (isNaN(newHourlyWage) || newHourlyWage < 0) {
            showErrorNotification("Neplatná hodinová mzda.");
            hourlyWageInput.value = hourlyWage; // Vrátiť pôvodnú hodnotu
            return;
        }
         if (isNaN(newTaxRatePercent) || newTaxRatePercent < 0 || newTaxRatePercent > 100) {
            showErrorNotification("Neplatné daňové percento (0-100).");
            taxRateInput.value = (taxRate * 100).toFixed(1); // Vrátiť pôvodnú hodnotu
            return;
        }

        hourlyWage = newHourlyWage;
        taxRate = newTaxRatePercent / 100.0;

        // Prepočítať všetky riadky s novými nastaveniami
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
            calculateRow(i);
        }
        calculateAndUpdateTotals(); // Prepočíta súčty a spustí ukladanie
    }


    window.changeMonth = function() {
      currentMonth = parseInt(monthSelect.value);
      createTable(); // Vytvorí novú tabuľku a načíta dáta pre nový mesiac
    }

    window.changeYear = function() {
      currentYear = parseInt(yearSelect.value);
      createTable(); // Vytvorí novú tabuľku a načíta dáta pre nový rok
    }

    function getDaysInMonth(month) {
        // Vytvorí dátum pre nultý deň nasledujúceho mesiaca,
        // čo je posledný deň aktuálneho mesiaca.
        // Mesiac je 0-based index, preto month + 1
        return new Date(currentYear, month + 1, 0).getDate();
    }


    // -------------------- INIT --------------------
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateUI(); // updateUI zavolá createTable a loadFromFirestore
    });

    // Počiatočné vytvorenie tabuľky a výpočet sa deje v updateUI po overení stavu autentifikácie
    // createTable(); // Už netreba volať tu
    // calculateTotal(); // Už netreba volať tu

    // -------------------- FUNKCIE PRE ZÁLOHU A OBNOVU DO EXCELU --------------------
    window.createBackup = function() {
      const key = `workData-${currentYear}-${currentMonth}`;
      const dataString = localStorage.getItem(key);
      if (dataString) {
        try {
            const dataObj = JSON.parse(dataString);
            // Vytvoríme pole riadkov pre Excel, začneme hlavičkou
            const ws_data = [
              ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"]
            ];
            // Pridáme dáta z tabuľky (zobrazené hodnoty)
            const daysInMonth = getDaysInMonth(currentMonth);
             for (let i = 1; i <= daysInMonth; i++) {
                 const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
                 const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
                 const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
                 const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '';
                 const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '';
                 // Pridávame riadok pre každý deň v mesiaci
                 ws_data.push([`Deň ${i}`, start, end, breakTime, gross, net]);
            }

            // Pridáme informácie o nastaveniach do ďalších riadkov (z aktuálnych hodnôt)
            ws_data.push([]); // Prázdny riadok ako oddeľovač
            ws_data.push(["Nastavenia:"]);
            ws_data.push(["Hodinová mzda", hourlyWage]);
            ws_data.push(["Daňové percento (%)", taxRate * 100]);
            ws_data.push(["Meno pracovníka", employeeName]);
            ws_data.push(["Počet desatinných miest", decimalPlaces]);
            ws_data.push(["Mesiac zálohy (0-11)", currentMonth]);
            ws_data.push(["Rok zálohy", currentYear]);
            ws_data.push(["Posledná aktualizácia (z localStorage)", dataObj.lastUpdated || "N/A"]);

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Nastavenie šírky stĺpcov pre lepšiu čitateľnosť
             ws['!cols'] = [
                { wch: 10 }, // Deň
                { wch: 10 }, // Príchod
                { wch: 10 }, // Odchod
                { wch: 15 }, // Prestávka (h)
                { wch: 15 }, // Hrubá Mzda (€)
                { wch: 15 }  // Čistá Mzda (€)
            ];


            XLSX.utils.book_append_sheet(wb, ws, `Záloha ${getMonthName(currentMonth)} ${currentYear}`);
            XLSX.writeFile(wb, `brunos-calculator-backup-${getMonthName(currentMonth)}-${currentYear}.xlsx`);
            showSaveNotification('Záloha bola úspešne vytvorená.');
        } catch (error) {
             console.error("Chyba pri vytváraní zálohy:", error);
             showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message);
        }
      } else {
        showErrorNotification('Nie sú dostupné žiadne lokálne dáta na zálohu pre tento mesiac.');
      }
    };

    window.restoreBackup = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return; // Ak používateľ zruší výber súboru

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0]; // Predpokladáme prvý list
            const ws = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" }); // Načítať ako pole polí, prázdne bunky ako ""

            // Skontrolujeme hlavičku
            const expectedHeader = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"];
            const actualHeader = rows[0].map(h => String(h).trim()); // Orezanie medzier pre istotu

            if (JSON.stringify(actualHeader) !== JSON.stringify(expectedHeader)) {
                 // Skúsime alternatívnu staršiu hlavičku bez "(h)" a "(€)" pre kompatibilitu
                 const altExpectedHeader = ["Deň", "Príchod", "Odchod", "Prestávka", "Hrubá Mzda", "Čistá Mzda"];
                 if (JSON.stringify(actualHeader.slice(0, altExpectedHeader.length)) !== JSON.stringify(altExpectedHeader)) {
                    throw new Error(`Nesprávny formát hlavičky súboru. Očakávaná hlavička: ${expectedHeader.join(', ')}`);
                 }
            }


            let dataArray = [];
            let settings = {};
            let backupMonth = -1;
            let backupYear = -1;
            let readingData = true;

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].map(cell => (cell === null || cell === undefined) ? "" : String(cell).trim()); // Prevod na string a orezanie

                if (readingData) {
                    // Ak riadok vyzerá ako dátový riadok (prvý stĺpec začína "Deň")
                    if (row[0] && row[0].startsWith("Deň")) {
                         // Hodnoty mzdy nepotrebujeme priamo z backupu, prepočítajú sa
                         dataArray.push({
                            start: row[1] || "",
                            end: row[2] || "",
                            breakTime: row[3] || "" // Ukladáme hodnotu prestávky
                            // gross a net sa prepočítajú
                         });
                    } else {
                        // Ak narazíme na riadok, ktorý nie je dátový, prepneme na čítanie nastavení
                        readingData = false;
                        // Spracujeme aktuálny riadok ako potenciálne nastavenie
                        i--; // Vrátime sa o krok späť, aby sme spracovali tento riadok v ďalšej iterácii
                    }
                } else {
                    // Čítanie nastavení (riadky za dátovými riadkami)
                    const key = row[0] ? String(row[0]).trim() : "";
                    const value = row[1] ? String(row[1]).trim() : "";

                    if (key === "Hodinová mzda") {
                        const parsedWage = parseFloat(value);
                        if (!isNaN(parsedWage) && parsedWage >= 0) settings.hourlyWage = parsedWage;
                    } else if (key === "Daňové percento (%)") {
                        const parsedTax = parseFloat(value);
                        if (!isNaN(parsedTax) && parsedTax >= 0 && parsedTax <= 100) settings.taxRate = parsedTax / 100.0;
                    } else if (key === "Meno pracovníka") {
                        settings.employeeName = value;
                    } else if (key === "Počet desatinných miest") {
                         const parsedDecimal = parseInt(value);
                         if (!isNaN(parsedDecimal) && parsedDecimal >= 0 && parsedDecimal <= 2) settings.decimalPlaces = parsedDecimal;
                    } else if (key === "Mesiac zálohy (0-11)") {
                         const parsedMonth = parseInt(value);
                         if (!isNaN(parsedMonth) && parsedMonth >= 0 && parsedMonth <= 11) backupMonth = parsedMonth;
                    } else if (key === "Rok zálohy") {
                         const parsedYear = parseInt(value);
                         if (!isNaN(parsedYear) && parsedYear >= 2000 && parsedYear <= 2050) backupYear = parsedYear; // Rozumný rozsah rokov
                    }
                }
            }

            // Overíme, či mesiac a rok zo zálohy zodpovedajú aktuálnemu nastaveniu
            if (backupMonth !== -1 && backupYear !== -1) {
                if (backupMonth !== currentMonth || backupYear !== currentYear) {
                    const confirmChange = confirm(`Záloha je pre ${getMonthName(backupMonth)} ${backupYear}. Chcete prepnúť na tento mesiac/rok a obnoviť dáta?`);
                    if (confirmChange) {
                        currentMonth = backupMonth;
                        currentYear = backupYear;
                        monthSelect.value = currentMonth;
                        yearSelect.value = currentYear;
                        // createTable() sa zavolá nižšie
                    } else {
                        showErrorNotification("Obnova bola zrušená. Záloha nebola pre aktuálne zvolený mesiac/rok.");
                        return; // Ukončíme obnovu
                    }
                }
            } else {
                 console.warn("Mesiac a rok neboli nájdené v záložnom súbore. Dáta sa obnovia pre aktuálne zvolený mesiac/rok.");
            }


            // Aplikujeme nastavenia zo zálohy, ak boli nájdené
            if (settings.hourlyWage !== undefined) hourlyWageInput.value = settings.hourlyWage;
            if (settings.taxRate !== undefined) taxRateInput.value = (settings.taxRate * 100).toFixed(1);
            if (settings.employeeName !== undefined) employeeNameInput.value = settings.employeeName;
            if (settings.decimalPlaces !== undefined) decimalPlacesSelect.value = settings.decimalPlaces;

            // Aktualizujeme globálne premenné z inputov (ktoré mohli byť zmenené)
            updateGlobalsFromInputs();

            // Vytvoríme dáta pre uloženie do localStorage (simulujeme formát saveToFirestore)
            const backupSaveData = {
              data: dataArray.map(d => ({ // Mapujeme len potrebné polia pre načítanie
                  start: d.start,
                  end: d.end,
                  breakTime: d.breakTime,
                  gross: (0).toFixed(decimalPlaces), // Placeholder, prepočíta sa
                  net: (0).toFixed(decimalPlaces)    // Placeholder, prepočíta sa
              })),
              hourlyWage: hourlyWage,
              taxRate: taxRate,
              employeeName: employeeName,
              decimalPlaces: decimalPlaces,
              lastUpdated: new Date().toISOString() // Dátum obnovy
            };

            // Uložíme pripravené dáta do localStorage pre daný (možno zmenený) mesiac/rok
            localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(backupSaveData));

            // Prekreslíme tabuľku a načítame dáta z localStorage (už s obnovenými hodnotami)
            createTable(); // createTable zavolá loadFromFirestore, ktoré načíta práve uložené dáta
            showSaveNotification('Záloha bola úspešne obnovená.');

          } catch (error) {
            console.error('Chyba pri načítavaní zálohy:', error);
            showErrorNotification('Chyba pri načítavaní zálohy: ' + error.message);
          }
        };
        reader.onerror = function(e) {
             console.error("Chyba pri čítaní súboru:", e);
             showErrorNotification("Chyba pri čítaní súboru.");
        };
        reader.readAsArrayBuffer(file);
      };
      input.click(); // Otvorí dialóg na výber súboru
    };

    // Pomocná funkcia na aktualizáciu globálnych premenných z hodnôt inputov
    function updateGlobalsFromInputs() {
        hourlyWage = parseFloat(hourlyWageInput.value) || 0;
        taxRate = (parseFloat(taxRateInput.value) || 0) / 100.0;
        employeeName = employeeNameInput.value.trim();
        decimalPlaces = parseInt(decimalPlacesSelect.value) || 1;
    }


    // Prepínač tmavého režimu - bez zmien funkčnosti
    function applyDarkMode(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
        document.querySelector('.container').classList.toggle('dark-mode', isDark);
        document.querySelector('table').classList.toggle('dark-mode', isDark);
        document.querySelectorAll('th').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.querySelectorAll('td').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"]').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.querySelectorAll('.btn').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.getElementById('totalSalary').classList.toggle('dark-mode', isDark);
        document.querySelectorAll('.current-day').forEach(el => el.classList.toggle('dark-mode', isDark));
        localStorage.setItem('darkMode', isDark);
    }

    window.toggleDarkMode = function() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        applyDarkMode(!isDarkMode);
    }

    // Aplikovať tmavý režim pri načítaní stránky
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    applyDarkMode(savedDarkMode);


  </script>

  <!-- Registrácia Service Workera -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
    }
  </script>
</body>
</html>
