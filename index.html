<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELAT√çVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Kni≈ænice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Z√°kladn√© ≈°t√Ωly */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
      margin: 2px 5px;
    }
    .settings > div {
      flex: 1 1 200px;
    }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%;
      margin-bottom: 10px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px 12px;
      cursor: pointer; /* Pridan√© pre lep≈°iu UX */
    }
    body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
    }
    .settings > button.highlight {
       flex: 1 1 150px;
     }
    .settings label {
      display: block;
      margin-bottom: 2px;
    }
    #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
    }
    #settings-collapsible-content.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 5px;
    }
    #settings-collapsible-content > div {
         flex: 1 1 200px;
         margin: 2px 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px; /* Ponechan√© pre horizont√°lne scrollovanie */
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle; /* Zarovnanie na stred */
    }
    th {
      background-color: #f2f2f2;
    }
    /* Odstr√°nen√© ≈°pecifick√© ≈°√≠rky stƒ∫pcov, rie≈°i sa v exportoch */

    input[type="tel"], input[type="number"], input[type="text"], select {
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }
    input[type="number"], input[type="text"], select {
        /* Tieto typy m√¥≈æu zabra≈• cel√∫ ≈°√≠rku bunky, ak nie s√∫ vo wrapperi */
        width: 100%;
    }
    /* input[type="tel"] ≈°√≠rka sa riadi cez flexbox vo wrapperi */

    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; padding: 15px 20px; }
    .backup-btn:hover { background-color: #6a1bb2; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }

    /* Tmav√Ω re≈æim */
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    body.dark-mode .container { background-color: #444; color: #f4f4f4; }
    body.dark-mode h1 { color: #f4f4f4; }
    body.dark-mode table { background-color: #555; color: #f4f4f4; }
    body.dark-mode th { background-color: #666; }
    body.dark-mode td { background-color: #444; color: #f4f4f4; border-color: #555; /* Zmena okraja v tmavom re≈æime */ }
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode select { background-color: #666; color: white; border-color: #555; }
    body.dark-mode .btn { color: #f4f4f4; }
    body.dark-mode .reset-btn { background-color: #d32f2f; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f; color: #fff; }
    body.dark-mode .current-day input { background-color: #5c1db3; color: #fff; border-color: #4a0e8f; }
    body.dark-mode .settings > button#toggleSettingsBtn { background-color: #555; color: #f4f4f4; border-color: #666; }

    /* Responzivita */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight { width: 100%; margin: 5px 0; flex-basis: auto; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 600px; /* Zmen≈°en√© pre lep≈°iu prehƒæadnos≈• */ }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; }
      .backup-btn { padding: 15px 16px; }
      #totalSalary { font-size: 16px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 12px; }
      table { min-width: 500px; /* E≈°te zmen≈°en√© */ }
      #settings-collapsible-content.visible { max-height: 700px; }
    }

    /* Notifik√°cie a Login forma */
    #saveNotification, #errorNotification { display: none; position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; font-size: 14px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
    #saveNotification.show, #errorNotification.show { display: block; opacity: 1; }
    #saveNotification { background-color: #4CAF50; color: white; }
    #errorNotification { background-color: #f44336; color: white; }
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] { width: 200px; margin: 5px auto; display: block; }
    #login-form .btn { width: 120px; margin: 5px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.9em; color: #007bff; text-decoration: none; }
    #login-form a:hover { text-decoration: underline; }
    body.dark-mode #login-form a { color: #6bbaff; }

    /* ≈†t√Ωly pre wrapper a ikonu hod√≠n */
    .time-input-wrapper {
        display: flex;
        align-items: center; /* Vertik√°lne zarovnanie */
        gap: 5px; /* Medzera medzi inputom a ikonou */
        /* Uist√≠me sa, ≈æe wrapper nepreteƒçie z bunky */
        max-width: 100%;
        box-sizing: border-box;
    }
    .time-input-wrapper input[type="tel"] {
        flex-grow: 1; /* Input zaberie dostupn√Ω priestor */
        min-width: 50px; /* Minim√°lna ≈°√≠rka */
        /* Odstr√°nime explicitn√∫ ≈°√≠rku, flex-grow sa postar√° */
        /* width: auto; */
    }
    .clock-icon {
        flex-shrink: 0; /* Ikona sa nebude zmen≈°ova≈• */
        cursor: pointer;
        font-size: 1.3em; /* Veƒækos≈• ikony */
        user-select: none; /* Zabr√°ni oznaƒçeniu textu ikony */
        transition: transform 0.2s ease; /* Anim√°cia pri kliknut√≠ */
        padding: 2px; /* Klikateƒæn√Ω priestor */
        line-height: 1; /* Pre lep≈°ie vertik√°lne zarovnanie emoji */
    }
    .clock-icon:hover { opacity: 0.8; }
    .clock-icon:active { transform: scale(0.9); }
    body.dark-mode .clock-icon { /* filter: brightness(1.2); */ } /* Mo≈æn√° √∫prava v tmavom re≈æime */

  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikaƒçn√© UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobrazi≈• nastavenia ‚ñº</button>
      <div id="settings-collapsible-content">
          <div>
            <label for="employeeNameInput">Meno pracovn√≠ka: </label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="taxRateInput">Da≈àov√© percento (%): </label>
            <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
              <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
              <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
              <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
              <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok: </label>
            <select id="yearSelect" onchange="changeYear()"></select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
      </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky bud√∫ generovan√© cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <!-- Hlavn√Ω JavaScript k√≥d + Firebase -->
  <script type="module">
    // Re≈æim
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
    window.toggleDarkMode = () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js'; // Odstr√°nen√Ω deleteDoc - nepou≈æ√≠va sa
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // Firebase Konfigur√°cia
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Verejn√Ω kƒæ√∫ƒç - zv√°≈æi≈• bezpeƒçnej≈°√≠ sp√¥sob
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Firebase Inicializ√°cia
    const app = initializeApp(firebaseConfig);
    try {
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Verejn√Ω kƒæ√∫ƒç ReCaptcha
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("Firebase App Check failed to initialize. Possibly due to ad blocker or unsupported environment.", e);
        // Aplik√°cia bude fungova≈• aj bez App Check, ale s ni≈æ≈°ou ochranou
    }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Glob√°lne Premenn√© a Elementy
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1; // Predvolen√© na 1
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = 10; // Naƒç√≠taj√∫ sa z localStorage/UI ni≈æ≈°ie
    let taxRate = 0.02; // Naƒç√≠taj√∫ sa z localStorage/UI ni≈æ≈°ie

    // Funkcia na aktualiz√°ciu pozdravu
    function updateGreeting() {
        const nameToUse = employeeName || localStorage.getItem('employeeName') || '';
        if (nameToUse) {
            const firstName = nameToUse.split(' ')[0];
            mainTitle.textContent = `Ahoj ${firstName}`;
        } else {
            mainTitle.textContent = 'Ahoj';
        }
    }

    // Popul√°cia a nastavenie rokov
    function populateYearSelect() {
        const startYear = 2020;
        const endYear = 2030;
        yearSelect.innerHTML = '';
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year; option.textContent = year;
            yearSelect.appendChild(option);
        }
        yearSelect.value = currentYear;
    }
    populateYearSelect();

    // Inicializ√°cia hodn√¥t z localStorage alebo UI
    hourlyWage = parseFloat(localStorage.getItem('hourlyWage') || hourlyWageInput.value) || 10;
    taxRate = (parseFloat(localStorage.getItem('taxRatePercent') || taxRateInput.value) || 2) / 100;
    decimalPlaces = parseInt(localStorage.getItem('decimalPlaces') || decimalPlacesSelect.value) || 1;
    employeeName = localStorage.getItem('employeeName') || employeeNameInput.value || '';

    // Nastavenie UI prvkov
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1);

    updateGreeting(); // Prvotn√© nastavenie pozdravu

    // Listener pre skrytie/zobrazenie nastaven√≠
    if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
            const isVisible = settingsCollapsibleContent.classList.toggle('visible');
            toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
        });
    }

    // Online/Offline monitoring a Notifik√°cie
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { showStatusNotification('Offline', 'red'); });

    function showStatusNotification(message, color) {
        const notification = document.createElement('div');
        // ... (≈°t√Ωlovanie ako predt√Ωm) ...
        notification.textContent = message;
        notification.style.cssText = `position:fixed; top:20px; right:20px; padding:10px 20px; border-radius:5px; background-color:${color}; color:white; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.2);`;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
    function showErrorNotification(message) {
        const notification = document.getElementById('errorNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 4000);
    }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') {
        const notification = document.getElementById('saveNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // Autentifik√°cia (Logika zost√°va rovnak√°)
    window.login = async () => {
        if (!isOnline()) return showErrorNotification('Ste offline. Prihl√°senie je mo≈æn√© iba online.');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) return showErrorNotification('Pros√≠m, zadajte email aj heslo.');
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) { showErrorNotification(`Chyba pri prihl√°sen√≠: ${mapFirebaseAuthError(error.code)}`); }
    };
    window.register = async () => {
        if (!isOnline()) return showErrorNotification('Ste offline. Registr√°cia je mo≈æn√° iba online.');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) return showErrorNotification('Pros√≠m, zadajte email aj heslo.');
        if (password.length < 6) return showErrorNotification('Heslo mus√≠ ma≈• aspo≈à 6 znakov.');
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            await createUserCollection(); // Vytvor√≠ user dokument
        } catch (error) { showErrorNotification(`Chyba pri registr√°cii: ${mapFirebaseAuthError(error.code)}`); }
    };
    window.logout = async () => {
        try { await signOut(auth); monthData = {}; } // Vyma≈æe d√°ta z pam√§te
        catch (error) { showErrorNotification(`Chyba pri odhl√°sen√≠: ${error.message}`); }
    };
    window.resetPassword = async () => {
        if (!isOnline()) return showErrorNotification('Ste offline. Obnova hesla je mo≈æn√° iba online.');
        const emailInput = document.getElementById('email');
        const email = emailInput.value;
        if (!email) { /* ... k√≥d pre zv√Ωraznenie poƒæa ... */ return showErrorNotification('Zadajte email pre obnovu hesla.'); }
        emailInput.style.border = '1px solid #ccc';
        try {
            await sendPasswordResetEmail(auth, email);
            showSaveNotification(`Email na obnovu hesla odoslan√Ω na ${email}. Skontrolujte po≈°tu (aj spam).`);
        } catch (error) { showErrorNotification(`Chyba pri obnove hesla: ${mapFirebaseAuthError(error.code)}`); }
    };
    function mapFirebaseAuthError(code) { /* ... (preklady ch√Ωb) ... */ return code; } // Skr√°ten√© pre prehƒæad
    async function createUserCollection() {
        if (!auth.currentUser) return;
        const userRef = doc(db, 'users', auth.currentUser.uid);
        try {
            await setDoc(userRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true });
            const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup'); // Vytvor√≠ subkolekciu
            await setDoc(initialDocRef, { setupComplete: true });
        } catch (error) { console.error('Error creating user collection:', error); }
    }

    // UI Update a Naƒç√≠tanie d√°t
    function updateUI() {
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');

        createTable(); // V≈ædy vytvor√≠me ≈°trukt√∫ru tabuƒæky

        if (currentUser) {
            loginForm.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;
            loadInitialData(); // Naƒç√≠tame d√°ta pre prihl√°sen√©ho u≈æ√≠vateƒæa
        } else {
            loginForm.style.display = 'flex';
            userInfo.style.display = 'none';
            loadFromLocalStorageOnly(); // Naƒç√≠tame len z localStorage
            if (!isOnline()) showErrorNotification('Ste offline. Prihl√°ste sa pre pr√≠stup k cloud d√°tam.');
        }
    }

    async function loadInitialData() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingSyncData = localStorage.getItem(pendingSyncKey);

        if (pendingSyncData && isOnline() && currentUser) {
            await syncWithFirebase();
            const updatedLocalData = localStorage.getItem(localKey);
            if (updatedLocalData) parseAndApplyData(updatedLocalData);
            else await loadFromFirestoreAndApply();
        } else if (localData) {
            parseAndApplyData(localData);
            // Voliteƒæne skontrolova≈• cloud pre nov≈°ie d√°ta
        } else if (isOnline() && currentUser) {
           await loadFromFirestoreAndApply();
        } else {
            calculateTotal(); // Zobraz√≠ nulov√© s√∫ƒçty
        }
    }

    async function loadFromFirestoreAndApply() {
        if (!currentUser) return;
        console.log('Naƒç√≠tavanie z Firestore...');
        try {
            const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const storedData = docSnap.data();
                const dataString = JSON.stringify(storedData);
                localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString);
                parseAndApplyData(dataString);
            } else {
                calculateTotal(); // Ak v cloude niƒç nie je
            }
        } catch (error) {
            showErrorNotification(`Chyba pri naƒç√≠tavan√≠ z Firebase: ${error.message}`);
            calculateTotal(); // Zobraz√≠ pr√°zdnu tabuƒæku pri chybe
        }
    }

    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        if (localData) parseAndApplyData(localData);
        else calculateTotal();
    }

    function parseAndApplyData(dataString) {
        try {
            const storedData = JSON.parse(dataString);

            // Aktualiz√°cia nastaven√≠ z ulo≈æen√Ωch d√°t
            hourlyWage = storedData.hourlyWage ?? hourlyWage;
            taxRate = storedData.taxRate ?? taxRate;
            employeeName = storedData.employeeName ?? employeeName;
            decimalPlaces = storedData.decimalPlaces ?? decimalPlaces;

            // Aktualiz√°cia UI prvkov nastaven√≠
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;

            updateGreeting(); // Aktualiz√°cia nadpisu

            // Ulo≈æenie aktu√°lnych nastaven√≠ do LS
            localStorage.setItem('hourlyWage', hourlyWage);
            localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1));
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces);

            // Aplik√°cia d√°t do tabuƒæky
            if (storedData.data && Array.isArray(storedData.data)) {
                const daysInMonth = getDaysInMonth(currentMonth);
                const daysToProcess = Math.min(daysInMonth, storedData.data.length);

                for (let index = 0; index < daysToProcess; index++) {
                    const day = storedData.data[index];
                    const i = index + 1;
                    const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

                    if (startEl && endEl && breakEl) {
                        startEl.value = day.start || '';
                        endEl.value = day.end || '';
                        breakEl.value = day.breakTime || '';
                        calculateRow(i); // Prepoƒç√≠ta zobrazen√© hodnoty
                    }
                }
                 // Vyƒçistenie nadbytoƒçn√Ωch riadkov
                 for (let i = daysToProcess + 1; i <= daysInMonth; i++) {
                     if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false);
                 }
            } else {
                 // Vyƒçistenie celej tabuƒæky, ak d√°ta ch√Ωbaj√∫
                const daysInMonth = getDaysInMonth(currentMonth);
                 for (let i = 1; i <= daysInMonth; i++) if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false);
            }
            calculateTotal(); // Prepoƒçet celkov√Ωch s√∫ƒçtov
        } catch (error) {
            showErrorNotification(`Chyba pri spracovan√≠ d√°t: ${error.message}`);
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false);
            calculateTotal();
        }
    }

    // Ukladanie d√°t
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000); // 1 sekunda

    function collectCurrentData() {
        const saveData = { data: [], hourlyWage, taxRate, employeeName, decimalPlaces, lastUpdated: new Date().toISOString() };
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            saveData.data.push({ start, end, breakTime, gross, net });
        }
        return saveData;
    }

    async function saveToFirestore() {
        if (!currentUser) return; // Len pre prihl√°sen√Ωch
        const saveData = collectCurrentData();
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;

        if (isOnline()) {
            try {
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, saveData, { merge: true }); // Merge zachov√° ostatn√© mesiace
                localStorage.removeItem(pendingSyncKey); // Odstr√°ni pr√≠znak ƒçakaj√∫cej synchroniz√°cie
                showSaveNotification('D√°ta synchronizovan√© s Firebase.');
            } catch (error) {
                showErrorNotification(`Chyba pri ukladan√≠ do cloudu: ${error.message}`);
                localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); // Oznaƒç√≠ aktu√°lne d√°ta ako ƒçakaj√∫ce
            }
        } else {
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); // Oznaƒç√≠ aktu√°lne d√°ta ako ƒçakaj√∫ce
            showSaveNotification('Ste offline, d√°ta ulo≈æen√© lok√°lne.');
        }
    }

    async function syncWithFirebase() {
        if (!currentUser || !isOnline()) return;
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingDataString = localStorage.getItem(pendingSyncKey);

        if (pendingDataString) {
            console.log('Synchronizujem ƒçakaj√∫ce d√°ta...');
            try {
                const dataToSync = JSON.parse(pendingDataString);
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, dataToSync, { merge: true }); // Prep√≠≈°e cloud ƒçakaj√∫cimi d√°tami
                localStorage.setItem(`workData-${currentYear}-${currentMonth}`, pendingDataString); // Ulo≈æ√≠ aj do hlavn√©ho LS kƒæ√∫ƒça
                localStorage.removeItem(pendingSyncKey);
                showSaveNotification('Offline d√°ta synchronizovan√©.');
                parseAndApplyData(pendingDataString); // Znovu aplikuje d√°ta pre istotu
            } catch (error) {
                showErrorNotification(`Chyba pri synchroniz√°cii: ${error.message}`);
            }
        }
    }

    // Naƒç√≠tanie z Firebase tlaƒçidlom
    window.loadFromFirestore = async () => {
        if (!currentUser) return showErrorNotification('Pre naƒç√≠tanie z Firebase sa mus√≠te prihl√°si≈•.');
        if (!isOnline()) return showErrorNotification('Ste offline. Potrebujete internetov√© pripojenie.');
        if (!confirm('Prep√≠sa≈• lok√°lne d√°ta d√°tami z Firebase?')) return;

        try {
            const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const storedData = docSnap.data();
                const dataString = JSON.stringify(storedData);
                localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString);
                localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); // Odstr√°ni ƒçakaj√∫ce d√°ta
                parseAndApplyData(dataString);
                showSaveNotification('D√°ta naƒç√≠tan√© z Firebase.');
            } else {
                showErrorNotification('Vo Firebase pre tento mesiac neboli n√°jden√© d√°ta.');
                // Lok√°lne d√°ta sa nemazaj√∫
            }
        } catch (error) { showErrorNotification(`Chyba pri naƒç√≠tavan√≠ z Firebase: ${error.message}`); }
    };

    // Vytvorenie tabuƒæky a v√Ωpoƒçty
    function getDayName(year, month, day) {
        return new Date(year, month, day).toLocaleDateString('sk-SK', { weekday: 'short' });
    }

    // Vlo≈æenie aktu√°lneho ƒçasu
    window.insertCurrentTime = (inputId) => {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            inputElement.value = `${hours}:${minutes}`;
            handleInput(inputElement, ''); // Spust√≠ valid√°ciu, v√Ωpoƒçet a ukladanie
        }
    };

    // Vytvorenie riadkov tabuƒæky
    function createTable() {
        const daysInMonth = getDaysInMonth(currentMonth);
        workDays.innerHTML = ''; // Vyƒçistenie
        const today = new Date();
        const todayDate = today.getDate();
        const todayMonth = today.getMonth();
        const todayYear = today.getFullYear();

        if (isNaN(daysInMonth) || daysInMonth <= 0) return console.error("Neplatn√Ω poƒçet dn√≠:", daysInMonth);

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === todayDate && currentMonth === todayMonth && currentYear === todayYear) {
                row.classList.add('current-day');
            }

            const dayName = getDayName(currentYear, currentMonth, i);
            const startId = `start-${currentYear}-${currentMonth}-${i}`;
            const endId = `end-${currentYear}-${currentMonth}-${i}`;
            const breakId = `break-${currentYear}-${currentMonth}-${i}`;
            const totalId = `total-${currentYear}-${currentMonth}-${i}`;
            const grossId = `gross-${currentYear}-${currentMonth}-${i}`;
            const netId = `net-${currentYear}-${currentMonth}-${i}`;

            // Pou≈æitie template liter√°lu pre prehƒæadnos≈•
            row.innerHTML = `
                <td>${i}. ${dayName}</td>
                <td>
                    <div class="time-input-wrapper">
                        <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"
                               oninput="handleInput(this, '${endId}')">
                        <span class="clock-icon" onclick="insertCurrentTime('${startId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span>
                    </div>
                </td>
                <td>
                    <div class="time-input-wrapper">
                        <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"
                               oninput="handleInput(this, '${breakId}')">
                        <span class="clock-icon" onclick="insertCurrentTime('${endId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span>
                    </div>
                </td>
                <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
                <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
                <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
            `;
            workDays.appendChild(row);
        }
    }

    // Spracovanie vstupu
    window.handleInput = (input, nextId) => {
        formatAndMoveNext(input, nextId);
        calculateAndUpdateTotals(); // V≈ædy ulo≈æ√≠ zmenu
    };
    window.handleBreakInput = (day) => {
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if (breakInput) {
            let breakValue = parseFloat(breakInput.value);
            if (isNaN(breakValue) || breakValue < 0) breakInput.value = '';
        }
        calculateRow(day);
        calculateAndUpdateTotals();
    };
    function calculateAndUpdateTotals() {
        calculateTotal(); // Najprv prepoƒç√≠ta s√∫ƒçty
        const saveData = collectCurrentData();
        const localKey = `workData-${currentYear}-${currentMonth}`;
        localStorage.setItem(localKey, JSON.stringify(saveData)); // V≈ædy ulo≈æ√≠ lok√°lne
        debouncedSaveToFirestore(); // Pok√∫si sa ulo≈æi≈• do cloudu (s debounce)
    }

    // Valid√°cia ƒçasu
    function isValidTimeFormat(timeString) {
        return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString);
    }

    // Form√°tovanie a presun
    function formatAndMoveNext(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, '');
        const originalValue = input.value;
        const cursorPosition = input.selectionStart;

        // Automatick√° dvojbodka
        if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) value += ':';
        else if (value.length === 4 && !value.includes(':')) value = `${value.substring(0, 2)}:${value.substring(2)}`;
        else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) value = `${value.substring(0, 2)}:${value.substring(2)}`;

        value = value.replace(/^:/, ''); // Dvojbodka na zaƒçiatku
        if ((value.match(/:/g) || []).length > 1) { // Viac dvojbodiek
            const parts = value.split(':'); value = `${parts[0]}:${parts.slice(1).join('')}`;
        }
        if (value.length > 5) value = value.slice(0, 5); // Max dƒ∫≈æka

        if (input.value !== value) {
            input.value = value;
            try { // Obnovenie kurzora
                if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) input.setSelectionRange(3, 3);
                else input.setSelectionRange(cursorPosition, cursorPosition);
            } catch (e) { /* Ignorova≈• chyby */ }
        }

        // V√Ωpoƒçet a presun fokusu
        const day = parseInt(input.id.split('-')[3]);
        if (value.length === 5) {
            calculateRow(day); // V≈ædy prepoƒç√≠ta≈•
            if (isValidTimeFormat(value) && nextId) moveNext(input, nextId); // Presun len ak je platn√Ω a existuje nextId
        } else {
            calculateRow(day); // Prepoƒç√≠ta≈• aj pri ne√∫plnom ƒçase
        }
    }

    function moveNext(currentElement, nextId) {
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
            nextElement.focus();
            if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') nextElement.select();
        }
    }

    // V√Ωpoƒçet riadku
    function calculateRow(day) {
        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return;

        const startTime = startInput.value; const endTime = endInput.value;
        const breakTime = parseFloat(breakInput.value) || 0;

        if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
            grossInput.value = (0).toFixed(decimalPlaces);
            netInput.value = (0).toFixed(decimalPlaces);
            return;
        }

        const [startH, startM] = startTime.split(':').map(Number);
        const [endH, endM] = endTime.split(':').map(Number);
        const startDate = new Date(2000, 0, 1, startH, startM);
        let endDate = new Date(2000, 0, 1, endH, endM);

        // Pr√°ca cez polnoc
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        let diffMinutes = (endDate.getTime() - startDate.getTime()) / 60000;
        diffMinutes -= (breakTime * 60);
        if (diffMinutes < 0) diffMinutes = 0;

        const decimalHours = diffMinutes / 60;
        const totalMinutesRounded = Math.round(diffMinutes);
        const hours = Math.floor(totalMinutesRounded / 60);
        const minutes = totalMinutesRounded % 60;

        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;
        const grossSalary = Math.max(0, decimalHours * hourlyWage);
        grossInput.value = grossSalary.toFixed(decimalPlaces);
        updateNetSalary(day); // Prepoƒçet ƒçistej mzdy
    }

    // V√Ωpoƒçet ƒçistej mzdy
    function updateNetSalary(day) {
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        if (!grossInput || !netInput) return;
        const grossSalary = parseFloat(grossInput.value) || 0;
        const netSalary = Math.max(0, grossSalary * (1 - taxRate));
        netInput.value = netSalary.toFixed(decimalPlaces);
    }

    // Reset riadku
    window.resetRow = (day, saveChanges = true) => {
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const brk = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if(start) start.value = ''; if(end) end.value = ''; if(brk) brk.value = '';
        calculateRow(day); // Prepoƒç√≠ta na nuly
        if (saveChanges) calculateAndUpdateTotals(); // Ulo≈æ√≠ zmeny
    };

    // V√Ωpoƒçet celkov√Ωch s√∫ƒçtov
    function calculateTotal() {
        let totalMinutes = 0, totalGross = 0, totalNet = 0, daysWithEntries = 0;
        const daysInMonth = getDaysInMonth(currentMonth);

        for (let i = 1; i <= daysInMonth; i++) {
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value;
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value;
            const brk = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value) || 0;
            let dayMins = 0, dayGross = 0, dayNet = 0, hasEntry = false;

            if (isValidTimeFormat(start) && isValidTimeFormat(end)) {
                const [sH, sM] = start.split(':').map(Number); const [eH, eM] = end.split(':').map(Number);
                const sDate = new Date(2000, 0, 1, sH, sM); let eDate = new Date(2000, 0, 1, eH, eM);
                if (eDate < sDate) eDate.setDate(eDate.getDate() + 1);
                let diffMins = (eDate.getTime() - sDate.getTime()) / 60000 - (brk * 60);
                if (diffMins < 0) diffMins = 0;
                dayMins = diffMins;
                const dayHours = dayMins / 60;
                dayGross = Math.max(0, dayHours * hourlyWage);
                dayNet = Math.max(0, dayGross * (1 - taxRate));
                if (dayMins > 0) hasEntry = true;
            }
            if (start || end || brk > 0) hasEntry = true;

            totalMinutes += dayMins; totalGross += dayGross; totalNet += dayNet;
            if (hasEntry) daysWithEntries++;
        }

        const totalMinsRounded = Math.round(totalMinutes);
        const totalH = Math.floor(totalMinsRounded / 60);
        const totalMRem = totalMinsRounded % 60;
        const totalDecH = totalMinutes / 60;
        const avgNet = daysWithEntries > 0 ? totalNet / daysWithEntries : 0;
        const avgMins = daysWithEntries > 0 ? totalMinutes / daysWithEntries : 0;
        const avgMinsRounded = Math.round(avgMins);
        const avgH = Math.floor(avgMinsRounded / 60);
        const avgM = avgMinsRounded % 60;
        const avgDecH = avgMins / 60;

        totalSalaryDiv.innerHTML = `
            Zapoƒç√≠tan√Ωch dn√≠: ${daysWithEntries}<br>
            Celkov√Ω ƒças: ${totalH}h ${totalMRem}m (${totalDecH.toFixed(decimalPlaces)} h)<br>
            Hrub√° mzda: ${totalGross.toFixed(decimalPlaces)} ‚Ç¨<br>
            ƒåist√° mzda: ${totalNet.toFixed(decimalPlaces)} ‚Ç¨<br>
            Priem. ƒçist√° mzda/de≈à: ${avgNet.toFixed(decimalPlaces)} ‚Ç¨<br>
            <strong>Priem. ƒças/de≈à: ${avgH}h ${avgM}m (${avgDecH.toFixed(decimalPlaces)} h)</strong>
        `;
    }

    // Exporty a nastavenia (Logika zost√°va rovnak√°)
    function getMonthName(month) { return new Date(2000, month, 1).toLocaleDateString('sk-SK', { month: 'long' }); }
    window.exportToPDF = () => { /* ... (k√≥d pre PDF export) ... */ };
    window.sendPDF = () => { /* ... (k√≥d pre zdieƒæanie PDF) ... */ };
    window.changeDecimalPlaces = () => {
        decimalPlaces = parseInt(decimalPlacesSelect.value);
        localStorage.setItem('decimalPlaces', decimalPlaces);
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) calculateRow(i);
        calculateAndUpdateTotals();
    };
    window.updateEmployeeName = () => {
        employeeName = employeeNameInput.value.trim();
        localStorage.setItem('employeeName', employeeName);
        updateGreeting();
        calculateAndUpdateTotals(); // Ulo≈æ√≠ zmenu mena
    };
    window.updateSettings = () => {
        const newWage = parseFloat(hourlyWageInput.value);
        const newTaxP = parseFloat(taxRateInput.value);
        if (!isNaN(newWage) && newWage >= 0) hourlyWage = newWage; else hourlyWageInput.value = hourlyWage;
        if (!isNaN(newTaxP) && newTaxP >= 0) taxRate = newTaxP / 100; else taxRateInput.value = (taxRate * 100).toFixed(1);
        localStorage.setItem('hourlyWage', hourlyWage);
        localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1));
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) calculateRow(i);
        calculateAndUpdateTotals();
    };
    window.changeMonth = () => { currentMonth = parseInt(monthSelect.value); updateUI(); };
    window.changeYear = () => { currentYear = parseInt(yearSelect.value); updateUI(); };
    function getDaysInMonth(month) { return new Date(currentYear, month + 1, 0).getDate(); }

    // Z√°loha a Obnova (Logika zost√°va rovnak√°)
    window.createBackup = () => { /* ... (k√≥d pre z√°lohu do Excelu) ... */ };
    window.restoreBackup = () => { /* ... (k√≥d pre obnovu z Excelu) ... */ };

    // INIT - Sledovanie stavu prihl√°senia
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateUI(); // Zavol√° sa pri zmene stavu prihl√°senia a na zaƒçiatku
    });

  </script>

  <!-- Service Worker Registr√°cia -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker zaregistrovan√Ω:', reg.scope))
          .catch(err => console.error('Registr√°cia Service Workera zlyhala:', err));
      });
    }
  </script>
</body>
</html>
