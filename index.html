<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- Z√°kladn√© ≈°t√Ωly --- */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
     h2 {
       text-align: center;
       color: #555;
       margin-top: -10px;
       font-size: 1.2em;
     }
     .settings {
       margin-bottom: 20px;
       display: flex;
       flex-wrap: wrap;
       align-items: flex-start;
     }
     .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
       margin: 2px 5px;
     }
     .settings > div {
       flex: 1 1 200px;
     }
     .settings > button#toggleSettingsBtn {
       flex-basis: 100%;
       margin-bottom: 10px;
       background-color: #eee;
       color: #333;
       border: 1px solid #ccc;
       text-align: left;
       padding: 8px 12px;
     }
     body.dark-mode .settings > button#toggleSettingsBtn {
         background-color: #555;
         color: #f4f4f4;
         border-color: #666;
     }
      .settings > button.highlight {
        flex: 1 1 150px;
      }
     .settings label {
       display: block;
       margin-bottom: 2px;
     }
     #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
     }
     #settings-collapsible-content.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 5px;
     }
     #settings-collapsible-content > div {
         flex: 1 1 200px;
         margin: 2px 5px;
     }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 1000px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: top; /* ZMENA: Na top pre lep≈°ie zarovnanie textarea */
    }
    th {
      background-color: #f2f2f2;
    }

    /* --- ≈†t√Ωly pre input bunky a ƒçasov√© tlaƒçidl√° --- */
    td .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 4px;
    }
     td .time-input-wrapper input[type="tel"] {
         flex-grow: 1;
         min-width: 60px;
     }
     td .time-input-wrapper .time-btn {
         font-size: 1.1em;
         cursor: pointer;
         padding: 2px 4px;
         border: 1px solid transparent;
         border-radius: 3px;
         line-height: 1;
         background: none;
         color: #555;
         user-select: none;
     }
      td .time-input-wrapper .time-btn:hover {
          background-color: #eee;
          border-color: #ccc;
      }
      body.dark-mode td .time-input-wrapper .time-btn {
          color: #bbb;
      }
      body.dark-mode td .time-input-wrapper .time-btn:hover {
          background-color: #555;
          border-color: #777;
          color: #fff;
      }

    /* --- ≈†√≠rky stƒ∫pcov --- */
    th:nth-child(7), td:nth-child(7), /* Hrub√° Mzda */
    th:nth-child(8), td:nth-child(8) { /* ƒåist√° Mzda */ width: 14%; }
    th:nth-child(6), td:nth-child(6) { /* Pozn√°mka */ width: 20%; }
    th:nth-child(1), td:nth-child(1) { /* De≈à */ width: 7%; }
    th:nth-child(2), td:nth-child(2) { /* Pr√≠chod */ width: 10%; }
    th:nth-child(3), td:nth-child(3) { /* Odchod */ width: 10%; }
    th:nth-child(4), td:nth-child(4) { /* Prest√°vka */ width: 7%; }
    th:nth-child(5), td:nth-child(5) { /* Odpracovan√© */ width: 10%; }
    th:nth-child(9), td:nth-child(9) { /* Akcia */ width: 8%; }

    /* --- Glob√°lne ≈°t√Ωly pre input a select --- */
    input[type="tel"], input[type="number"], input[type="text"], select, textarea { /* Pridan√° textarea */
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 1em; /* Pou≈æijeme relat√≠vnu veƒækos≈• */
      font-family: inherit; /* Zded√≠ font z body */
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: top; /* ZMENA: Z middle na top */
      line-height: 1.4; /* Trochu v√§ƒç≈°√≠ riadkov√Ω rozostup pre textarea */
    }

    /* --- ZMENEN√â: ≈†pecifick√Ω ≈°t√Ωl pre textarea pozn√°mky --- */
    textarea[id^="note-"] {
        background-color: #e6faff;
        /* Skrolovanie a v√Ω≈°ka */
        overflow-y: auto;   /* Povoli≈• vertik√°lne skrolovanie */
        min-height: 2.4em;  /* Minim√°lna v√Ω≈°ka (cca 1 riadok + padding) */
        max-height: 6em;   /* Maxim√°lna v√Ω≈°ka (cca 3-4 riadky) - upravte podƒæa potreby */
        resize: vertical; /* Povoli≈• pou≈æ√≠vateƒæovi meni≈• veƒækos≈• vertik√°lne */
        /* Ostatn√© ≈°t√Ωly zdeden√© alebo prep√≠san√© z glob√°lneho `textarea` */
    }

    .result { /* ... bez zmien ... */ }
    .btn-container { /* ... bez zmien ... */ }
    .btn { /* ... bez zmien ... */ }
    .reset-btn { /* ... bez zmien ... */ }
    .reset-btn:hover { /* ... bez zmien ... */ }
    .export-btn { /* ... bez zmien ... */ }
    .export-btn:hover { /* ... bez zmien ... */ }
    .backup-btn { /* ... bez zmien ... */ }
    .backup-btn:hover { /* ... bez zmien ... */ }
    .highlight { /* ... bez zmien ... */ }
    #totalSalary { /* ... bez zmien ... */ }
    #dataSizeContainer { /* Bez zmien */ }
    #dataSizeText { /* Bez zmien */ }
    #dataSizeBar { /* Bez zmien */ }
    #dataSizeFill { /* Bez zmien */ }

    /* --- Zv√Ωraznenie aktu√°lneho d≈àa --- */
    .current-day {
      background-color: #8a2be2 !important;
      color: white;
    }
    /* Glob√°lne pre prvky v current-day */
    .current-day input, .current-day select, .current-day textarea {
      background-color: #9932cc !important;
      color: white !important;
      border-color: #b366ff !important;
    }
    /* ≈†pecifick√© pre textarea pozn√°mky v current-day */
    .current-day textarea[id^="note-"] {
        background-color: #aa44dd !important; /* Trochu in√° farba */
        color: white !important; /* Uisti≈• sa, ≈æe text je biely */
    }
    .current-day .time-btn {
        color: white !important;
    }
    .current-day .time-btn:hover {
        background-color: #7a1fb4 !important;
        border-color: #9932cc !important;
     }

    /* --- Tmav√Ω re≈æim --- */
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode h1 {
      color: #f4f4f4;
    }
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
      border-color: #555;
    }
    /* Glob√°lne pre input/select/textarea v tmavom re≈æime */
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select,
    body.dark-mode textarea { /* Pridan√° textarea */
      background-color: #666;
      color: white;
      border-color: #555;
    }
    /* Tmav√Ω re≈æim pre textarea pozn√°mky */
    body.dark-mode textarea[id^="note-"] {
        background-color: #5a5a7a;
        border-color: #4a4a6a;
        color: white;
        /* ≈†t√Ωly pre scrollbar v tmavom re≈æime (voliteƒæn√©, z√°visl√© od prehliadaƒça) */
        /* Napr. pre Webkit prehliadaƒçe (Chrome, Safari, Edge): */
        /* scrollbar-color: #888 #555; */ /* Palec a dr√°ha */
    }
    /* Zvy≈°ok tmav√©ho re≈æimu bez zmien */
    body.dark-mode .btn { color: #f4f4f4; }
    body.dark-mode .reset-btn { background-color: #d32f2f; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f !important; color: #fff; }
    body.dark-mode .current-day input, body.dark-mode .current-day select, body.dark-mode .current-day textarea {
      background-color: #5c1db3 !important;
      color: #fff !important;
      border-color: #7e4bd7 !important;
    }
    body.dark-mode .current-day textarea[id^="note-"] {
       background-color: #6c2fc7 !important;
    }
    body.dark-mode .current-day .time-btn { color: #fff !important; }
    body.dark-mode .current-day .time-btn:hover { background-color: #4a0e8f !important; border-color: #5c1db3 !important; }

    /* --- Responzivita --- */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#toggleSettingsBtn { flex-basis: auto; width: 100%; margin-bottom: 10px; }
      .settings > button.highlight { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 1000px; }
      th, td { padding: 6px; font-size: 0.8em; }
       td .time-input-wrapper .time-btn { font-size: 1em; padding: 1px 3px; }
       /* Zmen≈°enie max-height pre pozn√°mku */
       textarea[id^="note-"] { max-height: 5em; } /* Trochu men≈°ia v√Ω≈°ka */
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; }
      .backup-btn { padding: 15px 16px; }
      #totalSalary { font-size: 16px; }
      #dataSizeContainer { font-size: 12px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 1em; } /* Upraven√© pre textarea */
      table { min-width: 1000px; }
      .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 5px 0; }
      #settings-collapsible-content > div { margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 700px; }
       td .time-input-wrapper .time-btn { font-size: 0.9em; padding: 1px 2px; }
       /* E≈°te men≈°ia max-height pre pozn√°mku */
       textarea[id^="note-"] { max-height: 4.5em; }
    }

    /* --- Notifik√°cie --- */
    #saveNotification, #errorNotification {
        display: none; position: fixed; bottom: 20px; right: 20px;
        padding: 10px 20px; border-radius: 5px; font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 1000;
        opacity: 0; transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show { display: block; opacity: 1; }
    #saveNotification { background-color: #4CAF50; color: white; }
    #errorNotification { background-color: #f44336; color: white; }

    /* --- Prihlasovanie --- */
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 200px; margin: 5px auto; display: block;
    }
    #login-form .btn { width: 120px; margin: 5px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.9em; color: #007bff; text-decoration: none; }
    #login-form a:hover { text-decoration: underline; }
    body.dark-mode #login-form a { color: #6bbaff; }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobrazi≈• nastavenia ‚ñº</button>
        <div id="settings-collapsible-content">
            <div>
                <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
            </div>
            <div>
                <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
                <label for="taxRateInput">Da≈àov√© percento (%): </label>
                <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
                <label for="monthSelect">Mesiac: </label>
                <select id="monthSelect" onchange="changeMonth()">
                  <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                  <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                  <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                  <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
                </select>
            </div>
            <div>
                <label for="yearSelect">Rok: </label>
                <select id="yearSelect" onchange="changeYear()"></select>
            </div>
            <div>
                <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                    <option value="1">1</option> <option value="2">2</option>
                </select>
            </div>
        </div>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
        <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Naƒç√≠tanie preferencie tmav√©ho re≈æimu z localStorage
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    // Funkcia pre prep√≠nanie tmav√©ho re≈æimu
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // --- IMPORTY Firebase --- (bez zmien)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // --- KONFIGUR√ÅCIA Firebase --- (bez zmien)
     const firebaseConfig = {
       apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
       authDomain: "uuuuu-f7ef9.firebaseapp.com",
       projectId: "uuuuu-f7ef9",
       storageBucket: "uuuuu-f7ef9.appspot.com",
       messagingSenderId: "456105865458",
       appId: "1:456105865458:web:101f0a4dcb455f174b606b",
     };

    // --- Inicializ√°cia Firebase --- (bez zmien)
    const app = initializeApp(firebaseConfig);
    try {
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("App Check initialization failed:", e);
    }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- GLOB√ÅLNE PREMENN√â --- (bez zmien)
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;

    // --- Funkcia na aktualiz√°ciu nadpisu --- (bez zmien)
    function updateGreeting() {
        if (employeeName) {
            const firstName = employeeName.split(' ')[0];
            mainTitle.textContent = `Ahoj ${firstName}`;
        } else {
            mainTitle.textContent = 'Ahoj';
        }
    }

    // --- Popul√°cia rokov --- (bez zmien)
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }
    populateYearSelect();

    // --- Nastavenie poƒçiatoƒçn√Ωch hodn√¥t UI --- (bez zmien)
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1);
    updateGreeting();

    // --- Skr√Ωvanie nastaven√≠ --- (bez zmien)
     if (toggleSettingsBtn && settingsCollapsibleContent) {
         toggleSettingsBtn.addEventListener('click', () => {
             const isVisible = settingsCollapsibleContent.classList.toggle('visible');
             toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
         });
     }

    // --- Online/Offline monitoring a notifik√°cie --- (bez zmien)
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { console.log('Online'); showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { console.log('Offline'); showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { /* ... k√≥d bez zmeny ... */ }
    function showErrorNotification(message) { /* ... k√≥d bez zmeny ... */ }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') { /* ... k√≥d bez zmeny ... */ }

    // --- Autentifik√°cia --- (bez zmien)
    window.login = async function() { /* ... k√≥d bez zmeny ... */ };
    window.register = async function() { /* ... k√≥d bez zmeny ... */ };
    window.logout = async function() { /* ... k√≥d bez zmeny ... */ };
    window.resetPassword = async function() { /* ... k√≥d bez zmeny ... */ };
    function mapFirebaseAuthError(errorCode) { /* ... k√≥d bez zmeny ... */ }
    async function createUserCollection() { /* ... k√≥d bez zmeny ... */ }

    // --- UI Update a Logika Naƒç√≠tania --- (bez zmien)
    function updateUI() { /* ... k√≥d bez zmeny ... */ }
    async function loadInitialData() { /* ... k√≥d bez zmeny ... */ }
    async function loadFromFirestoreAndApply() { /* ... k√≥d bez zmeny ... */ }

    // --- Ukladanie (Firestore a localStorage) a Debounce --- (bez zmien)
    function debounce(func, wait) { /* ... k√≥d bez zmeny ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);

    // --- Zber d√°t z tabuƒæky --- (bez zmien, textarea m√° .value)
    function collectCurrentData() {
         const saveData = { data: [], hourlyWage, taxRate, employeeName, decimalPlaces, lastUpdated: new Date().toISOString() };
         const daysInMonth = getDaysInMonth(currentMonth);
         for (let i = 1; i <= daysInMonth; i++) {
           const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
           const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
           const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
           const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`); // Teraz textarea
           const grossEl = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
           const netEl = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
           saveData.data.push({
             start: startEl?.value || '', end: endEl?.value || '', breakTime: breakEl?.value || '',
             note: noteEl?.value || '', // Z√≠skanie hodnoty z textarea
             gross: grossEl?.value || '0', net: netEl?.value || '0'
           });
         }
         return saveData;
    }

    // --- Ukladanie do Firestore --- (bez zmien)
    async function saveToFirestore() { /* ... k√≥d bez zmeny ... */ }

    // --- Synchroniz√°cia --- (bez zmien)
    async function syncWithFirebase() { /* ... k√≥d bez zmeny ... */ }

    // --- Manu√°lne naƒç√≠tanie z Firestore --- (bez zmien)
    window.loadFromFirestore = async function() { /* ... k√≥d bez zmeny ... */ };

    // --- Naƒç√≠tanie LEN z localStorage --- (bez zmien)
    function loadFromLocalStorageOnly() { /* ... k√≥d bez zmeny ... */ }

    // --- Spracovanie JSON a aplikovanie d√°t --- (bez zmien, textarea m√° .value)
    function parseAndApplyData(dataString) {
        try {
            const storedData = JSON.parse(dataString);
            // Aktualiz√°cia nastaven√≠
            hourlyWage = storedData.hourlyWage ?? (parseFloat(hourlyWageInput.value) || 10);
            taxRate = storedData.taxRate ?? ((parseFloat(taxRateInput.value) || 2) / 100);
            employeeName = storedData.employeeName ?? (employeeNameInput.value || '');
            decimalPlaces = storedData.decimalPlaces ?? (parseInt(decimalPlacesSelect.value) || 1);
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;
            updateGreeting();
            localStorage.setItem('hourlyWage', hourlyWage);
            localStorage.setItem('taxRate', taxRate);
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces);

            // Aplik√°cia d√°t do tabuƒæky
            if (storedData.data && Array.isArray(storedData.data)) {
                const daysInMonth = getDaysInMonth(currentMonth);
                const daysToProcess = Math.min(daysInMonth, storedData.data.length);
                for (let index = 0; index < daysToProcess; index++) {
                    const day = storedData.data[index];
                    const i = index + 1;
                    const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                    const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`); // Teraz textarea
                    if (startEl && endEl && breakEl && noteEl) {
                        startEl.value = day.start || '';
                        endEl.value = day.end || '';
                        breakEl.value = day.breakTime || '';
                        noteEl.value = day.note || ''; // Nastavenie hodnoty textarea
                        calculateRow(i);
                    }
                }
                // Vyƒçistenie riadkov navy≈°e
                 for (let i = daysToProcess + 1; i <= daysInMonth; i++) {
                     if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { resetRow(i, false); }
                 }
            } else { /* Vyƒçistenie celej tabuƒæky */ }
            calculateTotal();
        } catch (error) { /* Spracovanie chyby */ }
    }

    // -------------------- Tvorba tabuƒæky a v√Ωpoƒçty --------------------
    function getDayName(year, month, day) { /* ... k√≥d bez zmeny ... */ }

    // --- ZMENEN√â: Tvorba tabuƒæky (pou≈æ√≠va textarea pre pozn√°mku) ---
    function createTable() {
      console.log(`Vytv√°ram ≈°trukt√∫ru tabuƒæky pre ${getMonthName(currentMonth)} ${currentYear}`);
      workDays.innerHTML = '';
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        const startId = `start-${currentYear}-${currentMonth}-${i}`;
        const endId = `end-${currentYear}-${currentMonth}-${i}`;
        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
        const noteId = `note-${currentYear}-${currentMonth}-${i}`; // ID pre pozn√°mku (textarea)
        const grossId = `gross-${currentYear}-${currentMonth}-${i}`;
        const netId = `net-${currentYear}-${currentMonth}-${i}`;
        const totalId = `total-${currentYear}-${currentMonth}-${i}`;

        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td>
            <div class="time-input-wrapper">
              <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}')">
              <span class="time-btn" onclick="setCurrentTime('${startId}')" title="Zada≈• aktu√°lny ƒças">üïí</span>
            </div>
          </td>
          <td>
            <div class="time-input-wrapper">
              <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}')">
              <span class="time-btn" onclick="setCurrentTime('${endId}')" title="Zada≈• aktu√°lny ƒças">üïí</span>
            </div>
          </td>
          <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
          <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><textarea id="${noteId}" placeholder="Pozn√°mka..." oninput="calculateAndUpdateTotals()" rows="1"></textarea></td> {/* ZMENA: input na textarea, pridan√Ω rows="1" */}
          <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        workDays.appendChild(row);
      }
      console.log('≈†trukt√∫ra tabuƒæky vytvoren√°.');
    }

    // --- Z√°pis aktu√°lneho ƒçasu --- (bez zmien)
    window.setCurrentTime = function(inputId) { /* ... k√≥d bez zmeny ... */ }

    // --- Handler pre inputy (ƒças a prest√°vka) --- (bez zmien)
    window.handleInput = function(input, nextId) { /* ... k√≥d bez zmeny ... */ }
    window.handleBreakInput = function(day) { /* ... k√≥d bez zmeny ... */ }

    // --- Hlavn√° funkcia pre ukladanie d√°t --- (bez zmien)
    function calculateAndUpdateTotals() { /* ... k√≥d bez zmeny ... */ }

    // --- Pomocn√© funkcie (ƒças, presun) --- (bez zmien)
    function isValidTimeFormat(timeString) { /* ... k√≥d bez zmeny ... */ }
    function formatAndMoveNext(input, nextId) { /* ... k√≥d bez zmeny ... */ }
    function moveNext(currentElement, nextId) { /* ... k√≥d bez zmeny ... */ }

    // --- V√Ωpoƒçet riadku --- (bez zmien)
    function calculateRow(day) { /* ... k√≥d bez zmeny ... */ }

    // --- V√Ωpoƒçet ƒçistej mzdy --- (bez zmien)
    function updateNetSalary(day) { /* ... k√≥d bez zmeny ... */ }

    // --- Vynulovanie riadku --- (bez zmien, textarea m√° .value)
    window.resetRow = function(day, saveChanges = true) {
      const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const noteInput = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); // Teraz textarea

      if(startInput) startInput.value = '';
      if(endInput) endInput.value = '';
      if(breakInput) breakInput.value = '';
      if(noteInput) noteInput.value = ''; // Vynuluj textarea

      calculateRow(day);
      if (saveChanges) { calculateAndUpdateTotals(); }
    }

    // --- V√Ωpoƒçet celkov√Ωch s√∫ƒçtov --- (bez zmien)
    function calculateTotal() { /* ... k√≥d bez zmeny ... */ }

    // --- N√°zov mesiaca --- (bez zmien)
    function getMonthName(month) { /* ... k√≥d bez zmeny ... */ }

    // --- Export do PDF --- (bez zmien, textarea m√° .value)
    window.exportToPDF = function() { /* ... k√≥d bez zmeny, pristupuje k noteElement.value ... */ }

    // --- Odoslanie PDF --- (bez zmien)
    window.sendPDF = function() { /* ... k√≥d bez zmeny ... */ }

    // --- Ostatn√© nastavenia --- (bez zmien)
    window.changeDecimalPlaces = function() { /* ... k√≥d bez zmeny ... */ }
    window.updateEmployeeName = function() { /* ... k√≥d bez zmeny ... */ }
    window.updateSettings = function() { /* ... k√≥d bez zmeny ... */ }
    window.changeMonth = function() { /* ... k√≥d bez zmeny ... */ }
    window.changeYear = function() { /* ... k√≥d bez zmeny ... */ }
    function getDaysInMonth(month) { /* ... k√≥d bez zmeny ... */ }

    // --- Init Auth Listener --- (bez zmien)
    onAuthStateChanged(auth, (user) => { /* ... k√≥d bez zmeny ... */ });

    // --- Z√°loha a obnova --- (bez zmien, textarea m√° .value)
    window.createBackup = function() { /* ... k√≥d bez zmeny, pristupuje k row.note ... */ };
    window.restoreBackup = function() { /* ... k√≥d bez zmeny, naƒç√≠ta pozn√°mku do dataArray.note ... */ };

  </script>

  <script>
    // Service Worker registr√°cia (bez zmien)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => { console.log('SW zaregistrovan√Ω:', registration.scope); })
          .catch(error => { console.error('SW registr√°cia zlyhala:', error); });
      });
    }
  </script>
</body>
</html>
