<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>
  <link rel="manifest" href="./manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- VŠETKY ŠTÝLY ZOSTANÚ ROVNAKÉ AKO V POSLEDNEJ VERZII --- */
    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    h1 { text-align: center; font-size: 2.5em; color: black; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: flex-start; }
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 2px 5px; }
    .settings > div { flex: 1 1 200px; }
    .settings > button#toggleSettingsBtn { flex-basis: 100%; margin-bottom: 10px; background-color: #eee; color: #333; border: 1px solid #ccc; text-align: left; padding: 8px 12px; }
    body.dark-mode .settings > button#toggleSettingsBtn { background-color: #555; color: #f4f4f4; border-color: #666; }
    .settings > button.highlight { flex: 1 1 150px; }
    .settings label { display: block; margin-bottom: 2px; }
    #settings-collapsible-content { display: flex; flex-wrap: wrap; width: 100%; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.3s ease-out; }
    #settings-collapsible-content.visible { max-height: 400px; opacity: 1; margin-top: 5px; }
    #settings-collapsible-content > div { flex: 1 1 200px; margin: 2px 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    th:nth-child(6), td:nth-child(6), th:nth-child(7), td:nth-child(7) { width: 25%; }
    th:nth-child(1), td:nth-child(1), th:nth-child(2), td:nth-child(2), th:nth-child(3), td:nth-child(3), th:nth-child(4), td:nth-child(4), th:nth-child(5), td:nth-child(5), th:nth-child(8), td:nth-child(8) { width: 8.33%; }
    input[type="tel"], input[type="number"], input[type="text"], select { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; vertical-align: middle; }
    .result { font-weight: bold; margin-top: 20px; text-align: center; }
    .btn-container { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 20px; }
    .btn { flex: 1 1 150px; padding: 10px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; transition: background-color 0.3s ease; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; padding: 15px 20px; } .backup-btn:hover { background-color: #6a1bb2; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; } #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; } #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; } .current-day input { background-color: #9932cc; color: white; }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    body.dark-mode .container { background-color: #444; color: #f4f4f4; } body.dark-mode h1 { color: #f4f4f4; }
    body.dark-mode table { background-color: #555; color: #f4f4f4; } body.dark-mode th { background-color: #666; } body.dark-mode td { background-color: #444; color: #f4f4f4; }
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode select { background-color: #666; color: white; border-color: #555; }
    body.dark-mode .btn { color: #f4f4f4; } body.dark-mode .reset-btn { background-color: #d32f2f; } body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; } body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f; color: #fff; } body.dark-mode .current-day input { background-color: #5c1db3; color: #fff; }
    @media (max-width: 768px) {
      body { padding: 5px; } .container { padding: 10px; } h1 { font-size: 1.8em; } h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; } .settings > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#toggleSettingsBtn { flex-basis: auto; width: 100%; margin-bottom: 10px; } .settings > button.highlight { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; } #settings-collapsible-content > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 800px; } th, td { padding: 6px; font-size: 0.8em; } .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; } .backup-btn { padding: 15px 16px; } #totalSalary { font-size: 16px; } #dataSizeContainer { font-size: 12px; } .table-container { overflow-x: auto; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; } th, td { font-size: 0.7em; } .btn { font-size: 12px; padding: 6px 12px; } .backup-btn { padding: 15px 12px; } .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 12px; } table { min-width: 800px; }
      .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 5px 0; } #settings-collapsible-content > div { margin: 5px 0; } #settings-collapsible-content.visible { max-height: 700px; }
    }
    #saveNotification, #errorNotification { display: none; position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; font-size: 14px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
    #saveNotification.show, #errorNotification.show { display: block; opacity: 1; } #saveNotification { background-color: #4CAF50; color: white; } #errorNotification { background-color: #f44336; color: white; }
    #login-form { display: flex; flex-direction: column; align-items: center; } #login-form input[type="email"], #login-form input[type="password"] { width: 200px; margin: 5px auto; display: block; } #login-form .btn { width: 120px; margin: 5px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.9em; color: #007bff; text-decoration: none; } #login-form a:hover { text-decoration: underline; } body.dark-mode #login-form a { color: #6bbaff; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI (bez zmien) -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <!-- Nastavenia (bez zmien v HTML štruktúre) -->
    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button>
      <div id="settings-collapsible-content">
          <div>
            <label for="employeeNameInput">Meno pracovníka: </label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinová mzda (€): </label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="taxRateInput">Daňové percento (%): </label>
            <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
          </div>
          <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
              <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
              <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
              <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
              <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok: </label>
            <select id="yearSelect" onchange="changeYear()"> </select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Počet desatinných miest: </label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
              <option value="1">1</option> <option value="2">2</option>
            </select>
          </div>
      </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>

    <!-- Tabuľka (bez zmien v HTML štruktúre) -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th> <th>Príchod</th> <th>Odchod</th> <th>Prestávka</th>
            <th>Odpracované</th> <th>Hrubá Mzda (€)</th> <th>Čistá Mzda (€)</th> <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <!-- Tlačidlá (bez zmien v HTML štruktúre) -->
    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button>
    </div>
  </div>

  <!-- Notifikácie (bez zmien v HTML) -->
  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- ----------------------------------------------------- -->
  <!-- -------------- HLAVNÝ JAVASCRIPT KÓD -------------- -->
  <!-- ----------------------------------------------------- -->
  <script type="module">
    // Importy Firebase (ZMENA: pridaný getDocs, query, collection)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch, query } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js'; // Pridané getDocs, writeBatch, query
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // Konfigurácia Firebase (bez zmien)
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.firebasestorage.app",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase (bez zmien)
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), isTokenAutoRefreshEnabled: true });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Globálne premenné (bez zmien okrem monthData)
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth(); // Zostáva 0-based pre logiku JS
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(hourlyWageInput.value) || 10;
    let taxRate = (parseFloat(taxRateInput.value) || 2) / 100;
    // monthData sa už nebude používať na držanie všetkých dát mesiaca
    // let monthData = {};

    // --- Funkcie pre UI, online/offline, notifikácie, roky, tmavý režim (BEZ ZMIEN) ---
    if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
    window.toggleDarkMode = function() { /* ... */ }
    function updateGreeting() { /* ... */ }
    function populateYearSelect() { /* ... */ }
    populateYearSelect();
    monthSelect.value = currentMonth; yearSelect.value = currentYear; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName; updateGreeting();
    hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1);
    if (toggleSettingsBtn && settingsCollapsibleContent) { toggleSettingsBtn.addEventListener('click', () => { /* ... */ }); }
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { console.log('Online'); showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { console.log('Offline'); showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { /* ... */ }
    function showErrorNotification(message) { /* ... */ }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') { /* ... */ }

    // --- Autentifikácia (login, register, logout, resetPassword, createUserCollection) ---
    // createUserCollection bude upravená
    window.login = async function() { /* ... (bez zmien) ... */ }
    window.register = async function() {
      if (!isOnline()) { showErrorNotification('Ste offline...'); return; }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) { showErrorNotification('Zadajte email aj heslo.'); return; }
      if (password.length < 6) { showErrorNotification('Heslo musí mať aspoň 6 znakov.'); return; }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await initializeUserFirestoreData(userCredential.user); // Zavoláme novú funkciu
        console.log('Registrácia úspešná pre:', userCredential.user.email);
      } catch (error) { /* ... (bez zmien) ... */ }
    }
    window.logout = async function() { /* ... (bez zmien) ... */ }
    window.resetPassword = async function() { /* ... (bez zmien) ... */ }
    function mapFirebaseAuthError(errorCode) { /* ... (bez zmien) ... */ }

    // --- ZMENA: Inicializácia dát vo Firestore pri registrácii ---
    async function initializeUserFirestoreData(user) {
      if (!user) return;
      const userDocRef = doc(db, 'users', user.uid);
      const workDaysColRef = collection(userDocRef, 'workDays');
      // Vytvoríme hlavný user dokument
      const userDocData = { email: user.email, createdAt: new Date() };
      // Vytvoríme prázdny dokument pre aktuálny mesiac (aby kolekcia existovala)
      // Použijeme mesiac + 1 pre ID
      const initialMonthDocId = `${currentYear}-${currentMonth + 1}`;
      const initialMonthDocRef = doc(workDaysColRef, initialMonthDocId);
      const initialMonthData = { initialized: true, lastUpdated: new Date().toISOString() }; // Len značka

      // Použijeme batch pre atomický zápis
      const batch = writeBatch(db);
      batch.set(userDocRef, userDocData, { merge: true });
      batch.set(initialMonthDocRef, initialMonthData);

      try {
        await batch.commit();
        console.log('User document and initial month document created for:', user.email);
      } catch (error) {
        console.error('Error initializing user Firestore data:', error);
      }
    }

    // -------------------- UI Update a Logika Načítania (UPRAVENÉ) --------------------
    function updateUI() {
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');

        // Vždy najprv vytvoríme štruktúru tabuľky pre aktuálny mesiac/rok
        createTable(); // Táto funkcia zostáva rovnaká

        if (currentUser) {
            loginForm.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;
            // Ak je používateľ prihlásený, pokúsime sa načítať dáta z Firestore alebo LS
            loadInitialData();
        } else {
            loginForm.style.display = 'flex';
            userInfo.style.display = 'none';
            // Ak používateľ nie je prihlásený, načítame iba z localStorage
            loadFromLocalStorageOnly();
            if (!isOnline()) {
                showErrorNotification('Ste offline. Prihláste sa, keď budete online...');
            }
        }
    }

    // --- ZMENA: Načítanie dát ---
    async function loadInitialData() {
        const localKey = `workData-${currentYear}-${currentMonth}`; // LS kľúč zostáva 0-based
        const localData = localStorage.getItem(localKey);
        const pendingSyncKey = `pendingSyncSettings-${currentYear}-${currentMonth}`; // Kľúč len pre nastavenia
        const pendingSyncData = localStorage.getItem(pendingSyncKey);

        if (pendingSyncData && isOnline() && currentUser) {
            console.log('Máme čakajúce nastavenia a sme online, pokúšam sa synchronizovať PRED načítaním.');
            await syncWithFirebase(); // Počkáme na synchronizáciu nastavení
            // Po synchronizácii skúsime načítať dáta (mali by byť už aktuálne v cloude)
            await loadFromFirestoreAndApply();

        } else if (localData) {
            console.log('Načítavam počiatočné údaje z localStorage (priorita).');
            // parseAndApplyData spracuje dáta z LS (musí vedieť spracovať starý aj nový formát pre istotu)
            parseAndApplyData(localData);
            // Ak sme online, skontrolujeme cloud (voliteľné, vynecháme pre jednoduchosť)
            // if (isOnline() && currentUser) { /* checkCloudForUpdates(); */ }
        } else if (isOnline() && currentUser) {
            // localStorage prázdny, sme online a prihlásení -> načítame z Firestore
           await loadFromFirestoreAndApply();
        } else {
            console.log('Offline a žiadne dáta v localStorage.');
            calculateTotal(); // Vynuluje súčty
        }
    }

    // --- ZMENA: Načítanie z Firestore a aplikovanie dát ---
    async function loadFromFirestoreAndApply() {
         if (!currentUser) return; // Potrebujeme usera pre cestu
         console.log(`Pokúšam sa načítať údaje z Firestore pre ${currentYear}-${currentMonth + 1}`);
         try {
            const monthDocId = `${currentYear}-${currentMonth + 1}`;
            const userWorkDaysCol = collection(db, 'users', currentUser.uid, 'workDays');
            const monthDocRef = doc(userWorkDaysCol, monthDocId);
            const entriesColRef = collection(monthDocRef, 'entries'); // Referencia na podkolekciu

            // 1. Načítanie mesačného dokumentu (nastavenia)
            const monthDocSnap = await getDoc(monthDocRef);
            let settingsData = {};
            if (monthDocSnap.exists()) {
                settingsData = monthDocSnap.data();
                console.log('Nastavenia mesiaca nájdené vo Firestore:', settingsData);
            } else {
                console.log('Dokument s nastaveniami pre tento mesiac vo Firestore neexistuje.');
                // Použijeme default/aktuálne nastavenia z UI
                settingsData = {
                    hourlyWage: hourlyWage, taxRate: taxRate, employeeName: employeeName,
                    decimalPlaces: decimalPlaces, lastUpdated: null // Neznámy čas poslednej úpravy
                };
            }

            // 2. Načítanie všetkých denných záznamov z podkolekcie 'entries'
            const entriesQuery = query(entriesColRef); // Jednoduchý dotaz na celú kolekciu
            const entriesSnapshot = await getDocs(entriesQuery);
            let dailyEntries = {}; // Objekt na uloženie dát { '1': {start:...}, '2': {start:...} }
            if (!entriesSnapshot.empty) {
                entriesSnapshot.forEach((docSnap) => {
                    // ID dokumentu je číslo dňa (string), dáta sú v docSnap.data()
                    dailyEntries[docSnap.id] = docSnap.data();
                });
                console.log(`Načítaných ${entriesSnapshot.size} denných záznamov z Firestore.`);
            } else {
                console.log('Pre tento mesiac neboli v podkolekcii "entries" nájdené žiadne denné záznamy.');
            }

            // 3. Zostavenie finálneho objektu a uloženie do localStorage + aplikácia
            const combinedData = {
                settings: settingsData,
                entries: dailyEntries // Objekt s dennými záznamami
            };
            const dataString = JSON.stringify(combinedData);
             // LS kľúč zostáva 0-based
            localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString);
            parseAndApplyData(dataString); // Aplikujeme načítané dáta do UI
            showSaveNotification('Dáta boli úspešne načítané z Firebase.');

        } catch (error) {
            console.error('Chyba pri načítavaní z Firestore:', error);
            showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message);
            calculateTotal(); // V prípade chyby zobrazíme nuly
        }
    }

    // --- Ukladanie do Firestore a localStorage (UPRAVENÉ) ---
    function debounce(func, wait) { /* ... (bez zmien) ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);

    // --- ZMENA: Zbieranie dát z tabuľky a nastavení ---
    function collectCurrentDataForStorage() {
         const settingsData = {
            hourlyWage: hourlyWage,
            taxRate: taxRate,
            employeeName: employeeName,
            decimalPlaces: decimalPlaces,
            lastUpdated: new Date().toISOString()
         };

         const dailyEntriesData = {}; // Objekt pre denné záznamy: { '1': {start:...}, '2': {...} }
         const daysInMonth = getDaysInMonth(currentMonth);

         for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

            const start = startElement ? startElement.value : '';
            const end = endElement ? endElement.value : '';
            const breakTime = breakElement ? breakElement.value : '';

            // Uložíme záznam pre deň, len ak má aspoň nejakú hodnotu (start, end, alebo nenulovú prestávku)
            if (start || end || (breakTime && parseFloat(breakTime) > 0)) {
                 // Kľúč je číslo dňa ako string
                dailyEntriesData[i.toString()] = { start, end, breakTime };
            }
         }
         // Vrátime oba objekty
         return { settings: settingsData, entries: dailyEntriesData };
    }

    // --- ZMENA: Funkcia pre ukladanie do Firestore ---
    async function saveToFirestore() {
      if (!currentUser) return;

      const { settings, entries } = collectCurrentDataForStorage(); // Získame aktuálne dáta
      const monthDocId = `${currentYear}-${currentMonth + 1}`; // Mesiac + 1 pre ID
      const pendingSyncKey = `pendingSyncSettings-${currentYear}-${currentMonth}`; // Len pre nastavenia

      if (isOnline()) {
        try {
            console.log(`Pokúšam sa uložiť dáta do Firestore pre ${monthDocId}...`);
            const userWorkDaysCol = collection(db, 'users', currentUser.uid, 'workDays');
            const monthDocRef = doc(userWorkDaysCol, monthDocId);
            const entriesColRef = collection(monthDocRef, 'entries');

            // Použijeme Batch pre atomický zápis (nastavenia + všetky denné záznamy)
            const batch = writeBatch(db);

            // 1. Uloženie/aktualizácia mesačného dokumentu s nastaveniami
            batch.set(monthDocRef, settings, { merge: true }); // Merge pre istotu

            // 2. Uloženie/aktualizácia denných záznamov v podkolekcii 'entries'
            // Najprv získame existujúce kľúče (dni) v cloude, aby sme vedeli, ktoré vymazať
            const existingEntriesSnapshot = await getDocs(query(entriesColRef));
            const existingDayIds = new Set();
            existingEntriesSnapshot.forEach(docSnap => existingDayIds.add(docSnap.id));

            const currentDayIds = new Set(Object.keys(entries)); // Dni, ktoré majú byť uložené teraz

            // Uloženie/aktualizácia aktuálnych dní
            for (const dayId in entries) {
                const dayData = entries[dayId];
                const dayDocRef = doc(entriesColRef, dayId); // ID dokumentu je číslo dňa
                batch.set(dayDocRef, dayData); // Prepíše alebo vytvorí
            }

            // Vymazanie dní, ktoré existujú v cloude, ale už nemajú byť uložené (boli vymazané v UI)
            existingDayIds.forEach(dayId => {
                if (!currentDayIds.has(dayId)) {
                    const dayDocRefToDelete = doc(entriesColRef, dayId);
                    batch.delete(dayDocRefToDelete);
                    console.log(`Označujem deň ${dayId} na vymazanie z Firestore.`);
                }
            });

            // Vykonanie všetkých operácií v batchi
            await batch.commit();

            localStorage.removeItem(pendingSyncKey); // Odstránime pending flag pre nastavenia
            showSaveNotification('Dáta synchronizované s Firebase.');
            console.log('Dáta úspešne uložené do Firestore (nastavenia + denné záznamy).');

        } catch (error) {
            console.error('Chyba pri ukladaní do Firestore:', error);
            showErrorNotification('Chyba pri ukladaní dát do cloudu: ' + error.message);
            // Ak ukladanie zlyhá, označíme aspoň NASTAVENIA ako čakajúce
            localStorage.setItem(pendingSyncKey, JSON.stringify(settings));
        }
      } else {
        // Offline: Označíme len NASTAVENIA ako čakajúce
        console.log('Offline: Označujem nastavenia pre neskoršiu synchronizáciu');
        localStorage.setItem(pendingSyncKey, JSON.stringify(settings));
        showSaveNotification('Ste offline, dáta uložené lokálne (synchronizácia pri pripojení).');
      }
    }

    // --- ZMENA: Synchronizácia čakajúcich dát (len nastavenia) ---
    async function syncWithFirebase() {
      if (!currentUser || !isOnline()) return;

      console.log('Kontrolujem čakajúce nastavenia na synchronizáciu...');
      const pendingSyncKey = `pendingSyncSettings-${currentYear}-${currentMonth}`;
      const pendingSettingsString = localStorage.getItem(pendingSyncKey);

      if (pendingSettingsString) {
        console.log('Našli sa čakajúce nastavenia, pokúšam sa synchronizovať...');
        try {
          const settingsToSync = JSON.parse(pendingSettingsString);
          settingsToSync.lastUpdated = new Date().toISOString(); // Aktualizujeme čas

          const monthDocId = `${currentYear}-${currentMonth + 1}`;
          const userWorkDaysCol = collection(db, 'users', currentUser.uid, 'workDays');
          const monthDocRef = doc(userWorkDaysCol, monthDocId);

          // Prepíšeme len nastavenia v mesačnom dokumente
          await setDoc(monthDocRef, settingsToSync, { merge: true });
          console.log('Čakajúce nastavenia boli úspešne synchronizované s Firestore.');

          // Aktualizujeme aj hlavný localStorage kľúč (aj keď tam sú aj denné dáta)
          const localKey = `workData-${currentYear}-${currentMonth}`;
          const currentLocalDataString = localStorage.getItem(localKey);
          let combinedData = { settings: settingsToSync, entries: {} }; // Default entries
          if (currentLocalDataString) {
              try {
                  const currentLocalData = JSON.parse(currentLocalDataString);
                  if(currentLocalData.entries) combinedData.entries = currentLocalData.entries; // Zachováme denné dáta z LS
              } catch (e) { console.error("Chyba pri parsovaní LS dát počas synchronizácie nastavení:", e)}
          }
          localStorage.setItem(localKey, JSON.stringify(combinedData)); // Uložíme kombinované dáta

          localStorage.removeItem(pendingSyncKey); // Odstránime príznak po úspechu
          showSaveNotification('Offline nastavenia boli synchronizované s Firebase.');
          // Po synchronizácii môžeme obnoviť UI (hlavne nastavenia)
          parseAndApplyData(JSON.stringify(combinedData));

        } catch (error) {
          console.error('Chyba pri synchronizácii čakajúcich nastavení s Firestore:', error);
          showErrorNotification('Chyba pri synchronizácii offline nastavení: ' + error.message);
        }
      } else {
         console.log('Žiadne čakajúce nastavenia na synchronizáciu pre tento mesiac.');
      }
    }

    // --- ZMENA: Manuálne načítanie z Firestore ---
    window.loadFromFirestore = async function() {
        if (!currentUser) { showErrorNotification('Pre načítanie sa musíte prihlásiť.'); return; }
        if (!isOnline()) { showErrorNotification('Ste offline...'); return; }
        if (!confirm('Naozaj chcete načítať dáta z Firebase? Prepíšu sa tým lokálne zmeny.')) return;

        // Funkcia loadFromFirestoreAndApply už robí presne to, čo potrebujeme
        await loadFromFirestoreAndApply();
        // Odstránime príznak čakajúcej synchronizácie nastavení, ak existoval
        localStorage.removeItem(`pendingSyncSettings-${currentYear}-${currentMonth}`);
    }

    // --- ZMENA: Načítanie LEN z localStorage ---
    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);

        if (localData) {
            console.log('Načítavam údaje iba z localStorage (offline alebo neprihlásený)');
            parseAndApplyData(localData); // parseAndApplyData si musí poradiť s novým formátom
        } else {
            console.log('Žiadne údaje v localStorage na načítanie.');
            calculateTotal();
        }
    }

    // --- ZMENA: Spracovanie JSON stringu a aplikovanie dát do UI ---
    function parseAndApplyData(dataString) {
        try {
            const storedData = JSON.parse(dataString);
            let settings = {};
            let dailyEntries = {}; // Bude to objekt {'1': {...}, '2': {...}}

            // Spracovanie rôznych možných formátov z LS (starý vs. nový)
            if (storedData.settings && storedData.entries) {
                // Nový formát
                settings = storedData.settings;
                dailyEntries = storedData.entries;
            } else if (storedData.data && Array.isArray(storedData.data)) {
                // Starý formát - skonvertujeme ho
                console.warn("Konvertujem starý formát dát z localStorage.");
                settings = {
                    hourlyWage: storedData.hourlyWage, taxRate: storedData.taxRate,
                    employeeName: storedData.employeeName, decimalPlaces: storedData.decimalPlaces,
                    lastUpdated: storedData.lastUpdated
                };
                // Prevod poľa na objekt
                storedData.data.forEach((dayData, index) => {
                    const dayNum = index + 1;
                    // Uložíme len ak deň má nejaké dáta
                    if (dayData.start || dayData.end || (dayData.breakTime && parseFloat(dayData.breakTime) > 0)) {
                       dailyEntries[dayNum.toString()] = {
                           start: dayData.start || '',
                           end: dayData.end || '',
                           breakTime: dayData.breakTime || ''
                       };
                    }
                });
                // Preuložíme do LS v novom formáte
                const convertedData = { settings: settings, entries: dailyEntries };
                localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(convertedData));
            } else {
                 console.warn('Neočakávaný formát dát v localStorage. Používam default hodnoty.');
                 // Použijeme default/aktuálne hodnoty
                 settings = { hourlyWage, taxRate, employeeName, decimalPlaces, lastUpdated: null };
            }


            // Aktualizácia globálnych premenných a inputov pre nastavenia
            hourlyWage = settings.hourlyWage !== undefined ? settings.hourlyWage : 10;
            taxRate = settings.taxRate !== undefined ? settings.taxRate : 0.02;
            employeeName = settings.employeeName !== undefined ? settings.employeeName : '';
            decimalPlaces = settings.decimalPlaces !== undefined ? settings.decimalPlaces : 1;

            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;
            updateGreeting(); // Aktualizácia nadpisu

            localStorage.setItem('decimalPlaces', decimalPlaces);
            localStorage.setItem('employeeName', employeeName);

            // Aplikácia denných dát do tabuľky
            const daysInMonth = getDaysInMonth(currentMonth);
            // Najprv vynulujeme všetky riadky vizuálne
            for (let i = 1; i <= daysInMonth; i++) {
                if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                   resetRow(i, false); // Vynulujeme bez ukladania
                }
            }
            // Potom naplníme dáta z dailyEntries
            for (const dayId in dailyEntries) { // dayId je string '1', '2', ...
                const dayData = dailyEntries[dayId];
                const i = parseInt(dayId); // Prevedieme na číslo dňa
                if (i >= 1 && i <= daysInMonth) {
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

                    if (startElement && endElement && breakElement) {
                        startElement.value = dayData.start || '';
                        endElement.value = dayData.end || '';
                        breakElement.value = dayData.breakTime || '';
                        calculateRow(i); // Prepočítame riadok
                    }
                }
            }
            // Po aplikovaní všetkých riadkov prepočítame celkové súčty
            calculateTotal();
        } catch (error) {
            console.error('Chyba pri parsovaní alebo aplikovaní dát:', error);
            showErrorNotification('Chyba pri spracovaní uložených dát: ' + error.message);
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); }
            calculateTotal();
        }
    }


    // -------------------- Tvorba tabuľky a výpočty (BEZ ZMIEN v týchto funkciách) --------------------
    // getDayName, createTable, handleInput, handleBreakInput, isValidTimeFormat, formatAndMoveNext, moveNext, calculateRow, updateNetSalary, resetRow, calculateTotal
    function getDayName(year, month, day) { /* ... */ }
    function createTable() { /* ... */ }
    window.handleInput = function(input, nextId) { formatAndMoveNext(input, nextId); calculateAndUpdateTotals(); }
    window.handleBreakInput = function(day) { /* ... */ calculateRow(day); calculateAndUpdateTotals(); }
    function isValidTimeFormat(timeString) { /* ... */ }
    function formatAndMoveNext(input, nextId) { /* ... */ calculateRow(parseInt(input.id.split('-')[3])); /* ... */ }
    function moveNext(currentElement, nextId) { /* ... */ }
    function calculateRow(day) { /* ... */ updateNetSalary(day); /* ... */ }
    function updateNetSalary(day) { /* ... */ }
    window.resetRow = function(day, saveChanges = true) { /* ... */ calculateRow(day); if (saveChanges) { calculateAndUpdateTotals(); } }
    function calculateTotal() { /* ... */ }
    function getMonthName(month) { /* ... */ }

    // -------------------- Ukladanie pri zmene --------------------
    // Táto funkcia sa volá po každej zmene v inputoch
    function calculateAndUpdateTotals() {
        calculateTotal(); // Prepočítame celkové súčty na základe aktuálnych hodnôt v tabuľke

        // Získame aktuálne dáta z UI v novom formáte
        const saveData = collectCurrentDataForStorage();

        // Vždy uložíme do localStorage - toto zaručuje offline perzistenciu
        const localKey = `workData-${currentYear}-${currentMonth}`; // 0-based kľúč
        localStorage.setItem(localKey, JSON.stringify(saveData));

        // Pokúsime sa uložiť/synchronizovať s Firestore (s debounce)
        debouncedSaveToFirestore();
    }


    // --- Exporty a Zmeny nastavení (mierne úpravy kvôli formátu dát) ---
    // Exporty (exportToPDF, sendPDF) zostávajú funkčne rovnaké, čítajú priamo z UI
    window.exportToPDF = function() { /* ... (bez zmien, číta z UI) ... */ }
    window.sendPDF = function() { /* ... (bez zmien, číta z UI) ... */ }

    // Zmeny nastavení volajú calculateAndUpdateTotals, ktorá uloží správne dáta
    window.changeDecimalPlaces = function() { decimalPlaces = parseInt(decimalPlacesSelect.value); localStorage.setItem('decimalPlaces', decimalPlaces); /* ... prepočet ... */ calculateAndUpdateTotals(); }
    window.updateEmployeeName = function() { employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); calculateAndUpdateTotals(); }
    window.updateSettings = function() { /* ... validácia a nastavenie hourlyWage, taxRate ... */ /* ... prepočet riadkov ... */ calculateAndUpdateTotals(); }

    // Zmena mesiaca/roka zostáva rovnaká, updateUI načíta nové dáta
    window.changeMonth = function() { const oldMonth = currentMonth; currentMonth = parseInt(monthSelect.value); console.log(`Zmena mesiaca...`); updateUI(); }
    window.changeYear = function() { const oldYear = currentYear; currentYear = parseInt(yearSelect.value); console.log(`Zmena roku...`); updateUI(); }
    function getDaysInMonth(month) { return new Date(currentYear, month + 1, 0).getDate(); }


    // --- ZÁLOHOVANIE A OBNOVA (UPRAVENÉ pre novú štruktúru) ---
    // --- ZMENA: Zálohovanie ---
    window.createBackup = function() {
      const key = `workData-${currentYear}-${currentMonth}`;
      const dataString = localStorage.getItem(key);
      if (dataString) {
        try {
            const dataObj = JSON.parse(dataString); // Očakáva {settings: {}, entries: {'1':{}, '2':{}}}

            if (!dataObj.settings || !dataObj.entries) {
                throw new Error("Lokálne dáta nemajú očakávanú štruktúru (settings/entries).");
            }

            const ws_data = [
              ["Deň", "Príchod", "Odchod", "Prestávka (h)"] // Hlavička pre dáta
            ];
            const daysInMonth = getDaysInMonth(currentMonth);
            // Iterujeme od 1 do počtu dní v mesiaci
            for (let dayNum = 1; dayNum <= daysInMonth; dayNum++) {
                const dayId = dayNum.toString();
                const entryData = dataObj.entries[dayId]; // Získame dáta pre deň
                if (entryData) { // Ak pre deň existuje záznam
                    const dayName = getDayName(currentYear, currentMonth, dayNum);
                    ws_data.push([
                        `${dayNum}. ${dayName}`,
                        entryData.start || "",
                        entryData.end || "",
                        entryData.breakTime ? parseFloat(entryData.breakTime.replace(',', '.')) : "" // Ukladáme ako číslo
                    ]);
                } else {
                    // Ak pre deň nie je záznam, môžeme pridať prázdny riadok alebo ho preskočiť
                    // Pre úplnosť pridáme riadok len s dňom
                    // const dayName = getDayName(currentYear, currentMonth, dayNum);
                    // ws_data.push([`${dayNum}. ${dayName}`, "", "", ""]);
                }
            }

            // Pridáme nastavenia na koniec
            ws_data.push([]);
            ws_data.push(["Nastavenia:", "Hodnota"]);
            const settings = dataObj.settings;
            ws_data.push(["Hodinová mzda", settings.hourlyWage]);
            ws_data.push(["Daňové percento (%)", settings.taxRate * 100]);
            ws_data.push(["Meno pracovníka", settings.employeeName]);
            ws_data.push(["Počet desatinných miest", settings.decimalPlaces]);
            ws_data.push(["Posledná aktualizácia", settings.lastUpdated ? new Date(settings.lastUpdated).toLocaleString('sk-SK') : "Neznáma"]);

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Formáty a šírky stĺpcov (podobne ako predtým, ale bez miezd v dátovej časti)
            const timeFormat = "hh:mm"; const breakFormat = "0.0";
            const dataEndRow = ws_data.findIndex(row => row[0] === "Nastavenia:") -1 || ws_data.length; // Index posledného dátového riadku
            for (let R = 1; R < dataEndRow; ++R) { // Riadky 1 až po nastavenia
                 if(ws[XLSX.utils.encode_cell({c:1, r:R})]) ws[XLSX.utils.encode_cell({c:1, r:R})].z = timeFormat; // Príchod
                 if(ws[XLSX.utils.encode_cell({c:2, r:R})]) ws[XLSX.utils.encode_cell({c:2, r:R})].z = timeFormat; // Odchod
                 if(ws[XLSX.utils.encode_cell({c:3, r:R})]) ws[XLSX.utils.encode_cell({c:3, r:R})].z = breakFormat; // Prestávka
             }
            ws['!cols'] = [ { wch: 12 }, { wch: 8 }, { wch: 8 }, { wch: 10 } ]; // Šírky len pre 4 stĺpce
            ws['!cols'][0].wch = 25; // Širší prvý stĺpec pre nastavenia

            XLSX.utils.book_append_sheet(wb, ws, `Výkaz ${getMonthName(currentMonth)}`);
            const safeEmployeeName = (settings.employeeName || '').replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane';
            XLSX.writeFile(wb, `Zaloha_BrunoCalc_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`);
            showSaveNotification('Záloha bola úspešne vytvorená.');
        } catch(error) {
             console.error('Chyba pri vytváraní zálohy:', error);
             showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message);
        }
      } else {
        showErrorNotification('Nie sú dostupné žiadne lokálne dáta na zálohu.');
      }
    };

    // --- ZMENA: Obnova zo zálohy ---
    window.restoreBackup = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx'; // ...
      input.onchange = function(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true });
            const ws = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });

            const headerRowIndex = rows.findIndex(row => row && row[0]?.toString().toLowerCase().includes("deň"));
            if (headerRowIndex === -1) throw new Error("Hlavička ('Deň', 'Príchod',...) nebola nájdená.");
            const header = rows[headerRowIndex];
            const dayIndex = header.findIndex(h => h?.toString().toLowerCase().includes("deň"));
            const startIndex = header.findIndex(h => h?.toString().toLowerCase().includes("príchod"));
            const endIndex = header.findIndex(h => h?.toString().toLowerCase().includes("odchod"));
            const breakIndex = header.findIndex(h => h?.toString().toLowerCase().includes("prestávka"));
            if (dayIndex === -1 || startIndex === -1 || endIndex === -1 || breakIndex === -1) {
                throw new Error("Nepodarilo sa nájsť stĺpce Deň, Príchod, Odchod, Prestávka.");
            }

            let dailyEntries = {}; // Objekt pre denné záznamy {'1': {...}, ...}
            let settings = {};
            let i = headerRowIndex + 1;

            // Načítanie dát riadkov
            for (; i < rows.length; i++) {
              const row = rows[i];
              if (!row || row.length === 0 || !(row[dayIndex]?.toString().match(/^\d+\./i))) break; // Koniec dát, ak nezačína číslom dňa

              const dayMatch = row[dayIndex].toString().match(/^(\d+)\./); // Získa číslo dňa
              if (dayMatch && dayMatch[1]) {
                  const dayId = dayMatch[1]; // ID dňa (string)
                  let startTimeStr = row[startIndex]?.toString() || "";
                  let endTimeStr = row[endIndex]?.toString() || "";
                  // Konverzia času z Excelu
                  if (!isNaN(parseFloat(startTimeStr)) && !startTimeStr.includes(':')) startTimeStr = XLSX.SSF.format('hh:mm', parseFloat(startTimeStr));
                  if (!isNaN(parseFloat(endTimeStr)) && !endTimeStr.includes(':')) endTimeStr = XLSX.SSF.format('hh:mm', parseFloat(endTimeStr));

                  dailyEntries[dayId] = {
                    start: startTimeStr,
                    end: endTimeStr,
                    breakTime: row[breakIndex] !== undefined ? row[breakIndex].toString().replace(',', '.') : ""
                  };
              }
            }

            // Načítanie nastavení
            for (; i < rows.length; i++) {
              const row = rows[i];
              if (row && row.length > 1 && row[0] && typeof row[0] === 'string') {
                 const key = row[0].toString().trim().toLowerCase();
                 const value = row[1]?.toString().trim() || "";
                 if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined;
                 else if (key.includes("daňové percento")) settings.taxRate = (parseFloat(value.replace(',', '.').replace('%', '')) || undefined) / 100;
                 else if (key.includes("meno pracovníka")) settings.employeeName = value || undefined;
                 else if (key.includes("počet desatinných miest")) settings.decimalPlaces = parseInt(value) || undefined;
              }
            }

            // Zostavenie finálneho objektu
            const backupData = {
              // Použijeme hodnoty z Excelu, inak fallback na aktuálne
              settings: {
                  hourlyWage: settings.hourlyWage !== undefined ? settings.hourlyWage : hourlyWage,
                  taxRate: settings.taxRate !== undefined ? settings.taxRate : taxRate,
                  employeeName: settings.employeeName !== undefined ? settings.employeeName : employeeName,
                  decimalPlaces: settings.decimalPlaces !== undefined ? settings.decimalPlaces : decimalPlaces,
                  lastUpdated: new Date().toISOString() // Vždy nový čas
              },
              entries: dailyEntries // Načítané denné záznamy
            };

            if (!confirm(`Načítaná záloha obsahuje ${Object.keys(dailyEntries).length} dní. Naozaj chcete prepísať dáta pre ${getMonthName(currentMonth)} ${currentYear}?`)) return;

            const dataString = JSON.stringify(backupData);
            localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString);
            parseAndApplyData(dataString); // Aplikujeme do UI
            showSaveNotification('Záloha bola úspešne obnovená.');

            if (currentUser && isOnline()) {
              saveToFirestore(); // Pošle obnovené dáta do cloudu
            }
          } catch (error) { /* ... (chybové hlásenie bez zmien) ... */ }
        };
        reader.onerror = function() { /* ... (chybové hlásenie bez zmien) ... */ }
        reader.readAsArrayBuffer(file);
      };
      input.click();
    };

    // --- INIT ---
    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed. User:', user ? user.email : 'None');
      currentUser = user;
      updateUI(); // Naštartuje UI a načítanie dát
    });

  </script>

  <!-- Registrácia Service Workera (BEZ ZMIEN) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => console.log('SW reg OK:', registration.scope))
          .catch(error => console.error('SW reg ERR:', error));
      });
    }
  </script>
</body>
</html>
