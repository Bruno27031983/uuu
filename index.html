<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Z√°kladn√© ≈°t√Ωly */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black; /* Upraven√© z predch√°dzaj√∫cej verzie, aby nebolo z√°visl√© na dark mode */
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start; /* Zmenen√© z center na flex-start pre lep≈°ie zarovnanie labelov */
    }
    /* ≈†t√Ωl pre tlaƒçidlo a presunut√© prvky */
    .settings > div, .settings > button#toggleSettingsBtn {
       margin: 2px 5px;
    }
    .settings > div {
      flex: 1 1 200px; /* Ponechan√© pre flexibilitu */
    }
    /* ≈†t√Ωl pre tlaƒçidlo na skrytie/zobrazenie */
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%; /* Tlaƒçidlo zaberie cel√∫ ≈°√≠rku na zaƒçiatku */
      margin-bottom: 10px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px 12px;
      cursor: pointer;
    }
    /* ≈†t√Ωly pre obsah nastaven√≠ */
    .settings label {
      display: block;
      margin-bottom: 2px;
    }
    #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
    }
    #settings-collapsible-content.visible {
        max-height: 400px; /* Upravte podƒæa potreby */
        opacity: 1;
        margin-top: 5px; /* Mal√Ω odstup po rozbalen√≠ */
    }
    /* Aplikuje sa na divy vn√∫tri rozbalovacieho obsahu */
    #settings-collapsible-content > div {
         flex: 1 1 200px; /* P√¥vodn√© pravidlo pre vn√∫torn√© divy */
         margin: 2px 5px; /* P√¥vodn√Ω margin */
    }

    /* ≈†t√Ωly pre tabuƒæku */
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
      table-layout: fixed;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
      word-wrap: break-word;
    }
    th {
      background-color: #f2f2f2;
    }

    /* --- ≈†√çRKA STƒπPCOV --- */
    th:nth-child(1), td:nth-child(1) { width: 13%; } /* De≈à */
    th:nth-child(2), td:nth-child(2), /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { width: 90px; } /* Odchod - ZMENEN√â z 30% */
    th:nth-child(4), td:nth-child(4) { width: 12%; text-align: center; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { width: 16%; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6), /* Hrub√° mzda */
    th:nth-child(7), td:nth-child(7) { width: 15%; text-align: right;} /* ƒåist√° mzda */
    th:nth-child(8), td:nth-child(8) { width: 10%; text-align: center; } /* Akcia */
    /* --- KONIEC ≈†√çROK STƒπPCOV --- */

    /* ≈†t√Ωly pre inputy a selecty */
    input[type="tel"], input[type="number"], input[type="text"], select {
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
      max-width: 100%;
    }
    input[type="number"], input[type="text"], select {
        width: 100%; /* Umo≈æn√≠ selectom a inputom vyplni≈• ≈°√≠rku rodiƒça (div) */
    }

    .result { /* ... */ } /* Ponechan√© pre pr√≠padn√© bud√∫ce pou≈æitie */
    .btn-container {
       display: flex;
       flex-wrap: wrap;
       gap: 10px;
       justify-content: center;
       margin-top: 20px;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      color: white;
      background-color: #5c67f2;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
      text-align: center;
      flex: 1 1 150px; /* Flexibilita tlaƒçidiel */
      max-width: 200px;
    }
    .btn:hover { background-color: #4a54e0; }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; padding: 15px 20px; } /* V√§ƒç≈°ie padding pre z√°lohu */
    .backup-btn:hover { background-color: #6a1bb2; }
    /* .highlight class odstr√°nen√° */
    #totalSalary {
      margin-top: 20px;
      padding: 15px;
      background-color: #e9ecef;
      border-radius: 4px;
      font-size: 16px;
      line-height: 1.5;
      border: 1px solid #dee2e6;
      text-align: center; /* Centrovan√Ω text */
    }
    #dataSizeContainer { /* ... */ } /* Ponechan√© pre pr√≠padn√© bud√∫ce pou≈æitie */
    #dataSizeText { /* ... */ }
    #dataSizeBar { /* ... */ }
    #dataSizeFill { /* ... */ }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }


    /* Responzivita */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div, .settings > button#toggleSettingsBtn { width: 100%; margin: 5px 0; flex-basis: auto; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; }
      #settings-collapsible-content.visible { max-height: 600px; /* Zv√Ω≈°en√© pre viac polo≈æiek */ }
      table { min-width: 600px; }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; max-width: none; }
      .backup-btn { padding: 15px 16px; }
      #totalSalary { font-size: 14px; /* Zmen≈°en√© pre mobil */ }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 12px; }
      table { min-width: 500px; }
      #settings-collapsible-content.visible { max-height: 700px; /* E≈°te viac miesta */ }
      #totalSalary { font-size: 12px; } /* E≈°te men≈°ie */
    }

    /* Notifik√°cie a Login forma */
    #saveNotification, #errorNotification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        text-align: center;
    }
    #saveNotification.show, #errorNotification.show {
        opacity: 1;
        visibility: visible;
    }
    #saveNotification { background-color: #4CAF50; }
    #errorNotification { background-color: #f44336; }
    #login-form {
        display: flex; /* Zmenen√© na flex pre lep≈°ie zarovnanie */
        flex-direction: column; /* Polo≈æky pod sebou */
        align-items: center; /* Centrovanie */
        gap: 10px; /* Medzera medzi prvkami */
        margin-bottom: 15px; /* Odstup odspodu */
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 100%; /* Pln√° ≈°√≠rka v r√°mci formy */
        max-width: 300px; /* Maxim√°lna ≈°√≠rka pre prehƒæadnos≈• */
        padding: 8px;
        margin-bottom: 5px; /* Mal√Ω odstup */
        border: 1px solid #ccc;
        border-radius: 3px;
        box-sizing: border-box;
    }
    #login-form .btn { /* ≈†pecifickej≈°√≠ ≈°t√Ωl pre tlaƒçidl√° vo forme */
        width: auto; /* Automatick√° ≈°√≠rka */
        padding: 8px 20px;
        flex-grow: 0; /* Zabra≈àuje roztiahnutiu */
        max-width: 150px; /* Obmedzenie ≈°√≠rky */
    }
    #login-form a { color: #007bff; text-decoration: none; font-size: 0.9em; }
    #login-form a:hover { text-decoration: underline; }
    /* Dark mode pre login link odstr√°nen√Ω */

    /* ≈†t√Ωly pre wrapper a ikonu hod√≠n */
    .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
        max-width: 100%;
        box-sizing: border-box;
    }
    .time-input-wrapper input[type="tel"] {
        flex-grow: 1;
        min-width: 45px;
        /* max-width a width odstr√°nen√©, riadi rodiƒç (td cez table-layout: fixed) */
    }
    .clock-icon {
        flex-shrink: 0;
        cursor: pointer;
        font-size: 1.3em;
        user-select: none;
        transition: transform 0.2s ease;
        padding: 2px;
        line-height: 1;
    }
    .clock-icon:hover { opacity: 0.8; }
    .clock-icon:active { transform: scale(0.9); }
    /* Dark mode pre ikonu hod√≠n odstr√°nen√Ω */

  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Vitaj sp√§≈• üëã</h1> <h2></h2> <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobrazi≈• nastavenia ‚ñº</button>
      <div id="settings-collapsible-content">
        <div>
          <label for="employeeNameInput">Meno pracovn√≠ka: </label>
          <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
        </div>
        <div>
          <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
          <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
        </div>
        <div>
          <label for="taxRateInput">Da≈àov√© percento (%): </label>
          <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
        </div>
        <div>
          <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
          <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        </div> <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
          <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
          <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
          <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>

      </div> <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Re≈æim tmav√©ho re≈æimu odstr√°nen√Ω

    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // Firebase Konfigur√°cia
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Skontroluj, ƒçi je kƒæ√∫ƒç st√°le platn√Ω a bezpeƒçn√Ω
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Firebase Inicializ√°cia
    const app = initializeApp(firebaseConfig);
    try {
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Nahraƒè vlastn√Ωm kƒæ√∫ƒçom reCAPTCHA v3 Site Key
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) { console.warn("Firebase App Check failed to initialize.", e); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Glob√°lne Premenn√© a Elementy
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = 10;
    let taxRate = 0.02;

    // Funkcia na aktualiz√°ciu pozdravu (upraven√° v predch√°dzaj√∫com kroku)
    function updateGreeting() {
        const nameToUse = employeeName || localStorage.getItem('employeeName') || '';
        if (nameToUse) mainTitle.textContent = `Vitaj sp√§≈• ${nameToUse.split(' ')[0]} üëã`;
        else mainTitle.textContent = 'Vitaj sp√§≈• üëã';
    }

    // Popul√°cia a nastavenie rokov
    function populateYearSelect() {
        const startYear = 2020; const endYear = 2030;
        yearSelect.innerHTML = '';
        for (let y = startYear; y <= endYear; y++) {
            const option = document.createElement('option'); option.value = y; option.textContent = y; yearSelect.appendChild(option);
        }
        yearSelect.value = currentYear;
    }
    populateYearSelect();

    // Inicializ√°cia hodn√¥t z localStorage alebo UI
    hourlyWage = parseFloat(localStorage.getItem('hourlyWage') || hourlyWageInput.value) || 10;
    taxRate = (parseFloat(localStorage.getItem('taxRatePercent') || taxRateInput.value) || 2) / 100;
    decimalPlaces = parseInt(localStorage.getItem('decimalPlaces') || decimalPlacesSelect.value) || 1;
    employeeName = localStorage.getItem('employeeName') || employeeNameInput.value || '';

    // Nastavenie UI prvkov
    monthSelect.value = currentMonth; yearSelect.value = currentYear; decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName; hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1);

    updateGreeting(); // Zavolanie funkcie na √∫vodn√© nastavenie pozdravu

    // Listener pre skrytie/zobrazenie nastaven√≠
    if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
            const isVisible = settingsCollapsibleContent.classList.toggle('visible');
            toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
        });
    }

    // Online/Offline monitoring a Notifik√°cie
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { const n = document.createElement('div'); n.textContent = message; n.style.cssText = `position:fixed; top:20px; right:20px; padding:10px 20px; border-radius:5px; background-color:${color}; color:white; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,0.2);`; document.body.appendChild(n); setTimeout(() => n.remove(), 3000); }
    function showErrorNotification(message) { const n = document.getElementById('errorNotification'); n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 4000); }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') { const n = document.getElementById('saveNotification'); n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 3000); }

    // Autentifik√°cia
    window.login = async () => { if (!isOnline()) return showErrorNotification('Ste offline.'); const e = document.getElementById('email').value, p = document.getElementById('password').value; if (!e || !p) return showErrorNotification('Zadajte email a heslo.'); try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { showErrorNotification(`Chyba prihl√°senia: ${mapFirebaseAuthError(err.code)}`); } };
    window.register = async () => { if (!isOnline()) return showErrorNotification('Ste offline.'); const e = document.getElementById('email').value, p = document.getElementById('password').value; if (!e || !p) return showErrorNotification('Zadajte email a heslo.'); if (p.length < 6) return showErrorNotification('Heslo min. 6 znakov.'); try { await createUserWithEmailAndPassword(auth, e, p); await createUserCollection(); } catch (err) { showErrorNotification(`Chyba registr√°cie: ${mapFirebaseAuthError(err.code)}`); } };
    window.logout = async () => { try { await signOut(auth); /* monthData = {}; */ } catch (err) { showErrorNotification(`Chyba odhl√°senia: ${err.message}`); } }; // monthData nie je definovan√© glob√°lne, zakomentovan√©
    window.resetPassword = async () => { if (!isOnline()) return showErrorNotification('Ste offline.'); const eInput = document.getElementById('email'), email = eInput.value; if (!email) { eInput.style.border = '1px solid red'; setTimeout(() => { eInput.style.border = '1px solid #ccc'; }, 3000); return showErrorNotification('Zadajte email.'); } eInput.style.border = '1px solid #ccc'; try { await sendPasswordResetEmail(auth, email); showSaveNotification(`Email na obnovu odoslan√Ω na ${email}.`); } catch (err) { showErrorNotification(`Chyba obnovy: ${mapFirebaseAuthError(err.code)}`); } };
    function mapFirebaseAuthError(code) { const map = {'auth/invalid-email':'Neplatn√Ω email.','auth/user-not-found':'Pou≈æ√≠vateƒæ nen√°jden√Ω.','auth/wrong-password':'Nespr√°vne heslo.','auth/email-already-in-use':'Email u≈æ existuje.','auth/weak-password':'Slab√© heslo.','auth/requires-recent-login':'Vy≈æaduje sa nov√© prihl√°senie.','auth/network-request-failed':'Chyba siete.','auth/missing-email':'Zadajte email.'}; return map[code] || code; }
    async function createUserCollection() { if (!auth.currentUser) return; const uRef = doc(db, 'users', auth.currentUser.uid); try { await setDoc(uRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true }); const iRef = doc(collection(uRef, 'workDays'), 'initial_setup'); await setDoc(iRef, { setupComplete: true }); } catch (err) { console.error('Chyba vytvorenia user kolekcie:', err); } }

    // UI Update a Naƒç√≠tanie d√°t
    function updateUI() { const lForm = document.getElementById('login-form'), uInfo = document.getElementById('user-info'), uEmail = document.getElementById('user-email'); createTable(); if (currentUser) { lForm.style.display = 'none'; uInfo.style.display = 'block'; uEmail.textContent = currentUser.email; loadInitialData(); } else { lForm.style.display = 'flex'; uInfo.style.display = 'none'; loadFromLocalStorageOnly(); if (!isOnline()) showErrorNotification('Ste offline.'); } }
    async function loadInitialData() { const lKey = `workData-${currentYear}-${currentMonth}`, localData = localStorage.getItem(lKey), pKey = `pendingSync-${currentYear}-${currentMonth}`, pData = localStorage.getItem(pKey); if (pData && isOnline() && currentUser) { await syncWithFirebase(); const uData = localStorage.getItem(lKey); if (uData) parseAndApplyData(uData); else await loadFromFirestoreAndApply(); } else if (localData) parseAndApplyData(localData); else if (isOnline() && currentUser) await loadFromFirestoreAndApply(); else calculateTotal(); }
    async function loadFromFirestoreAndApply() { if (!currentUser) return; try { const dRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`); const dSnap = await getDoc(dRef); if (dSnap.exists()) { const sData = dSnap.data(), dataStr = JSON.stringify(sData); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataStr); parseAndApplyData(dataStr); } else calculateTotal(); /* Ak vo FB niƒç nie je, len prepoƒç√≠taj */ } catch (err) { showErrorNotification(`Chyba naƒç√≠tania z Firebase: ${err.message}`); calculateTotal(); /* Pri chybe tie≈æ len prepoƒç√≠taj lok√°lne */ } }
    function loadFromLocalStorageOnly() { const lKey = `workData-${currentYear}-${currentMonth}`, lData = localStorage.getItem(lKey); if (lData) parseAndApplyData(lData); else calculateTotal(); /* Ak niƒç lok√°lne, len prepoƒç√≠taj */ }
    function parseAndApplyData(dataString) { try { const sData = JSON.parse(dataString); hourlyWage = sData.hourlyWage ?? hourlyWage; taxRate = sData.taxRate ?? taxRate; employeeName = sData.employeeName ?? employeeName; decimalPlaces = sData.decimalPlaces ?? decimalPlaces; hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1); employeeNameInput.value = employeeName; decimalPlacesSelect.value = decimalPlaces; updateGreeting(); localStorage.setItem('hourlyWage', hourlyWage); localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1)); localStorage.setItem('employeeName', employeeName); localStorage.setItem('decimalPlaces', decimalPlaces); const daysInMonth = getDaysInMonth(currentMonth); /* Z√≠skaj aktu√°lny poƒçet dn√≠ */ if (sData.data?.length) { const daysToProcess = Math.min(daysInMonth, sData.data.length); for (let i = 0; i < daysToProcess; i++) { const dayData = sData.data[i]; const dayIndex = i + 1; const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`); const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`); const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); if (startEl && endEl && breakEl) { startEl.value = dayData.start || ''; endEl.value = dayData.end || ''; breakEl.value = dayData.breakTime || ''; calculateRow(dayIndex); } } /* Resetuj dni nad r√°mec ulo≈æen√Ωch d√°t, ak existuj√∫ */ for (let i = daysToProcess + 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false); } } else { /* Ak v d√°tach nie je pole 'data', resetuj v≈°etky riadky */ for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false); } } calculateTotal(); } catch (err) { showErrorNotification(`Chyba spracovania d√°t: ${err.message}`); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false); } calculateTotal(); } }


    // Ukladanie d√°t
    function debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);
    function collectCurrentData() { const sData = { data: [], hourlyWage, taxRate, employeeName, decimalPlaces, lastUpdated: new Date().toISOString() }; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const s = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || ''; const e = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || ''; const b = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || ''; const g = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0'; const n = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0'; sData.data.push({ start: s, end: e, breakTime: b, gross: g, net: n }); } return sData; }
    async function saveToFirestore() { if (!currentUser) return; const saveData = collectCurrentData(); const pendingKey = `pendingSync-${currentYear}-${currentMonth}`; if (isOnline()) { try { const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`); await setDoc(docRef, saveData, { merge: true }); localStorage.removeItem(pendingKey); /* Odstr√°≈à ƒçakaj√∫ce d√°ta po √∫spe≈°nom ulo≈æen√≠ */ showSaveNotification('D√°ta synchronizovan√© s Firebase.'); } catch (err) { showErrorNotification(`Chyba ukladania do Firebase: ${err.message}`); localStorage.setItem(pendingKey, JSON.stringify(saveData)); /* Ulo≈æ do pending, ak cloud zlyh√° */ } } else { localStorage.setItem(pendingKey, JSON.stringify(saveData)); showSaveNotification('Ste offline. D√°ta ulo≈æen√© lok√°lne na synchroniz√°ciu.'); } }
    async function syncWithFirebase() { if (!currentUser || !isOnline()) return; const pendingKey = `pendingSync-${currentYear}-${currentMonth}`; const pendingDataStr = localStorage.getItem(pendingKey); if (pendingDataStr) { try { const dataToSync = JSON.parse(pendingDataStr); const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`); await setDoc(docRef, dataToSync, { merge: true }); /* Ulo≈æ synchronizovan√© d√°ta aj do hlavn√©ho local storage */ localStorage.setItem(`workData-${currentYear}-${currentMonth}`, pendingDataStr); localStorage.removeItem(pendingKey); /* Odstr√°≈à ich z pending */ showSaveNotification('Lok√°lne ulo≈æen√© d√°ta boli synchronizovan√©.'); /* Aplikuj d√°ta aj do UI */ parseAndApplyData(pendingDataStr); } catch (err) { showErrorNotification(`Chyba synchroniz√°cie lok√°lnych d√°t: ${err.message}`); } } }

    // Naƒç√≠tanie z Firebase tlaƒçidlom
    window.loadFromFirestore = async () => { if (!currentUser) return showErrorNotification('Pre naƒç√≠tanie z cloudu sa mus√≠te prihl√°si≈•.'); if (!isOnline()) return showErrorNotification('Ste offline. Sk√∫ste naƒç√≠ta≈• nesk√¥r.'); if (!confirm('Naozaj chcete prep√≠sa≈• aktu√°lne zobrazen√© d√°ta d√°tami z Firebase?')) return; try { const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const serverData = docSnap.data(); const dataStr = JSON.stringify(serverData); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataStr); localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); /* Odstr√°ni≈• pr√≠padn√© ƒçakaj√∫ce d√°ta */ parseAndApplyData(dataStr); showSaveNotification('D√°ta √∫spe≈°ne naƒç√≠tan√© z Firebase.'); } else { showErrorNotification('Pre tento mesiac sa vo Firebase nenach√°dzaj√∫ ≈æiadne d√°ta.'); /* Resetuj tabuƒæku, ak vo FB niƒç nie je */ const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false); calculateTotal(); } } catch (err) { showErrorNotification(`Chyba pri naƒç√≠tavan√≠ d√°t z Firebase: ${err.message}`); } };

    // Vytvorenie tabuƒæky a v√Ωpoƒçty
    function getDayName(year, month, day) { return new Date(year, month, day).toLocaleDateString('sk-SK', { weekday: 'short' }); }
    window.insertCurrentTime = (inputId) => { const inputElement = document.getElementById(inputId); if (inputElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); inputElement.value = `${hours}:${minutes}`; /* Manu√°lne zavolaj handleInput na prepoƒçet a form√°tovanie */ handleInput(inputElement, ''); } };
    function createTable() { const daysInMonth = getDaysInMonth(currentMonth); workDays.innerHTML = ''; const today = new Date(); const todayDate = today.getDate(); const todayMonth = today.getMonth(); const todayYear = today.getFullYear(); if (isNaN(daysInMonth) || daysInMonth <= 0) { console.error("Neplatn√Ω poƒçet dn√≠ v mesiaci:", daysInMonth); return; } for (let i = 1; i <= daysInMonth; i++) { const row = document.createElement('tr'); if (i === todayDate && currentMonth === todayMonth && currentYear === todayYear) { row.classList.add('current-day'); } const dayName = getDayName(currentYear, currentMonth, i); const startId = `start-${currentYear}-${currentMonth}-${i}`; const endId = `end-${currentYear}-${currentMonth}-${i}`; const breakId = `break-${currentYear}-${currentMonth}-${i}`; const totalId = `total-${currentYear}-${currentMonth}-${i}`; const grossId = `gross-${currentYear}-${currentMonth}-${i}`; const netId = `net-${currentYear}-${currentMonth}-${i}`; row.innerHTML = `<td>${i}. ${dayName}</td><td><div class="time-input-wrapper"><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}')"><span class="clock-icon" onclick="insertCurrentTime('${startId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span></div></td><td><div class="time-input-wrapper"><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}')"><span class="clock-icon" onclick="insertCurrentTime('${endId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span></div></td><td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td><td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td><td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td><td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td><td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>`; workDays.appendChild(row); } }
    window.handleInput = (input, nextId) => { formatAndMoveNext(input, nextId); calculateAndUpdateTotals(); };
    window.handleBreakInput = (day) => { const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if (breakInput) { let breakValue = parseFloat(breakInput.value); if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; /* Resetni ak je neplatn√© */ } } calculateRow(day); calculateAndUpdateTotals(); };
    function calculateAndUpdateTotals() { calculateTotal(); /* Po ka≈ædom prepoƒçte riadku ulo≈æ d√°ta */ const saveData = collectCurrentData(); const localKey = `workData-${currentYear}-${currentMonth}`; localStorage.setItem(localKey, JSON.stringify(saveData)); debouncedSaveToFirestore(); /* Zavolaj debounced funkciu pre cloud */ }
    function isValidTimeFormat(timeString) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
    function formatAndMoveNext(input, nextId) { let value = input.value.replace(/[^\d:]/g, ''); let originalValue = input.value; let cursorPos = input.selectionStart; /* Automatick√© pridanie ':' */ if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value += ':'; } /* Pr√≠pad, keƒè niekto nap√≠≈°e 4 ƒç√≠sla bez ':' */ else if (value.length === 4 && !value.includes(':')) { value = `${value.substring(0, 2)}:${value.substring(2)}`; } /* Pr√≠pad, keƒè niekto nap√≠≈°e 3 ƒç√≠sla a mal by pr√≠s≈• ':' */ else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = `${value.substring(0, 2)}:${value.substring(2)}`; } /* Odstr√°nenie ':' na zaƒçiatku */ value = value.replace(/^:/, ''); /* Zabr√°nenie viacn√°sobn√Ωm ':' */ if ((value.match(/:/g) || []).length > 1) { const parts = value.split(':'); value = `${parts[0]}:${parts.slice(1).join('')}`; } /* Obmedzenie na 5 znakov */ if (value.length > 5) { value = value.slice(0, 5); } /* Aktualiz√°cia hodnoty a kurzora len ak do≈°lo k zmene */ if (input.value !== value) { input.value = value; /* Pokus o inteligentn√© nastavenie kurzora */ try { if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); } else { input.setSelectionRange(cursorPos, cursorPos); } } catch (e) { /* Ignoruj chyby pri nastavovan√≠ kurzora */ } } const day = parseInt(input.id.split('-')[3]); /* Prepoƒçet riadku */ calculateRow(day); /* Presun na ƒèal≈°√≠ input, ak je form√°t platn√Ω a dƒ∫≈æka 5 */ if (value.length === 5 && isValidTimeFormat(value)) { if (nextId) { moveNext(input, nextId); } } }
    function moveNext(currentElement, nextInputId) { const nextElement = document.getElementById(nextInputId); if (nextElement) { nextElement.focus(); /* Oznaƒçenie textu, ak to nie je number input */ if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') { nextElement.select(); } } }
    function calculateRow(day) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return; const startTime = startInput.value; const endTime = endInput.value; const breakTimeHours = parseFloat(breakInput.value) || 0; /* Ak je ƒças neplatn√Ω, resetuj v√Ωpoƒçty */ if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`; grossInput.value = (0).toFixed(decimalPlaces); netInput.value = (0).toFixed(decimalPlaces); return; } const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number); /* Vytvorenie Date objektov pre ƒæahk√Ω v√Ωpoƒçet rozdielu */ const startDate = new Date(2000, 0, 1, startHours, startMinutes); let endDate = new Date(2000, 0, 1, endHours, endMinutes); /* O≈°etrenie pr√°ce cez polnoc */ if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); } let diffMinutes = (endDate.getTime() - startDate.getTime()) / 60000; /* Odpoƒç√≠tanie prest√°vky v min√∫tach */ diffMinutes -= (breakTimeHours * 60); /* Z√°porn√Ω ƒças nie je mo≈æn√Ω */ if (diffMinutes < 0) { diffMinutes = 0; } const decimalHours = diffMinutes / 60; const totalMinutesRounded = Math.round(diffMinutes); const hours = Math.floor(totalMinutesRounded / 60); const minutes = totalMinutesRounded % 60; /* Zobrazenie v√Ωsledku */ totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`; const grossSalary = Math.max(0, decimalHours * hourlyWage); grossInput.value = grossSalary.toFixed(decimalPlaces); updateNetSalary(day); /* V≈ædy aktualizuj ƒçist√∫ mzdu po prepoƒçte hrubej */ }
    function updateNetSalary(day) { const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!grossInput || !netInput) return; const grossSalary = parseFloat(grossInput.value) || 0; const netSalary = Math.max(0, grossSalary * (1 - taxRate)); netInput.value = netSalary.toFixed(decimalPlaces); }
    window.resetRow = (day, save = true) => { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if(start) start.value = ''; if(end) end.value = ''; if(breakEl) breakEl.value = ''; calculateRow(day); /* Prepoƒç√≠taj riadok s pr√°zdnymi hodnotami */ if (save) { calculateAndUpdateTotals(); /* Ak chceme ulo≈æi≈• zmenu (defaultne √°no) */ } };
    function calculateTotal() { let totalMinutes = 0; let totalGross = 0; let totalNet = 0; let daysWorked = 0; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value; const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value; const breakTime = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value) || 0; let dailyMinutes = 0; let dailyGross = 0; let dailyNet = 0; let hasEntry = false; if (isValidTimeFormat(start) && isValidTimeFormat(end)) { const [sH, sM] = start.split(':').map(Number); const [eH, eM] = end.split(':').map(Number); const sDate = new Date(2000, 0, 1, sH, sM); let eDate = new Date(2000, 0, 1, eH, eM); if (eDate < sDate) { eDate.setDate(eDate.getDate() + 1); } let diffM = (eDate.getTime() - sDate.getTime()) / 60000 - (breakTime * 60); if (diffM < 0) diffM = 0; dailyMinutes = diffM; const dailyHours = dailyMinutes / 60; dailyGross = Math.max(0, dailyHours * hourlyWage); dailyNet = Math.max(0, dailyGross * (1 - taxRate)); if (dailyMinutes > 0) { hasEntry = true; } } /* Zapoƒç√≠taj de≈à, aj keƒè m√° len zadan√Ω ƒças alebo prest√°vku, ale nulov√Ω v√Ωsledn√Ω ƒças */ if (start || end || breakTime > 0) { hasEntry = true; } totalMinutes += dailyMinutes; totalGross += dailyGross; totalNet += dailyNet; if (hasEntry) { daysWorked++; } } const totalMinutesRounded = Math.round(totalMinutes); const totalHours = Math.floor(totalMinutesRounded / 60); const totalMinutesRemainder = totalMinutesRounded % 60; const totalDecimalHours = totalMinutes / 60; const avgNet = daysWorked > 0 ? totalNet / daysWorked : 0; const avgMinutes = daysWorked > 0 ? totalMinutes / daysWorked : 0; const avgMinutesRounded = Math.round(avgMinutes); const avgHours = Math.floor(avgMinutesRounded / 60); const avgMinsRemainder = avgMinutesRounded % 60; const avgDecimalHours = avgMinutes / 60; totalSalaryDiv.innerHTML = `Zapoƒç√≠tan√Ωch dn√≠: ${daysWorked}<br>Celkov√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>Hrub√° mzda: ${totalGross.toFixed(decimalPlaces)} ‚Ç¨<br>ƒåist√° mzda: ${totalNet.toFixed(decimalPlaces)} ‚Ç¨<br>Priem. ƒçist√° mzda/de≈à: ${avgNet.toFixed(decimalPlaces)} ‚Ç¨<br><strong>Priem. ƒças/de≈à: ${avgHours}h ${avgMinsRemainder}m (${avgDecimalHours.toFixed(decimalPlaces)} h)</strong>`; }

    // Exporty a nastavenia
    function getMonthName(monthIndex) { return new Date(2000, monthIndex, 1).toLocaleDateString('sk-SK', { month: 'long' }); }
    window.exportToPDF = () => { try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); /* Sk√∫s prida≈• font, ktor√Ω podporuje SK znaky - napr. z CDN */ doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`); const totalTime = totalCell ? totalCell.textContent.trim() : ''; const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value||'0'; const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value||'0'; /* Zahr≈à riadok len ak existuje nejak√Ω z√°znam */ if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) { tableData.push([ `${i}. ${getDayName(currentYear, currentMonth, i)}`, startTime, endTime, breakTime || '0', totalTime, `${parseFloat(grossSalary).toFixed(decimalPlaces)} ‚Ç¨`, `${parseFloat(netSalary).toFixed(decimalPlaces)} ‚Ç¨` ]); } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)','Odpracovan√©','Hrub√° Mzda','ƒåist√° Mzda']], body:tableData, startY:38, theme:'grid', styles:{font:'Roboto',fontSize:9,cellPadding:2,valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:10,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{ 0:{cellWidth:25,halign:'left'}, 1:{cellWidth:18,halign:'center'}, 2:{cellWidth:18,halign:'center'}, 3:{cellWidth:22,halign:'center'}, 4:{cellWidth:35,halign:'center'}, 5:{cellWidth:27,halign:'right'}, 6:{cellWidth:27,halign:'right'} } }); const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(11); const totalText = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi,'\n').replace(/<\/?strong>/gi,'').replace(/&nbsp;/g,' ').replace(/‚Ç¨/g,' EUR'); doc.text(totalText, 14, finalY); const safeName = (employeeName||'Nezadane').replace(/[^a-zA-Z0-9]/g,'_'); doc.save(`Vykaz_prace_${safeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`); } catch(err) { showErrorNotification(`Chyba pri exporte do PDF: ${err.message}`); console.error("PDF Export Error:", err); } };
    window.sendPDF = () => { try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`Z√°znam doch√°dzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) { tableData.push([ `${i}. ${getDayName(currentYear, currentMonth, i)}`, startTime, endTime, breakTime || '0' ]); } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)']], body:tableData, startY:38, theme:'grid', styles:{font:'Roboto',fontSize:10,cellPadding:3,valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:11,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{ 0:{cellWidth:50,halign:'left'}, 1:{cellWidth:40,halign:'center'}, 2:{cellWidth:40,halign:'center'}, 3:{cellWidth:40,halign:'center'} } }); const pdfBlob = doc.output('blob'); const safeName = (employeeName||'Nezadane').replace(/[^a-zA-Z0-9]/g,'_'); const pdfFileName = `Dochadzka_${safeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, {type:'application/pdf'}); /* Pou≈æitie Web Share API, ak je dostupn√© */ if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) { navigator.share({ files: [pdfFile], title: `Doch√°dzka ${getMonthName(currentMonth)} ${currentYear}`, text: `Z√°znam doch√°dzky pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).catch(error => { if (error.name !== 'AbortError') { console.error('Chyba zdieƒæania:', error); showErrorNotification(`Chyba zdieƒæania: ${error.message}`); } }); } else { /* Fallback na stiahnutie s√∫boru, ak zdieƒæanie nie je mo≈æn√© */ showErrorNotification('Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom. S√∫bor bude stiahnut√Ω.'); doc.save(pdfFileName); } } catch(err) { showErrorNotification(`Chyba pri pr√≠prave PDF na odoslanie: ${err.message}`); console.error("Send PDF Error:", err); } };
    window.changeDecimalPlaces = () => { decimalPlaces = parseInt(decimalPlacesSelect.value); localStorage.setItem('decimalPlaces', decimalPlaces); /* Prepoƒç√≠taj cel√∫ tabuƒæku a s√∫hrn */ for (let i = 1; i <= getDaysInMonth(currentMonth); i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); } } calculateAndUpdateTotals(); };
    window.updateEmployeeName = () => { employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); calculateAndUpdateTotals(); /* Ulo≈æ√≠ zmenu mena spolu s ostatn√Ωmi d√°tami */ };
    window.updateSettings = () => { const newWage = parseFloat(hourlyWageInput.value); const newTaxPercent = parseFloat(taxRateInput.value); if (!isNaN(newWage) && newWage >= 0) { hourlyWage = newWage; } else { hourlyWageInput.value = hourlyWage; /* Vr√°≈• p√¥vodn√∫ hodnotu ak je vstup neplatn√Ω */ } if (!isNaN(newTaxPercent) && newTaxPercent >= 0) { taxRate = newTaxPercent / 100; } else { taxRateInput.value = (taxRate * 100).toFixed(1); /* Vr√°≈• p√¥vodn√∫ hodnotu */ } localStorage.setItem('hourlyWage', hourlyWage); localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1)); /* Prepoƒç√≠taj v≈°etko */ for (let i = 1; i <= getDaysInMonth(currentMonth); i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); } } calculateAndUpdateTotals(); /* Ulo≈æ√≠ zmeny */ };
    window.changeMonth = () => { currentMonth = parseInt(monthSelect.value); updateUI(); /* Naƒç√≠taj d√°ta pre nov√Ω mesiac */ };
    window.changeYear = () => { currentYear = parseInt(yearSelect.value); updateUI(); /* Naƒç√≠taj d√°ta pre nov√Ω rok */ };
    function getDaysInMonth(month) { /* Vr√°ti poƒçet dn√≠ pre aktu√°lne nastaven√Ω currentYear a zadan√Ω month (0-11) */ return new Date(currentYear, month + 1, 0).getDate(); }

    // Z√°loha a Obnova
    window.createBackup = () => { const localKey = `workData-${currentYear}-${currentMonth}`; const dataString = localStorage.getItem(localKey); if (dataString) { try { const dataObject = JSON.parse(dataString); const worksheet_data = [ ["De≈à","Pr√≠chod","Odchod","Prest√°vka (h)","Hrub√° Mzda (‚Ç¨)","ƒåist√° Mzda (‚Ç¨)"] ]; /* Pridaj d√°ta dn√≠ */ if (dataObject.data?.length) { const daysInMonth = getDaysInMonth(currentMonth); const dataToExport = dataObject.data.slice(0, daysInMonth); dataToExport.forEach((rowData, index) => { const dayNum = index + 1; worksheet_data.push([ `${dayNum}. ${getDayName(currentYear, currentMonth, dayNum)}`, rowData.start || "", rowData.end || "", rowData.breakTime || "", rowData.gross ? parseFloat(rowData.gross) : 0, rowData.net ? parseFloat(rowData.net) : 0 ]); }); } /* Pridaj nastavenia na koniec */ worksheet_data.push([], /* Pr√°zdny riadok pre oddelenie */ ["Nastavenia:", "Hodnota"], ["Hodinov√° mzda", dataObject.hourlyWage], ["Da≈àov√© percento (%)", dataObject.taxRate * 100], ["Meno pracovn√≠ka", dataObject.employeeName], ["Poƒçet desatinn√Ωch miest", dataObject.decimalPlaces], ["Posledn√° aktualiz√°cia", dataObject.lastUpdated ? new Date(dataObject.lastUpdated).toLocaleString('sk-SK') : "Nezn√°ma"] ); const workbook = XLSX.utils.book_new(); const worksheet = XLSX.utils.aoa_to_sheet(worksheet_data); /* Form√°tovanie buniek (ƒças a meny) */ const moneyFormat = `0.00" ‚Ç¨"`; const timeFormat = "hh:mm"; const breakFormat = "0.0"; const dataEndRow = (dataObject.data?.length || 0) + 1; /* +1 lebo d√°ta zaƒç√≠naj√∫ od druh√©ho riadku (index 1) */ for (let R = 1; R < dataEndRow; ++R) { /* Stƒ∫pce B a C (index 1 a 2) - ƒåas */ if(worksheet[XLSX.utils.encode_cell({c:1, r:R})]) worksheet[XLSX.utils.encode_cell({c:1, r:R})].z = timeFormat; if(worksheet[XLSX.utils.encode_cell({c:2, r:R})]) worksheet[XLSX.utils.encode_cell({c:2, r:R})].z = timeFormat; /* Stƒ∫pec D (index 3) - Prest√°vka */ if(worksheet[XLSX.utils.encode_cell({c:3, r:R})]) worksheet[XLSX.utils.encode_cell({c:3, r:R})].z = breakFormat; /* Stƒ∫pce E a F (index 4 a 5) - Mzdy */ if(worksheet[XLSX.utils.encode_cell({c:4, r:R})]) worksheet[XLSX.utils.encode_cell({c:4, r:R})].z = moneyFormat; if(worksheet[XLSX.utils.encode_cell({c:5, r:R})]) worksheet[XLSX.utils.encode_cell({c:5, r:R})].z = moneyFormat; } /* Nastavenie ≈°√≠rky stƒ∫pcov */ worksheet['!cols'] = [ {wch:12}, {wch:8}, {wch:8}, {wch:10}, {wch:14}, {wch:14} ]; /* Roz≈°√≠r prv√Ω stƒ∫pec, ak s√∫ tam nastavenia */ const settingsRowIndex = worksheet_data.findIndex(r => r[0] === "Nastavenia:"); if (settingsRowIndex !== -1) { worksheet['!cols'][0].wch = Math.max(worksheet['!cols'][0].wch, 25); /* Zv√§ƒç≈°i, ak je treba */ } XLSX.utils.book_append_sheet(workbook, worksheet, `V√Ωkaz ${getMonthName(currentMonth)}`); const safeName = (employeeName||'Nezadane').replace(/[^a-zA-Z0-9]/g,'_'); XLSX.writeFile(workbook, `Zaloha_BrunoCalc_${safeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`); showSaveNotification('Z√°loha bola √∫spe≈°ne vytvoren√°.'); } catch(err) { showErrorNotification(`Chyba pri vytv√°ran√≠ z√°lohy: ${err.message}`); console.error("Backup Error:", err); } } else { showErrorNotification('Nie s√∫ k dispoz√≠cii ≈æiadne d√°ta na z√°lohovanie pre tento mesiac.'); } };
    window.restoreBackup = () => { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.xlsx'; fileInput.onchange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; /* Pou≈æi {header: 1, defval: ""} pre pole pol√≠, zachov√° pr√°zdne bunky */ const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false }); /* N√°jdi hlaviƒçku */ const headerIndex = rows.findIndex(r => r && r[0]?.toString().toLowerCase().includes("de≈à")); if (headerIndex === -1) throw new Error("Hlaviƒçka tabuƒæky (stƒ∫pec 'De≈à') nebola n√°jden√° v s√∫bore."); const headers = rows[headerIndex]; /* N√°jdi indexy relevantn√Ωch stƒ∫pcov */ const dayIndex = headers.findIndex(h => h?.toLowerCase().includes("de≈à")); const startIndex = headers.findIndex(h => h?.toLowerCase().includes("pr√≠chod")); const endIndex = headers.findIndex(h => h?.toLowerCase().includes("odchod")); const breakIndex = headers.findIndex(h => h?.toLowerCase().includes("prest√°vka")); if ([dayIndex, startIndex, endIndex, breakIndex].includes(-1)) throw new Error("V s√∫bore ch√Ωbaj√∫ potrebn√© stƒ∫pce (De≈à, Pr√≠chod, Odchod, Prest√°vka)."); let backupDataArray = []; let backupSettings = {}; let rowIndex = headerIndex + 1; /* Prech√°dzaj riadky s d√°tami */ for (; rowIndex < rows.length; rowIndex++) { const row = rows[rowIndex]; /* Ukonƒçi cyklus, ak riadok nezaƒç√≠na ƒç√≠slom d≈àa alebo je pr√°zdny */ if (!row || !row[dayIndex]?.toString().match(/^\d+\./)) break; let startTime = row[startIndex]?.toString() || ""; let endTime = row[endIndex]?.toString() || ""; /* Konverzia Excel ƒçasu (ƒç√≠slo 0-1) na HH:MM, ak je potrebn√© */ if (!isNaN(parseFloat(startTime)) && parseFloat(startTime) >= 0 && parseFloat(startTime) <= 1 && !startTime.includes(':')) { startTime = XLSX.SSF.format('hh:mm', parseFloat(startTime)); } if (!isNaN(parseFloat(endTime)) && parseFloat(endTime) >= 0 && parseFloat(endTime) <= 1 && !endTime.includes(':')) { endTime = XLSX.SSF.format('hh:mm', parseFloat(endTime)); } backupDataArray.push({ start: startTime, end: endTime, /* Nahraƒè desatinn√∫ ƒçiarku bodkou pre prest√°vku */ breakTime: row[breakIndex]?.toString().replace(',', '.') || "", gross: "0", /* Mzdy sa prepoƒç√≠taj√∫ */ net: "0" }); } /* Prech√°dzaj riadky s nastaveniami */ for (; rowIndex < rows.length; rowIndex++) { const row = rows[rowIndex]; if (row && row.length > 1 && row[0]) { const key = row[0].toString().trim().toLowerCase(); const value = row[1]?.toString().trim() || ""; if (key.includes("hodinov√° mzda")) backupSettings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined; else if (key.includes("da≈àov√© percento")) backupSettings.taxRate = (parseFloat(value.replace(',', '.').replace('%', '')) || undefined) / 100; else if (key.includes("meno pracovn√≠ka")) backupSettings.employeeName = value || undefined; else if (key.includes("poƒçet desatinn√Ωch miest")) backupSettings.decimalPlaces = parseInt(value) || undefined; } } /* Zostav fin√°lny objekt */ const backupDataObject = { data: backupDataArray, hourlyWage: backupSettings.hourlyWage ?? hourlyWage, /* Pou≈æi aktu√°lne, ak v z√°lohe nie je */ taxRate: backupSettings.taxRate ?? taxRate, employeeName: backupSettings.employeeName ?? employeeName, decimalPlaces: backupSettings.decimalPlaces ?? decimalPlaces, lastUpdated: new Date().toISOString() }; /* Potvrdenie od pou≈æ√≠vateƒæa */ if (!confirm(`Naozaj chcete obnovi≈• d√°ta zo z√°lohy? Aktu√°lne d√°ta pre ${getMonthName(currentMonth)} ${currentYear} bud√∫ prep√≠san√© ${backupDataArray.length} d≈àami zo s√∫boru.`)) return; /* Ulo≈æ a aplikuj d√°ta */ const dataString = JSON.stringify(backupDataObject); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); parseAndApplyData(dataString); /* Vyma≈æ pr√≠padn√© pending d√°ta pre tento mesiac */ localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); showSaveNotification('D√°ta boli √∫spe≈°ne obnoven√© zo z√°lohy.'); /* Ak je pou≈æ√≠vateƒæ online, hneƒè synchronizuj s Firebase */ if (currentUser && isOnline()) { saveToFirestore(); } } catch (err) { showErrorNotification(`Chyba pri obnove d√°t zo z√°lohy: ${err.message}`); console.error("Restore Backup Error:", err); } }; reader.onerror = () => { showErrorNotification('Nastala chyba pri ƒç√≠tan√≠ s√∫boru.'); }; reader.readAsArrayBuffer(file); }; fileInput.click(); };

    // INIT - Sledovanie stavu prihl√°senia a inicializ√°cia UI
    onAuthStateChanged(auth, (user) => { currentUser = user; updateUI(); /* Aktualizuj UI podƒæa stavu prihl√°senia */ });

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uisti sa, ≈æe cesta je spr√°vna
          .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
          .catch(error => console.log('ServiceWorker registration failed: ', error));
      });
    }
  </script>
</body>
</html>
