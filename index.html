<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doch√°dzka</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="icons/icon-192x192.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#5c67f2">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <style>
    /* V≈†ETKY VA≈†E CSS ≈†T√ùLY ZOST√ÅVAJ√ö ROVNAK√â - SKOP√çRUJTE ICH SEM Z VA≈†EJ FUNKƒåNEJ VERZIE */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; font-size: 16px; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(244,244,244,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; font-size: 1.2em; color: #555; text-align: center; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    h1 { text-align: center; font-size: 2.5em; color: black; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; margin-bottom: 20px; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; font-size: 0.9em; }
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; table-layout: fixed; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; word-wrap: break-word; position: relative; }
    th { background-color: #f2f2f2; font-weight: bold; }
    th:nth-child(1), td:nth-child(1) { width: 40px; } th:nth-child(2), td:nth-child(2) { width: 110px; } th:nth-child(3), td:nth-child(3) { width: 110px; } th:nth-child(4), td:nth-child(4) { width: 90px; text-align: center; } th:nth-child(5), td:nth-child(5) { width: 130px;} th:nth-child(6), td:nth-child(6) { width: 150px;} th:nth-child(7), td:nth-child(7) { width: 100px; text-align: right;} th:nth-child(8), td:nth-child(8) { width: 100px; text-align: right;} th:nth-child(9), td:nth-child(9) { width: 70px; text-align: center; }
    input[type="tel"], input[type="number"], input[type="text"], select, textarea { width: 100%; padding: 7px; box-sizing: border-box; background-color: #ffffd0; font-size: 1em; border: 1px solid #ccc; border-radius: 3px; vertical-align: middle; }
    textarea { resize: vertical; min-height: 38px; }
    td:nth-child(6) textarea { min-height: 38px; max-height: 100px; overflow-y: auto; }
    .time-input-wrapper { display: flex; align-items: center; gap: 5px; position: relative; }
    .time-input-wrapper input[type="tel"] { flex-grow: 1; min-width: 45px; padding-right: 30px; }
    .clock-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.4em; color: #555; user-select: none; z-index: 2; }
    .clock-icon:hover { color: #007bff; opacity: 0.8; }
    .btn-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn { padding: 12px 18px; border: none; border-radius: 4px; color: white; background-color: #5c67f2; cursor: pointer; font-size: 1.0em; transition: background-color 0.3s ease; text-align: center; flex: 1 1 150px; max-width: 200px; box-sizing: border-box; }
    .btn:hover { background-color: #4a54e0; } .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; } .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; } .backup-btn { background-color: #8a2be2; padding: 18px 22px; } .backup-btn:hover { background-color: #6a1bb2; }
    #totalSalary { margin-top: 20px; padding: 18px; background-color: #e9ecef; border-radius: 4px; font-size: 1.1em; line-height: 1.6; border: 1px solid #dee2e6; text-align: center; }
    .current-day { background-color: #8a2be2; color: white; } .current-day input, .current-day select, .current-day textarea { background-color: #9932cc; color: white; }
    .logout-section { margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
    #user-info, #login-form { display: none; } #user-info span { font-size: 0.95em; color: #333; } #user-info .btn { min-width: 150px; width: auto; flex-grow: 0; padding: 8px 16px; font-size: 0.9em; max-width: 200px; }
    #installAppButton { padding: 12px 18px; border: none; border-radius: 4px; color: white; background-color: #28a745; cursor: pointer; font-size: 1.0em; transition: background-color 0.3s ease; text-align: center; flex: 1 1 150px; max-width: 200px; box-sizing: border-box; margin-top: 5px; }
    #installAppButton:hover { background-color: #218838; }
    @media (max-width: 768px) { body { padding: 5px; font-size: 15px; } .container { padding: 12px; max-width: 100%; } h1 { font-size: 2.0em; } h2 { font-size: 1.1em; } .settings { flex-direction: column; align-items: stretch; } .settings > div, .settings > details { width: 100%; margin: 5px 0; flex-basis: auto; } .collapsible-content { flex-direction: column; align-items: stretch; } .collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; } table { min-width: 750px; } th, td { padding: 8px; font-size: 1.0em; } input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 1.0em; padding: 8px; } .clock-icon { font-size: 1.5em; } .btn-container { flex-direction: column; align-items: center; } .btn, #installAppButton { max-width: none; font-size: 1.05em; width: 95%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 5px; box-sizing: border-box; height: 44px; padding: 0 20px; flex: none; } .backup-btn { padding: 0 22px; } #user-info .btn { width: 80%; font-size: 0.95em; padding: 10px 16px; height: auto; margin-bottom: 0; } #totalSalary { font-size: 1.0em; padding: 15px; } }
    @media (max-width: 480px) { body { font-size: 14px; } .container { padding: 10px; } h1 { font-size: 1.8em; } h2 { font-size: 1.0em; } th, td { font-size: 0.9em; padding: 7px; } input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 0.95em; padding: 8px; } .settings label { font-size: 1.0em; } .clock-icon { font-size: 1.6em; } .btn, #installAppButton { font-size: 0.95em; width: 95%; height: 42px; padding: 0 15px; flex: none; margin-bottom: 4px; } .backup-btn { padding: 0 15px; } #user-info .btn { width: 85%; padding: 10px 16px; height: auto; margin-bottom: 0; } table { min-width: 600px; } #totalSalary { font-size: 0.95em; padding: 12px; } }
    #saveNotification, #errorNotification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 5px; color: white; z-index: 10000; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: center; font-size: 0.9em; }
    #saveNotification.show, #errorNotification.show { opacity: 1; visibility: visible; } #saveNotification { background-color: #4CAF50; } #errorNotification { background-color: #f44336; }
    #login-form { flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
    #login-form input[type="email"], #login-form input[type="password"] { width: 100%; max-width: 300px; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; font-size: 1em; }
    #login-form .btn { width: auto; max-width: 150px; padding: 10px 22px; margin: 5px 0; font-size: 1em; height: auto; flex: initial; background-color: #4CAF50; color: white; }
    #login-form .btn:hover { background-color: #388e3c; } #login-form a { color: #007bff; text-decoration: none; font-size: 0.9em; } #login-form a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <div id="loader">Naƒç√≠tavam aplik√°ciu...</div>

  <div class="container" style="display: none;">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;"> <div id="login-form"> <input type="email" id="email" placeholder="Email"> <input type="password" id="password" placeholder="Heslo"> <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button> <button class="btn export-btn" onclick="register()">Registrova≈•</button> <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a> </div> </div>
    <h1 id="mainTitle">Doch√°dzka üëã</h1> <h2></h2>
    <div class="settings"> <div> <label for="monthSelect">Mesiac: </label> <select id="monthSelect" onchange="changeMonth()"> <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option> <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option> <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option> <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option> </select> </div> <details class="collapsible-settings"> <summary>ƒéal≈°ie nastavenia</summary> <div class="collapsible-content"> <div> <label for="employeeNameInput">Meno pracovn√≠ka: </label> <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()"> </div> <div> <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label> <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"> </div> <div> <label for="taxRateInput">Da≈àov√© percento (%): </label> <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"> </div> <div> <label for="yearSelect">Rok: </label> <select id="yearSelect" onchange="changeYear()"></select> </div> <div> <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label> <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"> <option value="1">1</option> <option value="2" selected>2</option> </select> </div> </div> </details> </div>
    <div class="table-container"> <table> <thead> <tr> <th>De≈à</th> <th>Pr√≠chod</th> <th>Odchod</th> <th>Prest√°vka</th> <th>Odpracovan√©</th> <th>Pozn√°mky</th> <th>Hrub√° Mzda (‚Ç¨)</th> <th>ƒåist√° Mzda (‚Ç¨)</th> <th>Akcia</th> </tr> </thead> <tbody id="workDays"> </tbody> </table> </div>
    <div id="totalSalary"></div>
    <div class="btn-container"> <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button> <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button> <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button> <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button> <button class="btn export-btn" onclick="loadFromFirestore()">Obnovi≈• z Cloudu</button> </div>
    <div class="logout-section"> <div id="user-info"> <span id="user-email"></span> <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button> </div> </div>
  </div>
  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    console.log("SCRIPT START: Modul sa zaƒçal vykon√°va≈•.");

    // --- Deklar√°cia glob√°lnych premenn√Ωch ---
    // DOM Elementy
    let workDaysTableBody, totalSalaryDiv, mainTitleElement, subTitleElement, hourlyWageInput, taxRateInput,
        monthSelect, yearSelect, decimalPlacesSelect, employeeNameInput, loaderElement, loginFormElement,
        userInfoElement, userEmailElement, mainContainerElement;

    // Stavov√© premenn√© aplik√°cie
    let currentUser = null;
    let firestoreListenerUnsubscribe = null;
    const currentDateGlobal = new Date();
    let currentMonth = currentDateGlobal.getMonth();
    let currentYear = currentDateGlobal.getFullYear();
    let decimalPlaces = 2;
    let employeeName = '';
    let hourlyWage = 10;
    let taxRate = 0.02;

    // Firebase slu≈æby
    let app;
    let authModule; 
    let dbModule;  

    // --- DEFIN√çCIE V≈†ETK√ùCH FUNKCI√ç ---
    // (Presu≈àte sem V≈†ETKY va≈°e defin√≠cie funkci√≠ z predch√°dzaj√∫cej odpovede)
    // Zaƒç√≠na funkciou isOnline() a konƒç√≠ funkciou syncWithFirebase()
    // Je absol√∫tne kƒæ√∫ƒçov√©, aby tento blok obsahoval V≈†ETKY funkcie PRED initializeAppState
    // a PRED priraden√≠m k window objektu.

    // Pr√≠klad niekoƒæk√Ωch funkci√≠ (dopl≈àte v≈°etky ostatn√©):
    function isOnline() { return navigator.onLine; }
    function getMonthName(monthIndex) { const months = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return months[monthIndex] || ''; }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Mesiac alebo rok nie s√∫ definovan√©!"); return new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate(); } return new Date(currentYear, month + 1, 0).getDate(); }
    function getDayName(year, month, day) { return new Date(year, month, day).toLocaleDateString('sk-SK', { weekday: 'short' }); }
    // ... VLO≈ΩTE SEM V≈†ETKY OSTATN√â DEFIN√çCIE FUNKCI√ç Z PREDCH√ÅDZAJ√öCEJ VERZIE K√ìDU ...
    // ... (vr√°tane IndexedDB, UI, Firebase logiky atƒè.) ...
    // ... a≈æ po defin√≠ciu `async function syncWithFirebase() { ... }` ...

    // --- Hlavn√° inicializaƒçn√° funkcia aplik√°cie ---
    // T√°to funkcia bude volan√° a≈æ v DOMContentLoaded
    function initializeAppState() {
        console.log("Sp√∫≈°≈•am initializeAppState...");
        if (!loaderElement || !workDaysTableBody || !mainContainerElement || !authModule || !dbModule ) {
            console.error("KRITICK√Å CHYBA: Z√°kladn√© DOM elementy alebo Firebase moduly (authModule, dbModule) neboli priraden√© PRED initializeAppState!");
            if (loaderElement) loaderElement.innerHTML = "Chyba inicializ√°cie aplik√°cie!";
            return; 
        }
        
        console.log("Zobrazujem loader na zaƒçiatku initializeAppState.");
        loaderElement.style.display = 'flex';
        
        populateYearSelect(); // Teraz by mala by≈• definovan√°
        loadInitialSettings(); // Teraz by mala by≈• definovan√°

        console.log("Nastavujem onAuthStateChanged listener. authModule je:", authModule ? "OK" : "NEDEFINOVAN√ù!");
        onAuthStateChanged(authModule, (user) => {
            console.log("onAuthStateChanged - stav pou≈æ√≠vateƒæa:", user ? user.uid : '≈æiadny pou≈æ√≠vateƒæ');
            currentUser = user;

            if (loginFormElement) loginFormElement.style.display = currentUser ? 'none' : 'flex';
            if (userInfoElement) userInfoElement.style.display = currentUser ? 'flex' : 'none';
            if (userEmailElement) userEmailElement.textContent = currentUser ? `Prihl√°sen√Ω: ${currentUser.email}` : '';

            if (workDaysTableBody) { 
                 workDaysTableBody.innerHTML = ''; 
                 createTable(); // Teraz by mala by≈• definovan√°
            } else {
                 console.error("CHYBA v onAuthStateChanged: workDaysTableBody je st√°le null!");
            }

            if (currentUser) {
                console.log("Pou≈æ√≠vateƒæ je prihl√°sen√Ω, nastavujem Firestore listener.");
                setupFirestoreListener(); // Teraz by mala by≈• definovan√°
            } else {
                if (firestoreListenerUnsubscribe) {
                    console.log('Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω / odhl√°sil sa, odhlasujem Firestore listener.');
                    firestoreListenerUnsubscribe();
                    firestoreListenerUnsubscribe = null;
                }
                console.log("Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, naƒç√≠tavam z localStorageOnly.");
                loadFromLocalStorageOnly(); // Teraz by mala by≈• definovan√°
                if (!isOnline()) {
                     showErrorNotification('Ste offline. Niektor√© funkcie m√¥≈æu by≈• obmedzen√©.');
                }
                if (loaderElement) {
                    console.log("Skr√Ωvam loader (≈æiadny pou≈æ√≠vateƒæ, listener sa nenastavuje).");
                    loaderElement.style.display = 'none';
                }
            }
            updateGreeting(); // Teraz by mala by≈• definovan√°
            if (mainContainerElement) mainContainerElement.style.display = 'block';
        });
    }
    
    // --- Priradenie funkci√≠ k window objektu (MUS√ç BY≈§ PO ICH DEFIN√çCII) ---
    // (Sem skop√≠rujte blok s `window.login = login;` atƒè. z predch√°dzaj√∫cej kompletnej odpovede)

    // --- Spustenie aplik√°cie ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded: DOM je pripraven√Ω.");
        
        // Priradenie DOM elementov
        workDaysTableBody = document.getElementById('workDays');
        totalSalaryDiv = document.getElementById('totalSalary');
        mainTitleElement = document.getElementById('mainTitle');
        subTitleElement = document.querySelector('h2');
        hourlyWageInput = document.getElementById('hourlyWageInput');
        taxRateInput = document.getElementById('taxRateInput');
        monthSelect = document.getElementById('monthSelect');
        yearSelect = document.getElementById('yearSelect');
        decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        employeeNameInput = document.getElementById('employeeNameInput');
        loaderElement = document.getElementById('loader');
        loginFormElement = document.getElementById('login-form');
        userInfoElement = document.getElementById('user-info');
        userEmailElement = document.getElementById('user-email');
        mainContainerElement = document.querySelector('.container');

        if (loaderElement) {
            loaderElement.style.display = 'flex';
            console.log("Loader zobrazen√Ω v DOMContentLoaded.");
        } else {
            console.error("Loader element nebol n√°jden√Ω v DOMContentLoaded!");
            alert("Kritick√° chyba UI: Loader sa nena≈°iel.");
            return;
        }
        if (!mainContainerElement) {
            console.error("Hlavn√Ω kontajner (.container) nebol n√°jden√Ω v DOMContentLoaded!");
            if(loaderElement) loaderElement.innerHTML = "Chyba: Hlavn√Ω kontajner aplik√°cie sa nena≈°iel!";
            return;
        }
        
        try {
            // Firebase Inicializ√°cia
            const firebaseConfigLocal = { /* ... VA≈†A KONFIGUR√ÅCIA ... */ 
                apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // PR√çKLAD, POU≈ΩITE VLASTN√ö
                authDomain: "uuuuu-f7ef9.firebaseapp.com",
                projectId: "uuuuu-f7ef9",
                storageBucket: "uuuuu-f7ef9.appspot.com",
                messagingSenderId: "456105865458",
                appId: "1:456105865458:web:101f0a4dcb455f174b606b",
            };
            app = initializeApp(firebaseConfigLocal);
            authModule = getAuth(app); 
            dbModule = getFirestore(app); 
            console.log("Firebase app, authModule, dbModule inicializovan√© v DOMContentLoaded. authModule je:", authModule ? "OK" : "NEDEFINOVAN√ù!");

            if (!authModule || !dbModule) { // Extra kontrola
                 throw new Error("Firebase authModule alebo dbModule sa nepodarilo spr√°vne inicializova≈•.");
            }

            initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // V√Å≈† KƒΩ√öƒå
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check inicializ√°cia zavolan√° (asynchr√≥nne na pozad√≠) v DOMContentLoaded.");

            // SKOP√çRUJTE SEM BLOK S PRIRADEN√çM FUNKCI√ç K WINDOW OBJEKTU (window.login = login; atƒè.)
            // Tento blok MUS√ç by≈• tu, PO defin√≠cii funkci√≠ a PO inicializ√°cii Firebase
            window.login = async () => { if (!authModule) { console.error("Login: authModule nie je inicializovan√©!"); return; } if (!isOnline()) return showErrorNotification('Ste offline.'); const e = document.getElementById('email').value, p = document.getElementById('password').value; if (!e || !p) return showErrorNotification('Zadajte email a heslo.'); try { await signInWithEmailAndPassword(authModule, e, p); } catch (err) { showErrorNotification(`Chyba prihl√°senia: ${mapFirebaseAuthError(err.code)}`); } };
            // ... (V≈†ETKY OSTATN√â window.funkcia = funkcia; priradenia) ...
            window.register = async () => { if (!authModule) { console.error("Register: authModule nie je inicializovan√©!"); return; } if (!isOnline()) return showErrorNotification('Ste offline.'); const e = document.getElementById('email').value, p = document.getElementById('password').value; if (!e || !p) return showErrorNotification('Zadajte email a heslo.'); if (p.length < 6) return showErrorNotification('Heslo mus√≠ ma≈• aspo≈à 6 znakov.'); try { await createUserWithEmailAndPassword(authModule, e, p); await createUserCollection(); } catch (err) { showErrorNotification(`Chyba registr√°cie: ${mapFirebaseAuthError(err.code)}`); } };
            window.logout = async () => { if (!authModule) { console.error("Logout: authModule nie je inicializovan√©!"); return; } if (!confirm("Ste si ist√≠, ≈æe sa chcete odhl√°si≈•?")) return; if (firestoreListenerUnsubscribe) { console.log('Odhlasujem Firestore listener pri odhl√°sen√≠ pou≈æ√≠vateƒæa.'); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; } try { await signOut(authModule); currentUser = null; if (workDaysTableBody) workDaysTableBody.innerHTML = ''; createTable(); loadInitialSettings(); calculateTotal(); updateGreeting(); if(loginFormElement) loginFormElement.style.display = 'flex'; if(userInfoElement) userInfoElement.style.display = 'none'; if(userEmailElement) userEmailElement.textContent = ''; } catch (err) { showErrorNotification(`Chyba odhl√°senia: ${err.message}`); } };
            window.resetPassword = async () => { if (!authModule) { console.error("ResetPassword: authModule nie je inicializovan√©!"); return; } if (!isOnline()) return showErrorNotification('Ste offline.'); const eInput = document.getElementById('email'), email = eInput.value; if (!email) { if(eInput) eInput.style.border = '1px solid red'; setTimeout(() => { if(eInput) eInput.style.border = '1px solid #ccc'; }, 3000); return showErrorNotification('Zadajte email.'); } if(eInput) eInput.style.border = '1px solid #ccc'; try { await sendPasswordResetEmail(authModule, email); showSaveNotification(`Email na obnovu hesla bol odoslan√Ω na ${email}.`); } catch (err) { showErrorNotification(`Chyba obnovy hesla: ${mapFirebaseAuthError(err.code)}`); } };
            window.changeMonth = () => { currentMonth = parseInt(monthSelect.value); localStorage.setItem('currentMonth', currentMonth.toString()); if (workDaysTableBody) workDaysTableBody.innerHTML = ''; createTable(); setupFirestoreListener(); updateGreeting(); };
            window.changeYear = () => { currentYear = parseInt(yearSelect.value); localStorage.setItem('currentYear', currentYear.toString()); if (workDaysTableBody) workDaysTableBody.innerHTML = ''; createTable(); setupFirestoreListener(); updateGreeting(); };
            window.insertCurrentTime = (inputId) => { const inputElement = document.getElementById(inputId); if (inputElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); inputElement.value = `${hours}:${minutes}`; window.handleInput(inputElement, ''); } };
            window.handleInput = (input, nextId) => { formatAndMoveNext(input, nextId); window.calculateAndUpdateTotals(); };
            window.handleBreakInput = (day) => { const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if (breakInput) { let breakValue = parseFloat(breakInput.value); if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; } } calculateRow(day); window.calculateAndUpdateTotals(); };
            window.calculateAndUpdateTotals = () => { calculateTotal(); debouncedSaveToFirestore(); };
            window.resetRow = _resetRowInternal;
            window.loadFromFirestore = async () => { if (!currentUser) return showErrorNotification('Pre obnovenie z cloudu sa mus√≠te prihl√°si≈•.'); if (!isOnline()) return showErrorNotification('Ste offline. Sk√∫ste obnovi≈• nesk√¥r, keƒè budete online.'); if (!confirm('Naozaj chcete manu√°lne obnovi≈• d√°ta z cloudu a znova naƒç√≠ta≈• sledovanie zmien?')) return; console.log("Manu√°lne obnovenie d√°t z Firebase a znovunastavenie listenera."); if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) { createTable(); } await setupFirestoreListener(); };
            window.updateEmployeeName = () => { if(!employeeNameInput) return; employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); window.calculateAndUpdateTotals(); };
            window.updateSettings = () => { if(!hourlyWageInput || !taxRateInput) return; const wageValue = hourlyWageInput.value; const taxValue = taxRateInput.value; let wageChanged = false; let taxChanged = false; if (wageValue === "") { if (hourlyWage !== 0) { hourlyWage = 0; wageChanged = true; } } else { const newWage = parseFloat(wageValue); if (!isNaN(newWage) && newWage >= 0) { if (hourlyWage !== newWage) { hourlyWage = newWage; wageChanged = true; } } else { hourlyWageInput.value = hourlyWage.toFixed(1); } } if (taxValue === "") { if (taxRate !== 0) { taxRate = 0; taxChanged = true; } } else { const newTaxPercent = parseFloat(taxValue); if (!isNaN(newTaxPercent) && newTaxPercent >= 0 && newTaxPercent <=100) { const newTaxDecimal = newTaxPercent / 100; if (taxRate !== newTaxDecimal) { taxRate = newTaxDecimal; taxChanged = true; } } else { taxRateInput.value = (taxRate * 100).toFixed(1); } } if (wageChanged) { localStorage.setItem('hourlyWage', hourlyWage.toString()); } if (taxChanged) { localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1)); } if (wageChanged || taxChanged) { for (let i = 1; i <= getDaysInMonth(currentMonth); i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); } } window.calculateAndUpdateTotals(); } };
            window.changeDecimalPlaces = () => { if(!decimalPlacesSelect) return; decimalPlaces = parseInt(decimalPlacesSelect.value); localStorage.setItem('decimalPlaces', decimalPlaces.toString()); for (let i = 1; i <= getDaysInMonth(currentMonth); i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); } } window.calculateAndUpdateTotals(); };
            window.exportToPDF = () => { /* ... Va≈°a existuj√∫ca logika ... */ try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; const noteValue = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value||'';  const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`); const totalTime = totalCell ? totalCell.textContent.trim() : '-'; const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value||''; const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value||''; if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) { tableData.push([ `${i}. ${getDayName(currentYear, currentMonth, i)}`, startTime, endTime, breakTime || '0', totalTime, noteValue, `${parseFloat(grossSalary).toFixed(decimalPlaces)} ‚Ç¨`, `${parseFloat(netSalary).toFixed(decimalPlaces)} ‚Ç¨` ]); } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)','Odpracovan√©', 'Pozn√°mky', 'Hrub√° Mzda','ƒåist√° Mzda']], body:tableData, startY:38, theme:'grid', styles:{font:'Roboto',fontSize:9,cellPadding:2,valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:10,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{ 0: { cellWidth: 15, halign: 'left' }, 1: { cellWidth: 17, halign: 'center' }, 2: { cellWidth: 17, halign: 'center' }, 3: { cellWidth: 12, halign: 'center' }, 4: { cellWidth: 35, halign: 'center' }, 5: { cellWidth: 28, halign: 'left' }, 6: { cellWidth: 28, halign: 'right' }, 7: { cellWidth: 30, halign: 'right' } } }); const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(11); const totalText = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi,'\n').replace(/<\/?strong>/gi,'').replace(/ /g,' ').replace(/‚Ç¨/g,' EUR'); doc.text(totalText, 14, finalY); const nameForFile = employeeName || 'Nezadane'; const safeName = nameForFile.replace(/[^a-zA-Z0-9√Å√°√Ñ√§ƒåƒçƒéƒè√â√©√ç√≠ƒπƒ∫ƒΩƒæ≈á≈à√ì√≥√î√¥≈î≈ï≈†≈°≈§≈•√ö√∫√ù√Ω≈Ω≈æ\s-]/g, '').replace(/\s+/g, '_'); const finalSafeName = safeName || 'Nezadane'; doc.save(`Vykaz_prace_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`); showSaveNotification("PDF v√Ωkaz bol √∫spe≈°ne vygenerovan√Ω."); } catch(err) { showErrorNotification(`Chyba pri exporte do PDF: ${err.message}`); console.error("PDF Export Error:", err); } };
            window.sendPDF = () => { /* ... Va≈°a existuj√∫ca logika ... */ try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`Z√°znam doch√°dzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); let daysWorkedCount = 0; for (let i = 1; i <= daysInMonth; i++) { const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; const noteValue = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value||'';  if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) { tableData.push([ `${i}. ${getDayName(currentYear, currentMonth, i)}`, startTime, endTime, breakTime || '0', noteValue ]); daysWorkedCount++; } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)', 'Pozn√°mky']], body:tableData, startY:38, theme:'grid', styles:{font:'Roboto',fontSize:10,cellPadding:3,valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:11,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{ 0:{cellWidth:40,halign:'left'}, 1:{cellWidth:30,halign:'center'}, 2:{cellWidth:30,halign:'center'}, 3:{cellWidth:30,halign:'center'}, 4:{cellWidth:40,halign:'left'}  } }); const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(11); doc.text(`Poƒçet zapoƒç√≠tan√Ωch dn√≠: ${daysWorkedCount}`, 14, finalY); const pdfBlob = doc.output('blob'); const nameForFile = employeeName || 'Nezadane'; const safeName = nameForFile.replace(/[^a-zA-Z0-9√Å√°√Ñ√§ƒåƒçƒéƒè√â√©√ç√≠ƒπƒ∫ƒΩƒæ≈á≈à√ì√≥√î√¥≈î≈ï≈†≈°≈§≈•√ö√∫√ù√Ω≈Ω≈æ\s-]/g, '').replace(/\s+/g, '_'); const finalSafeName = safeName || 'Nezadane'; const pdfFileName = `Dochadzka_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, {type:'application/pdf'}); if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) { showSaveNotification("PDF pripraven√© na zdieƒæanie..."); navigator.share({ files: [pdfFile], title: `Doch√°dzka ${getMonthName(currentMonth)} ${currentYear}`, text: `Z√°znam doch√°dzky pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).catch(error => { if (error.name !== 'AbortError') { console.error('Chyba zdieƒæania:', error); showErrorNotification(`Chyba zdieƒæania: ${error.message}`); } }); } else { showErrorNotification('Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom. S√∫bor bude stiahnut√Ω.'); doc.save(pdfFileName); } } catch(err) { showErrorNotification(`Chyba pri pr√≠prave PDF na odoslanie: ${err.message}`); console.error("Send PDF Error:", err); } };
            window.restoreBackup = () => { /* ... Va≈°a existuj√∫ca logika ... */ const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.xlsx'; fileInput.onchange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false }); const headerIndex = rows.findIndex(r => r && r[0]?.toString().toLowerCase().includes("de≈à")); if (headerIndex === -1) throw new Error("Hlaviƒçka tabuƒæky (stƒ∫pec 'De≈à') nebola n√°jden√° v s√∫bore."); const headers = rows[headerIndex]; const dayIndex = headers.findIndex(h => h?.toLowerCase().includes("de≈à")); const startIndex = headers.findIndex(h => h?.toLowerCase().includes("pr√≠chod")); const endIndex = headers.findIndex(h => h?.toLowerCase().includes("odchod")); const breakIndex = headers.findIndex(h => h?.toLowerCase().includes("prest√°vka")); const noteIndex = headers.findIndex(h => h?.toLowerCase().includes("pozn√°mky") || h?.toLowerCase().includes("note"));  if ([dayIndex, startIndex, endIndex, breakIndex].includes(-1)) throw new Error("V s√∫bore ch√Ωbaj√∫ potrebn√© stƒ∫pce (De≈à, Pr√≠chod, Odchod, Prest√°vka)."); let backupDataArray = []; let backupSettings = {}; let rowIndex = headerIndex + 1; for (; rowIndex < rows.length; rowIndex++) { const row = rows[rowIndex]; if (!row || !row[dayIndex]?.toString().match(/^\d+\./)) break; let startTime = row[startIndex]?.toString() || ""; let endTime = row[endIndex]?.toString() || ""; if (!isNaN(parseFloat(startTime)) && parseFloat(startTime) >= 0 && parseFloat(startTime) <= 1 && !startTime.includes(':')) { startTime = XLSX.SSF.format('hh:mm', parseFloat(startTime)); } if (!isNaN(parseFloat(endTime)) && parseFloat(endTime) >= 0 && parseFloat(endTime) <= 1 && !endTime.includes(':')) { endTime = XLSX.SSF.format('hh:mm', parseFloat(endTime)); } const noteFromFile = noteIndex !== -1 ? (row[noteIndex]?.toString() || "") : "";  backupDataArray.push({ start: startTime, end: endTime, breakTime: row[breakIndex]?.toString().replace(',', '.') || "", note: noteFromFile,  gross: "0", net: "0" }); } for (; rowIndex < rows.length; rowIndex++) { const row = rows[rowIndex]; if (row && row.length > 1 && row[0]) { const key = row[0].toString().trim().toLowerCase(); const value = row[1]?.toString().trim() || ""; if (key.includes("hodinov√° mzda")) backupSettings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined; else if (key.includes("da≈àov√© percento")) backupSettings.taxRatePercent = parseFloat(value.replace(',', '.').replace('%', '')) || undefined; else if (key.includes("meno pracovn√≠ka")) backupSettings.employeeName = value || undefined; else if (key.includes("poƒçet desatinn√Ωch miest")) backupSettings.decimalPlaces = parseInt(value) || undefined; } } const restoredHourlyWage = backupSettings.hourlyWage ?? hourlyWage; const restoredTaxRatePercent = backupSettings.taxRatePercent ?? (taxRate * 100); const restoredEmployeeName = backupSettings.employeeName ?? employeeName; const restoredDecimalPlaces = backupSettings.decimalPlaces ?? decimalPlaces; const backupDataObject = { data: backupDataArray, hourlyWage: restoredHourlyWage, taxRate: restoredTaxRatePercent / 100, employeeName: restoredEmployeeName, decimalPlaces: restoredDecimalPlaces, lastUpdated: new Date().toISOString() }; if (!confirm(`Naozaj chcete obnovi≈• d√°ta zo z√°lohy? Aktu√°lne d√°ta pre ${getMonthName(currentMonth)} ${currentYear} bud√∫ prep√≠san√© ${backupDataArray.length} d≈àami zo s√∫boru. Nastavenia (mzda, da≈à atƒè.) bud√∫ tie≈æ aktualizovan√© podƒæa z√°lohy.`)) return; const dataString = JSON.stringify(backupDataObject); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); parseAndApplyData(dataString); if (currentUser) { clearPendingSyncForMonth(currentUser.uid, currentYear, currentMonth); saveToFirestore(); } } catch (err) { showErrorNotification(`Chyba pri obnove d√°t zo z√°lohy: ${err.message}`); console.error("Restore Backup Error:", err); } }; reader.onerror = () => { showErrorNotification('Nastala chyba pri ƒç√≠tan√≠ s√∫boru.'); }; reader.readAsArrayBuffer(file); }; fileInput.click(); };
            window.createBackup = () => { /* ... Va≈°a existuj√∫ca logika ... */ const localKey = `workData-${currentYear}-${currentMonth}`; const dataString = localStorage.getItem(localKey); if (dataString) { try { const dataObject = JSON.parse(dataString); const worksheet_data = [ ["De≈à","Pr√≠chod","Odchod","Prest√°vka (h)", "Pozn√°mky", "Hrub√° Mzda (‚Ç¨)","ƒåist√° Mzda (‚Ç¨)"] ]; if (dataObject.data?.length) { const daysInMonth = getDaysInMonth(currentMonth); const dataToExport = dataObject.data.slice(0, daysInMonth); dataToExport.forEach((rowData, index) => { const dayNum = index + 1; worksheet_data.push([ `${dayNum}. ${getDayName(currentYear, currentMonth, dayNum)}`, rowData.start || "", rowData.end || "", rowData.breakTime || "", rowData.note || "", rowData.gross ? parseFloat(rowData.gross) : 0, rowData.net ? parseFloat(rowData.net) : 0 ]); }); } worksheet_data.push([], ["Nastavenia:", "Hodnota"], ["Hodinov√° mzda", hourlyWage], ["Da≈àov√© percento (%)", taxRate * 100], ["Meno pracovn√≠ka", employeeName], ["Poƒçet desatinn√Ωch miest", decimalPlaces], ["Posledn√° aktualiz√°cia", dataObject.lastUpdated?new Date(dataObject.lastUpdated).toLocaleString('sk-SK'):"Nezn√°ma"]); const workbook = XLSX.utils.book_new(); const worksheet = XLSX.utils.aoa_to_sheet(worksheet_data); const moneyFormat = `0.00" ‚Ç¨"`; const timeFormat = "hh:mm"; const breakFormat = "0.0"; const dataEndRow = (dataObject.data?.length||0)+1; for (let R=1; R<dataEndRow; ++R) { if(worksheet[XLSX.utils.encode_cell({c:1,r:R})]) worksheet[XLSX.utils.encode_cell({c:1,r:R})].z=timeFormat; if(worksheet[XLSX.utils.encode_cell({c:2,r:R})]) worksheet[XLSX.utils.encode_cell({c:2,r:R})].z=timeFormat; if(worksheet[XLSX.utils.encode_cell({c:3,r:R})]) worksheet[XLSX.utils.encode_cell({c:3,r:R})].z=breakFormat; if(worksheet[XLSX.utils.encode_cell({c:5,r:R})]) worksheet[XLSX.utils.encode_cell({c:5,r:R})].z=moneyFormat;  if(worksheet[XLSX.utils.encode_cell({c:6,r:R})]) worksheet[XLSX.utils.encode_cell({c:6,r:R})].z=moneyFormat;  } worksheet['!cols'] = [ {wch:12}, {wch:8}, {wch:8}, {wch:10}, {wch:20},  {wch:14}, {wch:14} ]; const settingsRowIndex = worksheet_data.findIndex(r=>r[0]==="Nastavenia:"); if(settingsRowIndex!==-1) { worksheet['!cols'][0].wch=Math.max(worksheet['!cols'][0].wch, 25); } XLSX.utils.book_append_sheet(workbook, worksheet, `V√Ωkaz ${getMonthName(currentMonth)}`); const nameForFile = employeeName || 'Nezadane'; const safeName = nameForFile.replace(/[^a-zA-Z0-9√Å√°√Ñ√§ƒåƒçƒéƒè√â√©√ç√≠ƒπƒ∫ƒΩƒæ≈á≈à√ì√≥√î√¥≈î≈ï≈†≈°≈§≈•√ö√∫√ù√Ω≈Ω≈æ\s-]/g, '').replace(/\s+/g, '_'); const finalSafeName = safeName || 'Nezadane'; XLSX.writeFile(workbook, `Zaloha_Dochadzka_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`); showSaveNotification('Z√°loha bola √∫spe≈°ne vytvoren√°.'); } catch(err) { showErrorNotification(`Chyba pri vytv√°ran√≠ z√°lohy: ${err.message}`); console.error("Backup Error:", err); } } else { showErrorNotification('Nie s√∫ k dispoz√≠cii ≈æiadne d√°ta na z√°lohovanie pre tento mesiac.'); } };


            // A≈æ po defin√≠cii v≈°etk√Ωch funkci√≠, ktor√© initializeAppState vol√°
            initializeAppState();

        } catch (error) {
            console.error("KRITICK√Å CHYBA poƒças inicializ√°cie v DOMContentLoaded:", error);
            if (loaderElement) {
                loaderElement.innerHTML = `Nastala kritick√° chyba pri ≈°tarte aplik√°cie.<br><small>${error.message}</small>`;
                // V tomto pr√≠pade loader zostane viditeƒæn√Ω s chybou
            }
        }

        if ('serviceWorker' in navigator) { 
            navigator.serviceWorker.addEventListener('message', event => { 
              if (event.data && event.data.type === 'SW_LOG') { 
                  const logPayload = event.data.payload;
                  const message = logPayload.message; 
                  if (logPayload.logType === 'error') {
                      console.error(message);
                  } else if (logPayload.logType === 'warn') {
                      console.warn(message);
                  } else {
                      console.log(message);
                  }
              }
            }); 
        }
        setTimeout(() => { 
            if (loaderElement && getComputedStyle(loaderElement).display !== 'none' && !loaderElement.textContent.startsWith("Chyba")) { 
                console.warn("Fallback Timeout: Loader bol st√°le viditeƒæn√Ω po 7 sekund√°ch (a nie je chyba Firebase), n√∫tene skr√Ωvam a zobrazujem kontajner.");
                loaderElement.style.display = 'none';
                if (mainContainerElement) mainContainerElement.style.display = 'block';
            } else if (loaderElement && getComputedStyle(loaderElement).display !== 'none' && loaderElement.textContent.startsWith("Chyba")) {
                console.warn("Fallback Timeout: Loader zobrazuje chybu, nech√°vam ho viditeƒæn√Ω.");
            }
        }, 7000);
    });

    // PWA in≈°talaƒçn√° logika
    let deferredPrompt; /* ... k√≥d z predch√°dzaj√∫cej odpovede ... */ const installButtonContainer = document.querySelector('.btn-container'); window.addEventListener('beforeinstallprompt', (e) => { console.log('beforeinstallprompt udalos≈• zachyten√°'); e.preventDefault(); deferredPrompt = e; const installButtonId = 'installAppButton'; let installButton = document.getElementById(installButtonId); if (!installButton) { installButton = document.createElement('button'); installButton.id = installButtonId; installButton.classList.add('btn'); installButton.textContent = 'Nain≈°talova≈• Doch√°dzku'; if (installButtonContainer && installButtonContainer.lastChild) { installButtonContainer.insertBefore(installButton, installButtonContainer.lastChild.nextSibling); } else if (installButtonContainer) { installButtonContainer.appendChild(installButton); } else { console.warn('.btn-container nebol n√°jden√Ω pre in≈°talaƒçn√© tlaƒçidlo.'); } console.log('In≈°talaƒçn√© tlaƒçidlo pridan√©.'); } installButton.style.display = 'block'; installButton.onclick = async () => { console.log('Kliknut√© na in≈°talaƒçn√© tlaƒçidlo'); if (deferredPrompt) { installButton.style.display = 'none'; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; console.log(`Odpoveƒè na in≈°tal√°ciu: ${outcome}`); deferredPrompt = null; } else { console.log('deferredPrompt nie je dostupn√Ω.'); } }; }); window.addEventListener('appinstalled', () => { console.log('PWA bola nain≈°talovan√°'); const installButton = document.getElementById('installAppButton'); if (installButton) { installButton.style.display = 'none'; } deferredPrompt = null; });
  </script>

  <script>
    // Service Worker registr√°cia
    if ('serviceWorker' in navigator) { /* ... k√≥d z predch√°dzaj√∫cej odpovede ... */ window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js') .then(registration => { console.log('ServiceWorker registr√°cia √∫spe≈°n√°, scope: ', registration.scope); }) .catch(error => { console.log('ServiceWorker registr√°cia zlyhala: ', error); }); }); }
  </script>
</body>
</html>
