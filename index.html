  <!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Základné štýly - bez zmien */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) {
      width: 25%;
    }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8) {
      width: 8.33%;
    }
    input[type="tel"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    .container.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    table.dark-mode {
      background-color: #555;
      color: #f4f4f4;
    }
    th.dark-mode {
      background-color: #666;
    }
    td.dark-mode {
      background-color: #444;
      color: #f4f4f4;
    }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode {
      background-color: #666;
      color: white;
    }
    .btn.dark-mode {
      color: #333;
    }
    .reset-btn.dark-mode {
      background-color: #d32f2f;
    }
    .export-btn.dark-mode {
      background-color: #388e3c;
    }
    .backup-btn.dark-mode {
      background-color: #6a1bb2;
    }
    #totalSalary.dark-mode {
      background-color: #2c3e50;
    }
    .current-day.dark-mode {
      background-color: #4a0e8f;
      color: #fff;
    }
    .current-day.dark-mode input {
      background-color: #5c1db3;
      color: #fff;
    }
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                     0 0 20px rgba(255, 255, 255, 0.3),
                     0 0 30px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 255, 255, 1),
                     0 0 30px rgba(255, 255, 255, 0.9),
                     0 0 40px rgba(255, 255, 255, 0.7);
      }
    }
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1em;
      }
      .settings {
        flex-direction: column;
        align-items: stretch;
      }
      .settings > div {
        flex: 1 1 auto;
        margin: 10px 0;
      }
      table {
        min-width: 800px;
      }
      th, td {
        padding: 6px;
        font-size: 0.8em;
      }
      .btn-container {
        flex-direction: column;
        align-items: stretch;
      }
      .btn {
        flex: 1 1 auto;
        font-size: 14px;
        padding: 8px 16px;
        margin: 5px 0;
      }
      .backup-btn {
        padding: 15px 16px;
      }
      #totalSalary {
        font-size: 16px;
      }
      #dataSizeContainer {
        font-size: 12px;
      }
      .table-container {
        overflow-x: auto;
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.7em;
      }
      .btn {
        font-size: 12px;
        padding: 6px 12px;
      }
      .backup-btn {
        padding: 15px 12px;
      }
      .settings label {
        font-size: 0.9em;
      }
      input[type="tel"], input[type="number"], input[type="text"] {
        font-size: 12px;
      }
      table {
        min-width: 800px;
      }
    }
    #saveNotification, #errorNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show {
      display: block;
      opacity: 1;
    }
    #saveNotification {
      background-color: #4CAF50;
      color: white;
    }
    #errorNotification {
      background-color: #f44336;
      color: white;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 200px;
      margin: 5px auto;
      display: block;
    }
    #login-form .btn {
      width: 120px;
      margin: 5px 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Dynamicky generované roky -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
    </div>
  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // ... (bez zmeny)
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.firebasestorage.app",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    // ... (bez zmeny)
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);


    // -------------------- GLOBÁLNE PREMENNÉ --------------------
    // ... (bez zmeny)
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(hourlyWageInput.value);
    let taxRate = parseFloat(taxRateInput.value) / 100;
    let monthData = {};


    // -------------------- FUNKCIE PRE ROKY (select) --------------------
    // ... (bez zmeny)
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }
    populateYearSelect();

    // Nastavenie predvolených hodnôt
    // ... (bez zmeny)
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;


    // -------------------- MONITOROVANIE ONLINE/OFFLINE --------------------
    // ... (bez zmeny)
    function isOnline() {
      return navigator.onLine;
    }
    window.addEventListener('online', () => {
      console.log('Zariadenie je online');
      showStatusNotification('Online', 'green');
      // Tu už voláme syncWithFirebase, ak je používateľ prihlásený
      if (currentUser) {
          console.log('Attempting sync after coming online...');
          syncWithFirebase().catch(error => {
              console.error('Error during sync after coming online:', error);
          });
      }
    });
    window.addEventListener('offline', () => {
      console.log('Zariadenie je offline');
      showStatusNotification('Offline', 'red');
    });
    function showStatusNotification(message, color) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.backgroundColor = color;
      notification.style.color = 'white';
      notification.style.zIndex = '1000';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    function showErrorNotification(message) {
      const notification = document.getElementById('errorNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') {
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 2000);
    }

    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    // ... (funkcie login, register, logout bez zmeny)
    window.login = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Prihlásenie je možné iba online.');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // currentUser sa nastaví cez onAuthStateChanged
        // updateUI() sa zavolá cez onAuthStateChanged
      } catch (error) {
        showErrorNotification('Chyba pri prihlásení: ' + error.message);
      }
    }

    window.register = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Registrácia je možná iba online.');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // currentUser sa nastaví cez onAuthStateChanged
        await createUserCollection(); // Vytvoríme kolekciu hneď
        // updateUI() sa zavolá cez onAuthStateChanged
      } catch (error) {
        showErrorNotification('Chyba pri registrácii: ' + error.message);
      }
    }

    window.logout = async function() {
      try {
        await signOut(auth);
        // currentUser sa nastaví na null cez onAuthStateChanged
        // updateUI() sa zavolá cez onAuthStateChanged
        monthData = {}; // Reset lokálnych dát po odhlásení
        // createTable() sa zavolá v updateUI
      } catch (error) {
        showErrorNotification('Chyba pri odhlásení: ' + error.message);
      }
    }

    async function createUserCollection() {
      // Táto funkcia teraz berie currentUser priamo z globálnej premennej
      if (currentUser) {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          email: currentUser.email,
          createdAt: new Date()
        }, { merge: true });

        const initialDocRef = doc(collection(userRef, 'workDays'), 'initial');
        await setDoc(initialDocRef, { created: true }); // Len aby kolekcia nebola prázdna
      } else {
          console.error("Cannot create user collection, currentUser is null");
      }
    }


    function updateUI() {
      const loginForm = document.getElementById('login-form');
      const userInfo = document.getElementById('user-info');
      const userEmail = document.getElementById('user-email');

      if (currentUser) {
        loginForm.style.display = 'none';
        userInfo.style.display = 'block';
        userEmail.textContent = currentUser.email;
        // Najprv vytvoríme tabuľku, potom načítame dáta
        createTable();
        // loadFromFirestore sa teraz volá z createTable na konci
      } else {
        loginForm.style.display = 'block';
        userInfo.style.display = 'none';
        // Zobrazíme prázdnu tabuľku
        createTable();
        if (!isOnline()) {
          showErrorNotification('Ste offline. Prihláste sa, keď budete online.');
        }
      }
    }

    // -------------------- Ukladanie do Firestore a localStorage s debounce --------------------
    // ... (debounce, saveToFirestore bez zmeny)
     function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 500); // Mierne zvýšený debounce čas

    async function saveToFirestore() {
      // Získanie aktuálnych dát z tabuľky
      const currentTableData = [];
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
          const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
          const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
          const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
          const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

          const start = startElement ? startElement.value : '';
          const end = endElement ? endElement.value : '';
          const breakTime = breakElement ? breakElement.value : '';
          const gross = grossElement ? grossElement.value : '0.00';
          const net = netElement ? netElement.value : '0.00';

          currentTableData.push({ start, end, breakTime, gross, net });
        }

      const saveData = {
        data: currentTableData,
        hourlyWage: hourlyWage,
        taxRate: taxRate,
        employeeName: employeeName,
        decimalPlaces: decimalPlaces,
        lastUpdated: new Date().toISOString()
      };

      const localKey = `workData-${currentYear}-${currentMonth}`;
      const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;

      // Vždy uložíme do hlavného localStorage kľúča
      console.log('Saving data to main localStorage:', localKey);
      localStorage.setItem(localKey, JSON.stringify(saveData));

      if (currentUser) {
          if (isOnline()) {
              try {
                  console.log('Saving data to Firestore...');
                  const userRef = doc(db, 'users', currentUser.uid);
                  await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), saveData);
                  // Ak sme úspešne uložili online, môžeme odstrániť prípadné čakajúce dáta
                  if (localStorage.getItem(pendingKey)) {
                      console.log('Removing pending sync data as save was successful online.');
                      localStorage.removeItem(pendingKey);
                  }
                  showSaveNotification('Dáta synchronizované s cloudom');
              } catch (error) {
                  console.error('Chyba pri ukladaní do Firestore:', error);
                  showErrorNotification('Chyba pri synchronizácii: ' + error.message);
                  // Ak ukladanie zlyhalo aj keď sme online, uložíme do pending pre neskorší pokus
                  console.log('Saving data to pending sync due to Firestore error:', pendingKey);
                  localStorage.setItem(pendingKey, JSON.stringify(saveData));
              }
          } else {
              // Ak sme offline, uložíme do pending sync kľúča
              console.log('Offline: Saving data to pending sync:', pendingKey);
              localStorage.setItem(pendingKey, JSON.stringify(saveData));
              showSaveNotification('Dáta uložené lokálne (offline)');
          }
      } else {
          // Ak nie je prihlásený používateľ, iba uložíme lokálne
           showSaveNotification('Dáta uložené lokálne (neprihlásený)');
      }
    }


    async function syncWithFirebase() {
      if (!currentUser || !isOnline()) {
        // console.log('Sync check: Not syncing (not logged in or offline).');
        return; // Nerobíme nič, ak nie je používateľ prihlásený alebo je offline
      }

      console.log('Sync check: Logged in and online. Checking for pending data...');
      const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
      const pendingData = localStorage.getItem(pendingKey);

      if (pendingData) {
        console.log('Pending data found. Attempting to sync...');
        try {
          const dataToSync = JSON.parse(pendingData);
          const userRef = doc(db, 'users', currentUser.uid);
          await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), dataToSync);
          console.log('Pending data successfully synced with Firestore.');
          localStorage.removeItem(pendingKey); // Odstránime čakajúce dáta po úspešnej synchronizácii
          showSaveNotification('Offline zmeny boli synchronizované');
        } catch (error) {
          console.error('Chyba pri synchronizácii čakajúcich dát s Firestore:', error);
          showErrorNotification('Chyba pri synchronizácii offline zmien: ' + error.message);
          // Necháme pending dáta v localStorage pre ďalší pokus
        }
      } else {
        console.log('Sync check: No pending data found.');
      }
    }


    // -------------------- Načítanie z Firestore a localStorage --------------------
    // ... (loadFromFirestore bez zmeny)
    async function loadFromFirestore() {
      const localKey = `workData-${currentYear}-${currentMonth}`;
      const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
      let storedData = null;
      let source = null;

      // 1. Skontroluj pending dáta (majú najvyššiu prioritu, ak existujú)
      const pendingData = localStorage.getItem(pendingKey);
      if (pendingData) {
          console.log('Loading from PENDING localStorage data (highest priority)');
          try {
              storedData = JSON.parse(pendingData);
              source = 'pendingLocalStorage';
          } catch (error) {
              console.error('Error parsing pending localStorage data:', error);
              localStorage.removeItem(pendingKey); // Odstránime poškodené dáta
          }
      }

      // 2. Ak neboli pending dáta, skontroluj hlavný localStorage
      if (!storedData) {
          const localData = localStorage.getItem(localKey);
          if (localData) {
              console.log('Loading from MAIN localStorage data');
              try {
                  storedData = JSON.parse(localData);
                  source = 'mainLocalStorage';
              } catch (error) {
                  console.error('Error parsing main localStorage data:', error);
                  localStorage.removeItem(localKey); // Odstránime poškodené dáta
              }
          }
      }

      // 3. Ak neboli ani lokálne dáta a sme online a prihlásení, skús Firestore
      if (!storedData && currentUser && isOnline()) {
          console.log('No local data found. Attempting to load from Firestore...');
          try {
              const userRef = doc(db, 'users', currentUser.uid);
              const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
              const docSnap = await getDoc(docRef);

              if (docSnap.exists()) {
                  console.log('Loading from Firestore data');
                  storedData = docSnap.data();
                  source = 'firestore';
                  // Uložíme dáta z Firestore do hlavného localStorage pre offline prístup
                  localStorage.setItem(localKey, JSON.stringify(storedData));
                  // Ak sme načítali z Firestore, nemali by byť žiadne pending dáta, ale pre istotu skontrolujeme
                  if (localStorage.getItem(pendingKey)) {
                      console.warn('Firestore data loaded, but pending data also exists. Pending data should be synced later.');
                  }
              } else {
                  console.log('No data found in Firestore for this month.');
                  source = 'none';
              }
          } catch (error) {
              console.error('Error loading data from Firestore:', error);
              showErrorNotification('Chyba pri načítavaní dát z cloudu: ' + error.message);
              // V prípade chyby necháme storedData = null
          }
      } else if (!storedData) {
         console.log('No data found locally, and either offline or not logged in.');
         source = 'none';
      }

      // Ak sme našli nejaké dáta (z akéhokoľvek zdroja)
      if (storedData && storedData.data) {
          console.log(`Applying data loaded from: ${source}`);
          // Aplikujeme nastavenia
          hourlyWage = storedData.hourlyWage || parseFloat(hourlyWageInput.value);
          taxRate = storedData.taxRate || parseFloat(taxRateInput.value) / 100;
          employeeName = storedData.employeeName || '';
          decimalPlaces = storedData.decimalPlaces || 1;

          hourlyWageInput.value = hourlyWage;
          taxRateInput.value = (taxRate * 100).toFixed(1);
          employeeNameInput.value = employeeName;
          decimalPlacesSelect.value = decimalPlaces;

          // Aplikujeme dáta do tabuľky
          storedData.data.forEach((day, index) => {
            const i = index + 1;
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            // Výpočtové polia sa naplnia automaticky cez calculateRow
            if (startElement && endElement && breakElement) {
              startElement.value = day.start || '';
              endElement.value = day.end || '';
              breakElement.value = day.breakTime || '';
              // Neprepisujeme gross/net priamo, necháme calculateRow, aby to spočítalo
              calculateRow(i); // Prepočíta total, gross, net na základe vstupov
            }
          });
      } else {
          // Ak sa nenašli žiadne dáta, len resetneme nastavenia na default/aktuálne z inputov
          hourlyWage = parseFloat(hourlyWageInput.value);
          taxRate = parseFloat(taxRateInput.value) / 100;
          employeeName = employeeNameInput.value;
          decimalPlaces = parseInt(decimalPlacesSelect.value);
      }

      // Nakoniec vždy prepočítame celkové súčty
      calculateTotal();
    }


    // -------------------- Tvorba tabuľky a výpočty --------------------
    // ... (getDayName bez zmeny)
     function getDayName(year, month, day) {
      const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
      const date = new Date(year, month, day);
      return daysOfWeek[date.getDay()];
    }

    function createTable() {
      console.log('Creating table for month:', currentMonth, 'year:', currentYear);
      workDays.innerHTML = ''; // Vyčistíme starú tabuľku
      const currentDayOfMonth = new Date().getDate();
      const currentMonthIndex = new Date().getMonth();
      const currentYearValue = new Date().getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        // Zvýraznenie aktuálneho dňa
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        // Resetované hodnoty pre polia
        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        workDays.appendChild(row);
      }
      console.log('Table structure created. Loading data...');
      // Načítanie dát AŽ PO vytvorení štruktúry tabuľky
      loadFromFirestore();
    }


    // ... (handleInput, handleBreakInput, calculateAndUpdateTotals, formatAndMoveNext, moveNext bez zmeny)
    window.handleInput = function(input, nextId) {
      formatAndMoveNext(input, nextId);
      calculateAndUpdateTotals(); // Ukladá a prepočítava
    }
    window.handleBreakInput = function(day) {
      calculateRow(day); // Len prepočíta riadok
      const nextDay = day + 1;
      if (nextDay <= getDaysInMonth(currentMonth)) {
        // Presunieme focus na začiatok ďalšieho dňa pre plynulejšie zadávanie
        moveNext(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`), `start-${currentYear}-${currentMonth}-${nextDay}`);
      }
      calculateAndUpdateTotals(); // Ukladá a prepočítava
    }

    function calculateAndUpdateTotals() {
       // Najprv prepočítať všetky riadky (ak by sa zmenila hodinová mzda/daň)
      for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
         calculateRow(i);
      }
      // Potom prepočítať celkové súčty
      calculateTotal();
      // A nakoniec spustiť (debounce) ukladanie
      debouncedSaveToFirestore();
    }

     function formatAndMoveNext(input, nextId) {
      let value = input.value.replace(/[^\d:]/g, ''); // Povolí len čísla a dvojbodku
      // Automatické pridanie dvojbodky po 2 číslach
      if (value.length === 2 && !value.includes(':')) {
          // Ak používateľ zadal 3. znak, pridáme dvojbodku
          const originalLength = input.dataset.originalLength || 0;
          if (value.length > originalLength) {
              value = value + ':';
          }
      }
      // Oprava, ak používateľ vymaže dvojbodku
      if (value.length === 3 && value.charAt(2) !== ':') {
         value = value.slice(0,2) + ':' + value.slice(2);
      }
      // Obmedzenie na 5 znakov
      if (value.length > 5) {
          value = value.slice(0, 5);
      }

      input.value = value;
      input.dataset.originalLength = value.length; // Uložíme aktuálnu dĺžku

      // Validácia a presun po zadaní kompletného času HH:MM
      if (value.length === 5) {
        const [hours, minutes] = value.split(':').map(Number);
        // Jednoduchá validácia formátu
        if (value.match(/^\d{2}:\d{2}$/) && hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
          const day = parseInt(input.id.split('-')[3]);
          calculateRow(day); // Prepočítame riadok hneď po validnom zadaní
          moveNext(input, nextId);
        } else {
          // Ak formát nie je správny, môžeme dať vizuálnu spätnú väzbu alebo nechať tak
          // showErrorNotification("Neplatný čas. Zadajte HH:MM.");
          // input.value = value.slice(0,-1); // Prípadne odstrániť posledný znak
        }
      } else {
           // Ak čas nie je kompletný, len prepočítame riadok (ak už bol zadaný druhý čas)
           const day = parseInt(input.id.split('-')[3]);
           calculateRow(day);
      }
    }

     function moveNext(currentElement, nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) {
        nextElement.focus();
        // Ak je to input, môžeme ho aj vybrať pre ľahšie prepísanie
        if (nextElement.tagName === 'INPUT') {
            nextElement.select();
        }
      }
    }

    function calculateRow(day) {
      // ... (bez zmeny v logike výpočtu)
      const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`).value;
      const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`).value;
      const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const breakTime = parseFloat(breakTimeInput.value) || 0;

      const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

      // Reset na nulu, ak nie sú oba časy zadané správne
      let hours = 0, minutes = 0, decimalHours = 0, grossSalary = 0, netSalary = 0;

      if (startTime && endTime && startTime.length === 5 && endTime.length === 5 && startTime.includes(':') && endTime.includes(':')) {
        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);

        // Validácia hodín a minút
        if (startHours >= 0 && startHours < 24 && startMinutes >= 0 && startMinutes < 60 &&
            endHours >= 0 && endHours < 24 && endMinutes >= 0 && endMinutes < 60)
        {
            const startDate = new Date(2000, 0, 1, startHours, startMinutes); // Použijeme fixný dátum
            const endDate = new Date(2000, 0, 1, endHours, endMinutes);

            let diff = (endDate - startDate); // Rozdiel v milisekundách

            // Ak je čas odchodu menší ako čas príchodu (práca cez polnoc)
            if (diff < 0) {
                diff += 24 * 60 * 60 * 1000; // Pridáme 24 hodín v ms
            }

            const totalMinutesWorked = (diff / 60000) - (breakTime * 60); // Celkové minúty mínus prestávka v minútach

            if (totalMinutesWorked > 0) {
                hours = Math.floor(totalMinutesWorked / 60);
                minutes = Math.round(totalMinutesWorked % 60); // Zaokrúhlime minúty
                decimalHours = (totalMinutesWorked / 60); // Nezaokrúhľujeme pre výpočet mzdy

                grossSalary = decimalHours * hourlyWage;
                netSalary = grossSalary * (1 - taxRate);

                // Ochrana pred NaN/Infinity, ak by niečo bolo zle
                grossSalary = isFinite(grossSalary) ? grossSalary : 0;
                netSalary = isFinite(netSalary) ? netSalary : 0;
            }
        }
      }

      // Aktualizácia UI
      totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;
      grossInput.value = grossSalary.toFixed(decimalPlaces);
      netInput.value = netSalary.toFixed(decimalPlaces);
    }

    // ... (updateNetSalary - už nie je potrebná, logika je v calculateRow)

    window.resetRow = function(day) {
      // ... (bez zmeny)
      document.getElementById(`start-${currentYear}-${currentMonth}-${day}`).value = '';
      document.getElementById(`end-${currentYear}-${currentMonth}-${day}`).value = '';
      document.getElementById(`break-${currentYear}-${currentMonth}-${day}`).value = '';
      // calculateRow sa zavolá v calculateAndUpdateTotals, takže polia sa prepočítajú na 0
      calculateAndUpdateTotals(); // Prepočíta a uloží
    }

    function calculateTotal() {
      // ... (bez zmeny)
      let totalMinutes = 0;
      let totalGrossSalary = 0;
      let totalNetSalary = 0;
      let daysWithEntries = 0;

      workDays.querySelectorAll('tr').forEach(row => {
        const totalCell = row.children[4];
        const grossInput = row.children[5].querySelector('input');
        const netInput = row.children[6].querySelector('input');
        const startInput = row.children[1].querySelector('input'); // Pre kontrolu, či je deň vyplnený

        if (totalCell && grossInput && netInput && startInput) {
          // Použijeme hodnoty z inputov pre presnejšie sčítanie
          const grossValue = parseFloat(grossInput.value) || 0;
          const netValue = parseFloat(netInput.value) || 0;

          if (grossValue > 0) { // Rátame deň, len ak má nenulovú hrubú mzdu
              daysWithEntries++;
              totalGrossSalary += grossValue;
              totalNetSalary += netValue;

              // Výpočet minút z textového poľa "Odpracované"
              const totalText = totalCell.textContent;
              const match = totalText.match(/(\d+)h (\d+)m/); // Získame hodiny a minúty
              if (match) {
                  const hours = parseInt(match[1]) || 0;
                  const minutes = parseInt(match[2]) || 0;
                  totalMinutes += hours * 60 + minutes;
              }
          }
        }
      });

      const totalHours = Math.floor(totalMinutes / 60);
      const totalMinutesRemainder = Math.round(totalMinutes % 60); // Zaokrúhlenie celkových minút
      const totalDecimalHours = (totalMinutes / 60); // Nezaokrúhľujeme pre zobrazenie

      let averageNetSalary = 0;
      if (daysWithEntries > 0) {
        averageNetSalary = (totalNetSalary / daysWithEntries);
      }

      let averageWorkedMinutes = 0;
      if (daysWithEntries > 0) {
        averageWorkedMinutes = totalMinutes / daysWithEntries;
      }
      const averageHours = Math.floor(averageWorkedMinutes / 60);
      const averageMinutes = Math.round(averageWorkedMinutes % 60); // Zaokrúhlenie priemerných minút
      const averageDecimalHours = (averageWorkedMinutes / 60); // Nezaokrúhľujeme pre zobrazenie

      totalSalaryDiv.innerHTML = `
        Počet odpracovaných dní: ${daysWithEntries}<br>
        Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>
        Celková hrubá mzda: ${totalGrossSalary.toFixed(decimalPlaces)}€<br>
        Celková čistá mzda: ${totalNetSalary.toFixed(decimalPlaces)}€<br>
        Priemerná čistá mzda: ${averageNetSalary.toFixed(decimalPlaces)}€<br>
        <strong>Priemerný odpracovaný čas: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(decimalPlaces)} h)</strong>
      `;
    }

    // -------------------- EXPORT DO PDF (upravené pre diakritiku v tabuľke) --------------------
    // ... (getMonthName, exportToPDF, sendPDF bez zmeny)
     function getMonthName(month) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[month];
    }

    window.exportToPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Načítanie fontu Roboto pre správnu podporu diakritiky
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');

      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - Výkaz práce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);

      doc.setFontSize(14);
      doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 30); // Pridané meno pracovníka
      doc.text(`Hodinová mzda: ${hourlyWage} €`, 14, 35);
      doc.text(`Daň: ${taxRate * 100} %`, 14, 40);


      const tableData = [];
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
        const dayName = getDayName(currentYear, currentMonth, i);
        const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`).value || '-';
        const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`).value || '-';
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`).value || '0';
        const totalTimeText = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`).textContent;
        const grossSalary = parseFloat(document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`).value).toFixed(decimalPlaces) || '0.00';
        const netSalary = parseFloat(document.getElementById(`net-${currentYear}-${currentMonth}-${i}`).value).toFixed(decimalPlaces) || '0.00';

        // Zahrnieme riadok, len ak bol zadaný aspoň príchod alebo odchod
        if (startTime !== '-' || endTime !== '-') {
          // Formátovanie "Odpracované" pre lepšiu čitateľnosť v PDF
           const totalMatch = totalTimeText.match(/(\d+h \d+m)/);
           const totalTimeFormatted = totalMatch ? totalMatch[1] : '-';

          tableData.push([
              `Deň ${i} (${dayName})`,
              startTime,
              endTime,
              breakTime + ' h', // Pridáme jednotku k prestávke
              totalTimeFormatted, // Použijeme formátovaný čas
              grossSalary + ' €', // Pridáme menu
              netSalary + ' €'   // Pridáme menu
          ]);
        }
      }

      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá Mzda', 'Čistá Mzda']],
        body: tableData,
        startY: 45, // Posunieme začiatok tabuľky nižšie
        theme: 'grid', // Použijeme mriežku pre lepšiu prehľadnosť
        styles: {
            font: 'Roboto',
            fontSize: 9, // Zmenšíme písmo pre viac miesta
            cellPadding: 2
        },
        headStyles: {
            fillColor: [41, 128, 185], // Modrá farba hlavičky
            textColor: 255,
            fontStyle: 'bold'
        },
        columnStyles: {
            0: { cellWidth: 35 }, // Deň
            1: { cellWidth: 18 }, // Príchod
            2: { cellWidth: 18 }, // Odchod
            3: { cellWidth: 20, halign: 'right' }, // Prestávka
            4: { cellWidth: 25, halign: 'right' }, // Odpracované
            5: { cellWidth: 25, halign: 'right' }, // Hrubá
            6: { cellWidth: 25, halign: 'right' }  // Čistá
        }
      });

      // Pridáme celkové súčty pod tabuľku
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(11);
      // Získame text zo súčtov a rozdelíme ho na riadky
      const totalLines = totalSalaryDiv.innerHTML.split('<br>').map(line => line.replace(/<strong>|<\/strong>/g, '').trim());
       doc.text(totalLines, 14, finalY);


      doc.save(`brunos-calculator-vykaz-${getMonthName(currentMonth)}-${currentYear}.pdf`);
    }

    window.sendPDF = function() {
        // Najprv vygenerujeme PDF ako Blob
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
        doc.setFont('Roboto');
        doc.setFontSize(18);
        doc.text(`Bruno's Calculator - Výkaz práce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
        doc.setFontSize(14);
        doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 30);
        doc.text(`Hodinová mzda: ${hourlyWage} €`, 14, 35);
        doc.text(`Daň: ${taxRate * 100} %`, 14, 40);

        const tableData = [];
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const dayName = getDayName(currentYear, currentMonth, i);
            const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`).value || '-';
            const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`).value || '-';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`).value || '0';
            const totalTimeText = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`).textContent;
            const grossSalary = parseFloat(document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`).value).toFixed(decimalPlaces) || '0.00';
            const netSalary = parseFloat(document.getElementById(`net-${currentYear}-${currentMonth}-${i}`).value).toFixed(decimalPlaces) || '0.00';

            if (startTime !== '-' || endTime !== '-') {
                 const totalMatch = totalTimeText.match(/(\d+h \d+m)/);
                 const totalTimeFormatted = totalMatch ? totalMatch[1] : '-';
                 tableData.push([
                    `Deň ${i} (${dayName})`, startTime, endTime, breakTime + ' h',
                    totalTimeFormatted, grossSalary + ' €', netSalary + ' €'
                 ]);
            }
        }
        doc.autoTable({
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka', 'Odpracované', 'Hrubá Mzda', 'Čistá Mzda']],
            body: tableData, startY: 45, theme: 'grid',
            styles: { font: 'Roboto', fontSize: 9, cellPadding: 2 },
            headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold'},
            columnStyles: {
                0: { cellWidth: 35 }, 1: { cellWidth: 18 }, 2: { cellWidth: 18 },
                3: { cellWidth: 20, halign: 'right' }, 4: { cellWidth: 25, halign: 'right' },
                5: { cellWidth: 25, halign: 'right' }, 6: { cellWidth: 25, halign: 'right' }
            }
        });
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(11);
        const totalLines = totalSalaryDiv.innerHTML.split('<br>').map(line => line.replace(/<strong>|<\/strong>/g, '').trim());
        doc.text(totalLines, 14, finalY);

        const pdfBlob = doc.output('blob');
        const pdfFile = new File(
            [pdfBlob],
            `brunos-calculator-vykaz-${getMonthName(currentMonth)}-${currentYear}.pdf`,
            { type: 'application/pdf' }
        );

      // Pokusíme sa zdieľať pomocou Web Share API
      if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
        navigator.share({
          files: [pdfFile],
          title: `Výkaz práce ${getMonthName(currentMonth)} ${currentYear}`,
          text: `Výkaz práce pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.`
        })
        .then(() => console.log('PDF bolo úspešne odoslané cez Share API'))
        .catch(error => {
          // Ak používateľ zruší zdieľanie, nelogujeme to ako chybu
          if (error.name !== 'AbortError') {
              console.error('Chyba pri zdieľaní PDF cez Share API:', error);
              showErrorNotification('Chyba pri zdieľaní: ' + error.message);
          } else {
              console.log('Zdieľanie PDF bolo zrušené používateľom.');
          }
        });
      } else {
        // Fallback, ak Web Share API nie je podporované (napr. na desktopoch)
        // Ponúkneme stiahnutie súboru
        console.log('Web Share API for files not supported. Offering download instead.');
        // Využijeme funkciu exportToPDF, ktorá už ponúka stiahnutie
         exportToPDF();
        // Alternatívne môžeme vytvoriť odkaz na stiahnutie Blob-u manuálne:
        // const link = document.createElement('a');
        // link.href = URL.createObjectURL(pdfBlob);
        // link.download = pdfFile.name;
        // document.body.appendChild(link);
        // link.click();
        // document.body.removeChild(link);
        // URL.revokeObjectURL(link.href);
        showErrorNotification('Zdieľanie nie je podporované, PDF bolo stiahnuté.');
      }
    }

    // -------------------- OSTATNÉ NASTAVENIA --------------------
    // ... (changeDecimalPlaces, updateEmployeeName, updateSettings, changeMonth, changeYear, getDaysInMonth bez zmeny)
     window.changeDecimalPlaces = function() {
      decimalPlaces = parseInt(decimalPlacesSelect.value);
      localStorage.setItem('decimalPlaces', decimalPlaces); // Ukladáme priamo hodnotu
      // Prepočítame celú tabuľku a súčty
      calculateAndUpdateTotals();
    }

    window.updateEmployeeName = function() {
      employeeName = employeeNameInput.value.trim();
      localStorage.setItem('employeeName', employeeName); // Ukladáme priamo hodnotu
      // Meno pracovníka neovplyvňuje výpočty, stačí uložiť
      debouncedSaveToFirestore();
    }

    window.updateSettings = function() {
      // Táto funkcia sa volá pri zmene hodinovej mzdy alebo dane
      hourlyWage = parseFloat(hourlyWageInput.value) || 0; // Zabezpečíme, aby to bolo číslo
      taxRate = (parseFloat(taxRateInput.value) || 0) / 100; // Zabezpečíme, aby to bolo číslo

      // Uložíme nové nastavenia do localStorage (aj keď to robí aj saveToFirestore, pre istotu)
       localStorage.setItem('hourlyWage', hourlyWage);
       localStorage.setItem('taxRate', taxRate * 100); // Ukladáme percento

      // Prepočítame celú tabuľku a súčty, čo spustí aj ukladanie
      calculateAndUpdateTotals();
    }

     window.changeMonth = function() {
      currentMonth = parseInt(monthSelect.value);
      console.log(`Changing to month: ${currentMonth}`);
      createTable(); // Vytvorí novú tabuľku a načíta dáta pre nový mesiac
    }

    window.changeYear = function() {
      currentYear = parseInt(yearSelect.value);
      console.log(`Changing to year: ${currentYear}`);
      createTable(); // Vytvorí novú tabuľku a načíta dáta pre nový rok
    }

    function getDaysInMonth(month) {
        // Vytvorí dátum pre nultý deň nasledujúceho mesiaca, čo je posledný deň aktuálneho mesiaca
        return new Date(currentYear, month + 1, 0).getDate();
    }

    // -------------------- TMAVÝ REŽIM --------------------
    function applyDarkMode(isDark) {
        document.body.classList.toggle('dark-mode', isDark);
        document.querySelector('.container').classList.toggle('dark-mode', isDark);
        document.querySelector('table').classList.toggle('dark-mode', isDark);
        document.querySelectorAll('th').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.querySelectorAll('td').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"]').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.querySelectorAll('.btn').forEach(el => el.classList.toggle('dark-mode', isDark));
        document.getElementById('totalSalary').classList.toggle('dark-mode', isDark);
        // Zvýraznenie aktuálneho dňa v tmavom režime
        document.querySelectorAll('.current-day').forEach(el => el.classList.toggle('dark-mode', isDark));
    }

    window.toggleDarkMode = function() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        applyDarkMode(!isDarkMode);
        localStorage.setItem('darkMode', !isDarkMode); // Uložíme preferenciu
    }

    // Aplikujeme tmavý režim pri načítaní stránky, ak bol uložený
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    applyDarkMode(savedDarkMode);


    // -------------------- INIT --------------------

    // Inicializácia pri načítaní stránky
    // Načítanie uložených nastavení (ak existujú) - presunuté do loadFromFirestore
    // hourlyWageInput.value = localStorage.getItem('hourlyWage') || '10';
    // taxRateInput.value = localStorage.getItem('taxRate') || '2';
    // employeeNameInput.value = localStorage.getItem('employeeName') || '';
    // decimalPlacesSelect.value = localStorage.getItem('decimalPlaces') || '1';
    // hourlyWage = parseFloat(hourlyWageInput.value);
    // taxRate = parseFloat(taxRateInput.value) / 100;
    // employeeName = employeeNameInput.value;
    // decimalPlaces = parseInt(decimalPlacesSelect.value);

    // Listener pre stav autentifikácie - **UPRAVENÉ**
    onAuthStateChanged(auth, async (user) => { // Pridané async
      currentUser = user;
      updateUI(); // Aktualizuje UI a načíta dáta cez createTable -> loadFromFirestore

      // Po aktualizácii UI a načítaní dát skúsime synchronizovať PENDING dáta
      if (currentUser && isOnline()) {
        console.log('Auth state changed: User logged in and online. Attempting initial sync...');
        try {
          await syncWithFirebase();
        } catch (error) {
          console.error('Error during sync after auth state change:', error);
        }
      } else {
          console.log('Auth state changed: User logged out or offline. No initial sync.');
      }
    });

    // Listener pre návrat na kartu/okno - **PRIDANÉ**
    document.addEventListener('visibilitychange', async () => {
      // Skúsime synchronizovať, len ak sa karta stala viditeľnou, používateľ je prihlásený a sme online
      if (document.visibilityState === 'visible' && currentUser && isOnline()) {
        console.log('Tab became visible: User logged in and online. Attempting sync...');
        try {
          await syncWithFirebase();
        } catch (error) {
          console.error('Error during sync on visibility change:', error);
        }
      }
    });

    // Vytvorenie tabuľky a načítanie dát sa deje v onAuthStateChanged -> updateUI -> createTable -> loadFromFirestore
    // createTable(); // Toto už netreba volať tu


    // -------------------- FUNKCIE PRE ZÁLOHU A OBNOVU DO EXCELU --------------------
    // ... (createBackup, restoreBackup bez zmeny)
     window.createBackup = function() {
      const key = `workData-${currentYear}-${currentMonth}`;
      const dataString = localStorage.getItem(key);

      if (!dataString) {
          showErrorNotification('Nie sú dostupné žiadne lokálne dáta na zálohu pre tento mesiac.');
          return;
      }

      try {
          const dataObj = JSON.parse(dataString);

          // Vytvoríme pole riadkov pre Excel
          const ws_data = [
              // Hlavička
              ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"]
          ];

          // Dáta pre každý deň
          const daysInMonth = getDaysInMonth(currentMonth); // Získame počet dní pre aktuálny mesiac/rok
          for (let i = 0; i < daysInMonth; i++) {
              // Ak dáta v objekte existujú pre daný deň
              if (dataObj.data && dataObj.data[i]) {
                  const row = dataObj.data[i];
                   // Validácia a defaultné hodnoty
                   const start = row.start && row.start.match(/^\d{2}:\d{2}$/) ? row.start : "";
                   const end = row.end && row.end.match(/^\d{2}:\d{2}$/) ? row.end : "";
                   const breakTime = !isNaN(parseFloat(row.breakTime)) ? parseFloat(row.breakTime) : 0;
                   const gross = !isNaN(parseFloat(row.gross)) ? parseFloat(row.gross).toFixed(decimalPlaces) : "0.00";
                   const net = !isNaN(parseFloat(row.net)) ? parseFloat(row.net).toFixed(decimalPlaces) : "0.00";

                   // Pridáme riadok len ak je zadaný príchod alebo odchod
                   if (start || end) {
                       ws_data.push([
                           `Deň ${i+1}`, // Číslo dňa
                           start,
                           end,
                           breakTime, // Prestávka ako číslo
                           parseFloat(gross), // Hrubá ako číslo
                           parseFloat(net) // Čistá ako číslo
                       ]);
                   }
              }
          }

          // Pridáme informácie o nastaveniach na koniec
          ws_data.push([]); // Prázdny riadok ako oddeľovač
          ws_data.push(["Nastavenie", "Hodnota"]);
          ws_data.push(["Meno pracovníka", dataObj.employeeName || ""]);
          ws_data.push(["Hodinová mzda (€)", dataObj.hourlyWage || 0]);
          ws_data.push(["Daňové percento (%)", (dataObj.taxRate || 0) * 100]);
          ws_data.push(["Počet desatinných miest", dataObj.decimalPlaces || 1]);
          ws_data.push(["Mesiac zálohy", getMonthName(currentMonth)]);
          ws_data.push(["Rok zálohy", currentYear]);
          ws_data.push(["Posledná aktualizácia dát", dataObj.lastUpdated ? new Date(dataObj.lastUpdated).toLocaleString('sk-SK') : "Neznáma"]);
          ws_data.push(["Dátum vytvorenia zálohy", new Date().toLocaleString('sk-SK')]);


          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);

           // Nastavenie šírky stĺpcov (voliteľné, pre krajší vzhľad)
            ws['!cols'] = [
                { wch: 15 }, // Deň
                { wch: 10 }, // Príchod
                { wch: 10 }, // Odchod
                { wch: 15 }, // Prestávka (h)
                { wch: 18 }, // Hrubá Mzda (€)
                { wch: 18 }  // Čistá Mzda (€)
            ];
            // Nastavenie formátu pre číselné stĺpce (prestávka, mzdy)
            // Pozor: Formátovanie nemusí fungovať vo všetkých Excel klientoch rovnako
            const numberFormat = `0.${'0'.repeat(decimalPlaces)}`; // Napr. 0.0 alebo 0.00
            for (let R = 1; R < ws_data.length; ++R) { // Začíname od druhého riadku (index 1)
                 // Stĺpec Prestávka (index 3)
                 if(ws_data[R][3] !== undefined) {
                     const cell_address_break = XLSX.utils.encode_cell({c:3, r:R});
                     if(!ws[cell_address_break]) ws[cell_address_break] = {};
                     ws[cell_address_break].t = 'n'; // Typ Number
                     ws[cell_address_break].z = '0.0'; // Formát na 1 desatinné miesto
                 }
                 // Stĺpec Hrubá mzda (index 4)
                 if(ws_data[R][4] !== undefined) {
                     const cell_address_gross = XLSX.utils.encode_cell({c:4, r:R});
                     if(!ws[cell_address_gross]) ws[cell_address_gross] = {};
                     ws[cell_address_gross].t = 'n'; // Typ Number
                     ws[cell_address_gross].z = numberFormat; // Dynamický formát
                 }
                  // Stĺpec Čistá mzda (index 5)
                 if(ws_data[R][5] !== undefined) {
                     const cell_address_net = XLSX.utils.encode_cell({c:5, r:R});
                     if(!ws[cell_address_net]) ws[cell_address_net] = {};
                     ws[cell_address_net].t = 'n'; // Typ Number
                     ws[cell_address_net].z = numberFormat; // Dynamický formát
                 }
            }


          XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)}`); // Názov listu

          // Generovanie názvu súboru
          const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-z0-9]/gi, '_').toLowerCase();
          const fileName = `vykaz_${safeEmployeeName}_${currentYear}_${String(currentMonth + 1).padStart(2, '0')}.xlsx`;

          XLSX.writeFile(wb, fileName);
          showSaveNotification('Záloha do Excelu bola úspešne vytvorená.');

      } catch (error) {
          console.error("Chyba pri vytváraní zálohy do Excelu:", error);
          showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message);
      }
    };

    window.restoreBackup = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: false /* Načítať časy ako stringy */ });
            const sheetName = workbook.SheetNames[0]; // Berieme prvý list
            const ws = workbook.Sheets[sheetName];

            // Konvertujeme list na pole polí (Array of Arrays)
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false /* Formátované stringy */ });

            let dataArray = [];
            let settings = {};
            let backupMonth = -1;
            let backupYear = -1;
            let readingData = true; // Prepínač, či čítame dáta dní alebo nastavenia

            // Pripravíme prázdne dáta pre všetky dni v mesiaci
            const daysInTargetMonth = getDaysInMonth(currentMonth);
             dataArray = Array(daysInTargetMonth).fill(null).map(() => ({
                start: "", end: "", breakTime: "", gross: "0.00", net: "0.00"
             }));


            // Prejdeme riadky zo sheetu
            for (let i = 1; i < rows.length; i++) { // Začíname od druhého riadku (index 1), preskakujeme hlavičku
                const row = rows[i];
                if (!row || row.length === 0) { // Preskočíme prázdne riadky
                    continue;
                }

                // Ak narazíme na riadok "Nastavenie", prepneme na čítanie nastavení
                if (row[0] === "Nastavenie") {
                    readingData = false;
                    continue; // Preskočíme samotný riadok "Nastavenie"
                }

                if (readingData) {
                    // Čítame dáta dní
                    const dayMatch = String(row[0]).match(/Deň (\d+)/);
                    if (dayMatch && dayMatch[1]) {
                        const dayIndex = parseInt(dayMatch[1], 10) - 1; // Index v poli (0 až ...)

                        // Skontrolujeme, či index patrí do aktuálne zvoleného mesiaca
                        if (dayIndex >= 0 && dayIndex < daysInTargetMonth) {
                             // Formátujeme časy - ak nie sú validné, necháme prázdne
                             const formatTime = (timeStr) => {
                                 if (typeof timeStr === 'string' && timeStr.match(/^\d{1,2}:\d{2}$/)) {
                                     let [h, m] = timeStr.split(':');
                                     return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
                                 }
                                 return "";
                             };

                            dataArray[dayIndex] = {
                                start: formatTime(row[1]),
                                end: formatTime(row[2]),
                                breakTime: !isNaN(parseFloat(row[3])) ? String(parseFloat(row[3])) : "0", // Uložíme ako string
                                // Hrubú a čistú mzdu neobnovujeme, prepočítajú sa
                                gross: "0.00",
                                net: "0.00"
                            };
                        }
                    }
                } else {
                    // Čítame nastavenia
                    const key = String(row[0]).trim();
                    const value = row[1]; // Hodnota je v druhom stĺpci

                    if (key === "Meno pracovníka") settings.employeeName = String(value);
                    else if (key === "Hodinová mzda (€)") settings.hourlyWage = parseFloat(value);
                    else if (key === "Daňové percento (%)") settings.taxRate = parseFloat(value) / 100;
                    else if (key === "Počet desatinných miest") settings.decimalPlaces = parseInt(value);
                    else if (key === "Mesiac zálohy") {
                        const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
                        backupMonth = monthNames.indexOf(String(value));
                    }
                    else if (key === "Rok zálohy") backupYear = parseInt(value);
                }
            }

             // Overenie, či mesiac a rok zálohy zodpovedajú aktuálnemu nastaveniu
             if (backupMonth !== -1 && backupYear !== -1 && (backupMonth !== currentMonth || backupYear !== currentYear)) {
                 if (!confirm(`Záloha je pre ${getMonthName(backupMonth)} ${backupYear}. Naozaj ju chcete obnoviť do aktuálne zvoleného mesiaca (${getMonthName(currentMonth)} ${currentYear})?`)) {
                     showErrorNotification("Obnova zálohy bola zrušená.");
                     return; // Zrušíme obnovu
                 }
                 console.warn(`Restoring backup from ${getMonthName(backupMonth)}/${backupYear} into ${getMonthName(currentMonth)}/${currentYear}.`);
             }


            // Vytvoríme objekt pre uloženie do localStorage
            const restoredData = {
              data: dataArray, // Použijeme pripravené pole pre cieľový mesiac
              hourlyWage: !isNaN(settings.hourlyWage) ? settings.hourlyWage : parseFloat(hourlyWageInput.value),
              taxRate: !isNaN(settings.taxRate) ? settings.taxRate : parseFloat(taxRateInput.value) / 100,
              employeeName: settings.employeeName !== undefined ? settings.employeeName : employeeNameInput.value,
              decimalPlaces: !isNaN(settings.decimalPlaces) ? settings.decimalPlaces : parseInt(decimalPlacesSelect.value),
              lastUpdated: new Date().toISOString() // Nastavíme aktuálny čas ako poslednú aktualizáciu
            };

            // Uložíme obnovené dáta do localStorage (prepíšeme existujúce pre daný mesiac)
            const localKey = `workData-${currentYear}-${currentMonth}`;
            localStorage.setItem(localKey, JSON.stringify(restoredData));

            // Odstránime prípadné pending dáta pre tento mesiac, keďže sme obnovili zo zálohy
            const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
            if(localStorage.getItem(pendingKey)) {
                localStorage.removeItem(pendingKey);
                console.log("Removed pending sync data after restoring from backup.");
            }


            // Obnovíme UI - znovu vytvoríme tabuľku, ktorá načíta nové dáta z localStorage
            createTable(); // Toto zavolá loadFromFirestore, ktoré načíta práve uložené dáta

            showSaveNotification('Záloha z Excelu bola úspešne obnovená.');

          } catch (error) {
            console.error("Chyba pri načítavaní zálohy z Excelu:", error);
            showErrorNotification('Chyba pri načítavaní zálohy: ' + error.message);
          }
        };
        reader.onerror = function(error) {
             console.error("Chyba pri čítaní súboru:", error);
             showErrorNotification('Chyba pri čítaní súboru.');
        };
        reader.readAsArrayBuffer(file); // Čítame ako ArrayBuffer
      };
      input.click(); // Otvoríme dialóg na výber súboru
    };

  </script>

  <!-- Registrácia Service Workera (bez zmeny) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
    }
  </script>
</body>
</html>
