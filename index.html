<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- Z√°kladn√© ≈°t√Ωly --- */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
     h2 {
       text-align: center;
       color: #555;
       margin-top: -10px;
       font-size: 1.2em;
     }
     .settings {
       margin-bottom: 20px;
       display: flex;
       flex-wrap: wrap;
       align-items: flex-start;
     }
     .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
       margin: 2px 5px;
     }
     .settings > div {
       flex: 1 1 200px;
     }
     .settings > button#toggleSettingsBtn {
       flex-basis: 100%;
       margin-bottom: 10px;
       background-color: #eee;
       color: #333;
       border: 1px solid #ccc;
       text-align: left;
       padding: 8px 12px;
     }
     body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
     }
      .settings > button.highlight {
        flex: 1 1 150px;
      }
     .settings label {
       display: block;
       margin-bottom: 2px;
     }
     #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
     }
     #settings-collapsible-content.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 5px;
     }
     #settings-collapsible-content > div {
        flex: 1 1 200px;
        margin: 2px 5px;
     }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 1000px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
    }
    th {
      background-color: #f2f2f2;
    }

    /* --- ≈†t√Ωly pre input bunky a ƒçasov√© tlaƒçidl√° --- */
    td .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 4px;
    }
     td .time-input-wrapper input[type="tel"] {
        flex-grow: 1;
        min-width: 60px;
     }
     td .time-input-wrapper .time-btn {
        font-size: 1.1em;
        cursor: pointer;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 3px;
        line-height: 1;
        background: none;
        color: #555;
        user-select: none;
     }
      td .time-input-wrapper .time-btn:hover {
         background-color: #eee;
         border-color: #ccc;
      }
      body.dark-mode td .time-input-wrapper .time-btn {
         color: #bbb;
      }
      body.dark-mode td .time-input-wrapper .time-btn:hover {
         background-color: #555;
         border-color: #777;
         color: #fff;
      }


    /* --- ≈†√≠rky stƒ∫pcov --- */
    th:nth-child(7), td:nth-child(7), /* Hrub√° Mzda */
    th:nth-child(8), td:nth-child(8) { /* ƒåist√° Mzda */
      width: 14%;
    }
    th:nth-child(6), td:nth-child(6) { /* Pozn√°mka */
       width: 20%;
    }
    th:nth-child(1), td:nth-child(1) { /* De≈à */ width: 7%; }
    th:nth-child(2), td:nth-child(2) { /* Pr√≠chod */ width: 10%; }
    th:nth-child(3), td:nth-child(3) { /* Odchod */ width: 10%; }
    th:nth-child(4), td:nth-child(4) { /* Prest√°vka */ width: 7%; }
    th:nth-child(5), td:nth-child(5) { /* Odpracovan√© */ width: 10%; }
    th:nth-child(9), td:nth-child(9) { /* Akcia */ width: 8%; }

    /* --- Spoloƒçn√© ≈°t√Ωly pre input, select a textarea --- */
    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
      font-family: Arial, sans-serif;
    }

    /* --- ≈†pecifick√Ω ≈°t√Ωl pre textarea pozn√°mky --- */
    textarea[id^="note-"] {
       background-color: #e6faff;
       resize: vertical;
       min-height: 30px;
       line-height: 1.4;
       overflow-y: auto;
    }

    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
      text-align: center;
    }
    .reset-btn {
      background-color: #f44336;
      padding: 5px 10px;
      font-size: 14px;
      flex: 0 0 auto;
      min-width: 35px;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
     #dataSizeContainer { }
     #dataSizeText { }
     #dataSizeBar { }
     #dataSizeFill { }
     .current-day {
       background-color: #8a2be2 !important;
       color: white;
     }
     /* --- Zv√Ωraznenie aktu√°lneho d≈àa aj pre textarea --- */
     .current-day input, .current-day select, .current-day textarea {
       background-color: #9932cc !important;
       color: white !important;
       border-color: #b366ff !important;
     }
     .current-day textarea[id^="note-"] {
        background-color: #aa44dd !important;
     }
     .current-day .time-btn {
        color: white !important;
     }
     .current-day .time-btn:hover {
        background-color: #7a1fb4 !important;
        border-color: #9932cc !important;
     }

    /* --- Tmav√Ω re≈æim --- */
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode h1 {
       color: #f4f4f4;
    }
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
      border-color: #555;
    }
    /* --- Tmav√Ω re≈æim pre input, select a textarea --- */
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #666;
      color: white;
      border-color: #555;
    }
    /* --- Tmav√Ω re≈æim ≈°pecificky pre textarea pozn√°mky --- */
    body.dark-mode textarea[id^="note-"] {
       background-color: #5a5a7a;
       border-color: #4a4a6a;
    }
    body.dark-mode .btn { color: #f4f4f4; }
    body.dark-mode .reset-btn { background-color: #d32f2f; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f !important; color: #fff; }
    /* --- Tmav√Ω re≈æim pre current-day input, select, textarea --- */
    body.dark-mode .current-day input,
    body.dark-mode .current-day select,
    body.dark-mode .current-day textarea {
      background-color: #5c1db3 !important;
      color: #fff !important;
      border-color: #7e4bd7 !important;
    }
     body.dark-mode .current-day textarea[id^="note-"] {
        background-color: #6c2fc7 !important;
     }
     body.dark-mode .current-day .time-btn { color: #fff !important; }
     body.dark-mode .current-day .time-btn:hover {
        background-color: #4a0e8f !important;
        border-color: #5c1db3 !important;
     }

    /* --- Responzivita (Media Queries) --- */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#toggleSettingsBtn { flex-basis: auto; width: 100%; margin-bottom: 10px; }
      .settings > button.highlight { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 1000px; }
      th, td { padding: 6px; font-size: 0.8em; }
       td .time-input-wrapper .time-btn { font-size: 1em; padding: 1px 3px; }
       textarea { min-height: 28px; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; }
      .backup-btn { padding: 15px 16px; }
      #totalSalary { font-size: 16px; }
      #dataSizeContainer { font-size: 12px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 12px; }
      textarea { min-height: 26px; }
      table { min-width: 1000px; }
      .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 5px 0; }
      #settings-collapsible-content > div { margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 700px; }
       td .time-input-wrapper .time-btn { font-size: 0.9em; padding: 1px 2px; }
    }

    /* --- Notifik√°cie --- */
    #saveNotification, #errorNotification {
        display: none; position: fixed; bottom: 20px; right: 20px;
        padding: 10px 20px; border-radius: 5px; font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 1000;
        opacity: 0; transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show { display: block; opacity: 1; }
    #saveNotification { background-color: #4CAF50; color: white; }
    #errorNotification { background-color: #f44336; color: white; }

    /* --- Prihlasovanie --- */
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 200px; margin: 5px auto; display: block;
    }
    #login-form .btn { width: 120px; margin: 5px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.9em; color: #007bff; text-decoration: none; }
    #login-form a:hover { text-decoration: underline; }
    body.dark-mode #login-form a { color: #6bbaff; }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
      </div>
    </div>

    <!-- Upraven√Ω H1 nadpis -->
    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2></h2>

    <div class="settings">
       <button id="toggleSettingsBtn" class="btn">Zobrazi≈• nastavenia ‚ñº</button>
       <div id="settings-collapsible-content">
           <div>
               <label for="employeeNameInput">Meno pracovn√≠ka: </label>
               <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
           </div>
           <div>
               <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
               <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
           </div>
           <div>
               <label for="taxRateInput">Da≈àov√© percento (%): </label>
               <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
           </div>
           <div>
               <label for="monthSelect">Mesiac: </label>
               <select id="monthSelect" onchange="changeMonth()">
                 <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                 <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                 <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                 <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
               </select>
           </div>
           <div>
               <label for="yearSelect">Rok: </label>
               <select id="yearSelect" onchange="changeYear()"></select>
           </div>
           <div>
               <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
               <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                  <option value="1">1</option> <option value="2">2</option>
               </select>
           </div>
       </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th> <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky sa generuj√∫ a plnia tu -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
        <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠tanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Naƒç√≠tanie preferencie tmav√©ho re≈æimu
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    // Funkcia pre prep√≠nanie tmav√©ho re≈æimu
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // ----------------------- IMPORTY Firebase (pridan√Ω onSnapshot) -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGUR√ÅCIA Firebase --------------------
     const firebaseConfig = {
         apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // POZOR: Verejn√Ω API kƒæ√∫ƒç
         authDomain: "uuuuu-f7ef9.firebaseapp.com",
         projectId: "uuuuu-f7ef9",
         storageBucket: "uuuuu-f7ef9.appspot.com",
         messagingSenderId: "456105865458",
         appId: "1:456105865458:web:101f0a4dcb455f174b606b",
     };

    // Inicializ√°cia Firebase
    const app = initializeApp(firebaseConfig);
    try {
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // POZOR: Verejn√Ω kƒæ√∫ƒç reCAPTCHA
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("App Check initialization failed:", e);
    }
    const auth = getAuth(app);
    const db = getFirestore(app);


    // -------------------- GLOB√ÅLNE PREMENN√â (pridan√° currentListenerUnsubscribe) --------------------
    let currentUser = null;
    let currentListenerUnsubscribe = null; // Na ulo≈æenie funkcie pre odhl√°senie listenera
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');
    const loginForm = document.getElementById('login-form');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    // Naƒç√≠tanie hodn√¥t z localStorage s predvolen√Ωmi hodnotami
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02; // Uklad√°me ako desatinn√© ƒç√≠slo (2% = 0.02)


    // --- Funkcie pre UI, Nastavenia, Online/Offline, Notifik√°cie ---

    // UPRAVEN√Å: Funkcia na aktualiz√°ciu nadpisu
    function updateGreeting() {
        const wavingHand = ' üëã'; // Emoji s medzerou pred
        if (employeeName) {
            const firstName = employeeName.split(' ')[0];
            mainTitle.textContent = `Vitaj ${firstName}${wavingHand}`; // Form√°t: Vitaj Meno üëã
        } else {
            mainTitle.textContent = `Vitaj${wavingHand}`; // Form√°t: Vitaj üëã
        }
    }

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
     }
    populateYearSelect();

    // Nastavenie poƒçiatoƒçn√Ωch hodn√¥t UI
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1); // Prevod na percent√° pre zobrazenie
    updateGreeting(); // Zavolaj upraven√∫ funkciu pri ≈°tarte

    // Skr√Ωvanie nastaven√≠
     if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
           const isVisible = settingsCollapsibleContent.classList.toggle('visible');
           toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
        });
     }

    // Online/Offline monitoring a notifik√°cie
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => {
        console.log('Browser detected Online state.');
        showStatusNotification('Online', 'green');
        syncWithFirebase(); // Sk√∫s synchronizova≈• PRED aktualiz√°ciou UI
        updateUI();         // Aktualizuj UI (pripoj√≠ listener, ak treba)
    });
    window.addEventListener('offline', () => {
        console.log('Browser detected Offline state.');
        showStatusNotification('Offline', 'red');
        updateUI(); // Aktualizuj UI (odpoj√≠ listener, naƒç√≠ta z LS)
    });
    function showStatusNotification(message, color) {
      const notification = document.createElement('div');
      notification.textContent = message;
      Object.assign(notification.style, { position: 'fixed', top: '20px', right: '20px', padding: '10px 20px', borderRadius: '5px', backgroundColor: color, color: 'white', zIndex: '1000', boxShadow: '0 2px 5px rgba(0,0,0,0.2)' });
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
    function showErrorNotification(message) {
        const notification = document.getElementById('errorNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 4000);
    }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') {
        const notification = document.getElementById('saveNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }


    // --- Autentifik√°cia ---
    window.login = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Prihl√°senie je mo≈æn√© iba online.'); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); return; }
        try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error('Chyba pri prihl√°sen√≠:', error); showErrorNotification('Chyba pri prihl√°sen√≠: ' + mapFirebaseAuthError(error.code)); }
    };
    window.register = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Registr√°cia je mo≈æn√° iba online.'); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); return; }
        if (password.length < 6) { showErrorNotification('Heslo mus√≠ ma≈• aspo≈à 6 znakov.'); return; }
        try { await createUserWithEmailAndPassword(auth, email, password); await createUserCollection(); } catch (error) { console.error('Chyba pri registr√°cii:', error); showErrorNotification('Chyba pri registr√°cii: ' + mapFirebaseAuthError(error.code)); }
    };
    window.logout = async function() {
        if (currentListenerUnsubscribe) {
            console.log('Detaching Firestore listener due to logout.');
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
        }
        try {
            await signOut(auth);
        } catch (error) {
            console.error('Chyba pri odhl√°sen√≠:', error);
            showErrorNotification('Chyba pri odhl√°sen√≠: ' + error.message);
        }
    };
    window.resetPassword = async function() {
        if (!isOnline()) { showErrorNotification('Ste offline. Obnova hesla je mo≈æn√° iba online.'); return; }
        const emailInput = document.getElementById('email'); const email = emailInput.value;
        if (!email) { emailInput.style.border = '1px solid red'; showErrorNotification('Pros√≠m, zadajte v√°≈° email do poƒæa "Email" pre obnovu hesla.'); setTimeout(() => { emailInput.style.border = ''; }, 3000); return; }
        emailInput.style.border = '';
        try { await sendPasswordResetEmail(auth, email); showSaveNotification(`Email na obnovu hesla bol odoslan√Ω na ${email}. Skontrolujte si po≈°tu (aj spam).`); } catch (error) { console.error('Chyba pri obnove hesla:', error); showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code)); }
     };
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatn√Ω form√°t emailu.';
            case 'auth/user-not-found': return 'Pou≈æ√≠vateƒæ s t√Ωmto emailom nebol n√°jden√Ω.';
            case 'auth/wrong-password': return 'Nespr√°vne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je u≈æ zaregistrovan√Ω.';
            case 'auth/weak-password': return 'Heslo je pr√≠li≈° slab√© (min. 6 znakov).';
            case 'auth/requires-recent-login': return 'T√°to oper√°cia vy≈æaduje ned√°vne prihl√°senie.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            case 'auth/missing-email': return 'Pros√≠m, zadajte emailov√∫ adresu.';
            default: return errorCode;
        }
     }
    async function createUserCollection() {
        if (auth.currentUser) {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            try {
                await setDoc(userRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true });
                const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup');
                await setDoc(initialDocRef, { setupComplete: true });
                console.log('User collection and initial workDays doc created for:', auth.currentUser.email);
            } catch (error) { console.error('Error creating user collection:', error); }
        }
    }


    // --- Hlavn√° logika UI, Naƒç√≠tania a Synchroniz√°cie (REVIDOVAN√Å) ---
    function updateUI() {
        console.log("Updating UI based on Auth and Network state...");

        // 1. V≈ædy odhl√°sime star√Ω listener
        if (currentListenerUnsubscribe) {
            console.log("Detaching previous Firestore listener.");
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
        }

        // 2. Vytvor√≠me pr√°zdnu ≈°trukt√∫ru tabuƒæky
        createTable(); // Mus√≠ vytvori≈• pr√°zdne riadky

        // 3. Rozhodovanie podƒæa stavu prihl√°senia
        if (currentUser) {
            // ----- POU≈Ω√çVATEƒΩ JE PRIHL√ÅSEN√ù -----
            console.log(`User ${currentUser.email} is logged in.`);
            loginForm.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;

            // 4. IHNEƒé NAƒå√çTAJ A ZOBRAZ D√ÅTA Z LOCALSTORAGE
            console.log("Loading initial data from localStorage (while potentially connecting listener)...");
            loadFromLocalStorageOnly();

            // 5. Skontroluj stav pripojenia PRE PRIPOJENIE LISTENERA A SYNC
            if (isOnline()) {
                // ----- Prihl√°sen√Ω a ONLINE -----
                console.log("User is Online. Attaching Firestore listener and syncing.");

                const docId = `${currentYear}-${currentMonth}`;
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', docId);
                currentListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    console.log(`Firestore snapshot received for ${docId}. Exists: ${docSnap.exists()}`);
                    const localKey = `workData-${currentYear}-${currentMonth}`;
                    const localDataString = localStorage.getItem(localKey);

                    if (docSnap.exists()) {
                        const firestoreData = docSnap.data();
                        const firestoreDataString = JSON.stringify(firestoreData);

                        if (firestoreDataString !== localDataString) {
                            console.log("Firestore data differs from current localStorage, applying update.");
                            localStorage.setItem(localKey, firestoreDataString);
                            parseAndApplyData(firestoreDataString);
                        } else {
                            console.log("Firestore data matches current localStorage, skipping UI update from listener.");
                            calculateTotal();
                        }
                    } else {
                        console.log(`Document ${docId} does not exist in Firestore. Clearing local data if present.`);
                        if (localDataString) {
                            localStorage.removeItem(localKey);
                            parseAndApplyData(null);
                        } else {
                            calculateTotal();
                        }
                    }
                }, (error) => {
                    console.error(`Firestore listener error for ${docId}:`, error);
                    showErrorNotification(`Chyba pri poƒç√∫van√≠ zmien: ${error.message}. Zobrazujem lok√°lne d√°ta.`);
                });
                syncWithFirebase();
            } else {
                // ----- Prihl√°sen√Ω a OFFLINE -----
                console.log("User is Offline. Data loaded from localStorage.");
                showErrorNotification('Ste offline. Zobrazuj√∫ sa lok√°lne ulo≈æen√© d√°ta. Zmeny sa synchronizuj√∫ po pripojen√≠.');
            }
        } else {
            // ----- POU≈Ω√çVATEƒΩ NIE JE PRIHL√ÅSEN√ù -----
            console.log("User is not logged in. Loading from localStorage only.");
            loginForm.style.display = 'flex';
            userInfo.style.display = 'none';
            userEmail.textContent = '';
            loadFromLocalStorageOnly();
        }
    }

    // --- Ostatn√© funkcie (debounce, collectCurrentData, saveToFirestore, syncWithFirebase, loadFromFirestore, loadFromLocalStorageOnly, parseAndApplyData, createTable, calculateRow, calculateTotal, atƒè.) ---

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1500);

    function collectCurrentData() {
        const saveData = { data: [] };
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
             const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
             const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
             const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
             const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
             const start = startElement ? startElement.value : '';
             const end = endElement ? endElement.value : '';
             const breakTime = breakElement ? breakElement.value : '';
             const note = noteElement ? noteElement.value : '';
             saveData.data.push({ start, end, breakTime, note });
        }
        saveData.hourlyWage = hourlyWage;
        saveData.taxRate = taxRate;
        saveData.employeeName = employeeName;
        saveData.decimalPlaces = decimalPlaces;
        saveData.lastUpdated = new Date().toISOString();
        return saveData;
    }

    async function saveToFirestore() {
        if (!currentUser) { console.log("Cannot save to Firestore: User not logged in."); return; }
         const saveData = collectCurrentData();
         const localKey = `workData-${currentYear}-${currentMonth}`;
         const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;

        if (isOnline()) {
            try {
                console.log(`Attempting to save/sync to Firestore: ${currentYear}-${currentMonth}`);
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, saveData, { merge: true });
                localStorage.removeItem(pendingSyncKey);
                console.log(`Data successfully saved to Firestore: ${currentYear}-${currentMonth}`);
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                showErrorNotification('Chyba pri ukladan√≠ d√°t do cloudu: ' + error.message);
                localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
                localStorage.setItem(localKey, JSON.stringify(saveData));
            }
        } else {
            console.log('Offline: Marking data for later synchronization and saving locally.');
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
            localStorage.setItem(localKey, JSON.stringify(saveData));
            showSaveNotification('Ste offline, d√°ta ulo≈æen√© lok√°lne.');
        }
    }

    async function syncWithFirebase() {
        if (!currentUser || !isOnline()) return;
        console.log('Checking for pending data to sync...');
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingDataString = localStorage.getItem(pendingSyncKey);

        if (pendingDataString) {
            console.log('Found pending data, syncing with Firestore...');
            try {
                const dataToSync = JSON.parse(pendingDataString);
                dataToSync.lastUpdated = new Date().toISOString();
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, dataToSync, { merge: true });
                console.log('Pending data synced to Firestore.');
                localStorage.removeItem(pendingSyncKey);
                showSaveNotification('Offline d√°ta boli synchronizovan√©.');
            } catch (error) {
                console.error('Error syncing pending data:', error);
                showErrorNotification('Chyba pri synchroniz√°cii offline d√°t: ' + error.message);
            }
        } else {
            console.log('No pending data to sync.');
        }
    }

    window.loadFromFirestore = async function() {
         if (!currentUser) { showErrorNotification('Pre naƒç√≠tanie z Firebase sa mus√≠te prihl√°si≈•.'); return; }
         if (!isOnline()) { showErrorNotification('Ste offline. Naƒç√≠tanie z Firebase vy≈æaduje internet.'); return; }
         if (!confirm('Naozaj chcete manu√°lne naƒç√≠ta≈• d√°ta z Firebase? Prep√≠≈°u sa t√Ωm aktu√°lne lok√°lne d√°ta pre tento mesiac.')) { return; }
         console.log(`Manual load from Firestore initiated for ${currentYear}-${currentMonth}`);
         try {
             const userRef = doc(db, 'users', currentUser.uid);
             const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
             const docSnap = await getDoc(docRef);
             const localKey = `workData-${currentYear}-${currentMonth}`;
             if (docSnap.exists()) {
                 const storedData = docSnap.data();
                 const dataString = JSON.stringify(storedData);
                 console.log('Manual load successful, applying data.');
                 localStorage.setItem(localKey, dataString);
                 localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`);
                 parseAndApplyData(dataString);
                 showSaveNotification('D√°ta boli √∫spe≈°ne naƒç√≠tan√© z Firebase.');
             } else {
                 console.log('Manual load: No data found in Firestore.');
                 localStorage.removeItem(localKey);
                 localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`);
                 parseAndApplyData(null);
                 showErrorNotification('Pre tento mesiac neboli vo Firebase n√°jden√© ≈æiadne d√°ta.');
             }
         } catch (error) {
             console.error('Chyba pri manu√°lnom naƒç√≠tavan√≠ z Firestore:', error);
             showErrorNotification('Chyba pri naƒç√≠tavan√≠ d√°t z Firebase: ' + error.message);
         }
     };

    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        console.log(`Loading from localStorage only for key: ${localKey}. Data found: ${!!localData}`);
        parseAndApplyData(localData);
    }

    function parseAndApplyData(dataString) {
        if (!dataString) {
            console.log("parseAndApplyData received null/undefined, clearing table and resetting totals.");
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                     resetRow(i, false);
                }
            }
             updateGreeting();
             calculateTotal();
            return;
        }

        try {
            const storedData = JSON.parse(dataString);
            console.log("Parsing and applying data from source (LS or FS):", storedData);

            hourlyWage = storedData.hourlyWage !== undefined ? storedData.hourlyWage : hourlyWage;
            taxRate = storedData.taxRate !== undefined ? storedData.taxRate : taxRate;
            employeeName = storedData.employeeName !== undefined ? storedData.employeeName : employeeName;
            decimalPlaces = storedData.decimalPlaces !== undefined ? storedData.decimalPlaces : decimalPlaces;

            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;
            updateGreeting();

            localStorage.setItem('hourlyWage', hourlyWage);
            localStorage.setItem('taxRate', taxRate);
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces);

            const daysInMonth = getDaysInMonth(currentMonth);
            if (storedData.data && Array.isArray(storedData.data)) {
                const dataFromSource = storedData.data;
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayIndex = i - 1;
                    const dayData = dataFromSource[dayIndex];
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                    const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
                    if (startElement && endElement && breakElement && noteElement) {
                        if (dayData) {
                            startElement.value = dayData.start || ''; endElement.value = dayData.end || '';
                            breakElement.value = dayData.breakTime || ''; noteElement.value = dayData.note || '';
                        } else {
                            startElement.value = ''; endElement.value = ''; breakElement.value = ''; noteElement.value = '';
                        }
                        calculateRow(i);
                    }
                }
            } else {
                console.warn("Stored data is missing or has incorrect format (.data array). Clearing table.");
                for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); }
            }
            calculateTotal();
        } catch (error) {
            console.error('Chyba pri parsovan√≠ alebo aplikovan√≠ d√°t:', error, "Data string:", dataString);
            showErrorNotification('Chyba pri spracovan√≠ ulo≈æen√Ωch d√°t: ' + error.message);
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) { resetRow(i, false); }
            calculateTotal();
        }
    }


    // --- Tvorba tabuƒæky a V√Ωpoƒçty ---
    function getDayName(year, month, day) {
        const daysOfWeek = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
     }
    function createTable() {
      workDays.innerHTML = '';
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);
      if(daysInMonth <= 0){
           console.error(`Invalid number of days in month: ${daysInMonth} for ${currentMonth}/${currentYear}`);
           return;
      }
      console.log(`Creating table structure for ${daysInMonth} days...`);
      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }
        const dayName = getDayName(currentYear, currentMonth, i);
        const startId = `start-${currentYear}-${currentMonth}-${i}`;
        const endId = `end-${currentYear}-${currentMonth}-${i}`;
        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
        const noteId = `note-${currentYear}-${currentMonth}-${i}`;
        const totalId = `total-${currentYear}-${currentMonth}-${i}`;
        const grossId = `gross-${currentYear}-${currentMonth}-${i}`;
        const netId = `net-${currentYear}-${currentMonth}-${i}`;
        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td><div class="time-input-wrapper"><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}')"><span class="time-btn" onclick="setCurrentTime('${startId}')" title="Zada≈• aktu√°lny ƒças">üïí</span></div></td>
          <td><div class="time-input-wrapper"><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}')"><span class="time-btn" onclick="setCurrentTime('${endId}')" title="Zada≈• aktu√°lny ƒças">üïí</span></div></td>
          <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
          <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><textarea id="${noteId}" placeholder="Pozn√°mka..." oninput="calculateAndUpdateTotals()" rows="1"></textarea></td>
          <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        workDays.appendChild(row);
      }
      console.log("Table structure created.");
     }
    window.setCurrentTime = function(inputId) {
        const now = new Date(); const hours = now.getHours().toString().padStart(2, '0'); const minutes = now.getMinutes().toString().padStart(2, '0'); const currentTime = `${hours}:${minutes}`;
        const targetInput = document.getElementById(inputId);
        if (targetInput) { targetInput.value = currentTime; const day = parseInt(inputId.split('-')[3]); if (!isNaN(day)) { calculateRow(day); calculateAndUpdateTotals(); } }
    }
    window.handleInput = function(input, nextId) { formatAndMoveNext(input, nextId); calculateAndUpdateTotals(); }
    window.handleBreakInput = function(day) { calculateRow(day); calculateAndUpdateTotals(); }
    function calculateAndUpdateTotals() { calculateTotal(); const saveData = collectCurrentData(); const localKey = `workData-${currentYear}-${currentMonth}`; localStorage.setItem(localKey, JSON.stringify(saveData)); debouncedSaveToFirestore(); }
    function isValidTimeFormat(timeString) { if (!timeString) return false; return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
    function formatAndMoveNext(input, nextId) { let v = input.value.replace(/[^\d:]/g, ''); let o = input.value; let c = input.selectionStart; if (v.length === 2 && !v.includes(':') && v.length > o.replace(/[^\d]/g, '').length) v += ':'; else if (v.length === 4 && !v.includes(':')) v = v.substring(0, 2) + ':' + v.substring(2); else if (v.length === 3 && !v.includes(':') && v.length > o.replace(/[^\d:]/g, '').length) v = v.substring(0, 2) + ':' + v.substring(2); v = v.replace(/^:/, ''); if ((v.match(/:/g) || []).length > 1) { const p = v.split(':'); v = p[0] + ':' + p.slice(1).join(''); } if (v.length > 5) v = v.slice(0, 5); if (input.value !== v) { input.value = v; try { if (v.length === 3 && o.length === 2 && v.endsWith(':')) input.setSelectionRange(3, 3); else input.setSelectionRange(c, c); } catch (e) {} } const day = parseInt(input.id.split('-')[3]); calculateRow(day); if (v.length === 5 && isValidTimeFormat(v)) { moveNext(input, nextId); } }
    function moveNext(currentElement, nextId) { const nextElement = document.getElementById(nextId); if (nextElement) { nextElement.focus(); if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') nextElement.select(); } }
    function calculateRow(day) { const sId = `start-${currentYear}-${currentMonth}-${day}`; const eId = `end-${currentYear}-${currentMonth}-${day}`; const bId = `break-${currentYear}-${currentMonth}-${day}`; const tId = `total-${currentYear}-${currentMonth}-${day}`; const gId = `gross-${currentYear}-${currentMonth}-${day}`; const nId = `net-${currentYear}-${currentMonth}-${day}`; const sI = document.getElementById(sId); const eI = document.getElementById(eId); const bI = document.getElementById(bId); const tC = document.getElementById(tId); const gI = document.getElementById(gId); const nI = document.getElementById(nId); if (!sI||!eI||!bI||!tC||!gI||!nI) return; const sT = sI.value; const eT = eI.value; const bT = parseFloat(bI.value)||0; if(!isValidTimeFormat(sT)||!isValidTimeFormat(eT)){tC.textContent=`0h 0m (${(0).toFixed(decimalPlaces)} h)`;gI.value=(0).toFixed(decimalPlaces);nI.value=(0).toFixed(decimalPlaces);return;} const [sH,sM]=sT.split(':').map(Number); const [eH,eM]=eT.split(':').map(Number); const sD=new Date(2000,0,1,sH,sM); const eD=new Date(2000,0,1,eH,eM); let dMs=eD.getTime()-sD.getTime(); if(dMs<0)dMs+=86400000; let dMn=dMs/60000; const bMn=bT*60; dMn-=bMn; if(dMn<0)dMn=0; const dH=dMn/60; const tMR=Math.round(dMn); const hrs=Math.floor(tMR/60); const mns=tMR%60; tC.textContent=`${hrs}h ${mns}m (${dH.toFixed(decimalPlaces)} h)`; const gS=dH*hourlyWage; gI.value=Math.max(0,gS).toFixed(decimalPlaces); updateNetSalary(day); }
    function updateNetSalary(day) { const gId=`gross-${currentYear}-${currentMonth}-${day}`; const nId=`net-${currentYear}-${currentMonth}-${day}`; const gI=document.getElementById(gId); const nI=document.getElementById(nId); if(!gI||!nI)return; const gS=parseFloat(gI.value)||0; const nS=gS*(1-taxRate); nI.value=Math.max(0,nS).toFixed(decimalPlaces); }
    window.resetRow = function(day, saveChanges = true) { console.log(`Resetting row ${day}, saveChanges: ${saveChanges}`); const sI = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const eI = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const bI = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const nI = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); if(sI) sI.value=''; if(eI) eI.value=''; if(bI) bI.value=''; if(nI) nI.value=''; calculateRow(day); if (saveChanges) calculateAndUpdateTotals(); }
    function calculateTotal() { let tMP=0; let tGSP=0; let tNSP=0; let dWE=0; const dIM=getDaysInMonth(currentMonth); for(let i=1;i<=dIM;i++){ const sI=document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const eI=document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const bI=document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); const nI=document.getElementById(`note-${currentYear}-${currentMonth}-${i}`); if(!sI||!eI||!bI)continue; const sT=sI.value; const eT=eI.value; const bT=parseFloat(bI.value)||0; const nV=nI?nI.value:''; let dMn=0; let dGS=0; let dNS=0; let hE=false; if(isValidTimeFormat(sT)&&isValidTimeFormat(eT)){ const [sH,sM]=sT.split(':').map(Number); const [eH,eM]=eT.split(':').map(Number); const sD=new Date(2000,0,1,sH,sM); const eD=new Date(2000,0,1,eH,eM); let dMs=eD.getTime()-sD.getTime(); if(dMs<0)dMs+=86400000; let diffMn=dMs/60000; const bMn=bT*60; diffMn-=bMn; if(diffMn<0)diffMn=0; dMn=diffMn; const dDH=diffMn/60; dGS=Math.max(0,dDH*hourlyWage); dNS=Math.max(0,dGS*(1-taxRate)); if(dMn>0)hE=true; } if(sT||eT||(bT&&bT>0)||nV)hE=true; tMP+=dMn; tGSP+=dGS; tNSP+=dNS; if(hE)dWE++; } const tMR=Math.round(tMP); const tH=Math.floor(tMR/60); const tMRm=tMR%60; const tDH=tMP/60; const aNSP=dWE>0?tNSP/dWE:0; const aWMP=dWE>0?tMP/dWE:0; const aMR=Math.round(aWMP); const aH=Math.floor(aMR/60); const aM=aMR%60; const aDH=aWMP/60; totalSalaryDiv.innerHTML=` Zapoƒç√≠tan√Ωch dn√≠: ${dWE}<br> Celkov√Ω ƒças: ${tH}h ${tMRm}m (${tDH.toFixed(decimalPlaces)} h)<br> Hrub√° mzda: ${tGSP.toFixed(decimalPlaces)} ‚Ç¨<br> ƒåist√° mzda: ${tNSP.toFixed(decimalPlaces)} ‚Ç¨<br> Priem. ƒçist√° mzda/de≈à: ${aNSP.toFixed(decimalPlaces)} ‚Ç¨<br> <strong>Priem. ƒças/de≈à: ${aH}h ${aM}m (${aDH.toFixed(decimalPlaces)} h)</strong> `; }
    function getMonthName(month) { const mN=["Janu√°r","Febru√°r","Marec","Apr√≠l","M√°j","J√∫n","J√∫l","August","September","Okt√≥ber","November","December"]; if(month>=0&&month<mN.length)return mN[month]; return "Nezn√°my mesiac"; }

    // --- Exporty a Z√°lohy ---
    window.exportToPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch (e) { console.warn("Roboto font load failed, using helvetica."); doc.setFont('helvetica', 'normal'); } doc.setFontSize(16); doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tD = []; const dIM = getDaysInMonth(currentMonth); for (let i = 1; i <= dIM; i++) { const dN=getDayName(currentYear,currentMonth,i); const sT=document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const eT=document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const bT=document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; const n=document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value||''; const tTC=document.getElementById(`total-${currentYear}-${currentMonth}-${i}`); const tTT=tTC?tTC.textContent.trim():''; const gS=document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value||'0'; const nS=document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value||'0'; if(sT||eT||(bT&&parseFloat(bT)>0)||n){ tD.push([ `${i}. ${dN}`, sT, eT, bT||'0', tTT, n, `${parseFloat(gS).toFixed(decimalPlaces)} ‚Ç¨`, `${parseFloat(nS).toFixed(decimalPlaces)} ‚Ç¨` ]); } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)','Odpracovan√©','Pozn√°mka','Hrub√° Mzda','ƒåist√° Mzda']], body:tD, startY:38, theme:'grid', styles:{font:doc.getFont().fontName, fontSize:9, cellPadding:2, valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:10,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{0:{cellWidth:18},1:{cellWidth:15,halign:'center'},2:{cellWidth:15,halign:'center'},3:{cellWidth:18,halign:'center'},4:{cellWidth:25,halign:'center'},5:{cellWidth:35},6:{cellWidth:23,halign:'right'},7:{cellWidth:23,halign:'right'}}, }); const tY=doc.lastAutoTable.finalY+10; doc.setFontSize(11); const tTCt=totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi,'\n').replace(/<\/?strong>/gi,'').replace(/ /g,' ').replace(/‚Ç¨/g,' EUR'); doc.text(tTCt,14,tY); const sEN=employeeName.replace(/[^a-zA-Z0-9]/g,'_')||'Nezadane'; doc.save(`Vykaz_prace_${sEN}_${getMonthName(currentMonth)}_${currentYear}.pdf`); };
    window.sendPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch (e) { doc.setFont('helvetica', 'normal'); } doc.setFontSize(16); doc.text(`Z√°znam doch√°dzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tD = []; const dIM = getDaysInMonth(currentMonth); for (let i = 1; i <= dIM; i++) { const dN=getDayName(currentYear,currentMonth,i); const sT=document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const eT=document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const bT=document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; if(sT||eT||(bT&&parseFloat(bT)>0)){ tD.push([`${i}. ${dN}`, sT, eT, bT||'0']); } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)']], body:tD, startY:38, theme:'grid', styles:{font:doc.getFont().fontName, fontSize:10, cellPadding:3, valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:11,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{0:{cellWidth:50},1:{cellWidth:40,halign:'center'},2:{cellWidth:40,halign:'center'},3:{cellWidth:40,halign:'center'}} }); try { const pB=doc.output('blob'); const sEN=employeeName.replace(/[^a-zA-Z0-9]/g,'_')||'Nezadane'; const pFN=`Dochadzka_${sEN}_${getMonthName(currentMonth)}_${currentYear}.pdf`; const pF=new File([pB],pFN,{type:'application/pdf'}); if(navigator.canShare&&navigator.canShare({files:[pF]})){ navigator.share({files:[pF],title:`Doch√°dzka ${getMonthName(currentMonth)} ${currentYear}`,text:`Z√°znam doch√°dzky pre ${employeeName} za ${getMonthName(currentMonth)} ${currentYear}.`}).then(()=>console.log('PDF (doch√°dzka) zdieƒæan√©')).catch(e=>{if(e.name!=='AbortError'){console.error('Chyba zdieƒæania:',e); showErrorNotification('Chyba pri zdieƒæan√≠ PDF: '+e.message);}else{console.log('Zdieƒæanie zru≈°en√©');}}); } else { showErrorNotification('Zdieƒæanie s√∫borov nie je podporovan√©.'); doc.save(pFN); } } catch (e) { console.error('Chyba generovania PDF na zdieƒæanie:', e); showErrorNotification('Chyba pri pr√≠prave PDF: '+e.message); } };
    window.createBackup = function() { const bD=collectCurrentData(); const k=`workData-${currentYear}-${currentMonth}`; if(localStorage.getItem(k)||bD.data.some(d=>d.start||d.end||d.breakTime||d.note)){ try{ const wD=[["De≈à","Pr√≠chod","Odchod","Prest√°vka (h)","Pozn√°mka"]]; if(bD.data&&Array.isArray(bD.data)){ const dIM=getDaysInMonth(currentMonth); const dTE=bD.data.slice(0,dIM); dTE.forEach((r,idx)=>{ const dN=idx+1; const dNm=getDayName(currentYear,currentMonth,dN); wD.push([`${dN}. ${dNm}`,r.start||"",r.end||"",r.breakTime||"",r.note||""]); }); } wD.push([]); wD.push(["Nastavenia:","Hodnota"]); wD.push(["Hodinov√° mzda",bD.hourlyWage]); wD.push(["Da≈àov√© percento (%)",bD.taxRate*100]); wD.push(["Meno pracovn√≠ka",bD.employeeName]); wD.push(["Poƒçet desatinn√Ωch miest",bD.decimalPlaces]); wD.push(["Posledn√° aktualiz√°cia",bD.lastUpdated?new Date(bD.lastUpdated).toLocaleString('sk-SK'):"Nezn√°ma"]); const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(wD); const tF="hh:mm"; const bF="0.0"; const dER=(bD.data?bD.data.length:0)+1; for(let R=1;R<dER;++R){ if(ws[XLSX.utils.encode_cell({c:1,r:R})])ws[XLSX.utils.encode_cell({c:1,r:R})].z=tF; if(ws[XLSX.utils.encode_cell({c:2,r:R})])ws[XLSX.utils.encode_cell({c:2,r:R})].z=tF; if(ws[XLSX.utils.encode_cell({c:3,r:R})])ws[XLSX.utils.encode_cell({c:3,r:R})].z=bF; } ws['!cols']=[{wch:12},{wch:8},{wch:8},{wch:10},{wch:25}]; const sRI=wD.findIndex(r=>r[0]==="Nastavenia:"); if(sRI!==-1)ws['!cols'][0].wch=Math.max(ws['!cols'][0].wch,25); XLSX.utils.book_append_sheet(wb,ws,`V√Ωkaz ${getMonthName(currentMonth)}`); const sEN=employeeName.replace(/[^a-zA-Z0-9]/g,'_')||'Nezadane'; XLSX.writeFile(wb,`Zaloha_BrunoCalc_${sEN}_${getMonthName(currentMonth)}_${currentYear}.xlsx`); showSaveNotification('Z√°loha bola √∫spe≈°ne vytvoren√°.'); }catch(e){console.error('Chyba pri vytv√°ran√≠ z√°lohy:',e); showErrorNotification('Chyba pri vytv√°ran√≠ z√°lohy: '+e.message);} }else{showErrorNotification('Nie s√∫ dostupn√© ≈æiadne d√°ta na z√°lohu pre tento mesiac.');}};
    window.restoreBackup = function() { const i=document.createElement('input'); i.type='file'; i.accept='.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'; i.onchange=function(ev){ const f=ev.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){ try{ const d=new Uint8Array(e.target.result); const wB=XLSX.read(d,{type:'array',cellDates:false,cellNF:true}); const sN=wB.SheetNames[0]; const ws=wB.Sheets[sN]; const rws=XLSX.utils.sheet_to_json(ws,{header:1,defval:"",raw:false}); const hRI=rws.findIndex(rw=>rw&&rw[0]?.toString().toLowerCase().includes("de≈à")); if(hRI===-1)throw new Error("Hlaviƒçka tabuƒæky ('De≈à', ...) nebola n√°jden√°."); const hdr=rws[hRI]; const dIdx=hdr.findIndex(h=>h?.toString().toLowerCase().includes("de≈à")); const sIdx=hdr.findIndex(h=>h?.toString().toLowerCase().includes("pr√≠chod")); const eIdx=hdr.findIndex(h=>h?.toString().toLowerCase().includes("odchod")); const bIdx=hdr.findIndex(h=>h?.toString().toLowerCase().includes("prest√°vka")); const nIdx=hdr.findIndex(h=>h?.toString().toLowerCase().includes("pozn√°mka")); if(dIdx===-1||sIdx===-1||eIdx===-1||bIdx===-1)throw new Error("Nepodarilo sa n√°js≈• povinn√© stƒ∫pce: De≈à, Pr√≠chod, Odchod, Prest√°vka."); let dA=[]; let s={}; let j=hRI+1; for(;j<rws.length;j++){ const rw=rws[j]; if(!rw||rw.length===0||!(rw[dIdx]?.toString().match(/^\d+\./i)))break; const sC=ws[XLSX.utils.encode_cell({c:sIdx,r:j})]; const eC=ws[XLSX.utils.encode_cell({c:eIdx,r:j})]; const bC=ws[XLSX.utils.encode_cell({c:bIdx,r:j})]; let sTS=sC?.w||sC?.v?.toString()||""; let eTS=eC?.w||eC?.v?.toString()||""; let bTS=bC?.w||bC?.v?.toString()||""; if(sC?.t==='n'&&sC.z&&sC.z.includes('h'))sTS=XLSX.SSF.format('hh:mm',sC.v); if(eC?.t==='n'&&eC.z&&eC.z.includes('h'))eTS=XLSX.SSF.format('hh:mm',eC.v); dA.push({start:sTS,end:eTS,breakTime:bTS.replace(',','.'),note:(nIdx!==-1&&rw[nIdx]!==undefined)?rw[nIdx].toString():""}); } for(;j<rws.length;j++){ const rw=rws[j]; if(rw&&rw.length>1&&rw[0]&&typeof rw[0]==='string'){ const k=rw[0].toString().trim().toLowerCase(); const v=rw[1]?.toString().trim()||""; if(k.includes("hodinov√° mzda"))s.hourlyWage=parseFloat(v.replace(',','.'))||undefined; else if(k.includes("da≈àov√© percento"))s.taxRate=(parseFloat(v.replace(',','.').replace('%',''))||undefined)/100; else if(k.includes("meno pracovn√≠ka"))s.employeeName=v||undefined; else if(k.includes("poƒçet desatinn√Ωch miest"))s.decimalPlaces=parseInt(v)||undefined; } } const bD={ data:dA, hourlyWage:s.hourlyWage!==undefined?s.hourlyWage:hourlyWage, taxRate:s.taxRate!==undefined?s.taxRate:taxRate, employeeName:s.employeeName!==undefined?s.employeeName:employeeName, decimalPlaces:s.decimalPlaces!==undefined?s.decimalPlaces:decimalPlaces, lastUpdated:new Date().toISOString() }; if(!confirm(`Naƒç√≠tan√° z√°loha obsahuje ${dA.length} dn√≠. Naozaj chcete prep√≠sa≈• aktu√°lne d√°ta pre ${getMonthName(currentMonth)} ${currentYear}?`))return; const lK=`workData-${currentYear}-${currentMonth}`; localStorage.setItem(lK,JSON.stringify(bD)); localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); parseAndApplyData(JSON.stringify(bD)); showSaveNotification('Z√°loha bola √∫spe≈°ne obnoven√° a naƒç√≠tan√°.'); if(currentUser&&isOnline())saveToFirestore(); }catch(e){console.error('Chyba pri naƒç√≠tavan√≠ z√°lohy:',e); showErrorNotification('Chyba pri naƒç√≠tavan√≠ z√°lohy: '+e.message);} }; r.onerror=function(){showErrorNotification('Chyba pri ƒç√≠tan√≠ s√∫boru.');} r.readAsArrayBuffer(f); }; i.click(); };

    // --- Spr√°va nastaven√≠ ---
    window.changeDecimalPlaces = function() { decimalPlaces = parseInt(decimalPlacesSelect.value); localStorage.setItem('decimalPlaces', decimalPlaces); for(let i=1;i<=getDaysInMonth(currentMonth);i++){if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`))calculateRow(i);} calculateAndUpdateTotals(); }
    window.updateEmployeeName = function() { employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); calculateAndUpdateTotals(); }
    window.updateSettings = function() { const nHW=parseFloat(hourlyWageInput.value); const nTRP=parseFloat(taxRateInput.value); if(!isNaN(nHW)&&nHW>=0)hourlyWage=nHW; else hourlyWageInput.value=hourlyWage; if(!isNaN(nTRP)&&nTRP>=0)taxRate=nTRP/100; else taxRateInput.value=(taxRate*100).toFixed(1); localStorage.setItem('hourlyWage',hourlyWage); localStorage.setItem('taxRate',taxRate); for(let i=1;i<=getDaysInMonth(currentMonth);i++){if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`))calculateRow(i);} calculateAndUpdateTotals(); }
    window.changeMonth = function() { const oM=currentMonth; currentMonth=parseInt(monthSelect.value); console.log(`Changing month from ${getMonthName(oM)} to ${getMonthName(currentMonth)}`); updateUI(); }
    window.changeYear = function() { const oY=currentYear; currentYear=parseInt(yearSelect.value); console.log(`Changing year from ${oY} to ${currentYear}`); updateUI(); }
    function getDaysInMonth(month) { if(month<0||month>11){console.error(`Invalid month index: ${month}`); return 0;} const days=new Date(currentYear,month+1,0).getDate(); /* console.log(`getDaysInMonth(${month}) for year ${currentYear} returned: ${days}`); */ return days||0; }

    // --- Inicializ√°cia a Listener pre Auth State ---
    onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed. User:', user ? user.email : 'None');
        const previousUserUid = currentUser?.uid;
        currentUser = user;
        if (previousUserUid !== currentUser?.uid) {
             console.log("User UID changed, calling updateUI.");
             updateUI();
        } else {
             console.log("User UID did not change, skipping updateUI call from onAuthStateChanged (unless network changed).");
             if(isOnline() && currentUser) {
                 syncWithFirebase();
             } else if (!isOnline() && currentUser) {
                 updateUI();
             }
        }
    });

  </script>

  <script>
    // Service Worker registr√°cia
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, ≈æe cesta je spr√°vna
          .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
          .catch(error => { console.error('ServiceWorker registration failed: ', error); });
      });
    }
  </script>
</body>
</html>
