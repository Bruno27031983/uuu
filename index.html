<!DOCTYPE html>
<html lang="sk" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- OPRAVEN√â CSP: Pridan√© 'unsafe-inline' a 'unsafe-eval' pre funkƒçnos≈• inline scriptov a kni≈æn√≠c -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://www.gstatic.com https://apis.google.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob: https:;
    connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com wss://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com;
    frame-src 'self' https://*.firebaseapp.com https://www.google.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <title>Bruno's Calculator Pro+</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
  <meta name="theme-color" content="#7c3aed"/>

  <!-- Kni≈ænice pre export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    :root {
      /* Svetl√Ω re≈æim (Light Mode) */
      --primary-bg-color: #f0f2f5;
      --secondary-bg-color: #ffffff;
      --primary-text-color: #1f2937;
      --secondary-text-color: #4b5563;
      --input-bg-color: #fefcbf;
      --input-note-bg-color: #e0f2fe;
      --input-project-bg-color: #e0fef2;
      --table-header-bg-color: #f9fafb;
      --table-border-color: #e5e7eb;
      --current-day-bg-color: #7c3aed;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #2563eb;
      --btn-primary-hover-bg: #1d4ed8;
      --btn-secondary-bg: #7c3aed;
      --btn-secondary-hover-bg: #6d28d9;
      --btn-danger-bg: #dc2626;
      --btn-warning-bg: #f59e0b;
      --btn-warning-hover-bg: #d97706;
      --btn-text-color: #ffffff;
      --total-salary-bg: #eff6ff;
      --link-color: #2563eb;
      --focus-outline-color: #2563eb;
      --transition-speed: 0.3s;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Tmav√Ω re≈æim (Dark Mode) */
    html[data-theme='dark'] {
      --primary-bg-color: #111827;
      --secondary-bg-color: #1f2937;
      --primary-text-color: #f3f4f6;
      --secondary-text-color: #9ca3af;
      --input-bg-color: #374151;
      --input-note-bg-color: #2c3a4b;
      --input-project-bg-color: #2c4b3a;
      --table-header-bg-color: #374151;
      --table-border-color: #4b5563;
      --current-day-bg-color: #8b5cf6;
      --btn-primary-bg: #3b82f6;
      --btn-secondary-bg: #8b5cf6;
      --btn-danger-bg: #ef4444;
      --btn-warning-bg: #f97316;
      --total-salary-bg: #374151;
      --link-color: #60a5fa;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2') format('woff2');
      font-weight: 400 700;
      font-display: swap;
    }

    body {
      font-family: var(--font-family); margin: 0; padding: 12px;
      background-color: var(--primary-bg-color); color: var(--primary-text-color);
      transition: background-color var(--transition-speed), color var(--transition-speed);
      font-size: 0.92rem;
    }

    #app-loader {
      display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh;
      font-size: 1.2em; color: var(--secondary-text-color); background-color: var(--primary-bg-color);
    }
    .loader-emoji { font-size: 2em; margin-bottom: 10px; }

    .container {
      max-width: 1600px; margin: 20px auto; background: var(--secondary-bg-color);
      padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow);
      display: none; /* Skryt√© k√Ωm sa nenaƒç√≠ta */
    }

    h1 { text-align: center; margin-bottom: 5px; }
    h1#mainTitle {
      background: linear-gradient(45deg, #7c3aed, #db2777, #f59e0b);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    h2 { text-align: center; color: var(--secondary-text-color); font-weight: 500; margin-top: 0; }

    /* Ovl√°danie v hlaviƒçke (Login, Theme) */
    .header-controls {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
    }
    #user-info { display: flex; align-items: center; gap: 10px; font-weight: 500; }
    #themeToggleBtn { font-size: 1.2rem; padding: 6px 10px; background: var(--btn-secondary-bg); border: none; border-radius: 4px; cursor: pointer; }

    /* Auth Formul√°r */
    #auth-container { margin-bottom: 20px; }
    #login-fieldset { max-width: 400px; margin: 0 auto; border: 1px solid var(--table-border-color); border-radius: var(--border-radius); padding: 15px; }
    #login-form { display: flex; flex-direction: column; gap: 10px; }
    #login-form input { padding: 10px; border: 1px solid var(--table-border-color); border-radius: 4px; }
    
    /* Nastavenia */
    .settings { margin-bottom: 20px; }
    #toggleSettingsBtn { width: 100%; text-align: left; background: var(--secondary-bg-color); border: 1px solid var(--table-border-color); padding: 10px; cursor: pointer; font-weight: 500; border-radius: var(--border-radius); color: var(--primary-text-color); }
    #settings-collapsible-content {
      max-height: 0; overflow: hidden; opacity: 0; transition: all 0.4s ease;
      display: flex; flex-wrap: wrap; gap: 15px; margin-top: 0;
    }
    #settings-collapsible-content.visible { max-height: 1000px; opacity: 1; margin-top: 15px; padding: 5px; }
    fieldset { border: 1px solid var(--table-border-color); border-radius: var(--border-radius); padding: 10px 15px; flex: 1 1 300px; }
    legend { font-weight: 600; padding: 0 5px; }
    .settings label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--secondary-text-color); }
    
    /* Tabuƒæka */
    .table-container { overflow-x: auto; margin-bottom: 20px; border: 1px solid var(--table-border-color); border-radius: var(--border-radius); }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th, td { padding: 10px; border: 1px solid var(--table-border-color); text-align: left; font-size: 0.9rem; }
    th { background-color: var(--table-header-bg-color); position: sticky; top: 0; z-index: 5; font-weight: 600; }
    
    /* ≈†√≠rky stƒ∫pcov */
    th:nth-child(1), td:nth-child(1) { width: 100px; } /* De≈à */
    th:nth-child(2), td:nth-child(2) { width: 110px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { width: 110px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 90px; }  /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { width: 120px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { width: 160px; } /* Projekt - NOV√ù */
    th:nth-child(7), td:nth-child(7) { min-width: 200px; } /* Pozn√°mka */
    th:nth-child(8), td:nth-child(8) { width: 90px; }  /* Hrub√° */
    th:nth-child(9), td:nth-child(9) { width: 90px; }  /* ƒåist√° */
    th:nth-child(10), td:nth-child(10) { width: 50px; text-align: center; } /* Akcie */

    /* Inputy v tabuƒæke */
    input, select, textarea {
      width: 100%; padding: 8px; box-sizing: border-box; background-color: var(--input-bg-color);
      border: 1px solid var(--table-border-color); border-radius: 4px; color: var(--primary-text-color); font-family: inherit;
    }
    input:focus, textarea:focus { outline: 2px solid var(--focus-outline-color); border-color: transparent; }
    
    .time-input-wrapper { display: flex; align-items: center; gap: 4px; }
    .time-btn { cursor: pointer; background: none; border: none; font-size: 1.1rem; padding: 2px; }
    
    tr.weekend-day td:first-child { background-color: rgba(0,0,0,0.05); color: var(--secondary-text-color); }
    html[data-theme='dark'] tr.weekend-day td:first-child { background-color: rgba(255,255,255,0.05); }

    .current-day { background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color); }
    .current-day input, .current-day textarea { background-color: rgba(255,255,255,0.2) !important; color: white !important; border-color: rgba(255,255,255,0.4); }
    .current-day input::placeholder { color: rgba(255,255,255,0.7); }
    .current-day .time-btn { filter: brightness(2); }

    td input.project-input { background-color: var(--input-project-bg-color); }
    textarea { resize: vertical; min-height: 38px; background-color: var(--input-note-bg-color); }
    input[readonly] { background-color: var(--table-header-bg-color); border: none; font-weight: 500; }

    /* Celkov√° mzda a tlaƒçidl√° */
    #totalSalary {
      margin-top: 20px; padding: 20px; background-color: var(--total-salary-bg);
      border-radius: var(--border-radius); text-align: center; font-size: 1.1rem;
      box-shadow: var(--box-shadow);
    }
    .goal-progress { font-size: 0.9em; margin-top: 10px; font-weight: 600; }
    .goal-progress.good { color: #10b981; }
    .goal-progress.medium { color: #f59e0b; }
    .goal-progress.low { color: #ef4444; }

    .btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 25px; }
    .btn {
      padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white;
      font-weight: 500; transition: transform 0.1s;
    }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .export-btn { background-color: var(--btn-primary-bg); }
    .backup-btn { background-color: var(--btn-secondary-bg); }
    .reset-btn { background-color: var(--btn-danger-bg); }
    .warning-btn { background-color: var(--btn-warning-bg); }
    
    /* Notifik√°cie */
    #saveNotification, #errorNotification, #warningNotification {
      position: fixed; bottom: 20px; right: 20px; padding: 15px; border-radius: 6px; color: white;
      display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideUp 0.3s ease;
    }
    #saveNotification { background-color: #10b981; }
    #errorNotification { background-color: var(--btn-danger-bg); }
    #warningNotification { background-color: var(--btn-warning-bg); color: black; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Responsivita */
    @media (max-width: 768px) {
      .container { padding: 10px; margin: 0; }
      th, td { padding: 5px; font-size: 0.8rem; }
      .btn { width: 100%; margin-bottom: 5px; }
      #settings-collapsible-content { flex-direction: column; }
    }
  </style>
</head>
<body>

  <!-- Loading obrazovka -->
  <div id="app-loader">
    <div class="loader-emoji">üßÆ</div>
    <p>Bruno's Calculator Pro+</p>
    <small>Naƒç√≠tavam aplik√°ciu...</small>
  </div>

  <!-- Hlavn√Ω kontajner -->
  <div class="container" id="main-container">
    
    <!-- Auth Sekcia -->
    <div id="auth-container">
      <div class="header-controls">
        <div id="user-info" style="display: none;">
          <span id="user-email"></span>
          <button class="btn reset-btn" onclick="logoutUser()" style="padding: 5px 10px; font-size: 0.8rem;">Odhl√°si≈•</button>
        </div>
        <!-- Tmav√Ω re≈æim tlaƒçidlo -->
        <button id="themeToggleBtn" title="Prepn√∫≈• tmav√Ω re≈æim">üåô</button>
      </div>

      <fieldset id="login-fieldset">
        <legend>Prihl√°senie / Registr√°cia</legend>
        <div id="login-form">
          <input type="email" id="email" placeholder="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
          <button class="btn export-btn" onclick="loginUser()">Prihl√°si≈• sa</button>
          <button class="btn backup-btn" onclick="registerUser()">Registrova≈•</button>
          <a href="#" onclick="resetUserPassword(); return false;" style="text-align:center; font-size:0.9rem;">Zabudol som heslo</a>
        </div>
      </fieldset>
    </div>

    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <button id="toggleSettingsBtn">Zobrazi≈• nastavenia aplik√°cie ‚ñº</button>
      <div id="settings-collapsible-content">
        <fieldset>
          <legend>Z√°kladn√© √∫daje</legend>
          <label>Meno pracovn√≠ka:</label>
          <input type="text" id="employeeNameInput" oninput="updateSettings()">
          
          <label>Hodinov√° mzda (‚Ç¨):</label>
          <input type="number" id="hourlyWageInput" step="0.1" oninput="updateSettings()">
          
          <label>Da≈àov√© percento (%):</label>
          <input type="number" id="taxRateInput" step="0.1" oninput="updateSettings()">

          <!-- NOV√â: Mesaƒçn√Ω cieƒæ -->
          <label>Mesaƒçn√Ω cieƒæ z√°robku (‚Ç¨):</label>
          <input type="number" id="monthlyGoalInput" placeholder="Napr. 1500" oninput="updateSettings()">
        </fieldset>
        
        <fieldset>
          <legend>Zobrazenie a ƒåas</legend>
          <label>Desatinn√© miesta:</label>
          <select id="decimalPlacesSelect" onchange="updateSettings()">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
          </select>
          <label>Mesiac:</label>
          <select id="monthSelect" onchange="changeDate()"></select>
          <label>Rok:</label>
          <select id="yearSelect" onchange="changeDate()"></select>
        </fieldset>
      </div>
    </div>

    <!-- Tabuƒæka -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Projekt / √öloha</th> <!-- Nov√Ω stƒ∫pec -->
            <th>Pozn√°mka</th>
            <th>Hrub√° (‚Ç¨)</th>
            <th>ƒåist√° (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <!-- S√∫hrn -->
    <div id="totalSalary">V√Ωpoƒçet...</div>
    <div id="localStorageIndicator" style="text-align: right; font-size: 0.8rem; color: var(--secondary-text-color);"></div>

    <!-- Tlaƒçidl√° -->
    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Export PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Zdieƒæa≈• PDF</button>
      <button class="btn backup-btn" onclick="createBackup()">Z√°loha (XLSX)</button>
      <button class="btn backup-btn" onclick="restoreBackup()">Obnovi≈• (XLSX)</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠ta≈• z Cloudu</button>
      <button class="btn reset-btn" onclick="clearMonthData()">Vymaza≈• Mesiac</button>
    </div>

  </div>

  <!-- Notifik√°cie -->
  <div id="saveNotification">Ulo≈æen√©.</div>
  <div id="errorNotification">Chyba!</div>
  <div id="warningNotification">Upozornenie.</div>

  <!-- APLIKAƒåN√Å LOGIKA -->
  <script type="module">
    // --- 1. FIREBASE KONFIGUR√ÅCIA ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED, collection, doc, setDoc, getDoc, writeBatch, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SEM VLO≈ΩTE SVOJE FIREBASE √öDAJE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Vyme≈àte za v√°≈° API Key
        authDomain: "uuuuu-f7ef9.firebaseapp.com",       // Vyme≈àte za va≈°u dom√©nu
        projectId: "uuuuu-f7ef9",                          // Vyme≈àte za ID projektu
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b"
    };

    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = initializeFirestore(app, { localCache: persistentLocalCache({ sizeBytes: CACHE_SIZE_UNLIMITED }) });
    } catch (e) {
        console.error("Firebase init failed:", e);
        showError("Chyba inicializ√°cie datab√°zy. Skontrolujte konfigur√°ciu.");
    }

    // --- 2. Premenn√© a UI Referencie ---
    let currentUser = null;
    let unsubscribeListener = null;
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    const ui = {
        tbody: document.getElementById('workDays'),
        totalDiv: document.getElementById('totalSalary'),
        loader: document.getElementById('app-loader'),
        container: document.getElementById('main-container'),
        loginFieldset: document.getElementById('login-fieldset'),
        userInfo: document.getElementById('user-info'),
        themeBtn: document.getElementById('themeToggleBtn')
    };

    let settings = {
        name: '', wage: 10, tax: 2, decimals: 2, theme: 'light', goal: null
    };

    const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
    const DAY_NAMES = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];

    // --- 3. THEME MANAGER (Dark Mode) ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        ui.themeBtn.onclick = () => {
            const newTheme = settings.theme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        };
    }

    function setTheme(theme) {
        settings.theme = theme;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        ui.themeBtn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        document.querySelector('meta[name="theme-color"]').content = theme === 'dark' ? '#1f2937' : '#7c3aed';
    }

    // --- 4. INICIALIZ√ÅCIA ---
    function init() {
        initTheme();
        loadSettingsLocally();
        
        // Naplnenie selectov
        const monthSel = document.getElementById('monthSelect');
        MONTH_NAMES.forEach((m, i) => {
            let opt = document.createElement('option'); opt.value = i; opt.textContent = m;
            monthSel.appendChild(opt);
        });
        monthSel.value = currentMonth;

        const yearSel = document.getElementById('yearSelect');
        for(let y = 2020; y <= currentYear + 2; y++) {
            let opt = document.createElement('option'); opt.value = y; opt.textContent = y;
            yearSel.appendChild(opt);
        }
        yearSel.value = currentYear;

        // Toggle nastaven√≠
        document.getElementById('toggleSettingsBtn').onclick = function() {
            const content = document.getElementById('settings-collapsible-content');
            content.classList.toggle('visible');
            this.textContent = content.classList.contains('visible') ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
        };

        renderTable();
        
        // Firebase Auth Listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            ui.loader.style.display = 'none';
            ui.container.style.display = 'block';
            updateAuthUI();
            if(user) {
                syncData(); 
            } else {
                loadDataLocally();
            }
        });
    }

    // --- 5. LOGIKA TABUƒΩKY ---
    function renderTable() {
        ui.tbody.innerHTML = '';
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const frag = document.createDocumentFragment();

        document.getElementById('mainTitle').textContent = `Vitaj ${settings.name ? settings.name : 'üëã'}`;
        document.getElementById('subTitle').textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;

        for(let i=1; i<=daysInMonth; i++) {
            const date = new Date(currentYear, currentMonth, i);
            const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
            const isToday = (i === currentDate.getDate() && currentMonth === currentDate.getMonth() && currentYear === currentDate.getFullYear());
            
            const tr = document.createElement('tr');
            if(isWeekend) tr.classList.add('weekend-day');
            if(isToday) tr.classList.add('current-day');

            tr.innerHTML = `
                <td>${i}. ${DAY_NAMES[date.getDay()]}</td>
                <td>
                    <div class="time-input-wrapper">
                        <input type="tel" id="start-${i}" placeholder="HH:MM" onblur="calcRow(${i}); saveData();">
                        <button class="time-btn" onclick="setCurrentTime('start-${i}', ${i})">üïí</button>
                    </div>
                </td>
                <td>
                    <div class="time-input-wrapper">
                        <input type="tel" id="end-${i}" placeholder="HH:MM" onblur="calcRow(${i}); saveData();">
                        <button class="time-btn" onclick="setCurrentTime('end-${i}', ${i})">üïí</button>
                    </div>
                </td>
                <td><input type="number" id="break-${i}" placeholder="hod." oninput="calcRow(${i}); saveData();"></td>
                <td id="total-${i}">0h 0m</td>
                <td><input type="text" id="project-${i}" class="project-input" placeholder="Projekt..." oninput="saveData();"></td>
                <td><textarea id="note-${i}" placeholder="Pozn..." oninput="saveData();"></textarea></td>
                <td><input type="text" id="gross-${i}" readonly></td>
                <td><input type="text" id="net-${i}" readonly></td>
                <td><button class="btn reset-btn" style="padding:5px;" onclick="clearRow(${i})">X</button></td>
            `;
            frag.appendChild(tr);
        }
        ui.tbody.appendChild(frag);
        updateTotals();
    }

    window.setCurrentTime = (id, day) => {
        const now = new Date();
        const time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
        document.getElementById(id).value = time;
        calcRow(day);
        saveData();
    };

    window.calcRow = (i) => {
        const start = document.getElementById(`start-${i}`).value;
        const end = document.getElementById(`end-${i}`).value;
        const breakVal = parseFloat(document.getElementById(`break-${i}`).value) || 0;
        
        let hours = 0;
        if(isValidTime(start) && isValidTime(end)) {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let sDate = new Date(0,0,0,sh,sm);
            let eDate = new Date(0,0,0,eh,em);
            if(eDate < sDate) eDate.setDate(1); // cez polnoc
            
            let diffMins = (eDate - sDate) / 60000;
            diffMins -= (breakVal * 60);
            if(diffMins < 0) diffMins = 0;
            hours = diffMins / 60;
        }

        const hPart = Math.floor(hours);
        const mPart = Math.round((hours - hPart) * 60);
        document.getElementById(`total-${i}`).textContent = `${hPart}h ${mPart}m (${hours.toFixed(settings.decimals)})`;

        const gross = hours * settings.wage;
        const net = gross * (1 - (settings.tax / 100));

        document.getElementById(`gross-${i}`).value = gross.toFixed(settings.decimals);
        document.getElementById(`net-${i}`).value = net.toFixed(settings.decimals);
        
        updateTotals();
    };

    function updateTotals() {
        let totalNet = 0, totalGross = 0, totalHours = 0, days = 0;
        const count = new Date(currentYear, currentMonth + 1, 0).getDate();

        for(let i=1; i<=count; i++) {
            const net = parseFloat(document.getElementById(`net-${i}`).value) || 0;
            const gross = parseFloat(document.getElementById(`gross-${i}`).value) || 0;
            const timeText = document.getElementById(`total-${i}`).textContent;
            
            // Extrahovanie desatinn√Ωch hod√≠n zo z√°tvorky (X.XX)
            const match = timeText.match(/\(([\d.]+)\)/);
            const hours = match ? parseFloat(match[1]) : 0;

            if(hours > 0 || net > 0) {
                totalNet += net;
                totalGross += gross;
                totalHours += hours;
                days++;
            }
        }

        let html = `<strong>Zaroben√©:</strong> ${totalNet.toFixed(settings.decimals)} ‚Ç¨ (Hrub√°: ${totalGross.toFixed(settings.decimals)} ‚Ç¨)<br>`;
        html += `<strong>Odpracovan√©:</strong> ${Math.floor(totalHours)}h ${Math.round((totalHours%1)*60)}m (${days} dn√≠)`;

        // NOV√â: Mesaƒçn√Ω cieƒæ
        if (settings.goal > 0) {
            const percent = (totalNet / settings.goal) * 100;
            let pClass = percent >= 100 ? 'good' : (percent >= 50 ? 'medium' : 'low');
            html += `<div class="goal-progress ${pClass}">Cieƒæ (${settings.goal}‚Ç¨): Splnen√© na ${percent.toFixed(1)}%</div>`;
        }

        ui.totalDiv.innerHTML = html;
    }

    function isValidTime(t) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(t); }

    // --- 6. UKLADANIE A NAƒå√çTANIE ---
    window.saveData = debounce(async () => {
        const data = collectData();
        const docId = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
        const localKey = `workData-${currentUser ? currentUser.uid : 'guest'}-${docId}`;
        
        localStorage.setItem(localKey, JSON.stringify(data));
        document.getElementById('saveNotification').style.display = 'block';
        setTimeout(() => document.getElementById('saveNotification').style.display = 'none', 2000);

        if(currentUser && navigator.onLine) {
            try {
                await setDoc(doc(db, 'users', currentUser.uid, 'workData', docId), { data, updated: new Date().toISOString() }, {merge:true});
            } catch(e) { console.error("Save to cloud failed", e); }
        }
    }, 1000);

    function collectData() {
        let arr = [];
        const count = new Date(currentYear, currentMonth + 1, 0).getDate();
        for(let i=1; i<=count; i++) {
            arr.push({
                s: document.getElementById(`start-${i}`).value,
                e: document.getElementById(`end-${i}`).value,
                b: document.getElementById(`break-${i}`).value,
                p: document.getElementById(`project-${i}`).value, // Uklad√°me projekt
                n: document.getElementById(`note-${i}`).value
            });
        }
        return arr;
    }

    function applyData(data) {
        if(!data) return;
        data.forEach((d, index) => {
            const i = index + 1;
            if(document.getElementById(`start-${i}`)) {
                document.getElementById(`start-${i}`).value = d.s || '';
                document.getElementById(`end-${i}`).value = d.e || '';
                document.getElementById(`break-${i}`).value = d.b || '';
                document.getElementById(`project-${i}`).value = d.p || ''; // Naƒç√≠tame projekt
                document.getElementById(`note-${i}`).value = d.n || '';
                calcRow(i);
            }
        });
    }

    async function syncData() {
        if(unsubscribeListener) unsubscribeListener();
        const docId = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
        
        // Load User Settings
        try {
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            if(userDoc.exists() && userDoc.data().settings) {
                Object.assign(settings, userDoc.data().settings);
                refreshSettingsUI();
            }
        } catch(e) {}

        // Listen for Month Data
        unsubscribeListener = onSnapshot(doc(db, 'users', currentUser.uid, 'workData', docId), (snap) => {
            if(snap.exists()) {
                applyData(snap.data().data);
            } else {
                // If nothing in cloud, try local
                loadDataLocally();
            }
        });
    }

    function loadDataLocally() {
        const docId = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
        const localKey = `workData-${currentUser ? currentUser.uid : 'guest'}-${docId}`;
        const raw = localStorage.getItem(localKey);
        if(raw) applyData(JSON.parse(raw));
        else {
            // clear inputs
            const count = new Date(currentYear, currentMonth + 1, 0).getDate();
            for(let i=1; i<=count; i++) clearRow(i, false);
        }
    }

    window.updateSettings = function() {
        settings.name = document.getElementById('employeeNameInput').value;
        settings.wage = parseFloat(document.getElementById('hourlyWageInput').value) || 0;
        settings.tax = parseFloat(document.getElementById('taxRateInput').value) || 0;
        settings.decimals = parseInt(document.getElementById('decimalPlacesSelect').value);
        settings.goal = parseFloat(document.getElementById('monthlyGoalInput').value) || null;
        
        localStorage.setItem('settings', JSON.stringify(settings));
        
        // Prepoƒç√≠ta≈• v≈°etko
        const count = new Date(currentYear, currentMonth + 1, 0).getDate();
        for(let i=1; i<=count; i++) calcRow(i);

        if(currentUser) {
             setDoc(doc(db, 'users', currentUser.uid), { settings }, {merge: true});
        }
    };

    function loadSettingsLocally() {
        const s = localStorage.getItem('settings');
        if(s) Object.assign(settings, JSON.parse(s));
        refreshSettingsUI();
    }

    function refreshSettingsUI() {
        document.getElementById('employeeNameInput').value = settings.name;
        document.getElementById('hourlyWageInput').value = settings.wage;
        document.getElementById('taxRateInput').value = settings.tax;
        document.getElementById('decimalPlacesSelect').value = settings.decimals;
        document.getElementById('monthlyGoalInput').value = settings.goal || '';
        if(settings.theme) setTheme(settings.theme);
        renderTable(); // Re-render if month changed in settings logic previously
    }

    // --- 7. EXPORTY ---
    window.exportToPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text(`V√Ωkaz: ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 20);
        doc.setFontSize(10);
        doc.text(`Meno: ${settings.name} | Mzda: ${settings.wage}‚Ç¨/h | Cieƒæ: ${settings.goal ? settings.goal + '‚Ç¨' : '-'}`, 14, 28);

        const tableData = [];
        const count = new Date(currentYear, currentMonth + 1, 0).getDate();
        for(let i=1; i<=count; i++) {
            const start = document.getElementById(`start-${i}`).value;
            const end = document.getElementById(`end-${i}`).value;
            const project = document.getElementById(`project-${i}`).value;
            const note = document.getElementById(`note-${i}`).value;
            const total = document.getElementById(`total-${i}`).textContent;
            
            if(start || end || project || note) {
                tableData.push([
                    `${i}.`, start, end, total, project, note, 
                    document.getElementById(`net-${i}`).value + '‚Ç¨'
                ]);
            }
        }

        doc.autoTable({
            head: [['De≈à', 'Od', 'Do', 'ƒåas', 'Projekt', 'Pozn.', 'Netto']],
            body: tableData,
            startY: 35,
            styles: { fontSize: 8 },
            columnStyles: { 4: { cellWidth: 30 }, 5: { cellWidth: 40 } } // ≈†ir≈°√≠ projekt a pozn√°mka
        });

        // Pridanie s√∫ƒçtu na koniec PDF
        const finalY = doc.lastAutoTable.finalY + 10;
        const summary = ui.totalDiv.innerText.replace(/\n/g, ', ');
        doc.text(summary, 14, finalY);

        doc.save(`Vykaz_${settings.name}_${currentMonth+1}_${currentYear}.pdf`);
    };

    window.createBackup = () => {
        const data = collectData();
        const wb = XLSX.utils.book_new();
        // Pr√≠prava d√°t pre Excel vr√°tane stƒ∫pca Projekt
        const wsData = [
            ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka", "Projekt", "Pozn√°mka"]
        ];
        data.forEach((d, i) => {
            wsData.push([i+1, d.s, d.e, d.b, d.p, d.n]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Dochadzka");
        XLSX.writeFile(wb, "Zaloha.xlsx");
    };

    window.restoreBackup = () => {
        const input = document.createElement('input'); input.type = 'file';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = evt => {
                const wb = XLSX.read(evt.target.result, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws, {header:1});
                // Preskoƒçi≈• hlaviƒçku
                const mappedData = [];
                for(let i=1; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    if(row[0]) { // Ak existuje de≈à
                        mappedData[row[0]-1] = {
                            s: row[1] || '', e: row[2] || '', b: row[3] || '',
                            p: row[4] || '', n: row[5] || ''
                        };
                    }
                }
                applyData(mappedData);
                saveData();
                alert('Z√°loha obnoven√°!');
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        };
        input.click();
    };

    // --- 8. AUTH FUNKCIE ---
    window.loginUser = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try { await signInWithEmailAndPassword(auth, email, pass); }
        catch(e) { showError(e.message); }
    };
    
    window.registerUser = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try { await createUserWithEmailAndPassword(auth, email, pass); }
        catch(e) { showError(e.message); }
    };

    window.logoutUser = () => signOut(auth);

    function updateAuthUI() {
        if(currentUser) {
            ui.loginFieldset.style.display = 'none';
            ui.userInfo.style.display = 'flex';
            document.getElementById('user-email').textContent = currentUser.email;
        } else {
            ui.loginFieldset.style.display = 'block';
            ui.userInfo.style.display = 'none';
        }
    }

    // --- HELPERY ---
    window.changeDate = () => {
        currentMonth = parseInt(document.getElementById('monthSelect').value);
        currentYear = parseInt(document.getElementById('yearSelect').value);
        renderTable();
        if(currentUser) syncData(); else loadDataLocally();
    };
    
    window.clearRow = (i, save=true) => {
        ['start','end','break','project','note'].forEach(k => document.getElementById(`${k}-${i}`).value = '');
        calcRow(i);
        if(save) saveData();
    };

    window.clearMonthData = () => {
        if(confirm("Naozaj vymaza≈• cel√Ω mesiac?")) {
            const count = new Date(currentYear, currentMonth + 1, 0).getDate();
            for(let i=1; i<=count; i++) window.clearRow(i, false);
            saveData();
        }
    };

    function showError(msg) {
        const el = document.getElementById('errorNotification');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(()=>el.style.display='none', 4000);
    }
    
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Spustenie
    init();

  </script>
</body>
</html>
