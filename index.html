<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icons/icon-192x192.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    /* Všetky CSS štýly zostávajú rovnaké */
    body{font-family:Arial,sans-serif;line-height:1.6;margin:0;padding:10px;background-color:#f4f4f4;color:#333}.container{max-width:1200px;margin:auto;background:white;padding:15px;border-radius:5px;box-shadow:0 0 10px rgba(0,0,0,.1);position:relative}h1{text-align:center;font-size:2.5em;color:#000;margin-bottom:10px}h2{text-align:center;color:#555;margin-top:-10px;font-size:1.2em}.settings{margin-bottom:20px;display:flex;flex-wrap:wrap;align-items:flex-start}.settings>div,.settings>button#toggleSettingsBtn,.settings>button.highlight{margin:2px 5px}.settings>div{flex:1 1 200px}.settings>button#toggleSettingsBtn{flex-basis:100%;margin-bottom:10px;background-color:#eee;color:#333;border:1px solid #ccc;text-align:left;padding:8px 12px}body.dark-mode .settings>button#toggleSettingsBtn{background-color:#555;color:#f4f4f4;border-color:#666}.settings>button.highlight{flex:1 1 150px}.settings>button#enableNotificationsBtn{flex-basis:100%;margin-top:10px;background-color:#ff9800}.settings>button#enableNotificationsBtn:disabled{background-color:#bdbdbd;cursor:default}body.dark-mode .settings>button#enableNotificationsBtn{background-color:#e65100}body.dark-mode .settings>button#enableNotificationsBtn:disabled{background-color:#616161}.settings label{display:block;margin-bottom:2px}#settings-collapsible-content{display:flex;flex-wrap:wrap;width:100%;max-height:0;opacity:0;overflow:hidden;transition:max-height .4s ease-out,opacity .3s ease-out}#settings-collapsible-content.visible{max-height:400px;opacity:1;margin-top:5px}#settings-collapsible-content>div{flex:1 1 200px;margin:2px 5px}.table-container{overflow-x:auto}table{width:100%;border-collapse:collapse;margin-bottom:20px;min-width:800px}th,td{padding:8px;border:1px solid #ddd;text-align:left;font-size:.9em}th{background-color:#f2f2f2}th:nth-child(6),td:nth-child(6),th:nth-child(7),td:nth-child(7){width:25%}th:nth-child(1),td:nth-child(1),th:nth-child(2),td:nth-child(2),th:nth-child(3),td:nth-child(3),th:nth-child(4),td:nth-child(4),th:nth-child(5),td:nth-child(5),th:nth-child(8),td:nth-child(8){width:8.33%}input[type=tel],input[type=number],input[type=text],select{width:100%;padding:5px;box-sizing:border-box;background-color:#ffffd0;font-size:14px;border:1px solid #ccc;border-radius:3px;vertical-align:middle}.result{font-weight:700;margin-top:20px;text-align:center}.btn-container{display:flex;flex-wrap:wrap;justify-content:space-between;margin-top:20px}.btn{flex:1 1 150px;padding:10px 20px;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px;margin:5px;transition:background-color .3s ease}.reset-btn{background-color:#f44336}.reset-btn:hover{background-color:#d32f2f}.export-btn{background-color:#4caf50}.export-btn:hover{background-color:#388e3c}.backup-btn{background-color:#8a2be2;padding:15px 20px}.backup-btn:hover{background-color:#6a1bb2}.highlight{background-color:#ffcc00;color:#333;font-weight:700;border:2px solid #ffcc00}#totalSalary{font-size:18px;font-weight:700;text-align:center;margin-top:20px;padding:10px;background-color:#e6f3ff;border-radius:5px}#dataSizeContainer{margin-top:10px;text-align:center}#dataSizeText{margin-bottom:5px;font-size:14px;color:#555}#dataSizeBar{width:80%;height:20px;background-color:#ddd;border-radius:10px;margin:0 auto;overflow:hidden}#dataSizeFill{height:100%;width:0%;background-color:#4caf50;transition:width .3s ease}.current-day{background-color:#8a2be2;color:#fff}.current-day input{background-color:#9932cc;color:#fff}body.dark-mode{background-color:#333;color:#f4f4f4}body.dark-mode .container{background-color:#444;color:#f4f4f4}body.dark-mode h1{color:#f4f4f4}body.dark-mode table{background-color:#555;color:#f4f4f4}body.dark-mode th{background-color:#666}body.dark-mode td{background-color:#444;color:#f4f4f4}body.dark-mode input[type=tel],body.dark-mode input[type=number],body.dark-mode input[type=text],body.dark-mode select{background-color:#666;color:#fff;border-color:#555}body.dark-mode .btn{color:#f4f4f4}body.dark-mode .reset-btn{background-color:#d32f2f}body.dark-mode .export-btn{background-color:#388e3c}body.dark-mode .backup-btn{background-color:#6a1bb2}body.dark-mode #totalSalary{background-color:#2c3e50}body.dark-mode .current-day{background-color:#4a0e8f;color:#fff}body.dark-mode .current-day input{background-color:#5c1db3;color:#fff}@media (max-width:768px){body{padding:5px}.container{padding:10px}h1{font-size:1.8em}h2{font-size:1em}.settings{flex-direction:column;align-items:stretch}.settings>div{flex-basis:auto;width:100%;margin:5px 0}.settings>button#toggleSettingsBtn{flex-basis:auto;width:100%;margin-bottom:10px}.settings>button.highlight{flex-basis:auto;width:100%;margin:5px 0}.settings>button#enableNotificationsBtn{flex-basis:auto;width:100%;margin:10px 0 5px}#settings-collapsible-content{flex-direction:column;align-items:stretch}#settings-collapsible-content>div{flex-basis:auto;width:100%;margin:5px 0}#settings-collapsible-content.visible{max-height:600px}table{min-width:800px}th,td{padding:6px;font-size:.8em}.btn-container{flex-direction:column;align-items:stretch}.btn{flex:1 1 auto;font-size:14px;padding:8px 16px;margin:5px 0}.backup-btn{padding:15px 16px}#totalSalary{font-size:16px}#dataSizeContainer{font-size:12px}.table-container{overflow-x:auto}}@media (max-width:480px){h1{font-size:1.5em}th,td{font-size:.7em}.btn{font-size:12px;padding:6px 12px}.backup-btn{padding:15px 12px}.settings label{font-size:.9em}input[type=tel],input[type=number],input[type=text],select{font-size:12px}table{min-width:800px}.settings>button#toggleSettingsBtn,.settings>button.highlight{margin:5px 0}#settings-collapsible-content>div{margin:5px 0}#settings-collapsible-content.visible{max-height:700px}.settings>button#enableNotificationsBtn{margin:10px 0 5px}}#saveNotification,#errorNotification{display:none;position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:5px;font-size:14px;box-shadow:0 0 10px rgba(0,0,0,.2);z-index:1000;opacity:0;transition:opacity .5s ease-in-out}#saveNotification.show,#errorNotification.show{display:block;opacity:1}#saveNotification{background-color:#4caf50;color:#fff}#errorNotification{background-color:#f44336;color:#fff}#login-form{display:flex;flex-direction:column;align-items:center}#login-form input[type=email],#login-form input[type=password]{width:200px;margin:5px auto;display:block}#login-form .btn{width:120px;margin:5px 2px}#login-form a{margin-top:10px;display:block;font-size:.9em;color:#007bff;text-decoration:none}#login-form a:hover{text-decoration:underline}body.dark-mode #login-form a{color:#6bbaff}
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button>
      <div id="settings-collapsible-content">
          <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
          <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
          <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
          <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
          <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
          <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
      </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
       <button id="enableNotificationsBtn" class="btn highlight">Povoliť Notifikácie</button>
       {/* -------------------------------------- */}
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
    window.toggleDarkMode = function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, arrayUnion, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";
    const firebaseConfig = { apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", authDomain: "uuuuu-f7ef9.firebaseapp.com", projectId: "uuuuu-f7ef9", storageBucket: "uuuuu-f7ef9.firebasestorage.app", messagingSenderId: "456105865458", appId: "1:456105865458:web:101f0a4dcb455f174b606b", };
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), isTokenAutoRefreshEnabled: true });
    const auth = getAuth(app); const db = getFirestore(app); let messaging = null;
    try { if (typeof getMessaging === 'function') { messaging = getMessaging(app); console.log("Firebase Messaging initialized."); } else { console.warn("Firebase Messaging is not available/imported correctly."); } } catch (error) { console.error("Error initializing Firebase Messaging:", error); }
    let swRegistration = null; let currentUser = null; const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const mainTitle = document.getElementById('mainTitle'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const toggleSettingsBtn = document.getElementById('toggleSettingsBtn'); const settingsCollapsibleContent = document.getElementById('settings-collapsible-content'); const enableNotificationsBtn = document.getElementById('enableNotificationsBtn'); const currentDate = new Date(); let currentMonth = currentDate.getMonth(); let currentYear = currentDate.getFullYear(); let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1; let employeeName = localStorage.getItem('employeeName') || ''; let hourlyWage = parseFloat(hourlyWageInput.value) || 10; let taxRate = (parseFloat(taxRateInput.value) || 2) / 100; let monthData = {};
    function updateGreeting() { if (employeeName) { mainTitle.textContent = `Ahoj ${employeeName.split(' ')[0]}`; } else { mainTitle.textContent = 'Ahoj'; } }
    function populateYearSelect() { const startYear = 2020; const endYear = 2030; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } yearSelect.value = currentYear; }
    populateYearSelect(); monthSelect.value = currentMonth; yearSelect.value = currentYear; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName; hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1); updateGreeting();
    if (toggleSettingsBtn && settingsCollapsibleContent) { toggleSettingsBtn.addEventListener('click', () => { const isVisible = settingsCollapsibleContent.classList.toggle('visible'); toggleSettingsBtn.textContent = isVisible ? 'Skryť nastavenia ▲' : 'Zobraziť nastavenia ▼'; }); }
    function isOnline() { return navigator.onLine; }
    window.addEventListener('online', () => { console.log('Zariadenie je online'); showStatusNotification('Online', 'green'); syncWithFirebase(); });
    window.addEventListener('offline', () => { console.log('Zariadenie je offline'); showStatusNotification('Offline', 'red'); });
    function showStatusNotification(message, color) { const notification = document.createElement('div'); notification.textContent = message; Object.assign(notification.style, { position: 'fixed', top: '20px', right: '20px', padding: '10px 20px', borderRadius: '5px', backgroundColor: color, color: 'white', zIndex: '1000', boxShadow: '0 2px 5px rgba(0,0,0,0.2)' }); document.body.appendChild(notification); setTimeout(() => { notification.remove(); }, 3000); }
    function showErrorNotification(message) { const notification = document.getElementById('errorNotification'); notification.textContent = message; notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); }, 4000); }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); }, 3000); }
    window.login = async function() { if (!isOnline()) { showErrorNotification('Ste offline. Prihlásenie je možné iba online.'); return; } const email = document.getElementById('email').value; const password = document.getElementById('password').value; if (!email || !password) { showErrorNotification('Prosím, zadajte email aj heslo.'); return; } try { const userCredential = await signInWithEmailAndPassword(auth, email, password); console.log('Prihlásenie úspešné pre:', userCredential.user.email); } catch (error) { console.error('Chyba pri prihlásení:', error); showErrorNotification('Chyba pri prihlásení: ' + mapFirebaseAuthError(error.code)); } }
    window.register = async function() { if (!isOnline()) { showErrorNotification('Ste offline. Registrácia je možná iba online.'); return; } const email = document.getElementById('email').value; const password = document.getElementById('password').value; if (!email || !password) { showErrorNotification('Prosím, zadajte email aj heslo.'); return; } if (password.length < 6) { showErrorNotification('Heslo musí mať aspoň 6 znakov.'); return; } try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); await createUserCollection(); console.log('Registrácia úspešná pre:', userCredential.user.email); } catch (error) { console.error('Chyba pri registrácii:', error); showErrorNotification('Chyba pri registrácii: ' + mapFirebaseAuthError(error.code)); } }
    window.logout = async function() { try { await signOut(auth); console.log('Odhlásenie úspešné.'); monthData = {}; if(enableNotificationsBtn) { enableNotificationsBtn.disabled = false; enableNotificationsBtn.textContent = 'Povoliť Notifikácie'; } } catch (error) { console.error('Chyba pri odhlásení:', error); showErrorNotification('Chyba pri odhlásení: ' + error.message); } }
    window.resetPassword = async function() { if (!isOnline()) { showErrorNotification('Ste offline. Obnova hesla je možná iba online.'); return; } const emailInput = document.getElementById('email'); const email = emailInput.value; if (!email) { emailInput.style.border = '1px solid red'; showErrorNotification('Prosím, zadajte váš email do poľa "Email" pre obnovu hesla.'); setTimeout(() => { emailInput.style.border = '1px solid #ccc'; }, 3000); return; } emailInput.style.border = '1px solid #ccc'; try { await sendPasswordResetEmail(auth, email); console.log('Email na obnovu hesla odoslaný na:', email); showSaveNotification(`Email na obnovu hesla bol odoslaný na ${email}. Skontrolujte si poštu (aj priečinok spam).`); } catch (error) { console.error('Chyba pri odosielaní emailu na obnovu hesla:', error); showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code)); } }
    function mapFirebaseAuthError(errorCode) { switch (errorCode) { case 'auth/invalid-email': return 'Neplatný formát emailu.'; case 'auth/user-not-found': return 'Používateľ s týmto emailom nebol nájdený.'; case 'auth/wrong-password': return 'Nesprávne heslo.'; case 'auth/email-already-in-use': return 'Tento email je už zaregistrovaný.'; case 'auth/weak-password': return 'Heslo je príliš slabé (min. 6 znakov).'; case 'auth/requires-recent-login': return 'Táto operácia vyžaduje nedávne prihlásenie.'; case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.'; case 'auth/missing-email': return 'Prosím, zadajte emailovú adresu.'; default: return errorCode; } }
    async function createUserCollection() { if (auth.currentUser) { const userRef = doc(db, 'users', auth.currentUser.uid); try { await setDoc(userRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true }); const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup'); await setDoc(initialDocRef, { setupComplete: true }); console.log('User collection and initial workDays doc created for:', auth.currentUser.email); } catch (error) { console.error('Error creating user collection:', error); } } }
    async function loadInitialData() { const localKey = `workData-${currentYear}-${currentMonth}`; const localData = localStorage.getItem(localKey); const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`; const pendingSyncData = localStorage.getItem(pendingSyncKey); if (pendingSyncData && isOnline() && currentUser) { console.log('Máme čakajúce dáta a sme online, pokúšam sa synchronizovať PRED načítaním.'); await syncWithFirebase(); const updatedLocalData = localStorage.getItem(localKey); if (updatedLocalData) { console.log('Načítavam dáta z localStorage po synchronizácii.'); parseAndApplyData(updatedLocalData); } else { await loadFromFirestoreAndApply(); } } else if (localData) { console.log('Načítavam počiatočné údaje z localStorage (priorita).'); parseAndApplyData(localData); } else if (isOnline() && currentUser) { await loadFromFirestoreAndApply(); } else { console.log('Offline a žiadne dáta v localStorage.'); calculateTotal(); } }
    async function loadFromFirestoreAndApply() { console.log('Pokúšam sa načítať počiatočné údaje z Firestore'); if (!currentUser) return; try { const userRef = doc(db, 'users', currentUser.uid); const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const storedData = docSnap.data(); console.log('Dáta nájdené vo Firestore, ukladám do localStorage a aplikujem:', storedData); const dataString = JSON.stringify(storedData); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); parseAndApplyData(dataString); } else { console.log('Žiadne údaje v Firestore pre tento mesiac.'); calculateTotal(); } } catch (error) { console.error('Chyba pri počiatočnom načítavaní z Firestore:', error); showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message); calculateTotal(); } }
    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);
    function collectCurrentData() { const saveData = { data: [], hourlyWage: hourlyWage, taxRate: taxRate, employeeName: employeeName, decimalPlaces: decimalPlaces, lastUpdated: new Date().toISOString() }; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`); const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`); const start = startElement ? startElement.value : ''; const end = endElement ? endElement.value : ''; const breakTime = breakElement ? breakElement.value : ''; const gross = grossElement ? grossElement.value : '0'; const net = netElement ? netElement.value : '0'; saveData.data.push({ start, end, breakTime, gross, net }); } return saveData; }
    async function saveToFirestore() { if (!currentUser || !isOnline()) return; const saveData = collectCurrentData(); const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`; if (isOnline()) { try { console.log('Pokúšam sa uložiť/synchronizovať s Firestore...'); const userRef = doc(db, 'users', currentUser.uid); await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), saveData, { merge: true }); localStorage.removeItem(pendingSyncKey); console.log('Dáta úspešne uložené do Firestore.'); } catch (error) { console.error('Chyba pri ukladaní do Firestore:', error); showErrorNotification('Chyba pri ukladaní dát do cloudu: ' + error.message); localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); } } else { console.log('Offline: Označujem dáta pre neskoršiu synchronizáciu'); localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); showSaveNotification('Ste offline, dáta uložené lokálne.'); } }
    async function syncWithFirebase() { if (!currentUser || !isOnline()) return; console.log('Kontrolujem čakajúce dáta na synchronizáciu...'); const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`; const pendingDataString = localStorage.getItem(pendingSyncKey); if (pendingDataString) { console.log('Našli sa čakajúce dáta, pokúšam sa synchronizovať...'); try { const dataToSync = JSON.parse(pendingDataString); const userRef = doc(db, 'users', currentUser.uid); await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), dataToSync, { merge: true }); console.log('Čakajúce dáta boli úspešne synchronizované s Firestore.'); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, pendingDataString); localStorage.removeItem(pendingSyncKey); showSaveNotification('Offline dáta boli synchronizované s Firebase.'); parseAndApplyData(pendingDataString); } catch (error) { console.error('Chyba pri synchronizácii čakajúcich dát s Firestore:', error); showErrorNotification('Chyba pri synchronizácii offline dát: ' + error.message); } } else { console.log('Žiadne čakajúce dáta na synchronizáciu pre tento mesiac.'); } }
    window.loadFromFirestore = async function() { if (!currentUser) { showErrorNotification('Pre načítanie z Firebase sa musíte prihlásiť.'); return; } if (!isOnline()) { showErrorNotification('Ste offline. Pre načítanie z Firebase je potrebné pripojenie na internet.'); return; } if (!confirm('Naozaj chcete načítať dáta z Firebase? Prepíšu sa tým všetky neuložené lokálne zmeny pre tento mesiac.')) { console.log('Načítanie z Firebase zrušené používateľom.'); return; } try { const userRef = doc(db, 'users', currentUser.uid); const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`); const docSnap = await getDoc(docRef); if (docSnap.exists()) { const storedData = docSnap.data(); const dataString = JSON.stringify(storedData); console.log('Prepisujem lokálne dáta dátami z Firestore a ukladám do localStorage:', storedData); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); parseAndApplyData(dataString); showSaveNotification('Dáta boli úspešne načítané z Firebase.'); } else { console.log('Žiadne údaje v Firestore pre tento mesiac.'); showErrorNotification('Pre tento mesiac neboli vo Firebase nájdené žiadne dáta.'); } } catch (error) { console.error('Chyba pri manuálnom načítavaní z Firestore:', error); showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message); } }
    function loadFromLocalStorageOnly() { const localKey = `workData-${currentYear}-${currentMonth}`; const localData = localStorage.getItem(localKey); if (localData) { console.log('Načítavam údaje iba z localStorage (offline alebo neprihlásený)'); parseAndApplyData(localData); } else { console.log('Žiadne údaje v localStorage na načítanie pre tento mesiac.'); calculateTotal(); } }
    function parseAndApplyData(dataString) { try { const storedData = JSON.parse(dataString); hourlyWage = storedData.hourlyWage !== undefined ? storedData.hourlyWage : (parseFloat(hourlyWageInput.value) || 10); taxRate = storedData.taxRate !== undefined ? storedData.taxRate : ((parseFloat(taxRateInput.value) || 2) / 100); employeeName = storedData.employeeName !== undefined ? storedData.employeeName : (employeeNameInput.value || ''); decimalPlaces = storedData.decimalPlaces !== undefined ? storedData.decimalPlaces : (parseInt(decimalPlacesSelect.value) || 1); hourlyWageInput.value = hourlyWage; taxRateInput.value = (taxRate * 100).toFixed(1); employeeNameInput.value = employeeName; decimalPlacesSelect.value = decimalPlaces; updateGreeting(); localStorage.setItem('decimalPlaces', decimalPlaces); localStorage.setItem('employeeName', employeeName); if (storedData.data && Array.isArray(storedData.data)) { const daysInMonth = getDaysInMonth(currentMonth); const daysToProcess = Math.min(daysInMonth, storedData.data.length); for (let index = 0; index < daysToProcess; index++) { const day = storedData.data[index]; const i = index + 1; const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); if (startElement && endElement && breakElement) { startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || ''; calculateRow(i); } } for (let i = daysToProcess + 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { resetRow(i, false); } } } else { console.warn('Načítané dáta neobsahujú pole `data`.'); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { resetRow(i, false); } } } calculateTotal(); } catch (error) { console.error('Chyba pri parsovaní alebo aplikovaní dát:', error); showErrorNotification('Chyba pri spracovaní uložených dát: ' + error.message); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) resetRow(i, false); } calculateTotal(); } }
    function getDayName(year, month, day) { const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; const date = new Date(year, month, day); return daysOfWeek[date.getDay()]; }
    window.handleInput = function(input, nextId) { formatAndMoveNext(input, nextId); calculateAndUpdateTotals(); }
    window.handleBreakInput = function(day) { const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if (breakInput) { let breakValue = parseFloat(breakInput.value); if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; } } calculateRow(day); calculateAndUpdateTotals(); }
    function calculateAndUpdateTotals() { calculateTotal(); const saveData = collectCurrentData(); const localKey = `workData-${currentYear}-${currentMonth}`; localStorage.setItem(localKey, JSON.stringify(saveData)); debouncedSaveToFirestore(); }
    function isValidTimeFormat(timeString) { if (!timeString) return false; const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeString); }
    function formatAndMoveNext(input, nextId) { let value = input.value.replace(/[^\d:]/g, ''); let originalValue = input.value; let cursorPosition = input.selectionStart; if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = value + ':'; } else if (value.length === 4 && !value.includes(':')) { value = value.substring(0, 2) + ':' + value.substring(2); } else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = value.substring(0, 2) + ':' + value.substring(2); } value = value.replace(/^:/, ''); if ((value.match(/:/g) || []).length > 1) { const parts = value.split(':'); value = parts[0] + ':' + parts.slice(1).join(''); } if (value.length > 5) { value = value.slice(0, 5); } if (input.value !== value) { input.value = value; try { if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); } else { input.setSelectionRange(cursorPosition, cursorPosition); } } catch (e) { /* Ignorujeme */ } } const day = parseInt(input.id.split('-')[3]); if (value.length === 5) { if (isValidTimeFormat(value)) { calculateRow(day); moveNext(input, nextId); } else { calculateRow(day); } } else { calculateRow(day); } }
    function moveNext(currentElement, nextId) { const nextElement = document.getElementById(nextId); if (nextElement) { nextElement.focus(); if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') { nextElement.select(); } } }
    function calculateRow(day) { const startTimeInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endTimeInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) { return; } const startTime = startTimeInput.value; const endTime = endTimeInput.value; const breakTime = parseFloat(breakTimeInput.value) || 0; if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`; grossInput.value = (0).toFixed(decimalPlaces); netInput.value = (0).toFixed(decimalPlaces); return; } const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number); const startDate = new Date(2000, 0, 1, startHours, startMinutes); const endDate = new Date(2000, 0, 1, endHours, endMinutes); let diffMillis = endDate.getTime() - startDate.getTime(); if (diffMillis < 0) { diffMillis += 24 * 60 * 60 * 1000; } let diffMinutes = diffMillis / (60 * 1000); const breakMinutes = breakTime * 60; diffMinutes -= breakMinutes; if (diffMinutes < 0) diffMinutes = 0; const decimalHours = diffMinutes / 60; const totalMinutesRounded = Math.round(diffMinutes); const hours = Math.floor(totalMinutesRounded / 60); const minutes = totalMinutesRounded % 60; totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`; const grossSalary = decimalHours * hourlyWage; grossInput.value = Math.max(0, grossSalary).toFixed(decimalPlaces); updateNetSalary(day); }
    function updateNetSalary(day) { const grossSalaryInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netSalaryInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!grossSalaryInput || !netSalaryInput) return; const grossSalary = parseFloat(grossSalaryInput.value) || 0; const netSalary = grossSalary * (1 - taxRate); netSalaryInput.value = Math.max(0, netSalary).toFixed(decimalPlaces); }
    window.resetRow = function(day, saveChanges = true) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if(startInput) startInput.value = ''; if(endInput) endInput.value = ''; if(breakInput) breakInput.value = ''; calculateRow(day); if (saveChanges) { calculateAndUpdateTotals(); } }
    function calculateTotal() { let totalMinutesPrecise = 0; let totalGrossSalaryPrecise = 0; let totalNetSalaryPrecise = 0; let daysWithEntries = 0; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); if (!startInput || !endInput || !breakInput) continue; const startTime = startInput.value; const endTime = endInput.value; const breakTime = parseFloat(breakInput.value) || 0; let dayMinutes = 0; let dayGrossSalary = 0; let dayNetSalary = 0; let hasEntry = false; if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) { const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number); const startDate = new Date(2000, 0, 1, startHours, startMinutes); const endDate = new Date(2000, 0, 1, endHours, endMinutes); let diffMillis = endDate.getTime() - startDate.getTime(); if (diffMillis < 0) diffMillis += 24 * 60 * 60 * 1000; let diffMinutes = diffMillis / (60 * 1000); const breakMinutes = breakTime * 60; diffMinutes -= breakMinutes; if (diffMinutes < 0) diffMinutes = 0; dayMinutes = diffMinutes; const dayDecimalHours = diffMinutes / 60; dayGrossSalary = Math.max(0, dayDecimalHours * hourlyWage); dayNetSalary = Math.max(0, dayGrossSalary * (1 - taxRate)); if (dayMinutes > 0) { hasEntry = true; } } if (startTime || endTime || (breakTime && breakTime > 0)) { hasEntry = true; } totalMinutesPrecise += dayMinutes; totalGrossSalaryPrecise += dayGrossSalary; totalNetSalaryPrecise += dayNetSalary; if (hasEntry) { daysWithEntries++; } } const totalMinutesRounded = Math.round(totalMinutesPrecise); const totalHours = Math.floor(totalMinutesRounded / 60); const totalMinutesRemainder = totalMinutesRounded % 60; const totalDecimalHoursPrecise = totalMinutesPrecise / 60; const averageNetSalaryPrecise = daysWithEntries > 0 ? totalNetSalaryPrecise / daysWithEntries : 0; const averageWorkedMinutesPrecise = daysWithEntries > 0 ? totalMinutesPrecise / daysWithEntries : 0; const averageMinutesRounded = Math.round(averageWorkedMinutesPrecise); const averageHours = Math.floor(averageMinutesRounded / 60); const averageMinutes = averageMinutesRounded % 60; const averageDecimalHoursPrecise = averageWorkedMinutesPrecise / 60; totalSalaryDiv.innerHTML = ` Započítaných dní: ${daysWithEntries}<br> Celkový čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHoursPrecise.toFixed(decimalPlaces)} h)<br> Hrubá mzda: ${totalGrossSalaryPrecise.toFixed(decimalPlaces)} €<br> Čistá mzda: ${totalNetSalaryPrecise.toFixed(decimalPlaces)} €<br> Priem. čistá mzda/deň: ${averageNetSalaryPrecise.toFixed(decimalPlaces)} €<br> <strong>Priem. čas/deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHoursPrecise.toFixed(decimalPlaces)} h)</strong> `; }
    function getMonthName(month) { const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"]; if (month >= 0 && month < monthNames.length) { return monthNames[month]; } return "Neznámy mesiac"; }
    window.exportToPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const dayName = getDayName(currentYear, currentMonth, i); const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || ''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || ''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || ''; const totalTimeCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`); const totalTimeText = totalTimeCell ? totalTimeCell.textContent.trim() : ''; const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0'; const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0'; if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) ) { tableData.push([ `${i}. ${dayName}`, startTime, endTime, breakTime || '0', totalTimeText, `${parseFloat(grossSalary).toFixed(decimalPlaces)} €`, `${parseFloat(netSalary).toFixed(decimalPlaces)} €` ]); } } doc.autoTable({ head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Hrubá Mzda', 'Čistá Mzda']], body: tableData, startY: 38, theme: 'grid', styles: { font: 'Roboto', fontSize: 9, cellPadding: 2, valign: 'middle' }, headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold', fontSize: 10, halign: 'center' }, alternateRowStyles: { fillColor: [245, 245, 245] }, columnStyles: { 0: { cellWidth: 25, halign: 'left' }, 1: { cellWidth: 18, halign: 'center' }, 2: { cellWidth: 18, halign: 'center' }, 3: { cellWidth: 22, halign: 'center' }, 4: { cellWidth: 35, halign: 'center' }, 5: { cellWidth: 27, halign: 'right' }, 6: { cellWidth: 27, halign: 'right' } } }); const totalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(11); const totalTextContent = totalSalaryDiv.innerHTML .replace(/<br\s*\/?>/gi, '\n') .replace(/<\/?strong>/gi, '') .replace(/ /g, ' ') .replace(/€/g, ' EUR'); doc.text(totalTextContent, 14, totalY); const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane'; doc.save(`Vykaz_prace_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`); }
    window.sendPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`Záznam dochádzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const dayName = getDayName(currentYear, currentMonth, i); const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || ''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || ''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || ''; if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) { tableData.push([ `${i}. ${dayName}`, startTime, endTime, breakTime || '0' ]); } } doc.autoTable({ head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)']], body: tableData, startY: 38, theme: 'grid', styles: { font: 'Roboto', fontSize: 10, cellPadding: 3, valign: 'middle' }, headStyles: { fillColor: [220, 220, 220], textColor: [0, 0, 0], fontStyle: 'bold', fontSize: 11, halign: 'center' }, alternateRowStyles: { fillColor: [245, 245, 245] }, columnStyles: { 0: { cellWidth: 50, halign: 'left' }, 1: { cellWidth: 40, halign: 'center' }, 2: { cellWidth: 40, halign: 'center' }, 3: { cellWidth: 40, halign: 'center' } } }); try { const pdfBlob = doc.output('blob'); const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane'; const pdfFileName = `Dochadzka_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' }); if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) { navigator.share({ files: [pdfFile], title: `Dochádzka ${getMonthName(currentMonth)} ${currentYear}`, text: `Záznam dochádzky pre ${employeeName} za ${getMonthName(currentMonth)} ${currentYear}.` }) .then(() => console.log('PDF (dochádzka) bolo úspešne zdieľané')) .catch(error => { if (error.name !== 'AbortError') { console.error('Chyba pri zdieľaní PDF (dochádzka):', error); showErrorNotification('Chyba pri zdieľaní PDF: ' + error.message); } else { console.log('Zdieľanie PDF (dochádzka) bolo zrušené používateľom.'); } }); } else { showErrorNotification('Funkcia zdieľania súborov nie je podporovaná v tomto prehliadači.'); doc.save(pdfFileName); } } catch (error) { console.error('Chyba pri generovaní PDF (dochádzka) pre zdieľanie:', error); showErrorNotification('Chyba pri príprave PDF na zdieľanie: ' + error.message); } }
    window.changeDecimalPlaces = function() { decimalPlaces = parseInt(decimalPlacesSelect.value); localStorage.setItem('decimalPlaces', decimalPlaces); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)){ calculateRow(i); } } calculateAndUpdateTotals(); }
    window.updateEmployeeName = function() { employeeName = employeeNameInput.value.trim(); localStorage.setItem('employeeName', employeeName); updateGreeting(); calculateAndUpdateTotals(); }
    window.updateSettings = function() { const newHourlyWage = parseFloat(hourlyWageInput.value); const newTaxRatePercent = parseFloat(taxRateInput.value); if (!isNaN(newHourlyWage) && newHourlyWage >= 0) { hourlyWage = newHourlyWage; } else { hourlyWageInput.value = hourlyWage; } if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) { taxRate = newTaxRatePercent / 100; } else { taxRateInput.value = (taxRate * 100).toFixed(1); } const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)){ calculateRow(i); } } calculateAndUpdateTotals(); }
    window.changeMonth = function() { const oldMonth = currentMonth; currentMonth = parseInt(monthSelect.value); console.log(`Zmena mesiaca z ${getMonthName(oldMonth)} na ${getMonthName(currentMonth)} (${currentMonth})`); updateUI(); }
    window.changeYear = function() { const oldYear = currentYear; currentYear = parseInt(yearSelect.value); console.log(`Zmena roku z ${oldYear} na ${currentYear}`); updateUI(); }
    function getDaysInMonth(month) { if (month < 0 || month > 11) return 31; return new Date(currentYear, month + 1, 0).getDate(); }
    window.createBackup = function() { const key = `workData-${currentYear}-${currentMonth}`; const dataString = localStorage.getItem(key); if (dataString) { try { const dataObj = JSON.parse(dataString); const ws_data = [ ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"] ]; if (dataObj.data && Array.isArray(dataObj.data)) { const daysInMonth = getDaysInMonth(currentMonth); const dataToExport = dataObj.data.slice(0, daysInMonth); dataToExport.forEach((row, index) => { const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum); ws_data.push([ `${dayNum}. ${dayName}`, row.start || "", row.end || "", row.breakTime || "", row.gross ? parseFloat(row.gross) : 0, row.net ? parseFloat(row.net) : 0 ]); }); } ws_data.push([]); ws_data.push(["Nastavenia:", "Hodnota"]); ws_data.push(["Hodinová mzda", dataObj.hourlyWage]); ws_data.push(["Daňové percento (%)", dataObj.taxRate * 100]); ws_data.push(["Meno pracovníka", dataObj.employeeName]); ws_data.push(["Počet desatinných miest", dataObj.decimalPlaces]); ws_data.push(["Posledná aktualizácia", dataObj.lastUpdated ? new Date(dataObj.lastUpdated).toLocaleString('sk-SK') : "Neznáma"]); const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(ws_data); const moneyFormat = `0.00" €"`; const timeFormat = "hh:mm"; const breakFormat = "0.0"; const dataEndRow = (dataObj.data ? dataObj.data.length : 0) + 1; for (let R = 1; R < dataEndRow; ++R) { if(ws[XLSX.utils.encode_cell({c:1, r:R})]) ws[XLSX.utils.encode_cell({c:1, r:R})].z = timeFormat; if(ws[XLSX.utils.encode_cell({c:2, r:R})]) ws[XLSX.utils.encode_cell({c:2, r:R})].z = timeFormat; if(ws[XLSX.utils.encode_cell({c:3, r:R})]) ws[XLSX.utils.encode_cell({c:3, r:R})].z = breakFormat; if(ws[XLSX.utils.encode_cell({c:4, r:R})]) ws[XLSX.utils.encode_cell({c:4, r:R})].z = moneyFormat; if(ws[XLSX.utils.encode_cell({c:5, r:R})]) ws[XLSX.utils.encode_cell({c:5, r:R})].z = moneyFormat; } ws['!cols'] = [ { wch: 12 }, { wch: 8 }, { wch: 8 }, { wch: 10 }, { wch: 14 }, { wch: 14 } ]; const settingsRowIndex = ws_data.findIndex(row => row[0] === "Nastavenia:"); if (settingsRowIndex !== -1) { ws['!cols'][0].wch = 25; } XLSX.utils.book_append_sheet(wb, ws, `Výkaz ${getMonthName(currentMonth)}`); const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane'; XLSX.writeFile(wb, `Zaloha_BrunoCalc_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`); showSaveNotification('Záloha bola úspešne vytvorená.'); } catch(error) { console.error('Chyba pri vytváraní zálohy:', error); showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message); } } else { showErrorNotification('Nie sú dostupné žiadne lokálne dáta na zálohu pre tento mesiac.'); } };
    window.restoreBackup = function() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'; input.onchange = function(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true }); const sheetName = workbook.SheetNames[0]; const ws = workbook.Sheets[sheetName]; const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false }); const headerRowIndex = rows.findIndex(row => row && row[0]?.toString().toLowerCase().includes("deň")); if (headerRowIndex === -1) throw new Error("Hlavička tabuľky ('Deň', 'Príchod', ...) nebola nájdená."); const header = rows[headerRowIndex]; const dayIndex = header.findIndex(h => h?.toString().toLowerCase().includes("deň")); const startIndex = header.findIndex(h => h?.toString().toLowerCase().includes("príchod")); const endIndex = header.findIndex(h => h?.toString().toLowerCase().includes("odchod")); const breakIndex = header.findIndex(h => h?.toString().toLowerCase().includes("prestávka")); if (dayIndex === -1 || startIndex === -1 || endIndex === -1 || breakIndex === -1) { throw new Error("Nepodarilo sa nájsť všetky požadované stĺpce (Deň, Príchod, Odchod, Prestávka) v hlavičke."); } let dataArray = []; let settings = {}; let i = headerRowIndex + 1; for (; i < rows.length; i++) { const row = rows[i]; if (!row || row.length === 0 || !(row[dayIndex]?.toString().match(/^\d+\.|^Deň/i))) { break; } let startTimeStr = row[startIndex]?.toString() || ""; let endTimeStr = row[endIndex]?.toString() || ""; if (!isNaN(parseFloat(startTimeStr)) && parseFloat(startTimeStr) >= 0 && parseFloat(startTimeStr) <= 1 && !startTimeStr.includes(':')) { startTimeStr = XLSX.SSF.format('hh:mm', parseFloat(startTimeStr)); } if (!isNaN(parseFloat(endTimeStr)) && parseFloat(endTimeStr) >= 0 && parseFloat(endTimeStr) <= 1 && !endTimeStr.includes(':')) { endTimeStr = XLSX.SSF.format('hh:mm', parseFloat(endTimeStr)); } dataArray.push({ start: startTimeStr, end: endTimeStr, breakTime: row[breakIndex] !== undefined ? row[breakIndex].toString().replace(',', '.') : "", gross: "0", net: "0" }); } for (; i < rows.length; i++) { const row = rows[i]; if (row && row.length > 1 && row[0] && typeof row[0] === 'string') { const key = row[0].toString().trim().toLowerCase(); const value = row[1]?.toString().trim() || ""; if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined; else if (key.includes("daňové percento")) settings.taxRate = (parseFloat(value.replace(',', '.').replace('%', '')) || undefined) / 100; else if (key.includes("meno pracovníka")) settings.employeeName = value || undefined; else if (key.includes("počet desatinných miest")) settings.decimalPlaces = parseInt(value) || undefined; } } const backupData = { data: dataArray, hourlyWage: settings.hourlyWage !== undefined ? settings.hourlyWage : (parseFloat(hourlyWageInput.value) || 10), taxRate: settings.taxRate !== undefined ? settings.taxRate : ((parseFloat(taxRateInput.value) || 2) / 100), employeeName: settings.employeeName !== undefined ? settings.employeeName : (employeeNameInput.value || ""), decimalPlaces: settings.decimalPlaces !== undefined ? settings.decimalPlaces : (parseInt(decimalPlacesSelect.value) || 1), lastUpdated: new Date().toISOString() }; if (!confirm(`Načítaná záloha obsahuje ${dataArray.length} dní. Naozaj chcete prepísať aktuálne dáta pre ${getMonthName(currentMonth)} ${currentYear}?`)) { console.log('Obnova zálohy zrušená používateľom.'); return; } localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(backupData)); parseAndApplyData(JSON.stringify(backupData)); showSaveNotification('Záloha bola úspešne obnovená a načítaná.'); if (currentUser && isOnline()) { saveToFirestore(); } } catch (error) { console.error('Chyba pri načítavaní zálohy:', error); showErrorNotification('Chyba pri načítavaní zálohy: ' + error.message); } };
        reader.onerror = function() { showErrorNotification('Chyba pri čítaní súboru.'); }; // Opravené ukončenie
        reader.readAsArrayBuffer(file);
      };
      input.click();
    };

    // Funkcia na nastavenie globálnej SW registrácie
    window.setSwRegistration = (registration) => { console.log("Setting global swRegistration variable"); swRegistration = registration; if (currentUser && Notification.permission === 'granted') { console.log("SW registration received, attempting to get token now."); getAndSaveToken().catch(err => console.error("Token fetch failed after SW registration:", err)); } else { console.log("SW registration received, but conditions not met for immediate token fetch."); updateNotificationButtonState(); } }

    // ==================== SEKCIA: PUSH NOTIFIKÁCIE ====================
    function updateNotificationButtonState() { if (!enableNotificationsBtn || !messaging || !('Notification' in window) || !('serviceWorker' in navigator)) { if(enableNotificationsBtn) { enableNotificationsBtn.disabled = true; enableNotificationsBtn.textContent = 'Notifikácie nie sú podporované'; enableNotificationsBtn.style.display = 'none'; } return; } if (!currentUser) { if(enableNotificationsBtn) { enableNotificationsBtn.disabled = true; enableNotificationsBtn.textContent = 'Prihláste sa pre notifikácie'; enableNotificationsBtn.style.display = 'block'; } return; } enableNotificationsBtn.style.display = 'block'; const currentPermission = Notification.permission; console.log("Current Notification permission:", currentPermission); if (currentPermission === 'granted') { enableNotificationsBtn.disabled = true; enableNotificationsBtn.textContent = 'Notifikácie sú povolené'; if (swRegistration) { getAndSaveToken().catch(err => console.error("Background token fetch failed on state update:", err)); } else { console.log("SW registration not available yet for background token fetch."); } } else if (currentPermission === 'denied') { enableNotificationsBtn.disabled = true; enableNotificationsBtn.textContent = 'Notifikácie zamietnuté'; } else { enableNotificationsBtn.disabled = false; enableNotificationsBtn.textContent = 'Povoliť Notifikácie'; } }
    if (enableNotificationsBtn && messaging) { enableNotificationsBtn.addEventListener('click', requestNotificationPermission); }
    async function requestNotificationPermission() { if (!messaging || !('Notification' in window) || !('serviceWorker' in navigator)) { showErrorNotification('Push notifikácie nie sú podporované v tomto prehliadači alebo kontexte.'); return; } if (!currentUser) { showErrorNotification('Pre povolenie notifikácií sa musíte najprv prihlásiť.'); return; } console.log('Requesting notification permission...'); try { const permission = await Notification.requestPermission(); console.log('Notification permission result:', permission); updateNotificationButtonState(); if (permission === 'granted') { if (swRegistration) { await getAndSaveToken(); } else { console.warn("Permission granted, but SW registration not yet available to get token."); } } else if (permission === 'denied') { showErrorNotification('Povolenie pre notifikácie bolo zamietnuté.'); } else { console.log('Notification permission request dismissed.'); } } catch (error) { console.error('Error requesting notification permission:', error); showErrorNotification('Chyba pri žiadaní o povolenie notifikácií.'); } }
    async function getAndSaveToken() { if (!messaging || !('Notification' in window) || !('serviceWorker' in navigator) || Notification.permission !== 'granted' || !currentUser || !swRegistration) { console.log("Cannot get token: Conditions not met (messaging, Notification, SW, permission, user, swRegistration)."); updateNotificationButtonState(); return; } try { const vapidKey = "BFgn_i2DvvOzjah-tx4ikCjKL3073NS8IWxVHubgOyMUeG39dSXlRPb9vTFn7_4KkvlfS4mjGH-1irqcoR8zQx8"; console.log('Attempting to get FCM token using registration:', swRegistration); const currentToken = await getToken(messaging, { vapidKey: vapidKey, serviceWorkerRegistration: swRegistration }); if (currentToken) { console.log('FCM Token:', currentToken); await saveTokenToFirestore(currentToken); console.log("Token retrieved and saved successfully."); } else { console.log('No registration token available despite granted permission and SW registration.'); showErrorNotification('Nepodarilo sa získať registračný token. Skúste obnoviť stránku.'); if(enableNotificationsBtn) { enableNotificationsBtn.disabled = false; enableNotificationsBtn.textContent = 'Povoliť Notifikácie'; } } } catch (err) { console.error('An error occurred while retrieving token. ', err); if (err.code === 'messaging/notifications-blocked' || err.code === 'messaging/permission-blocked') { showErrorNotification('Notifikácie sú blokované v nastaveniach prehliadača.'); } else if (err.code === 'messaging/failed-service-worker-registration' || err.code === 'messaging/sw-registration-expected') { showErrorNotification('Chyba registrácie service workera. Skúste tvrdý refresh (Ctrl+Shift+R).'); } else { showErrorNotification('Chyba pri získavaní tokenu pre notifikácie: ' + err.message); } updateNotificationButtonState(); } }
    async function saveTokenToFirestore(token) { if (!currentUser) { console.warn("User not logged in, cannot save FCM token."); return; } const userRef = doc(db, 'users', currentUser.uid); try { await updateDoc(userRef, { fcmTokens: arrayUnion(token) }); console.log('FCM token updated/added for user:', currentUser.uid); } catch (error) { if (error.code === 'not-found' || error.message.includes("No document to update")) { console.log('User document or fcmTokens field not found, creating/setting field...'); try { await setDoc(userRef, { fcmTokens: [token] }, { merge: true }); console.log('User document/field created/updated with FCM token.'); } catch (setError) { console.error('Error setting FCM token in Firestore after update failed:', setError); showErrorNotification('Nepodarilo sa uložiť token do databázy.'); } } else { console.error('Error saving FCM token to Firestore:', error); showErrorNotification('Nepodarilo sa uložiť token do databázy.'); } } }
    if (messaging) { onMessage(messaging, (payload) => { console.log('Message received while app is in foreground: ', payload); const notificationTitle = payload.notification?.title || 'Nová správa'; const notificationBody = payload.notification?.body || ''; showSaveNotification(`${notificationTitle}: ${notificationBody}`); }); }
    // ==================== KONIEC SEKCIE: PUSH NOTIFIKÁCIE ====================

    // Vyčistená UI Update funkcia
    function updateUI() {
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');

        createTable(); // Vykreslí tabuľku

        if (currentUser) {
            if (loginForm) loginForm.style.display = 'none'; else console.error("loginForm not found!");
            if (userInfo) userInfo.style.display = 'block'; else console.error("userInfo not found!");
            if (userEmail) userEmail.textContent = currentUser.email; else console.error("userEmail not found!");
            loadInitialData();
            updateNotificationButtonState();
        } else {
            if (loginForm) {
                 loginForm.style.display = 'flex';
            } else {
                 console.error('Element loginForm nebol najdeny!');
            }
            if (userInfo) userInfo.style.display = 'none'; else console.error("userInfo not found!");
            loadFromLocalStorageOnly();
            if (!isOnline()) { showErrorNotification('Ste offline. Prihláste sa, keď budete online, pre prístup k cloudovým dátam.'); }
            if(enableNotificationsBtn) {
                enableNotificationsBtn.disabled = true;
                enableNotificationsBtn.textContent = 'Prihláste sa pre notifikácie';
                enableNotificationsBtn.style.display = 'block';
            } else { console.error("enableNotificationsBtn not found!"); }
        }
    }

    // Vyčistená createTable funkcia
    function createTable() {
      const daysInMonth = getDaysInMonth(currentMonth);
      if (!workDays) { console.error("Element workDays (tbody) nebol nájdený PRED mazaním obsahu!"); return; }
      workDays.innerHTML = '';
      if (daysInMonth <= 0) { console.warn("Počet dní v mesiaci je 0 alebo menej."); return; }
      const today = new Date(); const currentDayOfMonth = today.getDate(); const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
      const fragment = document.createDocumentFragment();
      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) { row.classList.add('current-day'); }
        const dayName = getDayName(currentYear, currentMonth, i);
        row.innerHTML = `<td>${i}. ${dayName}</td><td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}')"></td><td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}')"></td><td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td><td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td><td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td><td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td><td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>`;
        fragment.appendChild(row);
      }
      if (!workDays) { console.error("Element workDays (tbody) nebol nájdený PRED pripojením fragmentu!"); return; }
      workDays.appendChild(fragment);
    }

    // -------------------- INIT --------------------
    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed. User:', user ? user.email : 'None'); // Tento log je užitočný, necháme ho
      currentUser = user;
      updateUI();
    });

    // Priradenie funkcií na window
    window.login = login; window.register = register; window.logout = logout; window.resetPassword = resetPassword; window.updateEmployeeName = updateEmployeeName; window.updateSettings = updateSettings; window.changeMonth = changeMonth; window.changeYear = changeYear; window.changeDecimalPlaces = changeDecimalPlaces; window.toggleDarkMode = toggleDarkMode; window.exportToPDF = exportToPDF; window.sendPDF = sendPDF; window.restoreBackup = restoreBackup; window.createBackup = createBackup; window.loadFromFirestore = loadFromFirestore; window.handleInput = handleInput; window.handleBreakInput = handleBreakInput; window.resetRow = resetRow;

  </script>

  <!-- Registrácia Service Workera -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope); // Tento log je užitočný
            if (typeof window.setSwRegistration === 'function') {
                 window.setSwRegistration(registration);
            } else {
                 console.error("Funkcia window.setSwRegistration nebola nájdená! Skontrolujte poradie načítania skriptov."); // Tento error je dôležitý
            }
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error); // Tento error je dôležitý
            const btn = document.getElementById('enableNotificationsBtn');
            if(btn) {
                 btn.disabled = true;
                 btn.textContent = 'Chyba Service Workera';
                 if (typeof showErrorNotification === 'function') { showErrorNotification('Nepodarilo sa registrovať Service Worker, notifikácie nebudú fungovať.'); }
                 else { alert('Nepodarilo sa registrovať Service Worker, notifikácie nebudú fungovať.'); }
            }
          });
      });
    } else {
       const btn = document.getElementById('enableNotificationsBtn');
       if(btn) { btn.disabled = true; btn.textContent = 'Service Worker nepodporovaný'; btn.style.display = 'none'; }
    }
  </script>
</body>
</html>
