<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <link rel="manifest" href="./manifest.json" />
  <!-- Ikony pre PWA a favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png"> <!-- Pridajte si vlastn√∫ ikonu -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- CSS Premenn√© --- */
    :root {
      --primary-bg-color: #f4f4f4;
      --secondary-bg-color: white;
      --primary-text-color: #333;
      --input-bg-color: #ffffd0;
      --input-note-bg-color: #e6faff;
      --table-header-bg-color: #f2f2f2;
      --table-border-color: #ddd;
      --current-day-bg-color: #8a2be2;
      --current-day-text-color: white;
      --btn-primary-bg: #4CAF50;
      --btn-primary-hover-bg: #388e3c;
      --btn-secondary-bg: #8a2be2;
      --btn-secondary-hover-bg: #6a1bb2;
      --btn-danger-bg: #f44336;
      --btn-danger-hover-bg: #d32f2f;
      --btn-highlight-bg: #ffcc00;
      --btn-text-color: white;
      --total-salary-bg: #e6f3ff;
      --link-color: #007bff;
      --link-hover-color: #0056b3;
      --border-radius: 5px;
      --box-shadow: 0 0 10px rgba(0,0,0,0.1);
      --font-family: Arial, sans-serif;
      --base-font-size: 16px;
      --focus-outline-color: #4CAF50;

      /* Tmav√Ω re≈æim */
      --dark-primary-bg-color: #333;
      --dark-secondary-bg-color: #444;
      --dark-primary-text-color: #f4f4f4;
      --dark-input-bg-color: #666;
      --dark-input-note-bg-color: #5a5a7a;
      --dark-table-header-bg-color: #666;
      --dark-table-border-color: #555;
      --dark-current-day-bg-color: #4a0e8f;
      --dark-total-salary-bg: #2c3e50;
      --dark-link-color: #6bbaff;
      --dark-link-hover-color: #8ecfff;
    }

    /* --- Z√°kladn√© ≈°t√Ωly --- */
    html {
      font-size: var(--base-font-size);
      scroll-behavior: smooth;
    }
    body {
      font-family: var(--font-family);
      line-height: 1.6;
      margin: 0;
      padding: 8px;
      background-color: var(--primary-bg-color);
      color: var(--primary-text-color);
      font-size: 0.9rem;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      background: var(--secondary-bg-color);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 1.9rem;
      color: var(--primary-text-color);
      margin-bottom: 8px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -8px;
      font-size: 0.95rem;
      font-weight: normal;
    }
    body.dark-mode h2 { color: #ccc; }

    /* --- Focus ≈°t√Ωly pre dostupnos≈• --- */
    *:focus-visible {
        outline: 2px solid var(--focus-outline-color);
        outline-offset: 2px;
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3);
    }
    /* Reset pre prvky, ktor√© maj√∫ vlastn√Ω focus (napr. inputy) */
    input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible {
        outline: 2px solid var(--focus-outline-color);
        outline-offset: 1px; /* Bli≈æ≈°ie k prvku */
    }

    .settings {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 5px;
    }
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
      margin: 2px 4px;
    }
    .settings > div {
      flex: 1 1 200px;
    }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%;
      margin-bottom: 8px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: var(--border-radius);
    }
    body.dark-mode .settings > button#toggleSettingsBtn {
      background-color: #555;
      color: var(--dark-primary-text-color);
      border-color: #666;
    }
    .settings > button.highlight {
      flex: 1 1 145px;
    }
    .settings label {
      display: block;
      margin-bottom: 3px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    #settings-collapsible-content {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-top 0.4s ease-out;
      gap: 5px 8px; /* Row gap, column gap */
    }
    #settings-collapsible-content.visible {
      max-height: 550px; /* Zv√Ω≈°en√© pre nov√© nastavenia */
      opacity: 1;
      margin-top: 8px;
    }
    #settings-collapsible-content > div {
      flex: 1 1 200px;
      margin: 2px 0px; /* Upraven√©, gap sa postar√° o medzery */
    }
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 15px;
      border: 1px solid var(--table-border-color);
      border-radius: var(--border-radius);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid var(--table-border-color);
      text-align: left;
      font-size: 0.85rem;
      vertical-align: middle;
    }
    th {
      background-color: var(--table-header-bg-color);
      font-weight: bold;
      position: sticky; /* Pripnutie hlaviƒçky pri skrolovan√≠ */
      top: 0;
      z-index: 10;
    }
    /* V√≠kendov√© dni */
    tr.weekend-day td:first-child {
        background-color: #f9f9f9;
        font-style: italic;
    }
    body.dark-mode tr.weekend-day td:first-child {
        background-color: #3e3e3e;
    }

    td .time-input-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    td .time-input-wrapper input[type="tel"] {
      flex-grow: 1;
      min-width: 60px;
      padding: 6px 5px;
      font-size: 0.85rem;
    }
    td .time-input-wrapper .time-btn, .copy-day-btn {
      font-size: 1rem;
      cursor: pointer;
      padding: 3px 4px;
      border: 1px solid transparent;
      border-radius: 3px;
      line-height: 1;
      background: none;
      color: #555;
      user-select: none;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .copy-day-btn { font-size: 0.8em; padding: 2px 3px; margin-left: auto;}
    td .time-input-wrapper .time-btn:hover, .copy-day-btn:hover {
      background-color: #eee;
      border-color: #ccc;
    }
    body.dark-mode td .time-input-wrapper .time-btn, body.dark-mode .copy-day-btn {
      color: #bbb;
    }
    body.dark-mode td .time-input-wrapper .time-btn:hover, body.dark-mode .copy-day-btn:hover {
      background-color: #555;
      border-color: #777;
      color: #fff;
    }

    /* --- ≈†√≠rky stƒ∫pcov --- */
    th:nth-child(1), td:nth-child(1) { width: 90px; white-space: nowrap;}  /* De≈à */
    th:nth-child(2), td:nth-child(2) { width: 105px; white-space: nowrap;} /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { width: 105px; white-space: nowrap;} /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 85px; white-space: nowrap;}  /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { width: 115px; white-space: nowrap;} /* Odpracovan√© */
    th:nth-child(7), td:nth-child(7) { width: 95px; white-space: nowrap;}  /* Hrub√° Mzda */
    th:nth-child(8), td:nth-child(8) { width: 95px; white-space: nowrap;}  /* ƒåist√° Mzda */
    th:nth-child(9), td:nth-child(9) { width: 60px; white-space: nowrap; text-align: center;}  /* Akcia */

    th:nth-child(6), td:nth-child(6) { /* Pozn√°mka */
      min-width: 230px;
      width: 38%;
      white-space: normal; /* D√¥le≈æit√© pre zalamovanie textu */
    }

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 7px;
      box-sizing: border-box;
      background-color: var(--input-bg-color);
      font-size: 0.85rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      vertical-align: middle;
      font-family: var(--font-family);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="tel"]:focus, input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
        border-color: var(--focus-outline-color);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    td input[type="number"] {
      min-width: 55px;
    }
    td input[type="number"][readonly] {
      background-color: #f0f0f0;
      border: none;
      padding-left: 2px;
      padding-right: 2px;
      color: #555;
    }
    textarea[id^="note-"] {
      background-color: var(--input-note-bg-color);
      resize: none; /* Zak√°zan√© manu√°lne roztiahnutie, JS sa postar√° o dynamick√© */
      min-height: 34px; /* V√Ω≈°ka jedn√©ho riadku */
      line-height: 1.4;
      overflow-y: hidden; /* Skry≈• scrollbar, ak nie je potrebn√Ω */
      white-space: pre-wrap; /* Zachova≈• zalamovanie a medzery */
      word-wrap: break-word;
    }

    .result {
      font-weight: bold;
      margin-top: 15px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
      gap: 8px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 18px;
      color: var(--btn-text-color);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      margin: 4px;
      transition: background-color 0.3s ease, transform 0.1s ease;
      text-align: center;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0px); }

    .btn.is-loading {
        pointer-events: none;
        position: relative;
    }
    .btn.is-loading::before {
        content: "";
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.5);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

    .reset-btn {
      background-color: var(--btn-danger-bg);
      padding: 6px 10px;
      font-size: 0.85rem;
      flex: 0 0 auto;
      min-width: 40px;
    }
    .reset-btn:hover { background-color: var(--btn-danger-hover-bg); }

    .export-btn { background-color: var(--btn-primary-bg); }
    .export-btn:hover { background-color: var(--btn-primary-hover-bg); }
    .backup-btn { background-color: var(--btn-secondary-bg); }
    .backup-btn:hover { background-color: var(--btn-secondary-hover-bg); }
    .highlight {
      background-color: var(--btn-highlight-bg);
      color: #333;
      font-weight: bold;
      border: 2px solid var(--btn-highlight-bg);
    }
    #totalSalary {
      font-size: 0.95rem;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 12px;
      background-color: var(--total-salary-bg);
      border-radius: var(--border-radius);
      line-height: 1.7;
    }
    #localStorageIndicator {
        font-size: 0.75rem;
        text-align: right;
        margin-top: 5px;
        color: #777;
    }
    body.dark-mode #localStorageIndicator { color: #aaa; }

    .current-day { background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color); }
    .current-day td, .current-day th { background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color) !important; border-color: var(--current-day-bg-color) !important; }
    .current-day input, .current-day select, .current-day textarea {
      background-color: #9932cc !important; /* Tmav≈°ia fialov√° pre inputy */
      color: var(--current-day-text-color) !important;
      border-color: #b366ff !important;
    }
    .current-day textarea[id^="note-"] { background-color: #aa44dd !important; }
    .current-day .time-btn, .current-day .copy-day-btn { color: var(--current-day-text-color) !important; }
    .current-day .time-btn:hover, .current-day .copy-day-btn:hover { background-color: #7a1fb4 !important; border-color: #9932cc !important; }

    /* --- Tmav√Ω re≈æim --- */
    body.dark-mode {
      background-color: var(--dark-primary-bg-color);
      color: var(--dark-primary-text-color);
    }
    body.dark-mode .container { background-color: var(--dark-secondary-bg-color); color: var(--dark-primary-text-color); }
    body.dark-mode h1 { color: var(--dark-primary-text-color); }
    body.dark-mode .table-container { border-color: var(--dark-table-border-color); }
    body.dark-mode table { color: var(--dark-primary-text-color); }
    body.dark-mode th { background-color: var(--dark-table-header-bg-color); }
    body.dark-mode td { border-color: var(--dark-table-border-color); }
    body.dark-mode td input[type="number"][readonly] { background-color: #505050; color: #ccc; }
    body.dark-mode .current-day { background-color: var(--dark-current-day-bg-color) !important; }
    body.dark-mode .current-day td, body.dark-mode .current-day th { background-color: var(--dark-current-day-bg-color) !important; border-color: var(--dark-current-day-bg-color) !important;}
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"], body.dark-mode input[type="text"],
    body.dark-mode select, body.dark-mode textarea {
      background-color: var(--dark-input-bg-color);
      color: white;
      border-color: #555;
    }
    body.dark-mode textarea[id^="note-"] { background-color: var(--dark-input-note-bg-color); border-color: #4a4a6a;}
    body.dark-mode .current-day input, body.dark-mode .current-day select, body.dark-mode .current-day textarea {
      background-color: #5c1db3 !important; color: #fff !important; border-color: #7e4bd7 !important;
    }
    body.dark-mode .current-day textarea[id^="note-"] { background-color: #6c2fc7 !important; }
    body.dark-mode .current-day .time-btn, body.dark-mode .current-day .copy-day-btn { color: #fff !important; }
    body.dark-mode .current-day .time-btn:hover, body.dark-mode .current-day .copy-day-btn:hover { background-color: #4a0e8f !important; border-color: #5c1db3 !important; }
    body.dark-mode .btn { color: var(--dark-primary-text-color); } /* Text tlaƒçidiel m√¥≈æe by≈• aj svetl√Ω, z√°le≈æ√≠ od BG */
    body.dark-mode .reset-btn { background-color: var(--btn-danger-hover-bg); } /* Tmav≈°√≠ odtie≈à pre tmav√Ω re≈æim */
    body.dark-mode .export-btn { background-color: var(--btn-primary-hover-bg); }
    body.dark-mode .backup-btn { background-color: var(--btn-secondary-hover-bg); }
    body.dark-mode #totalSalary { background-color: var(--dark-total-salary-bg); }

    /* --- Responzivita --- */
    @media (max-width: 768px) {
      html { font-size: 15px; } /* Mierne men≈°√≠ base font */
      body { padding: 6px; font-size: 0.9rem; }
      .container { padding: 10px; }
      h1 { font-size: 1.7rem; } h2 { font-size: 0.9rem; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; margin: 4px 0; }
      .settings > button#toggleSettingsBtn { padding: 10px 12px; font-size: 0.92rem; }
      #settings-collapsible-content.visible { max-height: 650px; } /* Zv√Ω≈°en√© pre viac nastaven√≠ */
      th, td { padding: 7px; font-size: 0.88rem; }
      textarea[id^="note-"] { min-height: 36px; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { font-size: 0.95rem; padding: 11px 15px; margin: 5px 0; }
    }
    @media (max-width: 480px) {
      html { font-size: 14px; }
      body { padding: 5px; } .container { padding: 8px; }
      h1 { font-size: 1.5rem; } h2 { font-size: 0.85rem; }
      th, td { padding: 6px; font-size: 0.85rem; }
      textarea[id^="note-"] { min-height: 38px; }
      #settings-collapsible-content.visible { max-height: 750px; } /* E≈°te viac miesta pre nastavenia na mal√Ωch obr. */
      .btn { font-size: 0.9rem; padding: 10px 14px; }
    }

    /* --- Notifik√°cie --- */
    #saveNotification, #errorNotification, #warningNotification {
        display: none; position: fixed; bottom: 20px; right: 20px;
        padding: 12px 20px;
        border-radius: var(--border-radius); font-size: 0.9rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2); z-index: 1000;
        opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        transform: translateY(20px);
    }
    #saveNotification.show, #errorNotification.show, #warningNotification.show {
        display: block; opacity: 1; transform: translateY(0);
    }
    #saveNotification { background-color: var(--btn-primary-bg); color: white; }
    #errorNotification { background-color: var(--btn-danger-bg); color: white; }
    #warningNotification { background-color: var(--btn-highlight-bg); color: #333; }

    /* --- Login formul√°r --- */
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
      width: 220px; margin: 6px auto; display: block; padding: 8px; font-size: 0.9rem;
    }
    #login-form .btn { width: 130px; margin: 6px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.88rem; color: var(--link-color); text-decoration: none; }
    #login-form a:hover { text-decoration: underline; color: var(--link-hover-color); }
    body.dark-mode #login-form a { color: var(--dark-link-color); }
    body.dark-mode #login-form a:hover { color: var(--dark-link-hover-color); }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" aria-label="Email">
        <input type="password" id="password" placeholder="Heslo" aria-label="Heslo">
        <button class="btn export-btn" onclick="loginUser()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="registerUser()">Registrova≈•</button>
        <a href="#" onclick="resetUserPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logoutUser()" style="margin-left: 10px;">Odhl√°si≈• sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <div class="settings">
        <button id="toggleSettingsBtn" class="btn" aria-expanded="false" aria-controls="settings-collapsible-content">Zobrazi≈• nastavenia ‚ñº</button>
        <div id="settings-collapsible-content">
            <div>
                <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
            </div>
            <div>
                <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
                <label for="taxRateInput">Da≈àov√© percento (%):</label>
                <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
                <label for="defaultBreakInput">Predvolen√° prest√°vka (hod.):</label>
                <input type="number" id="defaultBreakInput" value="0.5" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
                <label for="monthSelect">Mesiac:</label>
                <select id="monthSelect" onchange="changeMonth()"></select>
            </div>
            <div>
                <label for="yearSelect">Rok:</label>
                <select id="yearSelect" onchange="changeYear()"></select>
            </div>
            <div>
                <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                  <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                </select>
            </div>
        </div>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky sa generuj√∫ dynamicky -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite"></div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
        <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (s pozn.)</button>
        <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu z XLSX</button>
        <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu XLSX</button>
        <button class="btn export-btn" onclick="loadFromFirestore()">Naƒç√≠ta≈• z cloudu</button>
        <button class="btn reset-btn" onclick="clearMonthData()" style="background-color: #ff9800; flex-grow: 0.5;" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification" role="alert" aria-live="assertive"></div>
  <div id="warningNotification" role="alert" aria-live="assertive"></div>

  <script type="module">
    // Importy Firebase (bez zmien, ak nie s√∫ nutn√© nov≈°ie verzie)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // --- Firebase Konfigur√°cia ---
    // POZOR: Tieto kƒæ√∫ƒçe s√∫ verejn√© a sl√∫≈æia na identifik√°ciu va≈°ej Firebase aplik√°cie.
    // Pre produkciu zabezpeƒçte svoje d√°ta pomocou Firebase Security Rules a App Check.
    // apiKey by mal by≈• chr√°nen√Ω, ak je to mo≈æn√© (napr. cez backend proxy), ale pre client-side SDK je ≈°tandardne verejn√Ω.
    // reCAPTCHA kƒæ√∫ƒç je verejn√Ω (site key).
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Nahraƒète va≈°im API kƒæ√∫ƒçom
        authDomain: "uuuuu-f7ef9.firebaseapp.com", // Nahraƒète va≈°ou Auth dom√©nou
        projectId: "uuuuu-f7ef9", // Nahraƒète va≈°im Project ID
        storageBucket: "uuuuu-f7ef9.appspot.com", // Nahraƒète va≈°im Storage Bucket
        messagingSenderId: "456105865458", // Nahraƒète va≈°im Sender ID
        appId: "1:456105865458:web:101f0a4dcb455f174b606b", // Nahraƒète va≈°im App ID
    };

    // Inicializ√°cia Firebase
    const app = initializeApp(firebaseConfig);
    try {
        // POZOR: Nahraƒète 'YOUR_RECAPTCHA_SITE_KEY' va≈°√≠m reCAPTCHA v3 site kƒæ√∫ƒçom.
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Pou≈æite svoj kƒæ√∫ƒç
            isTokenAutoRefreshEnabled: true
        });
        console.log("Firebase App Check initialized.");
    } catch (e) {
        console.warn("App Check initialization failed (this might happen on localhost if not configured, or if reCAPTCHA key is invalid):", e);
    }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Glob√°lne Premenn√© ---
    let currentUser = null;
    let currentListenerUnsubscribe = null;
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const subTitle = document.getElementById('subTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const defaultBreakInput = document.getElementById('defaultBreakInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');
    const localStorageIndicator = document.getElementById('localStorageIndicator');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // Naƒç√≠tanie hodn√¥t z localStorage s predvolen√Ωmi hodnotami
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02; // 2%
    let defaultBreakTime = parseFloat(localStorage.getItem('defaultBreakTime')) || 0.5; // 0.5 hodiny

    const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
    const DAY_NAMES_SHORT = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];

    // --- Inicializ√°cia UI Prvkov ---
    function populateMonthSelect() {
        monthSelect.innerHTML = '';
        MONTH_NAMES.forEach((name, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            monthSelect.appendChild(option);
        });
    }

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = currentDate.getFullYear() + 5; // Do 5 rokov do bud√∫cnosti
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }

    function initializeSettingsInputs() {
        populateMonthSelect();
        populateYearSelect();
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        hourlyWageInput.value = hourlyWage.toFixed(1); // Zobrazi≈• s jedn√Ωm desatinn√Ωm miestom pre konzistenciu
        taxRateInput.value = (taxRate * 100).toFixed(1);
        defaultBreakInput.value = defaultBreakTime.toFixed(1);
        updatePageTitle();
        updateLocalStorageSizeIndicator();
    }

    // --- Event Listeners ---
    if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
            const isVisible = settingsCollapsibleContent.classList.toggle('visible');
            toggleSettingsBtn.textContent = isVisible ? 'Skry≈• nastavenia ‚ñ≤' : 'Zobrazi≈• nastavenia ‚ñº';
            toggleSettingsBtn.setAttribute('aria-expanded', isVisible);
        });
    }
    window.addEventListener('online', () => handleOnlineStatusChange(true));
    window.addEventListener('offline', () => handleOnlineStatusChange(false));

    // --- Utility Funkcie ---
    function getDaysInMonth(month, year) {
        return new Date(year, month + 1, 0).getDate();
    }
    function getDayName(year, month, day) {
        const date = new Date(year, month, day);
        return DAY_NAMES_SHORT[date.getDay()];
    }
    function isWeekend(year, month, day) {
        const dayOfWeek = new Date(year, month, day).getDay();
        return dayOfWeek === 0 || dayOfWeek === 6; // Nedeƒæa (0) alebo Sobota (6)
    }
    const debounce = (func, wait) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    };

    // --- Notifik√°cie a Status ---
    function showNotification(id, message, duration = 3000) {
        const notification = document.getElementById(id);
        if (!notification) return;
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), duration);
    }
    window.showSaveNotification = (message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©.') => showNotification('saveNotification', message);
    window.showErrorNotification = (message) => showNotification('errorNotification', message, 4000);
    window.showWarningNotification = (message) => showNotification('warningNotification', message, 4000);

    function handleOnlineStatusChange(online) {
        const message = online ? 'Spojenie obnoven√©, ste online.' : 'Ste offline. Zmeny sa ulo≈æia lok√°lne.';
        const notificationType = online ? 'saveNotification' : 'warningNotification';
        showNotification(notificationType, message);
        if (online) {
            syncWithFirebase(); // Pokus o synchroniz√°ciu pri obnoven√≠ spojenia
        }
        updateUI(); // Aktualiz√°cia UI pre pr√≠padn√© zmeny (napr. deaktiv√°cia tlaƒçidiel)
    }

    function setLoadingState(button, isLoading, originalText = "Sprac√∫vam...") {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.textContent;
            button.innerHTML = `<span class="spinner" role="status" aria-hidden="true"></span> ${originalText}`;
            button.classList.add('is-loading');
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || originalText; // Fallback if originalText was not passed
            button.classList.remove('is-loading');
        }
    }

    // --- UI Aktualiz√°cie ---
    function updateGreeting() {
        const wavingHand = "üëã";
        const namePart = employeeName ? `${employeeName.split(' ')[0]}` : "";
        mainTitle.textContent = `Vitaj${namePart ? ' ' + namePart : ''}${wavingHand}`;
        updatePageTitle();
    }

    function updatePageTitle() {
        const monthName = MONTH_NAMES[currentMonth];
        const titleNamePart = employeeName ? `${employeeName} - ` : "";
        document.title = `${titleNamePart}${monthName} ${currentYear} | Bruno's Calc`;
        subTitle.textContent = `${monthName} ${currentYear}`;
    }

    function updateLocalStorageSizeIndicator() {
        let total = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            total += (key.length + value.length) * 2; // Pribli≈æn√° veƒækos≈• v bajtoch (UTF-16)
        }
        const sizeKB = (total / 1024).toFixed(1);
        const limitMB = 5; // Typick√Ω limit pre localStorage
        localStorageIndicator.textContent = `Lok√°lne √∫lo≈æisko: ~${sizeKB} KB / ${limitMB} MB`;
    }

    // --- Firebase Autentifik√°cia ---
    window.loginUser = async function() {
        const btn = event.target;
        setLoadingState(btn, true, "Prihlasujem...");
        if (!navigator.onLine) { showErrorNotification('Ste offline. Prihl√°senie je mo≈æn√© iba online.'); setLoadingState(btn, false, "Prihl√°si≈• sa"); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); setLoadingState(btn, false, "Prihl√°si≈• sa"); return; }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showSaveNotification('√öspe≈°ne prihl√°sen√Ω.');
        } catch (error) {
            console.error('Chyba pri prihl√°sen√≠:', error);
            showErrorNotification('Chyba pri prihl√°sen√≠: ' + mapFirebaseAuthError(error.code));
        } finally {
            setLoadingState(btn, false, "Prihl√°si≈• sa");
        }
    };
    window.registerUser = async function() {
        const btn = event.target;
        setLoadingState(btn, true, "Registrujem...");
        if (!navigator.onLine) { showErrorNotification('Ste offline. Registr√°cia je mo≈æn√° iba online.'); setLoadingState(btn, false, "Registrova≈•"); return; }
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) { showErrorNotification('Pros√≠m, zadajte email aj heslo.'); setLoadingState(btn, false, "Registrova≈•"); return; }
        if (password.length < 6) { showErrorNotification('Heslo mus√≠ ma≈• aspo≈à 6 znakov.'); setLoadingState(btn, false, "Registrova≈•"); return; }
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            await createUserCollection(); // Vytvor√≠ z√°kladn√∫ ≈°trukt√∫ru pre nov√©ho pou≈æ√≠vateƒæa
            showSaveNotification('√öspe≈°ne zaregistrovan√Ω a prihl√°sen√Ω.');
        } catch (error) {
            console.error('Chyba pri registr√°cii:', error);
            showErrorNotification('Chyba pri registr√°cii: ' + mapFirebaseAuthError(error.code));
        } finally {
            setLoadingState(btn, false, "Registrova≈•");
        }
    };
    window.logoutUser = async function() {
        const btn = event.target;
        setLoadingState(btn, true, "Odhlasujem...");
        if (currentListenerUnsubscribe) {
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
        }
        try {
            await signOut(auth);
            showSaveNotification('√öspe≈°ne odhl√°sen√Ω.');
        } catch (error) {
            console.error('Chyba pri odhl√°sen√≠:', error);
            showErrorNotification('Chyba pri odhl√°sen√≠: ' + error.message);
        } finally {
            // Po odhl√°sen√≠ sa `onAuthStateChanged` postar√° o updateUI
        }
    };
    window.resetUserPassword = async function() {
        if (!navigator.onLine) { showErrorNotification('Ste offline. Obnova hesla je mo≈æn√° iba online.'); return; }
        const emailInput = document.getElementById('email'); const email = emailInput.value;
        if (!email) {
            emailInput.style.border = '1px solid red';
            showErrorNotification('Pros√≠m, zadajte v√°≈° email do poƒæa "Email" pre obnovu hesla.');
            setTimeout(() => { emailInput.style.border = ''; }, 3000); return;
        }
        emailInput.style.border = '';
        try {
            await sendPasswordResetEmail(auth, email);
            showSaveNotification(`Email na obnovu hesla bol odoslan√Ω na ${email}. Skontrolujte si po≈°tu (aj spam).`);
        } catch (error) {
            console.error('Chyba pri obnove hesla:', error);
            showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code));
        }
    };
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatn√Ω form√°t emailu.';
            case 'auth/user-disabled': return 'Tento √∫ƒçet bol deaktivovan√Ω.';
            case 'auth/user-not-found': return 'Pou≈æ√≠vateƒæ s t√Ωmto emailom nebol n√°jden√Ω.';
            case 'auth/wrong-password': return 'Nespr√°vne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je u≈æ zaregistrovan√Ω.';
            case 'auth/weak-password': return 'Heslo je pr√≠li≈° slab√© (min. 6 znakov).';
            case 'auth/requires-recent-login': return 'T√°to oper√°cia vy≈æaduje ned√°vne prihl√°senie. Odhl√°ste sa a prihl√°ste znova.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            case 'auth/too-many-requests': return 'Pr√≠li≈° veƒæa pokusov. Sk√∫ste nesk√¥r.';
            case 'auth/missing-email': return 'Pros√≠m, zadajte emailov√∫ adresu.';
            default: return `Nezn√°ma chyba (${errorCode}). Sk√∫ste znova.`;
        }
    }
    async function createUserCollection() {
        if (auth.currentUser) {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            try {
                await setDoc(userRef, { email: auth.currentUser.email, createdAt: new Date().toISOString() }, { merge: true });
                const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup');
                await setDoc(initialDocRef, { setupComplete: true, timestamp: new Date().toISOString() });
                console.log('User collection and initial workDays doc created for:', auth.currentUser.email);
            } catch (error) {
                console.error('Error creating user collection or initial document:', error);
                showErrorNotification('Nepodarilo sa inicializova≈• pou≈æ√≠vateƒæsk√© d√°ta v cloude.');
            }
        }
    }

    // --- Hlavn√° logika UI a D√°t ---
    function updateUI() {
        console.log("Updating UI for user:", currentUser ? currentUser.email : "None", `Month: ${currentMonth + 1}/${currentYear}`);
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');

        if (currentListenerUnsubscribe) {
            console.log("Detaching previous Firestore listener.");
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
        }

        createTable();

        if (currentUser) {
            loginForm.style.display = 'none';
            userInfo.style.display = 'block';
            userEmailSpan.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;

            if (navigator.onLine) {
                console.log(`Online: Attaching Firestore listener for user ${currentUser.uid}, month ${currentYear}-${currentMonth}`);
                const docId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', docId);

                currentListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    console.log(`Firestore snapshot received for ${docId}. Exists: ${docSnap.exists()}`);
                    const localKey = `workData-${currentUser.uid}-${currentYear}-${currentMonth}`;
                    if (docSnap.exists()) {
                        const firestoreData = docSnap.data();
                        const firestoreDataString = JSON.stringify(firestoreData);
                        if (firestoreDataString !== localStorage.getItem(localKey) || !docSnap.metadata.hasPendingWrites) {
                            console.log("Firestore data differs or is a server update. Applying to UI.");
                            localStorage.setItem(localKey, firestoreDataString);
                            parseAndApplyData(firestoreDataString);
                        } else {
                             console.log("Firestore data matches local data or is a local echo. No UI update from snapshot needed beyond total recalc.");
                             calculateTotal();
                        }
                    } else {
                        console.log(`Document ${docId} does not exist in Firestore. Clearing local data if exists.`);
                        if (localStorage.getItem(localKey)) {
                            localStorage.removeItem(localKey);
                        }
                        parseAndApplyData(null);
                    }
                }, (error) => {
                    console.error(`Firestore listener error for ${docId}:`, error);
                    showErrorNotification(`Chyba pri poƒç√∫van√≠ zmien z cloudu: ${error.message}. Zobrazujem lok√°lne d√°ta.`);
                    loadFromLocalStorageOnly();
                });
                syncWithFirebase();
            } else {
                console.log("User logged in but offline. Loading from localStorage only.");
                showWarningNotification('Ste offline. Zobrazuj√∫ sa lok√°lne ulo≈æen√© d√°ta. Zmeny sa synchronizuj√∫ po pripojen√≠.');
                loadFromLocalStorageOnly();
            }
        } else {
            loginForm.style.display = 'flex';
            userInfo.style.display = 'none';
            console.log("User not logged in. Loading from (generic) localStorage only.");
            loadFromLocalStorageOnly();
            if (!navigator.onLine) {
                showWarningNotification('Ste offline. Pre pr√≠stup k cloudov√Ωm d√°tam a funkci√°m sa prihl√°ste, keƒè budete online.');
            }
        }
        updateGreeting();
        updatePageTitle();
        updateLocalStorageSizeIndicator();
    }

    const debouncedSaveAndSync = debounce(() => {
        const data = collectCurrentDataForStorage();
        const localKey = getLocalStorageKey();
        localStorage.setItem(localKey, JSON.stringify(data));
        console.log("Data saved to localStorage due to input/change.");
        updateLocalStorageSizeIndicator();

        if (currentUser && navigator.onLine) {
            saveToFirestore(data);
        } else if (currentUser && !navigator.onLine) {
            localStorage.setItem(getPendingSyncKey(), JSON.stringify(data));
            console.log("Data marked for pending sync.");
        }
        calculateTotal();
    }, 1200);

    function getLocalStorageKey() {
        return currentUser
            ? `workData-${currentUser.uid}-${currentYear}-${currentMonth}`
            : `workData-guest-${currentYear}-${currentMonth}`;
    }
    function getPendingSyncKey() {
        return currentUser ? `pendingSync-${currentUser.uid}-${currentYear}-${currentMonth}` : null;
    }

    function collectCurrentDataForStorage() {
        const saveData = { data: [] };
        const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) {
            const start = document.getElementById(`start-${i}`)?.value || '';
            const end = document.getElementById(`end-${i}`)?.value || '';
            const breakTimeVal = document.getElementById(`break-${i}`)?.value || '';
            const note = document.getElementById(`note-${i}`)?.value || '';
            saveData.data.push({ start, end, breakTime: breakTimeVal, note });
        }
        saveData.employeeName = employeeName;
        saveData.hourlyWage = hourlyWage;
        saveData.taxRate = taxRate;
        saveData.decimalPlaces = decimalPlaces;
        saveData.defaultBreakTime = defaultBreakTime;
        saveData.lastUpdated = new Date().toISOString();
        return saveData;
    }

    async function saveToFirestore(dataToSave) {
        if (!currentUser || !navigator.onLine) {
            console.log("Cannot save to Firestore: User not logged in or offline.");
            return;
        }
        const docId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
        const docRef = doc(db, 'users', currentUser.uid, 'workDays', docId);
        console.log(`Attempting to save to Firestore: users/${currentUser.uid}/workDays/${docId}`);
        try {
            await setDoc(docRef, dataToSave, { merge: true });
            console.log(`Data successfully saved/merged to Firestore for ${docId}`);
            const pendingKey = getPendingSyncKey();
            if(pendingKey) localStorage.removeItem(pendingKey);
        } catch (error) {
            console.error('Error saving to Firestore:', error);
            showErrorNotification('Chyba pri ukladan√≠ d√°t do cloudu: ' + error.message);
            const pendingKey = getPendingSyncKey();
            if(pendingKey) localStorage.setItem(pendingKey, JSON.stringify(dataToSave));
        }
    }

    async function syncWithFirebase() {
        if (!currentUser || !navigator.onLine) return;
        const pendingKey = getPendingSyncKey();
        if (!pendingKey) return;

        const pendingDataString = localStorage.getItem(pendingKey);
        if (pendingDataString) {
            console.log('Found pending data, syncing with Firestore...');
            try {
                const dataToSync = JSON.parse(pendingDataString);
                dataToSync.lastUpdated = new Date().toISOString();
                await saveToFirestore(dataToSync);
                // Ak saveToFirestore uspeje, odstr√°ni pending flag (vo vn√∫tri saveToFirestore)
                showSaveNotification('Lok√°lne zmeny boli synchronizovan√© s cloudom.');
            } catch (error) {
                console.error('Error syncing pending data:', error);
                showErrorNotification('Chyba pri synchroniz√°cii lok√°lnych zmien: ' + error.message);
            }
        } else {
            console.log('No pending data to sync.');
        }
    }

    window.loadFromFirestore = async function() {
        const btn = event.target;
        setLoadingState(btn, true, "Naƒç√≠tavam...");
        if (!currentUser) { showErrorNotification('Pre naƒç√≠tanie z Firebase sa mus√≠te prihl√°si≈•.'); setLoadingState(btn, false, "Naƒç√≠ta≈• z cloudu"); return; }
        if (!navigator.onLine) { showErrorNotification('Ste offline. Naƒç√≠tanie z Firebase vy≈æaduje internet.'); setLoadingState(btn, false, "Naƒç√≠ta≈• z cloudu"); return; }

        if (!confirm('Naozaj chcete manu√°lne naƒç√≠ta≈• d√°ta z cloudu? Prep√≠≈°u sa t√Ωm aktu√°lne lok√°lne d√°ta pre tento mesiac.')) {
            setLoadingState(btn, false, "Naƒç√≠ta≈• z cloudu"); return;
        }
        console.log(`Manual load from Firestore initiated for ${currentYear}-${currentMonth}`);
        const docId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
        const docRef = doc(db, 'users', currentUser.uid, 'workDays', docId);
        try {
            const docSnap = await getDoc(docRef);
            const localKey = getLocalStorageKey();
            if (docSnap.exists()) {
                const storedData = docSnap.data();
                const dataString = JSON.stringify(storedData);
                localStorage.setItem(localKey, dataString);
                const pendingKey = getPendingSyncKey();
                if(pendingKey) localStorage.removeItem(pendingKey);
                parseAndApplyData(dataString);
                showSaveNotification('D√°ta boli √∫spe≈°ne naƒç√≠tan√© z cloudu.');
            } else {
                localStorage.removeItem(localKey);
                const pendingKey = getPendingSyncKey();
                if(pendingKey) localStorage.removeItem(pendingKey);
                parseAndApplyData(null);
                showWarningNotification('Pre tento mesiac neboli v cloude n√°jden√© ≈æiadne d√°ta.');
            }
        } catch (error) {
            console.error('Chyba pri manu√°lnom naƒç√≠tavan√≠ z Firestore:', error);
            showErrorNotification('Chyba pri naƒç√≠tavan√≠ d√°t z cloudu: ' + error.message);
        } finally {
            setLoadingState(btn, false, "Naƒç√≠ta≈• z cloudu");
        }
    };

    function loadFromLocalStorageOnly() {
        const localKey = getLocalStorageKey();
        const localData = localStorage.getItem(localKey);
        console.log(`Loading from localStorage only for key: ${localKey}. Data found: ${!!localData}`);
        parseAndApplyData(localData);
    }

    function parseAndApplyData(dataString) {
        employeeName = localStorage.getItem('employeeName') || '';
        hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
        decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        defaultBreakTime = parseFloat(localStorage.getItem('defaultBreakTime')) || 0.5;

        if (dataString) {
            try {
                const storedData = JSON.parse(dataString);
                console.log("Parsing and applying data from source (LS or FS):", storedData);
                if (storedData.employeeName !== undefined) employeeName = storedData.employeeName;
                if (storedData.hourlyWage !== undefined) hourlyWage = parseFloat(storedData.hourlyWage);
                if (storedData.taxRate !== undefined) taxRate = parseFloat(storedData.taxRate);
                if (storedData.decimalPlaces !== undefined) decimalPlaces = parseInt(storedData.decimalPlaces);
                if (storedData.defaultBreakTime !== undefined) defaultBreakTime = parseFloat(storedData.defaultBreakTime);

                employeeNameInput.value = employeeName;
                hourlyWageInput.value = hourlyWage.toFixed(1);
                taxRateInput.value = (taxRate * 100).toFixed(1);
                decimalPlacesSelect.value = decimalPlaces;
                defaultBreakInput.value = defaultBreakTime.toFixed(1);

                if (storedData.data && Array.isArray(storedData.data)) {
                    const daysInTable = getDaysInMonth(currentMonth, currentYear);
                    storedData.data.slice(0, daysInTable).forEach((dayData, index) => {
                        const dayNum = index + 1;
                        const startEl = document.getElementById(`start-${dayNum}`);
                        const endEl = document.getElementById(`end-${dayNum}`);
                        const breakEl = document.getElementById(`break-${dayNum}`);
                        const noteEl = document.getElementById(`note-${dayNum}`);

                        if (startEl && endEl && breakEl && noteEl) {
                            startEl.value = dayData.start || '';
                            endEl.value = dayData.end || '';
                            breakEl.value = dayData.breakTime || '';
                            noteEl.value = dayData.note || '';
                            autoResizeTextarea(noteEl);
                            calculateRow(dayNum);
                        }
                    });
                }
            } catch (error) {
                console.error('Chyba pri parsovan√≠ alebo aplikovan√≠ d√°t:', error, "Data string:", dataString);
                showErrorNotification('Chyba pri spracovan√≠ ulo≈æen√Ωch d√°t: ' + error.message + '. Obnovujem predvolen√©.');
                resetTableInputsAndSettingsToDefault();
            }
        } else {
            console.log("No data string provided to parseAndApplyData. Resetting table and settings inputs.");
            resetTableInputsAndSettingsToDefault();
        }
        updateGreeting();
        calculateTotal();
    }

    function resetTableInputsAndSettingsToDefault() {
        const daysInTable = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= daysInTable; i++) {
            const startEl = document.getElementById(`start-${i}`);
            if (startEl) startEl.value = '';
            const endEl = document.getElementById(`end-${i}`);
            if (endEl) endEl.value = '';
            const breakEl = document.getElementById(`break-${i}`);
            if (breakEl) breakEl.value = '';
            const noteEl = document.getElementById(`note-${i}`);
            if (noteEl) { noteEl.value = ''; autoResizeTextarea(noteEl); }
            calculateRow(i);
        }
        employeeNameInput.value = localStorage.getItem('employeeName') || '';
        hourlyWageInput.value = (parseFloat(localStorage.getItem('hourlyWage')) || 10).toFixed(1);
        taxRateInput.value = ((parseFloat(localStorage.getItem('taxRate')) || 0.02) * 100).toFixed(1);
        decimalPlacesSelect.value = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        defaultBreakInput.value = (parseFloat(localStorage.getItem('defaultBreakTime')) || 0.5).toFixed(1);
    }

    // --- Tabuƒæka a V√Ωpoƒçty ---
    function createTable() {
        workDaysTbody.innerHTML = '';
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();
        const days = getDaysInMonth(currentMonth, currentYear);

        for (let i = 1; i <= days; i++) {
            const row = workDaysTbody.insertRow();
            const dayStr = String(i);
            const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
            if (isCurrentDay) row.classList.add('current-day');
            if (isWeekend(currentYear, currentMonth, i)) row.classList.add('weekend-day');

            const dayName = getDayName(currentYear, currentMonth, i);

            row.innerHTML = `
                <td>${i}. ${dayName} ${isCurrentDay ? '<span>‚≠ê</span>': ''}</td>
                <td>
                    <div class="time-input-wrapper">
                        <input type="tel" id="start-${dayStr}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" aria-label="Pr√≠chod d≈àa ${dayStr}" oninput="handleTimeInput(this, 'end-${dayStr}', ${dayStr})">
                        <button class="time-btn" onclick="setCurrentTime('start-${dayStr}', ${dayStr})" title="Zada≈• aktu√°lny ƒças" aria-label="Zada≈• aktu√°lny ƒças pre pr√≠chod d≈àa ${dayStr}">üïí</button>
                    </div>
                </td>
                <td>
                    <div class="time-input-wrapper">
                        <input type="tel" id="end-${dayStr}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" aria-label="Odchod d≈àa ${dayStr}" oninput="handleTimeInput(this, 'break-${dayStr}', ${dayStr})">
                        <button class="time-btn" onclick="setCurrentTime('end-${dayStr}', ${dayStr})" title="Zada≈• aktu√°lny ƒças" aria-label="Zada≈• aktu√°lny ƒças pre odchod d≈àa ${dayStr}">üïí</button>
                    </div>
                </td>
                <td><input type="number" id="break-${dayStr}" min="0" step="0.1" placeholder="hod." aria-label="Prest√°vka d≈àa ${dayStr}" oninput="handleBreakInput(${dayStr})"></td>
                <td id="total-${dayStr}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
                <td><textarea id="note-${dayStr}" placeholder="Pozn√°mka..." aria-label="Pozn√°mka ku d≈àu ${dayStr}" oninput="handleNoteInput(this)" rows="1"></textarea></td>
                <td><input type="number" id="gross-${dayStr}" readonly aria-label="Hrub√° mzda d≈àa ${dayStr}"></td>
                <td><input type="number" id="net-${dayStr}" readonly aria-label="ƒåist√° mzda d≈àa ${dayStr}"></td>
                <td>
                    <div style="display: flex; align-items: center; justify-content: space-around;">
                        ${i > 1 ? `<button class="copy-day-btn" onclick="copyPreviousDayData(${dayStr})" title="Kop√≠rova≈• z predch. d≈àa" aria-label="Kop√≠rova≈• d√°ta z predch√°dzaj√∫ceho d≈àa do d≈àa ${dayStr}">üìã</button>` : ''}
                        <button class="btn reset-btn" onclick="resetRow(${dayStr})" aria-label="Resetova≈• de≈à ${dayStr}">X</button>
                    </div>
                </td>
            `;
        }
    }

    window.setCurrentTime = function(inputId, day) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const targetInput = document.getElementById(inputId);
        if (targetInput) {
            targetInput.value = `${hours}:${minutes}`;
            targetInput.dispatchEvent(new Event('input'));
        }
    }

    window.handleTimeInput = function(input, nextId, day) {
        formatTimeAndMoveNext(input, nextId);
        checkAndApplyDefaultBreak(day);
        calculateRow(day);
        debouncedSaveAndSync();
    }
    window.handleBreakInput = function(day) {
        calculateRow(day);
        debouncedSaveAndSync();
    }
    window.handleNoteInput = function(textarea) {
        autoResizeTextarea(textarea);
        debouncedSaveAndSync();
    }

    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    function isValidTimeFormat(timeString) {
        if (!timeString) return false;
        return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString);
    }

    // ----- FUNKCIA formatTimeAndMoveNext -----
    function formatTimeAndMoveNext(input, nextId) {
        const rawValue = input.value;
        const selectionStartOriginal = input.selectionStart;

        let digits = rawValue.replace(/[^\d]/g, '');

        let formattedValue = "";
        let newCursorPos = 0;

        if (digits.length === 0) {
            formattedValue = "";
            newCursorPos = 0;
        } else if (digits.length === 1) {
            formattedValue = digits;
            newCursorPos = 1;
        } else if (digits.length === 2) {
            formattedValue = digits;
            newCursorPos = 2;
        } else if (digits.length === 3) {
            formattedValue = digits.substring(0, 2) + ':' + digits.substring(2);
            newCursorPos = formattedValue.length;
        } else {
            digits = digits.substring(0, 4);
            formattedValue = digits.substring(0, 2) + ':' + digits.substring(2, 4);
            newCursorPos = formattedValue.length;
        }

        if (input.value !== formattedValue) {
            input.value = formattedValue;
        }

        if (rawValue.length > 5 && formattedValue.length === 5) {
            newCursorPos = 5;
        }
        try {
            input.setSelectionRange(newCursorPos, newCursorPos);
        } catch (e) { /* V pr√≠pade chyby (napr. input nie je focusnut√Ω), nerob niƒç */ }

        if (formattedValue.length === 5 && isValidTimeFormat(formattedValue)) {
            const justCompleted = (rawValue !== formattedValue && rawValue.length <= 5) ||
                                  (rawValue.length < 5 && selectionStartOriginal === rawValue.length && digits.length >=4) ||
                                  (digits.length === 4 && rawValue.length === 4);

            if (justCompleted) {
                const nextElement = document.getElementById(nextId);
                if (nextElement) {
                    nextElement.focus();
                    if (nextElement.type !== 'number' && typeof nextElement.select === 'function') {
                        nextElement.select();
                    }
                }
            }
        }
    }
    // ----- KONIEC FUNKCIE formatTimeAndMoveNext -----

    function checkAndApplyDefaultBreak(day) {
        const startInput = document.getElementById(`start-${day}`);
        const endInput = document.getElementById(`end-${day}`);
        const breakInput = document.getElementById(`break-${day}`);

        if (startInput && endInput && breakInput &&
            isValidTimeFormat(startInput.value) && isValidTimeFormat(endInput.value) &&
            (breakInput.value === '' || parseFloat(breakInput.value) === 0) &&
            defaultBreakTime > 0) {
            breakInput.value = defaultBreakTime.toFixed(1);
        }
    }

    function calculateRow(day) {
        const startTimeInput = document.getElementById(`start-${day}`);
        const endTimeInput = document.getElementById(`end-${day}`);
        const breakTimeInput = document.getElementById(`break-${day}`);
        const totalCell = document.getElementById(`total-${day}`);
        const grossInput = document.getElementById(`gross-${day}`);
        const netInput = document.getElementById(`net-${day}`);

        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) {
            console.warn(`Missing element for row ${day} in calculateRow`); return;
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const breakTimeHours = parseFloat(breakTimeInput.value.replace(',', '.')) || 0;

        if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
            grossInput.value = (0).toFixed(decimalPlaces);
            netInput.value = (0).toFixed(decimalPlaces);
            startTimeInput.style.borderColor = ''; endTimeInput.style.borderColor = '';
            return;
        }

        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);
        let startDate = new Date(2000, 0, 1, startHours, startMinutes);
        let endDate = new Date(2000, 0, 1, endHours, endMinutes);

        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }
        startTimeInput.style.borderColor = '';
        endTimeInput.style.borderColor = '';

        let diffMillis = endDate.getTime() - startDate.getTime();
        let totalWorkMinutes = diffMillis / (1000 * 60);
        totalWorkMinutes -= (breakTimeHours * 60);
        if (totalWorkMinutes < 0) totalWorkMinutes = 0;

        const decimalHours = totalWorkMinutes / 60;
        const hoursPart = Math.floor(totalWorkMinutes / 60);
        const minutesPart = Math.round(totalWorkMinutes % 60);

        totalCell.textContent = `${hoursPart}h ${minutesPart}m (${decimalHours.toFixed(decimalPlaces)} h)`;
        const grossSalary = decimalHours * hourlyWage;
        grossInput.value = Math.max(0, grossSalary).toFixed(decimalPlaces);
        const netSalary = grossSalary * (1 - taxRate);
        netInput.value = Math.max(0, netSalary).toFixed(decimalPlaces);
    }

    window.resetRow = function(day) {
        if (!confirm(`Naozaj chcete vymaza≈• z√°znam pre ${day}. de≈à?`)) return;
        const dayStr = String(day);
        document.getElementById(`start-${dayStr}`).value = '';
        document.getElementById(`end-${dayStr}`).value = '';
        document.getElementById(`break-${dayStr}`).value = '';
        const noteEl = document.getElementById(`note-${dayStr}`);
        noteEl.value = '';
        autoResizeTextarea(noteEl);
        calculateRow(day);
        debouncedSaveAndSync();
        showSaveNotification(`Z√°znam pre ${day}. de≈à bol vymazan√Ω.`);
    }

    window.copyPreviousDayData = function(currentDay) {
        if (currentDay <= 1) return;
        const prevDay = currentDay - 1;
        const prevStart = document.getElementById(`start-${prevDay}`)?.value || '';
        const prevEnd = document.getElementById(`end-${prevDay}`)?.value || '';
        const prevBreak = document.getElementById(`break-${prevDay}`)?.value || '';
        const prevNote = document.getElementById(`note-${prevDay}`)?.value || '';

        if (!prevStart && !prevEnd && !prevBreak && !prevNote) {
            showWarningNotification(`Predch√°dzaj√∫ci de≈à (${prevDay}.) neobsahuje ≈æiadne d√°ta na kop√≠rovanie.`);
            return;
        }
        if (!confirm(`Naozaj chcete skop√≠rova≈• d√°ta z ${prevDay}. d≈àa do ${currentDay}. d≈àa? Existuj√∫ce d√°ta v ${currentDay}. dni bud√∫ prep√≠san√©.`)) return;

        document.getElementById(`start-${currentDay}`).value = prevStart;
        document.getElementById(`end-${currentDay}`).value = prevEnd;
        document.getElementById(`break-${currentDay}`).value = prevBreak;
        const noteEl = document.getElementById(`note-${currentDay}`);
        noteEl.value = prevNote;
        autoResizeTextarea(noteEl);
        calculateRow(currentDay);
        debouncedSaveAndSync();
        showSaveNotification(`D√°ta z ${prevDay}. d≈àa boli skop√≠rovan√© do ${currentDay}. d≈àa.`);
    }

    window.clearMonthData = async function() {
        const btn = event.target;
        if (!confirm(`Naozaj chcete vymaza≈• V≈†ETKY d√°ta pre mesiac ${MONTH_NAMES[currentMonth]} ${currentYear}? T√°to akcia je nezvratn√° pre lok√°lne d√°ta. Ak ste prihl√°sen√Ω, d√°ta bud√∫ vymazan√© aj z cloudu.`)) return;
        setLoadingState(btn, true, "Mazanie...");

        const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) {
            document.getElementById(`start-${i}`).value = '';
            document.getElementById(`end-${i}`).value = '';
            document.getElementById(`break-${i}`).value = '';
            const noteEl = document.getElementById(`note-${i}`);
            noteEl.value = '';
            autoResizeTextarea(noteEl);
            calculateRow(i);
        }
        calculateTotal();

        const emptyData = collectCurrentDataForStorage();
        const localKey = getLocalStorageKey();
        localStorage.setItem(localKey, JSON.stringify(emptyData));
        updateLocalStorageSizeIndicator();

        if (currentUser && navigator.onLine) {
            const docId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const docRef = doc(db, 'users', currentUser.uid, 'workDays', docId);
            try {
                await setDoc(docRef, emptyData, { merge: false });
                console.log(`Data for month ${docId} cleared in Firestore.`);
                const pendingKey = getPendingSyncKey();
                if(pendingKey) localStorage.removeItem(pendingKey);
            } catch (error) {
                console.error(`Error clearing month data in Firestore for ${docId}:`, error);
                showErrorNotification('Chyba pri mazan√≠ d√°t v cloude: ' + error.message);
                const pendingKey = getPendingSyncKey();
                if(pendingKey) localStorage.setItem(pendingKey, JSON.stringify(emptyData));
            }
        } else if (currentUser && !navigator.onLine) {
             const pendingKey = getPendingSyncKey();
             if(pendingKey) localStorage.setItem(pendingKey, JSON.stringify(emptyData));
        }
        showSaveNotification(`V≈°etky d√°ta pre ${MONTH_NAMES[currentMonth]} ${currentYear} boli vymazan√©.`);
        setLoadingState(btn, false, "Vymaza≈• mesiac");
    }

    function calculateTotal() {
        console.log("Calculating totals...");
        let totalWorkMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithEntries = 0;
        const days = getDaysInMonth(currentMonth, currentYear);

        for (let i = 1; i <= days; i++) {
            const startTime = document.getElementById(`start-${i}`)?.value;
            const endTime = document.getElementById(`end-${i}`)?.value;
            const breakTimeStr = document.getElementById(`break-${i}`)?.value;
            const noteValue = document.getElementById(`note-${i}`)?.value || "";

            let dayWorkMinutes = 0;
            if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                const [sH, sM] = startTime.split(':').map(Number);
                const [eH, eM] = endTime.split(':').map(Number);
                let sDate = new Date(2000,0,1,sH,sM);
                let eDate = new Date(2000,0,1,eH,eM);
                if (eDate < sDate) eDate.setDate(eDate.getDate() + 1);

                let diffMillis = eDate.getTime() - sDate.getTime();
                dayWorkMinutes = diffMillis / (1000 * 60);
                const breakHours = parseFloat(breakTimeStr?.replace(',', '.')) || 0;
                dayWorkMinutes -= (breakHours * 60);
                if (dayWorkMinutes < 0) dayWorkMinutes = 0;
            }

            const grossSalary = parseFloat(document.getElementById(`gross-${i}`)?.value) || 0;
            const netSalary = parseFloat(document.getElementById(`net-${i}`)?.value) || 0;

            if (dayWorkMinutes > 0 || (grossSalary > 0) || noteValue.trim() !== "") {
                daysWithEntries++;
            }
            totalWorkMinutes += dayWorkMinutes;
            totalGrossSalary += grossSalary;
            totalNetSalary += netSalary;
        }

        const totalHoursPart = Math.floor(totalWorkMinutes / 60);
        const totalMinutesPart = Math.round(totalWorkMinutes % 60);
        const totalDecimalHours = totalWorkMinutes / 60;

        const avgNetSalary = daysWithEntries > 0 ? totalNetSalary / daysWithEntries : 0;
        const avgWorkMinutes = daysWithEntries > 0 ? totalWorkMinutes / daysWithEntries : 0;
        const avgHoursPart = Math.floor(avgWorkMinutes / 60);
        const avgMinutesPart = Math.round(avgWorkMinutes % 60);
        const avgDecimalHours = avgWorkMinutes / 60;

        totalSalaryDiv.innerHTML = `
            Zapoƒç√≠tan√Ωch dn√≠: <strong>${daysWithEntries}</strong><br>
            Celkov√Ω ƒças: <strong>${totalHoursPart}h ${totalMinutesPart}m</strong> (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>
            Hrub√° mzda: <strong>${totalGrossSalary.toFixed(decimalPlaces)} ‚Ç¨</strong><br>
            ƒåist√° mzda: <strong>${totalNetSalary.toFixed(decimalPlaces)} ‚Ç¨</strong><br>
            Priem. ƒçist√° mzda/de≈à: ${avgNetSalary.toFixed(decimalPlaces)} ‚Ç¨<br>
            Priem. ƒças/de≈à: ${avgHoursPart}h ${avgMinutesPart}m (${avgDecimalHours.toFixed(decimalPlaces)} h)
        `;
    }

    // --- Exporty a Z√°lohy ---
    window.exportToPDF = async function() {
        const btn = event.target;
        setLoadingState(btn, true, "Exportujem PDF...");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        try {
            try {
                doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
                doc.setFont('Roboto');
            } catch (e) { console.warn("Roboto font not found for PDF, using helvetica."); doc.setFont('helvetica'); }

            doc.setFontSize(16);
            doc.text(`V√Ωkaz pr√°ce - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
            doc.setFontSize(12);
            doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30);
            doc.setFontSize(10);
            doc.text(`Hodinov√° mzda: ${hourlyWage.toFixed(decimalPlaces)} ‚Ç¨/h, Da≈à: ${(taxRate * 100).toFixed(1)}%`, 14, 36);

            const tableData = [];
            const days = getDaysInMonth(currentMonth, currentYear);
            for (let i = 1; i <= days; i++) {
                const dayName = getDayName(currentYear, currentMonth, i);
                const startTime = document.getElementById(`start-${i}`)?.value || '';
                const endTime = document.getElementById(`end-${i}`)?.value || '';
                const breakTime = document.getElementById(`break-${i}`)?.value || '';
                const note = document.getElementById(`note-${i}`)?.value || '';
                const totalTimeText = document.getElementById(`total-${i}`)?.textContent.trim() || '';
                const grossSalary = parseFloat(document.getElementById(`gross-${i}`)?.value || '0').toFixed(decimalPlaces);
                const netSalary = parseFloat(document.getElementById(`net-${i}`)?.value || '0').toFixed(decimalPlaces);

                if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) || note.trim() !== "") {
                    tableData.push([
                        `${i}. ${dayName}`, startTime, endTime, breakTime || '0',
                        totalTimeText, note, `${grossSalary} ‚Ç¨`, `${netSalary} ‚Ç¨`
                    ]);
                }
            }

            doc.autoTable({
                head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka (h)', 'Odpracovan√©', 'Pozn√°mka', 'Hrub√° Mzda', 'ƒåist√° Mzda']],
                body: tableData,
                startY: 42,
                theme: 'grid',
                styles: { font: doc.getFont().fontName || 'helvetica', fontSize: 8, cellPadding: 1.5, valign: 'middle' },
                headStyles: { fillColor: [220, 220, 220], textColor: [0,0,0], fontStyle: 'bold', fontSize: 8.5, halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 18, halign: 'left' }, 1: { cellWidth: 13, halign: 'center' },
                    2: { cellWidth: 13, halign: 'center' }, 3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 22, halign: 'center' }, 5: { cellWidth: 'auto', halign: 'left' },
                    6: { cellWidth: 18, halign: 'right' }, 7: { cellWidth: 18, halign: 'right' }
                },
                didParseCell: (data) => {
                    if (data.column.index === 5) data.cell.styles.cellWidth = 'wrap';
                }
            });

            const totalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            const totalTextContent = totalSalaryDiv.innerHTML
                .replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/gi, '')
                .replace(/ /g, ' ').replace(/‚Ç¨/g, 'EUR'); // Pou≈æ√≠vam nbsp (non-breaking space)
            doc.text(totalTextContent, 14, totalY);

            const safeEmployeeName = (employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
            doc.save(`Vykaz_prace_${safeEmployeeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`);
            showSaveNotification('PDF s√∫bor bol √∫spe≈°ne vygenerovan√Ω.');
        } catch (error) {
            console.error("Error exporting to PDF:", error);
            showErrorNotification("Chyba pri exporte do PDF: " + error.message);
        } finally {
            setLoadingState(btn, false, "Exportova≈• do PDF");
        }
    }

    window.sendPDF = async function() {
        const btn = event.target;
        setLoadingState(btn, true, "Pripravujem PDF...");

        calculateTotal(); // <<< Explicitn√© volanie pre aktu√°lnos≈• totalSalaryDiv

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        try {
            try {
                doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
                doc.setFont('Roboto');
            } catch (e) {
                console.warn("Roboto font not found for PDF, using helvetica.");
                doc.setFont('helvetica', 'normal');
            }

            doc.setFontSize(16);
            doc.text(`Z√°znam doch√°dzky - ${MONTH_NAMES[currentMonth]} ${currentYear}`, 14, 22);
            doc.setFontSize(12);
            doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30);

            // Z√≠skanie poƒçtu odpracovan√Ωch dn√≠ z totalSalaryDiv
            let workedDaysCount = 0;
            const totalSalaryText = totalSalaryDiv.textContent || "";
            const workedDaysMatch = totalSalaryText.match(/Zapoƒç√≠tan√Ωch dn√≠:\s*(\d+)/i);
            
            // DEBUG: V√Ωpisy do konzoly na overenie hodn√¥t
            console.log("DEBUG sendPDF - totalSalaryText:", totalSalaryText);
            console.log("DEBUG sendPDF - workedDaysMatch:", workedDaysMatch);

            if (workedDaysMatch && workedDaysMatch[1]) {
                workedDaysCount = parseInt(workedDaysMatch[1]);
            }
            console.log("DEBUG sendPDF - workedDaysCount:", workedDaysCount); // DEBUG

            // Zobrazenie poƒçtu odpracovan√Ωch dn√≠
            doc.setFontSize(10);
            doc.text(`Celkov√Ω poƒçet odpracovan√Ωch dn√≠: ${workedDaysCount}`, 14, 36);

            const tableData = [];
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);

            for (let i = 1; i <= daysInMonth; i++) {
                const dayName = getDayName(currentYear, currentMonth, i);
                const startTime = document.getElementById(`start-${i}`)?.value || '';
                const endTime = document.getElementById(`end-${i}`)?.value || '';
                const breakTime = document.getElementById(`break-${i}`)?.value || '';
                const note = document.getElementById(`note-${i}`)?.value || '';

                if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) || note.trim() !== "") {
                    tableData.push([`${i}. ${dayName}`, startTime, endTime, breakTime || '0', note]);
                }
            }

            doc.autoTable({
                head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka (h)', 'Pozn√°mka']],
                body: tableData,
                startY: 42, 
                theme: 'grid',
                styles: { font: doc.getFont().fontName || 'helvetica', fontSize: 9, cellPadding: 2, valign: 'middle' },
                headStyles: { fillColor: [220,220,220], textColor: [0,0,0], fontStyle: 'bold', fontSize: 10, halign: 'center'},
                columnStyles: {
                    0: { cellWidth: 30 }, 
                    1: { cellWidth: 25, halign: 'center' }, 
                    2: { cellWidth: 25, halign: 'center' }, 
                    3: { cellWidth: 25, halign: 'center' }, 
                    4: { cellWidth: 'auto' } 
                },
                didParseCell: (data) => {
                    if (data.column.index === 4) {
                        data.cell.styles.cellWidth = 'wrap';
                    }
                }
            });

            try {
                const pdfBlob = doc.output('blob');
                const safeEmployeeName = (employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                const pdfFileName = `Dochadzka_${safeEmployeeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.pdf`;
                const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    await navigator.share({
                        files: [pdfFile],
                        title: `Doch√°dzka ${MONTH_NAMES[currentMonth]} ${currentYear}`,
                        text: `Z√°znam doch√°dzky pre ${employeeName || 'pracovn√≠ka'} za ${MONTH_NAMES[currentMonth]} ${currentYear} (s pozn√°mkami).`
                    });
                    console.log('PDF (doch√°dzka s pozn.) zdieƒæan√©.');
                } else {
                    showWarningNotification('Zdieƒæanie s√∫borov nie je podporovan√© vo va≈°om prehliadaƒçi. S√∫bor sa stiahne.');
                    doc.save(pdfFileName);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Chyba zdieƒæania alebo generovania PDF:', error);
                    showErrorNotification('Chyba pri pr√≠prave alebo zdieƒæan√≠ PDF: ' + error.message);
                } else {
                    console.log('Zdieƒæanie PDF zru≈°en√© pou≈æ√≠vateƒæom.');
                }
            }
        } catch (error) {
            console.error("Error generating PDF for sending:", error);
            showErrorNotification("Chyba pri generovan√≠ PDF na odoslanie: " + error.message);
        }
        finally {
            setLoadingState(btn, false, "Odosla≈• PDF (s pozn.)");
        }
    }


    window.createBackup = function() {
        const btn = event.target;
        setLoadingState(btn, true, "Vytv√°ram z√°lohu...");
        const backupData = collectCurrentDataForStorage();
        const key = getLocalStorageKey();

        if (localStorage.getItem(key) || backupData.data.some(d => d.start || d.end || d.breakTime || d.note)) {
            try {
                const ws_data = [["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka"]];
                if (backupData.data && Array.isArray(backupData.data)) {
                    const days = getDaysInMonth(currentMonth, currentYear);
                    backupData.data.slice(0, days).forEach((row, index) => {
                        const dayNum = index + 1;
                        const dayName = getDayName(currentYear, currentMonth, dayNum);
                        ws_data.push([`${dayNum}. ${dayName}`, row.start || "", row.end || "", row.breakTime || "", row.note || ""]);
                    });
                }
                ws_data.push([]);
                ws_data.push(["Nastavenie", "Hodnota"]);
                ws_data.push(["Meno pracovn√≠ka", backupData.employeeName]);
                ws_data.push(["Hodinov√° mzda (‚Ç¨)", backupData.hourlyWage]);
                ws_data.push(["Da≈àov√© percento (%)", (backupData.taxRate * 100).toFixed(1)]);
                ws_data.push(["Predvolen√° prest√°vka (h)", backupData.defaultBreakTime.toFixed(1)]);
                ws_data.push(["Poƒçet des. miest", backupData.decimalPlaces]);
                ws_data.push(["Mesiac (index)", currentMonth]);
                ws_data.push(["Rok", currentYear]);
                ws_data.push(["Posledn√° aktualiz√°cia", backupData.lastUpdated ? new Date(backupData.lastUpdated).toLocaleString('sk-SK') : "Nezn√°ma"]);

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!cols'] = [ {wch:15}, {wch:10}, {wch:10}, {wch:15}, {wch:40}, {wch:25}, {wch:15} ];
                XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${MONTH_NAMES[currentMonth]} ${currentYear}`);
                const safeEmployeeName = (employeeName || 'Pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                XLSX.writeFile(wb, `Zaloha_BrunoCalc_${safeEmployeeName}_${MONTH_NAMES[currentMonth]}_${currentYear}.xlsx`);
                showSaveNotification('Z√°loha bola √∫spe≈°ne vytvoren√°.');
            } catch(error) {
                console.error('Chyba pri vytv√°ran√≠ z√°lohy:', error);
                showErrorNotification('Chyba pri vytv√°ran√≠ z√°lohy: ' + error.message);
            }
        } else {
            showWarningNotification('Nie s√∫ dostupn√© ≈æiadne d√°ta na z√°lohu pre tento mesiac.');
        }
        setLoadingState(btn, false, "Vytvori≈• z√°lohu XLSX");
    };
    window.restoreBackup = function() {
        const btn = event.target;
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        input.onchange = function(event) {
            setLoadingState(btn, true, "Sprac√∫vam s√∫bor...");
            const file = event.target.files[0];
            if (!file) { setLoadingState(btn, false, "Obnovi≈• z√°lohu z XLSX"); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileData = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(fileData, { type: 'array', cellDates: true, cellNF: false, cellText:true });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });

                    const restoredData = { data: [] };
                    let settingsParsed = {};
                    let dataReadingMode = false;

                    const headerRowIndex = jsonData.findIndex(row => row && row[0] && row[0].toString().toLowerCase().includes("de≈à"));
                    if (headerRowIndex === -1) throw new Error("Hlaviƒçka tabuƒæky ('De≈à') nebola n√°jden√° v s√∫bore.");

                    const header = jsonData[headerRowIndex].map(h => h.toString().toLowerCase());
                    const colMap = {
                        day: header.indexOf("de≈à"),
                        start: header.indexOf("pr√≠chod"),
                        end: header.indexOf("odchod"),
                        break: header.indexOf("prest√°vka (h)"),
                        note: header.indexOf("pozn√°mka")
                    };
                    if (colMap.day === -1 || colMap.start === -1 || colMap.end === -1 || colMap.break === -1) {
                        throw new Error("Ch√Ωbaj√∫ povinn√© stƒ∫pce v hlaviƒçke: De≈à, Pr√≠chod, Odchod, Prest√°vka (h).");
                    }

                    for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || !row[colMap.day] || !row[colMap.day].toString().match(/^\d+\./)) {
                            dataReadingMode = false;
                            if(row && row[0] && row[0].toString().toLowerCase() === "nastavenie") i++;
                        }
                        if (dataReadingMode || (row && row[colMap.day] && row[colMap.day].toString().match(/^\d+\./))) {
                            dataReadingMode = true;
                            restoredData.data.push({
                                start: row[colMap.start] || "",
                                end: row[colMap.end] || "",
                                breakTime: row[colMap.break] ? row[colMap.break].toString().replace(',', '.') : "",
                                note: colMap.note !== -1 ? (row[colMap.note] || "") : ""
                            });
                            continue;
                        }

                        if (!dataReadingMode && row && row[0] && row[1] !== undefined) {
                            const key = row[0].toString().toLowerCase().trim();
                            const value = row[1].toString().trim();
                            if (key.includes("meno pracovn√≠ka")) settingsParsed.employeeName = value;
                            else if (key.includes("hodinov√° mzda")) settingsParsed.hourlyWage = parseFloat(value.replace('‚Ç¨','').replace(',','.'));
                            else if (key.includes("da≈àov√© percento")) settingsParsed.taxRate = parseFloat(value.replace('%','').replace(',','.')) / 100;
                            else if (key.includes("predvolen√° prest√°vka")) settingsParsed.defaultBreakTime = parseFloat(value.replace(',','.'));
                            else if (key.includes("poƒçet des. miest")) settingsParsed.decimalPlaces = parseInt(value);
                            else if (key.includes("mesiac (index)") && !isNaN(parseInt(value))) settingsParsed.month = parseInt(value);
                            else if (key.includes("rok") && !isNaN(parseInt(value))) settingsParsed.year = parseInt(value);
                        }
                    }

                    if (settingsParsed.month !== undefined && settingsParsed.year !== undefined) {
                        if (settingsParsed.month !== currentMonth || settingsParsed.year !== currentYear) {
                            if (!confirm(`Z√°loha je pre ${MONTH_NAMES[settingsParsed.month]} ${settingsParsed.year}. Chcete prepn√∫≈• na tento mesiac a naƒç√≠ta≈• d√°ta?`)) {
                                setLoadingState(btn, false, "Obnovi≈• z√°lohu z XLSX"); return;
                            }
                            currentMonth = settingsParsed.month;
                            currentYear = settingsParsed.year;
                            monthSelect.value = currentMonth;
                            yearSelect.value = currentYear;
                        }
                    }

                    const finalData = {
                        data: restoredData.data,
                        employeeName: settingsParsed.employeeName !== undefined ? settingsParsed.employeeName : employeeName,
                        hourlyWage: settingsParsed.hourlyWage !== undefined ? settingsParsed.hourlyWage : hourlyWage,
                        taxRate: settingsParsed.taxRate !== undefined ? settingsParsed.taxRate : taxRate,
                        decimalPlaces: settingsParsed.decimalPlaces !== undefined ? settingsParsed.decimalPlaces : decimalPlaces,
                        defaultBreakTime: settingsParsed.defaultBreakTime !== undefined ? settingsParsed.defaultBreakTime : defaultBreakTime,
                        lastUpdated: new Date().toISOString()
                    };

                    if (!confirm(`Naƒç√≠tan√° z√°loha obsahuje ${finalData.data.length} dn√≠ pre ${MONTH_NAMES[currentMonth]} ${currentYear}. Naozaj chcete prep√≠sa≈• aktu√°lne d√°ta?`)) {
                        setLoadingState(btn, false, "Obnovi≈• z√°lohu z XLSX"); return;
                    }

                    const localKey = getLocalStorageKey();
                    const backupDataString = JSON.stringify(finalData);
                    localStorage.setItem(localKey, backupDataString);
                    const pendingKey = getPendingSyncKey();
                    if(pendingKey) localStorage.removeItem(pendingKey);

                    updateUI();
                    parseAndApplyData(backupDataString);
                    showSaveNotification('Z√°loha bola √∫spe≈°ne obnoven√° a naƒç√≠tan√°.');

                    if (currentUser && navigator.onLine) {
                        saveToFirestore(finalData);
                    } else if (currentUser) {
                        const pendingKey = getPendingSyncKey();
                        if(pendingKey) localStorage.setItem(pendingKey, backupDataString);
                    }
                } catch (error) {
                    console.error('Chyba pri naƒç√≠tavan√≠ z√°lohy:', error);
                    showErrorNotification('Chyba pri naƒç√≠tavan√≠ z√°lohy: ' + error.message);
                } finally {
                    setLoadingState(btn, false, "Obnovi≈• z√°lohu z XLSX");
                    input.value = '';
                }
            };
            reader.onerror = () => {
                showErrorNotification('Chyba pri ƒç√≠tan√≠ s√∫boru.');
                setLoadingState(btn, false, "Obnovi≈• z√°lohu z XLSX");
            }
            reader.readAsArrayBuffer(file);
        };
        input.click();
    };

    // --- Spr√°va Nastaven√≠ ---
    window.changeDecimalPlaces = function() {
        decimalPlaces = parseInt(decimalPlacesSelect.value);
        localStorage.setItem('decimalPlaces', decimalPlaces);
        const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) calculateRow(i);
        debouncedSaveAndSync();
    }
    window.updateEmployeeName = function() {
        employeeName = employeeNameInput.value.trim();
        localStorage.setItem('employeeName', employeeName);
        updateGreeting();
        debouncedSaveAndSync();
    }
    window.updateSettings = function() {
        const newHourlyWage = parseFloat(hourlyWageInput.value);
        const newTaxRatePercent = parseFloat(taxRateInput.value);
        const newDefaultBreak = parseFloat(defaultBreakInput.value);

        if (!isNaN(newHourlyWage) && newHourlyWage >= 0) hourlyWage = newHourlyWage;
        else hourlyWageInput.value = hourlyWage.toFixed(1);

        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) taxRate = newTaxRatePercent / 100;
        else taxRateInput.value = (taxRate * 100).toFixed(1);

        if (!isNaN(newDefaultBreak) && newDefaultBreak >= 0) defaultBreakTime = newDefaultBreak;
        else defaultBreakInput.value = defaultBreakTime.toFixed(1);

        localStorage.setItem('hourlyWage', hourlyWage);
        localStorage.setItem('taxRate', taxRate);
        localStorage.setItem('defaultBreakTime', defaultBreakTime);

        const days = getDaysInMonth(currentMonth, currentYear);
        for (let i = 1; i <= days; i++) calculateRow(i);
        debouncedSaveAndSync();
    }
    window.changeMonth = function() {
        currentMonth = parseInt(monthSelect.value);
        console.log(`Month changed to: ${MONTH_NAMES[currentMonth]}`);
        updateUI();
    }
    window.changeYear = function() {
        currentYear = parseInt(yearSelect.value);
        console.log(`Year changed to: ${currentYear}`);
        updateUI();
    }

    // --- Tmav√Ω Re≈æim ---
    window.toggleDarkMode = function() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }

    // --- Inicializ√°cia Aplik√°cie ---
    onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed. User:', user ? user.email : 'None');
        currentUser = user;
        updateUI();
    });

    initializeSettingsInputs();

    // --- Vzor Firebase Security Rules (prida≈• do Firebase konzoly) ---
    /*
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /users/{userId}/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        match /users/{userId}/workDays/{monthDocId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }
    */
  </script>

  <!-- Service Worker registr√°cia -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => { console.log('ServiceWorker registration successful with scope: ', registration.scope); })
          .catch(error => { console.error('ServiceWorker registration failed: ', error); });
      });
    }
  </script>
</body>
</html>
