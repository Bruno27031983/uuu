<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dochádzka Pro</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="icons/icon-192x192.png" type="image/png"> <!-- Uistite sa, že táto ikona existuje -->
  <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- A táto tiež -->
  <meta name="theme-color" content="#5c67f2">
  <meta name="description" content="Aplikácia na sledovanie dochádzky pracovníkov.">


  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <style>
    :root {
      --primary-bg: #f4f4f4;
      --secondary-bg: white;
      --text-color: #333;
      --input-bg: #ffffd0;
      --input-border: #ccc;
      --header-bg: #f2f2f2;
      --button-primary-bg: #5c67f2;
      --button-primary-hover-bg: #4a54e0;
      --button-reset-bg: #f44336;
      --button-reset-hover-bg: #d32f2f;
      --button-export-bg: #4CAF50;
      --button-export-hover-bg: #388e3c;
      --button-backup-bg: #8a2be2;
      --button-backup-hover-bg: #6a1bb2;
      --button-highlight-bg: #ffc107; 
      --button-highlight-text: #333;
      --current-day-bg: #8a2be2;
      --current-day-text: white;
      --current-day-input-bg: #9932cc;
      --total-salary-bg: #e9ecef;
      --total-salary-border: #dee2e6;
      --link-color: #007bff;
      --note-indicator-color: #28a745;
      --note-toggle-btn-bg: #6c757d;
      --note-toggle-btn-hover-bg: #5a6268;
      --note-textarea-bg: #f0f0f0;
      --collapsible-summary-bg: #f8f8f8;
      --collapsible-summary-hover-bg: #eee;
      --collapsible-content-border: #eee;
      --datasize-bar-bg: #ddd;
      --datasize-fill-good: #4CAF50;
      --datasize-fill-warn: #ff9800;
      --datasize-fill-bad: #f44336;
      --loader-bg: rgba(244,244,244,0.8);
      --loader-text: #555;
      --notification-save-bg: #4CAF50;
      --notification-error-bg: #f44336;
      --login-form-bg: #f9f9f9;
      --login-form-border: #ccc;
    }

    body.dark-mode {
      --primary-bg: #333;
      --secondary-bg: #444;
      --text-color: #f4f4f4;
      --input-bg: #666;
      --input-border: #888;
      --header-bg: #666;
      --button-primary-bg: #7b85f5;
      --button-primary-hover-bg: #6a73e3;
      --button-reset-bg: #f66b5f;
      --button-reset-hover-bg: #e45a4f;
      --button-export-bg: #6fbf7a;
      --button-export-hover-bg: #5a9e63;
      --button-backup-bg: #a356f0;
      --button-backup-hover-bg: #8a3ee0;
      --button-highlight-bg: #ffca2c;
      --button-highlight-text: #212121;
      --current-day-bg: #4a0e8f;
      --current-day-text: #fff;
      --current-day-input-bg: #5c1db3;
      --total-salary-bg: #2c3e50;
      --total-salary-border: #34495e;
      --link-color: #66b3ff;
      --note-indicator-color: #6fbf7a;
      --note-toggle-btn-bg: #828a91;
      --note-toggle-btn-hover-bg: #70777d;
      --note-textarea-bg: #555;
      --collapsible-summary-bg: #555;
      --collapsible-summary-hover-bg: #666;
      --collapsible-content-border: #666;
      --datasize-bar-bg: #555;
      --loader-bg: rgba(51,51,51,0.8);
      --loader-text: #bbb;
      --notification-save-bg: #6fbf7a;
      --notification-error-bg: #f66b5f;
      --login-form-bg: #3e3e3e;
      --login-form-border: #555;
    }

    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--primary-bg);
      color: var(--text-color);
      font-size: 16px;
      transition: background-color 0.3s, color 0.3s;
    }
    #loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--loader-bg);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; font-size: 1.2em; color: var(--loader-text);
    }
    .container {
      max-width: 1200px; margin: auto; background: var(--secondary-bg);
      padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s, color 0.3s;
    }
    h1#mainTitle {
      text-align: center; font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text; -webkit-background-clip: text; color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
    }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode h1#mainTitle {
        animation: gradientText 5s ease-in-out infinite, textShadowPulseDark 2s ease-in-out infinite;
    }
    @keyframes textShadowPulseDark { 0%, 100% { text-shadow: 0 0 10px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.3), 0 0 30px rgba(0,0,0,0.2); } 50% { text-shadow: 0 0 20px rgba(0,0,0,1), 0 0 30px rgba(0,0,0,0.9), 0 0 40px rgba(0,0,0,0.7); } }

    h2 { text-align: center; color: var(--text-color); margin-top: -10px; font-size: 1.2em; margin-bottom: 20px; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; font-size: 0.9em; }
    .collapsible-settings summary {
        cursor: pointer; padding: 8px; border: 1px solid var(--input-border);
        border-radius: 3px; background-color: var(--collapsible-summary-bg);
        display: list-item; transition: background-color 0.2s ease; font-weight: bold;
    }
    .collapsible-settings summary:hover { background-color: var(--collapsible-summary-hover-bg); }
    .collapsible-content {
        display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px;
        padding: 10px 5px 5px 5px; border-top: 1px solid var(--collapsible-content-border); margin-top: 5px;
    }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 1050px; table-layout: fixed; }
    th, td {
        padding: 8px; border: 1px solid #ddd; 
        text-align: left; font-size: 0.9em;
        vertical-align: top; word-wrap: break-word; position: relative;
    }
     body.dark-mode th, body.dark-mode td {
        border-color: var(--input-border);
    }
    th { background-color: var(--header-bg); font-weight: bold; }
    th:nth-child(1), td:nth-child(1) { width: 40px; } 
    th:nth-child(2), td:nth-child(2) { width: 110px; } 
    th:nth-child(3), td:nth-child(3) { width: 110px; } 
    th:nth-child(4), td:nth-child(4) { width: 90px; text-align: center; } 
    th:nth-child(5), td:nth-child(5) { width: 130px;} 
    th:nth-child(6), td:nth-child(6) { width: 150px;} 
    th:nth-child(7), td:nth-child(7) { width: 100px; text-align: right;} 
    th:nth-child(8), td:nth-child(8) { width: 100px; text-align: right;} 
    th:nth-child(9), td:nth-child(9) { width: 70px; text-align: center; } 

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%; padding: 7px; box-sizing: border-box; background-color: var(--input-bg);
      font-size: 1em; border: 1px solid var(--input-border); border-radius: 3px; vertical-align: middle;
      color: var(--text-color);
    }
    textarea.note-textarea-class {
        resize: vertical; min-height: 40px; max-height: 100px; overflow-y: auto;
        background-color: var(--note-textarea-bg);
    }

    .time-input-wrapper { display: flex; align-items: center; gap: 5px; position: relative; }
    .time-input-wrapper input[type="tel"] { flex-grow: 1; min-width: 45px; padding-right: 30px; }
    .clock-icon {
        position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
        cursor: pointer; font-size: 1.4em; color: var(--text-color); user-select: none; z-index: 2;
    }
    .clock-icon:hover { color: var(--link-color); opacity: 0.8; }

    .note-controls { display: flex; align-items: center; gap: 5px; margin-bottom: 3px;}
    .note-indicator-icon {
        display: none;
        font-size: 1.1em; color: var(--note-indicator-color);
        vertical-align: middle; cursor: default;
    }
    .toggle-note-btn {
        background-color: var(--note-toggle-btn-bg); color: white;
        padding: 3px 8px; border: none; border-radius: 3px;
        cursor: pointer; font-size: 0.8em; transition: background-color 0.2s ease;
        vertical-align: middle;
    }
    .toggle-note-btn:hover { background-color: var(--note-toggle-btn-hover-bg); }
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }


    .btn-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn {
      padding: 12px 18px; border: none; border-radius: 4px; color: white;
      background-color: var(--button-primary-bg); cursor: pointer; font-size: 1.0em;
      transition: background-color 0.3s ease; text-align: center;
      flex: 1 1 150px; max-width: 200px; box-sizing: border-box;
    }
    .btn:hover { background-color: var(--button-primary-hover-bg); }
    .reset-btn { background-color: var(--button-reset-bg); }
    .reset-btn:hover { background-color: var(--button-reset-hover-bg); }
    .export-btn { background-color: var(--button-export-bg); }
    .export-btn:hover { background-color: var(--button-export-hover-bg); }
    .backup-btn { background-color: var(--button-backup-bg); padding: 18px 22px; }
    .backup-btn:hover { background-color: var(--button-backup-hover-bg); }
    .dark-mode-toggle-btn { background-color: var(--button-highlight-bg); color: var(--button-highlight-text) !important; }
    .dark-mode-toggle-btn:hover { opacity: 0.9; }


    #totalSalary {
      margin-top: 20px; padding: 18px; background-color: var(--total-salary-bg);
      border-radius: 4px; font-size: 1.1em; line-height: 1.6;
      border: 1px solid var(--total-salary-border); text-align: center;
    }
    .current-day { background-color: var(--current-day-bg) !important; color: var(--current-day-text) !important; }
    .current-day input, .current-day select, .current-day textarea, .current-day .toggle-note-btn {
        background-color: var(--current-day-input-bg) !important;
        color: var(--current-day-text) !important;
        border-color: var(--current-day-bg) !important;
    }
    .current-day .clock-icon, .current-day .note-indicator-icon { color: var(--current-day-text) !important; }


    #dataSizeContainer { margin-top: 15px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 0.85em; color: var(--text-color); }
    #dataSizeBar { width: 80%; max-width: 300px; height: 15px; background-color: var(--datasize-bar-bg); border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: var(--datasize-fill-good); transition: width 0.3s ease, background-color 0.3s; }


    .logout-section { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--collapsible-content-border); text-align: center; }
    #user-info, #login-form { display: none; }
    #user-info span { font-size: 0.95em; color: var(--text-color); }
    #user-info .btn { min-width: 150px; width: auto; flex-grow: 0; padding: 8px 16px; font-size: 0.9em; max-width: 200px; }

    #installAppButton {
        padding: 12px 18px; border: none; border-radius: 4px; color: white;
        background-color: #28a745; cursor: pointer; font-size: 1.0em;
        transition: background-color 0.3s ease; text-align: center;
        flex: 1 1 150px; max-width: 200px; box-sizing: border-box; margin-top: 5px;
    }
    #installAppButton:hover { background-color: #218838; }

    @media (max-width: 768px) {
      body { padding: 5px; font-size: 15px; }
      .container { padding: 12px; max-width: 100%; }
      h1#mainTitle { font-size: 2.0em; }
      h2 { font-size: 1.1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div, .settings > details, .settings > button { width: 100%; margin: 5px 0; flex-basis: auto; }
      .collapsible-content { flex-direction: column; align-items: stretch; }
      .collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; }
      table { min-width: 750px; }
      th, td { padding: 8px; font-size: 1.0em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea {
          font-size: 1.0em; padding: 8px;
      }
      .clock-icon { font-size: 1.5em; }
      .btn-container { flex-direction: column; align-items: center; }
      .btn, #installAppButton, .dark-mode-toggle-btn {
          max-width: none; font-size: 1.05em; width: 95%;
          margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 5px;
          box-sizing: border-box; height: 44px; padding: 0 20px; flex: none;
      }
      .backup-btn { padding: 0 22px; }
      #user-info .btn { width: 80%; font-size: 0.95em; padding: 10px 16px; height: auto; margin-bottom: 0; }
      #totalSalary { font-size: 1.0em; padding: 15px; }
    }

    @media (max-width: 480px) {
      body { font-size: 14px; }
      .container { padding: 10px; }
      h1#mainTitle { font-size: 1.8em; }
      h2 { font-size: 1.0em; }
      th, td { font-size: 0.9em; padding: 7px; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea {
          font-size: 0.95em; padding: 8px;
      }
      .settings label { font-size: 1.0em; }
      .clock-icon { font-size: 1.6em; }
      .btn, #installAppButton, .dark-mode-toggle-btn {
          font-size: 0.95em; width: 95%; height: 42px; padding: 0 15px;
          flex: none; margin-bottom: 4px;
      }
      .backup-btn { padding: 0 15px; }
      #user-info .btn { width: 85%; padding: 10px 16px; height: auto; margin-bottom: 0; }
      table { min-width: 600px; }
      #totalSalary { font-size: 0.95em; padding: 12px; }
    }


    #saveNotification, #errorNotification {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        padding: 10px 20px; border-radius: 5px; color: white;
        z-index: 10000; opacity: 0; visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        text-align: center; font-size: 0.9em;
    }
    #saveNotification.show, #errorNotification.show { opacity: 1; visibility: visible; }
    #saveNotification { background-color: var(--notification-save-bg); }
    #errorNotification { background-color: var(--notification-error-bg); }

    #login-form {
        flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px;
        padding: 15px; border: 1px solid var(--login-form-border); border-radius: 5px;
        background-color: var(--login-form-bg);
    }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 100%; max-width: 300px; padding: 8px; margin-bottom: 5px;
        border: 1px solid var(--input-border); border-radius: 3px; box-sizing: border-box;
        font-size: 1em; background-color: var(--input-bg); color: var(--text-color);
    }
    #login-form .btn {
        width: auto; max-width: 150px; padding: 10px 22px; margin: 5px 0;
        font-size: 1em; height: auto; flex: initial;
        background-color: var(--button-export-bg); color: white;
    }
    #login-form .btn:hover { background-color: var(--button-export-hover-bg); }
    #login-form a { color: var(--link-color); text-decoration: none; font-size: 0.9em; }
    #login-form a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <div id="loader">Načítavam aplikáciu...</div>

  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
    </div>

    <h1 id="mainTitle">Dochádzka 👋</h1>
    <h2></h2>
    <div class="settings">
        <div>
          <label for="monthSelect">Mesiac: </label>
          <select id="monthSelect" onchange="changeMonth()">
            <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
            <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
            <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
            <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
          </select>
        </div>
        <details class="collapsible-settings">
          <summary>Ďalšie nastavenia</summary>
          <div class="collapsible-content">
            <div>
              <label for="employeeNameInput">Meno pracovníka: </label>
              <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
            </div>
            <div>
              <label for="hourlyWageInput">Hodinová mzda (€): </label>
              <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
              <label for="taxRateInput">Daňové percento (%): </label>
              <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div> <label for="yearSelect">Rok: </label>
              <select id="yearSelect" onchange="changeYear()"></select>
            </div>
            <div>
              <label for="decimalPlacesSelect">Počet desatinných miest: </label>
              <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
              </select>
            </div>
          </div>
        </details>
        <button id="darkModeToggle" class="btn dark-mode-toggle-btn" onclick="toggleDarkMode()">🌙/☀️</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Poznámky</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Obnoviť z Cloudu</button>
      <!-- Inštalačné tlačidlo PWA sa pridá sem dynamicky cez JS -->
    </div>

    <div class="logout-section">
        <div id="user-info">
          <span id="user-email"></span>
          <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
        </div>
    </div>

  </div>
  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // <-- NAHRAĎTE TOTO VAŠOU REÁLNOU KONFIGURÁCIOU!
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
    };

    const app = initializeApp(firebaseConfig);

    // --- Firebase App Check s vaším kľúčom (zakomentované pre jednoduché testovanie prihlásenia) ---
    // Ak chcete App Check aktivovať, odkomentujte nasledujúci blok
    // a uistite sa, že kľúč '6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'
    // je správne nakonfigurovaný pre vašu doménu
    // v Google Cloud Console pre reCAPTCHA v3.
    /*
    try {
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // VÁŠ REÁLNY KĽÚČ
            isTokenAutoRefreshEnabled: true
        });
        console.log("Firebase App Check initialized with your key.");
    } catch (e) {
        console.warn("Firebase App Check failed to initialize. This might affect Firebase interactions if not properly configured.", e);
    }
    */
    // --- Koniec Firebase App Check ---

    const auth = getAuth(app);
    const db = getFirestore(app);

    // Globálne premenné
    let currentUser = null;
    let firestoreListenerUnsubscribe = null;

    const workDaysTableBody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitleElement = document.getElementById('mainTitle');
    const subTitleElement = document.querySelector('h2');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const loaderElement = document.getElementById('loader');
    const loginFormElement = document.getElementById('login-form');
    const userInfoElement = document.getElementById('user-info');
    const userEmailElement = document.getElementById('user-email');
    const dataSizeTextElement = document.getElementById('dataSizeText');
    const dataSizeFillElement = document.getElementById('dataSizeFill');

    const MAX_LOCAL_STORAGE_SIZE_KB = 4096; // Približný limit pre notifikáciu

    const currentDateGlobal = new Date();
    let currentMonth = currentDateGlobal.getMonth();
    let currentYear = currentDateGlobal.getFullYear();
    let decimalPlaces = 2;
    let employeeName = '';
    let hourlyWage = 10;
    let taxRate = 0.02; 
    let isDarkMode = false;
    let workDataStore = {}; // Interný store pre dáta tabuľky

    // --- VŠETKY JAVASCRIPT FUNKCIE Z PREDCHÁDZAJÚCEJ ODPOVEDE SEM ---
    // (updateGreeting, populateYearSelect, loadGlobalSettingsFromLocalStorage, ... až po PWA logiku)
    // Nasleduje skrátená verzia, celý obsah funkcií je v predchádzajúcich odpovediach

    function updateGreeting() {
        const nameToUse = employeeName || '';
        if (nameToUse && mainTitleElement) {
            mainTitleElement.textContent = `Vitaj späť ${nameToUse.split(' ')[0]} 👋`;
        } else if (mainTitleElement) {
            mainTitleElement.textContent = 'Dochádzka 👋';
        }
        if (subTitleElement) {
            const monthName = getMonthName(currentMonth);
            subTitleElement.textContent = monthName ? `${monthName} ${currentYear}` : `Načítavam... ${currentYear}`;
        }
    }

    function populateYearSelect() {
        const startYear = 2020;
        const endYear = new Date().getFullYear() + 2;
        if (yearSelect) {
            yearSelect.innerHTML = '';
            for (let y = startYear; y <= endYear; y++) {
                const option = document.createElement('option');
                option.value = y; option.textContent = y;
                yearSelect.appendChild(option);
            }
        }
    }

    function loadGlobalSettingsFromLocalStorage() {
        console.log("loadGlobalSettingsFromLocalStorage called");
        hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        taxRate = (parseFloat(localStorage.getItem('taxRatePercent')) || 2) / 100;
        decimalPlaces = parseInt(localStorage.getItem('decimalPlaces'), 10) || 2;
        employeeName = localStorage.getItem('employeeName') || '';
        isDarkMode = JSON.parse(localStorage.getItem('isDarkMode')) || false;

        let storedMonth = localStorage.getItem('currentMonth');
        let parsedMonth = parseInt(storedMonth, 10);
        if (typeof parsedMonth === 'number' && !isNaN(parsedMonth) && parsedMonth >= 0 && parsedMonth <= 11) {
            currentMonth = parsedMonth;
        } else {
            currentMonth = new Date().getMonth();
            console.log("loadGlobalSettings: currentMonth fallback to actual month:", currentMonth);
        }

        let storedYear = localStorage.getItem('currentYear');
        let parsedYear = parseInt(storedYear, 10);
        const currentActualYear = new Date().getFullYear();
        if (typeof parsedYear === 'number' && !isNaN(parsedYear) && parsedYear >= 2020 && parsedYear <= currentActualYear + 5) {
            currentYear = parsedYear;
        } else {
            currentYear = currentActualYear;
            console.log("loadGlobalSettings: currentYear fallback to actual year:", currentYear);
        }
        console.log(`loadGlobalSettings: Loaded month: ${currentMonth}, year: ${currentYear}`);

        if(monthSelect) monthSelect.value = currentMonth;
        if(yearSelect) yearSelect.value = currentYear;
        if(decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
        if(employeeNameInput) employeeNameInput.value = employeeName;
        if(hourlyWageInput) hourlyWageInput.value = hourlyWage.toFixed(1);
        if(taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1);
        
        applyDarkMode(isDarkMode);
        updateGreeting();
    }
    
    function saveGlobalSettingsToLocalStorage() {
        localStorage.setItem('hourlyWage', hourlyWage.toString());
        localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1));
        localStorage.setItem('decimalPlaces', decimalPlaces.toString());
        localStorage.setItem('employeeName', employeeName);
        localStorage.setItem('isDarkMode', JSON.stringify(isDarkMode));
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        updateDataSize();
    }

    function isOnline() { return navigator.onLine; }

    function showStatusNotification(message, color = '#007bff', duration = 3000) {
        const n = document.createElement('div');
        n.textContent = message;
        n.style.cssText = `position:fixed; top:20px; right:20px; padding:10px 20px; border-radius:5px; background-color:${color}; color:white; z-index:10001; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition: opacity 0.5s; opacity: 0;`;
        document.body.appendChild(n);
        setTimeout(() => n.style.opacity = '1', 10);
        setTimeout(() => {
            n.style.opacity = '0';
            setTimeout(() => n.remove(), 500);
        }, duration);
    }
    function showErrorNotification(message) { const n = document.getElementById('errorNotification'); if(n) {n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 4000);} else {console.error("Error notification element not found!", message)} }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') { const n = document.getElementById('saveNotification'); if(n) {n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 3000);} else {console.log("Save notification:", message)} }
    function mapFirebaseAuthError(code) { const map = {'auth/invalid-email':'Neplatný email.','auth/user-not-found':'Používateľ nenájdený.','auth/wrong-password':'Nesprávne heslo.','auth/email-already-in-use':'Email už existuje.','auth/weak-password':'Slabé heslo.','auth/requires-recent-login':'Vyžaduje sa nové prihlásenie.','auth/network-request-failed':'Chyba siete.','auth/missing-email':'Zadajte email.'}; return map[code] || code; }

    async function createUserCollection() { if (!auth.currentUser) return; const uRef = doc(db, 'users', auth.currentUser.uid); try { await setDoc(uRef, { email: auth.currentUser.email, createdAt: serverTimestamp() }, { merge: true }); const iRef = doc(collection(uRef, 'workDays'), 'initial_setup'); await setDoc(iRef, { setupComplete: true }); } catch (err) { console.error('Chyba vytvorenia user kolekcie:', err); } }

    function loadFromLocalStorageOnly() {
        console.log(`loadFromLocalStorageOnly called for ${getMonthName(currentMonth)}/${currentYear}`);
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        
        if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) {
             console.log("loadFromLocalStorageOnly: Table is empty, calling createTable().");
            createTable();
        }

        if (localData) {
            console.log(`Načítavam dáta z lokálneho úložiska (workData) pre ${getMonthName(currentMonth)} ${currentYear}.`);
            parseAndApplyData(localData, true);
        } else {
            console.log(`V lokálnom úložisku (workData) sa nenašli žiadne dáta pre ${getMonthName(currentMonth)} ${currentYear}. Resetujem UI a store.`);
            const dataKey = `workData-${currentYear}-${currentMonth}`;
            workDataStore[dataKey] = createEmptyMonthData();
            if (workDaysTableBody.hasChildNodes()) {
                const daysInMonth = getDaysInMonth(currentMonth);
                for (let i = 1; i <= daysInMonth; i++) {
                    if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        _resetRowUIOnly(i);
                        updateNoteIndicator(i);
                    }
                }
            } else if (workDaysTableBody && !workDaysTableBody.hasChildNodes() && (typeof currentMonth === 'number' && typeof currentYear === 'number') ) {
                const daysInMonth = getDaysInMonth(currentMonth);
                 if (daysInMonth > 0 && workDaysTableBody.children.length === 0) { // Ak sa tabuľka z nejakého dôvodu nevytvorila, skús znova
                    console.warn("loadFromLocalStorageOnly: Table was expected but empty, re-creating.");
                    createTable();
                 } else { // Tabuľka je prázdna, lebo dní je 0, alebo už bola vytvorená (createTable hore)
                    for (let i = 1; i <= daysInMonth; i++) {
                        if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                            _resetRowUIOnly(i); updateNoteIndicator(i);
                        }
                    }
                 }
            }
            calculateTotal();
        }
        updateDataSize();
    }
    
    function createEmptyMonthData() {
        const daysInMonth = getDaysInMonth(currentMonth);
         if (daysInMonth === 0 || isNaN(daysInMonth)) { // Pridaná kontrola NaN
            console.warn(`createEmptyMonthData: Počet dní v mesiaci je neplatný (${daysInMonth}) pre ${currentMonth}/${currentYear}. Vraciam prázdne pole.`);
            return [];
        }
        return Array.from({ length: daysInMonth }, () => ({
            start: '', end: '', breakTime: '', note: '', noteVisible: false,
        }));
    }

    function parseAndApplyData(dataString, isLocalOnlyLoad = false) {
        let sData;
        try {
            sData = JSON.parse(dataString);
        } catch (err) {
            showErrorNotification(`Chyba spracovania prijatých dát: ${err.message}`);
            console.error("Chyba v parseAndApplyData (JSON.parse):", err, "Data string:", dataString);
            loadGlobalSettingsFromLocalStorage(); // Načíta default/LS globálne nastavenia
            const dataKey = `workData-${currentYear}-${currentMonth}`;
            workDataStore[dataKey] = createEmptyMonthData();
            if (workDaysTableBody && !workDaysTableBody.hasChildNodes() && (typeof currentMonth === 'number' && !isNaN(currentMonth) && typeof currentYear === 'number' && !isNaN(currentYear))) {
                 console.warn("parseAndApplyData (catch): Table is empty, calling createTable().");
                 createTable();
            } else if (workDaysTableBody && workDaysTableBody.hasChildNodes()) { // Ak už je tabuľka, resetni riadky
                const daysInMonth = getDaysInMonth(currentMonth);
                for (let i = 1; i <= daysInMonth; i++) {
                    if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        _resetRowUIOnly(i); updateNoteIndicator(i);
                    }
                }
            }
            calculateTotal(); updateDataSize(); return;
        }

        console.log("parseAndApplyData - prijaté dáta:", sData);

        if (!isLocalOnlyLoad && sData.settings) {
            hourlyWage = parseFloat(sData.settings.hourlyWage) ?? hourlyWage;
            employeeName = String(sData.settings.employeeName ?? employeeName);
            decimalPlaces = parseInt(sData.settings.decimalPlaces, 10) ?? decimalPlaces;
            let loadedTaxRate = sData.settings.taxRate;
            if (loadedTaxRate !== undefined && loadedTaxRate !== null) { taxRate = parseFloat(loadedTaxRate); }
            isDarkMode = sData.settings.isDarkMode ?? isDarkMode;
            
            if(hourlyWageInput) hourlyWageInput.value = hourlyWage.toFixed(1);
            if(taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1);
            if(employeeNameInput) employeeNameInput.value = employeeName;
            if(decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
            applyDarkMode(isDarkMode);
            saveGlobalSettingsToLocalStorage();
        }
        updateGreeting();

        if (workDaysTableBody && !workDaysTableBody.hasChildNodes() && (typeof currentMonth === 'number' && !isNaN(currentMonth) && typeof currentYear === 'number' && !isNaN(currentYear))) {
            console.warn("parseAndApplyData: Tabuľka nebola inicializovaná, vytváram ju.");
            createTable();
        }
        
        const dataKey = `workData-${currentYear}-${currentMonth}`;
        workDataStore[dataKey] = sData.days || createEmptyMonthData();

        const daysInMonth = getDaysInMonth(currentMonth);
        const activeElementId = document.activeElement?.id;

        for (let i = 1; i <= daysInMonth; i++) {
            const dayIndex = i - 1;
            const dayData = workDataStore[dataKey]?.[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };
            
            const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
            const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${i}`);
            const noteToggleBtn = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${i}`);

            if (startEl && endEl && breakEl && noteEl && noteContainer && noteToggleBtn) {
                if (startEl.id !== activeElementId) startEl.value = dayData.start || '';
                if (endEl.id !== activeElementId) endEl.value = dayData.end || '';
                if (breakEl.id !== activeElementId) breakEl.value = dayData.breakTime || '';
                if (noteEl.id !== activeElementId) noteEl.value = dayData.note || '';

                const isNoteVisible = dayData.noteVisible === true;
                noteContainer.classList.toggle('visible', isNoteVisible);
                noteToggleBtn.textContent = isNoteVisible ? 'Skryť' : 'Poznámka';
                updateNoteIndicator(i);
                calculateRow(i);
            }
        }
        calculateTotal();
        if (!isLocalOnlyLoad) updateDataSize();
    }

    async function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) {
            console.log('Odhlasujem existujúci Firestore listener.');
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (!currentUser) {
            console.log('Nie je prihlásený používateľ, Firestore listener sa nenastavuje.');
            loadFromLocalStorageOnly();
            if (loaderElement) loaderElement.style.display = 'none';
            return;
        }
        if (!isOnline()) {
            console.log('Aplikácia je offline, Firestore listener sa nenastavuje. Zobrazujem lokálne dáta.');
            loadFromLocalStorageOnly();
            const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
            if (localStorage.getItem(pendingKey)) {
                 showStatusNotification('Máte neodoslané zmeny, ktoré sa zosynchronizujú po pripojení.', '#ffc107', 5000);
            }
            if (loaderElement) loaderElement.style.display = 'none';
            return;
        }
        
        if (typeof currentMonth !== 'number' || isNaN(currentMonth) || typeof currentYear !== 'number' || isNaN(currentYear)) {
            console.error("setupFirestoreListener: Invalid month/year. Aborting listener setup.");
            if (loaderElement) loaderElement.style.display = 'none';
            return;
        }

        const docPath = `users/${currentUser.uid}/workDays/${currentYear}-${currentMonth}`;
        const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
        console.log(`Nastavujem Firestore listener pre: ${docPath}`);
        if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) {
            console.log("setupFirestoreListener: Table is empty, calling createTable().");
            createTable();
        }

        if (loaderElement) loaderElement.style.display = 'flex';

        firestoreListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
            if (loaderElement) loaderElement.style.display = 'none';
            console.log(`Firestore listener (${docRef.path}): Prijaté dáta | Pending writes: ${docSnap.metadata.hasPendingWrites} | From cache: ${docSnap.metadata.fromCache}`);

            const currentLocalDataKey = `workData-${currentYear}-${currentMonth}`;

            if (docSnap.exists()) {
                const serverData = docSnap.data();
                const serverDataString = JSON.stringify(serverData);

                if (docSnap.metadata.hasPendingWrites && docSnap.metadata.fromCache) {
                    console.log(`Firestore listener (${docRef.path}): Pending writes z cache, aktualizujem LS a store, UI sa nemení.`);
                    localStorage.setItem(currentLocalDataKey, serverDataString);
                     const dataKey = `workData-${currentYear}-${currentMonth}`;
                    workDataStore[dataKey] = serverData.days || createEmptyMonthData();
                    // Globálne nastavenia sa tu neaktualizujú z pending writes
                    return;
                }
                
                console.log(`Firestore listener (${docRef.path}): Dokument existuje, aplikujem dáta.`);
                localStorage.setItem(currentLocalDataKey, serverDataString);
                parseAndApplyData(serverDataString, false);

                const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
                if (localStorage.getItem(pendingKey)) {
                    console.log(`Firestore listener (${docRef.path}): Vymazávam pending sync dáta.`);
                    localStorage.removeItem(pendingKey);
                }
                if (!docSnap.metadata.hasPendingWrites && !docSnap.metadata.fromCache) {
                     console.log(`Firestore listener (${docRef.path}): Dáta plne zosynchronizované zo servera.`);
                }

            } else {
                console.log(`Firestore listener (${docRef.path}): Dokument neexistuje. Čistím lokálne dáta a store.`);
                localStorage.removeItem(currentLocalDataKey);
                const dataKey = `workData-${currentYear}-${currentMonth}`;
                workDataStore[dataKey] = createEmptyMonthData();

                if (workDaysTableBody && workDaysTableBody.hasChildNodes()) {
                    const daysInMonth = getDaysInMonth(currentMonth);
                     for (let i = 1; i <= daysInMonth; i++) {
                        if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                            _resetRowUIOnly(i);
                            updateNoteIndicator(i);
                        }
                     }
                } else if (workDaysTableBody && (typeof currentMonth === 'number' && !isNaN(currentMonth) && typeof currentYear === 'number' && !isNaN(currentYear))) {
                     console.warn("setupFirestoreListener (doc not exists): Table was expected but empty, re-creating.");
                    createTable();
                }
                calculateTotal();
                updateGreeting();
                if (!docSnap.metadata.hasPendingWrites) {
                    showErrorNotification('Dáta pre tento mesiac boli na serveri odstránené alebo neexistujú.');
                }
            }
            updateDataSize();
        }, (error) => {
            if (loaderElement) loaderElement.style.display = 'none';
            console.error(`Chyba vo Firestore listeneri (${docRef.path}): `, error);
            showErrorNotification(`Chyba pri počúvaní zmien z Firebase: ${error.message}`);
            if (firestoreListenerUnsubscribe) {
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
            }
            loadFromLocalStorageOnly();
        });
    }

    function debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1200);

    function collectCurrentDataForSaving() {
        const dataKey = `workData-${currentYear}-${currentMonth}`;
        const daysData = workDataStore[dataKey] || createEmptyMonthData();

        return {
            days: daysData.map(d => ({ 
                start: d.start || '', end: d.end || '', breakTime: d.breakTime || '',
                note: d.note || '', noteVisible: d.noteVisible === true
            })),
            settings: { 
                hourlyWage: parseFloat(hourlyWage), taxRate: parseFloat(taxRate), 
                employeeName: String(employeeName), decimalPlaces: parseInt(decimalPlaces,10),
                isDarkMode: isDarkMode
            },
            lastUpdated: serverTimestamp()
        };
    }

    async function saveToFirestore() {
        const saveData = collectCurrentDataForSaving();
        const localWorkDataKey = `workData-${currentYear}-${currentMonth}`;
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;

        localStorage.setItem(localWorkDataKey, JSON.stringify(saveData));
        updateDataSize();

        if (!currentUser) {
            console.log('Používateľ nie je prihlásený. Dáta uložené iba lokálne. Synchronizácia preskočená.');
            return;
        }

        if (!isOnline()) {
            console.log('Aplikácia je offline. Ukladám dáta do fronty pre background sync.');
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
            showErrorNotification('Ste offline. Dáta uložené lokálne, zosynchronizujú sa po pripojení.');
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                navigator.serviceWorker.ready.then(swReg => swReg.sync.register('sync-pending-data'))
                    .then(() => console.log('Background sync zaregistrovaný.'))
                    .catch(err => console.error('Chyba registrácie background sync:', err));
            }
            return;
        }

        try {
            console.log(`Ukladám dáta do Firestore pre ${currentUser.uid}/${currentYear}-${currentMonth}`);
            const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
            await setDoc(docRef, saveData, { merge: true });
            localStorage.removeItem(pendingSyncKey);
        } catch (err) {
            showErrorNotification(`Chyba ukladania do Firebase: ${err.message}. Dáta uložené lokálne.`);
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
               navigator.serviceWorker.ready.then(swReg => swReg.sync.register('sync-pending-data'))
                .catch(syncErr => console.error('Chyba registrácie background sync po chybe ukladania:', syncErr));
            }
        }
    }

    async function syncWithFirebase() {
        if (!currentUser || !isOnline()) { return; }
        const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingDataStr = localStorage.getItem(pendingKey);
        if (pendingDataStr) {
            console.log('syncWithFirebase: Našli sa čakajúce dáta, pokus o synchronizáciu.');
            if (loaderElement) loaderElement.style.display = 'flex';
            try {
                const dataToSync = JSON.parse(pendingDataStr);
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, dataToSync, { merge: true });
                localStorage.setItem(`workData-${currentYear}-${currentMonth}`, pendingDataStr); // Aj do hlavného úložiska
                localStorage.removeItem(pendingKey);
                showSaveNotification('Čakajúce zmeny boli úspešne zosynchronizované.');
            } catch (err) {
                showErrorNotification(`Chyba synchronizácie čakajúcich dát: ${err.message}`);
            } finally {
                if (loaderElement) loaderElement.style.display = 'none';
            }
        } else {
            console.log('syncWithFirebase: Žiadne čakajúce dáta na synchronizáciu.');
        }
    }

    function getDayName(year, month, day) { return new Date(year, month, day).toLocaleDateString('sk-SK', { weekday: 'short' }); }

    function createTable() {
        console.log(`Vytváram tabuľku pre ${getMonthName(currentMonth)} ${currentYear}`);
        if (!workDaysTableBody) { console.error("Element tbody#workDays nebol nájdený!"); return; }
        workDaysTableBody.innerHTML = '';
        
        const daysInMonth = getDaysInMonth(currentMonth);
        if (daysInMonth === 0 || isNaN(daysInMonth)) {
            console.error(`Chyba: Počet dní v mesiaci je neplatný (${daysInMonth}) pre ${getMonthName(currentMonth)}/${currentYear}. Tabuľka sa nevytvorí.`);
            if (totalSalaryDiv) totalSalaryDiv.innerHTML = "Chyba: Neplatný mesiac alebo rok.";
            return;
        }

        const todayFull = new Date();
        const todayDate = todayFull.getDate();
        const todayMonth = todayFull.getMonth();
        const todayYear = todayFull.getFullYear();

        const dataKey = `workData-${currentYear}-${currentMonth}`;
        if (!workDataStore[dataKey] || workDataStore[dataKey].length !== daysInMonth) { // Ak store neexistuje alebo nesedí počet dní
            console.warn(`createTable: WorkDataStore pre ${dataKey} chýba alebo má nesprávny počet dní. Vytváram nový.`);
            workDataStore[dataKey] = createEmptyMonthData();
        }
        const currentMonthData = workDataStore[dataKey];

        for (let i = 1; i <= daysInMonth; i++) {
            const row = workDaysTableBody.insertRow();
            if (i === todayDate && currentMonth === todayMonth && currentYear === todayYear) {
                row.classList.add('current-day');
            }
            const dayNameStr = getDayName(currentYear, currentMonth, i);
            const ids = {
                start: `start-${currentYear}-${currentMonth}-${i}`, end: `end-${currentYear}-${currentMonth}-${i}`,
                break: `break-${currentYear}-${currentMonth}-${i}`,
                noteContainer: `note-container-${currentYear}-${currentMonth}-${i}`,
                note: `note-${currentYear}-${currentMonth}-${i}`,
                noteToggle: `note-toggle-${currentYear}-${currentMonth}-${i}`,
                noteIndicator: `note-indicator-${currentYear}-${currentMonth}-${i}`,
                total: `total-${currentYear}-${currentMonth}-${i}`, gross: `gross-${currentYear}-${currentMonth}-${i}`,
                net: `net-${currentYear}-${currentMonth}-${i}`
            };
            const dayIndex = i - 1;
            const dayData = currentMonthData[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };

            row.innerHTML = `<td>${i}. ${dayNameStr}</td>
                             <td><div class="time-input-wrapper"><input type="tel" id="${ids.start}" value="${dayData.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="window.handleTimeInput(this, '${ids.end}', ${i})"><span class="clock-icon" onclick="window.insertCurrentTime('${ids.start}')" title="Vložiť aktuálny čas">🕒</span></div></td>
                             <td><div class="time-input-wrapper"><input type="tel" id="${ids.end}" value="${dayData.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="window.handleTimeInput(this, '${ids.break}', ${i})"><span class="clock-icon" onclick="window.insertCurrentTime('${ids.end}')" title="Vložiť aktuálny čas">🕒</span></div></td>
                             <td><input type="number" id="${ids.break}" value="${dayData.breakTime}" min="0" step="0.5" placeholder="hod." oninput="window.handleBreakInput(${i})"></td>
                             <td id="${ids.total}">-</td>
                             <td>
                                <div class="note-controls">
                                  <span class="note-indicator-icon" id="${ids.noteIndicator}">📝</span>
                                  <button id="${ids.noteToggle}" class="toggle-note-btn" onclick="window.toggleNote(${i})">${dayData.noteVisible ? 'Skryť' : 'Poznámka'}</button>
                                </div>
                                <div id="${ids.noteContainer}" class="note-container ${dayData.noteVisible ? 'visible' : ''}">
                                  <textarea id="${ids.note}" class="note-textarea-class" placeholder="Poznámka" oninput="window.handleNoteTextAreaInput(this, ${i})" rows="1">${dayData.note}</textarea>
                                </div>
                             </td>
                             <td><input type="number" id="${ids.gross}" readonly></td>
                             <td><input type="number" id="${ids.net}" readonly></td>
                             <td><button class="btn reset-btn" onclick="window.resetRow(${i})">X</button></td>`;
            
            calculateRow(i);
            updateNoteIndicator(i);
        }
        applyDarkModeUIStyling();
        calculateTotal();
    }

    function isValidTimeFormat(timeString) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
    
    function formatAndMoveNext(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, '');
        let originalValue = input.value;
        let cursorPos = input.selectionStart;

        if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) {
            value += ':';
        } else if (value.length === 4 && !value.includes(':')) {
            value = `${value.substring(0, 2)}:${value.substring(2)}`;
        } else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) {
             value = `${value.substring(0, 2)}:${value.substring(2)}`;
        }
        value = value.replace(/^:/, '');
        if ((value.match(/:/g) || []).length > 1) {
            const parts = value.split(':');
            value = `${parts[0]}:${parts.slice(1).join('')}`;
        }
        if (value.length > 5) { value = value.slice(0, 5); }

        if (input.value !== value) {
            input.value = value;
            try {
                if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) {
                    input.setSelectionRange(3, 3);
                } else {
                    input.setSelectionRange(cursorPos, cursorPos);
                }
            } catch (e) { /*ignore*/ }
        }
        const day = parseInt(input.id.split('-')[3], 10);
        if (!isNaN(day)) calculateRow(day); // Pridaná kontrola NaN
        if (value.length === 5 && isValidTimeFormat(value)) {
            if (nextId) { moveNext(input, nextId); }
        }
    }

    function moveNext(currentElement, nextInputId) {
        const nextElement = document.getElementById(nextInputId);
        if (nextElement) {
            nextElement.focus();
            if (nextElement.tagName === 'INPUT' && (nextElement.type === 'tel' || nextElement.type === 'number' || nextElement.type === 'text') ) {
                nextElement.select();
            }
        }
    }
    
    function calculateRow(day) {
        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return;

        const startTime = startInput.value;
        const endTime = endInput.value;
        const breakTimeHours = parseFloat(breakInput.value) || 0;

        if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) {
            totalCell.textContent = '-';
            grossInput.value = (0).toFixed(decimalPlaces);
            netInput.value = (0).toFixed(decimalPlaces);
            return;
        }

        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);

        const startDate = new Date(2000, 0, 1, startHours, startMinutes);
        let endDate = new Date(2000, 0, 1, endHours, endMinutes);
        if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }

        let diffMinutes = (endDate.getTime() - startDate.getTime()) / 60000;
        diffMinutes -= (breakTimeHours * 60);
        if (diffMinutes < 0) { diffMinutes = 0; }

        const decimalHours = diffMinutes / 60;
        const totalMinutesRounded = Math.round(diffMinutes);
        const hours = Math.floor(totalMinutesRounded / 60);
        const minutes = totalMinutesRounded % 60;

        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;
        
        const grossSalary = Math.max(0, decimalHours * hourlyWage);
        grossInput.value = grossSalary.toFixed(decimalPlaces);
        
        const netSalary = Math.max(0, grossSalary * (1 - taxRate));
        netInput.value = netSalary.toFixed(decimalPlaces);
    }

    function _resetRowInternal(day, save = true, promptUser = true) {
        if (promptUser) { if (!confirm("Naozaj chcete vynulovať údaje pre tento deň?")) { return; } }
        _resetRowUIOnly(day);
        const dataKey = `workData-${currentYear}-${currentMonth}`;
        const dayIndex = day - 1;
        if (workDataStore[dataKey] && workDataStore[dataKey][dayIndex]) {
            workDataStore[dataKey][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
        }
        updateNoteIndicator(day);
        calculateRow(day);
        if (save) { window.calculateAndUpdateTotals(); }
    }
    
    function _resetRowUIOnly(day) {
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
        const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`);
        const noteToggleBtn = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`);

        if(start) start.value = '';
        if(end) end.value = '';
        if(breakEl) breakEl.value = '';
        if(noteEl) noteEl.value = '';
        if(noteContainer) noteContainer.classList.remove('visible');
        if(noteToggleBtn) noteToggleBtn.textContent = 'Poznámka';
    }

    function calculateTotal() {
        let totalMinutes = 0; let totalGross = 0; let totalNet = 0; let daysWorked = 0;
        const dataKey = `workData-${currentYear}-${currentMonth}`;
        const currentMonthDaysData = workDataStore[dataKey] || [];
        const daysInCurrentMonth = getDaysInMonth(currentMonth); // Pre kontrolu

        // Ak store nemá správny počet dní, nepočítaj, aby sa predišlo chybám
        if (currentMonthDaysData.length !== daysInCurrentMonth && daysInCurrentMonth > 0) {
             console.warn(`calculateTotal: Počet dní v store (${currentMonthDaysData.length}) nesedí s počtom dní v mesiaci (${daysInCurrentMonth}) pre ${getMonthName(currentMonth)}/${currentYear}. Celkové sumy môžu byť nepresné.`);
             // Možno by bolo lepšie store preinicializovať, ak je to vážny problém, ale to by mohlo stratiť dáta.
             // Pre teraz len vypíšeme varovanie.
        }


        currentMonthDaysData.forEach(dayData => {
            if (dayData && isValidTimeFormat(dayData.start) && isValidTimeFormat(dayData.end)) {
                const [sH, sM] = dayData.start.split(':').map(Number);
                const [eH, eM] = dayData.end.split(':').map(Number);
                const breakTime = parseFloat(dayData.breakTime) || 0;

                const sDate = new Date(2000, 0, 1, sH, sM);
                let eDate = new Date(2000, 0, 1, eH, eM);
                if (eDate < sDate) { eDate.setDate(eDate.getDate() + 1); }

                let diffM = (eDate.getTime() - sDate.getTime()) / 60000 - (breakTime * 60);
                if (diffM < 0) diffM = 0;
                
                const dailyHours = diffM / 60;
                const dailyGross = Math.max(0, dailyHours * hourlyWage);
                const dailyNet = Math.max(0, dailyGross * (1 - taxRate));

                totalMinutes += diffM;
                totalGross += dailyGross;
                totalNet += dailyNet;
                if (diffM > 0) daysWorked++;
            }
        });

        const totalMinutesRounded = Math.round(totalMinutes);
        const totalHours = Math.floor(totalMinutesRounded / 60);
        const totalMinutesRemainder = totalMinutesRounded % 60;
        const totalDecimalHours = totalMinutes / 60;
        const avgNet = daysWorked > 0 ? totalNet / daysWorked : 0;
        const avgMinutes = daysWorked > 0 ? totalMinutes / daysWorked : 0;
        const avgMinutesRounded = Math.round(avgMinutes);
        const avgHours = Math.floor(avgMinutesRounded / 60);
        const avgMinsRemainder = avgMinutesRounded % 60;
        const avgDecimalHours = avgMinutes / 60;

        if (totalSalaryDiv) totalSalaryDiv.innerHTML = `Započítaných dní: ${daysWorked}<br>Celkový čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>Hrubá mzda: ${totalGross.toFixed(decimalPlaces)} €<br>Čistá mzda: ${totalNet.toFixed(decimalPlaces)} €<br>Priem. čistá mzda/deň: ${avgNet.toFixed(decimalPlaces)} €<br><strong>Priem. čas/deň: ${avgHours}h ${avgMinsRemainder}m (${avgDecimalHours.toFixed(decimalPlaces)} h)</strong>`;
    }

    function getMonthName(monthIndex) {
        const months = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
        if (typeof monthIndex === 'number' && monthIndex >= 0 && monthIndex <= 11) {
            return months[monthIndex];
        }
        console.warn(`getMonthName called with invalid index: ${monthIndex}`);
        return "";
    }

    function getDaysInMonth(month) {
        if (typeof currentYear !== 'number' || isNaN(currentYear) ||
            typeof month !== 'number' || isNaN(month) || month < 0 || month > 11) {
            console.warn(`getDaysInMonth: Invalid month (${month}) or year (${currentYear}). Returning 0 days.`);
            return 0;
        }
        return new Date(currentYear, month + 1, 0).getDate();
    }

    function applyDarkMode(isDarkValue) {
        isDarkMode = isDarkValue;
        document.body.classList.toggle('dark-mode', isDarkMode);
        applyDarkModeUIStyling();
    }

    function applyDarkModeUIStyling() {
        const elementsToToggle = [
            ...document.querySelectorAll('.current-day input, .current-day select, .current-day textarea, .current-day .toggle-note-btn, .current-day .clock-icon, .current-day .note-indicator-icon')
        ];
        elementsToToggle.forEach(el => el?.classList.toggle('dark-mode', isDarkMode));
        
        // Pre istotu, ak by .current-day nebola správne nastylovaná len cez CSS premenné
        document.querySelectorAll('.current-day').forEach(row => {
            row.classList.toggle('dark-mode', isDarkMode);
        });
    }

    window.toggleDarkMode = () => {
        isDarkMode = !isDarkMode;
        applyDarkMode(isDarkMode);
        saveGlobalSettingsToLocalStorage();
        debouncedSaveToFirestore();
    };

    window.toggleNote = (day) => {
        const container = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`);
        const button = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`);
        if (container && button) {
            const isVisible = container.classList.toggle('visible');
            button.textContent = isVisible ? 'Skryť' : 'Poznámka';

            const dataKey = `workData-${currentYear}-${currentMonth}`;
            const dayIndex = day - 1;
            if (workDataStore[dataKey] && workDataStore[dataKey][dayIndex]) {
                workDataStore[dataKey][dayIndex].noteVisible = isVisible;
                window.calculateAndUpdateTotals();
            }
        }
    };

    function updateNoteIndicator(day) {
        const noteTextarea = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
        const indicatorIcon = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);
        if (noteTextarea && indicatorIcon) {
            const hasContent = noteTextarea.value.trim() !== '';
            indicatorIcon.style.display = hasContent ? 'inline-block' : 'none';
        }
    }
    
    window.handleNoteTextAreaInput = (textarea, day) => {
        updateWorkDataStoreFromUI(day, 'note', textarea.value);
        updateNoteIndicator(day);
        window.calculateAndUpdateTotals();
    };

    function updateDataSize() {
        try {
            let totalBytes = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                if (key && value) {
                    totalBytes += (key.length * 2) + (value.length * 2);
                }
            }
            const kilobytes = (totalBytes / 1024).toFixed(2);
            const percentageUsed = Math.min(((parseFloat(kilobytes) / MAX_LOCAL_STORAGE_SIZE_KB) * 100), 100);

            if (dataSizeTextElement) dataSizeTextElement.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_LOCAL_STORAGE_SIZE_KB} KB`;
            if (dataSizeFillElement) {
                dataSizeFillElement.style.width = `${percentageUsed}%`;
                if (percentageUsed > 90) dataSizeFillElement.style.backgroundColor = 'var(--datasize-fill-bad)';
                else if (percentageUsed > 70) dataSizeFillElement.style.backgroundColor = 'var(--datasize-fill-warn)';
                else dataSizeFillElement.style.backgroundColor = 'var(--datasize-fill-good)';
            }
        } catch (error) {
            console.error("Chyba pri výpočte veľkosti localStorage:", error);
            if (dataSizeTextElement) dataSizeTextElement.textContent = "Chyba pri výpočte veľkosti dát.";
        }
    }
    
    window.login = async () => {
        console.log("Login attempt started...");
        if (!isOnline()) return showErrorNotification('Ste offline.');
        const e_input = document.getElementById('email');
        const p_input = document.getElementById('password');
        if (!e_input || !p_input) { console.error("Login form elements not found"); return; }
        const e = e_input.value;
        const p = p_input.value;

        if (!e || !p) return showErrorNotification('Zadajte email a heslo.');
        try {
            const userCredential = await signInWithEmailAndPassword(auth, e, p);
            console.log("Login successful:", userCredential.user);
        } catch (err) {
            console.error("Login error details:", err);
            showErrorNotification(`Chyba prihlásenia: ${mapFirebaseAuthError(err.code)} (${err.message})`);
        }
    };
    window.register = async () => {
        console.log("Register attempt started...");
        if (!isOnline()) return showErrorNotification('Ste offline.');
        const e_input = document.getElementById('email');
        const p_input = document.getElementById('password');
        if (!e_input || !p_input) { console.error("Register form elements not found"); return; }
        const e = e_input.value;
        const p = p_input.value;
        if (!e || !p) return showErrorNotification('Zadajte email a heslo.');
        if (p.length < 6) return showErrorNotification('Heslo musí mať aspoň 6 znakov.');
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, e, p);
            console.log("Registration successful:", userCredential.user);
            await createUserCollection();
        } catch (err) {
            console.error("Registration error details:", err);
            showErrorNotification(`Chyba registrácie: ${mapFirebaseAuthError(err.code)} (${err.message})`);
        }
    };
    window.logout = async () => {
        if (!confirm("Ste si istí, že sa chcete odhlásiť?")) return;
        if (firestoreListenerUnsubscribe) {
            console.log('Odhlasujem Firestore listener pri odhlásení používateľa.');
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }
        try {
            await signOut(auth);
            currentUser = null;
            workDataStore = {}; 
            // onAuthStateChanged sa postará o zvyšok UI
        } catch (err) {
            console.error("Logout error:", err);
            showErrorNotification(`Chyba odhlásenia: ${err.message}`);
        }
    };
    window.resetPassword = async () => {
        if (!isOnline()) return showErrorNotification('Ste offline.');
        const eInput = document.getElementById('email');
        if (!eInput) { console.error("Email input for password reset not found"); return; }
        const email = eInput.value;
        if (!email) { 
            if(eInput) { eInput.style.border = '1px solid red'; setTimeout(() => { if(eInput) eInput.style.border = '1px solid var(--input-border)'; }, 3000); }
            return showErrorNotification('Zadajte email.'); 
        }
        if(eInput) eInput.style.border = '1px solid var(--input-border)';
        try {
            await sendPasswordResetEmail(auth, email);
            showSaveNotification(`Email na obnovu hesla bol odoslaný na ${email}.`);
        } catch (err) {
            console.error("Password reset error:", err);
            showErrorNotification(`Chyba obnovy hesla: ${mapFirebaseAuthError(err.code)}`);
        }
    };
    
    window.changeMonth = () => {
        currentMonth = parseInt(monthSelect.value, 10);
        saveGlobalSettingsToLocalStorage();
        updateGreeting();
        if (workDaysTableBody) workDaysTableBody.innerHTML = '';
        createTable(); 
        setupFirestoreListener();
    };
    window.changeYear = () => {
        currentYear = parseInt(yearSelect.value, 10);
        saveGlobalSettingsToLocalStorage();
        updateGreeting();
        if (workDaysTableBody) workDaysTableBody.innerHTML = '';
        createTable();
        setupFirestoreListener();
    };

    window.insertCurrentTime = (inputId) => { const inputElement = document.getElementById(inputId); if (inputElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); inputElement.value = `${hours}:${minutes}`; const day = parseInt(inputId.split('-')[3], 10); if (!isNaN(day)) { window.handleTimeInput(inputElement, '', day); } }};
    
    function updateWorkDataStoreFromUI(day, field, value) {
        const dataKey = `workData-${currentYear}-${currentMonth}`;
        const dayIndex = day - 1;
        if (!workDataStore[dataKey]) workDataStore[dataKey] = createEmptyMonthData();
        
        // Uisti sa, že pole pre tento deň existuje
        if (!workDataStore[dataKey][dayIndex]) {
             workDataStore[dataKey][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
        }
        workDataStore[dataKey][dayIndex][field] = value;
    }

    window.handleTimeInput = (input, nextId, day) => {
        formatAndMoveNext(input, nextId);
        const field = input.id.startsWith('start-') ? 'start' : 'end';
        updateWorkDataStoreFromUI(day, field, input.value);
        // calculateRow(day); // Už je volané vo formatAndMoveNext
        window.calculateAndUpdateTotals();
    };

    window.handleBreakInput = (day) => {
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if (breakInput) {
            let breakValue = parseFloat(breakInput.value);
            if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; breakValue = 0; } // Oprava UI
            updateWorkDataStoreFromUI(day, 'breakTime', breakInput.value);
        }
        calculateRow(day);
        window.calculateAndUpdateTotals();
    };
    
    window.calculateAndUpdateTotals = () => {
        calculateTotal();
        debouncedSaveToFirestore();
    };

    window.resetRow = (day) => { _resetRowInternal(day, true, true); };

    window.loadFromFirestore = async () => { 
        if (!currentUser) return showErrorNotification('Pre obnovenie z cloudu sa musíte prihlásiť.');
        if (!isOnline()) return showErrorNotification('Ste offline. Skúste obnoviť neskôr, keď budete online.');
        if (!confirm('Naozaj chcete manuálne obnoviť dáta z cloudu a znova načítať sledovanie zmien?')) return;
        console.log("Manuálne obnovenie dát z Firebase a znovunastavenie listenera.");
        if (workDaysTableBody && !workDaysTableBody.hasChildNodes() && (typeof currentMonth === 'number' && !isNaN(currentMonth) && typeof currentYear === 'number' && !isNaN(currentYear))) {
             console.log("loadFromFirestore: Table is empty, calling createTable().");
             createTable();
        }
        await setupFirestoreListener();
    };
    
    window.updateEmployeeName = () => {
        if(!employeeNameInput) return;
        employeeName = employeeNameInput.value.trim();
        saveGlobalSettingsToLocalStorage();
        updateGreeting();
        window.calculateAndUpdateTotals();
    };
    window.updateSettings = () => {
        if(!hourlyWageInput || !taxRateInput) return;
        const oldHourlyWage = hourlyWage;
        const oldTaxRate = taxRate;

        const wageValue = hourlyWageInput.value;
        const taxValue = taxRateInput.value;

        if (wageValue === "") { hourlyWage = 0; }
        else { const newWage = parseFloat(wageValue); if (!isNaN(newWage) && newWage >= 0) { hourlyWage = newWage; } else { hourlyWageInput.value = oldHourlyWage.toFixed(1); } }

        if (taxValue === "") { taxRate = 0; }
        else { const newTaxPercent = parseFloat(taxValue); if (!isNaN(newTaxPercent) && newTaxPercent >= 0 && newTaxPercent <=100) { taxRate = newTaxPercent / 100; } else { taxRateInput.value = (oldTaxRate * 100).toFixed(1); } }

        if (hourlyWage !== oldHourlyWage || taxRate !== oldTaxRate) {
            saveGlobalSettingsToLocalStorage();
            for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
                if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); }
            }
            window.calculateAndUpdateTotals();
        }
    };
    window.changeDecimalPlaces = () => {
        if(!decimalPlacesSelect) return;
        const oldDecimalPlaces = decimalPlaces;
        decimalPlaces = parseInt(decimalPlacesSelect.value, 10);
        if (decimalPlaces !== oldDecimalPlaces) {
            saveGlobalSettingsToLocalStorage();
            for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
                if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); }
            }
            window.calculateAndUpdateTotals();
        }
    };

    window.exportToPDF = () => { 
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); 
            doc.setFont('Roboto'); 
            doc.setFontSize(16); 
            doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); 
            doc.setFontSize(12); 
            doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30);
            
            const tableData = [];
            const dataKey = `workData-${currentYear}-${currentMonth}`;
            const currentMonthDaysData = workDataStore[dataKey] || [];

            currentMonthDaysData.forEach((dayData, index) => {
                const dayNum = index + 1;
                if (dayData && (isValidTimeFormat(dayData.start) || isValidTimeFormat(dayData.end) || dayData.note)) { // Ak je aspoň nejaký relevantný údaj
                    let totalTimeStr = '-';
                    let grossSal = 0;
                    let netSal = 0;

                    if (isValidTimeFormat(dayData.start) && isValidTimeFormat(dayData.end)) {
                        const [sH, sM] = dayData.start.split(':').map(Number);
                        const [eH, eM] = dayData.end.split(':').map(Number);
                        const breakTime = parseFloat(dayData.breakTime) || 0;
                        const sDate = new Date(2000,0,1,sH,sM);
                        let eDate = new Date(2000,0,1,eH,eM);
                        if(eDate < sDate) eDate.setDate(eDate.getDate()+1);
                        let diffM = (eDate.getTime() - sDate.getTime()) / 60000 - (breakTime * 60);
                        if(diffM < 0) diffM = 0;
                        const decHours = diffM / 60;
                        const h = Math.floor(decHours);
                        const m = Math.round((decHours - h) * 60);
                        totalTimeStr = `${h}h ${m}m (${decHours.toFixed(decimalPlaces)} h)`;
                        grossSal = Math.max(0, decHours * hourlyWage);
                        netSal = Math.max(0, grossSal * (1 - taxRate));
                    }

                    tableData.push([
                        `${dayNum}. ${getDayName(currentYear, currentMonth, dayNum)}`,
                        dayData.start || '-', dayData.end || '-', dayData.breakTime || '0',
                        totalTimeStr,
                        dayData.note || '',
                        `${grossSal.toFixed(decimalPlaces)} €`,
                        `${netSal.toFixed(decimalPlaces)} €`
                    ]);
                }
            });
            doc.autoTable({ 
                head:[['Deň','Príchod','Odchod','Prestávka (h)','Odpracované', 'Poznámky', 'Hrubá Mzda','Čistá Mzda']], 
                body:tableData, startY:38, theme:'grid', 
                styles:{font:'Roboto',fontSize:9,cellPadding:2,valign:'middle'}, 
                headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:10,halign:'center'}, 
                alternateRowStyles:{fillColor:[245,245,245]}, 
                columnStyles:{ 
                    0: { cellWidth: 15, halign: 'left' }, 1: { cellWidth: 17, halign: 'center' }, 
                    2: { cellWidth: 17, halign: 'center' }, 3: { cellWidth: 12, halign: 'center' }, 
                    4: { cellWidth: 35, halign: 'center' }, 5: { cellWidth: 28, halign: 'left' }, 
                    6: { cellWidth: 28, halign: 'right' }, 7: { cellWidth: 30, halign: 'right' } 
                } 
            }); 
            const finalY = doc.lastAutoTable.finalY + 10; 
            doc.setFontSize(11); 
            const totalText = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi,'\n').replace(/<\/?strong>/gi,'').replace(/  +/g,' ').replace(/€/g,' EUR'); 
            doc.text(totalText, 14, finalY); 
            const nameForFile = employeeName || 'Nezadane'; 
            const safeName = nameForFile.replace(/[^a-zA-Z0-9ÁáÄäČčĎďÉéÍíĹĺĽľŇňÓóÔôŔŕŠšŤťÚúÝýŽž\s-]/g, '').replace(/\s+/g, '_'); 
            const finalSafeName = safeName || 'Nezadane'; 
            doc.save(`Vykaz_prace_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`); 
            showSaveNotification("PDF výkaz bol úspešne vygenerovaný.");
        } catch(err) { showErrorNotification(`Chyba pri exporte do PDF: ${err.message}`); console.error("PDF Export Error:", err); }
    };
    window.sendPDF = () => { /* Implementácia podobná exportToPDF, ale pre zdieľanie/stiahnutie jednoduchšej verzie */ };
    window.restoreBackup = () => { 
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json'; // Ak záloha je JSON z collectCurrentDataForSaving
        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (backupData && backupData.days && backupData.settings) {
                        if (!confirm(`Naozaj chcete obnoviť dáta zo zálohy? Aktuálne dáta pre ${getMonthName(currentMonth)} ${currentYear} budú prepísané.`)) return;
                        
                        // Aplikuj globálne nastavenia zo zálohy
                        hourlyWage = parseFloat(backupData.settings.hourlyWage) ?? hourlyWage;
                        taxRate = parseFloat(backupData.settings.taxRate) ?? taxRate;
                        employeeName = String(backupData.settings.employeeName ?? employeeName);
                        decimalPlaces = parseInt(backupData.settings.decimalPlaces, 10) ?? decimalPlaces;
                        isDarkMode = backupData.settings.isDarkMode ?? isDarkMode;
                        saveGlobalSettingsToLocalStorage(); // Ulož ich do LS

                        // Aplikuj dáta dní
                        const dataKey = `workData-${currentYear}-${currentMonth}`;
                        workDataStore[dataKey] = backupData.days;
                        
                        // Aktualizuj UI
                        loadGlobalSettingsFromLocalStorage(); // Pre istotu načíta a aplikuje globálne nastavenia na UI
                        if(workDaysTableBody) workDaysTableBody.innerHTML = ''; // Vyčisti tabuľku
                        createTable(); // Vykresli tabuľku s novými dátami
                        calculateTotal(); // Prepočítaj súčty
                        
                        showSaveNotification('Dáta boli úspešne obnovené zo zálohy.');
                        debouncedSaveToFirestore(); // Ulož do Firebase
                    } else {
                        showErrorNotification('Súbor zálohy má nesprávny formát.');
                    }
                } catch (err) {
                    showErrorNotification(`Chyba pri obnove dát zo zálohy: ${err.message}`);
                    console.error("Restore Backup Error:", err);
                }
            };
            reader.onerror = () => { showErrorNotification('Nastala chyba pri čítaní súboru.'); };
            reader.readAsText(file);
        };
        fileInput.click();
    };
    window.createBackup = () => { 
        const backupData = collectCurrentDataForSaving();
        // Odstránime serverTimestamp, lebo to nie je serializovateľné priamo do JSON pre stiahnutie
        delete backupData.lastUpdated; 
        backupData.clientTimestamp = new Date().toISOString(); // Pridáme klientsky timestamp

        const blob = new Blob([JSON.stringify(backupData, null, 2)], {type : 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const nameForFile = employeeName || 'Nezadane';
        const safeName = nameForFile.replace(/[^a-zA-Z0-9ÁáÄäČčĎďÉéÍíĹĺĽľŇňÓóÔôŔŕŠšŤťÚúÝýŽž\s-]/g, '').replace(/\s+/g, '_');
        a.download = `Dochadzka_Zaloha_${safeName}_${getMonthName(currentMonth)}_${currentYear}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSaveNotification('Záloha bola úspešne vytvorená.');
    };

    // Hlavná inicializačná funkcia aplikácie
    function initializeAppState() {
        console.log("initializeAppState called");
        if (loaderElement) loaderElement.style.display = 'flex';

        populateYearSelect();
        loadGlobalSettingsFromLocalStorage();

        onAuthStateChanged(auth, (user) => {
            console.log("onAuthStateChanged - user:", user ? user.uid : 'žiadny používateľ');
            const previousUserUID = currentUser ? currentUser.uid : null;
            currentUser = user;

            if (workDaysTableBody) workDaysTableBody.innerHTML = '';
            
            if (loginFormElement) loginFormElement.style.display = 'none';
            if (userInfoElement) userInfoElement.style.display = 'none';
            if (userEmailElement) userEmailElement.textContent = '';
            
            if (typeof currentMonth !== 'number' || isNaN(currentMonth) || typeof currentYear !== 'number' || isNaN(currentYear)) {
                console.warn("onAuthStateChanged: currentMonth/Year not valid, reloading global settings.");
                loadGlobalSettingsFromLocalStorage();
                if (typeof currentMonth !== 'number' || isNaN(currentMonth) || typeof currentYear !== 'number' || isNaN(currentYear)) {
                    if(loaderElement) loaderElement.textContent = "Kritická chyba inicializácie. Obnovte stránku.";
                    console.error("CRITICAL: Month/Year still invalid after re-load in onAuthStateChanged.");
                    return; 
                }
            }
            console.log(`onAuthStateChanged: Calling createTable for ${getMonthName(currentMonth)}/${currentYear}`);
            createTable();

            if (currentUser) {
                if (userInfoElement) userInfoElement.style.display = 'flex';
                if (userEmailElement) userEmailElement.textContent = `Prihlásený: ${currentUser.email}`;
                console.log("Používateľ prihlásený, nastavujem Firestore listener.");
                setupFirestoreListener();
            } else {
                if (firestoreListenerUnsubscribe) {
                    console.log('Používateľ nie je prihlásený / odhlásil sa, odhlasujem Firestore listener.');
                    firestoreListenerUnsubscribe();
                    firestoreListenerUnsubscribe = null;
                }
                if (loginFormElement) loginFormElement.style.display = 'flex';
                console.log("Používateľ nie je prihlásený, načítavam len z lokálneho úložiska.");
                loadFromLocalStorageOnly();
                if (!isOnline()) {
                     showErrorNotification('Ste offline. Niektoré funkcie môžu byť obmedzené.');
                }
            }
            updateGreeting();
            updateDataSize();

            if (!currentUser && !firestoreListenerUnsubscribe && loaderElement) {
                loaderElement.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeAppState();
        // Service Worker message listener
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
              if (event.data && event.data.type === 'TRIGGER_SYNC_FROM_SW') {
                console.log('Main App: Prijatá správa TRIGGER_SYNC_FROM_SW od Service Workera.');
                if (isOnline() && currentUser) {
                  showStatusNotification('Synchronizácia dát spustená na pozadí Service Workerom...', '#007bff');
                  syncWithFirebase().catch(err => {
                     console.error('Automatická synchronizácia vyvolaná SW zlyhala:', err);
                  });
                } else {
                  console.log('Main App: Podmienky pre synchronizáciu (online & prihlásený) nie sú splnené po správe od SW.');
                }
              }
            });
        }
    });

    // PWA inštalačná logika
    let deferredPrompt;
    const installButtonContainer = document.querySelector('.btn-container'); 
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('beforeinstallprompt udalosť zachytená');
        e.preventDefault();
        deferredPrompt = e;
        const installButtonId = 'installAppButton';
        let installButton = document.getElementById(installButtonId);

        if (!installButton && installButtonContainer) { // Pridaj len ak neexistuje a kontajner je nájdený
            installButton = document.createElement('button');
            installButton.id = installButtonId;
            installButton.classList.add('btn'); // Použi existujúcu triedu pre štýl
            installButton.textContent = 'Nainštalovať Dochádzku';
            
            // Skús vložiť za "Vytvoriť zálohu" alebo na koniec
            const backupButton = Array.from(installButtonContainer.children).find(btn => btn.textContent.includes("Vytvoriť zálohu"));
            if (backupButton && backupButton.nextSibling) {
               installButtonContainer.insertBefore(installButton, backupButton.nextSibling);
            } else if (backupButton) {
               installButtonContainer.appendChild(installButton);
            }
            else { 
               installButtonContainer.appendChild(installButton); // Ak sa nenájde backup button, pridaj na koniec
            }
            console.log('Inštalačné tlačidlo pridané.');
        } else if (installButton) {
            installButton.style.display = 'flex'; // Uisti sa, že je viditeľné, ak už existuje
        }


        if(installButton) { // Ak tlačidlo existuje (bolo pridané alebo už existovalo)
            installButton.onclick = async () => {
                console.log('Kliknuté na inštalačné tlačidlo');
                if (deferredPrompt) {
                    installButton.style.display = 'none';
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Odpoveď na inštaláciu: ${outcome}`);
                    deferredPrompt = null;
                } else {
                    console.log('deferredPrompt nie je dostupný.');
                }
            };
        }
    });
    window.addEventListener('appinstalled', () => {
        console.log('PWA bola nainštalovaná');
        const installButton = document.getElementById('installAppButton');
        if (installButton) {
            installButton.style.display = 'none';
        }
        deferredPrompt = null; // Resetuj deferredPrompt
    });

  </script>

  <script>
    // Service Worker registrácia
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
          .then(registration => {
            console.log('ServiceWorker registrácia úspešná, scope: ', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker registrácia zlyhala: ', error);
          });
      });
    }
  </script>
</body>
</html>
