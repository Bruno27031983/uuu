<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>
  <link rel="manifest" href="./manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    /* Základné štýly - bez zmien okrem h1 */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    /* --- ZMENENÝ ŠTÝL PRE h1 --- */
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black; /* Statická čierna farba */
      /* Odstránené: background, background-clip, -webkit-background-clip, animation */
      margin-bottom: 10px;
    }
    /* --- KONIEC ZMENY PRE h1 --- */

    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      /* Zmenené: zarovnanie na začiatok pre lepšie zobrazenie tlačidla */
      align-items: flex-start;
      /* Odstránené justify-content, flex riadi šírku */
    }
    /* --- ÚPRAVA PRE TESNEJŠIE ROZLOŽENIE --- */
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
       /* Aplikujeme margin na všetky priame deti .settings */
      margin: 2px 5px;
    }
    .settings > div {
      flex: 1 1 200px; /* Ponecháme flex pre input divy */
    }
     /* Tlačidlá v settings majú pevnú šírku alebo sa prispôsobia obsahu */
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%; /* Tlačidlo na rozbalenie zaberie celú šírku */
      margin-bottom: 10px; /* Väčší odstup pod tlačidlom */
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px 12px;
    }
    body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
    }
     .settings > button.highlight {
       /* Ponecháme flex: 1 1 150px; ako bolo definované v .btn */
       flex: 1 1 150px;
       /* Prípadne pevná šírka */
       /* width: auto; */
       /* min-width: 150px; */
     }


    .settings label {
      display: block;
      margin-bottom: 2px; /* Zmenšený margin pod labelom (bol 5px) */
    }
    /* --- KONIEC ÚPRAVY PRE TESNEJŠIE ROZLOŽENIE --- */

    /* --- NOVÉ ŠTÝLY PRE SKRÝVANIE --- */
    #settings-collapsible-content {
        display: flex; /* Použijeme flex pre vnútorné elementy */
        flex-wrap: wrap; /* Umožní zalamovanie */
        width: 100%; /* Zaberie celú šírku */
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
        /* Odstránené justify-content, flex na deťoch to riadi */
    }
    #settings-collapsible-content.visible {
        max-height: 400px; /* Dostatočne veľká hodnota, upravte podľa potreby */
        opacity: 1;
        /* Pridáme malý odstup zhora, keď je viditeľný */
        margin-top: 5px;
    }
    #settings-collapsible-content > div {
         flex: 1 1 200px; /* Zachováme flex pre vnútorné divy */
         margin: 2px 5px; /* Zachováme marginy */
    }
     /* --- KONIEC NOVÝCH ŠTÝLOV PRE SKRÝVANIE --- */

    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px; /* Môže byť potrebné zväčšiť kvôli ikonám */
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      /* --- NOVÉ: Pozicovanie pre ikony --- */
      position: relative;
    }
    th {
      background-color: #f2f2f2;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) {
      width: 25%;
    }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(2), td:nth-child(2), /* ZMENA ŠÍRKY */
    th:nth-child(3), td:nth-child(3), /* ZMENA ŠÍRKY */
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8) {
      width: 10%; /* Upravená šírka pre Príchod/Odchod */
    }
    /* Štýly pre inputy a select */
    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }
     /* --- NOVÉ: Úprava paddingu pre tel inputy kvôli ikone --- */
    input[type="tel"] {
      padding-right: 28px; /* Priestor pre ikonu */
    }

    /* --- NOVÉ: Štýly pre ikonu hodín --- */
    .time-icon {
        position: absolute;
        right: 8px; /* Odsadenie od pravého okraja bunky */
        top: 50%;
        transform: translateY(-50%); /* Vertikálne centrovanie */
        cursor: pointer;
        font-size: 1.2em; /* Veľkosť ikony */
        color: #555; /* Farba ikony */
        user-select: none; /* Zabráni označeniu textu ikony */
        z-index: 2; /* Aby bola nad inputom, ak by sa prekrývali */
    }
    .time-icon:hover {
        color: #007bff; /* Zmena farby pri prejdení myšou */
        opacity: 0.8;
    }
    body.dark-mode .time-icon {
        color: #bbb; /* Svetlejšia ikona v tmavom režime */
    }
     body.dark-mode .time-icon:hover {
        color: #87cefa; /* Svetlomodrá pri hover v tmavom režime */
    }
    /* --- KONIEC nových štýlov pre ikonu --- */


    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    /* Opravený tmavý režim: selektory sa teraz vzťahujú na prvky v rámci body.dark-mode */
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    /* --- ŠTÝL PRE h1 V TMAVOM REŽIME --- */
    body.dark-mode h1 {
        color: #f4f4f4; /* Svetlá farba pre tmavý režim */
    }
    /* --- KONIEC ŠTÝLU PRE h1 V TMAVOM REŽIME --- */
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select { /* Pridaný select */
      background-color: #666;
      color: white;
      border-color: #555; /* Trochu tmavší okraj pre kontrast */
    }
    body.dark-mode .btn {
      color: #f4f4f4; /* Svetlejší text na tmavých tlačidlách */
    }
    body.dark-mode .reset-btn {
      background-color: #d32f2f;
    }
    body.dark-mode .export-btn {
      background-color: #388e3c;
    }
    body.dark-mode .backup-btn {
      background-color: #6a1bb2;
    }
    body.dark-mode #totalSalary {
      background-color: #2c3e50;
    }
    body.dark-mode .current-day {
      background-color: #4a0e8f;
      color: #fff;
    }
    body.dark-mode .current-day input {
      background-color: #5c1db3;
      color: #fff;
    }
    /* Odstránené animácie, lebo už nie sú potrebné */

    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.8em;
      }
      h2 {
        font-size: 1em;
      }
      .settings {
        flex-direction: column; /* Toto už je, ale potvrdzujeme */
        align-items: stretch; /* Zarovnáme položky na šírku */
      }
      .settings > div {
        flex-basis: auto; /* Resetujeme flex-basis pre vnútorné divy */
        width: 100%; /* Všetky divy na 100% šírky */
        margin: 5px 0; /* Upravený margin pre mobilné zobrazenie */
      }
       .settings > button#toggleSettingsBtn {
           flex-basis: auto; /* Reset */
           width: 100%;
           margin-bottom: 10px;
       }
       .settings > button.highlight {
           flex-basis: auto; /* Reset */
           width: 100%;
           margin: 5px 0;
       }
       /* Vnútro collapsible kontajnera na mobiloch */
       #settings-collapsible-content {
            flex-direction: column; /* Pod sebou */
            align-items: stretch;
       }
       #settings-collapsible-content > div {
           flex-basis: auto;
           width: 100%; /* Každý input na 100% šírky */
           margin: 5px 0;
       }
       #settings-collapsible-content.visible {
           max-height: 600px; /* Zvýšená max-height pre mobil */
       }


      table {
        min-width: 800px; /* Ponechávame dostatočnú šírku */
      }
      th, td {
        padding: 6px;
        font-size: 0.8em;
      }
       /* --- Mobilné úpravy pre ikonu --- */
       input[type="tel"] {
          padding-right: 25px; /* Trochu menej paddingu na mobile */
       }
      .time-icon {
          right: 5px;
          font-size: 1.1em;
      }
      /* --- Koniec mobilných úprav pre ikonu --- */

      .btn-container {
        flex-direction: column;
        align-items: stretch;
      }
      .btn {
        flex: 1 1 auto;
        font-size: 14px;
        padding: 8px 16px;
        margin: 5px 0;
      }
      .backup-btn {
        padding: 15px 16px;
      }
      #totalSalary {
        font-size: 16px;
      }
      #dataSizeContainer {
        font-size: 12px;
      }
      .table-container {
        overflow-x: auto;
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }
      th, td {
        font-size: 0.7em;
      }
      .btn {
        font-size: 12px;
        padding: 6px 12px;
      }
      .backup-btn {
        padding: 15px 12px;
      }
      .settings label {
        font-size: 0.9em;
      }
      input[type="tel"], input[type="number"], input[type="text"], select { /* Pridaný select */
        font-size: 12px;
      }
       /* --- Najmenšie obrazovky - ikona --- */
      input[type="tel"] {
          padding-right: 22px;
      }
      .time-icon {
          right: 4px;
          font-size: 1em;
      }
       /* --- Koniec úprav pre najmenšie obrazovky --- */

      table {
        min-width: 800px; /* Stále treba scrollovať */
      }
      /* Oprava pre najmenšie obrazovky, aby tlačidlá mali nejaký margin */
       .settings > button#toggleSettingsBtn,
       .settings > button.highlight {
           margin: 5px 0;
       }
       #settings-collapsible-content > div {
          margin: 5px 0;
       }
       #settings-collapsible-content.visible {
           max-height: 700px; /* Ešte väčšia výška pre istotu */
       }

    }
    #saveNotification, #errorNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show {
      display: block;
      opacity: 1;
    }
    #saveNotification {
      background-color: #4CAF50;
      color: white;
    }
    #errorNotification {
      background-color: #f44336;
      color: white;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 200px;
      margin: 5px auto;
      display: block;
    }
    #login-form .btn {
      width: 120px;
      margin: 5px 2px;
    }
    /* --- NOVÝ ŠTÝL pre odkaz na obnovu hesla --- */
    #login-form a {
        margin-top: 10px;
        display: block;
        font-size: 0.9em;
        color: #007bff; /* Modrá farba odkazu */
        text-decoration: none;
    }
    #login-form a:hover {
        text-decoration: underline;
    }
    body.dark-mode #login-form a {
        color: #6bbaff; /* Svetlejšia modrá v tmavom režime */
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>
<h1 id="mainTitle">Ahoj</h1> <h2></h2><div class="settings">
  <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button>

  <div id="settings-collapsible-content">
      <div>
        <label for="employeeNameInput">Meno pracovníka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()">
          </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
  </div> <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button></div> <div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Deň</th>
        <th>Príchod</th>
        <th>Odchod</th>
        <th>Prestávka</th>
        <th>Odpracované</th>
        <th>Hrubá Mzda (€)</th>
        <th>Čistá Mzda (€)</th>
        <th>Akcia</th>
      </tr>
    </thead>
    <tbody id="workDays">
      </tbody>
  </table></div><div id="totalSalary"></div><div class="btn-container">
  <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
  <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button> <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
  <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
  <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button></div>
content_copy
download
Use code with caution.
  </div>
  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>
  <script type="module">
    // Načítanie preferencie tmavého režimu z localStorage
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    // Funkcia pre prepínanie tmavého režimu
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    // --- ZMENA: Pridaný import sendPasswordResetEmail ---
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    const firebaseConfig = {
       apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Pozor: Odporúča sa nenechávať API kľúč takto verejne v kóde
       authDomain: "uuuuu-f7ef9.firebaseapp.com",
       projectId: "uuuuu-f7ef9",
       storageBucket: "uuuuu-f7ef9.firebasestorage.app",
       messagingSenderId: "456105865458",
       appId: "1:456105865458:web:101f0a4dcb455f174b606b",
     };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
       provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Pozor: Verejný kľúč ReCaptcha
       isTokenAutoRefreshEnabled: true
     });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------------------- GLOBÁLNE PREMENNÉ --------------------
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    // --- NOVÉ / UPRAVENÉ: Referencie pre collapsible časť ---
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');


    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || ''; // Načítanie mena z localStorage
    let hourlyWage = parseFloat(hourlyWageInput.value) || 10; // Default hodnota
    let taxRate = (parseFloat(taxRateInput.value) || 2) / 100; // Default hodnota
    let monthData = {}; // Toto sa už nepoužíva na priame načítanie, ale môže slúžiť na iné účely

    // --- UPRAVENÁ FUNKCIA: Funkcia na aktualizáciu nadpisu (zobrazí len prvé meno) ---
    function updateGreeting() {
      if (employeeName) {
        // --- ZMENA: Zobrazenie len prvého mena ---
        const firstName = employeeName.split(' ')[0]; // Rozdelí meno podľa medzery a vezme prvú časť
        mainTitle.textContent = `Ahoj ${firstName}`; // Použije len prvé meno v pozdrave
        // --- KONIEC ZMENY ---
      } else {
        mainTitle.textContent = 'Ahoj'; // Predvolený text, ak meno nie je zadané
      }
    }
    // --- KONIEC UPRAVENEJ FUNKCIE ---


    // -------------------- FUNKCIE PRE ROKY (select) --------------------
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = 2030;
      yearSelect.innerHTML = ''; // Vyčistíme pre prípad opakovaného volania
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear; // Nastavíme aktuálny rok ako vybraný
    }
    populateYearSelect();

    // Nastavenie predvolených hodnôt selectov a inputov na základe globálnych premenných
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName; // Nastavenie inputu podľa načítaného mena
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1); // Zobrazíme percento

    // --- Zavolať funkciu pri štarte na nastavenie počiatočného nadpisu ---
    updateGreeting();

    // --- NOVÝ KÓD PRE SKRÝVANIE NASTAVENÍ ---
    if (toggleSettingsBtn && settingsCollapsibleContent) {
        toggleSettingsBtn.addEventListener('click', () => {
            const isVisible = settingsCollapsibleContent.classList.toggle('visible');
            if (isVisible) {
                toggleSettingsBtn.textContent = 'Skryť nastavenia ▲';
            } else {
                toggleSettingsBtn.textContent = 'Zobraziť nastavenia ▼';
            }
        });
    }
    // --- KONIEC NOVÉHO KÓDU PRE SKRÝVANIE NASTAVENÍ ---


    // -------------------- MONITOROVANIE ONLINE/OFFLINE --------------------
    function isOnline() {
      return navigator.onLine;
    }
    window.addEventListener('online', () => {
      console.log('Zariadenie je online');
      showStatusNotification('Online', 'green');
      syncWithFirebase(); // Pokúsi sa synchronizovať čakajúce dáta
    });
    window.addEventListener('offline', () => {
      console.log('Zariadenie je offline');
      showStatusNotification('Offline', 'red');
    });
    function showStatusNotification(message, color) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '5px';
      notification.style.backgroundColor = color;
      notification.style.color = 'white';
      notification.style.zIndex = '1000';
      notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    function showErrorNotification(message) {
      const notification = document.getElementById('errorNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000); // Dlhší čas pre chybové hlásenia
    }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') {
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000); // Zvýšený čas pre notifikáciu o obnove hesla
    }

    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    window.login = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Prihlásenie je možné iba online.');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) {
        showErrorNotification('Prosím, zadajte email aj heslo.');
        return;
      }
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // currentUser sa nastaví cez onAuthStateChanged listener
        // updateUI sa zavolá cez onAuthStateChanged listener
        console.log('Prihlásenie úspešné pre:', userCredential.user.email);
      } catch (error) {
        console.error('Chyba pri prihlásení:', error);
        showErrorNotification('Chyba pri prihlásení: ' + mapFirebaseAuthError(error.code));
      }
    }

    window.register = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Registrácia je možná iba online.');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
       if (!email || !password) {
        showErrorNotification('Prosím, zadajte email aj heslo.');
        return;
      }
       if (password.length < 6) {
          showErrorNotification('Heslo musí mať aspoň 6 znakov.');
          return;
       }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await createUserCollection(); // Vytvorí user dokument vo Firestore
        // currentUser sa nastaví cez onAuthStateChanged listener
        // updateUI sa zavolá cez onAuthStateChanged listener
        console.log('Registrácia úspešná pre:', userCredential.user.email);
      } catch (error) {
        console.error('Chyba pri registrácii:', error);
        showErrorNotification('Chyba pri registrácii: ' + mapFirebaseAuthError(error.code));
      }
    }

    window.logout = async function() {
      try {
        await signOut(auth);
        // currentUser sa nastaví na null cez onAuthStateChanged listener
        // updateUI sa zavolá cez onAuthStateChanged listener
        console.log('Odhlásenie úspešné.');
        monthData = {}; // Vymaže dáta z pamäte pri odhlásení
      } catch (error) {
        console.error('Chyba pri odhlásení:', error);
        showErrorNotification('Chyba pri odhlásení: ' + error.message);
      }
    }

    // --- NOVÁ FUNKCIA: Obnova hesla ---
    window.resetPassword = async function() {
      if (!isOnline()) {
        showErrorNotification('Ste offline. Obnova hesla je možná iba online.');
        return;
      }
      const emailInput = document.getElementById('email');
      const email = emailInput.value;
      if (!email) {
        // Zvýrazníme emailové pole ak je prázdne
        emailInput.style.border = '1px solid red';
        showErrorNotification('Prosím, zadajte váš email do poľa "Email" pre obnovu hesla.');
        // Odstránime zvýraznenie po chvíli
        setTimeout(() => { emailInput.style.border = '1px solid #ccc'; }, 3000);
        return;
      }
      // Resetujeme štýl okraja, ak bol predtým červený
      emailInput.style.border = '1px solid #ccc';

      try {
        await sendPasswordResetEmail(auth, email);
        console.log('Email na obnovu hesla odoslaný na:', email);
        // Dlhšia notifikácia
        showSaveNotification(`Email na obnovu hesla bol odoslaný na ${email}. Skontrolujte si poštu (aj priečinok spam).`);
      } catch (error) {
        console.error('Chyba pri odosielaní emailu na obnovu hesla:', error);
        showErrorNotification('Chyba pri obnove hesla: ' + mapFirebaseAuthError(error.code));
      }
    }

    // Pomocná funkcia na preklad Firebase chybových kódov
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatný formát emailu.';
            case 'auth/user-not-found': return 'Používateľ s týmto emailom nebol nájdený.';
            case 'auth/wrong-password': return 'Nesprávne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je už zaregistrovaný.';
            case 'auth/weak-password': return 'Heslo je príliš slabé (min. 6 znakov).';
            case 'auth/requires-recent-login': return 'Táto operácia vyžaduje nedávne prihlásenie.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            // --- ZMENA: Pridaný preklad pre prípadnú chybu pri resete ---
            case 'auth/missing-email': return 'Prosím, zadajte emailovú adresu.';
            default: return errorCode; // Vráti pôvodný kód, ak nie je preklad
        }
    }

    async function createUserCollection() {
      if (auth.currentUser) { // Použijeme auth.currentUser pre istotu
        const userRef = doc(db, 'users', auth.currentUser.uid);
        try {
            await setDoc(userRef, {
              email: auth.currentUser.email,
              createdAt: new Date()
            }, { merge: true }); // Merge pre prípad, že by dokument už existoval

            // Vytvorenie subkolekcie a úvodného dokumentu, aby nebola prázdna
            const initialDocRef = doc(collection(userRef, 'workDays'), 'initial_setup');
            await setDoc(initialDocRef, { setupComplete: true });
            console.log('User collection and initial workDays doc created for:', auth.currentUser.email);
        } catch (error) {
            console.error('Error creating user collection:', error);
            // Nezobrazujeme notifikáciu používateľovi, chyba sa loguje
        }
      }
    }

    // -------------------- UI Update a Logika Načítania --------------------
    function updateUI() {
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');

        // Vždy najprv vytvoríme štruktúru tabuľky pre aktuálny mesiac/rok
        createTable(); // Táto funkcia teraz obsahuje aj ikony

        if (currentUser) {
            loginForm.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = currentUser.email;
            // Ak je používateľ prihlásený, pokúsime sa načítať dáta
            loadInitialData();
        } else {
            loginForm.style.display = 'flex'; // Použijeme flex pre správne zobrazenie
            userInfo.style.display = 'none';
            // Ak používateľ nie je prihlásený, načítame iba z localStorage
            loadFromLocalStorageOnly();
            if (!isOnline()) {
                showErrorNotification('Ste offline. Prihláste sa, keď budete online, pre prístup k cloudovým dátam.');
            }
        }
    }

    // Funkcia pre počiatočné načítanie dát po prihlásení alebo obnovení stránky
    async function loadInitialData() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
        const pendingSyncData = localStorage.getItem(pendingSyncKey);

        if (pendingSyncData && isOnline() && currentUser) {
            // Ak máme čakajúce dáta a sme online, najprv ich skúsime synchronizovať
            console.log('Máme čakajúce dáta a sme online, pokúšam sa synchronizovať PRED načítaním.');
            await syncWithFirebase(); // Počkáme na dokončenie synchronizácie
            // Po synchronizácii načítame dáta (mali by byť už aktuálne v cloude aj lokálne)
            const updatedLocalData = localStorage.getItem(localKey);
            if (updatedLocalData) {
                console.log('Načítavam dáta z localStorage po synchronizácii.');
                parseAndApplyData(updatedLocalData);
            } else {
                 // Ak ani po synchronizácii nie sú lokálne dáta, skúsime načítať z FS
                await loadFromFirestoreAndApply();
            }
        } else if (localData) {
            console.log('Načítavam počiatočné údaje z localStorage (priorita).');
            parseAndApplyData(localData);
            // Ak sme online, skontrolujeme, či nie sú v cloude novšie dáta (voliteľné)
            if (isOnline() && currentUser) {
                // checkCloudForUpdates(); // Implementujte, ak chcete porovnávať časy poslednej úpravy
            }
        } else if (isOnline() && currentUser) {
            // localStorage prázdny, sme online a prihlásení -> načítame z Firestore
           await loadFromFirestoreAndApply();
        } else {
            console.log('Offline a žiadne dáta v localStorage.');
            // Tabuľka zostane prázdna (ale štruktúra bola vytvorená)
            calculateTotal(); // Vynuluje súčty
        }
    }

    // Pomocná funkcia na načítanie z Firestore a aplikovanie dát
    async function loadFromFirestoreAndApply() {
         console.log('Pokúšam sa načítať počiatočné údaje z Firestore');
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const storedData = docSnap.data();
                    console.log('Dáta nájdené vo Firestore, ukladám do localStorage a aplikujem:', storedData);
                    const dataString = JSON.stringify(storedData);
                    localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); // Uložíme do localStorage
                    parseAndApplyData(dataString); // Aplikujeme dáta
                } else {
                    console.log('Žiadne údaje v Firestore pre tento mesiac.');
                    // Tabuľka zostane prázdna, súčty vynulujeme
                    calculateTotal();
                }
            } catch (error) {
                console.error('Chyba pri počiatočnom načítavaní z Firestore:', error);
                showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message);
                // Ak nastane chyba pri čítaní z FS, je lepšie nechať tabuľku prázdnu
                calculateTotal();
            }
    }


    // -------------------- Ukladanie do Firestore a localStorage s debounce --------------------
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    // Debounce pre ukladanie - 1 sekunda po poslednej zmene
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);

    // Funkcia pre zozbieranie dát z tabuľky a nastavení
    function collectCurrentData() {
         const saveData = {
            data: [],
            hourlyWage: hourlyWage,
            taxRate: taxRate,
            employeeName: employeeName, // Ukladáme stále celé meno
            decimalPlaces: decimalPlaces,
            lastUpdated: new Date().toISOString() // Vždy pridáme časovú značku
         };

         const daysInMonth = getDaysInMonth(currentMonth);
         for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            // Čítame aj vypočítané hodnoty pre konzistenciu
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

            // Kontrola existencie elementov pred čítaním .value
            const start = startElement ? startElement.value : '';
            const end = endElement ? endElement.value : '';
            const breakTime = breakElement ? breakElement.value : '';
            // Ukladáme hodnoty z input polí
            const gross = grossElement ? grossElement.value : '0';
            const net = netElement ? netElement.value : '0';

            saveData.data.push({ start, end, breakTime, gross, net });
         }
         return saveData;
    }

    // Funkcia pre ukladanie do Firestore (volaná cez debounce)
    async function saveToFirestore() {
      if (!currentUser) return; // Ukladáme do FS len ak je user prihlásený

      const saveData = collectCurrentData(); // Získame aktuálne dáta
      const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;

       // Lokálne uloženie je už riešené v calculateAndUpdateTotals
      if (isOnline()) {
        try {
            console.log('Pokúšam sa uložiť/synchronizovať s Firestore...');
            const userRef = doc(db, 'users', currentUser.uid);
            // Použijeme setDoc s merge=true, aby sme neprepisovali iné mesiace a zachovali štruktúru
            await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), saveData, { merge: true });
            // Odstránime príznak čakajúcej synchronizácie, ak existoval (pretože sme práve úspešne uložili)
            localStorage.removeItem(pendingSyncKey);
            showSaveNotification('Dáta synchronizované s Firebase.');
            console.log('Dáta úspešne uložené do Firestore.');
        } catch (error) {
            console.error('Chyba pri ukladaní do Firestore:', error);
            showErrorNotification('Chyba pri ukladaní dát do cloudu: ' + error.message);
            // Ak ukladanie do FS zlyhá, označíme DÁTA Z TOHTO OKAMIHU ako čakajúce na synchronizáciu
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
        }
      } else {
        // Ak sme offline, len označíme AKTUÁLNE DÁTA ako čakajúce na synchronizáciu
        console.log('Offline: Označujem dáta pre neskoršiu synchronizáciu');
        localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
        // Lokálne uloženie prebehlo v calculateAndUpdateTotals
        showSaveNotification('Ste offline, dáta uložené lokálne.');
      }
    }

    // Funkcia na synchronizáciu čakajúcich dát (volaná pri prechode na online)
    async function syncWithFirebase() {
      if (!currentUser || !isOnline()) return; // Synchronizujeme len ak sme online a prihlásení

      console.log('Kontrolujem čakajúce dáta na synchronizáciu...');
      const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;
      const pendingDataString = localStorage.getItem(pendingSyncKey);

      if (pendingDataString) {
        console.log('Našli sa čakajúce dáta, pokúšam sa synchronizovať...');
        try {
          const dataToSync = JSON.parse(pendingDataString);
          const userRef = doc(db, 'users', currentUser.uid);
          // Prepíšeme cloudové dáta čakajúcimi dátami
          await setDoc(doc(userRef, 'workDays', `${currentYear}-${currentMonth}`), dataToSync, { merge: true });
          console.log('Čakajúce dáta boli úspešne synchronizované s Firestore.');
          // Uložíme synchronizované dáta aj do hlavného localStorage kľúča
          localStorage.setItem(`workData-${currentYear}-${currentMonth}`, pendingDataString);
          localStorage.removeItem(pendingSyncKey); // Odstránime príznak po úspechu
          showSaveNotification('Offline dáta boli synchronizované s Firebase.');
          // Po synchronizácii môžeme obnoviť UI, aby sme mali istotu, že zobrazuje posledné dáta
          parseAndApplyData(pendingDataString);
        } catch (error) {
          console.error('Chyba pri synchronizácii čakajúcich dát s Firestore:', error);
          showErrorNotification('Chyba pri synchronizácii offline dát: ' + error.message);
          // Necháme pendingKey v localStorage pre ďalší pokus
        }
      } else {
         console.log('Žiadne čakajúce dáta na synchronizáciu pre tento mesiac.');
      }
    }

    // -------------------- Načítanie z Firestore (explicitne tlačidlom) --------------------
    window.loadFromFirestore = async function() {
        if (!currentUser) {
          showErrorNotification('Pre načítanie z Firebase sa musíte prihlásiť.');
          return;
        }
        if (!isOnline()) {
           showErrorNotification('Ste offline. Pre načítanie z Firebase je potrebné pripojenie na internet.');
           return;
        }

        console.log('Manuálne vyžiadané načítanie údajov z Firestore');
        // VAROVANIE: Toto prepíše akékoľvek lokálne zmeny!
        if (!confirm('Naozaj chcete načítať dáta z Firebase? Prepíšu sa tým všetky neuložené lokálne zmeny pre tento mesiac.')) {
             console.log('Načítanie z Firebase zrušené používateľom.');
             return;
        }

        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', `${currentYear}-${currentMonth}`);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const storedData = docSnap.data();
                const dataString = JSON.stringify(storedData);

                console.log('Prepisujem lokálne dáta dátami z Firestore a ukladám do localStorage:', storedData);
                localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString);
                 // Odstránime príznak čakajúcej synchronizácie, ak existoval, lebo sme práve načítali cloud verziu
                localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`);
                parseAndApplyData(dataString); // Aplikujeme načítané dáta do tabuľky
                showSaveNotification('Dáta boli úspešne načítané z Firebase.');

            } else {
                console.log('Žiadne údaje v Firestore pre tento mesiac.');
                showErrorNotification('Pre tento mesiac neboli vo Firebase nájdené žiadne dáta.');
                // Možno by sme mali vymazať aj lokálne dáta? Alebo nechať používateľa rozhodnúť.
                // Pre istotu nevymazávame lokálne dáta, ak v cloude nič nie je.
            }
        } catch (error) {
            console.error('Chyba pri manuálnom načítavaní z Firestore:', error);
            showErrorNotification('Chyba pri načítavaní dát z Firebase: ' + error.message);
        }
    }

    // Funkcia pre načítanie LEN z localStorage (používa sa, keď user nie je prihlásený)
    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);

        if (localData) {
            console.log('Načítavam údaje iba z localStorage (offline alebo neprihlásený)');
            parseAndApplyData(localData);
        } else {
            console.log('Žiadne údaje v localStorage na načítanie pre tento mesiac.');
            // Tabuľka zostane prázdna (bola vytvorená v updateUI)
            calculateTotal(); // Zobrazí nulové súčty
        }
    }

    // Pomocná funkcia na spracovanie JSON stringu a aplikovanie dát do UI
    function parseAndApplyData(dataString) {
        try {
            const storedData = JSON.parse(dataString);

            // Aktualizácia globálnych premenných a inputov pre nastavenia
            // Použijeme hodnoty z uložených dát, ak existujú, inak použijeme aktuálne hodnoty z UI ako fallback
            hourlyWage = storedData.hourlyWage !== undefined ? storedData.hourlyWage : (parseFloat(hourlyWageInput.value) || 10);
            taxRate = storedData.taxRate !== undefined ? storedData.taxRate : ((parseFloat(taxRateInput.value) || 2) / 100);
            employeeName = storedData.employeeName !== undefined ? storedData.employeeName : (employeeNameInput.value || ''); // Aj meno sa načíta z dát
            decimalPlaces = storedData.decimalPlaces !== undefined ? storedData.decimalPlaces : (parseInt(decimalPlacesSelect.value) || 1);

            // Aktualizujeme UI prvky nastavení
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            decimalPlacesSelect.value = decimalPlaces;

            // --- Aktualizácia nadpisu po načítaní dát ---
            updateGreeting();

            // Uložíme aktuálne platné nastavenia do localStorage pre konzistenciu
            localStorage.setItem('decimalPlaces', decimalPlaces);
            localStorage.setItem('employeeName', employeeName); // Uložíme aj meno

            // Aplikácia dát do tabuľky
            if (storedData.data && Array.isArray(storedData.data)) {
                const daysInMonth = getDaysInMonth(currentMonth);
                // Prejdeme maximálne toľko dní, koľko je v aktuálnom mesiaci a koľko je v uložených dátach
                const daysToProcess = Math.min(daysInMonth, storedData.data.length);

                for (let index = 0; index < daysToProcess; index++) {
                    const day = storedData.data[index];
                    const i = index + 1; // Deň v mesiaci (1-based)
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

                    if (startElement && endElement && breakElement) {
                        startElement.value = day.start || '';
                        endElement.value = day.end || '';
                        breakElement.value = day.breakTime || '';
                        // Prepočítame riadok, aby sa aktualizovali aj vypočítané hodnoty (čas, mzdy)
                        calculateRow(i);
                    } else {
                        //console.warn(`Elementy pre deň ${i} neboli nájdené pri aplikovaní dát.`);
                    }
                }
                 // Vyčistíme riadky, ktoré sú navyše v tabuľke oproti uloženým dátam
                 for (let i = daysToProcess + 1; i <= daysInMonth; i++) {
                     if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        resetRow(i, false); // Vynulujeme bez ukladania
                     }
                 }
            } else {
                console.warn('Načítané dáta neobsahujú pole `data`. Tabuľka zostane prázdna.');
                 // Vyčistíme tabuľku pre istotu
                const daysInMonth = getDaysInMonth(currentMonth);
                 for (let i = 1; i <= daysInMonth; i++) {
                     resetRow(i, false); // Vynulujeme bez ukladania
                 }
            }
            // Po aplikovaní všetkých riadkov prepočítame celkové súčty
            calculateTotal();
        } catch (error) {
            console.error('Chyba pri parsovaní alebo aplikovaní dát:', error);
            showErrorNotification('Chyba pri spracovaní uložených dát: ' + error.message);
            // V prípade chyby je lepšie zobraziť prázdnu tabuľku
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                 resetRow(i, false); // Vynulujeme bez ukladania
             }
            calculateTotal(); // Vynuluje súčty
        }
    }


    // -------------------- Tvorba tabuľky a výpočty --------------------
    function getDayName(year, month, day) {
      const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; // Skrátené názvy
      const date = new Date(year, month, day);
      return daysOfWeek[date.getDay()];
    }

    // --- ZMENENÁ FUNKCIA: Pridanie ikon hodín ---
    function createTable() {
      console.log(`Vytváram štruktúru tabuľky pre ${getMonthName(currentMonth)} ${currentYear}`);
      workDays.innerHTML = ''; // Vyčistíme predchádzajúci obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth);

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
         // Zvýraznenie aktuálneho dňa
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        const startInputId = `start-${currentYear}-${currentMonth}-${i}`;
        const endInputId = `end-${currentYear}-${currentMonth}-${i}`;
        const breakInputId = `break-${currentYear}-${currentMonth}-${i}`;
        const totalCellId = `total-${currentYear}-${currentMonth}-${i}`;
        const grossInputId = `gross-${currentYear}-${currentMonth}-${i}`;
        const netInputId = `net-${currentYear}-${currentMonth}-${i}`;

        // Vytvoríme riadok s prázdnymi inputmi a ikonami
        row.innerHTML = `
          <td>${i}. ${dayName}</td> <td> <input type="tel" id="${startInputId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endInputId}')">
            <span class="time-icon" title="Vložiť aktuálny čas" onclick="insertCurrentTime('${startInputId}')">⏰</span>
          </td>
          <td> <input type="tel" id="${endInputId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakInputId}')">
            <span class="time-icon" title="Vložiť aktuálny čas" onclick="insertCurrentTime('${endInputId}')">⏰</span>
          </td>
          <td><input type="number" id="${breakInputId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
          <td id="${totalCellId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="${grossInputId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><input type="number" id="${netInputId}" min="0" step="0.01" placeholder="0.00" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td> `;
        workDays.appendChild(row);
      }
      console.log('Štruktúra tabuľky vytvorená (s ikonami).');
      // Načítanie dát sa teraz deje v updateUI alebo loadFromLocalStorageOnly
    }
    // --- KONIEC ZMENENEJ FUNKCIE createTable ---


    // --- NOVÁ FUNKCIA: Vloženie aktuálneho času ---
    window.insertCurrentTime = function(targetInputId) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const formattedTime = `${hours}:${minutes}`;

        const targetInput = document.getElementById(targetInputId);
        if (targetInput) {
            targetInput.value = formattedTime;
            console.log(`Vložený čas ${formattedTime} do ${targetInputId}`);

            // Manuálne spustenie prepočtu a uloženia, keďže 'oninput' sa nespustí
            const day = parseInt(targetInputId.split('-')[3]);
            if (!isNaN(day)) {
                calculateRow(day); // Prepočíta riadok
                calculateAndUpdateTotals(); // Prepočíta celkové súčty a uloží dáta
            }
        } else {
            console.error('Cieľový input pre vloženie času nebol nájdený:', targetInputId);
            showErrorNotification('Chyba: Nepodarilo sa nájsť pole pre vloženie času.');
        }
    }
    // --- KONIEC NOVEJ FUNKCIE insertCurrentTime ---


    window.handleInput = function(input, nextId) {
      formatAndMoveNext(input, nextId); // Formátovanie a prípadný presun
      calculateAndUpdateTotals(); // Vždy prepočíta a uloží zmenu
    }

    window.handleBreakInput = function(day) {
      // Validácia vstupu pre prestávku
      const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      if (breakInput) {
          let breakValue = parseFloat(breakInput.value);
          if (isNaN(breakValue) || breakValue < 0) {
              breakInput.value = ''; // Vymaže neplatnú hodnotu
          } else {
               // Voliteľne: obmedziť maximálnu prestávku, napr. na 12 hodín
               // if (breakValue > 12) breakValue = 12;
               // breakInput.value = breakValue;
          }
      }
      calculateRow(day); // Prepočíta riadok
      calculateAndUpdateTotals(); // Uloží zmenu
    }

    // Hlavná funkcia pre ukladanie dát po akejkoľvek zmene
    function calculateAndUpdateTotals() {
        // Prepočítame celkové súčty na základe aktuálnych hodnôt v tabuľke
        calculateTotal();

        // Získame aktuálne dáta z UI
        const saveData = collectCurrentData();

        // Vždy uložíme do localStorage - toto zaručuje offline perzistenciu
        const localKey = `workData-${currentYear}-${currentMonth}`;
        // console.log('Ukladám aktuálne dáta do localStorage:', saveData); // Logovanie môžeme obmedziť
        localStorage.setItem(localKey, JSON.stringify(saveData));

        // Pokúsime sa uložiť/synchronizovať s Firestore (s debounce)
        debouncedSaveToFirestore();
    }

    // --- Pomocná funkcia pre validáciu času ---
    function isValidTimeFormat(timeString) {
        // Kontroluje formát HH:MM a platné rozsahy hodín/minút
        if (!timeString) return false; // Prázdny string nie je platný formát
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return timeRegex.test(timeString);
    }

    // --- UPRAVENÁ FUNKCIA pre formátovanie a presun ---
    function formatAndMoveNext(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, ''); // Ponechá len čísla a dvojbodku
        let originalValue = input.value; // Uchováme si pôvodnú hodnotu pre porovnanie
        let cursorPosition = input.selectionStart; // Pozícia kurzora pred zmenou

        // Inteligentné pridanie dvojbodky:
        // Ak sú 2 čísla a dĺžka sa zvýšila (písanie, nie mazanie)
        if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) {
             value = value + ':';
        }
        // Ak sú 4 číslice bez dvojbodky -> HH:MM (napr. pri vložení)
        else if (value.length === 4 && !value.includes(':')) {
            value = value.substring(0, 2) + ':' + value.substring(2);
        }
         // Ak sú 3 číslice, žiadna dvojbodka a dĺžka sa zvýšila
        else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d:]/g, '').length) {
             value = value.substring(0, 2) + ':' + value.substring(2);
        }

        // Odstránenie viacerých dvojbodiek alebo na začiatku
        value = value.replace(/^:/, ''); // Odstráni ':' na začiatku
        if ((value.match(/:/g) || []).length > 1) {
            const parts = value.split(':');
            value = parts[0] + ':' + parts.slice(1).join(''); // Ponechá len prvú ':'
        }

        // Obmedzenie dĺžky na 5 znakov HH:MM
        if (value.length > 5) {
           value = value.slice(0, 5);
        }

        // Zápis upravenej hodnoty späť do inputu - len ak sa hodnota zmenila
        if (input.value !== value) {
            input.value = value;
            // Pokus o obnovenie pozície kurzora (môže byť nepresné pri auto-formátovaní)
            try {
                 // Ak sme pridali dvojbodku, posunieme kurzor za ňu
                 if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) {
                     input.setSelectionRange(3, 3);
                 } else {
                     input.setSelectionRange(cursorPosition, cursorPosition);
                 }
            } catch (e) { /* Ignorujeme chyby pri nastavovaní kurzora */ }
        }

        const day = parseInt(input.id.split('-')[3]);

        // Validácia, výpočet a presun fokusu až po úprave hodnoty
        if (value.length === 5) {
            if (isValidTimeFormat(value)) {
                calculateRow(day); // Prepočíta riadok
                moveNext(input, nextId); // Presunie fokus
            } else {
                // Neplatný formát pri 5 znakoch - môžeme zobraziť chybu, ale nepresúvame fokus
                // showValidationError(input, "Neplatný čas (HH:MM)"); // Príklad validácie
                calculateRow(day); // Prepočíta (pravdepodobne na 0)
            }
        } else {
             // Ak čas nie je kompletný, prepočítame riadok aj tak
             calculateRow(day);
        }
        // calculateAndUpdateTotals() sa volá zvonku (v handleInput) po tejto funkcii
    }


    function moveNext(currentElement, nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) {
        nextElement.focus();
        // Voliteľne: Označí text v ďalšom poli pre ľahšie prepísanie
         if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number') { // Neoznačovať číslo (break)
             nextElement.select();
         }
      }
    }

    // --- VÝPOČET RIADKU ---
    function calculateRow(day) {
        const startTimeInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endTimeInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) {
            return; // Elementy neexistujú
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const breakTime = parseFloat(breakTimeInput.value) || 0; // 0 ak je prázdne alebo neplatné číslo

        // Resetujeme na 0, ak časy nie sú platné
        if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
            grossInput.value = (0).toFixed(decimalPlaces);
            netInput.value = (0).toFixed(decimalPlaces);
            return;
        }

        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);

        // Vytvoríme dátumy v rovnaký deň pre ľahký výpočet rozdielu
        const startDate = new Date(2000, 0, 1, startHours, startMinutes);
        const endDate = new Date(2000, 0, 1, endHours, endMinutes);
        let diffMillis = endDate.getTime() - startDate.getTime();

        // Ak čas konca je pred časom začiatku, predpokladáme prácu cez polnoc (pridáme 24 hodín)
        if (diffMillis < 0) {
            diffMillis += 24 * 60 * 60 * 1000;
        }

        // Prevod na minúty a odpočítanie prestávky
        let diffMinutes = diffMillis / (60 * 1000);
        const breakMinutes = breakTime * 60;
        diffMinutes -= breakMinutes;

        // Záporný výsledok znamená, že prestávka bola dlhšia ako práca -> 0
        if (diffMinutes < 0) diffMinutes = 0;

        // Presné desatinné hodiny pre výpočet mzdy
        const decimalHours = diffMinutes / 60;

        // Zaokrúhlené minúty pre zobrazenie H:M
        const totalMinutesRounded = Math.round(diffMinutes);
        const hours = Math.floor(totalMinutesRounded / 60);
        const minutes = totalMinutesRounded % 60;

        // Aktualizácia bunky s celkovým časom
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

        // Výpočet a aktualizácia miezd
        const grossSalary = decimalHours * hourlyWage;
        grossInput.value = Math.max(0, grossSalary).toFixed(decimalPlaces); // Zabezpečíme, aby nebola záporná
        updateNetSalary(day); // Aktualizuje čistú mzdu
    }

    // --- VÝPOČET ČISTEJ MZDY ---
    function updateNetSalary(day) {
        const grossSalaryInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netSalaryInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        if (!grossSalaryInput || !netSalaryInput) return; // Kontrola existencie

        const grossSalary = parseFloat(grossSalaryInput.value) || 0;
        const netSalary = grossSalary * (1 - taxRate); // Aplikujeme daňovú sadzbu
        netSalaryInput.value = Math.max(0, netSalary).toFixed(decimalPlaces); // Zabezpečíme nezápornosť
    }

    // --- VYNULOVANIE RIADKU ---
    // Pridaný parameter 'saveChanges' pre možnosť vynulovania bez ukladania
    window.resetRow = function(day, saveChanges = true) {
      const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

      if(startInput) startInput.value = '';
      if(endInput) endInput.value = '';
      if(breakInput) breakInput.value = '';

      calculateRow(day); // Prepočíta riadok (výsledkom budú nuly)

      if (saveChanges) {
          calculateAndUpdateTotals(); // Uloží zmeny, len ak je to požadované
      }
    }

    // --- VÝPOČET CELKOVÝCH SÚČTOV --- (Používa isValidTimeFormat)
    function calculateTotal() {
        let totalMinutesPrecise = 0;
        let totalGrossSalaryPrecise = 0;
        let totalNetSalaryPrecise = 0;
        let daysWithEntries = 0;
        const daysInMonth = getDaysInMonth(currentMonth);

        for (let i = 1; i <= daysInMonth; i++) {
            const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            // Pre istotu skontrolujeme, či elementy existujú
            if (!startInput || !endInput || !breakInput) continue;

            const startTime = startInput.value;
            const endTime = endInput.value;
            const breakTime = parseFloat(breakInput.value) || 0;
            let dayMinutes = 0;
            let dayGrossSalary = 0;
            let dayNetSalary = 0;
            let hasEntry = false;

            // Výpočet pre deň, len ak sú časy platné
            if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) {
                const [startHours, startMinutes] = startTime.split(':').map(Number);
                const [endHours, endMinutes] = endTime.split(':').map(Number);
                const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                const endDate = new Date(2000, 0, 1, endHours, endMinutes);
                let diffMillis = endDate.getTime() - startDate.getTime();
                if (diffMillis < 0) diffMillis += 24 * 60 * 60 * 1000; // Práca cez polnoc

                let diffMinutes = diffMillis / (60 * 1000);
                const breakMinutes = breakTime * 60;
                diffMinutes -= breakMinutes;
                if (diffMinutes < 0) diffMinutes = 0; // Celkový čas nemôže byť záporný

                dayMinutes = diffMinutes; // Ukladáme presné minúty pre súčet
                const dayDecimalHours = diffMinutes / 60;
                dayGrossSalary = Math.max(0, dayDecimalHours * hourlyWage);
                dayNetSalary = Math.max(0, dayGrossSalary * (1 - taxRate));

                // Deň počítame, ak bol odpracovaný nejaký čas (aj po odpočítaní prestávky)
                if (dayMinutes > 0) {
                     hasEntry = true;
                }
            }
            // Deň počítame aj vtedy, ak je zadaný aspoň jeden čas alebo nenulová prestávka (indikuje aktivitu v ten deň)
             if (startTime || endTime || (breakTime && breakTime > 0)) {
               hasEntry = true;
            }

            totalMinutesPrecise += dayMinutes;
            totalGrossSalaryPrecise += dayGrossSalary;
            totalNetSalaryPrecise += dayNetSalary;
            if (hasEntry) {
                 daysWithEntries++;
            }
        }

        // Výpočet celkových a priemerných hodnôt
        const totalMinutesRounded = Math.round(totalMinutesPrecise); // Celkové minúty zaokrúhlime pre zobrazenie H:M
        const totalHours = Math.floor(totalMinutesRounded / 60);
        const totalMinutesRemainder = totalMinutesRounded % 60;
        const totalDecimalHoursPrecise = totalMinutesPrecise / 60; // Pre mzdu používame presné desatinné hodiny

        const averageNetSalaryPrecise = daysWithEntries > 0 ? totalNetSalaryPrecise / daysWithEntries : 0;
        const averageWorkedMinutesPrecise = daysWithEntries > 0 ? totalMinutesPrecise / daysWithEntries : 0;
        const averageMinutesRounded = Math.round(averageWorkedMinutesPrecise);
        const averageHours = Math.floor(averageMinutesRounded / 60);
        const averageMinutes = averageMinutesRounded % 60;
        const averageDecimalHoursPrecise = averageWorkedMinutesPrecise / 60;

        // Aktualizácia HTML elementu so súhrnom
        totalSalaryDiv.innerHTML = `
            Započítaných dní: ${daysWithEntries}<br>
            Celkový čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHoursPrecise.toFixed(decimalPlaces)} h)<br>
            Hrubá mzda: ${totalGrossSalaryPrecise.toFixed(decimalPlaces)} €<br>
            Čistá mzda: ${totalNetSalaryPrecise.toFixed(decimalPlaces)} €<br>
            Priem. čistá mzda/deň: ${averageNetSalaryPrecise.toFixed(decimalPlaces)} €<br>
            <strong>Priem. čas/deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHoursPrecise.toFixed(decimalPlaces)} h)</strong>
        `;
    }


    // -------------------- EXPORT DO PDF (Vylepšený vzhľad) --------------------
    function getMonthName(month) { // Pomocná funkcia pre názov mesiaca
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      // Ochrana pred neplatným indexom
      if (month >= 0 && month < monthNames.length) {
         return monthNames[month];
      }
      return "Neznámy mesiac";
    }

    window.exportToPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      // Pridanie podpory pre UTF-8 znaky (diakritika)
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');

      // Hlavička dokumentu
      doc.setFontSize(16);
      doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22);
      doc.setFontSize(12);
      doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30); // V PDF stále celé meno

      const tableData = [];
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
        const dayName = getDayName(currentYear, currentMonth, i); // Použije skrátený názov dňa
        const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const totalTimeCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`);
        // Získame text z TD, odstránime prípadné nadbytočné medzery
        const totalTimeText = totalTimeCell ? totalTimeCell.textContent.trim() : '';
        const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
        const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';

        // Zahrnieme riadok len ak má nejaký záznam (čas alebo nenulovú prestávku)
        if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0) ) {
          tableData.push([
              `${i}. ${dayName}`, // Deň a skratka
              startTime,
              endTime,
              breakTime || '0', // Zobrazí 0 ak je prázdne
              totalTimeText,
              `${parseFloat(grossSalary).toFixed(decimalPlaces)} €`, // Formátovaná mzda s €
              `${parseFloat(netSalary).toFixed(decimalPlaces)} €`     // Formátovaná mzda s €
          ]);
        }
      }

      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Hrubá Mzda', 'Čistá Mzda']],
        body: tableData,
        startY: 38, // Posunieme začiatok tabuľky nižšie
        theme: 'grid', // Použijeme tému 'grid' pre jasné čiary
        styles: {
            font: 'Roboto',
            fontSize: 9,
            cellPadding: 2, // Trochu viac paddingu v bunkách
            valign: 'middle' // Vertikálne zarovnanie na stred
        },
        headStyles: {
            fillColor: [220, 220, 220], // Svetlo šedá hlavička
            textColor: [0, 0, 0],       // Čierny text hlavičky
            fontStyle: 'bold',
            fontSize: 10,
            halign: 'center' // Horizontálne zarovnanie hlavičky na stred
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245] // Veľmi svetlá šedá pre striedavé riadky (zebra)
        },
        columnStyles: { // Prispôsobenie šírky stĺpcov
             0: { cellWidth: 25, halign: 'left' },   // Deň - zarovnaný vľavo
             1: { cellWidth: 18, halign: 'center' }, // Príchod - centrovaný
             2: { cellWidth: 18, halign: 'center' }, // Odchod - centrovaný
             3: { cellWidth: 22, halign: 'center' }, // Prestávka - centrovaný
             4: { cellWidth: 35, halign: 'center' }, // Odpracované - centrovaný
             5: { cellWidth: 27, halign: 'right' },  // Hrubá Mzda - zarovnaná vpravo
             6: { cellWidth: 27, halign: 'right' }   // Čistá Mzda - zarovnaná vpravo
         },
        didDrawPage: function (data) {
           // Možnosť pridať pätičku (napr. číslo strany)
           // doc.text('Strana ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      // Súhrn na konci
      const totalY = doc.lastAutoTable.finalY + 10; // Väčší odstup pod tabuľkou
      doc.setFontSize(11); // Trochu menšie písmo pre súhrn
      // Preformátujeme HTML súhrn pre PDF a odstránime HTML tagy
      const totalTextContent = totalSalaryDiv.innerHTML
                                .replace(/<br\s*\/?>/gi, '\n') // Nahradí <br> za nový riadok
                                .replace(/<\/?strong>/gi, '') // Odstráni <strong> a </strong>
                                .replace(/ /g, ' ') // Nahradí   medzerou
                                .replace(/€/g, ' EUR'); // Nahradí symbol za kód meny
      doc.text(totalTextContent, 14, totalY);

      // Uloženie PDF - vylepšený názov súboru
      const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane'; // Odstráni špeciálne znaky z mena
      doc.save(`Vykaz_prace_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`);
    }


    // -------------------- ODOSLANIE PDF (Zjednodušený obsah a vylepšený vzhľad) --------------------
    window.sendPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      // Pridanie podpory pre UTF-8 znaky (diakritika)
      doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
      doc.setFont('Roboto');

      // Hlavička dokumentu - Meno a Mesiac/Rok
      doc.setFontSize(16);
      doc.text(`Záznam dochádzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22);
      doc.setFontSize(12);
      doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 30); // V PDF stále celé meno

      const tableData = [];
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
        const dayName = getDayName(currentYear, currentMonth, i); // Skrátený názov
        const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';

        // Zahrnieme riadok len ak má nejaký záznam (čas alebo nenulovú prestávku)
        if (startTime || endTime || (breakTime && parseFloat(breakTime) > 0)) {
          // Pridávame LEN požadované stĺpce
          tableData.push([
              `${i}. ${dayName}`, // Deň a skratka
              startTime,
              endTime,
              breakTime || '0' // Zobrazí 0 ak je prázdne
          ]);
        }
      }

      // Generovanie tabuľky LEN s požadovanými stĺpcami
      doc.autoTable({
        head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)']], // LEN požadované hlavičky
        body: tableData,
        startY: 38, // Posunieme začiatok tabuľky nižšie
        theme: 'grid', // Použijeme tému 'grid' pre jasné čiary
        styles: {
            font: 'Roboto',
            fontSize: 10, // Môžeme použiť trochu väčšie písmo, keďže je menej stĺpcov
            cellPadding: 3, // Viac paddingu
            valign: 'middle'
        },
        headStyles: {
            fillColor: [220, 220, 220], // Svetlo šedá hlavička
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            fontSize: 11,
            halign: 'center'
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245] // Zebra efekt
        },
        columnStyles: { // Širšie stĺpce, keďže sú len 4
             0: { cellWidth: 50, halign: 'left' },   // Deň - zarovnaný vľavo
             1: { cellWidth: 40, halign: 'center' }, // Príchod - centrovaný
             2: { cellWidth: 40, halign: 'center' }, // Odchod - centrovaný
             3: { cellWidth: 40, halign: 'center' }  // Prestávka - centrovaný
         },
         didDrawPage: function (data) {
           // Optional: Add page numbers or footer if needed
         }
      });

      // --- SÚHRN JE TU ÚMYSELNE ODSTRÁNENÝ ---

      // Generovanie Blob a File pre zdieľanie
      try {
        const pdfBlob = doc.output('blob');
        // Jednoduchší názov súboru pre zdieľaný PDF
        const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane';
        const pdfFileName = `Dochadzka_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`;
        const pdfFile = new File(
          [pdfBlob],
          pdfFileName,
          { type: 'application/pdf' }
        );

        // Zdieľanie pomocou Web Share API
        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
          navigator.share({
            files: [pdfFile],
            title: `Dochádzka ${getMonthName(currentMonth)} ${currentYear}`, // Názov pre zdieľacie okno
            text: `Záznam dochádzky pre ${employeeName} za ${getMonthName(currentMonth)} ${currentYear}.` // Popis pre zdieľanie
          })
          .then(() => console.log('PDF (dochádzka) bolo úspešne zdieľané'))
          .catch(error => {
            // Chyba pri zdieľaní (napr. používateľ zrušil) - ignorujeme AbortError
            if (error.name !== 'AbortError') {
               console.error('Chyba pri zdieľaní PDF (dochádzka):', error);
               showErrorNotification('Chyba pri zdieľaní PDF: ' + error.message);
            } else {
               console.log('Zdieľanie PDF (dochádzka) bolo zrušené používateľom.');
            }
          });
        } else {
          showErrorNotification('Funkcia zdieľania súborov nie je podporovaná v tomto prehliadači.');
          // Fallback - ponúknuť stiahnutie aj zjednodušenej verzie
          doc.save(pdfFileName);
        }
      } catch (error) {
          console.error('Chyba pri generovaní PDF (dochádzka) pre zdieľanie:', error);
          showErrorNotification('Chyba pri príprave PDF na zdieľanie: ' + error.message);
      }
    }


    // -------------------- OSTATNÉ NASTAVENIA --------------------
    window.changeDecimalPlaces = function() {
      decimalPlaces = parseInt(decimalPlacesSelect.value);
      localStorage.setItem('decimalPlaces', decimalPlaces); // Uložíme nastavenie do LS
      // Prepočítame zobrazenie a uložíme dáta
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
          // Najprv musíme zabezpečiť, že elementy existujú
          if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)){
             calculateRow(i); // Prepočíta zobrazenie pre každý riadok
          }
      }
      calculateAndUpdateTotals(); // Prepočíta súčty a uloží všetky dáta (vrátane nového nastavenia)
    }

    window.updateEmployeeName = function() {
      employeeName = employeeNameInput.value.trim(); // Stále ukladáme celé meno
      localStorage.setItem('employeeName', employeeName); // Uložíme nastavenie do LS

      // --- Aktualizácia nadpisu pri zmene mena (zobrazí len prvé meno) ---
      updateGreeting();

      // Meno neovplyvňuje výpočty, ale chceme uložiť zmenu
      calculateAndUpdateTotals(); // Uloží všetky dáta (vrátane nového celého mena)
    }

    window.updateSettings = function() {
      // Načítame a validujeme hodnoty
      const newHourlyWage = parseFloat(hourlyWageInput.value);
      const newTaxRatePercent = parseFloat(taxRateInput.value);

      if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
           hourlyWage = newHourlyWage;
      } else {
          hourlyWageInput.value = hourlyWage; // Vrátime pôvodnú hodnotu, ak je vstup neplatný
      }

       if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) {
           taxRate = newTaxRatePercent / 100;
      } else {
           taxRateInput.value = (taxRate * 100).toFixed(1); // Vrátime pôvodnú hodnotu
      }

       // Prepočítame všetky riadky a celkové súčty
      const daysInMonth = getDaysInMonth(currentMonth);
      for (let i = 1; i <= daysInMonth; i++) {
         if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)){
             calculateRow(i); // Prepočíta mzdu pre každý riadok
          }
      }
      calculateAndUpdateTotals(); // Prepočíta súčty a uloží všetky dáta (vrátane nových nastavení)
    }

    window.changeMonth = function() {
      // Uložíme dáta aktuálneho mesiaca pred zmenou (hoci by to mal robiť debounce, pre istotu)
      // saveToFirestore.flush(); // Ak by sme použili pokročilý debounce s flush metódou
      const oldMonth = currentMonth;
      currentMonth = parseInt(monthSelect.value);
      console.log(`Zmena mesiaca z ${getMonthName(oldMonth)} na ${getMonthName(currentMonth)} (${currentMonth})`);
      updateUI(); // Prekreslí UI a načíta dáta pre nový mesiac
    }

    window.changeYear = function() {
       // Uložíme dáta aktuálneho roku/mesiaca pred zmenou
       // saveToFirestore.flush();
       const oldYear = currentYear;
       currentYear = parseInt(yearSelect.value);
       console.log(`Zmena roku z ${oldYear} na ${currentYear}`);
       updateUI(); // Prekreslí UI a načíta dáta pre nový rok
    }

    function getDaysInMonth(month) {
      // Mesiac je 0-based (0-11), rok je normálny
      // new Date(year, month + 1, 0) vracia posledný deň mesiaca 'month'
      // Ochrana pred neplatným mesiacom (hoci by select nemal dovoliť)
      if (month < 0 || month > 11) return 31; // Fallback
      return new Date(currentYear, month + 1, 0).getDate();
    }

    // -------------------- INIT --------------------
    // Listener na zmeny stavu prihlásenia
    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed. User:', user ? user.email : 'None');
      currentUser = user;
      // updateUI() sa postará o všetko - zobrazenie UI a načítanie dát
      updateUI();
    });

    // -------------------- FUNKCIE PRE ZÁLOHU A OBNOVU DO EXCELU --------------------
    window.createBackup = function() {
      const key = `workData-${currentYear}-${currentMonth}`;
      const dataString = localStorage.getItem(key);
      if (dataString) {
        try {
            const dataObj = JSON.parse(dataString);
            const ws_data = [
              ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"] // Hlavička
            ];
            // Použijeme dáta z objektu, nie z UI, aby sme mali istotu konzistencie
            if (dataObj.data && Array.isArray(dataObj.data)) {
                const daysInMonth = getDaysInMonth(currentMonth); // Pre názvy dní
                const dataToExport = dataObj.data.slice(0, daysInMonth); // Len relevantné dni

                dataToExport.forEach((row, index) => {
                    const dayNum = index + 1;
                    const dayName = getDayName(currentYear, currentMonth, dayNum);
                    ws_data.push([
                        `${dayNum}. ${dayName}`, // Formát dňa
                        row.start || "",
                        row.end || "",
                        row.breakTime || "",
                        // Ukladáme čísla pre lepšiu prácu v Exceli
                        row.gross ? parseFloat(row.gross) : 0,
                        row.net ? parseFloat(row.net) : 0
                    ]);
                });
            }
            // Pridáme nastavenia na koniec
            ws_data.push([]); // Prázdny riadok pre oddelenie
            ws_data.push(["Nastavenia:", "Hodnota"]);
            ws_data.push(["Hodinová mzda", dataObj.hourlyWage]);
            ws_data.push(["Daňové percento (%)", dataObj.taxRate * 100]); // Uložíme ako číslo percenta
            ws_data.push(["Meno pracovníka", dataObj.employeeName]); // V zálohe stále celé meno
            ws_data.push(["Počet desatinných miest", dataObj.decimalPlaces]);
            ws_data.push(["Posledná aktualizácia", dataObj.lastUpdated ? new Date(dataObj.lastUpdated).toLocaleString('sk-SK') : "Neznáma"]);

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Nastavenie formátu pre mzdové stĺpce (číslo s 2 desatinnými miestami a €)
            const moneyFormat = `0.00" €"`; // Excel formát
            // Nastavenie formátu pre časové stĺpce (HH:MM)
            const timeFormat = "hh:mm";
            // Nastavenie formátu pre prestávku (číslo s 1 desatinným miestom)
            const breakFormat = "0.0";

             // Aplikujeme formáty na bunky dátovej časti
             // Riadky 1 až dataArray.length (indexy v ws_data)
             const dataEndRow = (dataObj.data ? dataObj.data.length : 0) + 1;
             for (let R = 1; R < dataEndRow; ++R) {
                 // Stĺpec Príchod (index 1) a Odchod (index 2)
                 if(ws[XLSX.utils.encode_cell({c:1, r:R})]) ws[XLSX.utils.encode_cell({c:1, r:R})].z = timeFormat;
                 if(ws[XLSX.utils.encode_cell({c:2, r:R})]) ws[XLSX.utils.encode_cell({c:2, r:R})].z = timeFormat;
                 // Stĺpec Prestávka (index 3)
                 if(ws[XLSX.utils.encode_cell({c:3, r:R})]) ws[XLSX.utils.encode_cell({c:3, r:R})].z = breakFormat;
                 // Stĺpec Hrubá mzda (index 4) a Čistá mzda (index 5)
                 if(ws[XLSX.utils.encode_cell({c:4, r:R})]) ws[XLSX.utils.encode_cell({c:4, r:R})].z = moneyFormat;
                 if(ws[XLSX.utils.encode_cell({c:5, r:R})]) ws[XLSX.utils.encode_cell({c:5, r:R})].z = moneyFormat;
             }

             // Nastavenie šírky stĺpcov pre lepší vzhľad
             ws['!cols'] = [
                { wch: 12 }, // Deň
                { wch: 8 },  // Príchod
                { wch: 8 },  // Odchod
                { wch: 10 }, // Prestávka
                { wch: 14 }, // Hrubá Mzda
                { wch: 14 }, // Čistá Mzda
            ];
             // Pre nastavenia - širší prvý stĺpec
            const settingsRowIndex = ws_data.findIndex(row => row[0] === "Nastavenia:");
            if (settingsRowIndex !== -1) {
                 // ws['!cols'][0] = { wch: Math.max(ws['!cols'][0].wch, 25) }; // Zväčšíme prvý stĺpec, ak nie je dosť široký
                 ws['!cols'][0].wch = 25; // Nastavíme šírku prvého stĺpca pre nastavenia
            }


            XLSX.utils.book_append_sheet(wb, ws, `Výkaz ${getMonthName(currentMonth)}`);
            const safeEmployeeName = employeeName.replace(/[^a-zA-Z0-9]/g, '_') || 'Nezadane';
            XLSX.writeFile(wb, `Zaloha_BrunoCalc_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`);
            showSaveNotification('Záloha bola úspešne vytvorená.');
        } catch(error) {
             console.error('Chyba pri vytváraní zálohy:', error);
             showErrorNotification('Chyba pri vytváraní zálohy: ' + error.message);
        }
      } else {
        showErrorNotification('Nie sú dostupné žiadne lokálne dáta na zálohu pre tento mesiac.');
      }
    };

    window.restoreBackup = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            // Čítame s raw: false pre formátované hodnoty (napr. časy) a cellDates: true pre dátumy (aj keď ich tu priamo nepoužívame)
            const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true });
            const sheetName = workbook.SheetNames[0];
            const ws = workbook.Sheets[sheetName];
            // Konverzia na pole polí, prázdne bunky ako ""
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false }); // raw: false je dôležité pre formátované časy

            const headerRowIndex = rows.findIndex(row => row && row[0]?.toString().toLowerCase().includes("deň"));
            if (headerRowIndex === -1) throw new Error("Hlavička tabuľky ('Deň', 'Príchod', ...) nebola nájdená.");

            const header = rows[headerRowIndex];
            // Nájdeme indexy stĺpcov podľa hlavičky (flexibilnejšie)
            const dayIndex = header.findIndex(h => h?.toString().toLowerCase().includes("deň"));
            const startIndex = header.findIndex(h => h?.toString().toLowerCase().includes("príchod"));
            const endIndex = header.findIndex(h => h?.toString().toLowerCase().includes("odchod"));
            const breakIndex = header.findIndex(h => h?.toString().toLowerCase().includes("prestávka"));
            // Gross a Net nepotrebujeme čítať, prepočítajú sa

            if (dayIndex === -1 || startIndex === -1 || endIndex === -1 || breakIndex === -1) {
                throw new Error("Nepodarilo sa nájsť všetky požadované stĺpce (Deň, Príchod, Odchod, Prestávka) v hlavičke.");
            }

            let dataArray = [];
            let settings = {};
            let i = headerRowIndex + 1; // Začíname riadok po hlavičke

            // Načítanie dát riadkov
            for (; i < rows.length; i++) {
              const row = rows[i];
              // Riadok musí existovať a obsahovať niečo v stĺpci "Deň", čo začína na číslo alebo "Deň"
              if (!row || row.length === 0 || !(row[dayIndex]?.toString().match(/^\d+\.|^Deň/i))) {
                   // Ak narazíme na riadok, ktorý nespĺňa formát, predpokladáme koniec dátovej časti
                   break;
              }
              // Spracujeme časy - Excel ich môže vrátiť ako čísla (zlomky dňa) alebo formátovaný string
              let startTimeStr = row[startIndex]?.toString() || "";
              let endTimeStr = row[endIndex]?.toString() || "";

              // Ak Excel vrátil číslo pre čas (zlomok dňa), prekonvertujeme ho na HH:MM
              // Predpokladáme, že číslo je medzi 0 a 1
              if (!isNaN(parseFloat(startTimeStr)) && parseFloat(startTimeStr) >= 0 && parseFloat(startTimeStr) <= 1 && !startTimeStr.includes(':')) {
                 startTimeStr = XLSX.SSF.format('hh:mm', parseFloat(startTimeStr));
              }
              if (!isNaN(parseFloat(endTimeStr)) && parseFloat(endTimeStr) >= 0 && parseFloat(endTimeStr) <= 1 && !endTimeStr.includes(':')) {
                 endTimeStr = XLSX.SSF.format('hh:mm', parseFloat(endTimeStr));
              }

              dataArray.push({
                start: startTimeStr,
                end: endTimeStr,
                // Prestávka by mala byť číslo
                breakTime: row[breakIndex] !== undefined ? row[breakIndex].toString().replace(',', '.') : "",
                gross: "0", // Nepotrebujeme čítať, prepočíta sa
                net: "0"    // Nepotrebujeme čítať, prepočíta sa
              });
            }

            // Načítanie nastavení (pokračujeme od riadku 'i', kde skončilo čítanie dát)
            for (; i < rows.length; i++) {
              const row = rows[i];
              // Hľadáme riadky, ktoré majú aspoň 2 stĺpce a prvý obsahuje text (kľúč nastavenia)
              if (row && row.length > 1 && row[0] && typeof row[0] === 'string') {
                 const key = row[0].toString().trim().toLowerCase();
                 const value = row[1]?.toString().trim() || ""; // Hodnota z druhého stĺpca
                 if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined;
                 else if (key.includes("daňové percento")) settings.taxRate = (parseFloat(value.replace(',', '.').replace('%', '')) || undefined) / 100;
                 else if (key.includes("meno pracovníka")) settings.employeeName = value || undefined; // Načítame celé meno zo zálohy
                 else if (key.includes("počet desatinných miest")) settings.decimalPlaces = parseInt(value) || undefined;
                 // lastUpdated nečítame, nastavíme aktuálny čas
              }
            }

            // Zostavenie finálneho objektu pre localStorage
            const backupData = {
              data: dataArray,
              // Použijeme hodnoty z Excelu, ak boli nájdené, inak fallback na aktuálne hodnoty z UI
              hourlyWage: settings.hourlyWage !== undefined ? settings.hourlyWage : (parseFloat(hourlyWageInput.value) || 10),
              taxRate: settings.taxRate !== undefined ? settings.taxRate : ((parseFloat(taxRateInput.value) || 2) / 100),
              employeeName: settings.employeeName !== undefined ? settings.employeeName : (employeeNameInput.value || ""), // Obnovíme celé meno
              decimalPlaces: settings.decimalPlaces !== undefined ? settings.decimalPlaces : (parseInt(decimalPlacesSelect.value) || 1),
              lastUpdated: new Date().toISOString() // Vždy nastavíme aktuálny čas ako poslednú úpravu pri obnove
            };

            // Potvrdenie od používateľa pred prepísaním
            if (!confirm(`Načítaná záloha obsahuje ${dataArray.length} dní. Naozaj chcete prepísať aktuálne dáta pre ${getMonthName(currentMonth)} ${currentYear}?`)) {
                 console.log('Obnova zálohy zrušená používateľom.');
                 return;
            }

            // Uložíme obnovené dáta do localStorage pre aktuálny mesiac/rok
            localStorage.setItem(`workData-${currentYear}-${currentMonth}`, JSON.stringify(backupData));
            // Aplikujeme dáta do UI (parseAndApplyData načíta aj nastavenia a zavolá updateGreeting)
            parseAndApplyData(JSON.stringify(backupData));
            showSaveNotification('Záloha bola úspešne obnovená a načítaná.');

            // Ak je užívateľ prihlásený a online, môžeme tieto obnovené dáta hneď poslať do cloudu
            if (currentUser && isOnline()) {
              saveToFirestore(); // Pošle obnovené dáta do cloudu
            }
          } catch (error) {
            console.error('Chyba pri načítavaní zálohy:', error);
            showErrorNotification('Chyba pri načítavaní zálohy: ' + error.message);
          }
        };
        reader.onerror = function() {
            showErrorNotification('Chyba pri čítaní súboru.');
        }
        reader.readAsArrayBuffer(file);
      };
      input.click(); // Otvorí dialóg na výber súboru
    };

  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta k service-worker.js je správna
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
    }
  </script>
</body>
</html>
