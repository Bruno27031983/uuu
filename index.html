<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Vylepšený titulok a popis pre SEO a zdieľanie -->
  <title>Bruno's Calculator | Evidencia dochádzky a miezd</title>
  <meta name="description" content="Jednoduchá a efektívna kalkulačka na sledovanie pracovnej doby a výpočet hrubej/čistej mzdy s možnosťou exportu a online synchronizácie.">
  <meta name="theme-color" content="#4CAF50"> <!-- Farba pre UI prehliadača na mobile -->

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />
  <!-- Ikony pre PWA (Príklad - doplňte si vlastné) -->
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" href="/icons/icon-192x192.png">

  <!-- Knižnice pre export do PDF a Excelu (Zvážiť lokálnu kópiu alebo npm pre PWA offline) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js" integrity="sha512-ma4tP8ZgmhT0dku6vRkiL5B6Uj+NTrx+Ff0q0uA9vMzA2u5C+gC73t+uXy2fSTXp0y8o+34+F9rT/F94qZkS2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvCbOBVEZmKP+NuMncJMzVxjHCLP9HznAOQSgVU5lTwnAMCjCRaPVWIVruubqk9TQZePtv4bQ9PYAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> <!-- Novšia verzia XLSX -->

  <style>
    /* ----- Základné štýly a premenné ----- */
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #8a2be2;
      --danger-color: #f44336;
      --warning-color: #ffcc00;
      --light-bg: #f4f4f4;
      --dark-bg: #333;
      --light-card-bg: white;
      --dark-card-bg: #444;
      --light-text: #333;
      --dark-text: #f4f4f4;
      --input-light-bg: #ffffd0;
      --input-dark-bg: #666;
      --border-color-light: #ddd;
      --border-color-dark: #555;
      --header-bg-light: #f2f2f2;
      --header-bg-dark: #666;
      --link-color: #007bff;
      --gradient-start: #ff0000;
      --gradient-mid1: #00ff00;
      --gradient-mid2: #0000ff;
      --gradient-mid3: #ffff00;
      --gradient-end: #ff00ff;

      --font-family: Arial, sans-serif;
      --base-font-size: 16px;
      --line-height: 1.6;
      --border-radius: 5px;
      --box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      --transition-speed: 0.3s;
    }

    body {
      font-family: var(--font-family);
      line-height: var(--line-height);
      margin: 0;
      padding: 10px;
      background-color: var(--light-bg);
      color: var(--light-text);
      font-size: var(--base-font-size);
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--light-card-bg);
      padding: 20px; /* Viac paddingu */
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    /* ----- Typografia ----- */
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, var(--gradient-start), var(--gradient-mid1), var(--gradient-mid2), var(--gradient-mid3), var(--gradient-end));
      background-size: 200% 200%; /* Pre plynulejšiu animáciu */
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 5px;
    }

    h2 {
      text-align: center;
      color: #555;
      margin-top: 0;
      margin-bottom: 25px; /* Viac priestoru */
      font-size: 1.2em;
      font-weight: normal; /* Menej výrazný podnadpis */
    }

    /* ----- Nastavenia ----- */
    .settings {
      margin-bottom: 25px;
      display: grid; /* Použitie Gridu pre lepšie zarovnanie */
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responzívny grid */
      gap: 15px; /* Medzery medzi prvkami */
      align-items: end; /* Zarovnanie prvkov na spodok */
    }

    .settings > div {
      display: flex;
      flex-direction: column; /* Label nad inputom */
    }

    .settings label {
      margin-bottom: 5px;
      font-size: 0.9em;
      font-weight: bold;
      color: #666;
    }

    /* ----- Tabuľka ----- */
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color-light); /* Orámovanie kontajnera */
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px; /* Zachované pre horizontálne scrollovanie */
    }

    th, td {
      padding: 10px 12px; /* Viac paddingu */
      border: 1px solid var(--border-color-light);
      text-align: left;
      font-size: 0.95em; /* Trochu väčšie písmo */
      vertical-align: middle; /* Vertikálne centrovanie */
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    th {
      background-color: var(--header-bg-light);
      font-weight: bold; /* Zdôraznenie hlavičky */
      white-space: nowrap; /* Zabráni lámaniu textu v hlavičke */
    }

    /* Špecifické šírky stĺpcov (zachované, ale možno prehodnotiť) */
    th:nth-child(6), td:nth-child(6), /* Hrubá Mzda */
    th:nth-child(7), td:nth-child(7) { /* Čistá Mzda */
        /* width: 20%; Radšej nechať auto alebo použiť relatívne jednotky */
        min-width: 110px; /* Minimálna šírka */
    }
     th:nth-child(5), td:nth-child(5) { /* Odpracované */
         min-width: 130px;
     }

    tbody tr:hover td {
        background-color: rgba(0, 0, 0, 0.03); /* Jemné zvýraznenie pri hoveri */
    }

    /* ----- Formulárové prvky ----- */
    input[type="tel"],
    input[type="number"],
    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
      width: 100%;
      padding: 8px 10px; /* Viac paddingu */
      box-sizing: border-box;
      background-color: var(--input-light-bg);
      font-size: 1em; /* konzistentná veľkosť */
      border: 1px solid var(--border-color-light);
      border-radius: calc(var(--border-radius) - 2px);
      transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
    }

    /* Špecifické pre číselné vstupy v tabuľke */
    td input[type="number"] {
        background-color: transparent; /* Readonly polia bez žltej */
        border: none; /* Readonly polia bez orámovania */
        padding-left: 0;
        padding-right: 0;
        -moz-appearance: textfield; /* Skrytie šípok v Firefoxe */
    }
    td input[type="number"]::-webkit-outer-spin-button,
    td input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none; /* Skrytie šípok v Chrome/Safari */
        margin: 0;
    }

    /* ----- Tlačidlá ----- */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Centrovanie tlačidiel */
      gap: 10px; /* Medzery medzi tlačidlami */
      margin-top: 25px;
    }

    .btn {
      padding: 10px 20px;
      color: white;
      background-color: var(--primary-color); /* Predvolená farba */
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      text-align: center;
      transition: background-color var(--transition-speed) ease, transform 0.1s ease, box-shadow 0.2s ease;
      display: inline-flex; /* Pre zarovnanie ikon */
      align-items: center;
      justify-content: center;
      gap: 5px; /* Medzera medzi textom a ikonou */
    }
    .btn:hover {
      background-color: #388e3c; /* Stmavenie primárnej farby */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px); /* Jemný posun hore */
    }
    .btn:active {
        transform: translateY(0); /* Späť pri kliknutí */
        box-shadow: none;
    }
    .btn:disabled { /* Štýl pre deaktivované tlačidlá */
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .reset-btn { background-color: var(--danger-color); }
    .reset-btn:hover { background-color: #d32f2f; }

    .export-btn { background-color: var(--primary-color); } /* Zjednotené s .btn */
    .export-btn:hover { background-color: #388e3c; }

    .backup-btn { background-color: var(--secondary-color); }
    .backup-btn:hover { background-color: #6a1bb2; }

    .highlight-btn { background-color: var(--warning-color); color: var(--light-text); }
    .highlight-btn:hover { background-color: #e6b800; }

    /* Tlačidlo pre vynulovanie riadku */
    td .reset-btn {
        padding: 5px 8px;
        font-size: 0.8em;
        min-width: 80px; /* Aby sa zmestil text */
    }


    /* ----- Celkové výsledky ----- */
    #totalSalary {
      font-size: 1.1em; /* Trochu väčší */
      font-weight: bold;
      text-align: center;
      margin-top: 25px;
      padding: 15px;
      background-color: #e6f3ff;
      border-radius: var(--border-radius);
      border: 1px solid #cce0ff; /* Jemné orámovanie */
      line-height: 1.8; /* Viac miesta medzi riadkami */
    }
    #totalSalary strong {
        color: var(--primary-color); /* Zdôraznenie priemeru */
    }

    /* ----- Veľkosť dát (nepoužité, ale štýly ponechané) ----- */
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: var(--primary-color); transition: width var(--transition-speed) ease; }

    /* ----- Zvýraznenie aktuálneho dňa ----- */
    .current-day td { /* Zvýraznenie celého riadku */
      background-color: #e8dff5; /* Jemnejšia fialová */
    }
    .current-day td:first-child {
        font-weight: bold; /* Zdôraznenie názvu dňa */
    }
    .current-day input { /* Inputy v aktuálnom dni */
      background-color: #f5f0fa;
      font-weight: bold; /* Mierne zdôraznenie textu v inpute */
    }

    /* ----- Tmavý režim ----- */
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    body.dark-mode .container { background-color: var(--dark-card-bg); }
    body.dark-mode h2 { color: #bbb; }
    body.dark-mode .settings label { color: #ccc; }
    body.dark-mode table { border-color: var(--border-color-dark); }
    body.dark-mode th { background-color: var(--header-bg-dark); border-color: var(--border-color-dark); }
    body.dark-mode td { border-color: var(--border-color-dark); }
    body.dark-mode tbody tr:hover td { background-color: rgba(255, 255, 255, 0.05); }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode input[type="email"],
    body.dark-mode input[type="password"],
    body.dark-mode select {
      background-color: var(--input-dark-bg);
      color: var(--dark-text);
      border-color: var(--border-color-dark);
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
      border-color: var(--secondary-color); /* Iná farba focusu v tmavom režime */
      box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.4);
    }
    body.dark-mode #totalSalary {
        background-color: #2c3e50;
        border-color: #3b536d;
    }
    body.dark-mode #totalSalary strong { color: var(--warning-color); }
    body.dark-mode .current-day td { background-color: #4a0e8f; }
    body.dark-mode .current-day input { background-color: #5c1db3; }
    body.dark-mode .btn { /* Tmavé tlačidlá s bielym textom */ color: white; }
    /* Farby tlačidiel v tmavom režime - môžu zostať rovnaké alebo sa upraviť */
    body.dark-mode .reset-btn { background-color: #c62828; }
    body.dark-mode .reset-btn:hover { background-color: #a52020; }
    body.dark-mode .export-btn { background-color: #388e3c; }
    body.dark-mode .export-btn:hover { background-color: #2a6d2d; }
    body.dark-mode .backup-btn { background-color: #6a1bb2; }
    body.dark-mode .backup-btn:hover { background-color: #52158a; }
    body.dark-mode .highlight-btn { background-color: #e6b800; color: var(--dark-bg); }
    body.dark-mode .highlight-btn:hover { background-color: #cca300; }
    body.dark-mode ::-webkit-calendar-picker-indicator { filter: invert(1); } /* Lepšia viditeľnosť kalendára */
    body.dark-mode .table-container { border-color: var(--border-color-dark); }


    /* ----- Animácie ----- */
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 15px rgba(255, 255, 255, 0.2), 0 0 25px rgba(255, 255, 255, 0.1); }
      50% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.7), 0 0 35px rgba(255, 255, 255, 0.5); }
    }

    /* ----- Notifikácie ----- */
    .notification {
      display: none; /* Skryté defaultne, ovládané JS */
      position: fixed;
      bottom: 20px;
      left: 50%; /* Centrovanie */
      transform: translateX(-50%); /* Presné centrovanie */
      padding: 12px 25px;
      border-radius: var(--border-radius);
      font-size: 0.95em;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1001; /* Nad ostatnými prvkami */
      opacity: 0;
      transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out;
      min-width: 250px; /* Minimálna šírka */
      text-align: center;
    }
    .notification.show {
      display: block;
      opacity: 1;
      bottom: 30px; /* Posun hore pri zobrazení */
    }
    #saveNotification { background-color: var(--primary-color); color: white; }
    #errorNotification { background-color: var(--danger-color); color: white; }
    #syncNotification { background-color: var(--secondary-color); color: white; } /* Nová notifikácia pre sync */

    /* ----- Login formulár ----- */
    #login-form {
      display: none; /* Skrytý defaultne */
      flex-direction: column;
      align-items: center;
      gap: 10px; /* Medzery medzi prvkami */
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid var(--border-color-light);
      border-radius: var(--border-radius);
      max-width: 300px; /* Obmedzenie šírky */
      margin-left: auto;
      margin-right: auto;
    }
    #login-form input { width: 100%; }
    #login-form .btn-group { display: flex; gap: 10px; } /* Tlačidlá vedľa seba */

    #user-info {
        display: none; /* Skryté defaultne */
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f0f0f0; /* Jemné pozadie */
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color-light);
        display: flex; /* Zarovnanie emailu a tlačidla */
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    #user-info span { font-weight: bold; }
    #user-info .btn { padding: 8px 15px; font-size: 0.9em; } /* Menšie odhlasovacie tlačidlo */

    /* ----- Indikátor stavu pripojenia ----- */
    #connection-status {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: var(--border-radius);
        font-size: 0.8em;
        font-weight: bold;
        z-index: 1000;
        opacity: 0.8;
        transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    }
    #connection-status.online { background-color: var(--primary-color); color: white; }
    #connection-status.offline { background-color: var(--danger-color); color: white; }
    #connection-status.syncing { background-color: var(--secondary-color); color: white; }

    /* ----- Loading indikátor ----- */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    body.dark-mode .loading-overlay {
        background-color: rgba(0, 0, 0, 0.7);
    }
    .loading-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .spinner { /* Jednoduchý CSS spinner */
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s ease infinite;
    }
    body.dark-mode .spinner {
        border-left-color: var(--secondary-color);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ----- Prístupnosť ----- */
    /* Zvýraznenie focusu pre klávesnicovú navigáciu */
    *:focus-visible {
        outline: 2px solid var(--secondary-color);
        outline-offset: 2px;
        box-shadow: none; /* Reset iných focus štýlov */
    }
    body.dark-mode *:focus-visible {
         outline-color: var(--warning-color);
    }

    /* ----- Responzivita ----- */
    @media (max-width: 992px) {
        .settings {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Menšie stĺpce pre tablety */
        }
    }

    @media (max-width: 768px) {
      body { padding: 5px; font-size: 15px; }
      .container { padding: 15px; }
      h1 { font-size: 2em; }
      h2 { font-size: 1.1em; }
      .settings { grid-template-columns: 1fr 1fr; } /* Dva stĺpce na menších tabletoch */
      th, td { padding: 8px 10px; font-size: 0.9em; }
      .btn-container { flex-direction: column; align-items: stretch; } /* Tlačidlá pod sebou */
      .btn { font-size: 0.95em; }
      #totalSalary { font-size: 1em; padding: 12px; }
      .notification { width: 90%; left: 5%; transform: translateX(0); font-size: 0.9em; }
      #user-info { flex-direction: column; gap: 5px; }
    }

    @media (max-width: 480px) {
      body { font-size: 14px; }
      .container { padding: 10px; }
      h1 { font-size: 1.6em; }
      h2 { font-size: 1em; }
      .settings { grid-template-columns: 1fr; } /* Jeden stĺpec na mobiloch */
      th, td { font-size: 0.8em; padding: 6px 8px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 0.9em; }
      .btn { font-size: 0.9em; padding: 10px 15px; }
      td .reset-btn { min-width: 70px; font-size: 0.75em; }
      #totalSalary { font-size: 0.95em; }
    }

  </style>
</head>
<body>
  <!-- Indikátor stavu pripojenia a synchronizácie -->
  <div id="connection-status">Offline</div>

  <div class="container">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Autentifikačné UI -->
    <div id="auth-container" style="margin-bottom: 20px;">
      <!-- Login/Register Form -->
      <form id="login-form" onsubmit="event.preventDefault();"> <!-- Použitie form pre lepšiu sémantiku -->
        <input type="email" id="email" placeholder="Email" required aria-label="Email">
        <input type="password" id="password" placeholder="Heslo" required aria-label="Heslo">
        <div class="btn-group">
            <button type="button" class="btn export-btn" onclick="login()" aria-label="Prihlásiť sa">Prihlásiť sa</button>
            <button type="button" class="btn export-btn" onclick="register()" aria-label="Registrovať sa">Registrovať</button>
        </div>
      </form>
      <!-- User Info and Logout -->
      <div id="user-info">
        Prihlásený ako: <span id="user-email" aria-live="polite"></span>
        <button class="btn reset-btn" onclick="logout()" aria-label="Odhlásiť sa">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="subTitle">Evidencia dochádzky a výpočet mzdy</h2> <!-- Pridaný podnadpis -->

    <!-- Nastavenia -->
    <section aria-labelledby="settings-heading"> <!-- Sekcia pre prístupnosť -->
        <h3 id="settings-heading" class="visually-hidden">Nastavenia výpočtu</h3> <!-- Skrytý nadpis pre screen readery -->
        <div class="settings">
          <div>
            <label for="employeeNameInput">Meno pracovníka:</label>
            <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()" aria-label="Meno pracovníka">
          </div>
          <div>
            <label for="hourlyWageInput">Hodinová mzda (€):</label>
            <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()" aria-label="Hodinová mzda v eurách">
          </div>
          <div>
            <label for="taxRateInput">Daňové percento (%):</label>
            <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()" aria-label="Daňové percento">
          </div>
          <div>
            <label for="monthSelect">Mesiac:</label>
            <select id="monthSelect" onchange="changeMonth()" aria-label="Vyberte mesiac">
              <option value="0">Január</option>
              <option value="1">Február</option>
              <option value="2">Marec</option>
              <option value="3">Apríl</option>
              <option value="4">Máj</option>
              <option value="5">Jún</option>
              <option value="6">Júl</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">Október</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <div>
            <label for="yearSelect">Rok:</label>
            <select id="yearSelect" onchange="changeYear()" aria-label="Vyberte rok">
              <!-- Dynamicky generované roky -->
            </select>
          </div>
          <div>
            <label for="decimalPlacesSelect">Desatinné miesta:</label>
            <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()" aria-label="Počet desatinných miest pre zobrazenie">
              <option value="1">1</option>
              <option value="2" selected>2</option> <!-- Predvolené na 2 miesta -->
              <option value="3">3</option>
            </select>
          </div>
          <button onclick="toggleDarkMode()" class="btn highlight-btn" aria-label="Prepínač tmavého/svetlého režimu">
            <!-- Ikona (príklad - použiť SVG alebo font ikonu) -->
            ☀️/🌙 Režim
          </button>
        </div>
    </section>

    <!-- Tabuľka s dátami -->
    <section aria-labelledby="work-data-heading">
        <h3 id="work-data-heading" class="visually-hidden">Záznamy dochádzky</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th scope="col">Deň</th>
                <th scope="col">Príchod</th>
                <th scope="col">Odchod</th>
                <th scope="col">Prestávka (h)</th>
                <th scope="col">Odpracované</th>
                <th scope="col">Hrubá Mzda (€)</th>
                <th scope="col">Čistá Mzda (€)</th>
                <th scope="col">Akcia</th>
              </tr>
            </thead>
            <tbody id="workDays" aria-live="polite" aria-atomic="true">
              <!-- Riadky budú generované cez JavaScript -->
            </tbody>
          </table>
        </div>
    </section>

    <!-- Súčty -->
    <div id="totalSalary" aria-live="polite">
        <!-- Súčty budú generované cez JavaScript -->
        Načítavam súčty...
    </div>

    <!-- Kontajner s tlačidlami akcií -->
    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()" aria-label="Exportovať aktuálny mesiac do PDF">
          <!-- Ikona --> Export PDF
      </button>
      <button class="btn export-btn" onclick="sendPDF()" aria-label="Odoslať aktuálny mesiac ako PDF cez zdieľanie">
          <!-- Ikona --> Odoslať PDF
      </button>
      <button class="btn backup-btn" onclick="createBackup()" aria-label="Vytvoriť zálohu aktuálneho mesiaca do Excel súboru">
          <!-- Ikona --> Vytvoriť zálohu (.xlsx)
      </button>
      <button class="btn backup-btn" onclick="triggerRestoreBackup()" aria-label="Obnoviť dáta pre aktuálny mesiac zo zálohy Excel">
           <!-- Ikona --> Obnoviť zálohu (.xlsx)
      </button>
      <input type="file" id="restoreFileInput" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display: none;" onchange="handleRestoreFile(event)">
      <button class="btn export-btn" onclick="loadFromFirestore()" aria-label="Načítať dáta pre aktuálny mesiac z Firebase cloudu (prepíše lokálne zmeny)">
          <!-- Ikona --> Načítať z cloudu
      </button>
      <!-- Možno pridať: <button class="btn reset-btn" onclick="resetMonthConfirm()" aria-label="Vynulovať všetky dáta pre aktuálny mesiac">Vymazať mesiac</button> -->
    </div>
  </div>

  <!-- Notifikácie -->
  <div id="saveNotification" class="notification" role="status" aria-live="polite"></div>
  <div id="errorNotification" class="notification" role="alert" aria-live="assertive"></div>
  <div id="syncNotification" class="notification" role="status" aria-live="polite"></div>

  <!-- Skrytá trieda pre screen readery -->
  <style>.visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }</style>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, writeBatch, serverTimestamp, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // !!! BEZPEČNOSTNÉ RIZIKO - NIKDY NENECHÁVAŤ V KÓDE NA KLIENTOVI V PRODUKCII !!!
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // <- Nahradiť bezpečným spôsobom
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com", // Opravený storageBucket
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // -------------------- INICIALIZÁCIA APLIKÁCIE --------------------
    let app;
    let auth;
    let db;
    let appCheck;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        // App Check - dôležité pre ochranu backendu
        appCheck = initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Váš Site Key
          isTokenAutoRefreshEnabled: true
        });
        console.log("Firebase inicializovaný úspešne.");
    } catch (error) {
        console.error("FATAL: Chyba pri inicializácii Firebase:", error);
        showErrorNotification("Kritická chyba: Nepodarilo sa pripojiť k Firebase. Skúste obnoviť stránku.", true); // true = persistent
        // Tu by aplikácia mala prejsť do nejakého núdzového režimu alebo informovať užívateľa
    }

    // -------------------- KONŠTANTY A GLOBÁLNE PREMENNÉ --------------------
    const DOM = { // Objekt pre ľahší prístup k DOM elementom
        workDaysTableBody: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        mainTitle: document.getElementById('mainTitle'),
        subTitle: document.getElementById('subTitle'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        loginForm: document.getElementById('login-form'),
        userInfo: document.getElementById('user-info'),
        userEmailSpan: document.getElementById('user-email'),
        saveNotification: document.getElementById('saveNotification'),
        errorNotification: document.getElementById('errorNotification'),
        syncNotification: document.getElementById('syncNotification'),
        connectionStatus: document.getElementById('connection-status'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        restoreFileInput: document.getElementById('restoreFileInput'),
        // Tlačidlá pre prípadné disabled stavy
        loginButton: document.querySelector('#login-form button[onclick="login()"]'),
        registerButton: document.querySelector('#login-form button[onclick="register()"]'),
        logoutButton: document.querySelector('#user-info button[onclick="logout()"]'),
        loadFromCloudButton: document.querySelector('button[onclick="loadFromFirestore()"]'),
        // ... pridať ďalšie tlačidlá podľa potreby
    };

    const DEFAULT_DECIMAL_PLACES = 2;
    const SAVE_DEBOUNCE_MS = 1000; // Dlhší debounce pre menej časté zápisy
    const NOTIFICATION_TIMEOUT_MS = 3000;
    const SYNC_NOTIFICATION_TIMEOUT_MS = 4000;
    const ERROR_NOTIFICATION_TIMEOUT_MS = 5000;

    let currentUser = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || DEFAULT_DECIMAL_PLACES;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10; // Načítanie aj z LS
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02; // Načítanie aj z LS
    let monthDataCache = {}; // Cache pre načítané dáta mesiacov
    let isOnline = navigator.onLine;
    let syncState = 'idle'; // 'idle', 'syncing', 'pending', 'error'
    let notificationTimeoutId = null;
    let debouncedSaveTimer = null;

    const dayNames = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; // Kratšie názvy dní

    // -------------------- POMOCNÉ FUNKCIE --------------------

    /** Zobrazí/skryje loading overlay */
    function setLoading(isLoading) {
        DOM.loadingOverlay.classList.toggle('show', isLoading);
        // Prípadne deaktivovať dôležité tlačidlá počas načítavania
        // Array.from(DOM.container.querySelectorAll('button')).forEach(btn => btn.disabled = isLoading);
    }

    /** Zobrazí notifikáciu */
    function showNotification(element, message, isPersistent = false, timeout = NOTIFICATION_TIMEOUT_MS) {
        if (notificationTimeoutId) clearTimeout(notificationTimeoutId); // Zruší predch. timeout
        element.textContent = message;
        element.classList.add('show');
        if (!isPersistent) {
            notificationTimeoutId = setTimeout(() => {
                element.classList.remove('show');
            }, timeout);
        }
    }
    function showSaveNotification(message = 'Dáta uložené lokálne.') { showNotification(DOM.saveNotification, message); }
    function showErrorNotification(message, isPersistent = false) { showNotification(DOM.errorNotification, message, isPersistent, ERROR_NOTIFICATION_TIMEOUT_MS); }
    function showSyncNotification(message) { showNotification(DOM.syncNotification, message, false, SYNC_NOTIFICATION_TIMEOUT_MS); }

    /** Debounce funkcia */
    function debounce(func, wait) {
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(debouncedSaveTimer);
          func(...args);
        };
        clearTimeout(debouncedSaveTimer);
        debouncedSaveTimer = setTimeout(later, wait);
      };
    }

    /** Formátuje číslo na daný počet des. miest */
    function formatNumber(num) {
        return (typeof num === 'number' && !isNaN(num)) ? num.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
    }

    /** Získa počet dní v mesiaci */
    function getDaysInMonth(year, month) { return new Date(year, month + 1, 0).getDate(); }

    /** Získa skratku dňa v týždni */
    function getDayAbbreviation(year, month, day) { return dayNames[new Date(year, month, day).getDay()]; }

    /** Získa názov mesiaca */
    function getMonthName(monthIndex) {
        const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
        return monthNames[monthIndex] ?? "Neznámy";
    }

    /** Regulárny výraz pre validáciu času HH:MM */
    const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

    /** Generuje unikátny kľúč pre localStorage a Firestore */
    function getDataKey(year, month) { return `workData-${year}-${month}`; }

    // -------------------- SPRÁVA STAVU PRIPOJENIA A SYNCHRONIZÁCIE --------------------

    function updateOnlineStatus() {
        isOnline = navigator.onLine;
        if (isOnline) {
            DOM.connectionStatus.textContent = 'Online';
            DOM.connectionStatus.className = 'online';
            console.log('Stav: Online');
            if (db) enableNetwork(db).catch(console.warn); // Skúsi povoliť sieť pre Firestore
            if (currentUser) trySyncPendingData(); // Skúsi synchronizovať čakajúce dáta po pripojení
        } else {
            DOM.connectionStatus.textContent = 'Offline';
            DOM.connectionStatus.className = 'offline';
            console.log('Stav: Offline');
            setSyncState('idle'); // Reset sync state pri offline
            if (db) disableNetwork(db).catch(console.warn); // Skúsi explicitne vypnúť sieť pre Firestore
            showErrorNotification('Pracujete v offline režime. Zmeny sa ukladajú lokálne.');
        }
    }

    function setSyncState(newState) {
        syncState = newState;
        // Aktualizovať UI podľa stavu synchronizácie (napr. ikona, text)
        switch (syncState) {
            case 'syncing':
                DOM.connectionStatus.textContent = 'Synchronizujem...';
                DOM.connectionStatus.className = 'syncing';
                break;
            case 'pending':
                DOM.connectionStatus.textContent = 'Čaká na synchronizáciu';
                DOM.connectionStatus.className = 'offline'; // Alebo špeciálna farba
                break;
            case 'error':
                 DOM.connectionStatus.textContent = 'Chyba synchronizácie';
                 DOM.connectionStatus.className = 'offline'; // Alebo error farba
                 break;
            case 'idle':
            default:
                // Vráti sa na Online/Offline stav
                 updateOnlineStatus();
                break;
        }
        console.log(`Sync state: ${syncState}`);
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // -------------------- UKLADANIE A NAČÍTANIE DÁT --------------------

    /** Zozbiera aktuálne dáta z UI a nastavení */
    function collectCurrentData() {
         const data = [];
         const daysInCurrentMonth = getDaysInMonth(currentYear, currentMonth);
         for (let i = 1; i <= daysInCurrentMonth; i++) {
            // Použitie optional chaining a nullish coalescing pre robustnosť
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value ?? '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value ?? '';
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value ?? '';
            // Ukladáme *vypočítané* hodnoty, nie hodnoty z readonly inputov
            const { decimalHours } = calculateWorkHours(start, end, breakTime);
            const gross = calculateGrossSalary(decimalHours);
            const net = calculateNetSalary(gross);

            data.push({ start, end, breakTime, hours: decimalHours, gross, net }); // Ukladáme aj hodiny pre jednoduchší výpočet
         }

         return {
            data,
            hourlyWage,
            taxRate,
            employeeName,
            decimalPlaces,
            lastUpdated: serverTimestamp() // Použijeme serverový čas pri ukladaní do Firestore
            // Alebo new Date().toISOString() pre localStorage
         };
    }

    /** Uloží dáta do localStorage */
    function saveToLocalStorage(dataObject) {
        const key = getDataKey(currentYear, currentMonth);
        try {
            // Pre localStorage potrebujeme konkrétny dátum, nie serverTimestamp
            const localData = { ...dataObject, lastUpdated: new Date().toISOString() };
            localStorage.setItem(key, JSON.stringify(localData));
            localStorage.setItem('hourlyWage', hourlyWage); // Uložíme aj individuálne nastavenia
            localStorage.setItem('taxRate', taxRate);
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces);
            console.log(`Dáta pre ${key} uložené do localStorage.`);
            showSaveNotification(); // Notifikácia o lokálnom uložení
        } catch (error) {
            console.error(`Chyba pri ukladaní do localStorage (${key}):`, error);
            showErrorNotification('Chyba pri lokálnom ukladaní dát!');
            // Riešenie pre plné localStorage?
            if (error.name === 'QuotaExceededError') {
                showErrorNotification('Lokálne úložisko je plné! Skúste vymazať staré dáta alebo zálohy.', true);
            }
        }
    }

    /** Debouncovaná verzia saveToFirestore */
    const debouncedSaveToFirestore = debounce(async () => {
        if (!currentUser || !isOnline) {
            if (!isOnline) setSyncState('pending'); // Ak sme offline, označíme ako čakajúce
            console.log('Preskakujem ukladanie do Firestore (neprihlásený alebo offline).');
            return;
        }

        setSyncState('syncing');
        setLoading(true); // Zobraziť indikátor načítania

        const saveData = collectCurrentData();
        const key = getDataKey(currentYear, currentMonth);
        const userRef = doc(db, 'users', currentUser.uid);
        const docRef = doc(userRef, 'workDays', key);

        try {
            await setDoc(docRef, saveData);
            localStorage.removeItem(`pendingSync-${key}`); // Odstrániť príznak čakajúcej synchronizácie
            setSyncState('idle');
            showSyncNotification('Dáta synchronizované s cloudom.');
            console.log(`Dáta pre ${key} úspešne uložené do Firestore.`);
        } catch (error) {
            console.error(`Chyba pri ukladaní do Firestore (${key}):`, error);
            showErrorNotification('Chyba pri synchronizácii dát s cloudom.');
            localStorage.setItem(`pendingSync-${key}`, JSON.stringify(saveData)); // Označiť ako čakajúce na sync
            setSyncState('error');
        } finally {
            setLoading(false); // Skryť indikátor načítania
        }
    }, SAVE_DEBOUNCE_MS);


    /** Spúšťač ukladania (lokálne hneď, do cloudu debouncovane) */
    function triggerSave() {
        const currentData = collectCurrentData();
        saveToLocalStorage(currentData); // Vždy uložíme lokálne okamžite
        debouncedSaveToFirestore();     // Pokúsime sa uložiť do cloudu (debouncovane)
    }

    /** Pokúsi sa synchronizovať dáta označené ako čakajúce */
    async function trySyncPendingData() {
        if (!currentUser || !isOnline) return;

        const prefix = `pendingSync-workData-`;
        let syncedCount = 0;
        setLoading(true);
        setSyncState('syncing');

        try {
            const batch = writeBatch(db); // Použijeme batch zápis pre efektivitu
            const keysToRemove = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(prefix)) {
                    const dataString = localStorage.getItem(key);
                    if (dataString) {
                        try {
                            const dataToSync = JSON.parse(dataString);
                            // Správny dokument ID bez prefixu
                            const docId = key.substring(prefix.length);
                            const userRef = doc(db, 'users', currentUser.uid);
                            const docRef = doc(userRef, 'workDays', docId);
                            // Pridáme do batch operácie namiesto individuálneho setDoc
                            batch.set(docRef, { ...dataToSync, lastUpdated: serverTimestamp() }); // Aktualizujeme čas pri synchronizácii
                            keysToRemove.push(key);
                            syncedCount++;
                            console.log(`Pripravené na synchronizáciu: ${docId}`);
                        } catch (parseError) {
                            console.error(`Chyba pri parsovaní čakajúcich dát pre kľúč ${key}:`, parseError);
                            localStorage.removeItem(key); // Odstrániť poškodené dáta
                        }
                    }
                }
            }

            if (syncedCount > 0) {
                await batch.commit(); // Odošleme všetky zmeny naraz
                keysToRemove.forEach(key => localStorage.removeItem(key)); // Odstránime kľúče až po úspešnom zápise
                console.log(`${syncedCount} záznamov úspešne synchronizovaných.`);
                showSyncNotification(`${syncedCount} offline záznamov synchronizovaných.`);
                setSyncState('idle');
                // Po úspešnej synchronizácii možno načítať aktuálne dáta, ak sa zmenil mesiac medzitým
                // loadInitialData();
            } else {
                 console.log('Žiadne čakajúce dáta na synchronizáciu.');
                 setSyncState('idle');
            }

        } catch (error) {
            console.error('Chyba pri synchronizácii čakajúcich dát:', error);
            showErrorNotification('Nepodarilo sa synchronizovať offline zmeny.');
            setSyncState('error');
        } finally {
            setLoading(false);
        }
    }

    /** Načíta dáta pre aktuálny mesiac (priorita: cache -> localStorage -> Firestore) */
    async function loadInitialData() {
        const key = getDataKey(currentYear, currentMonth);
        console.log(`Načítavam dáta pre ${key}...`);
        setLoading(true);

        // 1. Skontrolovať cache
        if (monthDataCache[key]) {
            console.log("Nájdené v cache.");
            applyDataToUI(monthDataCache[key]);
            setLoading(false);
            trySyncPendingData(); // Skontrolovať, či nie sú čakajúce dáta pre tento mesiac
            return;
        }

        // 2. Skontrolovať localStorage
        const localDataString = localStorage.getItem(key);
        if (localDataString) {
            console.log("Nájdené v localStorage.");
            try {
                const localData = JSON.parse(localDataString);
                monthDataCache[key] = localData; // Uložiť do cache
                applyDataToUI(localData);
                // Ak sme online, skontrolujeme, či máme čakajúce dáta alebo či sa cloud nelíši
                if (isOnline && currentUser) {
                   const pendingKey = `pendingSync-${key}`;
                   if (localStorage.getItem(pendingKey)) {
                       console.log("Existujú čakajúce dáta pre tento mesiac, neprepisujem z cloudu.");
                       setSyncState('pending');
                       showSyncNotification("Máte neodoslané offline zmeny pre tento mesiac.");
                   } else {
                       // Voliteľne: Skontrolovať, či sa cloudové dáta nelíšia (napr. podľa lastUpdated)
                       // checkForCloudUpdates(key, localData.lastUpdated);
                       trySyncPendingData(); // Všeobecná kontrola sync
                   }
                }
            } catch (error) {
                console.error(`Chyba pri parsovaní dát z localStorage (${key}):`, error);
                localStorage.removeItem(key); // Odstrániť poškodené dáta
                showErrorNotification("Chyba pri načítaní lokálnych dát. Skúste načítať z cloudu.");
                createEmptyTable(); // Zobraziť prázdnu tabuľku
            } finally {
                setLoading(false);
            }
            return;
        }

        // 3. Skontrolovať Firestore (iba ak sme online a prihlásení)
        if (isOnline && currentUser) {
            console.log("Hľadám v Firestore...");
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                const docRef = doc(userRef, 'workDays', key);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("Nájdené v Firestore.");
                    const cloudData = docSnap.data();
                     // Firestore vracia Timestamp, pre localStorage/cache je lepšie ISO string
                    const dataToApply = {
                        ...cloudData,
                        lastUpdated: cloudData.lastUpdated?.toDate()?.toISOString() || new Date().toISOString()
                    };
                    monthDataCache[key] = dataToApply; // Uložiť do cache
                    localStorage.setItem(key, JSON.stringify(dataToApply)); // Uložiť aj do localStorage
                    applyDataToUI(dataToApply);
                } else {
                    console.log(`Žiadne dáta v Firestore pre ${key}. Vytváram prázdnu tabuľku.`);
                    createEmptyTable(); // Ak nenájdeme nikde, vytvoríme prázdnu
                }
            } catch (error) {
                console.error(`Chyba pri načítavaní z Firestore (${key}):`, error);
                showErrorNotification('Chyba pri načítavaní dát z cloudu.');
                createEmptyTable(); // Zobraziť prázdnu tabuľku pri chybe
            } finally {
                 setLoading(false);
            }
        } else {
            // Offline a žiadne lokálne dáta
            console.log("Offline a žiadne lokálne dáta. Vytváram prázdnu tabuľku.");
            createEmptyTable();
            setLoading(false);
        }
    }

    /** Explicitné načítanie z Firestore (tlačidlom) - prepíše lokálne dáta! */
    window.loadFromFirestore = async function() {
        if (!currentUser) return showErrorNotification('Pre načítanie z cloudu sa musíte prihlásiť.');
        if (!isOnline) return showErrorNotification('Ste offline. Pripojte sa na internet pre načítanie z cloudu.');

        const key = getDataKey(currentYear, currentMonth);
        if (!confirm(`Naozaj chcete načítať dáta z cloudu pre ${getMonthName(currentMonth)} ${currentYear}? Prepíšu sa tým všetky aktuálne lokálne zmeny pre tento mesiac.`)) {
            return;
        }

        console.log(`Manuálne vyžiadané načítanie z Firestore pre ${key}...`);
        setLoading(true);
        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', key);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                const dataToApply = {
                    ...cloudData,
                    lastUpdated: cloudData.lastUpdated?.toDate()?.toISOString() || new Date().toISOString()
                };

                // Prepísať cache a localStorage
                monthDataCache[key] = dataToApply;
                localStorage.setItem(key, JSON.stringify(dataToApply));
                localStorage.removeItem(`pendingSync-${key}`); // Zmazať príznak čakajúcej synchronizácie

                applyDataToUI(dataToApply); // Aplikovať do UI
                showSaveNotification('Dáta úspešne načítané z cloudu.');
                setSyncState('idle'); // Reset sync state
            } else {
                showErrorNotification(`Pre ${getMonthName(currentMonth)} ${currentYear} neboli v cloude nájdené žiadne dáta.`);
                // Možno by sme mali vymazať aj lokálne dáta? Záleží na požiadavke.
                // createEmptyTable();
                // delete monthDataCache[key];
                // localStorage.removeItem(key);
                // triggerSave();
            }
        } catch (error) {
            console.error(`Chyba pri manuálnom načítavaní z Firestore (${key}):`, error);
            showErrorNotification('Chyba pri načítavaní dát z cloudu.');
        } finally {
            setLoading(false);
        }
    }


    /** Aplikuje načítané dáta (z cache, LS alebo FS) do UI */
    function applyDataToUI(storedData) {
        console.log('Aplikujem dáta do UI:', storedData);

        // 1. Aktualizovať globálne nastavenia a inputy
        hourlyWage = storedData.hourlyWage ?? 10;
        taxRate = storedData.taxRate ?? 0.02;
        employeeName = storedData.employeeName ?? '';
        decimalPlaces = storedData.decimalPlaces ?? DEFAULT_DECIMAL_PLACES;

        DOM.hourlyWageInput.value = hourlyWage;
        DOM.taxRateInput.value = (taxRate * 100).toFixed(1); // Zobraziť ako percento
        DOM.employeeNameInput.value = employeeName;
        DOM.decimalPlacesSelect.value = decimalPlaces;

        // 2. Vytvoriť štruktúru tabuľky (ak ešte neexistuje alebo pre istotu)
        createTableStructure();

        // 3. Naplniť tabuľku dátami
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        if (storedData.data && storedData.data.length >= daysInMonth) {
             storedData.data.slice(0, daysInMonth).forEach((dayData, index) => {
                const day = index + 1;
                const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
                const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
                const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

                if (startEl && endEl && breakEl) {
                    startEl.value = dayData.start || '';
                    endEl.value = dayData.end || '';
                    breakEl.value = dayData.breakTime || '';
                    // Prepočítame riadok, aby sa aktualizovali aj vypočítané hodnoty (čas, mzdy)
                    calculateRow(day);
                } else {
                    // console.warn(`Elementy pre deň ${day} neboli nájdené pri aplikovaní dát.`);
                }
             });
        } else {
             console.warn(`Nedostatok dát v poli 'data' pre mesiac ${currentMonth + 1}/${currentYear}. Očakávaných: ${daysInMonth}, Nájdených: ${storedData.data?.length ?? 0}`);
             // V tomto prípade by tabuľka zostala vyplnená len čiastočne alebo vôbec
        }

        // 4. Prepočítať celkové súčty
        calculateTotal();

        console.log('Dáta úspešne aplikované do UI.');
    }


    // -------------------- TVORBA TABUĽKY A VÝPOČTY --------------------

    /** Vytvorí len štruktúru tabuľky (riadky a inputy) */
    function createTableStructure() {
      console.log('Vytváram štruktúru tabuľky pre:', `${getMonthName(currentMonth)} ${currentYear}`);
      DOM.workDaysTableBody.innerHTML = ''; // Vyčistíme predchádzajúci obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);

      const fragment = document.createDocumentFragment(); // Optimalizácia - pridávame do fragmentu

      for (let i = 1; i <= daysInSelectedMonth; i++) {
        const row = document.createElement('tr');
        const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
        if (isCurrentDay) {
          row.classList.add('current-day');
          row.setAttribute('aria-current', 'date'); // Prístupnosť
        }

        const dayAbbr = getDayAbbreviation(currentYear, currentMonth, i);
        const idBase = `${currentYear}-${currentMonth}-${i}`;

        // Optimalizované vytvorenie buniek
        row.innerHTML = `
          <td>Deň ${i} (${dayAbbr})</td>
          <td><input type="tel" id="start-${idBase}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'end-${idBase}')" aria-label="Príchod deň ${i}"></td>
          <td><input type="tel" id="end-${idBase}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'break-${idBase}')" aria-label="Odchod deň ${i}"></td>
          <td><input type="number" id="break-${idBase}" min="0" step="0.1" placeholder="hod." oninput="handleBreakInput(${i})" aria-label="Prestávka v hodinách deň ${i}"></td>
          <td id="total-${idBase}" aria-label="Odpracovaný čas deň ${i}">0h 0m (0.0 h)</td>
          <td><input type="number" id="gross-${idBase}" readonly tabindex="-1" aria-label="Hrubá mzda deň ${i}"></td>
          <td><input type="number" id="net-${idBase}" readonly tabindex="-1" aria-label="Čistá mzda deň ${i}"></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})" aria-label="Vynulovať záznam pre deň ${i}">Vynulovať</button></td>
        `;
        fragment.appendChild(row);
      }
      DOM.workDaysTableBody.appendChild(fragment); // Pridáme celý fragment naraz
      console.log('Štruktúra tabuľky vytvorená.');
    }

    /** Vytvorí prázdnu tabuľku a vynuluje súčty */
    function createEmptyTable() {
        createTableStructure();
        calculateTotal(); // Vynuluje súčty
    }


    /** Spracuje vstup času a posunie focus */
    window.handleTimeInput = function(input, nextId) {
        let value = input.value.replace(/[^\d:]/g, ''); // Povolí len čísla a :

        // Automatické doplnenie ':'
        if (value.length === 2 && !value.includes(':')) {
            const hours = parseInt(value);
            if (hours >= 0 && hours < 24) { // Len ak sú prvé dve čísla platné hodiny
                 value += ':';
            }
        } else if (value.length === 3 && value.charAt(1) === ':') { // Prípad 1:30 -> 01:30
             value = '0' + value;
        } else if (value.length === 4 && value.charAt(2) !== ':') { // Prípad 1230 -> 12:30
             value = value.slice(0, 2) + ':' + value.slice(2);
        }

        // Obmedzenie dĺžky a validácia formátu HH:MM
        if (value.length > 5) value = value.slice(0, 5);
        input.value = value;

        // Validácia a prepočet
        if (timeRegex.test(value)) {
            input.setCustomValidity(''); // Platný formát
            const day = parseInt(input.id.split('-')[3]);
            calculateRow(day);
            triggerSave(); // Uložiť zmenu
            moveFocus(nextId);
        } else if (value.length > 0) {
            input.setCustomValidity('Neplatný formát času (HH:MM)'); // Nastaví neplatný stav pre CSS/JS
        } else {
             input.setCustomValidity(''); // Prázdne pole je OK
             const day = parseInt(input.id.split('-')[3]);
             calculateRow(day); // Prepočítať, ak sa čas vymaže
             triggerSave(); // Uložiť zmenu
        }
        // input.reportValidity(); // Zobrazí chybovú hlášku prehliadača (voliteľné)
    }

    /** Spracuje vstup prestávky */
    window.handleBreakInput = function(day) {
        const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if (!input) return;

        // Povoliť len čísla a jednu desatinnú bodku/čiarku, nahradiť čiarku bodkou
        let value = input.value.replace(',', '.').replace(/[^\d.]/g, '');
        // Zabrániť viacerým bodkám
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        // Obmedziť na napr. 1 desatinné miesto (hodnotu v hodinách)
        if (parts[1] && parts[1].length > 1) {
            value = parseFloat(value).toFixed(1);
        }

        input.value = value; // Aktualizovať hodnotu v poli

        // Validácia (musí byť číslo a nezáporné)
        const breakHours = parseFloat(value);
        if (value === '' || (!isNaN(breakHours) && breakHours >= 0)) {
            input.setCustomValidity('');
            calculateRow(day); // Prepočíta riadok
            triggerSave();     // Uloží zmenu
             // Presun fokusu po zadaní platnej hodnoty (voliteľné)
            // if (value !== '' && !isNaN(breakHours)) {
            //     const nextDay = day + 1;
            //     if (nextDay <= getDaysInMonth(currentYear, currentMonth)) {
            //         moveFocus(`start-${currentYear}-${currentMonth}-${nextDay}`);
            //     }
            // }
        } else {
            input.setCustomValidity('Prestávka musí byť nezáporné číslo.');
        }
        // input.reportValidity();
    }

    /** Presunie focus na ďalší element */
    function moveFocus(elementId) {
        const nextElement = document.getElementById(elementId);
        if (nextElement) {
            nextElement.focus();
            // Voliteľne: Označiť text v ďalšom poli
            if (nextElement.select) {
                 // Timeout, aby sa focus stihol presunúť pred selectom
                setTimeout(() => nextElement.select(), 0);
            }
        }
    }

    /** Vypočíta odpracované hodiny pre daný riadok */
    function calculateWorkHours(startTime, endTime, breakTimeStr) {
        if (!timeRegex.test(startTime) || !timeRegex.test(endTime)) {
            return { totalMinutes: 0, decimalHours: 0, formatted: `0h 0m (0.0 h)` };
        }

        const breakHours = parseFloat(String(breakTimeStr).replace(',', '.')) || 0;
        const breakMinutes = Math.max(0, breakHours) * 60;

        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);

        // Použitie Date objektov pre jednoduchší prechod cez polnoc
        const startDate = new Date(2000, 0, 1, startHours, startMinutes);
        let endDate = new Date(2000, 0, 1, endHours, endMinutes);

        // Ak je koncový čas menší ako začiatočný, predpokladáme prácu cez polnoc
        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1); // Posunúť endDate o deň
        }

        const diffMillis = endDate.getTime() - startDate.getTime();
        let diffMinutes = diffMillis / (1000 * 60); // Rozdiel v minútach

        // Odpočítať prestávku
        diffMinutes -= breakMinutes;
        diffMinutes = Math.max(0, diffMinutes); // Nemôže byť záporné

        const totalMinutesRounded = Math.round(diffMinutes); // Zaokrúhlenie na celé minúty
        const hoursPart = Math.floor(totalMinutesRounded / 60);
        const minutesPart = totalMinutesRounded % 60;
        const decimalHours = diffMinutes / 60; // Desatinné hodiny (presnejšie pre výplatu)

        return {
            totalMinutes: totalMinutesRounded, // Zaokrúhlené minúty pre zobrazenie
            decimalHours: decimalHours,         // Desatinné hodiny pre výpočet mzdy
            formatted: `${hoursPart}h ${minutesPart}m (${formatNumber(decimalHours)} h)`
        };
    }

     /** Vypočíta hrubú mzdu */
    function calculateGrossSalary(decimalHours) {
        return Math.max(0, decimalHours * hourlyWage);
    }

    /** Vypočíta čistú mzdu */
    function calculateNetSalary(grossSalary) {
        return Math.max(0, grossSalary * (1 - taxRate));
    }


    /** Prepočíta celý riadok (čas, mzdy) */
    function calculateRow(day) {
        const idBase = `${currentYear}-${currentMonth}-${day}`;
        const startTime = document.getElementById(`start-${idBase}`)?.value ?? '';
        const endTime = document.getElementById(`end-${idBase}`)?.value ?? '';
        const breakTimeStr = document.getElementById(`break-${idBase}`)?.value ?? '';
        const totalCell = document.getElementById(`total-${idBase}`);
        const grossInput = document.getElementById(`gross-${idBase}`);
        const netInput = document.getElementById(`net-${idBase}`);

        if (!totalCell || !grossInput || !netInput) {
            // console.warn(`Chýbajúce elementy pre výpočet dňa ${day}`);
            return; // Ak elementy neexistujú, nerobíme nič
        }

        const { decimalHours, formatted } = calculateWorkHours(startTime, endTime, breakTimeStr);
        const grossSalary = calculateGrossSalary(decimalHours);
        const netSalary = calculateNetSalary(grossSalary);

        totalCell.textContent = formatted;
        grossInput.value = formatNumber(grossSalary);
        netInput.value = formatNumber(netSalary);

        // calculateTotal() sa volá externe po potrebných calculateRow() alebo pri triggerSave()
    }

    /** Vynuluje jeden riadok */
    window.resetRow = function(day) {
        const idBase = `${currentYear}-${currentMonth}-${day}`;
        const startInput = document.getElementById(`start-${idBase}`);
        const endInput = document.getElementById(`end-${idBase}`);
        const breakInput = document.getElementById(`break-${idBase}`);

        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (breakInput) breakInput.value = '';

        // Reset validity a prepočet
        [startInput, endInput, breakInput].forEach(input => input?.setCustomValidity(''));
        calculateRow(day); // Prepočíta na nulu
        triggerSave();     // Uloží zmeny
        startInput?.focus(); // Vráti focus na začiatok riadku
    }

    /** Vypočíta a zobrazí celkové súčty */
    function calculateTotal() {
        let totalMinutesSum = 0;
        let totalGrossSum = 0;
        let totalNetSum = 0;
        let daysWithValidEntries = 0; // Počítame len dni s platným časom alebo prestávkou
        const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);

        for (let i = 1; i <= daysInSelectedMonth; i++) {
            const idBase = `${currentYear}-${currentMonth}-${i}`;
            const start = document.getElementById(`start-${idBase}`)?.value ?? '';
            const end = document.getElementById(`end-${idBase}`)?.value ?? '';
            const breakTimeStr = document.getElementById(`break-${idBase}`)?.value ?? '';

            const { totalMinutes, decimalHours } = calculateWorkHours(start, end, breakTimeStr);
            const gross = calculateGrossSalary(decimalHours);
            const net = calculateNetSalary(gross);

            totalMinutesSum += totalMinutes; // Sčítavame zaokrúhlené minúty pre zobrazenie celk. času
            totalGrossSum += gross;
            totalNetSum += net;

            // Započítať deň, ak má platný časový údaj ALEBO zadanú prestávku
             if (decimalHours > 0 || (parseFloat(breakTimeStr.replace(',', '.')) || 0) > 0) {
                 daysWithValidEntries++;
             }
        }

        const totalHoursPart = Math.floor(totalMinutesSum / 60);
        const totalMinutesPart = totalMinutesSum % 60;
        const totalDecimalHours = totalMinutesSum / 60; // Celkové desatinné hodiny

        const avgNetSalary = daysWithValidEntries > 0 ? totalNetSum / daysWithValidEntries : 0;
        const avgMinutes = daysWithValidEntries > 0 ? totalMinutesSum / daysWithValidEntries : 0;
        const avgHoursPart = Math.floor(avgMinutes / 60);
        const avgMinutesPart = Math.round(avgMinutes % 60); // Priemer zaokrúhlime
        const avgDecimalHours = avgMinutes / 60;


        DOM.totalSalaryDiv.innerHTML = `
            Počet započítaných dní: <strong>${daysWithValidEntries}</strong><br>
            Celkový odpracovaný čas: <strong>${totalHoursPart}h ${totalMinutesPart}m</strong> (${formatNumber(totalDecimalHours)} h)<br>
            Celková hrubá mzda: <strong>${formatNumber(totalGrossSum)} €</strong><br>
            Celková čistá mzda: <strong>${formatNumber(totalNetSum)} €</strong><br>
            Priemerná čistá mzda / deň: <strong>${formatNumber(avgNetSalary)} €</strong><br>
            Priemerný odpracovaný čas / deň: <strong>${avgHoursPart}h ${avgMinutesPart}m</strong> (${formatNumber(avgDecimalHours)} h)
        `;
    }

    // -------------------- OBSLUHA UDALOSTÍ UI --------------------

    /** Aktualizuje nastavenia (mzda, daň) a prepočíta všetko */
    window.updateSettings = function() {
        const newHourlyWage = parseFloat(DOM.hourlyWageInput.value) || 0;
        const newTaxRatePercent = parseFloat(DOM.taxRateInput.value) || 0;
        const newTaxRate = Math.max(0, Math.min(100, newTaxRatePercent)) / 100; // Validácia 0-100

        // Aktualizovať len ak sa hodnota zmenila, aby sa zbytočne neprepočítavalo
        let changed = false;
        if (newHourlyWage !== hourlyWage) {
            hourlyWage = newHourlyWage;
            changed = true;
        }
        if (newTaxRate !== taxRate) {
            taxRate = newTaxRate;
            // Korekcia zobrazenia v inpute, ak zadal napr. viac ako 100
            DOM.taxRateInput.value = (newTaxRate * 100).toFixed(1);
            changed = true;
        }

        if (changed) {
            console.log('Aktualizované nastavenia: Mzda=', hourlyWage, 'Daň=', taxRate);
            // Prepočítať všetky riadky a súčty
            const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInSelectedMonth; i++) calculateRow(i);
            calculateTotal();
            triggerSave(); // Uložiť zmeny (vrátane nových nastavení)
        }
    }

    /** Aktualizuje meno pracovníka */
    window.updateEmployeeName = function() {
        const newName = DOM.employeeNameInput.value.trim();
        if (newName !== employeeName) {
            employeeName = newName;
            console.log('Meno pracovníka aktualizované:', employeeName);
            // Meno neovplyvňuje výpočty, stačí uložiť
            triggerSave();
        }
    }

    /** Zmena desatinných miest */
    window.changeDecimalPlaces = function() {
        const newPlaces = parseInt(DOM.decimalPlacesSelect.value);
        if (newPlaces !== decimalPlaces) {
            decimalPlaces = newPlaces;
            console.log('Počet desatinných miest zmenený na:', decimalPlaces);
            // Prepočítať zobrazenie v tabuľke a súčty
             const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInSelectedMonth; i++) calculateRow(i);
            calculateTotal();
            triggerSave(); // Uložiť zmenu nastavenia
        }
    }

    /** Zmena mesiaca */
    window.changeMonth = function() {
        const newMonth = parseInt(DOM.monthSelect.value);
        if (newMonth !== currentMonth) {
            currentMonth = newMonth;
            console.log(`Zmena mesiaca na: ${getMonthName(currentMonth)} (${currentMonth})`);
            // Vyčistiť cache pre istotu? Alebo nechať.
            // monthDataCache = {};
            loadInitialData(); // Načítať dáta pre nový mesiac
             updatePageTitle();
        }
    }

    /** Zmena roku */
    window.changeYear = function() {
        const newYear = parseInt(DOM.yearSelect.value);
        if (newYear !== currentYear) {
            currentYear = newYear;
            console.log(`Zmena roku na: ${currentYear}`);
            // Vyčistiť cache pre istotu? Alebo nechať.
            // monthDataCache = {};
            loadInitialData(); // Načítať dáta pre nový rok
            updatePageTitle();
        }
    }

    /** Prepínanie tmavého režimu */
    window.toggleDarkMode = function() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDarkMode);
        console.log('Tmavý režim:', isDarkMode ? 'Zapnutý' : 'Vypnutý');
    }

     /** Aktualizuje titulok stránky */
     function updatePageTitle() {
         document.title = `Bruno's Calc - ${getMonthName(currentMonth)} ${currentYear}${employeeName ? ` | ${employeeName}` : ''}`;
         DOM.subTitle.textContent = `Evidencia za ${getMonthName(currentMonth)} ${currentYear}`;
     }

     /** Naplní select pre roky */
    function populateYearSelect() {
        const startYear = 2020;
        const endYear = new Date().getFullYear() + 2; // Pár rokov do budúcnosti
        const fragment = document.createDocumentFragment();
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            fragment.appendChild(option);
        }
        DOM.yearSelect.appendChild(fragment);
    }

    // -------------------- AUTENTIFIKÁCIA Firebase --------------------

    window.login = async function() {
        if (!isOnline) return showErrorNotification('Ste offline. Prihlásenie vyžaduje internetové pripojenie.');
        if (!db || !auth) return showErrorNotification('Chyba pripojenia k Firebase.');

        const email = DOM.loginForm.querySelector('#email').value;
        const password = DOM.loginForm.querySelector('#password').value;
        if (!email || !password) return showErrorNotification('Prosím, zadajte email aj heslo.');

        setLoading(true);
        DOM.loginButton.disabled = true;
        DOM.registerButton.disabled = true;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            currentUser = userCredential.user;
            console.log('Prihlásený:', currentUser.email);
            updateAuthUI(); // Zobrazí info, skryje formulár
            // Po prihlásení automaticky skúsime načítať/synchronizovať dáta
            loadInitialData();
        } catch (error) {
            console.error('Chyba pri prihlásení:', error);
            showErrorNotification(`Chyba pri prihlásení: ${mapFirebaseAuthError(error.code)}`);
            currentUser = null; // Reset užívateľa pri chybe
            updateAuthUI();
        } finally {
             setLoading(false);
             DOM.loginButton.disabled = false;
             DOM.registerButton.disabled = false;
        }
    }

    window.register = async function() {
        if (!isOnline) return showErrorNotification('Ste offline. Registrácia vyžaduje internetové pripojenie.');
         if (!db || !auth) return showErrorNotification('Chyba pripojenia k Firebase.');

        const email = DOM.loginForm.querySelector('#email').value;
        const password = DOM.loginForm.querySelector('#password').value;
         if (!email || password.length < 6) return showErrorNotification('Prosím, zadajte platný email a heslo (min. 6 znakov).');

        setLoading(true);
         DOM.loginButton.disabled = true;
         DOM.registerButton.disabled = true;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            currentUser = userCredential.user;
            console.log('Zaregistrovaný a prihlásený:', currentUser.email);
            // Po úspešnej registrácii môžeme vytvoriť základný dokument užívateľa
            await createUserProfileIfNeeded(currentUser);
            updateAuthUI();
            // Po registrácii nie je čo načítavať, zobrazíme prázdnu tabuľku
            createEmptyTable();
            triggerSave(); // Uložíme prázdny stav pre nového usera

        } catch (error) {
            console.error('Chyba pri registrácii:', error);
            showErrorNotification(`Chyba pri registrácii: ${mapFirebaseAuthError(error.code)}`);
            currentUser = null;
            updateAuthUI();
        } finally {
             setLoading(false);
             DOM.loginButton.disabled = false;
             DOM.registerButton.disabled = false;
        }
    }

    window.logout = async function() {
        if (!auth) return;
        setLoading(true);
        DOM.logoutButton.disabled = true;
        try {
            await signOut(auth);
            console.log('Užívateľ odhlásený.');
            currentUser = null;
            monthDataCache = {}; // Vymazať cache po odhlásení
            updateAuthUI();
            // Po odhlásení načítame dáta LEN z localStorage (ak nejaké sú)
            loadInitialData(); // loadInitialData teraz správne handle-uje offline/neprihlásený stav
        } catch (error) {
            console.error('Chyba pri odhlásení:', error);
            showErrorNotification('Chyba pri odhlásení.');
            // UI zostane v stave prihlásenia, ak sa nepodarí odhlásiť?
        } finally {
            setLoading(false);
             // Enable button again? Or rely on UI update? Re-enable in updateAuthUI maybe.
        }
    }

    /** Vytvorí profil užívateľa v DB, ak neexistuje */
    async function createUserProfileIfNeeded(user) {
        if (!user || !db) return;
        const userRef = doc(db, 'users', user.uid);
        try {
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                await setDoc(userRef, {
                    email: user.email,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });
                console.log(`Vytvorený profil pre ${user.email}`);
                // Vytvorenie podkolekcie 'workDays' nie je nutné vopred
            } else {
                 // Aktualizovať lastLogin pri existujúcom profile
                 await setDoc(userRef, { lastLogin: serverTimestamp() }, { merge: true });
                 console.log(`Aktualizovaný lastLogin pre ${user.email}`);
            }
        } catch (error) {
            console.error(`Chyba pri vytváraní/aktualizácii profilu pre ${user.uid}:`, error);
            // Nejde o kritickú chybu pre funkčnosť appky, len logujeme
        }
    }


    /** Mapuje Firebase Auth error kódy na zrozumiteľné správy */
    function mapFirebaseAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatný formát emailu.';
            case 'auth/user-disabled': return 'Tento účet bol deaktivovaný.';
            case 'auth/user-not-found': return 'Účet s týmto emailom neexistuje.';
            case 'auth/wrong-password': return 'Nesprávne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je už zaregistrovaný.';
            case 'auth/weak-password': return 'Heslo je príliš slabé (min. 6 znakov).';
            case 'auth/requires-recent-login': return 'Táto operácia vyžaduje nedávne prihlásenie.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            default: return `Neznáma chyba (${errorCode})`;
        }
    }

    /** Aktualizuje UI pre prihlásenie/odhlásenie */
    function updateAuthUI() {
        if (currentUser) {
            DOM.loginForm.style.display = 'none';
            DOM.userInfo.style.display = 'flex'; // Používame flex pre layout
            DOM.userEmailSpan.textContent = currentUser.email;
            DOM.logoutButton.disabled = false;
            // Povolíme tlačidlo Načítať z cloudu
            if (DOM.loadFromCloudButton) DOM.loadFromCloudButton.disabled = false;
        } else {
            DOM.loginForm.style.display = 'flex'; // Používame flex
            DOM.userInfo.style.display = 'none';
            DOM.userEmailSpan.textContent = '';
            // Vyčistiť formulár
            DOM.loginForm.querySelector('#email').value = '';
            DOM.loginForm.querySelector('#password').value = '';
            // Zakážeme tlačidlo Načítať z cloudu
            if (DOM.loadFromCloudButton) DOM.loadFromCloudButton.disabled = true;
        }
    }

    // Listener na zmeny stavu prihlásenia
    onAuthStateChanged(auth, async (user) => {
        console.log('Stav autentifikácie zmenený. User:', user?.uid ?? 'None');
        setLoading(true);
        if (user) {
            currentUser = user;
            // Aktualizovať profil (lastLogin) asynchrónne
            createUserProfileIfNeeded(user).catch(console.error);
        } else {
            currentUser = null;
            monthDataCache = {}; // Vymazať cache pri odhlásení
        }
        updateAuthUI();
        await loadInitialData(); // Vždy načítať dáta po zmene stavu prihlásenia
        setLoading(false);
        updatePageTitle();
    }, (error) => {
        // Chyba pri sledovaní stavu prihlásenia
        console.error("Chyba onAuthStateChanged:", error);
        showErrorNotification("Chyba pri komunikácii so serverom autentifikácie.", true);
        currentUser = null; // Pre istotu
        updateAuthUI();
        loadInitialData(); // Skúsiť načítať aspoň lokálne dáta
    });


    // -------------------- EXPORT A ZÁLOHA --------------------

    /** Získa dáta pre export/zálohu (z aktuálneho UI stavu) */
    function getExportData() {
        const data = [
            // Hlavička
            ['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované (h:m)', 'Odpr. (dec. h)', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']
        ];
        const daysInSelectedMonth = getDaysInMonth(currentYear, currentMonth);
        let totalMinutesSum = 0, totalGrossSum = 0, totalNetSum = 0;

        for (let i = 1; i <= daysInSelectedMonth; i++) {
            const idBase = `${currentYear}-${currentMonth}-${i}`;
            const dayAbbr = getDayAbbreviation(currentYear, currentMonth, i);
            const start = document.getElementById(`start-${idBase}`)?.value ?? '';
            const end = document.getElementById(`end-${idBase}`)?.value ?? '';
            const breakTimeStr = document.getElementById(`break-${idBase}`)?.value ?? '';
            // Opätovný výpočet pre presnosť exportu
            const { totalMinutes, decimalHours, formatted } = calculateWorkHours(start, end, breakTimeStr);
            const gross = calculateGrossSalary(decimalHours);
            const net = calculateNetSalary(gross);

            // Pridáme riadok len ak je nejaký záznam (čas alebo prestávka)
            if (start || end || (parseFloat(breakTimeStr.replace(',', '.')) || 0) > 0) {
                data.push([
                    `Deň ${i} (${dayAbbr})`,
                    start,
                    end,
                    breakTimeStr.replace('.', ','), // Export s čiarkou
                    formatted.split('(')[0].trim(), // Len H:M
                    formatNumber(decimalHours).replace('.',','), // Dec. hodiny s čiarkou
                    formatNumber(gross).replace('.',','),
                    formatNumber(net).replace('.',',')
                ]);
            }
            totalMinutesSum += totalMinutes;
            totalGrossSum += gross;
            totalNetSum += net;
        }

        // Pridať súčty a nastavenia na koniec
        const totalHoursPart = Math.floor(totalMinutesSum / 60);
        const totalMinutesPart = totalMinutesSum % 60;
        const totalDecimalHours = totalMinutesSum / 60;

        const summary = [
            [], // Prázdny riadok ako oddeľovač
            ['', '', '', '', 'SÚHRN:', '', '', ''],
            ['Meno pracovníka:', employeeName, '', '', 'Celkový čas:', `${totalHoursPart}h ${totalMinutesPart}m`, `(${formatNumber(totalDecimalHours).replace('.',',')} h)`, ''],
            ['Hodinová mzda:', `${formatNumber(hourlyWage).replace('.',',')} €`, '', '', 'Hrubá mzda celkom:', `${formatNumber(totalGrossSum).replace('.',',')} €`, '', ''],
            ['Daň (%):', `${(taxRate * 100).toFixed(1).replace('.',',')}`, '', '', 'Čistá mzda celkom:', `${formatNumber(totalNetSum).replace('.',',')} €`, '', '']
        ];

        return { tableData: data.concat(summary), rawTableData: data }; // Vrátiť aj čisté dáta pre PDF
    }

    /** Export do PDF */
    window.exportToPDF = function() {
        try {
            setLoading(true);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Pridanie fontu podporujúceho diakritiku (ak treba - Roboto štandardne má obmedzenú podporu)
            // Riešenie: Použiť štandardný font alebo vložiť vlastný .ttf
            // Príklad s vlastným (treba mať súbor fontu):
            // doc.addFileToVFS("Roboto-Regular.ttf", robotoFontBase64); // font musí byť base64 string
            // doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
            doc.setFont('helvetica'); // Štandardný font, ktorý by mal byť OK

            const title = `Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`;
            doc.setFontSize(18);
            doc.text(title, 14, 20);
            if (employeeName) {
                doc.setFontSize(12);
                doc.text(`Pracovník: ${employeeName}`, 14, 27);
            }

            const { rawTableData } = getExportData(); // Získať len dáta tabuľky bez súhrnu
            const bodyData = rawTableData.slice(1).map(row => row.slice(0, 8)); // Odstrániť hlavičku a zobrať prvých 8 stĺpcov

            doc.autoTable({
                head: [rawTableData[0].slice(0, 8)], // Hlavička
                body: bodyData,
                startY: 35,
                styles: { font: 'helvetica', fontSize: 9 }, // Menšie písmo pre PDF
                headStyles: { fillColor: [76, 175, 80], textColor: 255, fontStyle: 'bold' },
                theme: 'grid', // Alebo 'striped'
                didParseCell: function (data) { // Centrovanie číselných stĺpcov
                     const colIndex = data.column.index;
                     if (colIndex >= 3 && colIndex <= 7) { // Stĺpce od Prestávka po Čistá mzda
                          data.cell.styles.halign = 'right';
                     }
                 }
            });

            // Pridať súčty pod tabuľku
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            // Získať text zo súhrnného divu a vyčistiť HTML
            const totalText = DOM.totalSalaryDiv.innerText || DOM.totalSalaryDiv.textContent;
            doc.text(totalText, 14, finalY);

            doc.save(`vykaz-${employeeName ? employeeName.replace(/\s+/g, '_') + '-' : ''}${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`);
            showSaveNotification('PDF súbor úspešne vygenerovaný.');

        } catch (error) {
            console.error("Chyba pri generovaní PDF:", error);
            showErrorNotification(`Chyba pri exporte do PDF: ${error.message}`);
        } finally {
            setLoading(false);
        }
    }

    /** Odoslanie PDF cez navigator.share */
    window.sendPDF = async function() {
        if (!navigator.share || !navigator.canShare) {
            return showErrorNotification('Zdieľanie súborov nie je podporované vaším prehliadačom alebo zariadením.');
        }

        try {
            setLoading(true);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('helvetica'); // Alebo iný font

            const title = `Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`;
            doc.setFontSize(18);
            doc.text(title, 14, 20);
             if (employeeName) {
                 doc.setFontSize(12);
                 doc.text(`Pracovník: ${employeeName}`, 14, 27);
             }

            const { rawTableData } = getExportData();
            const bodyData = rawTableData.slice(1).map(row => row.slice(0, 8));

            doc.autoTable({
                head: [rawTableData[0].slice(0, 8)],
                body: bodyData,
                startY: 35,
                styles: { font: 'helvetica', fontSize: 9 },
                headStyles: { fillColor: [76, 175, 80], textColor: 255, fontStyle: 'bold' },
                theme: 'grid',
                 didParseCell: function (data) {
                      const colIndex = data.column.index;
                      if (colIndex >= 3 && colIndex <= 7) { data.cell.styles.halign = 'right'; }
                  }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            const totalText = DOM.totalSalaryDiv.innerText || DOM.totalSalaryDiv.textContent;
            doc.text(totalText, 14, finalY);

            const pdfBlob = doc.output('blob');
            const filename = `vykaz-${employeeName ? employeeName.replace(/\s+/g, '_') + '-' : ''}${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`;
            const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });

            if (navigator.canShare({ files: [pdfFile] })) {
                await navigator.share({
                    files: [pdfFile],
                    title: title,
                    text: `Výkaz práce za ${getMonthName(currentMonth)} ${currentYear}${employeeName ? ` pre ${employeeName}` : ''}`
                });
                console.log('PDF úspešne odoslané cez Share API.');
            } else {
                showErrorNotification('Zdieľanie PDF súborov nie je v tejto chvíli možné.');
            }
        } catch (error) {
             // Chyba "AbortError" je bežná, ak užívateľ zruší zdieľanie
            if (error.name !== 'AbortError') {
                console.error('Chyba pri zdieľaní PDF:', error);
                showErrorNotification(`Chyba pri zdieľaní PDF: ${error.message}`);
            } else {
                console.log("Zdieľanie PDF zrušené užívateľom.");
            }
        } finally {
            setLoading(false);
        }
    }


    /** Vytvorenie zálohy do Excelu */
    window.createBackup = function() {
        try {
            setLoading(true);
            const { tableData } = getExportData(); // Získať dáta vrátane súhrnu

            // Nahradiť prípadné HTML entity v mene pracovníka
            const cleanEmployeeName = employeeName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Vytvorenie worksheet
            const ws = XLSX.utils.aoa_to_sheet(tableData);

            // Prispôsobenie šírky stĺpcov (voliteľné)
            const columnWidths = [
                { wch: 18 }, // Deň
                { wch: 10 }, // Príchod
                { wch: 10 }, // Odchod
                { wch: 12 }, // Prestávka
                { wch: 15 }, // Odpracované H:M
                { wch: 15 }, // Odpracované Dec.
                { wch: 18 }, // Hrubá Mzda
                { wch: 18 }  // Čistá Mzda
            ];
            ws['!cols'] = columnWidths;

            // Vytvorenie workbooku
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)}`);

            // Generovanie a stiahnutie súboru
            const filename = `zaloha-${cleanEmployeeName ? cleanEmployeeName.replace(/\s+/g, '_') + '-' : ''}${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.xlsx`;
            XLSX.writeFile(wb, filename);
            showSaveNotification('Excel záloha úspešne vytvorená.');

        } catch (error) {
            console.error("Chyba pri vytváraní Excel zálohy:", error);
            showErrorNotification(`Chyba pri vytváraní zálohy: ${error.message}`);
        } finally {
            setLoading(false);
        }
    };

    /** Spustí výber súboru pre obnovu */
    window.triggerRestoreBackup = function() {
        DOM.restoreFileInput.click(); // Otvorí dialóg na výber súboru
    }

    /** Spracuje vybraný súbor zálohy */
    window.handleRestoreFile = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        setLoading(true);
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0]; // Predpokladáme prvý list
                if (!sheetName) throw new Error("Záložný súbor neobsahuje žiadne listy.");

                const ws = workbook.Sheets[sheetName];
                // Skúsime získať dáta ako pole polí (lepšie pre kontrolu štruktúry)
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

                // -- Parsrovanie dát zo sheetu --
                let restoredDataArray = [];
                let restoredSettings = {};
                let dataParsingStarted = false;
                let headerRowFound = false;

                // Očakávané hlavičky (flexibilnejšie porovnanie)
                const expectedHeaders = ["deň", "príchod", "odchod", "prestávka", "hrubá mzda", "čistá mzda"];

                for (const row of rows) {
                    if (!Array.isArray(row)) continue; // Ignorovať neplatné riadky

                    const firstCellLower = String(row[0]).toLowerCase().trim();

                    // Hľadanie hlavičky
                    if (!headerRowFound && expectedHeaders.every(header => row.some(cell => String(cell).toLowerCase().trim().includes(header)))) {
                        headerRowFound = true;
                        dataParsingStarted = true;
                        continue; // Preskočiť riadok hlavičky
                    }

                    // Parsovanie dátových riadkov (ak sme našli hlavičku a riadok vyzerá ako dátový)
                    if (dataParsingStarted && firstCellLower.startsWith("deň")) {
                        // Predpokladáme poradie: Deň, Príchod, Odchod, Prestávka, _, _, Hrubá, Čistá
                        // Indexy môžu byť iné, ale toto je základ z exportu
                        restoredDataArray.push({
                            start: String(row[1] ?? ''), // Príchod
                            end: String(row[2] ?? ''),   // Odchod
                            breakTime: String(row[3] ?? '').replace(',', '.'), // Prestávka (späť na bodku)
                            // Mzdy a hodiny sa dopočítajú pri aplikácii
                        });
                    }
                    // Parsovanie nastavení (ak sme skončili s dátami alebo nenašli hlavičku)
                    else if (row.length >= 2) {
                        const key = firstCellLower.replace(':', '');
                        const value = String(row[1]).trim();

                        if (key.includes("hodinová mzda")) restoredSettings.hourlyWage = parseFloat(value.replace('€', '').replace(',', '.')) || undefined;
                        else if (key.includes("daň (%)")) restoredSettings.taxRate = (parseFloat(value.replace('%', '').replace(',', '.')) || 0) / 100;
                        else if (key.includes("meno pracovníka")) restoredSettings.employeeName = value;
                        // Desatinné miesta sa nenačítavajú zo zálohy, použijú sa aktuálne
                    }
                }

                if (!headerRowFound && restoredDataArray.length === 0) {
                    throw new Error("Nepodarilo sa nájsť rozpoznateľné dáta dochádzky v súbore.");
                }

                // Potvrdenie od užívateľa
                 if (!confirm(`Našli sa dáta pre ${restoredDataArray.length} dní. Naozaj chcete obnoviť tieto dáta a nastavenia? Aktuálne dáta pre tento mesiac budú prepísané.`)) {
                      DOM.restoreFileInput.value = ''; // Reset inputu
                      setLoading(false);
                      return;
                 }


                // Zostavenie objektu pre aplikáciu
                const backupData = {
                  data: restoredDataArray,
                  // Použiť obnovené nastavenia, ak existujú, inak ponechať aktuálne
                  hourlyWage: restoredSettings.hourlyWage ?? hourlyWage,
                  taxRate: restoredSettings.taxRate ?? taxRate,
                  employeeName: restoredSettings.employeeName ?? employeeName,
                  decimalPlaces: decimalPlaces, // Ponechať aktuálne
                  lastUpdated: new Date().toISOString() // Označiť ako práve obnovené
                };

                // Uložíme obnovené dáta do localStorage a cache
                const dataKey = getDataKey(currentYear, currentMonth);
                localStorage.setItem(dataKey, JSON.stringify(backupData));
                monthDataCache[dataKey] = backupData;

                // Aplikujeme dáta do UI
                applyDataToUI(backupData);
                showSaveNotification('Záloha bola úspešne obnovená.');

                // Ak je užívateľ prihlásený a online, automaticky uložíme obnovené dáta do cloudu
                if (currentUser && isOnline) {
                  console.log("Ukladám obnovené dáta do Firestore...");
                  // Zavoláme save priamo, nie debouncovanú verziu, aby sa uložilo hneď
                  const saveData = collectCurrentData(); // Znova zozbierať, teraz už s obnovenými dátami
                  const userRef = doc(db, 'users', currentUser.uid);
                  const docRef = doc(userRef, 'workDays', dataKey);
                  setDoc(docRef, saveData).then(() => {
                       showSyncNotification("Obnovené dáta synchronizované s cloudom.");
                       setSyncState('idle');
                       localStorage.removeItem(`pendingSync-${dataKey}`);
                  }).catch(err => {
                       console.error("Chyba pri ukladaní obnovených dát do Firestore:", err);
                       showErrorNotification("Chyba pri synchronizácii obnovených dát.");
                       localStorage.setItem(`pendingSync-${dataKey}`, JSON.stringify(saveData));
                       setSyncState('error');
                  });
                }

            } catch (error) {
                console.error('Chyba pri načítavaní zálohy:', error);
                showErrorNotification(`Chyba pri spracovaní zálohy: ${error.message}`);
            } finally {
                 DOM.restoreFileInput.value = ''; // Reset inputu pre možnosť nahrať rovnaký súbor znova
                 setLoading(false);
            }
        };

        reader.onerror = function() {
            showErrorNotification('Chyba pri čítaní súboru zálohy.');
            DOM.restoreFileInput.value = '';
            setLoading(false);
        }

        reader.readAsArrayBuffer(file);
    };


    // -------------------- INICIALIZÁCIA APLIKÁCIE --------------------
    function initializeAppUI() {
        console.log("Inicializujem UI...");
        // Načítanie preferencie tmavého režimu
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        // Naplnenie selectov
        populateYearSelect();
        // Nastavenie predvolených hodnôt selectov a inputov z globálnych premenných
        DOM.monthSelect.value = currentMonth;
        DOM.yearSelect.value = currentYear;
        DOM.decimalPlacesSelect.value = decimalPlaces;
        DOM.hourlyWageInput.value = hourlyWage;
        DOM.taxRateInput.value = (taxRate * 100).toFixed(1);
        DOM.employeeNameInput.value = employeeName;

        updatePageTitle();
        updateOnlineStatus(); // Zistiť počiatočný stav pripojenia

        // Prvotné načítanie dát sa deje v onAuthStateChanged listeneri

        console.log("UI inicializované.");
    }

    // Spustenie inicializácie po načítaní DOMu
    document.addEventListener('DOMContentLoaded', initializeAppUI);

    // Globálne funkcie prístupné z HTML (kvôli type="module")
    // Už sú definované vyššie s `window.` prefixom, takže toto nie je nutné,
    // ale môže slúžiť ako prehľad dostupných funkcií.
    // window.login = login;
    // window.register = register;
    // ... atď.

  </script>

  <!-- Registrácia Service Workera (pre PWA funkčnosť) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne, rozsah:', registration.scope);
            // Tu môžete pridať logiku pre aktualizáciu SW, ak je to potrebné
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
       // Listener pre správy od Service Workera (napr. o dostupnosti aktualizácie)
       navigator.serviceWorker.addEventListener('message', event => {
           console.log("Správa od SW:", event.data);
           if (event.data && event.data.type === 'SKIP_WAITING_COMPLETE') {
                window.location.reload(); // Automaticky obnoviť stránku po aktivácii nového SW
           } else if (event.data && event.data.type === 'CACHE_UPDATED') {
               // Informovať užívateľa o aktualizovaných dátach na pozadí
               // showNotification(document.getElementById('syncNotification'), 'Dáta na pozadí aktualizované.');
           }
       });
    }
  </script>
</body>
</html>
