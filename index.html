<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator</title>

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* --- VŠETKY ŠTÝLY ZOSTÁVAJÚ NEZMENENÉ --- */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .settings > div, .settings > button#toggleSettingsBtn, .settings > button.highlight {
      margin: 2px 5px;
    }
    .settings > div {
      flex: 1 1 200px;
    }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%;
      margin-bottom: 10px;
      background-color: #eee;
      color: #333;
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px 12px;
    }
    body.dark-mode .settings > button#toggleSettingsBtn {
        background-color: #555;
        color: #f4f4f4;
        border-color: #666;
    }
     .settings > button.highlight {
       flex: 1 1 150px;
     }
     .settings > button#enableNotificationsBtn {
         flex-basis: 100%;
         margin-top: 10px;
         background-color: #ff9800;
     }
     .settings > button#enableNotificationsBtn:disabled {
         background-color: #bdbdbd;
         cursor: default;
     }
     body.dark-mode .settings > button#enableNotificationsBtn {
          background-color: #e65100;
     }
     body.dark-mode .settings > button#enableNotificationsBtn:disabled {
          background-color: #616161;
     }
    .settings label {
      display: block;
      margin-bottom: 2px;
    }
    #settings-collapsible-content {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
    }
    #settings-collapsible-content.visible {
        max-height: 400px;
        opacity: 1;
        margin-top: 5px;
    }
    #settings-collapsible-content > div {
         flex: 1 1 200px;
         margin: 2px 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7) {
      width: 25%;
    }
    th:nth-child(1), td:nth-child(1),
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(8), td:nth-child(8) {
      width: 8.33%;
    }
    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }
    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px;
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: background-color 0.3s ease;
    }
    .reset-btn {
      background-color: #f44336;
    }
    .reset-btn:hover {
      background-color: #d32f2f;
    }
    .export-btn {
      background-color: #4CAF50;
    }
    .export-btn:hover {
      background-color: #388e3c;
    }
    .backup-btn {
      background-color: #8a2be2;
      padding: 15px 20px;
    }
    .backup-btn:hover {
      background-color: #6a1bb2;
    }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    body.dark-mode .container {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode h1 {
        color: #f4f4f4;
    }
    body.dark-mode table {
      background-color: #555;
      color: #f4f4f4;
    }
    body.dark-mode th {
      background-color: #666;
    }
    body.dark-mode td {
      background-color: #444;
      color: #f4f4f4;
    }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select {
      background-color: #666;
      color: white;
      border-color: #555;
    }
    body.dark-mode .btn {
      color: #f4f4f4;
    }
    body.dark-mode .reset-btn {
      background-color: #d32f2f;
    }
    body.dark-mode .export-btn {
      background-color: #388e3c;
    }
    body.dark-mode .backup-btn {
      background-color: #6a1bb2;
    }
    body.dark-mode #totalSalary {
      background-color: #2c3e50;
    }
    body.dark-mode .current-day {
      background-color: #4a0e8f;
      color: #fff;
    }
    body.dark-mode .current-day input {
      background-color: #5c1db3;
      color: #fff;
    }

    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#toggleSettingsBtn { flex-basis: auto; width: 100%; margin-bottom: 10px; }
      .settings > button.highlight { flex-basis: auto; width: 100%; margin: 5px 0; }
      .settings > button#enableNotificationsBtn { flex-basis: auto; width: 100%; margin: 10px 0 5px 0; }
      #settings-collapsible-content { flex-direction: column; align-items: stretch; }
      #settings-collapsible-content > div { flex-basis: auto; width: 100%; margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 600px; }
      table { min-width: 800px; }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn-container { flex-direction: column; align-items: stretch; }
      .btn { flex: 1 1 auto; font-size: 14px; padding: 8px 16px; margin: 5px 0; }
      .backup-btn { padding: 15px 16px; }
      #totalSalary { font-size: 16px; }
      #dataSizeContainer { font-size: 12px; }
      .table-container { overflow-x: auto; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.7em; }
      .btn { font-size: 12px; padding: 6px 12px; }
      .backup-btn { padding: 15px 12px; }
      .settings label { font-size: 0.9em; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 12px; }
      table { min-width: 800px; }
      .settings > button#toggleSettingsBtn, .settings > button.highlight { margin: 5px 0; }
      #settings-collapsible-content > div { margin: 5px 0; }
      #settings-collapsible-content.visible { max-height: 700px; }
      .settings > button#enableNotificationsBtn { margin: 10px 0 5px 0; }
    }
    #saveNotification, #errorNotification {
      display: none; position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 5px; font-size: 14px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out;
    }
    #saveNotification.show, #errorNotification.show { display: block; opacity: 1; }
    #saveNotification { background-color: #4CAF50; color: white; }
    #errorNotification { background-color: #f44336; color: white; }
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] { width: 200px; margin: 5px auto; display: block; }
    #login-form .btn { width: 120px; margin: 5px 2px; }
    #login-form a { margin-top: 10px; display: block; font-size: 0.9em; color: #007bff; text-decoration: none; }
    #login-form a:hover { text-decoration: underline; }
    body.dark-mode #login-form a { color: #6bbaff; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
        <button class="btn export-btn" onclick="register()">Registrovať</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Ahoj</h1>
    <h2></h2>

    <!-- Nastavenia -->
    <div class="settings">
      <button id="toggleSettingsBtn" class="btn">Zobraziť nastavenia ▼</button>
      <div id="settings-collapsible-content">
          <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
          <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
          <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
          <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
          <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
          <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
      </div>
       <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
       <button id="enableNotificationsBtn" class="btn highlight">Povoliť Notifikácie</button>
       {/* -------------------------------------- */}
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Načítanie z Firebase</button>
    </div>
  </div>

  <div id="saveNotification">Dáta boli úspešne uložené</div>
  <div id="errorNotification"></div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // Načítanie preferencie tmavého režimu...
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
    window.toggleDarkMode = function() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, arrayUnion, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.firebasestorage.app",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);
    let messaging = null;
    try {
        if (typeof getMessaging === 'function') {
             messaging = getMessaging(app);
             console.log("Firebase Messaging initialized.");
        } else {
            console.warn("Firebase Messaging is not available/imported correctly.");
        }
    } catch (error) {
        console.error("Error initializing Firebase Messaging:", error);
    }

    // -------------------- GLOBÁLNE PREMENNÉ --------------------
    // OPRAVA 1: Pridaná premenná pre SW registráciu
    let swRegistration = null;
    let currentUser = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
    const settingsCollapsibleContent = document.getElementById('settings-collapsible-content');
    const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(hourlyWageInput.value) || 10;
    let taxRate = (parseFloat(taxRateInput.value) || 2) / 100;
    let monthData = {};

    // --- VŠETKY OSTATNÉ FUNKCIE A KÓD ZOSTAJÚ NEZMENENÉ AŽ PO SEKIU PUSH NOTIFIKÁCIÍ ---
    // --- (updateGreeting, populateYearSelect, skrývanie, online/offline, notifikácie, Auth, createUserCollection, UI Update, loadData, save/sync, export, záloha, výpočty, atď...) ---
    function updateGreeting() { /* ... kód ... */ }
    function populateYearSelect() { /* ... kód ... */ }
    if (toggleSettingsBtn && settingsCollapsibleContent) { /* ... kód ... */ }
    function isOnline() { /* ... kód ... */ }
    window.addEventListener('online', () => { /* ... kód ... */ });
    window.addEventListener('offline', () => { /* ... kód ... */ });
    function showStatusNotification(message, color) { /* ... kód ... */ }
    function showErrorNotification(message) { /* ... kód ... */ }
    function showSaveNotification(message = 'Dáta boli úspešne uložené') { /* ... kód ... */ }
    window.login = async function() { /* ... kód ... */ }
    window.register = async function() { /* ... kód ... */ }
    window.logout = async function() { /* ... kód ... */ }
    window.resetPassword = async function() { /* ... kód ... */ }
    function mapFirebaseAuthError(errorCode) { /* ... kód ... */ }
    async function createUserCollection() { /* ... kód ... */ }
    function updateUI() { /* ... kód ... */ }
    async function loadInitialData() { /* ... kód ... */ }
    async function loadFromFirestoreAndApply() { /* ... kód ... */ }
    function debounce(func, wait) { /* ... kód ... */ }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1000);
    function collectCurrentData() { /* ... kód ... */ }
    async function saveToFirestore() { /* ... kód ... */ }
    async function syncWithFirebase() { /* ... kód ... */ }
    window.loadFromFirestore = async function() { /* ... kód ... */ }
    function loadFromLocalStorageOnly() { /* ... kód ... */ }
    function parseAndApplyData(dataString) { /* ... kód ... */ }
    function getDayName(year, month, day) { /* ... kód ... */ }
    function createTable() { /* ... kód ... */ }
    window.handleInput = function(input, nextId) { /* ... kód ... */ }
    window.handleBreakInput = function(day) { /* ... kód ... */ }
    function calculateAndUpdateTotals() { /* ... kód ... */ }
    function isValidTimeFormat(timeString) { /* ... kód ... */ }
    function formatAndMoveNext(input, nextId) { /* ... kód ... */ }
    function moveNext(currentElement, nextId) { /* ... kód ... */ }
    function calculateRow(day) { /* ... kód ... */ }
    function updateNetSalary(day) { /* ... kód ... */ }
    window.resetRow = function(day, saveChanges = true) { /* ... kód ... */ }
    function calculateTotal() { /* ... kód ... */ }
    function getMonthName(month) { /* ... kód ... */ }
    window.exportToPDF = function() { /* ... kód ... */ }
    window.sendPDF = function() { /* ... kód ... */ }
    window.changeDecimalPlaces = function() { /* ... kód ... */ }
    window.updateEmployeeName = function() { /* ... kód ... */ }
    window.updateSettings = function() { /* ... kód ... */ }
    window.changeMonth = function() { /* ... kód ... */ }
    window.changeYear = function() { /* ... kód ... */ }
    function getDaysInMonth(month) { /* ... kód ... */ }
    window.createBackup = function() { /* ... kód ... */ }
    window.restoreBackup = function() { /* ... kód ... */ }
    // --- KONIEC nezmenených funkcií ---

    // OPRAVA 3: Pridaná funkcia na nastavenie SW registrácie z vonkajšieho skriptu
    window.setSwRegistration = (registration) => {
        console.log("Setting global swRegistration variable");
        swRegistration = registration; // Nastaví globálnu premennú v module
        // Po získaní registrácie môžeme skontrolovať, či už máme povolenie a usera na získanie tokenu
        if (currentUser && Notification.permission === 'granted') {
             console.log("SW registration received, attempting to get token now.");
             getAndSaveToken().catch(err => console.error("Token fetch failed after SW registration:", err));
        } else {
            console.log("SW registration received, but conditions not met for immediate token fetch.");
            updateNotificationButtonState(); // Aktualizujeme tlačidlo
        }
    }

    // ==================== SEKCIA: PUSH NOTIFIKÁCIE (s opravami) ====================

    // Funkcia na aktualizáciu stavu tlačidla notifikácií (bez zmien v tejto funkcii)
    function updateNotificationButtonState() {
        if (!enableNotificationsBtn || !messaging || !('Notification' in window) || !('serviceWorker' in navigator)) {
            if(enableNotificationsBtn) {
                enableNotificationsBtn.disabled = true;
                enableNotificationsBtn.textContent = 'Notifikácie nie sú podporované';
                enableNotificationsBtn.style.display = 'none';
            }
            return;
        }
        if (!currentUser) {
             if(enableNotificationsBtn) {
                enableNotificationsBtn.disabled = true;
                enableNotificationsBtn.textContent = 'Prihláste sa pre notifikácie';
                enableNotificationsBtn.style.display = 'block';
            }
            return;
        }

        enableNotificationsBtn.style.display = 'block';
        const currentPermission = Notification.permission;
        console.log("Current Notification permission:", currentPermission);

        if (currentPermission === 'granted') {
             enableNotificationsBtn.disabled = true;
             enableNotificationsBtn.textContent = 'Notifikácie sú povolené';
             if (swRegistration) { // Skontrolujeme, či už máme registráciu
                getAndSaveToken().catch(err => console.error("Background token fetch failed on state update:", err));
             } else {
                 console.log("SW registration not available yet for background token fetch.");
             }
        } else if (currentPermission === 'denied') {
             enableNotificationsBtn.disabled = true;
             enableNotificationsBtn.textContent = 'Notifikácie zamietnuté';
        } else { // default
             enableNotificationsBtn.disabled = false;
             enableNotificationsBtn.textContent = 'Povoliť Notifikácie';
        }
    }


    // Listener pre tlačidlo na povolenie notifikácií (bez zmien v tejto funkcii)
    if (enableNotificationsBtn && messaging) {
        enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
        // updateNotificationButtonState(); // Počiatočná aktualizácia je teraz lepšie riadená cez onAuthStateChanged a setSwRegistration
    }

    // Funkcia na vyžiadanie povolenia pre notifikácie (bez zmien v tejto funkcii)
    async function requestNotificationPermission() {
        if (!messaging || !('Notification' in window) || !('serviceWorker' in navigator)) {
             showErrorNotification('Push notifikácie nie sú podporované v tomto prehliadači alebo kontexte.');
             return;
        }
        if (!currentUser) {
            showErrorNotification('Pre povolenie notifikácií sa musíte najprv prihlásiť.');
            return;
        }

        console.log('Requesting notification permission...');
        try {
            const permission = await Notification.requestPermission();
            console.log('Notification permission result:', permission);
            updateNotificationButtonState();

            if (permission === 'granted') {
                if (swRegistration) { // Ak už máme registráciu, hneď získame token
                   await getAndSaveToken();
                } else {
                   console.warn("Permission granted, but SW registration not yet available to get token.");
                   // Token sa získa neskôr cez setSwRegistration
                }
            } else if (permission === 'denied') {
                showErrorNotification('Povolenie pre notifikácie bolo zamietnuté.');
            } else {
                 console.log('Notification permission request dismissed.');
            }
        } catch (error) {
            console.error('Error requesting notification permission:', error);
            showErrorNotification('Chyba pri žiadaní o povolenie notifikácií.');
        }
    }

    // OPRAVA 2: Funkcia na získanie a uloženie FCM tokenu (UPRAVENÁ)
    async function getAndSaveToken() {
        // Pridaná kontrola swRegistration
        if (!messaging || !('Notification' in window) || !('serviceWorker' in navigator) || Notification.permission !== 'granted' || !currentUser || !swRegistration) {
            console.log("Cannot get token: Conditions not met (messaging, Notification, SW, permission, user, swRegistration).");
            updateNotificationButtonState();
            return;
        }

        try {
            const vapidKey = "BFgn_i2DvvOzjah-tx4ikCjKL3073NS8IWxVHubgOyMUeG39dSXlRPb9vTFn7_4KkvlfS4mjGH-1irqcoR8zQx8";
            console.log('Attempting to get FCM token using registration:', swRegistration);

            // Poskytnutie serviceWorkerRegistration
            const currentToken = await getToken(messaging, {
                 vapidKey: vapidKey,
                 serviceWorkerRegistration: swRegistration // Toto je kľúčová úprava
            });

            if (currentToken) {
                console.log('FCM Token:', currentToken);
                await saveTokenToFirestore(currentToken);
                console.log("Token retrieved and saved successfully.");
                // Voliteľné: showSaveNotification('Zariadenie zaregistrované pre notifikácie.');
            } else {
                console.log('No registration token available despite granted permission and SW registration.');
                showErrorNotification('Nepodarilo sa získať registračný token. Skúste obnoviť stránku.');
                if(enableNotificationsBtn) {
                    enableNotificationsBtn.disabled = false;
                    enableNotificationsBtn.textContent = 'Povoliť Notifikácie';
                }
            }
        } catch (err) {
            console.error('An error occurred while retrieving token. ', err);
             if (err.code === 'messaging/notifications-blocked' || err.code === 'messaging/permission-blocked') {
                showErrorNotification('Notifikácie sú blokované v nastaveniach prehliadača.');
             } else if (err.code === 'messaging/failed-service-worker-registration' || err.code === 'messaging/sw-registration-expected') {
                // Táto chyba by už nemala nastať s explicitným serviceWorkerRegistration
                showErrorNotification('Chyba registrácie service workera. Skúste tvrdý refresh (Ctrl+Shift+R).');
             } else {
                showErrorNotification('Chyba pri získavaní tokenu pre notifikácie: ' + err.message);
             }
             updateNotificationButtonState();
        }
    }

    // Funkcia na uloženie tokenu do Firestore (bez zmien v tejto funkcii)
    async function saveTokenToFirestore(token) {
        if (!currentUser) {
            console.warn("User not logged in, cannot save FCM token.");
            return;
        }
        const userRef = doc(db, 'users', currentUser.uid);
        try {
            await updateDoc(userRef, {
                fcmTokens: arrayUnion(token)
            });
            console.log('FCM token updated/added for user:', currentUser.uid);
        } catch (error) {
            if (error.code === 'not-found' || error.message.includes("No document to update")) {
                 console.log('User document or fcmTokens field not found, creating/setting field...');
                 try {
                      await setDoc(userRef, { fcmTokens: [token] }, { merge: true });
                      console.log('User document/field created/updated with FCM token.');
                 } catch (setError) {
                      console.error('Error setting FCM token in Firestore after update failed:', setError);
                      showErrorNotification('Nepodarilo sa uložiť token do databázy.');
                 }
            } else {
                 console.error('Error saving FCM token to Firestore:', error);
                 showErrorNotification('Nepodarilo sa uložiť token do databázy.');
            }
        }
    }

    // Listener pre správy prijaté, keď je aplikácia otvorená (bez zmien v tejto funkcii)
    if (messaging) {
        onMessage(messaging, (payload) => {
            console.log('Message received while app is in foreground: ', payload);
            const notificationTitle = payload.notification?.title || 'Nová správa';
            const notificationBody = payload.notification?.body || '';
            showSaveNotification(`${notificationTitle}: ${notificationBody}`);
        });
    }

    // ==================== KONIEC SEKCIE: PUSH NOTIFIKÁCIE ====================

    // -------------------- INIT --------------------
    // Listener na zmeny stavu prihlásenia (bez zmien)
    onAuthStateChanged(auth, (user) => {
      console.log('Auth state changed. User:', user ? user.email : 'None');
      currentUser = user;
      updateUI(); // Zavolá sa updateUI, ktoré zariadi všetko ostatné vrátane updateNotificationButtonState
    });

    // Priradenie funkcií na window pre volania z HTML (nezmenené)
    window.login = login;
    window.register = register;
    window.logout = logout;
    window.resetPassword = resetPassword;
    window.updateEmployeeName = updateEmployeeName;
    window.updateSettings = updateSettings;
    window.changeMonth = changeMonth;
    window.changeYear = changeYear;
    window.changeDecimalPlaces = changeDecimalPlaces;
    window.toggleDarkMode = toggleDarkMode;
    // window.enableNotifications = enableNotifications; // Toto je teraz requestNotificationPermission
    window.exportToPDF = exportToPDF;
    window.sendPDF = sendPDF;
    window.restoreBackup = restoreBackup;
    window.createBackup = createBackup;
    window.loadFromFirestore = loadFromFirestore;
    window.handleInput = handleInput;
    window.handleBreakInput = handleBreakInput;
    window.resetRow = resetRow;

  </script>

  <!-- OPRAVA 4: Registrácia Service Workera (UPRAVENÁ) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Cesta musí byť správna
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne s rozsahom:', registration.scope);
            // Volanie funkcie na nastavenie globálnej premennej v module
            if (typeof window.setSwRegistration === 'function') {
                 window.setSwRegistration(registration);
            } else {
                 console.error("Funkcia window.setSwRegistration nebola nájdená! Skontrolujte poradie načítania skriptov.");
                 // Môžete sem pridať záložnú logiku alebo zobraziť chybu
            }
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
            const btn = document.getElementById('enableNotificationsBtn');
            if(btn) {
                 btn.disabled = true;
                 btn.textContent = 'Chyba Service Workera';
                 // Použitie existujúcej funkcie showErrorNotification (s kontrolou)
                 if (typeof showErrorNotification === 'function') {
                    showErrorNotification('Nepodarilo sa registrovať Service Worker, notifikácie nebudú fungovať.');
                 } else {
                     alert('Nepodarilo sa registrovať Service Worker, notifikácie nebudú fungovať.');
                 }
            }
          });
      });
    } else {
       const btn = document.getElementById('enableNotificationsBtn');
       if(btn) {
           btn.disabled = true;
           btn.textContent = 'Service Worker nepodporovaný';
           btn.style.display = 'none';
       }
    }
  </script>
</body>
</html>
