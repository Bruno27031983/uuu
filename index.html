<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator Pro</title> <!-- Zmenený titulok -->

  <!-- Meta tagy pre PWA -->
  <meta name="theme-color" content="#8a2be2"/>
  <meta name="description" content="Pokročilá kalkulačka mzdy s offline podporou a synchronizáciou."/>
  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />
  <!-- Ikona pre lepší vzhľad -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="images/icon-192x192.png"> <!-- Ikona pre Apple -->


  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script> <!-- Defer pre rýchlejšie načítanie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script> <!-- Aktualizovaná verzia -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script> <!-- Aktualizovaná verzia -->
  <!-- Knižnica pre notifikácie -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js" defer></script>
  <!-- Font Roboto pre PDF -->
  <!-- addFont vo funkciách PDF sa postará o načítanie, ale pre istotu môžeme linkovať -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">


  <style>
    /* --- Vylepšené štýly --- */
    :root {
      --primary-color: #8a2be2; /* Fialová */
      --primary-dark: #6a1bb2;
      --secondary-color: #4CAF50; /* Zelená */
      --secondary-dark: #388e3c;
      --danger-color: #f44336; /* Červená */
      --danger-dark: #d32f2f;
      --warning-color: #ff9800; /* Oranžová */
      --warning-dark: #e68a00;
      --info-color: #2196F3; /* Modrá */
      --info-dark: #1976d2;
      --light-bg: #f4f7f6; /* Svetlejšia sivá */
      --light-card-bg: white;
      --light-text: #333;
      --dark-bg: #2c3e50; /* Tmavšia modrá */
      --dark-card-bg: #34495e; /* Ešte tmavšia modrá */
      --dark-text: #ecf0f1; /* Svetlejšia sivá */
      --border-color: #ddd;
      --dark-border-color: #555;
      --input-bg: #ffffff; /* Biele pozadie inputov */
      --input-border: #ccc;
      --dark-input-bg: #555;
      --dark-input-text: white;
      --dark-input-border: #777;
      --current-day-bg: #e6e6fa; /* Svetlá fialová */
      --dark-current-day-bg: #5a4a8c; /* Tmavšia fialová */
      --readonly-bg: #eee;
      --dark-readonly-bg: #444;
      --readonly-text: #777;
      --dark-readonly-text: #aaa;
      --weekend-bg: rgba(0, 0, 0, 0.03);
      --dark-weekend-bg: rgba(255, 255, 255, 0.05);
      --invalid-border: var(--danger-color);
      --invalid-bg: #ffebee;
      --dark-invalid-bg: #5a2d33;
      --focus-shadow: rgba(138, 43, 226, 0.2);
      --dark-focus-shadow: rgba(138, 43, 226, 0.3);
      --toastify-color-success: linear-gradient(to right, #00b09b, #96c93d);
      --toastify-color-error: linear-gradient(to right, #ff5f6d, #ffc371);
      --toastify-color-warning: linear-gradient(to right, #f7b733, #fc4a1a);
      --toastify-color-info: linear-gradient(to right, #00d2ff, #3a7bd5);
    }

    *, *::before, *::after {
        box-sizing: border-box; /* Lepší box model */
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modernejší font */
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--light-bg);
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease; /* Plynulý prechod */
    }
    .container {
      max-width: 1300px; /* Trochu širší kontajner */
      margin: 15px auto; /* Väčší margin */
      background: var(--light-card-bg);
      padding: 20px; /* Viac paddingu */
      border-radius: 8px; /* Zaoblenejšie rohy */
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }
    h1 {
      text-align: center;
      font-size: 2.8em; /* Trochu väčšie */
      font-weight: 700; /* Tučnejšie */
      background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #00ff00, #0000ff, var(--primary-color));
      background-size: 200% 200%; /* Pre plynulejšiu animáciu */
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 6s ease-in-out infinite, textShadowPulse 2.5s ease-in-out infinite;
      margin-bottom: 5px; /* Menší margin */
      line-height: 1.2;
    }
    h2 {
      text-align: center;
      color: #777; /* Svetlejšia sivá */
      margin-top: 0;
      margin-bottom: 25px; /* Väčší odstup */
      font-size: 1.3em;
      font-weight: 400; /* Normálna hrúbka */
    }
    .settings {
      margin-bottom: 25px;
      display: grid; /* Použitie Gridu pre lepšie zarovnanie */
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responzívny grid */
      gap: 15px; /* Medzery medzi prvkami */
      align-items: end; /* Zarovnanie na spodok (pre tlačidlo tm. režimu) */
    }
    .settings > div { margin: 0; }
    .settings label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600; /* Trochu tučnejšie labely */
      font-size: 0.95em;
      color: var(--light-text);
    }
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color); /* Orámovanie tabuľky */
      border-radius: 5px;
      margin-bottom: 25px;
      transition: border-color 0.3s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px; /* Trochu širšia minimálna šírka */
    }
    th, td {
      padding: 10px 12px; /* Viac paddingu */
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle; /* Zarovnanie na stred */
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    th {
      background-color: #e9ecef; /* Svetlejšia hlavička */
      font-weight: 600;
      position: sticky; /* Prilepená hlavička pri skrolovaní */
      top: 0;
      z-index: 10;
      color: var(--light-text);
    }
     td:last-child, th:last-child {
       text-align: center; /* Centrovanie tlačidiel */
       width: 110px; /* Fixná šírka pre akcie */
     }
     td:nth-child(1) { width: 80px; } /* Šírka pre deň */
     td:nth-child(5) { width: 130px; } /* Šírka pre odpracované */

    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 8px 10px; /* Väčší padding */
      box-sizing: border-box;
      background-color: var(--input-bg);
      color: var(--light-text);
      font-size: 14px;
      border: 1px solid var(--input-border);
      border-radius: 4px; /* Jemne zaoblené */
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--focus-shadow); /* Jemný focus glow */
    }
    input[readonly] {
      background-color: var(--readonly-bg);
      color: var(--readonly-text);
      cursor: default;
      border-color: #ddd;
    }
    input.invalid { /* Štýl pre neplatný vstup */
        border-color: var(--invalid-border) !important; /* Zvýraznenie */
        background-color: var(--invalid-bg);
    }

    #totalSalary {
      font-size: 1.1em; /* Trochu väčšie */
      font-weight: 500; /* Normálna hrúbka pre text */
      text-align: left; /* Zarovnanie doľava pre lepší prehľad */
      margin-top: 25px;
      padding: 15px 20px;
      background-color: #e9ecef; /* Podobné ako hlavička tabuľky */
      border-radius: 5px;
      line-height: 1.8; /* Väčšie riadkovanie */
      color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #totalSalary strong {
      color: var(--primary-dark); /* Tmavo fialová pre zvýraznenie */
      font-weight: 700;
    }
    #totalSalary br {
        margin-bottom: 4px; /* Malý odstup medzi riadkami */
    }

    /* Štýly pre aktuálny deň a víkendy */
    tr.weekend td {
        background-color: var(--weekend-bg);
    }
    tr.current-day td {
      background-color: var(--current-day-bg) !important; /* !important aby prebilo weekend */
      font-weight: bold;
      color: #333; /* Text zostane tmavý */
    }
    tr.current-day input:not([readonly]) {
      background-color: #fffacd; /* Žltšie pozadie pre inputy */
      font-weight: bold;
    }

    /* --- Tlačidlá --- */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Centrovanie tlačidiel */
      gap: 10px; /* Medzery */
      margin-top: 25px;
    }
    .btn {
      padding: 10px 18px; /* Upravený padding */
      color: white;
      background-color: var(--primary-color); /* Default farba */
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      text-decoration: none; /* Pre prípad použitia ako <a> */
      display: inline-flex; /* Pre ikony */
      align-items: center;
      justify-content: center;
      gap: 8px; /* Medzera medzi ikonou a textom */
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover {
      opacity: 0.9; /* Jemné zosvetlenie */
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn:active {
        transform: translateY(1px); /* Efekt stlačenia */
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .btn:disabled, .btn.disabled { /* Pre deaktivované tlačidlá */
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
    }

    /* Vlastné farby tlačidiel */
    .btn-primary { background-color: var(--primary-color); }
    .btn-primary:hover { background-color: var(--primary-dark); }
    .btn-secondary { background-color: var(--secondary-color); }
    .btn-secondary:hover { background-color: var(--secondary-dark); }
    .btn-danger { background-color: var(--danger-color); }
    .btn-danger:hover { background-color: var(--danger-dark); }
    .btn-warning { background-color: var(--warning-color); color: #333; }
    .btn-warning:hover { background-color: var(--warning-dark); }
    .btn-info { background-color: var(--info-color); }
    .btn-info:hover { background-color: var(--info-dark); }

    /* Tlačidlá v riadku tabuľky */
    .btn-sm {
      padding: 4px 8px;
      font-size: 14px;
      margin: 0 2px; /* Malý odstup */
       box-shadow: none; /* Menší tieň */
    }
    .btn-sm:hover { box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-sm:active { transform: translateY(0.5px); }

    /* --- Tmavý režim --- */
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    body.dark-mode .container {
      background-color: var(--dark-card-bg);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    body.dark-mode h2 { color: #bdc3c7; } /* Svetlejšia sivá pre podnadpis */
    body.dark-mode label { color: var(--dark-text); }
    body.dark-mode .table-container { border-color: var(--dark-border-color); }
    body.dark-mode th { background-color: #4a627a; border-color: var(--dark-border-color); color: var(--dark-text); }
    body.dark-mode td { border-color: var(--dark-border-color); }
    body.dark-mode tr.weekend td { background-color: var(--dark-weekend-bg); }
    body.dark-mode tr.current-day td { background-color: var(--dark-current-day-bg) !important; color: var(--dark-text); }
    body.dark-mode tr.current-day input:not([readonly]) { background-color: #7061a0; }

    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select {
      background-color: var(--dark-input-bg);
      color: var(--dark-input-text);
      border-color: var(--dark-input-border);
    }
    body.dark-mode input[readonly] {
        background-color: var(--dark-readonly-bg);
        color: var(--dark-readonly-text);
        border-color: #555;
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--dark-focus-shadow);
    }
    body.dark-mode input.invalid { background-color: var(--dark-invalid-bg); border-color: var(--danger-dark) !important; }
    body.dark-mode #totalSalary {
      background-color: #2c3e50; /* Tmavšie pozadie pre súčty */
      color: var(--dark-text);
    }
    body.dark-mode #totalSalary strong { color: #a569bd; } /* Svetlejšia fialová pre zvýraznenie */
    body.dark-mode .btn-warning { color: white; background-color: var(--warning-dark); } /* Úprava warning tlačidla v tmavom režime */
    body.dark-mode .btn-warning:hover { background-color: #b36b00; }
     body.dark-mode .nav-arrow { color: var(--dark-text); }
     body.dark-mode .nav-arrow:hover { color: var(--primary-color); }

    /* Animácie nadpisu */
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4); }
      50% { text-shadow: 0 0 16px rgba(255, 255, 255, 0.8); }
    }

    /* Media Queries - menšie úpravy */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 15px; margin: 10px auto; }
      h1 { font-size: 2.2em; }
      h2 { font-size: 1.1em; }
      .settings { grid-template-columns: 1fr; gap: 10px; } /* Jeden stĺpec na mobiloch */
      th, td { padding: 8px; font-size: 0.85em; }
      .btn-container { justify-content: stretch; } /* Roztiahnuť tlačidlá */
      .btn { font-size: 14px; flex-grow: 1; } /* Tlačidlá zaberú celú šírku */
      #totalSalary { font-size: 1em; padding: 12px 15px; }
      table { min-width: 800px; } /* Stále potrebný skrolovač */
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.8em; }
      th, td { padding: 6px; font-size: 0.8em; }
      .btn { font-size: 13px; padding: 8px 12px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 13px; padding: 6px 8px; }
       table { min-width: 700px; } /* Ešte menšia min. šírka */
       td:last-child, th:last-child { width: 90px; } /* Užší stĺpec akcií */
       .btn-sm { padding: 3px 6px; font-size: 12px; }
    }

    /* Indikátor aktivity */
    #activityIndicator {
      display: none; /* Skryté defaultne */
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    #activityIndicator.show {
        display: block;
        opacity: 1;
    }

    /* Šípky pre mesiac/rok */
    .month-year-nav {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .nav-arrow {
        background: none;
        border: none;
        font-size: 1.5em;
        line-height: 1;
        cursor: pointer;
        color: var(--primary-color);
        padding: 0 5px;
        transition: color 0.2s ease;
    }
    .nav-arrow:hover { color: var(--primary-dark); }
    .nav-arrow:disabled { color: #ccc; cursor: not-allowed; }
    body.dark-mode .nav-arrow:disabled { color: #555; }

    /* Vylepšenie prihlasovacieho formulára */
    #auth-container {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 25px;
        transition: border-color 0.3s ease;
    }
    #login-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px; /* Medzery medzi prvkami */
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 250px; /* Trochu širšie */
      max-width: 90%;
      margin: 0; /* Reset marginu */
      text-align: center;
    }
    #login-form .btn-group { /* Zoskupenie tlačidiel prihlásenia/registrácie */
        display: flex;
        gap: 10px;
    }
    #login-form .btn {
      width: auto; /* Automatická šírka */
      padding: 8px 15px; /* Menší padding pre tieto tlačidlá */
    }
    #user-info {
        font-size: 0.95em;
        display: flex; /* Lepšie zarovnanie */
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    #user-info span {
        font-weight: 500;
        word-break: break-all; /* Zalomenie dlhého emailu */
    }

    /* Štýly pre Toastify notifikácie (základné nastavenie) */
    .toastify {
        padding: 12px 20px;
        color: #fff;
        display: inline-block;
        box-shadow: 0 3px 6px -1px rgba(0, 0, 0, 0.12), 0 10px 36px -4px rgba(77, 96, 232, 0.3);
        background: -webkit-linear-gradient(315deg, #73a5ff, #5477f5);
        background: linear-gradient(135deg, #73a5ff, #5477f5);
        position: fixed;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        max-width: calc(50% - 20px);
        z-index: 2147483647;
    }
    .toastify.on { opacity: 1; }
    /* Farby sú definované v :root a aplikované v JS */

  </style>
</head>
<body>
  <!-- Indikátor aktivity -->
  <div id="activityIndicator">Spracovávam...</div>

  <div class="container">
    <!-- Autentifikačné UI -->
    <div id="auth-container">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" autocomplete="email">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div class="btn-group">
            <button class="btn btn-secondary" id="loginBtn">Prihlásiť sa</button> <!-- Použitie ID pre listener -->
            <button class="btn btn-info" id="registerBtn">Registrovať</button> <!-- Použitie ID pre listener -->
        </div>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn btn-danger" id="logoutBtn">Odhlásiť sa</button> <!-- Použitie ID pre listener -->
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator Pro</h1>
    <h2 id="subTitle">Výkaz práce a výpočet mzdy</h2>

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.01">
      </div>
      <div>
        <label for="taxRateInput">Daň (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <div class="month-year-nav">
            <button class="nav-arrow" id="prevMonthBtn" aria-label="Predchádzajúci mesiac"><</button>
            <select id="monthSelect">
              <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
              <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
              <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
              <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
            </select>
            <button class="nav-arrow" id="nextMonthBtn" aria-label="Nasledujúci mesiac">></button>
        </div>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
         <div class="month-year-nav">
            <button class="nav-arrow" id="prevYearBtn" aria-label="Predchádzajúci rok"><</button>
            <select id="yearSelect">
              <!-- Dynamicky generované roky -->
            </select>
            <button class="nav-arrow" id="nextYearBtn" aria-label="Nasledujúci rok">></button>
        </div>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinné miesta:</label>
        <select id="decimalPlacesSelect">
          <option value="1">1</option>
          <option value="2" selected>2</option>
          <option value="3">3</option>
        </select>
      </div>
      <!-- Tlačidlo tmavého režimu je na konci gridu -->
      <button id="darkModeToggleBtn" class="btn btn-warning">Tmavý/Svetlý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary">Celkové súčty budú vypočítané tu...</div>

    <div class="btn-container">
      <button id="exportPdfBtn" class="btn btn-secondary">Export PDF</button>
      <button id="sharePdfBtn" class="btn btn-secondary">Zdieľať PDF</button>
      <button id="backupBtn" class="btn btn-info">Zálohovať (.xlsx)</button>
      <button id="restoreBtn" class="btn btn-warning">Obnoviť zo zálohy</button>
      <button id="loadCloudBtn" class="btn btn-primary">Načítať z Cloudu</button>
      <button id="resetMonthBtn" class="btn btn-danger">Resetovať Mesiac</button>
    </div>
  </div>

  <!-- Firebase & App Logic -->
  <script type="module">
    // Prísny režim pre lepšiu kvalitu kódu
    "use strict";

    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, enableIndexedDbPersistence, clearIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    const app = initializeApp(firebaseConfig);
    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
      isTokenAutoRefreshEnabled: true
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Povolenie Offline Perzistencie Firestore
    (async () => {
        try {
            await enableIndexedDbPersistence(db);
            console.log("Firestore offline perzistencia povolená.");
        } catch (err) {
            if (err.code == 'failed-precondition') {
                console.warn("Firestore offline perzistencia: Viac otvorených tabov, perzistencia povolená len v prvom.");
            } else if (err.code == 'unimplemented') {
                console.warn("Firestore offline perzistencia: Prehliadač nepodporuje túto funkciu.");
            } else {
                console.error("Chyba pri povoľovaní Firestore offline perzistencie:", err);
            }
        }
    })();


    // -------------------- DOM Elementy (Konštanty) --------------------
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const subTitle = document.getElementById('subTitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const activityIndicator = document.getElementById('activityIndicator');
    const loginForm = document.getElementById('login-form');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    // Tlačidlá
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    const darkModeToggleBtn = document.getElementById('darkModeToggleBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const sharePdfBtn = document.getElementById('sharePdfBtn');
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const loadCloudBtn = document.getElementById('loadCloudBtn');
    const resetMonthBtn = document.getElementById('resetMonthBtn');


    // -------------------- Globálny Stav Aplikácie --------------------
    let currentUser = null;
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let minYear = 2020; // Minimálny rok v selecte
    let maxYear = currentDate.getFullYear() + 2; // Maximálny rok v selecte
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
    let monthDataCache = {}; // Jednoduchá cache pre dáta mesiacov v pamäti
    let dataChangedSinceLoad = false; // Flag na sledovanie zmien pre ukladanie
    let copiedRowData = null; // Pre kopírovanie riadkov


    // -------------------- Pomocné Funkcie (Debounce, Formátovanie, Notifikácie) --------------------

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const context = this;
        const later = () => {
          timeout = null;
          func.apply(context, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showToast(message, type = 'info', duration = 3000) {
        if (typeof Toastify !== 'function') {
            console.log(`Toastify fallback: [${type}] ${message}`);
            return;
        }
        let backgroundColor;
        switch (type) {
            case 'success': backgroundColor = "var(--toastify-color-success)"; break;
            case 'error': backgroundColor = "var(--toastify-color-error)"; break;
            case 'warning': backgroundColor = "var(--toastify-color-warning)"; break;
            default: backgroundColor = "var(--toastify-color-info)";
        }
        Toastify({ text: message, duration: duration, gravity: "bottom", position: "right", stopOnFocus: true, style: { background: backgroundColor } }).showToast();
    }

    function showActivity(message = "Spracovávam...") {
        activityIndicator.textContent = message;
        activityIndicator.classList.add('show');
    }

    function hideActivity() {
        activityIndicator.classList.remove('show');
    }

    function getMonthName(monthIndex) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[monthIndex] || '';
    }

    function getDayName(year, month, day) {
      const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"];
      const date = new Date(year, month, day);
      return daysOfWeek[date.getDay()];
    }

    function getDaysInMonth(year, month) {
      return new Date(year, month + 1, 0).getDate();
    }

    function formatCurrency(value) {
        return (Math.max(0, parseFloat(value) || 0)).toFixed(decimalPlaces);
    }

    function mapFirebaseAuthError(errorCode) {
         switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatný formát emailu.';
            case 'auth/user-not-found': return 'Používateľ s týmto emailom neexistuje.';
            case 'auth/wrong-password': return 'Nesprávne heslo.';
            case 'auth/email-already-in-use': return 'Tento email je už zaregistrovaný.';
            case 'auth/weak-password': return 'Heslo musí mať aspoň 6 znakov.';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            case 'auth/too-many-requests': return 'Príliš veľa neúspešných pokusov. Skúste neskôr.';
            case 'auth/operation-not-allowed': return 'Prihlásenie emailom/heslom nie je povolené.';
            default:
                console.error("Neznáma chyba Firebase Auth:", errorCode);
                return `Neznáma chyba (${errorCode})`;
        }
    }

    // -------------------- Tmavý Režim --------------------
    function applyDarkModePreference() {
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        } else {
             document.body.classList.remove('dark-mode');
        }
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      showToast(`Režim zobrazenia: ${isDarkMode ? 'Tmavý' : 'Svetlý'}`, 'info', 1500);
      updateWeekendStyles();
    }

    function updateWeekendStyles() {
        const weekendColor = document.body.classList.contains('dark-mode') ? 'var(--dark-weekend-bg)' : 'var(--weekend-bg)';
        workDaysTbody.querySelectorAll('.weekend').forEach(row => {
             row.style.backgroundColor = weekendColor;
        });
    }


    // -------------------- Navigácia Mesiac/Rok --------------------
    function populateYearSelect() {
      yearSelect.innerHTML = '';
      for (let year = minYear; year <= maxYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      updateNavigationButtons();
    }

    function updateNavigationButtons() {
        prevMonthBtn.disabled = (currentYear === minYear && currentMonth === 0);
        nextMonthBtn.disabled = (currentYear === maxYear && currentMonth === 11);
        prevYearBtn.disabled = (currentYear <= minYear);
        nextYearBtn.disabled = (currentYear >= maxYear);
    }

    function navigateMonth(direction) {
        let newMonth = currentMonth + direction;
        let newYear = currentYear;
        if (newMonth > 11) { newMonth = 0; newYear++; }
        else if (newMonth < 0) { newMonth = 11; newYear--; }

        if (newYear >= minYear && newYear <= maxYear) {
           yearSelect.value = newYear;
           currentYear = newYear;
           monthSelect.value = newMonth;
           currentMonth = newMonth;
           updateNavigationButtons();
           initializeAppSettings();
           loadAndDisplayData();
        } else { showToast("Rok mimo povoleného rozsahu.", "warning"); }
    }

     function navigateYear(direction) {
        let newYear = currentYear + direction;
        if (newYear >= minYear && newYear <= maxYear) {
           yearSelect.value = newYear;
           currentYear = newYear;
           updateNavigationButtons();
           initializeAppSettings();
           loadAndDisplayData();
        } else { showToast("Rok mimo povoleného rozsahu.", "warning"); }
    }

    // -------------------- AUTENTIFIKÁCIA (Event Listenery) --------------------
    loginBtn.addEventListener('click', async () => {
        if (!navigator.onLine) return showToast('Ste offline. Prihlásenie je možné iba online.', 'error');
        const emailVal = emailInput.value;
        const passwordVal = passwordInput.value;
        if (!emailVal || !passwordVal) return showToast('Prosím, zadajte email aj heslo.', 'warning');
        showActivity('Prihlasujem...');
        try {
            const userCredential = await signInWithEmailAndPassword(auth, emailVal, passwordVal);
            showToast(`Vitajte späť, ${userCredential.user.email}!`, 'success');
        } catch (error) {
            console.error('Chyba pri prihlásení:', error);
            showToast(`Chyba pri prihlásení: ${mapFirebaseAuthError(error.code)}`, 'error', 4000);
        } finally { hideActivity(); }
    });

    registerBtn.addEventListener('click', async () => {
        if (!navigator.onLine) return showToast('Ste offline. Registrácia je možná iba online.', 'error');
        const emailVal = emailInput.value;
        const passwordVal = passwordInput.value;
        if (!emailVal || !passwordVal) return showToast('Prosím, zadajte email aj heslo.', 'warning');
        if (passwordVal.length < 6) return showToast('Heslo musí mať aspoň 6 znakov.', 'warning');
        showActivity('Registrujem...');
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, emailVal, passwordVal);
            await createUserDocument(userCredential.user);
            showToast(`Registrácia úspešná! Vitajte, ${userCredential.user.email}!`, 'success');
        } catch (error) {
            console.error('Chyba pri registrácii:', error);
            showToast(`Chyba pri registrácii: ${mapFirebaseAuthError(error.code)}`, 'error', 4000);
        } finally { hideActivity(); }
    });

    logoutBtn.addEventListener('click', async () => {
        showActivity('Odhlasujem...');
        try {
            await signOut(auth);
            monthDataCache = {};
            showToast('Boli ste úspešne odhlásený.', 'info');
        } catch (error) {
            console.error('Chyba pri odhlásení:', error);
            showToast('Chyba pri odhlásení.', 'error');
        } finally { hideActivity(); }
    });

    async function createUserDocument(user) {
        if (!user) return;
        const userRef = doc(db, 'users', user.uid);
        try {
            await setDoc(userRef, { email: user.email, createdAt: new Date() }, { merge: true });
            console.log('User dokument vytvorený/aktualizovaný pre:', user.uid);
        } catch (error) { console.error('Chyba pri vytváraní user dokumentu:', error); }
    }

    // -------------------- Riadenie Stavu Aplikácie (UI, Načítanie Dát) --------------------

    function updateAuthUI() {
        if (currentUser) {
            loginForm.style.display = 'none';
            userInfo.style.display = 'flex';
            userEmail.textContent = currentUser.email;
            loadCloudBtn.disabled = false;
            resetMonthBtn.title = "Resetovať mesiac (aj v cloude)";
        } else {
            loginForm.style.display = 'flex';
            userInfo.style.display = 'none';
            userEmail.textContent = '';
            emailInput.value = '';
            passwordInput.value = '';
            loadCloudBtn.disabled = true;
             resetMonthBtn.title = "Resetovať mesiac (lokálne)";
        }
    }

    function initializeAppSettings() {
        hourlyWageInput.value = hourlyWage.toFixed(2);
        taxRateInput.value = (taxRate * 100).toFixed(1);
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        const monthName = getMonthName(currentMonth);
        subTitle.textContent = `Výkaz práce za ${monthName} ${currentYear}`;
        mainTitle.textContent = employeeName ? `${employeeName} - Kalkulačka` : "Bruno's Calculator Pro";
        updateNavigationButtons();
    }

    async function loadAndDisplayData() {
        showActivity('Načítavam dáta...');
        const dataKey = `${currentYear}-${currentMonth}`;
        let dataToApply = null;
        let loadedFrom = "žiadny zdroj";

        if (monthDataCache[dataKey]) {
            console.log('Načítavam dáta z pamäťovej cache.');
            dataToApply = monthDataCache[dataKey];
            loadedFrom = "Cache";
        } else {
            if (currentUser) {
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const docRef = doc(userRef, 'workDays', dataKey);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        dataToApply = docSnap.data();
                        loadedFrom = "Firestore";
                        localStorage.setItem(`workData-${dataKey}`, JSON.stringify(dataToApply));
                    } else {
                        const localData = localStorage.getItem(`workData-${dataKey}`);
                        if (localData) { try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (po FS)"; } catch (e) { console.error("Chyba parsovania LS:", e); } }
                    }
                } catch (error) {
                    console.error('Chyba pri načítavaní z Firestore:', error);
                    showToast('Chyba pri načítavaní dát z cloudu.', 'error');
                    const localData = localStorage.getItem(`workData-${dataKey}`);
                    if (localData) { try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (po chybe FS)"; } catch (e) { console.error("Chyba parsovania LS:", e); } }
                }
            } else {
                const localData = localStorage.getItem(`workData-${dataKey}`);
                if (localData) { try { dataToApply = JSON.parse(localData); loadedFrom = "localStorage (neprihlásený)"; } catch (e) { console.error("Chyba parsovania LS:", e); } }
            }
        }

        console.log(`Dáta načítané z: ${loadedFrom}`);
        applyDataToUI(dataToApply);
        if (dataToApply && loadedFrom !== "Cache") { monthDataCache[dataKey] = dataToApply; }
        hideActivity();
    }

    function applyDataToUI(storedData) {
        console.log('Aplikujem dáta do UI:', storedData);
        if (storedData) {
            hourlyWage = storedData.hourlyWage !== undefined ? parseFloat(storedData.hourlyWage) : hourlyWage;
            taxRate = storedData.taxRate !== undefined ? parseFloat(storedData.taxRate) : taxRate;
            employeeName = storedData.employeeName !== undefined ? String(storedData.employeeName) : employeeName;
            decimalPlaces = storedData.decimalPlaces !== undefined ? parseInt(storedData.decimalPlaces) : decimalPlaces;
        }
         initializeAppSettings();
         createTableStructure();

        if (storedData && storedData.data && Array.isArray(storedData.data)) {
            storedData.data.forEach((day, index) => {
                const i = index + 1;
                const startElement = document.getElementById(`start-${i}`);
                const endElement = document.getElementById(`end-${i}`);
                const breakElement = document.getElementById(`break-${i}`);
                if (startElement && endElement && breakElement) {
                    startElement.value = day.start || '';
                    endElement.value = day.end || '';
                    breakElement.value = day.breakTime !== undefined ? String(day.breakTime).replace('.', ',') : '';
                     validateTimeInput(startElement);
                     validateTimeInput(endElement);
                     validateBreakInput(breakElement); // Pridaná validácia prestávky
                }
            });
        } else if (storedData) { console.warn("Pole 'data' chýba alebo nie je pole v uložených dátach."); }

        recalculateAllRowsAndTotal();
        dataChangedSinceLoad = false;
    }

    // -------------------- Ukladanie Dát --------------------

    function collectCurrentData() {
         const daysInMonth = getDaysInMonth(currentYear, currentMonth);
         const dayDataArray = [];
         for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${i}`);
            const endElement = document.getElementById(`end-${i}`);
            const breakElement = document.getElementById(`break-${i}`);
            const grossElement = document.getElementById(`gross-${i}`);
            const netElement = document.getElementById(`net-${i}`);
            dayDataArray.push({
                start: startElement ? startElement.value : '',
                end: endElement ? endElement.value : '',
                breakTime: breakElement ? String(breakElement.value).replace(',', '.') : '0',
                gross: grossElement ? grossElement.value : '0.00',
                net: netElement ? netElement.value : '0.00'
            });
         }
         return { data: dayDataArray, hourlyWage, taxRate, employeeName, decimalPlaces, lastUpdated: new Date().toISOString() };
    }

    function handleDataChange() {
        dataChangedSinceLoad = true;
        saveToLocalStorage();
        scheduleSaveToFirestore();
    }

    const saveToLocalStorage = debounce(() => {
        if (!dataChangedSinceLoad) return;
        const currentData = collectCurrentData();
        const dataKey = `${currentYear}-${currentMonth}`;
        try {
            localStorage.setItem(`workData-${dataKey}`, JSON.stringify(currentData));
            localStorage.setItem('hourlyWage', hourlyWage.toString());
            localStorage.setItem('taxRate', taxRate.toString());
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces.toString());
            console.log('Dáta uložené do localStorage.');
        } catch (e) {
            console.error("Chyba pri ukladaní do localStorage:", e);
            showToast('Chyba pri lokálnom ukladaní dát!', 'error');
             if (e.name === 'QuotaExceededError') { showToast('Lokálne úložisko je plné!', 'error', 5000); }
        }
    }, 500);

    const scheduleSaveToFirestore = debounce(async () => {
        if (!currentUser || !dataChangedSinceLoad) return;
        const currentData = collectCurrentData();
        const dataKey = `${currentYear}-${currentMonth}`;
        console.log("Pokus o uloženie do Firestore...");
        showActivity('Synchronizujem s cloudom...');
        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', dataKey);
            await setDoc(docRef, currentData);
            console.log('Dáta úspešne uložené/synchronizované s Firestore.');
            showToast('Dáta synchronizované s cloudom.', 'success', 1500);
            dataChangedSinceLoad = false;
            monthDataCache[dataKey] = currentData;
        } catch (error) {
            console.error('Chyba pri ukladaní do Firestore:', error);
            showToast('Chyba pri synchronizácii s cloudom.', 'error');
        } finally { setTimeout(hideActivity, 500); }
    }, 2000);

    loadCloudBtn.addEventListener('click', async () => {
        if (!currentUser) return showToast('Pre načítanie z cloudu sa musíte prihlásiť.', 'warning');
        if (!navigator.onLine) { showToast('Ste offline. Načítavajú sa posledné lokálne synchronizované dáta.', 'warning'); }
        if (dataChangedSinceLoad && !confirm('Máte neuložené lokálne zmeny. Naozaj chcete načítať dáta z Cloudu a prepísať ich?')) return;
        showActivity('Načítavam z cloudu...');
        const dataKey = `${currentYear}-${currentMonth}`;
        try {
            const userRef = doc(db, 'users', currentUser.uid);
            const docRef = doc(userRef, 'workDays', dataKey);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const storedData = docSnap.data();
                localStorage.setItem(`workData-${dataKey}`, JSON.stringify(storedData));
                applyDataToUI(storedData);
                monthDataCache[dataKey] = storedData;
                showToast('Dáta boli úspešne načítané z cloudu.', 'success');
            } else {
                showToast('Pre tento mesiac neboli v cloude nájdené žiadne dáta.', 'info');
                // applyDataToUI(null); // Možnosť vyčistiť UI
            }
        } catch (error) {
            console.error('Chyba pri manuálnom načítavaní z Firestore:', error);
            showToast('Chyba pri načítavaní dát z cloudu.', 'error');
        } finally { hideActivity(); }
    });

     resetMonthBtn.addEventListener('click', async () => {
         const monthName = getMonthName(currentMonth);
         const message = currentUser ? `Naozaj chcete vymazať všetky záznamy pre ${monthName} ${currentYear} (lokálne aj v cloude)? Táto akcia je nevratná!` : `Naozaj chcete vymazať všetky lokálne záznamy pre ${monthName} ${currentYear}? Táto akcia je nevratná!`;
         if (!confirm(message)) return;
         showActivity('Resetujem mesiac...');
         const dataKey = `${currentYear}-${currentMonth}`;
         applyDataToUI(null);
         delete monthDataCache[dataKey];
         localStorage.removeItem(`workData-${dataKey}`);
         if (currentUser) {
             try {
                 const userRef = doc(db, 'users', currentUser.uid);
                 const docRef = doc(userRef, 'workDays', dataKey);
                 await deleteDoc(docRef);
                 console.log('Dáta úspešne vymazané z Firestore.');
                 showToast('Dáta pre aktuálny mesiac boli úspešne vymazané.', 'success');
             } catch (error) {
                  console.error('Chyba pri mazaní dát z Firestore:', error);
                  showToast('Chyba pri mazaní dát z cloudu.', 'error');
             }
         } else { showToast('Lokálne dáta pre aktuálny mesiac boli vymazané.', 'success'); }
         dataChangedSinceLoad = false;
         hideActivity();
     });

    // -------------------- Tvorba tabuľky a Event Listeners --------------------

    function createTableStructure() {
        console.log(`Vytváram štruktúru tabuľky pre ${getMonthName(currentMonth)} ${currentYear}`);
        workDaysTbody.innerHTML = '';
        const today = new Date();
        const currentDay = today.getDate();
        const isCurrentMonthAndYear = (today.getMonth() === currentMonth && today.getFullYear() === currentYear);
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        const fragment = document.createDocumentFragment();
        const isDarkMode = document.body.classList.contains('dark-mode');
        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            const dayDate = new Date(currentYear, currentMonth, i);
            const dayOfWeek = dayDate.getDay();
            const dayName = getDayName(currentYear, currentMonth, i);
            row.dataset.day = i;
            if (isCurrentMonthAndYear && i === currentDay) row.classList.add('current-day');
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                 row.classList.add('weekend');
                 row.style.backgroundColor = isDarkMode ? 'var(--dark-weekend-bg)' : 'var(--weekend-bg)';
            }
            row.innerHTML = `
              <td>${i}. (${dayName})</td>
              <td><input type="tel" id="start-${i}" data-day="${i}" class="time-input" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
              <td><input type="tel" id="end-${i}" data-day="${i}" class="time-input" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
              <td><input type="text" id="break-${i}" data-day="${i}" class="break-input" inputmode="decimal" placeholder="hod."></td>
              <td id="total-${i}">0h 0m (0.0 h)</td>
              <td><input type="text" id="gross-${i}" class="salary-output" placeholder="0.00" readonly></td>
              <td><input type="text" id="net-${i}" class="salary-output" placeholder="0.00" readonly></td>
              <td class="action-buttons">
                  <button class="btn btn-danger btn-sm reset-row-btn" data-day="${i}" title="Vynulovať riadok">✖</button>
                  <button class="btn btn-info btn-sm copy-row-btn" data-day="${i}" title="Kopírovať / Vložiť čas">📄</button>
              </td>
            `;
            fragment.appendChild(row);
        }
        workDaysTbody.appendChild(fragment);
        console.log('Štruktúra tabuľky vytvorená.');
    }

    workDaysTbody.addEventListener('input', (event) => {
        const target = event.target;
        if (target.matches('.time-input')) { handleTimeInput(target); }
        else if (target.matches('.break-input')) { handleBreakInput(target); }
    });
     workDaysTbody.addEventListener('focusout', (event) => {
        if (event.target.matches('.time-input')) { validateTimeInput(event.target); }
        else if (event.target.matches('.break-input')) { validateBreakInput(event.target); }
     });
    workDaysTbody.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;
        const day = parseInt(button.dataset.day);
        if (isNaN(day)) return;
        if (button.classList.contains('reset-row-btn')) { resetRow(day); }
        else if (button.classList.contains('copy-row-btn')) { handleCopyPasteClick(day); }
    });

    function handleTimeInput(input) {
        const day = parseInt(input.dataset.day);
        formatTimeInput(input);
        validateTimeInput(input);
        calculateRow(day);
        handleDataChange();
    }
    function handleBreakInput(input) {
        const day = parseInt(input.dataset.day);
        input.value = input.value.replace(/[^0-9.,]/g, '');
        calculateRow(day);
        handleDataChange();
    }
    function formatTimeInput(input) {
        let value = input.value.replace(/[^\d]/g, '');
        if (value.length > 2) value = value.slice(0, 2) + ':' + value.slice(2, 4);
        if (value.length > 5) value = value.slice(0, 5);
        input.value = value;
    }
    function validateTimeInput(input) {
        const value = input.value;
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        if (value && !timeRegex.test(value)) { input.classList.add('invalid'); }
        else { input.classList.remove('invalid'); }
    }
     function validateBreakInput(input) {
        const value = input.value.replace(',', '.').trim();
        if (value && (isNaN(parseFloat(value)) || parseFloat(value) < 0)) {
             input.classList.add('invalid');
             showToast(`Neplatná hodnota prestávky: ${input.value}`, 'warning', 2000);
        } else { input.classList.remove('invalid'); }
    }
    function resetRow(day) {
      ['start', 'end', 'break'].forEach(type => {
          const input = document.getElementById(`${type}-${day}`);
          if (input) { input.value = ''; input.classList.remove('invalid'); }
      });
      calculateRow(day);
      handleDataChange();
      showToast(`Riadok ${day} vynulovaný.`, 'info', 1500);
    }
    function handleCopyPasteClick(day) { if (copiedRowData) { pasteRowData(day); } else { copyRowData(day); } }
    function copyRowData(day) {
        const start = document.getElementById(`start-${day}`)?.value || '';
        const end = document.getElementById(`end-${day}`)?.value || '';
        const breakTime = document.getElementById(`break-${day}`)?.value || '';
        if (start || end || breakTime) {
            copiedRowData = { start, end, breakTime };
            showToast(`Časy z dňa ${day} skopírované. Kliknite na 📄 v inom riadku pre vloženie.`, 'success', 3000);
        } else { showToast(`Niet čo kopírovať z dňa ${day}.`, 'info', 1500); }
    }
    function pasteRowData(day) {
        if (!copiedRowData) return;
        const startInput = document.getElementById(`start-${day}`);
        const endInput = document.getElementById(`end-${day}`);
        const breakInput = document.getElementById(`break-${day}`);
        if (startInput && endInput && breakInput) {
            startInput.value = copiedRowData.start;
            endInput.value = copiedRowData.end;
            breakInput.value = copiedRowData.breakTime;
            validateTimeInput(startInput);
            validateTimeInput(endInput);
            validateBreakInput(breakInput);
            calculateRow(day);
            handleDataChange();
            showToast(`Časy vložené do dňa ${day}.`, 'success', 1500);
        }
    }

    // -------------------- Výpočty --------------------

    function calculateRow(day) {
        const startTimeInput = document.getElementById(`start-${day}`);
        const endTimeInput = document.getElementById(`end-${day}`);
        const breakTimeInput = document.getElementById(`break-${day}`);
        const totalCell = document.getElementById(`total-${day}`);
        const grossInput = document.getElementById(`gross-${day}`);
        const netInput = document.getElementById(`net-${day}`);
        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) return;
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const breakTime = parseFloat(String(breakTimeInput.value).replace(',', '.')) || 0;
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        let decimalHours = 0, hours = 0, minutes = 0;
        if (timeRegex.test(startTime) && timeRegex.test(endTime) && !startTimeInput.classList.contains('invalid') && !endTimeInput.classList.contains('invalid') && !breakTimeInput.classList.contains('invalid')) {
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            let startTotalMinutes = startH * 60 + startM;
            let endTotalMinutes = endH * 60 + endM;
            if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;
            let diffMinutes = endTotalMinutes - startTotalMinutes - (breakTime * 60);
            if (diffMinutes < 0) diffMinutes = 0;
            const totalMinutesRounded = Math.round(diffMinutes);
            hours = Math.floor(totalMinutesRounded / 60);
            minutes = totalMinutesRounded % 60;
            decimalHours = diffMinutes / 60;
        }
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;
        const grossSalary = decimalHours * hourlyWage;
        const netSalary = grossSalary * (1 - taxRate);
        grossInput.value = formatCurrency(grossSalary);
        netInput.value = formatCurrency(netSalary);
    }

    function recalculateAllRowsAndTotal() {
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        for (let i = 1; i <= daysInMonth; i++) calculateRow(i);
        calculateTotal();
    }

    function calculateTotal() {
        let totalMinutesPrecise = 0, totalGrossSalaryPrecise = 0, totalNetSalaryPrecise = 0;
        let daysWithValidEntries = 0, totalBreakMinutes = 0;
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        for (let i = 1; i <= daysInMonth; i++) {
            const startInput = document.getElementById(`start-${i}`);
            const endInput = document.getElementById(`end-${i}`);
            const breakInput = document.getElementById(`break-${i}`);
            if (!startInput || !endInput || !breakInput) continue;
            const startTime = startInput.value;
            const endTime = endInput.value;
            const breakTime = parseFloat(String(breakInput.value).replace(',', '.')) || 0;
            let dayDecimalHours = 0;
            let dayHasValidEntry = false;
             const isValidBreak = !breakInput.classList.contains('invalid');
             const isValidStart = !startInput.classList.contains('invalid');
             const isValidEnd = !endInput.classList.contains('invalid');
            if (timeRegex.test(startTime) && timeRegex.test(endTime) && isValidStart && isValidEnd && isValidBreak) {
                 const [startH, startM] = startTime.split(':').map(Number);
                 const [endH, endM] = endTime.split(':').map(Number);
                 let startTotalMinutes = startH * 60 + startM;
                 let endTotalMinutes = endH * 60 + endM;
                 if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;
                 let diffMinutes = endTotalMinutes - startTotalMinutes - (breakTime * 60);
                 if (diffMinutes < 0) diffMinutes = 0;
                 totalMinutesPrecise += diffMinutes;
                 totalBreakMinutes += breakTime * 60;
                 dayDecimalHours = diffMinutes / 60;
                 dayHasValidEntry = true;
            } else if (breakTime > 0 && isValidBreak) { totalBreakMinutes += breakTime * 60; }
            const dayGrossSalary = dayDecimalHours * hourlyWage;
            const dayNetSalary = dayGrossSalary * (1 - taxRate);
            totalGrossSalaryPrecise += Math.max(0, dayGrossSalary);
            totalNetSalaryPrecise += Math.max(0, dayNetSalary);
            if (dayHasValidEntry) daysWithValidEntries++;
        }
        const totalMinutesRounded = Math.round(totalMinutesPrecise);
        const totalH = Math.floor(totalMinutesRounded / 60);
        const totalM = totalMinutesRounded % 60;
        const totalDecimalH = totalMinutesPrecise / 60;
        const totalBreakH = Math.floor(totalBreakMinutes / 60);
        const totalBreakM = Math.round(totalBreakMinutes % 60);
        const avgNet = daysWithValidEntries > 0 ? totalNetSalaryPrecise / daysWithValidEntries : 0;
        const avgMinutes = daysWithValidEntries > 0 ? totalMinutesPrecise / daysWithValidEntries : 0;
        const avgMinutesRounded = Math.round(avgMinutes);
        const avgH = Math.floor(avgMinutesRounded / 60);
        const avgM = avgMinutesRounded % 60;
        const avgDecimalH = avgMinutes / 60;
        totalSalaryDiv.innerHTML = `
            Započítaných (kompletných) dní: ${daysWithValidEntries}<br>
            Celkový odpracovaný čas: <strong>${totalH}h ${totalM}m</strong> (${totalDecimalH.toFixed(decimalPlaces)} h)<br>
            Celková hrubá mzda: <strong>${formatCurrency(totalGrossSalaryPrecise)} €</strong><br>
            Celková čistá mzda: <strong>${formatCurrency(totalNetSalaryPrecise)} €</strong><br>
            Celkový čas prestávok: ${totalBreakH}h ${totalBreakM}m<br>
            Priemerná čistá mzda / deň: ${formatCurrency(avgNet)} €<br>
            Priemerný odprac. čas / deň: ${avgH}h ${avgM}m (${avgDecimalH.toFixed(decimalPlaces)} h)
        `;
    }

    // -------------------- Export PDF Funkcie --------------------

    // Funkcia na export do PDF
    function exportToPDF() {
      if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.autoTable === 'undefined') {
          return showToast("Knižnica pre PDF sa ešte nenačítala, skúste o chvíľu.", "warning");
      }
      showActivity('Generujem PDF...');
      try {
          const { jsPDF } = window.jspdf; // Získame triedu jsPDF
          const doc = new jsPDF();

          // Pridanie fontu (malo by byť v poriadku, ak je linkovaný alebo cdn funguje)
          // Cesta k fontu musí byť dostupná z CDN
          try {
             // Pre istotu skúsime pridať font, ak by nebol automaticky načítaný
             // Použijeme základný helvetica ak Roboto zlyhá
             if (doc.getFontList && !doc.getFontList().hasOwnProperty('Roboto')) {
                 doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
             }
             doc.setFont('Roboto');
          } catch(fontError) {
              console.warn("Nepodarilo sa načítať/nastaviť font Roboto, použije sa helvetica.", fontError);
              doc.setFont('helvetica', 'normal');
          }

          // Hlavička PDF
          doc.setFontSize(18);
          doc.text(`Bruno's Calculator - Výkaz práce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
          doc.setFontSize(14);
          doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28); // Pridaná kontrola
          doc.setFontSize(12); // Menšie pre ďalšie info
          doc.text(`Hodinová mzda: ${hourlyWage.toFixed(2)} €`, 14, 34);
          doc.text(`Sadzba dane: ${(taxRate * 100).toFixed(1)} %`, 100, 34);

          // Zbieranie dát z tabuľky
          const tableData = [];
          const daysCount = getDaysInMonth(currentYear, currentMonth); // Použitie správnej funkcie
          for (let i = 1; i <= daysCount; i++) {
              // Použitie správnych ID (napr. `start-${i}`)
              const dayName = getDayName(currentYear, currentMonth, i);
              const startTime = document.getElementById(`start-${i}`)?.value || '';
              const endTime = document.getElementById(`end-${i}`)?.value || '';
              const breakTimeValue = document.getElementById(`break-${i}`)?.value || ''; // Môže byť s čiarkou
              const totalTime = document.getElementById(`total-${i}`)?.textContent || '';
              const grossSalary = document.getElementById(`gross-${i}`)?.value || ''; // Už formátované
              const netSalary = document.getElementById(`net-${i}`)?.value || '';   // Už formátované

              // Podmienka na zahrnutie riadku (upravená na kontrolu validity prestávky)
              const breakTimeFloat = parseFloat(String(breakTimeValue).replace(',', '.')) || 0;
              if (startTime || endTime || breakTimeFloat >= 0) { // Zahrnieme aj riadky s 0 prestávkou
                  tableData.push([
                      `Deň ${i} (${dayName})`,
                      startTime,
                      endTime,
                      breakTimeValue || '0', // Zobrazíme ako je v inpute (s čiarkou)
                      totalTime,
                      grossSalary + ' €', // Pridáme menu
                      netSalary + ' €'    // Pridáme menu
                  ]);
              }
          }

          // Generovanie tabuľky
          doc.autoTable({
              head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']],
              body: tableData,
              startY: 40, // Väčší odstup od hlavičky
              theme: 'grid', // Modernejší vzhľad
              styles: {
                  font: doc.getFont().fontName, // Použije nastavený font (Roboto alebo fallback)
                  fontSize: 9,
                  cellPadding: 2,
                  valign: 'middle',
              },
              headStyles: {
                  fillColor: [44, 62, 80], // Tmavšia modro-sivá
                  textColor: 255,
                  fontStyle: 'bold',
                  halign: 'center'
              },
              alternateRowStyles: { fillColor: [245, 245, 245] }, // Svetlosivá pre striedavé riadky
              columnStyles: { // Zarovnanie stĺpcov
                    0: { halign: 'left', cellWidth: 25 }, // Deň
                    1: { halign: 'center' }, // Príchod
                    2: { halign: 'center' }, // Odchod
                    3: { halign: 'center', cellWidth: 20 }, // Prestávka
                    4: { halign: 'left' }, // Odpracované
                    5: { halign: 'right' }, // Hrubá Mzda
                    6: { halign: 'right' } // Čistá Mzda
              },
               didDrawCell: (data) => { // Príklad dodatočného štýlovania, napr. víkendy
                    // const dayText = data.cell.raw; // Text bunky v prvom stĺpci
                    // if (data.column.index === 0 && typeof dayText === 'string' && dayText.includes('(Ne)') || dayText.includes('(So)')) {
                    //      doc.setFillColor(255, 240, 240); // Jemne červená pre víkend
                    // }
                }
          });

          // Pridanie súčtov pod tabuľku
          const totalY = doc.lastAutoTable.finalY + 10;
          doc.setFontSize(10); // Menšie písmo pre súčty
          // Použijeme innerText pre jednoduchšie odstránenie HTML tagov
          const totalTextContent = totalSalaryDiv.innerText || '';
          doc.text(totalTextContent, 14, totalY);

          // Uloženie PDF
          const fileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
          doc.save(fileName);
          showToast('PDF úspešne vygenerované.', 'success');

      } catch (error) {
          console.error("Chyba pri generovaní PDF:", error);
          showToast('Chyba pri generovaní PDF.', 'error');
      } finally {
          hideActivity();
      }
    }

    // Funkcia na zdieľanie PDF
    async function sendPDF() {
        if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.autoTable === 'undefined') {
            return showToast("Knižnica pre PDF sa ešte nenačítala, skúste o chvíľu.", "warning");
        }

        showActivity('Pripravujem PDF na zdieľanie...');
        let doc; // Pre prípadný fallback save pri chybe
        try {
            const { jsPDF } = window.jspdf;
            doc = new jsPDF();

            try {
                if (doc.getFontList && !doc.getFontList().hasOwnProperty('Roboto')) {
                    doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
                }
                doc.setFont('Roboto');
            } catch(fontError) {
                console.warn("Nepodarilo sa načítať/nastaviť font Roboto, použije sa helvetica.", fontError);
                doc.setFont('helvetica', 'normal');
            }

            // Hlavička PDF (rovnaká ako pri exporte)
            doc.setFontSize(18);
            doc.text(`Bruno's Calculator - Výkaz práce (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
            doc.setFontSize(14);
            doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
            doc.setFontSize(12);
            doc.text(`Hodinová mzda: ${hourlyWage.toFixed(2)} €`, 14, 34);
            doc.text(`Sadzba dane: ${(taxRate * 100).toFixed(1)} %`, 100, 34);

            // Zbieranie dát (rovnaké ako pri exporte)
            const tableData = [];
            const daysCount = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysCount; i++) {
                const dayName = getDayName(currentYear, currentMonth, i);
                const startTime = document.getElementById(`start-${i}`)?.value || '';
                const endTime = document.getElementById(`end-${i}`)?.value || '';
                const breakTimeValue = document.getElementById(`break-${i}`)?.value || '';
                const totalTime = document.getElementById(`total-${i}`)?.textContent || '';
                const grossSalary = document.getElementById(`gross-${i}`)?.value || '';
                const netSalary = document.getElementById(`net-${i}`)?.value || '';
                const breakTimeFloat = parseFloat(String(breakTimeValue).replace(',', '.')) || 0;
                if (startTime || endTime || breakTimeFloat >= 0) {
                    tableData.push([
                        `Deň ${i} (${dayName})`, startTime, endTime, breakTimeValue || '0', totalTime, grossSalary + ' €', netSalary + ' €'
                    ]);
                }
            }

            // Generovanie tabuľky (rovnaké ako pri exporte)
            doc.autoTable({
                head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Hrubá Mzda (€)', 'Čistá Mzda (€)']],
                body: tableData,
                startY: 40, theme: 'grid',
                styles: { font: doc.getFont().fontName, fontSize: 9, cellPadding: 2, valign: 'middle' },
                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold', halign: 'center' },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                columnStyles: { 0: { halign: 'left', cellWidth: 25 }, 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center', cellWidth: 20 }, 4: { halign: 'left' }, 5: { halign: 'right' }, 6: { halign: 'right' } }
            });

            // Pridanie súčtov (rovnaké ako pri exporte)
            const totalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            const totalTextContent = totalSalaryDiv.innerText || '';
            doc.text(totalTextContent, 14, totalY);

            // Vytvorenie Blob a File
            const pdfBlob = doc.output('blob');
            const fileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            // Pokus o zdieľanie
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                await navigator.share({
                    files: [pdfFile],
                    title: `Výkaz práce ${getMonthName(currentMonth)} ${currentYear}`,
                    text: `Výkaz práce pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)}.`
                });
                console.log('PDF úspešne odoslané cez Share API');
                showToast('PDF pripravené na zdieľanie.', 'success');
            } else {
                console.warn('Share API nie je podporované alebo nemôže zdieľať súbory.');
                showToast('Zdieľanie súborov nie je podporované. PDF bolo stiahnuté.', 'warning', 4000);
                doc.save(fileName); // Fallback na stiahnutie
            }

        } catch (error) {
            console.error('Chyba pri zdieľaní PDF:', error);
            // Zistíme, či chyba nastala priamo pri navigator.share (napr. užívateľ zrušil)
            if (error.name === 'AbortError') {
                showToast('Zdieľanie bolo zrušené.', 'info');
            } else {
                showToast(`Chyba pri príprave PDF na zdieľanie: ${error.message}`, 'error');
                // Fallback na stiahnutie pri chybe generovania
                if (doc) try { doc.save(`Vykaz-chyba-${Date.now()}.pdf`); } catch (e) {}
            }
        } finally {
            hideActivity();
        }
    }

    // --- Priradenie listenerov k tlačidlám ---
    exportPdfBtn.addEventListener('click', exportToPDF);
    sharePdfBtn.addEventListener('click', sendPDF);

    // -------------------- Exporty a Zálohy (Event Listenery) --------------------

    // Export PDF už je definovaný vyššie

    // Zdieľanie PDF už je definované vyššie

    backupBtn.addEventListener('click', () => {
         if (typeof XLSX === 'undefined') { return showToast("Knižnica pre Excel sa ešte nenačítala.", "warning"); }
         showActivity('Vytváram zálohu...');
        try {
             const currentData = collectCurrentData();
             if (!currentData?.data?.length) return showToast('Nie sú dáta na zálohovanie.', 'warning');
            const ws_data = [ ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Hrubá Mzda (€)", "Čistá Mzda (€)"] ];
            currentData.data.forEach((row, index) => {
                const day = index + 1;
                 ws_data.push([
                     `${day}. (${getDayName(currentYear, currentMonth, day)})`,
                     row.start, row.end,
                     parseFloat(row.breakTime) || 0, // Uložíme ako číslo
                     parseFloat(row.gross) || 0,
                     parseFloat(row.net) || 0
                 ]);
            });
            ws_data.push([]);
            ws_data.push(["--- Nastavenia ---"]);
            ws_data.push(["Pracovník:", currentData.employeeName]);
            ws_data.push(["Hodinová mzda (€):", currentData.hourlyWage]);
            ws_data.push(["Sadzba dane (%):", currentData.taxRate * 100]);
            ws_data.push(["Desatinné miesta:", currentData.decimalPlaces]);
            ws_data.push(["Posledná aktualizácia:", currentData.lastUpdated ? new Date(currentData.lastUpdated).toLocaleString('sk-SK') : 'Neznáma']);
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:15}, {wch:10}, {wch:10}, {wch:12}, {wch:15}, {wch:15} ];
            XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)}`);
            const fileName = `Zaloha-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Záloha bola úspešne vytvorená.', 'success');
        } catch(error) {
             console.error('Chyba pri vytváraní zálohy:', error);
             showToast('Chyba pri vytváraní zálohy.', 'error');
        } finally { hideActivity(); }
    });

    restoreBtn.addEventListener('click', () => {
        if (typeof XLSX === 'undefined') { return showToast("Knižnica pre Excel sa ešte nenačítala.", "warning"); }
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls';
        input.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm(`Naozaj obnoviť dáta zo súboru "${file.name}" pre ${getMonthName(currentMonth)} ${currentYear}?`)) return;
            showActivity(`Spracovávam zálohu...`);
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });
                    let headerRowIndex = rows.findIndex(row => String(row[0]).toLowerCase().includes("deň"));
                    if (headerRowIndex === -1) throw new Error("Hlavička tabuľky ('Deň') nebola nájdená.");
                    const dataStartIndex = headerRowIndex + 1;
                    const restoredDayData = [];
                    let settings = {};
                    const daysInTargetMonth = getDaysInMonth(currentYear, currentMonth);
                    let readingData = true;
                    for (let i = dataStartIndex; i < rows.length; i++) {
                         const row = rows[i];
                         if (!row || !row.some(cell => cell !== "")) { readingData = false; continue; }
                         const firstCellLower = String(row[0]).toLowerCase().trim();
                         if (readingData && (firstCellLower.startsWith("deň") || /^\d+\.?/.test(firstCellLower))) {
                              if (restoredDayData.length < daysInTargetMonth) {
                                 restoredDayData.push({
                                     start: String(row[1] || ""),
                                     end: String(row[2] || ""),
                                     breakTime: String(row[3] || "0").replace(',','.'),
                                 });
                              }
                         } else {
                              readingData = false;
                              if (row.length > 1 && row[0]) {
                                  const key = String(row[0]).toLowerCase().trim().replace(':', '');
                                  const value = String(row[1] || "").trim();
                                  if (key.includes("pracovník")) settings.employeeName = value;
                                  else if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value.replace(/[^\d.,]/g, '').replace(',', '.')) || undefined;
                                  else if (key.includes("sadzba dane")) settings.taxRate = (parseFloat(value.replace(/[^\d.,]/g, '').replace(',', '.')) || undefined) / 100;
                                  else if (key.includes("desatinné miesta")) settings.decimalPlaces = parseInt(value) || undefined;
                              }
                         }
                     }
                      while (restoredDayData.length < daysInTargetMonth) { restoredDayData.push({ start: "", end: "", breakTime: "" }); }
                    const backupData = { data: restoredDayData, hourlyWage: settings.hourlyWage ?? hourlyWage, taxRate: settings.taxRate ?? taxRate, employeeName: settings.employeeName ?? employeeName, decimalPlaces: settings.decimalPlaces ?? decimalPlaces, lastUpdated: new Date().toISOString() };
                    applyDataToUI(backupData);
                    monthDataCache[`${currentYear}-${currentMonth}`] = backupData;
                    handleDataChange();
                    showToast('Záloha bola úspešne obnovená.', 'success');
                } catch (error) {
                    console.error('Chyba pri načítavaní zálohy:', error);
                    showToast(`Chyba pri načítavaní zálohy: ${error.message}`, 'error', 5000);
                } finally { hideActivity(); }
            };
            reader.onerror = () => { showToast('Chyba pri čítaní súboru.', 'error'); hideActivity(); }
            reader.readAsArrayBuffer(file);
        };
        input.click();
    });

    // -------------------- Nastavenia Aplikácie (Event Listenery) --------------------

    employeeNameInput.addEventListener('input', debounce((event) => {
        employeeName = event.target.value.trim();
        mainTitle.textContent = employeeName ? `${employeeName} - Kalkulačka` : "Bruno's Calculator Pro";
        handleDataChange();
    }, 500));
    hourlyWageInput.addEventListener('input', debounce((event) => {
        hourlyWage = parseFloat(String(event.target.value).replace(',', '.')) || 0;
        recalculateAllRowsAndTotal();
        handleDataChange();
    }, 500));
    taxRateInput.addEventListener('input', debounce((event) => {
        taxRate = (parseFloat(String(event.target.value).replace(',', '.')) || 0) / 100;
        if (taxRate < 0) taxRate = 0; if (taxRate > 1) taxRate = 1;
        recalculateAllRowsAndTotal();
        handleDataChange();
    }, 500));
    decimalPlacesSelect.addEventListener('change', (event) => {
        decimalPlaces = parseInt(event.target.value);
        recalculateAllRowsAndTotal();
        handleDataChange();
    });
    monthSelect.addEventListener('change', () => { currentMonth = parseInt(monthSelect.value); updateNavigationButtons(); initializeAppSettings(); loadAndDisplayData(); });
    yearSelect.addEventListener('change', () => { currentYear = parseInt(yearSelect.value); updateNavigationButtons(); initializeAppSettings(); loadAndDisplayData(); });
    prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
    nextMonthBtn.addEventListener('click', () => navigateMonth(1));
    prevYearBtn.addEventListener('click', () => navigateYear(-1));
    nextYearBtn.addEventListener('click', () => navigateYear(1));
    darkModeToggleBtn.addEventListener('click', toggleDarkMode);

    // -------------------- INICIALIZÁCIA APLIKÁCIE --------------------
    function initializeAppUI() {
        applyDarkModePreference();
        populateYearSelect();
        initializeAppSettings();
        updateAuthUI();
        loadAndDisplayData();
    }

    onAuthStateChanged(auth, (user) => {
        console.log("Auth state changed. User:", user ? user.uid : 'None');
        const wasLoggedIn = !!currentUser;
        currentUser = user;
        updateAuthUI();
        if (wasLoggedIn !== !!currentUser) {
            monthDataCache = {};
            loadAndDisplayData();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        initializeAppUI();
         if (!navigator.onLine) { showToast("Aplikácia je v režime offline.", "warning"); }
         window.addEventListener('online', () => showToast('Pripojenie k internetu obnovené.', 'success', 2000));
         window.addEventListener('offline', () => showToast('Ste offline. Zmeny sa uložia lokálne.', 'warning', 4000));
    });

  </script>

  <!-- Service Worker registrácia -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne:', registration.scope);
            registration.onupdatefound = () => {
                 const installingWorker = registration.installing;
                 if (installingWorker) {
                     installingWorker.onstatechange = () => {
                         if (installingWorker.state === 'installed') {
                             if (navigator.serviceWorker.controller) {
                                 console.log('Nový obsah je dostupný, prosím obnovte stránku.');
                                 if(typeof showToast === 'function') { showToast('Je dostupná nová verzia aplikácie. Obnovte stránku.', 'info', 10000); }
                                 else { alert('Je dostupná nová verzia aplikácie. Obnovte stránku.'); }
                             } else {
                                 console.log('Obsah je cachovaný pre offline použitie.');
                                 if(typeof showToast === 'function') { showToast('Aplikácia je pripravená na offline použitie.', 'success', 3000); }
                             }
                         }
                     };
                 }
             };
          })
          .catch(error => { console.error('Registrácia Service Workera zlyhala:', error); });
            navigator.serviceWorker.oncontrollerchange = () => {
                 console.log('Nový Service Worker prevzal kontrolu. Odporúča sa obnoviť stránku.');
                 if(typeof showToast === 'function') { showToast('Aplikácia bola aktualizovaná. Obnovte stránku pre najnovšie funkcie.', 'info', 10000); }
            };
      });
    }
  </script>
</body>
</html>
