<!DOCTYPE html>
<html lang="sk" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Content Security Policy - ochrana proti XSS a neautorizovan√Ωm zdrojom -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com https://www.gstatic.com https://apis.google.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob: https:;
    connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com wss://*.firebaseio.com;
    frame-src 'self' https://*.firebaseapp.com https://www.google.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  ">
  <title>Bruno's Calculator Pro</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <meta name="theme-color" content="#7c3aed"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js" defer></script>

  <style>
    :root {
      --primary-bg-color: #f0f2f5;
      --secondary-bg-color: #ffffff;
      --primary-text-color: #1f2937;
      --secondary-text-color: #4b5563;
      --input-bg-color: #fefcbf;
      --input-note-bg-color: #e0f2fe;
      --input-project-bg-color: #e0fef2;
      --table-header-bg-color: #f9fafb;
      --table-border-color: #e5e7eb;
      --current-day-bg-color: #7c3aed;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #2563eb;
      --btn-primary-hover-bg: #1d4ed8;
      --btn-secondary-bg: #7c3aed;
      --btn-secondary-hover-bg: #6d28d9;
      --btn-danger-bg: #dc2626;
      --btn-danger-hover-bg: #b91c1c;
      --btn-warning-bg: #f59e0b;
      --btn-warning-hover-bg: #d97706;
      --btn-highlight-bg: #f59e0b;
      --btn-text-color: #ffffff;
      --total-salary-bg: #eff6ff;
      --link-color: #2563eb;
      --link-hover-color: #1d4ed8;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --box-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --base-font-size: 16px;
      --focus-outline-color: var(--btn-primary-bg);
      --transition-speed: 0.2s;
      --theme-color-meta: #7c3aed;
    }

    html[data-theme='dark'] {
      --primary-bg-color: #111827;
      --secondary-bg-color: #1f2937;
      --primary-text-color: #f3f4f6;
      --secondary-text-color: #9ca3af;
      --input-bg-color: #374151;
      --input-note-bg-color: #2c3a4b;
      --input-project-bg-color: #2c4b3a;
      --table-header-bg-color: #374151;
      --table-border-color: #4b5563;
      --current-day-bg-color: #8b5cf6;
      --current-day-text-color: #ffffff;
      --btn-primary-bg: #3b82f6;
      --btn-primary-hover-bg: #2563eb;
      --btn-secondary-bg: #8b5cf6;
      --btn-secondary-hover-bg: #7c3aed;
      --btn-danger-bg: #ef4444;
      --btn-danger-hover-bg: #dc2626;
      --btn-warning-bg: #f97316;
      --btn-warning-hover-bg: #ea580c;
      --btn-highlight-bg: #f97316;
      --total-salary-bg: #374151;
      --link-color: #60a5fa;
      --link-hover-color: #3b82f6;
      --focus-outline-color: var(--btn-primary-bg);
      --theme-color-meta: #1f2937;
    }

    @font-face {
      font-family: 'Inter';
      src: url('https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2') format('woff2');
      font-weight: 400 700;
      font-style: normal;
      font-display: swap;
    }

    html { font-size: var(--base-font-size); scroll-behavior: smooth; }
    body {
      font-family: var(--font-family); line-height: 1.6; margin: 0; padding: 12px;
      background-color: var(--primary-bg-color); color: var(--primary-text-color);
      font-size: 0.92rem; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    #app-loader {
      display: flex; justify-content: center; align-items: center; height: 100vh;
      font-size: 1.2em; color: var(--secondary-text-color); text-align: center;
      flex-direction: column; background-color: var(--primary-bg-color);
    }
    #app-loader p { margin: 5px 0; }
    #app-loader .loader-emoji { font-size: 2em; margin-bottom: 10px; }

    .container {
      max-width: 1600px; margin: 20px auto; background: var(--secondary-bg-color);
      padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); position: relative;
      transition: background-color var(--transition-speed);
    }
    h1 { text-align: center; font-size: 2rem; color: var(--primary-text-color); margin-bottom: 10px; font-weight: 700; }
    h1#mainTitle {
      background: linear-gradient(45deg, #7c3aed, #db2777, #f59e0b);
      -webkit-background-clip: text; background-clip: text; color: transparent; padding-bottom: 3px;
    }
    h2 {
      text-align: center; color: var(--secondary-text-color); margin-top: -5px;
      font-size: 1rem; font-weight: 500; margin-bottom: 20px;
    }
    fieldset { border: 1px solid var(--table-border-color); border-radius: var(--border-radius); padding: 15px; margin-bottom: 20px; }
    legend { font-weight: 600; color: var(--primary-text-color); padding: 0 8px; font-size: 0.95rem; }
    *:focus-visible { outline: 3px solid var(--focus-outline-color); outline-offset: 2px; box-shadow: 0 0 0 5px rgba(37, 99, 235, 0.2); }
    input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible { outline: 2px solid var(--focus-outline-color); outline-offset: 1px; }
    
    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
    #themeToggleBtn { font-size: 1.3rem; padding: 6px 10px; line-height: 1; background-color: var(--secondary-bg-color); color: var(--primary-text-color); border: 1px solid var(--table-border-color); }
    #themeToggleBtn:hover { background-color: var(--primary-bg-color); }

    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > button#toggleSettingsBtn { margin: 0; }
    .settings > div { flex: 1 1 220px; }
    .settings > button#toggleSettingsBtn {
      flex-basis: 100%; margin-bottom: 10px; background-color: var(--secondary-bg-color); color: var(--primary-text-color);
      border: 1px solid var(--table-border-color); text-align: left; padding: 10px 15px; font-size: 0.95rem;
      font-weight: 500; cursor: pointer; border-radius: var(--border-radius);
      transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
    }
    .settings > button#toggleSettingsBtn:hover { background-color: var(--primary-bg-color); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
    .settings label { display: block; margin-bottom: 5px; font-size: 0.875rem; font-weight: 500; color: var(--secondary-text-color); }
    #settings-collapsible-content {
      display: flex; flex-wrap: wrap; width: 100%; max-height: 0; opacity: 0; overflow: hidden;
      transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out; gap: 10px 12px;
    }
    #settings-collapsible-content.visible { max-height: 800px; opacity: 1; margin-top: 10px; }
    #settings-collapsible-content > fieldset { display: contents; }
    #settings-collapsible-content > fieldset > div { flex: 1 1 220px; margin: 0; }
    
    .table-container {
      overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;
      border: 1px solid var(--table-border-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 10px 12px; border: 1px solid var(--table-border-color); text-align: left;
      font-size: 0.875rem; vertical-align: middle; transition: background-color var(--transition-speed);
    }
    thead tr { border-bottom: 2px solid #d1d5db; }
    th { background-color: var(--table-header-bg-color); font-weight: 600; color: var(--primary-text-color); position: sticky; top: 0; z-index: 10; }
    tr.weekend-day td:first-child { background-color: #f3f4f6; font-style: normal; color: var(--secondary-text-color); }
    html[data-theme='dark'] tr.weekend-day td:first-child { background-color: #374151; color: var(--secondary-text-color); }

    td .time-input-wrapper { display: flex; align-items: center; gap: 5px; }
    td .time-input-wrapper input[type="tel"] { flex-grow: 1; min-width: 65px; padding: 8px 6px; font-size: 0.875rem; }
    td .time-input-wrapper .time-btn {
      font-size: 1.1rem; cursor: pointer; padding: 4px 5px; border: 1px solid transparent;
      border-radius: var(--border-radius); line-height: 1; background: none; color: var(--secondary-text-color);
      user-select: none; transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
    }
    td .time-input-wrapper .time-btn:hover { background-color: #e5e7eb; border-color: #d1d5db; color: var(--primary-text-color); }
    html[data-theme='dark'] td .time-input-wrapper .time-btn:hover { background-color: #4b5563; border-color: #6b7280; color: var(--primary-text-color); }

    th:nth-child(1), td:nth-child(1) { width: 95px;}
    th:nth-child(2), td:nth-child(2) { width: 105px;}
    th:nth-child(3), td:nth-child(3) { width: 105px;}
    th:nth-child(4), td:nth-child(4) { width: 85px;}
    th:nth-child(5), td:nth-child(5) { width: 110px;}
    th:nth-child(6), td:nth-child(6) { min-width: 150px; width: auto; }
    th:nth-child(7), td:nth-child(7) { min-width: 200px; width: auto; }
    th:nth-child(8), td:nth-child(8) { width: 90px;}
    th:nth-child(9), td:nth-child(9) { width: 90px;}
    th:nth-child(10), td:nth-child(10) { width: 45px; text-align: center;}

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%; padding: 9px 12px; box-sizing: border-box; background-color: var(--input-bg-color);
      font-size: 0.9rem; border: 1px solid var(--table-border-color); border-radius: var(--border-radius); vertical-align: middle;
      font-family: var(--font-family); transition: border-color var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed); color: var(--primary-text-color);
    }
    input[type="tel"]:focus, input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
        border-color: var(--focus-outline-color); box-shadow: 0 0 0 1px var(--focus-outline-color);
    }
    input[type="tel"].invalid-time, input[type="number"].invalid-value, input[type="text"].invalid-value {
        border-color: var(--btn-danger-bg) !important; box-shadow: 0 0 0 1px var(--btn-danger-bg) !important;
    }
    td input[type="number"] { min-width: 60px; }
    td input[type="text"].project-input { background-color: var(--input-project-bg-color); }
    td input[type="number"][readonly] {
      background-color: var(--table-header-bg-color) !important;
      border: none; padding-left: 2px; padding-right: 2px;
      color: var(--secondary-text-color); font-weight: 500;
    }
    textarea[id^="note-"] {
      background-color: var(--input-note-bg-color); resize: vertical; min-height: 38px; line-height: 1.5;
      overflow-y: hidden; white-space: pre-wrap; word-wrap: break-word;
    }
    .btn-container { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 25px; gap: 12px; }
    .btn {
      flex: 0 1 auto; padding: 10px 20px; color: var(--btn-text-color); border: none;
      border-radius: var(--border-radius); cursor: pointer; font-size: 0.92rem; font-weight: 500;
      margin: 0; transition: background-color var(--transition-speed) ease, transform 0.1s ease, box-shadow var(--transition-speed) ease;
      text-align: center; box-shadow: var(--box-shadow);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 7px 10px -3px rgba(0,0,0,0.1), 0 4px 5px -2px rgba(0,0,0,0.06); }
    .btn:active { transform: translateY(0px); box-shadow: var(--box-shadow); }
    .btn.is-loading { pointer-events: none; position: relative; }
    .btn.is-loading::before {
        content: ""; position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.6);
        border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    html[data-theme='dark'] .btn.is-loading::before {
        border: 2px solid rgba(255,255,255,0.4);
        border-top-color: var(--primary-text-color);
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    .reset-btn { background-color: var(--btn-danger-bg); }
    .reset-btn:hover { background-color: var(--btn-danger-hover-bg); }
    .btn.warning-btn { background-color: var(--btn-warning-bg); color: var(--primary-text-color); }
    html[data-theme='dark'] .btn.warning-btn { color: var(--primary-bg-color); }
    .btn.warning-btn:hover { background-color: var(--btn-warning-hover-bg); }
    .export-btn { background-color: var(--btn-primary-bg); }
    .export-btn:hover { background-color: var(--btn-primary-hover-bg); }
    .backup-btn { background-color: var(--btn-secondary-bg); }
    .backup-btn:hover { background-color: var(--btn-secondary-hover-bg); }
    #totalSalary {
      font-size: 1rem; font-weight: 500; text-align: center; margin-top: 25px; padding: 15px;
      background-color: var(--total-salary-bg); border-radius: var(--border-radius); line-height: 1.8;
      color: var(--primary-text-color); box-shadow: var(--box-shadow);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    #totalSalary .goal-progress { font-size: 0.9em; margin-top: 8px; color: var(--secondary-text-color); }
    #totalSalary .goal-progress.good { color: #10b981; }
    #totalSalary .goal-progress.medium { color: #f59e0b; }
    #totalSalary .goal-progress.low { color: #ef4444; }
    html[data-theme='dark'] #totalSalary .goal-progress.good { color: #34d399; }
    html[data-theme='dark'] #totalSalary .goal-progress.medium { color: #f97316; }
    html[data-theme='dark'] #totalSalary .goal-progress.low { color: #f87171; }

    #localStorageIndicator { font-size: 0.8rem; text-align: right; margin-top: 8px; color: #9ca3af; }
    html[data-theme='dark'] #localStorageIndicator { color: var(--secondary-text-color); }

    .current-day { background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color); }
    .current-day td, .current-day th {
        background-color: var(--current-day-bg-color) !important; color: var(--current-day-text-color) !important;
        border-color: rgba(255,255,255,0.3) !important;
    }
    .current-day input, .current-day select, .current-day textarea, .current-day input.project-input {
      background-color: rgba(255,255,255,0.15) !important; color: var(--current-day-text-color) !important;
      border-color: rgba(255,255,255,0.4) !important;
    }
    .current-day input::placeholder, .current-day textarea::placeholder { color: rgba(255,255,255,0.7); }
    .current-day textarea[id^="note-"] { background-color: rgba(255,255,255,0.2) !important; }
    .current-day input[id^="project-"] { background-color: rgba(200,255,200,0.2) !important; }
    .current-day .time-btn { color: var(--current-day-text-color) !important; }
    .current-day .time-btn:hover { background-color: rgba(255,255,255,0.25) !important; border-color: rgba(255,255,255,0.5) !important; }

    #auth-container { margin-bottom: 20px; }
    #auth-container fieldset { width: 100%; max-width: 380px; margin-left:auto; margin-right:auto; }
    #login-form { display: flex; flex-direction: column; align-items: center; }
    #login-form input[type="email"], #login-form input[type="password"] {
      width: 100%; margin: 8px 0; display: block; padding: 10px; font-size: 0.95rem; box-sizing: border-box;
    }
    #login-form .btn {
      width: 100%; margin: 8px 0 0 0; padding: 10px 15px; font-size: 0.95rem;
      flex-grow: 0; flex-shrink: 0; flex-basis: auto; min-width: auto; max-width: none;
    }
    #login-form .btn + .btn { margin-top: 10px; }
    #login-form a { margin-top: 15px; display: block; font-size: 0.9rem; color: var(--link-color); text-decoration: none; }
    #login-form a:hover { text-decoration: underline; color: var(--link-hover-color); }
    #user-info { align-items: center; }
    @media (max-width: 768px) {
      body { padding: 8px; font-size: 0.9rem; }
      .container { padding: 15px; margin: 10px auto; }
      .header-controls { justify-content: center; }
      #themeToggleBtn { order: -1; }
      h1 { font-size: 1.8rem; } h2 { font-size: 0.95rem; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; width: 100%; }
      #settings-collapsible-content.visible { max-height: 950px; }
      th, td { padding: 8px; font-size: 0.85rem; }
      textarea[id^="note-"] { min-height: 40px; }
      .btn-container .btn { font-size: 0.9rem; padding: 12px 18px; margin: 5px 0; min-width: 180px; max-width: 300px; }
      .btn-container .btn[title*="Vymaza≈• mesiac"] { max-width: 240px; }
      #login-form input[type="email"], #login-form input[type="password"] { font-size: 0.9rem; padding: 10px;}
      #login-form .btn { font-size: 0.92rem !important; padding-top: 11px !important; padding-bottom: 11px !important;}
      #login-form a { margin-top: 18px !important; font-size: 0.88rem; }
    }
    @media (max-width: 480px) {
      body { padding: 6px; } .container { padding: 10px; }
      h1 { font-size: 1.6rem; } h2 { font-size: 0.9rem; }
      th, td { padding: 7px; font-size: 0.82rem; }
      textarea[id^="note-"] { min-height: 42px; }
      #settings-collapsible-content.visible { max-height: 1100px; }
      .btn-container .btn { font-size: 0.88rem; padding: 11px 16px; min-width: 100%; max-width: 280px; }
      #login-form input[type="email"], #login-form input[type="password"],
      #login-form .btn { font-size: 0.88rem !important; }
    }
    #saveNotification, #errorNotification, #warningNotification {
        display: none; position: fixed; bottom: 25px; right: 25px; padding: 15px 22px;
        border-radius: var(--border-radius); font-size: 0.95rem; box-shadow: var(--box-shadow-lg);
        z-index: 10000; opacity: 0; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        transform: translateY(30px); font-weight: 500;
    }
    #saveNotification.show, #errorNotification.show, #warningNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification { background-color: var(--btn-primary-bg); color: white; }
    #errorNotification { background-color: var(--btn-danger-bg); color: white; }
    #warningNotification { background-color: var(--btn-highlight-bg); color: var(--primary-text-color); }
    html[data-theme='dark'] #warningNotification { color: var(--primary-bg-color); }

    @media print {
      html[data-theme='dark'] body { background-color: #fff !important; color: #000 !important; }
      html[data-theme='dark'] th, html[data-theme='dark'] td { background-color: #fff !important; color: #000 !important; border-color: #ccc !important; }
      #themeToggleBtn { display: none !important; }
      td input[type="text"].project-input {
          background-color: transparent !important; border: none !important; color: #000 !important;
          padding: 0 !important; text-align: left; width: auto !important; font-size: 9pt !important;
      }
    }
  </style>
</head>
<body>
  <div id="app-loader">
    <p class="loader-emoji">üßÆ</p>
    <p>Bruno's Calculator Pro+</p>
    <p style="font-size: 0.8em;">Naƒç√≠tavam aplik√°ciu...</p>
  </div>

  <div class="container" style="display: none;">
    <div id="auth-container">
      <fieldset id="login-fieldset">
        <legend>Prihl√°senie / Registr√°cia</legend>
        <div id="login-form">
          <input type="email" id="email" placeholder="Email" aria-label="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Heslo" aria-label="Heslo" autocomplete="current-password">
          <button id="loginBtn" class="btn export-btn">Prihl√°si≈• sa</button>
          <button id="registerBtn" class="btn export-btn">Registrova≈•</button>
          <a href="#" id="resetPasswordLink">Zabudli ste heslo?</a>
        </div>
      </fieldset>
      <div class="header-controls">
        <div id="user-info" style="display: none; justify-content: flex-start; align-items: center; gap: 15px; margin-top:10px; flex-grow: 1;">
            <span id="user-email" style="font-weight:500;"></span>
            <button id="logoutBtn" class="btn reset-btn" style="padding: 8px 15px; font-size: 0.85rem; margin:0;">Odhl√°si≈• sa</button>
        </div>
        <button id="themeToggleBtn" class="btn" title="Prepn√∫≈• svetl√Ω/tmav√Ω re≈æim" style="margin-left: auto; background-color: var(--btn-secondary-bg); padding: 8px 12px;">
            <span id="themeIcon">üåô</span>
        </button>
      </div>
    </div>

    <h1 id="mainTitle">Vitaj üëã</h1>
    <h2 id="subTitle"></h2>

    <div class="settings">
        <button id="toggleSettingsBtn" class="btn" aria-expanded="false" aria-controls="settings-collapsible-content">Zobrazi≈• nastavenia aplik√°cie ‚ñº</button>
        <div id="settings-collapsible-content">
            <fieldset>
                <legend>Z√°kladn√© nastavenia</legend>
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="hourlyWageInput">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="text" inputmode="decimal" id="taxRateInput">
                </div>
                <div>
                    <label for="monthlyGoalInput">Mesaƒçn√Ω cieƒæ z√°robku (‚Ç¨):</label>
                    <input type="text" inputmode="decimal" id="monthlyGoalInput" placeholder="Napr. 1500">
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest:</label>
                    <select id="decimalPlacesSelect">
                      <option value="1">1</option> <option value="2" selected>2</option> <option value="3">3</option>
                    </select>
                </div>
            </fieldset>
             <fieldset>
                <legend>Navig√°cia v ƒçase</legend>
                <div>
                    <label for="monthSelect">Mesiac:</label>
                    <select id="monthSelect"></select>
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect"></select>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Projekt/√öloha</th>
            <th>Pozn√°mka</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary" aria-live="polite">V√Ωpoƒçet celkovej mzdy...</div>
    <div id="localStorageIndicator"></div>

    <div class="btn-container">
        <button id="exportPDFBtn" class="btn export-btn">Exportova≈• do PDF</button>
        <button id="sendPDFBtn" class="btn export-btn">Odosla≈• PDF (s pozn.)</button>
        <button id="createBackupBtn" class="btn backup-btn">Vytvori≈• z√°lohu (XLSX)</button>
        <button id="restoreBackupBtn" class="btn backup-btn">Obnovi≈• z√°lohu (XLSX)</button>
        <button id="loadFromFirestoreBtn" class="btn export-btn">Naƒç√≠ta≈• z Cloudu</button>
        <button id="clearMonthBtn" class="btn warning-btn" title="Vymaza≈• v≈°etky d√°ta pre aktu√°lny mesiac">Vymaza≈• Mesiac</button>
    </div>
  </div>

  <div id="saveNotification" role="status" aria-live="polite">D√°ta boli √∫spe≈°ne ulo≈æen√©.</div>
  <div id="errorNotification" role="alert" aria-live="assertive">Nastala chyba.</div>
  <div id="warningNotification" role="alert" aria-live="assertive">Upozornenie.</div>

  <script type="module">
    // Importy Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
        initializeFirestore, persistentLocalCache, CACHE_SIZE_UNLIMITED,
        collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, writeBatch
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };
    const RECAPTCHA_V3_SITE_KEY ="6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v";

    const app = initializeApp(firebaseConfig);
    try {
       const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider(RECAPTCHA_V3_SITE_KEY),
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) {
        console.warn("App Check initialization failed.", e);
        showWarningNotification("Inicializ√°cia App Check zlyhala. Niektor√© funkcie m√¥≈æu by≈• obmedzen√©.");
    }
    const auth = getAuth(app);

    let db;
    try {
        db = initializeFirestore(app, {
            localCache: persistentLocalCache({ sizeBytes: CACHE_SIZE_UNLIMITED })
        });
    } catch (error) {
        console.warn("Failed to initialize Firestore with persistent cache. Falling back to in-memory cache.", error);
        showWarningNotification("Chyba pri inicializ√°cii offline √∫lo≈æiska. D√°ta nebud√∫ dostupn√© offline.");
        db = initializeFirestore(app, {});
    }

    let currentUser = null;
    let currentListenerUnsubscribe = null;

    const uiRefs = {
        workDaysTbody: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        mainTitle: document.getElementById('mainTitle'),
        subTitle: document.getElementById('subTitle'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthlyGoalInput: document.getElementById('monthlyGoalInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        toggleSettingsBtn: document.getElementById('toggleSettingsBtn'),
        settingsCollapsibleContent: document.getElementById('settings-collapsible-content'),
        localStorageIndicator: document.getElementById('localStorageIndicator'),
        loginForm: document.getElementById('login-form'),
        loginFieldset: document.getElementById('login-fieldset'),
        userInfo: document.getElementById('user-info'),
        userEmailSpan: document.getElementById('user-email'),
        appLoader: document.getElementById('app-loader'),
        mainContainer: document.querySelector('.container'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        themeIcon: document.getElementById('themeIcon'),
        themeMeta: document.querySelector('meta[name="theme-color"]'),
        loginBtn: document.getElementById('loginBtn'),
        registerBtn: document.getElementById('registerBtn'),
        resetPasswordLink: document.getElementById('resetPasswordLink'),
        logoutBtn: document.getElementById('logoutBtn'),
        exportPDFBtn: document.getElementById('exportPDFBtn'),
        sendPDFBtn: document.getElementById('sendPDFBtn'),
        createBackupBtn: document.getElementById('createBackupBtn'),
        restoreBackupBtn: document.getElementById('restoreBackupBtn'),
        loadFromFirestoreBtn: document.getElementById('loadFromFirestoreBtn'),
        clearMonthBtn: document.getElementById('clearMonthBtn'),
    };

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    let appSettings = {
        decimalPlaces: 2, employeeName: '', hourlyWage: 10, taxRate: 0.02,
        theme: 'light',
        monthlyEarningsGoal: null
    };

    const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
    const DAY_NAMES_SHORT = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"];
    const PENDING_SYNC_MONTHS_LS_KEY = 'pendingSyncMonthsList';

    // --- Theme Manager ---
    const ThemeManager = {
        init: () => {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                appSettings.theme = storedTheme;
            } else {
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                appSettings.theme = prefersDark ? 'dark' : 'light';
            }
            ThemeManager.applyTheme(appSettings.theme);
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    appSettings.theme = e.matches ? 'dark' : 'light';
                    ThemeManager.applyTheme(appSettings.theme);
                }
            });
        },
        applyTheme: (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            uiRefs.themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            appSettings.theme = theme;
            if (uiRefs.themeMeta) {
                uiRefs.themeMeta.content = getComputedStyle(document.documentElement).getPropertyValue('--theme-color-meta').trim();
            }
        },
        toggleTheme: () => {
            const newTheme = appSettings.theme === 'light' ? 'dark' : 'light';
            ThemeManager.applyTheme(newTheme);
            saveAppSettingToLocalStorage('theme', newTheme);
            debouncedSaveAppSettingsToFirestore();
        }
    };

    async function updateAppBadge(count) {
      if ('setAppBadge' in navigator) {
        try {
          if (count > 0) { await navigator.setAppBadge(count); }
          else { await navigator.clearAppBadge(); }
        } catch (error) { console.error('Failed to set app badge:', error); }
      }
    }

    function getPendingSyncMonths() { const stored = localStorage.getItem(PENDING_SYNC_MONTHS_LS_KEY); return stored ? JSON.parse(stored) : []; }
    function savePendingSyncMonths(months) { localStorage.setItem(PENDING_SYNC_MONTHS_LS_KEY, JSON.stringify(months)); updateAppBadge(months.length); }
    function addMonthToPendingList(monthDocId) { if (!currentUser) return; let pendingMonths = getPendingSyncMonths(); if (!pendingMonths.includes(monthDocId)) { pendingMonths.push(monthDocId); savePendingSyncMonths(pendingMonths); } }
    function removeMonthFromPendingList(monthDocId) { let pendingMonths = getPendingSyncMonths(); const index = pendingMonths.indexOf(monthDocId); if (index > -1) { pendingMonths.splice(index, 1); savePendingSyncMonths(pendingMonths); } }
    function getPendingSyncCount() { if (!currentUser) return 0; return getPendingSyncMonths().length; }
    function getDaysInMonth(month, year) { return new Date(year, month + 1, 0).getDate(); }
    function getDayName(year, month, day) { return DAY_NAMES_SHORT[new Date(year, month, day).getDay()]; }
    function isWeekend(year, month, day) { const d = new Date(year, month, day).getDay(); return d === 0 || d === 6; }
    const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; };
    function isValidTimeFormat(timeString) { return typeof timeString === 'string' && /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }

    function validatePassword(password) {
        if (!password || password.length < 8) {
            return 'Heslo mus√≠ ma≈• aspo≈à 8 znakov.';
        }
        if (!/[A-Z]/.test(password)) {
            return 'Heslo mus√≠ obsahova≈• aspo≈à jedno veƒæk√© p√≠smeno.';
        }
        if (!/[a-z]/.test(password)) {
            return 'Heslo mus√≠ obsahova≈• aspo≈à jedno mal√© p√≠smeno.';
        }
        if (!/\d/.test(password)) {
            return 'Heslo mus√≠ obsahova≈• aspo≈à jedno ƒç√≠slo.';
        }
        return null;
    }

    function showNotification(id, message, duration = 3500) { 
      const notification = document.getElementById(id); 
      if (!notification) { console.warn(`Notification element with ID '${id}' not found.`); return; } 
      notification.textContent = message; 
      notification.classList.add('show'); 
      setTimeout(() => notification.classList.remove('show'), duration); 
    }
    window.showSaveNotification = (message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©.') => showNotification('saveNotification', message);
    window.showErrorNotification = (message) => showNotification('errorNotification', message, 5000);
    window.showWarningNotification = (message) => showNotification('warningNotification', message, 4500);

    function setLoadingState(button, isLoading, textParam = "Sprac√∫vam...") {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            if (!button.dataset.originalText) { button.dataset.originalText = button.textContent; }
            const spinnerSpan = document.createElement('span'); 
            spinnerSpan.className = 'spinner'; 
            spinnerSpan.setAttribute('role', 'status'); 
            spinnerSpan.setAttribute('aria-hidden', 'true');
            button.textContent = ''; 
            button.appendChild(spinnerSpan); 
            button.appendChild(document.createTextNode(` ${textParam}`)); 
            button.classList.add('is-loading');
        } else {
            button.disabled = false;
            if (button.dataset.originalText) { 
              button.textContent = button.dataset.originalText; 
              delete button.dataset.originalText; 
            }
            else { button.textContent = textParam; }
            button.classList.remove('is-loading');
        }
    }

    function loadAppSettingsFromLocalStorage() {
        appSettings.decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        appSettings.employeeName = localStorage.getItem('employeeName') || '';
        appSettings.hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        appSettings.taxRate = parseFloat(localStorage.getItem('taxRate')) || 0.02;
        appSettings.theme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        appSettings.monthlyEarningsGoal = localStorage.getItem('monthlyEarningsGoal') ? parseFloat(localStorage.getItem('monthlyEarningsGoal')) : null;
    }
    
    function saveAppSettingToLocalStorage(key, value) { 
      localStorage.setItem(key, value); 
      appSettings[key] = value; 
    }
    
    async function saveAppSettingsToFirestore() { 
      if (!currentUser || !navigator.onLine) return; 
      const userDocRef = doc(db, 'users', currentUser.uid); 
      try { 
        await setDoc(userDocRef, { appSettings: appSettings }, { merge: true }); 
      } catch (error) { 
        console.error("Error saving app settings to Firestore:", error); 
        showErrorNotification("Nepodarilo sa ulo≈æi≈• nastavenia aplik√°cie do cloudu."); 
      } 
    }
    
    const debouncedSaveAppSettingsToFirestore = debounce(saveAppSettingsToFirestore, 1800);

    // === EVENT LISTENER SETUP FUNKCIE ===
    
    function setupEventListeners() {
      // Auth tlaƒçidl√°
      uiRefs.loginBtn.addEventListener('click', loginUser);
      uiRefs.registerBtn.addEventListener('click', registerUser);
      uiRefs.resetPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        resetUserPassword();
      });
      uiRefs.logoutBtn.addEventListener('click', logoutUser);
      
      // Theme toggle
      uiRefs.themeToggleBtn.addEventListener('click', ThemeManager.toggleTheme);
      
      // Settings
      uiRefs.toggleSettingsBtn.addEventListener('click', toggleSettings);
      uiRefs.employeeNameInput.addEventListener('input', updateEmployeeName);
      uiRefs.hourlyWageInput.addEventListener('input', function() { handleNumericInput(this); });
      uiRefs.hourlyWageInput.addEventListener('blur', function() { handleWageOrTaxOrGoalBlur(this); });
      uiRefs.taxRateInput.addEventListener('input', function() { handleNumericInput(this); });
      uiRefs.taxRateInput.addEventListener('blur', function() { handleWageOrTaxOrGoalBlur(this); });
      uiRefs.monthlyGoalInput.addEventListener('input', function() { handleNumericInput(this); });
      uiRefs.monthlyGoalInput.addEventListener('blur', function() { handleWageOrTaxOrGoalBlur(this); });
      uiRefs.decimalPlacesSelect.addEventListener('change', changeDecimalPlaces);
      uiRefs.monthSelect.addEventListener('change', changeMonth);
      uiRefs.yearSelect.addEventListener('change', changeYear);
      
      // Action buttons
      uiRefs.exportPDFBtn.addEventListener('click', exportToPDF);
      uiRefs.sendPDFBtn.addEventListener('click', sendPDF);
      uiRefs.createBackupBtn.addEventListener('click', createBackup);
      uiRefs.restoreBackupBtn.addEventListener('click', restoreBackup);
      uiRefs.loadFromFirestoreBtn.addEventListener('click', loadFromFirestore);
      uiRefs.clearMonthBtn.addEventListener('click', clearMonthData);
      
      // Event delegation pre dynamicky generovan√© elementy v tabuƒæke
      uiRefs.workDaysTbody.addEventListener('click', handleTableClick);
      uiRefs.workDaysTbody.addEventListener('input', handleTableInput);
      uiRefs.workDaysTbody.addEventListener('blur', handleTableBlur, true);
    }

    function handleTableClick(e) {
      // Handler pre time-btn tlaƒçidl√°
      if (e.target.classList.contains('time-btn')) {
        const input = e.target.previousElementSibling || e.target.nextElementSibling;
        if (input && input.tagName === 'INPUT') {
          setCurrentTime(input);
        }
      }
      
      // Handler pre delete tlaƒçidl√° (ak bud√∫)
      if (e.target.classList.contains('delete-day-btn')) {
        const day = parseInt(e.target.dataset.day);
        if (day) deleteDayData(day);
      }
    }

    function handleTableInput(e) {
      const target = e.target;
      
      // Time inputs
      if (target.classList.contains('time-input')) {
        debouncedSaveMonthData();
        recalculateDayRow(target);
      }
      
      // Break inputs
      if (target.id && target.id.startsWith('break-')) {
        handleNumericInput(target);
        debouncedSaveMonthData();
        recalculateDayRow(target);
      }
      
      // Project inputs
      if (target.id && target.id.startsWith('project-')) {
        debouncedSaveMonthData();
      }
      
      // Note textareas
      if (target.id && target.id.startsWith('note-')) {
        autoResizeTextarea(target);
        debouncedSaveMonthData();
      }
    }

    function handleTableBlur(e) {
      const target = e.target;
      
      if (target.id && target.id.startsWith('break-')) {
        handleBreakBlur(target);
      }
    }

    function setCurrentTime(input) {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      input.value = `${hours}:${minutes}`;
      input.classList.remove('invalid-time');
      debouncedSaveMonthData();
      recalculateDayRow(input);
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    function recalculateDayRow(inputElement) {
      const row = inputElement.closest('tr');
      if (!row) return;
      
      const day = parseInt(row.dataset.day);
      if (!day) return;
      
      const arrivalInput = row.querySelector(`#arrival-${day}`);
      const departureInput = row.querySelector(`#departure-${day}`);
      const breakInput = row.querySelector(`#break-${day}`);
      const workedHoursInput = row.querySelector(`#worked-${day}`);
      const grossSalaryInput = row.querySelector(`#gross-${day}`);
      const netSalaryInput = row.querySelector(`#net-${day}`);
      
      if (!arrivalInput || !departureInput || !breakInput || !workedHoursInput || !grossSalaryInput || !netSalaryInput) return;
      
      const arrival = arrivalInput.value;
      const departure = departureInput.value;
      const breakMinutes = parseFloat(breakInput.value) || 0;
      
      if (isValidTimeFormat(arrival) && isValidTimeFormat(departure)) {
        const [arrH, arrM] = arrival.split(':').map(Number);
        const [depH, depM] = departure.split(':').map(Number);
        
        let totalMinutes = (depH * 60 + depM) - (arrH * 60 + arrM);
        if (totalMinutes < 0) totalMinutes += 24 * 60;
        
        const workedMinutes = Math.max(0, totalMinutes - breakMinutes);
        const workedHours = workedMinutes / 60;
        
        workedHoursInput.value = workedHours.toFixed(appSettings.decimalPlaces);
        
        const grossSalary = workedHours * appSettings.hourlyWage;
        const netSalary = grossSalary * (1 - appSettings.taxRate);
        
        grossSalaryInput.value = grossSalary.toFixed(appSettings.decimalPlaces);
        netSalaryInput.value = netSalary.toFixed(appSettings.decimalPlaces);
        
        arrivalInput.classList.remove('invalid-time');
        departureInput.classList.remove('invalid-time');
      } else {
        workedHoursInput.value = '';
        grossSalaryInput.value = '';
        netSalaryInput.value = '';
        
        if (arrival && !isValidTimeFormat(arrival)) {
          arrivalInput.classList.add('invalid-time');
        } else {
          arrivalInput.classList.remove('invalid-time');
        }
        
        if (departure && !isValidTimeFormat(departure)) {
          departureInput.classList.add('invalid-time');
        } else {
          departureInput.classList.remove('invalid-time');
        }
      }
      
      calculateTotalSalary();
    }

    function calculateTotalSalary() {
      let totalGross = 0;
      let totalNet = 0;
      let totalWorkedHours = 0;
      
      const allRows = uiRefs.workDaysTbody.querySelectorAll('tr');
      allRows.forEach(row => {
        const day = parseInt(row.dataset.day);
        if (!day) return;
        
        const workedInput = row.querySelector(`#worked-${day}`);
        const grossInput = row.querySelector(`#gross-${day}`);
        const netInput = row.querySelector(`#net-${day}`);
        
        if (workedInput && workedInput.value) {
          totalWorkedHours += parseFloat(workedInput.value) || 0;
        }
        if (grossInput && grossInput.value) {
          totalGross += parseFloat(grossInput.value) || 0;
        }
        if (netInput && netInput.value) {
          totalNet += parseFloat(netInput.value) || 0;
        }
      });
      
      let summaryHTML = `
        <strong>Celkov√° hrub√° mzda:</strong> ${totalGross.toFixed(appSettings.decimalPlaces)} ‚Ç¨<br>
        <strong>Celkov√° ƒçist√° mzda:</strong> ${totalNet.toFixed(appSettings.decimalPlaces)} ‚Ç¨<br>
        <strong>Celkovo odpracovan√© hodiny:</strong> ${totalWorkedHours.toFixed(appSettings.decimalPlaces)} h
      `;
      
      if (appSettings.monthlyEarningsGoal && appSettings.monthlyEarningsGoal > 0) {
        const progress = (totalNet / appSettings.monthlyEarningsGoal) * 100;
        const remaining = appSettings.monthlyEarningsGoal - totalNet;
        
        let progressClass = 'low';
        if (progress >= 90) progressClass = 'good';
        else if (progress >= 60) progressClass = 'medium';
        
        summaryHTML += `
          <div class="goal-progress ${progressClass}">
            üìä Progres k cieƒæu: ${progress.toFixed(1)}% (${totalNet.toFixed(2)} / ${appSettings.monthlyEarningsGoal.toFixed(2)} ‚Ç¨)<br>
            ${remaining > 0 ? `Zost√°va: ${remaining.toFixed(2)} ‚Ç¨` : 'üéâ Cieƒæ dosiahnut√Ω!'}
          </div>
        `;
      }
      
      uiRefs.totalSalaryDiv.innerHTML = summaryHTML;
    }

    function handleNumericInput(input) {
      let value = input.value.replace(',', '.');
      input.value = value;
    }

    function handleWageOrTaxOrGoalBlur(input) {
      const value = parseFloat(input.value);
      
      if (input.id === 'hourlyWageInput') {
        if (!isNaN(value) && value >= 0) {
          appSettings.hourlyWage = value;
          saveAppSettingToLocalStorage('hourlyWage', value);
          input.classList.remove('invalid-value');
        } else {
          input.classList.add('invalid-value');
          showErrorNotification('Hodinov√° mzda mus√≠ by≈• kladn√© ƒç√≠slo.');
          return;
        }
      } else if (input.id === 'taxRateInput') {
        if (!isNaN(value) && value >= 0 && value <= 100) {
          appSettings.taxRate = value / 100;
          saveAppSettingToLocalStorage('taxRate', appSettings.taxRate);
          input.classList.remove('invalid-value');
        } else {
          input.classList.add('invalid-value');
          showErrorNotification('Da≈àov√© percento mus√≠ by≈• medzi 0 a 100.');
          return;
        }
      } else if (input.id === 'monthlyGoalInput') {
        if (!isNaN(value) && value >= 0) {
          appSettings.monthlyEarningsGoal = value;
          saveAppSettingToLocalStorage('monthlyEarningsGoal', value);
          input.classList.remove('invalid-value');
        } else if (input.value === '') {
          appSettings.monthlyEarningsGoal = null;
          localStorage.removeItem('monthlyEarningsGoal');
          input.classList.remove('invalid-value');
        } else {
          input.classList.add('invalid-value');
          showErrorNotification('Mesaƒçn√Ω cieƒæ mus√≠ by≈• kladn√© ƒç√≠slo.');
          return;
        }
      }
      
      debouncedSaveAppSettingsToFirestore();
      recalculateAllRows();
      calculateTotalSalary();
    }

    function handleBreakBlur(input) {
      const value = parseFloat(input.value);
      if (isNaN(value) || value < 0) {
        input.classList.add('invalid-value');
        showErrorNotification('Prest√°vka mus√≠ by≈• kladn√© ƒç√≠slo.');
      } else {
        input.classList.remove('invalid-value');
        recalculateDayRow(input);
      }
    }

    function recalculateAllRows() {
      const allRows = uiRefs.workDaysTbody.querySelectorAll('tr');
      allRows.forEach(row => {
        const day = parseInt(row.dataset.day);
        if (!day) return;
        const firstInput = row.querySelector('input');
        if (firstInput) recalculateDayRow(firstInput);
      });
    }

    function updateEmployeeName() {
      const name = uiRefs.employeeNameInput.value.trim();
      appSettings.employeeName = name;
      saveAppSettingToLocalStorage('employeeName', name);
      updateSubTitle();
      debouncedSaveAppSettingsToFirestore();
    }

    function updateSubTitle() {
      const monthName = MONTH_NAMES[currentMonth];
      const employeeName = appSettings.employeeName || 'Pracovn√≠k';
      uiRefs.subTitle.textContent = `${employeeName} - ${monthName} ${currentYear}`;
    }

    function changeDecimalPlaces() {
      const newValue = parseInt(uiRefs.decimalPlacesSelect.value);
      appSettings.decimalPlaces = newValue;
      saveAppSettingToLocalStorage('decimalPlaces', newValue);
      debouncedSaveAppSettingsToFirestore();
      recalculateAllRows();
      calculateTotalSalary();
    }

    function changeMonth() {
      const newMonth = parseInt(uiRefs.monthSelect.value);
      if (newMonth !== currentMonth) {
        currentMonth = newMonth;
        loadCurrentMonthData();
      }
    }

    function changeYear() {
      const newYear = parseInt(uiRefs.yearSelect.value);
      if (newYear !== currentYear) {
        currentYear = newYear;
        loadCurrentMonthData();
      }
    }

    function toggleSettings() {
      const isVisible = uiRefs.settingsCollapsibleContent.classList.toggle('visible');
      uiRefs.toggleSettingsBtn.setAttribute('aria-expanded', isVisible);
      uiRefs.toggleSettingsBtn.textContent = isVisible 
        ? 'Skry≈• nastavenia aplik√°cie ‚ñ≤' 
        : 'Zobrazi≈• nastavenia aplik√°cie ‚ñº';
    }

    // === AUTH FUNKCIE ===
    
    async function loginUser() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showErrorNotification('Pros√≠m vypl≈àte email a heslo.');
        return;
      }
      
      setLoadingState(uiRefs.loginBtn, true, 'Prihlasovanie...');
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showSaveNotification('√öspe≈°ne prihl√°sen√Ω!');
      } catch (error) {
        console.error('Login error:', error);
        showErrorNotification(`Chyba pri prihl√°sen√≠: ${error.message}`);
      } finally {
        setLoadingState(uiRefs.loginBtn, false);
      }
    }

    async function registerUser() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showErrorNotification('Pros√≠m vypl≈àte email a heslo.');
        return;
      }
      
      const passwordError = validatePassword(password);
      if (passwordError) {
        showErrorNotification(passwordError);
        return;
      }
      
      setLoadingState(uiRefs.registerBtn, true, 'Registr√°cia...');
      
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showSaveNotification('√öspe≈°ne registrovan√Ω!');
      } catch (error) {
        console.error('Registration error:', error);
        showErrorNotification(`Chyba pri registr√°cii: ${error.message}`);
      } finally {
        setLoadingState(uiRefs.registerBtn, false);
      }
    }

    async function logoutUser() {
      try {
        await signOut(auth);
        showSaveNotification('Odhl√°sen√Ω.');
      } catch (error) {
        console.error('Logout error:', error);
        showErrorNotification('Chyba pri odhl√°sen√≠.');
      }
    }

    async function resetUserPassword() {
      const email = document.getElementById('email').value.trim();
      
      if (!email) {
        showErrorNotification('Pros√≠m zadajte email adresu.');
        return;
      }
      
      try {
        await sendPasswordResetEmail(auth, email);
        showSaveNotification('Email na reset hesla bol odoslan√Ω.');
      } catch (error) {
        console.error('Password reset error:', error);
        showErrorNotification(`Chyba: ${error.message}`);
      }
    }

    // === MONTH DATA FUNKCIE ===
    
    function getMonthDocId() {
      return `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    }

    function loadCurrentMonthData() {
      updateSubTitle();
      populateMonthSelects();
      
      const monthDocId = getMonthDocId();
      const storedData = localStorage.getItem(`monthData_${monthDocId}`);
      
      if (storedData) {
        try {
          const monthData = JSON.parse(storedData);
          renderMonthTable(monthData);
        } catch (error) {
          console.error('Error parsing stored month data:', error);
          renderMonthTable({});
        }
      } else {
        renderMonthTable({});
      }
      
      if (currentUser && navigator.onLine) {
        attachMonthListener();
      }
    }

    function renderMonthTable(monthData) {
      const daysInMonth = getDaysInMonth(currentMonth, currentYear);
      const today = new Date();
      const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
      const currentDay = isCurrentMonth ? today.getDate() : -1;
      
      let html = '';
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dayName = getDayName(currentYear, currentMonth, day);
        const isWeekendDay = isWeekend(currentYear, currentMonth, day);
        const isCurrentDay = day === currentDay;
        
        const dayData = monthData[day] || {};
        const arrival = dayData.arrival || '';
        const departure = dayData.departure || '';
        const breakMinutes = dayData.break || 0;
        const project = dayData.project || '';
        const note = dayData.note || '';
        
        let workedHours = '';
        let grossSalary = '';
        let netSalary = '';
        
        if (isValidTimeFormat(arrival) && isValidTimeFormat(departure)) {
          const [arrH, arrM] = arrival.split(':').map(Number);
          const [depH, depM] = departure.split(':').map(Number);
          
          let totalMinutes = (depH * 60 + depM) - (arrH * 60 + arrM);
          if (totalMinutes < 0) totalMinutes += 24 * 60;
          
          const workedMinutes = Math.max(0, totalMinutes - breakMinutes);
          const worked = workedMinutes / 60;
          
          workedHours = worked.toFixed(appSettings.decimalPlaces);
          
          const gross = worked * appSettings.hourlyWage;
          const net = gross * (1 - appSettings.taxRate);
          
          grossSalary = gross.toFixed(appSettings.decimalPlaces);
          netSalary = net.toFixed(appSettings.decimalPlaces);
        }
        
        html += `
          <tr data-day="${day}" class="${isWeekendDay ? 'weekend-day' : ''} ${isCurrentDay ? 'current-day' : ''}">
            <td>${day}. ${dayName}</td>
            <td>
              <div class="time-input-wrapper">
                <input type="tel" id="arrival-${day}" class="time-input" placeholder="08:00" value="${arrival}" maxlength="5">
                <button type="button" class="time-btn" title="Nastavi≈• aktu√°lny ƒças">üïê</button>
              </div>
            </td>
            <td>
              <div class="time-input-wrapper">
                <input type="tel" id="departure-${day}" class="time-input" placeholder="16:00" value="${departure}" maxlength="5">
                <button type="button" class="time-btn" title="Nastavi≈• aktu√°lny ƒças">üïê</button>
              </div>
            </td>
            <td><input type="number" id="break-${day}" placeholder="30" value="${breakMinutes || ''}" min="0" step="1"></td>
            <td><input type="number" id="worked-${day}" readonly value="${workedHours}"></td>
            <td><input type="text" id="project-${day}" class="project-input" placeholder="N√°zov projektu..." value="${project}"></td>
            <td><textarea id="note-${day}" placeholder="Pozn√°mky...">${note}</textarea></td>
            <td><input type="number" id="gross-${day}" readonly value="${grossSalary}"></td>
            <td><input type="number" id="net-${day}" readonly value="${netSalary}"></td>
            <td></td>
          </tr>
        `;
      }
      
      uiRefs.workDaysTbody.innerHTML = html;
      
      // Auto-resize textareas
      document.querySelectorAll('textarea[id^="note-"]').forEach(textarea => {
        autoResizeTextarea(textarea);
      });
      
      calculateTotalSalary();
    }

    function collectMonthData() {
      const monthData = {};
      const daysInMonth = getDaysInMonth(currentMonth, currentYear);
      
      for (let day = 1; day <= daysInMonth; day++) {
        const arrival = document.getElementById(`arrival-${day}`)?.value || '';
        const departure = document.getElementById(`departure-${day}`)?.value || '';
        const breakMinutes = parseFloat(document.getElementById(`break-${day}`)?.value) || 0;
        const project = document.getElementById(`project-${day}`)?.value || '';
        const note = document.getElementById(`note-${day}`)?.value || '';
        
        if (arrival || departure || breakMinutes || project || note) {
          monthData[day] = { arrival, departure, break: breakMinutes, project, note };
        }
      }
      
      return monthData;
    }

    function saveMonthData() {
      const monthData = collectMonthData();
      const monthDocId = getMonthDocId();
      
      localStorage.setItem(`monthData_${monthDocId}`, JSON.stringify(monthData));
      
      if (currentUser && navigator.onLine) {
        saveMonthDataToFirestore(monthData, monthDocId);
      } else if (currentUser) {
        addMonthToPendingList(monthDocId);
        updateLocalStorageIndicator();
      }
    }

    const debouncedSaveMonthData = debounce(saveMonthData, 1000);

    async function saveMonthDataToFirestore(monthData, monthDocId) {
      if (!currentUser) return;
      
      const monthDocRef = doc(db, 'users', currentUser.uid, 'months', monthDocId);
      
      try {
        await setDoc(monthDocRef, { data: monthData }, { merge: true });
        removeMonthFromPendingList(monthDocId);
        updateLocalStorageIndicator();
      } catch (error) {
        console.error('Error saving to Firestore:', error);
        addMonthToPendingList(monthDocId);
        updateLocalStorageIndicator();
      }
    }

    function attachMonthListener() {
      if (currentListenerUnsubscribe) {
        currentListenerUnsubscribe();
      }
      
      if (!currentUser) return;
      
      const monthDocId = getMonthDocId();
      const monthDocRef = doc(db, 'users', currentUser.uid, 'months', monthDocId);
      
      currentListenerUnsubscribe = onSnapshot(monthDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data && data.data) {
            localStorage.setItem(`monthData_${monthDocId}`, JSON.stringify(data.data));
            renderMonthTable(data.data);
            removeMonthFromPendingList(monthDocId);
            updateLocalStorageIndicator();
          }
        }
      }, (error) => {
        console.error('Firestore listener error:', error);
      });
    }

    async function loadFromFirestore() {
      if (!currentUser) {
        showErrorNotification('Mus√≠te by≈• prihl√°sen√Ω.');
        return;
      }
      
      if (!navigator.onLine) {
        showWarningNotification('Ste offline. Pripojte sa k internetu.');
        return;
      }
      
      setLoadingState(uiRefs.loadFromFirestoreBtn, true, 'Naƒç√≠tavam...');
      
      const monthDocId = getMonthDocId();
      const monthDocRef = doc(db, 'users', currentUser.uid, 'months', monthDocId);
      
      try {
        const docSnap = await getDoc(monthDocRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data && data.data) {
            localStorage.setItem(`monthData_${monthDocId}`, JSON.stringify(data.data));
            renderMonthTable(data.data);
            showSaveNotification('D√°ta boli naƒç√≠tan√© z cloudu.');
          } else {
            showWarningNotification('≈Ωiadne d√°ta v cloude pre tento mesiac.');
          }
        } else {
          showWarningNotification('≈Ωiadne d√°ta v cloude pre tento mesiac.');
        }
      } catch (error) {
        console.error('Error loading from Firestore:', error);
        showErrorNotification('Chyba pri naƒç√≠tan√≠ z cloudu.');
      } finally {
        setLoadingState(uiRefs.loadFromFirestoreBtn, false);
      }
    }

    function clearMonthData() {
      if (!confirm(`Naozaj chcete vymaza≈• v≈°etky d√°ta pre ${MONTH_NAMES[currentMonth]} ${currentYear}?`)) {
        return;
      }
      
      const monthDocId = getMonthDocId();
      localStorage.removeItem(`monthData_${monthDocId}`);
      renderMonthTable({});
      
      if (currentUser && navigator.onLine) {
        deleteMonthDataFromFirestore(monthDocId);
      }
      
      showSaveNotification('Mesaƒçn√© d√°ta boli vymazan√©.');
    }

    async function deleteMonthDataFromFirestore(monthDocId) {
      if (!currentUser) return;
      
      const monthDocRef = doc(db, 'users', currentUser.uid, 'months', monthDocId);
      
      try {
        await deleteDoc(monthDocRef);
        removeMonthFromPendingList(monthDocId);
        updateLocalStorageIndicator();
      } catch (error) {
        console.error('Error deleting from Firestore:', error);
      }
    }

    // === EXPORT/BACKUP FUNKCIE ===
    
    async function exportToPDF() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        showErrorNotification('PDF kni≈ænica nie je naƒç√≠tan√°. Sk√∫ste znova.');
        return;
      }
      
      setLoadingState(uiRefs.exportPDFBtn, true, 'Generujem PDF...');
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const monthName = MONTH_NAMES[currentMonth];
        const employeeName = appSettings.employeeName || 'Pracovn√≠k';
        
        doc.setFontSize(16);
        doc.text(`${employeeName} - ${monthName} ${currentYear}`, 14, 20);
        
        const monthData = collectMonthData();
        const tableData = [];
        
        for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
          const dayData = monthData[day] || {};
          const dayName = getDayName(currentYear, currentMonth, day);
          
          tableData.push([
            `${day}. ${dayName}`,
            dayData.arrival || '-',
            dayData.departure || '-',
            dayData.break ? `${dayData.break} min` : '-',
            dayData.project || '-'
          ]);
        }
        
        doc.autoTable({
          startY: 30,
          head: [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka', 'Projekt']],
          body: tableData,
          theme: 'grid',
          styles: { fontSize: 9 }
        });
        
        const filename = `${employeeName}_${monthName}_${currentYear}.pdf`;
        doc.save(filename);
        
        showSaveNotification('PDF bolo exportovan√©.');
      } catch (error) {
        console.error('PDF export error:', error);
        showErrorNotification('Chyba pri exporte PDF.');
      } finally {
        setLoadingState(uiRefs.exportPDFBtn, false);
      }
    }

    async function sendPDF() {
      showWarningNotification('Funkcia odoslania PDF nie je implementovan√°. Pou≈æite export a odo≈°lite manu√°lne.');
    }

    async function createBackup() {
      if (!window.XLSX) {
        showErrorNotification('XLSX kni≈ænica nie je naƒç√≠tan√°. Sk√∫ste znova.');
        return;
      }
      
      setLoadingState(uiRefs.createBackupBtn, true, 'Vytv√°ram z√°lohu...');
      
      try {
        const monthData = collectMonthData();
        const worksheetData = [['De≈à', 'Pr√≠chod', 'Odchod', 'Prest√°vka', 'Projekt', 'Pozn√°mka']];
        
        for (let day = 1; day <= getDaysInMonth(currentMonth, currentYear); day++) {
          const dayData = monthData[day] || {};
          const dayName = getDayName(currentYear, currentMonth, day);
          
          worksheetData.push([
            `${day}. ${dayName}`,
            dayData.arrival || '',
            dayData.departure || '',
            dayData.break || '',
            dayData.project || '',
            dayData.note || ''
          ]);
        }
        
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, `${MONTH_NAMES[currentMonth]} ${currentYear}`);
        
        const monthName = MONTH_NAMES[currentMonth];
        const employeeName = appSettings.employeeName || 'Pracovnik';
        const filename = `${employeeName}_${monthName}_${currentYear}_zaloha.xlsx`;
        
        XLSX.writeFile(workbook, filename);
        
        showSaveNotification('Z√°loha bola vytvoren√°.');
      } catch (error) {
        console.error('Backup error:', error);
        showErrorNotification('Chyba pri vytv√°ran√≠ z√°lohy.');
      } finally {
        setLoadingState(uiRefs.createBackupBtn, false);
      }
    }

    async function restoreBackup() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!window.XLSX) {
          showErrorNotification('XLSX kni≈ænica nie je naƒç√≠tan√°.');
          return;
        }
        
        setLoadingState(uiRefs.restoreBackupBtn, true, 'Obnovovanie...');
        
        try {
          const reader = new FileReader();
          
          reader.onload = (event) => {
            try {
              const data = new Uint8Array(event.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
              
              const monthData = {};
              
              for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                const dayMatch = String(row[0]).match(/^(\d+)\./);
                if (!dayMatch) continue;
                
                const day = parseInt(dayMatch[1]);
                
                monthData[day] = {
                  arrival: row[1] || '',
                  departure: row[2] || '',
                  break: parseFloat(row[3]) || 0,
                  project: row[4] || '',
                  note: row[5] || ''
                };
              }
              
              const monthDocId = getMonthDocId();
              localStorage.setItem(`monthData_${monthDocId}`, JSON.stringify(monthData));
              renderMonthTable(monthData);
              
              if (currentUser && navigator.onLine) {
                saveMonthDataToFirestore(monthData, monthDocId);
              }
              
              showSaveNotification('Z√°loha bola obnoven√°.');
            } catch (error) {
              console.error('Restore error:', error);
              showErrorNotification('Chyba pri obnoven√≠ z√°lohy.');
            } finally {
              setLoadingState(uiRefs.restoreBackupBtn, false);
            }
          };
          
          reader.readAsArrayBuffer(file);
        } catch (error) {
          console.error('File read error:', error);
          showErrorNotification('Chyba pri ƒç√≠tan√≠ s√∫boru.');
          setLoadingState(uiRefs.restoreBackupBtn, false);
        }
      };
      
      input.click();
    }

    // === UTILITY FUNKCIE ===
    
    function populateMonthSelects() {
      if (uiRefs.monthSelect.options.length === 0) {
        MONTH_NAMES.forEach((name, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = name;
          uiRefs.monthSelect.appendChild(option);
        });
      }
      uiRefs.monthSelect.value = currentMonth;
      
      if (uiRefs.yearSelect.options.length === 0) {
        for (let year = currentYear - 5; year <= currentYear + 5; year++) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          uiRefs.yearSelect.appendChild(option);
        }
      }
      uiRefs.yearSelect.value = currentYear;
    }

    function updateLocalStorageIndicator() {
      const pendingCount = getPendingSyncCount();
      if (pendingCount > 0) {
        uiRefs.localStorageIndicator.textContent = `‚ö†Ô∏è ${pendingCount} mesiac(ov) ƒçak√° na synchroniz√°ciu`;
      } else {
        uiRefs.localStorageIndicator.textContent = currentUser ? '‚úÖ V≈°etko synchronizovan√©' : '';
      }
    }

    function updateUISettings() {
      uiRefs.hourlyWageInput.value = appSettings.hourlyWage;
      uiRefs.taxRateInput.value = (appSettings.taxRate * 100).toFixed(2);
      uiRefs.monthlyGoalInput.value = appSettings.monthlyEarningsGoal || '';
      uiRefs.decimalPlacesSelect.value = appSettings.decimalPlaces;
      uiRefs.employeeNameInput.value = appSettings.employeeName;
    }

    // === INICIALIZ√ÅCIA ===
    
    function initApp() {
      loadAppSettingsFromLocalStorage();
      ThemeManager.init();
      setupEventListeners();
      populateMonthSelects();
      updateSubTitle();
      updateUISettings();
      updateLocalStorageIndicator();
      
      // Auth state listener
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          uiRefs.loginFieldset.style.display = 'none';
          uiRefs.userInfo.style.display = 'flex';
          uiRefs.userEmailSpan.textContent = user.email;
          
          loadCurrentMonthData();
          
          // Sync pending months
          if (navigator.onLine) {
            syncPendingMonths();
          }
        } else {
          currentUser = null;
          uiRefs.loginFieldset.style.display = 'block';
          uiRefs.userInfo.style.display = 'none';
          
          if (currentListenerUnsubscribe) {
            currentListenerUnsubscribe();
            currentListenerUnsubscribe = null;
          }
          
          loadCurrentMonthData();
        }
        
        updateLocalStorageIndicator();
        
        // Hide loader, show app
        uiRefs.appLoader.style.display = 'none';
        uiRefs.mainContainer.style.display = 'block';
      });
      
      // Online/offline detection
      window.addEventListener('online', () => {
        showSaveNotification('Pripojenie obnoven√©. Synchronizujem...');
        if (currentUser) {
          syncPendingMonths();
          attachMonthListener();
        }
      });
      
      window.addEventListener('offline', () => {
        showWarningNotification('Ste offline. Zmeny sa ulo≈æia lok√°lne.');
      });
    }

    async function syncPendingMonths() {
      if (!currentUser || !navigator.onLine) return;
      
      const pendingMonths = getPendingSyncMonths();
      if (pendingMonths.length === 0) return;
      
      for (const monthDocId of pendingMonths) {
        const storedData = localStorage.getItem(`monthData_${monthDocId}`);
        if (storedData) {
          try {
            const monthData = JSON.parse(storedData);
            await saveMonthDataToFirestore(monthData, monthDocId);
          } catch (error) {
            console.error(`Error syncing month ${monthDocId}:`, error);
          }
        }
      }
      
      updateLocalStorageIndicator();
    }

    // Spustenie aplik√°cie
    initApp();
  </script>
</body>
</html>
