<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Pro Calculator</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="icons/favicon.ico" type="image/x-icon" /> <!-- Pridanie ikony -->
  <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- Ikona pre Apple -->

  <!-- Knižnice pre PDF a Excel (ponechané) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script> <!-- novšia verzia -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script> <!-- novšia verzia -->

  <!-- Ikony (príklad: Font Awesome - pridajte odkaz alebo SVG) -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"> -->

  <!-- CSS (odporúčané presunúť do externého súboru style.css) -->
  <style>
    :root {
      --primary-bg: #f8f9fa; /* Svetlejšia šedá */
      --secondary-bg: #ffffff;
      --text-color: #212529; /* Tmavšia textová */
      --muted-text-color: #6c757d; /* Šedá pre menej dôležitý text */
      --input-bg: #ffffff;
      --input-border: #ced4da;
      --input-focus-border: #86b7fe;
      --input-focus-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      --table-border: #dee2e6;
      --header-bg: #e9ecef; /* Jemnejšia hlavička */
      --button-primary-bg: #0d6efd; /* Bootstrap modrá */
      --button-primary-hover: #0b5ed7;
      --button-secondary-bg: #6c757d; /* Bootstrap šedá */
      --button-secondary-hover: #5c636a;
      --button-success-bg: #198754; /* Bootstrap zelená */
      --button-success-hover: #157347;
      --button-danger-bg: #dc3545; /* Bootstrap červená */
      --button-danger-hover: #bb2d3b;
      --button-warning-bg: #ffc107; /* Bootstrap žltá */
      --button-warning-hover: #ffca2c;
      --button-info-bg: #0dcaf0; /* Bootstrap tyrkysová */
      --button-info-hover: #31d2f2;
      --highlight-bg: #cfe2ff; /* Jemné zvýraznenie */
      --total-bg: #f8f9fa;
      --notification-success-bg: #d1e7dd;
      --notification-success-text: #0f5132;
      --notification-error-bg: #f8d7da;
      --notification-error-text: #842029;
      --notification-info-bg: #cff4fc;
      --notification-info-text: #055160;
      --current-day-bg: #cfe2ff; /* Svetlo modrá pre aktuálny deň */
      --current-day-border: #9ec5fe;
      --overtime-color: #dc3545;

      --border-radius: 0.375rem; /* Bootstrap zaoblenie */
      --spacing-unit: 1rem;
    }

    /* --- Tmavý režim premenné --- */
    body.dark-mode {
       --primary-bg: #212529;
       --secondary-bg: #343a40;
       --text-color: #f8f9fa;
       --muted-text-color: #adb5bd;
       --input-bg: #495057;
       --input-border: #6c757d;
       --input-focus-border: #6ea8fe;
       --input-focus-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Môže zostať rovnaké */
       --table-border: #495057;
       --header-bg: #495057;
       --button-primary-bg: #0d6efd;
       --button-primary-hover: #3b82f6;
       --button-secondary-bg: #6c757d;
       --button-secondary-hover: #7f888f;
       --button-success-bg: #198754;
       --button-success-hover: #2ea36a;
       --button-danger-bg: #dc3545;
       --button-danger-hover: #e55a67;
       --button-warning-bg: #ffc107;
       --button-warning-hover: #ffcd39;
       --button-info-bg: #0dcaf0;
       --button-info-hover: #4ad7f2;
       --highlight-bg: #3b4147;
       --total-bg: #343a40;
       --notification-success-bg: #0f5132;
       --notification-success-text: #d1e7dd;
       --notification-error-bg: #842029;
       --notification-error-text: #f8d7da;
       --notification-info-bg: #055160;
       --notification-info-text: #cff4fc;
       --current-day-bg: #0d6efd;
       --current-day-border: #0a58ca;
       --overtime-color: #f38ba8; /* Catppuccin red pre tmavý režim */
    }

    /* --- Základné štýly --- */
    *, *::before, *::after { box-sizing: border-box; }
    html { font-size: 16px; } /* Základ pre rem */
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      line-height: 1.5;
      margin: 0;
      padding: 0; /* Padding na container */
      background-color: var(--primary-bg);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 1320px; /* Širší kontajner */
      margin: var(--spacing-unit) auto;
      background: var(--secondary-bg);
      padding: calc(var(--spacing-unit) * 1.5);
      border-radius: var(--border-radius);
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2rem; /* Trochu menšie */
      font-weight: 500; /* Menej tučné */
      margin-bottom: 0.5rem;
      color: var(--text-color); /* Normálna farba, gradient je príliš rušivý */
      /* Gradient odstránený pre čistejší vzhľad */
    }
    h2 {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--muted-text-color);
      margin-top: 0;
      margin-bottom: 1.5rem;
    }

    /* --- Settings Panel --- */
    .settings-panel {
      background-color: var(--primary-bg);
      border: 1px solid var(--table-border);
      border-radius: var(--border-radius);
      padding: var(--spacing-unit);
      margin-bottom: 1.5rem;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-bottom: var(--spacing-unit); /* Pridaný margin ak je rozbalený */
    }
    .settings-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .settings-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-unit);
      max-height: 0; /* Skryté defaultne */
      overflow: hidden;
      transition: max-height 0.5s ease-out;
    }
    .settings-panel.open .settings-content {
       max-height: 1000px; /* Dostatočne veľké na obsah */
    }
    .settings-panel label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .settings-panel input, .settings-panel select {
      width: 100%;
    }
    .toggle-icon::before { content: '▼'; /* Šípka dole */ display: inline-block; margin-left: 0.5rem; }
    .settings-panel.open .toggle-icon::before { content: '▲'; /* Šípka hore */ }

    /* --- Navigácia Mesiac/Rok --- */
    .navigation {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 0.5rem;
    }
    .navigation button {
        padding: 0.3rem 0.6rem;
        font-size: 1rem;
        line-height: 1; /* Pre zarovnanie */
        flex-shrink: 0; /* Aby sa neskracovali */
    }
    .navigation select {
        padding: 0.4rem 0.8rem;
        font-size: 1rem;
        max-width: 150px; /* Obmedzenie šírky */
    }

    /* --- Tabuľka --- */
    .table-container { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      min-width: 1000px; /* Pre rolovanie na menších obrazovkách */
      font-size: 0.875rem; /* Menšie písmo v tabuľke */
    }
    th, td {
      padding: 0.6rem 0.5rem; /* Upravený padding */
      border: 1px solid var(--table-border);
      text-align: left;
      vertical-align: top; /* Zarovnanie navrch pre poznámky */
    }
    th {
      background-color: var(--header-bg);
      font-weight: 500;
      white-space: nowrap;
    }
    td {
      transition: background-color 0.3s;
    }
    /* Špecifické šírky stĺpcov */
    th:nth-child(1), td:nth-child(1) { width: 8%; } /* Deň */
    th:nth-child(2), td:nth-child(2) { width: 10%; } /* Príchod */
    th:nth-child(3), td:nth-child(3) { width: 10%; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 8%; text-align: right; } /* Prestávka */
    th:nth-child(5), td:nth-child(5) { width: 10%; } /* Odpracované */
    th:nth-child(6), td:nth-child(6) { width: 12%; text-align: right;} /* Hrubá Mzda */
    th:nth-child(7), td:nth-child(7) { width: 12%; text-align: right;} /* Čistá Mzda */
    th:nth-child(8), td:nth-child(8) { width: 20%; } /* Poznámky */
    th:nth-child(9), td:nth-child(9) { width: 10%; text-align: center;} /* Akcie */

    /* --- Formulárové prvky --- */
    input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="time"], select, textarea {
      display: block;
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: var(--text-color);
      background-color: var(--input-bg);
      background-clip: padding-box;
      border: 1px solid var(--input-border);
      appearance: none; /* Odstránenie default štýlovania */
      border-radius: var(--border-radius);
      transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out, background-color 0.3s, color 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--input-focus-border);
      outline: 0;
      box-shadow: var(--input-focus-shadow);
    }
    input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(var(--dark-mode-invert, 0)); /* Invert ikony v tmavom režime */
    }
    body.dark-mode { --dark-mode-invert: 1; }
    input[readonly] {
        background-color: var(--header-bg); /* Lepšie ako transparentné */
        opacity: 0.7;
    }
    input.currency { text-align: right; }
    textarea {
        min-height: 60px; /* Pre poznámky */
        resize: vertical;
        font-size: 0.875rem;
    }
    input:invalid {
        border-color: var(--button-danger-bg);
    }
    .validation-error {
        color: var(--button-danger-bg);
        font-size: 0.8rem;
        margin-top: 0.1rem;
    }

    /* --- Tlačidlá --- */
    .btn {
      display: inline-flex; /* Pre ikonky */
      align-items: center;
      justify-content: center;
      gap: 0.5rem; /* Medzera medzi ikonou a textom */
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      text-align: center;
      text-decoration: none;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      border: 1px solid transparent;
      border-radius: var(--border-radius);
      transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
      white-space: nowrap; /* Aby sa text nezalamoval */
    }
    .btn:disabled { cursor: not-allowed; opacity: 0.65; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; border-radius: 0.25rem; }
    .btn-primary { background-color: var(--button-primary-bg); color: #fff; }
    .btn-primary:hover { background-color: var(--button-primary-hover); }
    .btn-secondary { background-color: var(--button-secondary-bg); color: #fff; }
    .btn-secondary:hover { background-color: var(--button-secondary-hover); }
    .btn-success { background-color: var(--button-success-bg); color: #fff; }
    .btn-success:hover { background-color: var(--button-success-hover); }
    .btn-danger { background-color: var(--button-danger-bg); color: #fff; }
    .btn-danger:hover { background-color: var(--button-danger-hover); }
    .btn-warning { background-color: var(--button-warning-bg); color: #000; }
    .btn-warning:hover { background-color: var(--button-warning-hover); }
    .btn-info { background-color: var(--button-info-bg); color: #000; }
    .btn-info:hover { background-color: var(--button-info-hover); }
    .btn-light { background-color: var(--primary-bg); color: var(--text-color); border-color: var(--input-border); }
    .btn-light:hover { background-color: var(--header-bg); }

    .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem; margin-top: 1.5rem; }

    /* --- Aktuálny deň --- */
    .current-day {
        background-color: var(--current-day-bg);
        border-left: 3px solid var(--current-day-border);
    }
    .current-day input, .current-day select, .current-day textarea {
        border-color: var(--current-day-border); /* Jemnejšie zvýraznenie */
    }

    /* --- Súčty --- */
    .totals-section {
      background-color: var(--total-bg);
      border: 1px solid var(--table-border);
      border-radius: var(--border-radius);
      padding: var(--spacing-unit);
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--spacing-unit);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .total-item { text-align: center; }
    .total-item .label {
      display: block;
      font-size: 0.875rem;
      color: var(--muted-text-color);
      margin-bottom: 0.25rem;
    }
    .total-item .value {
      font-size: 1.1rem;
      font-weight: 500;
    }
    .total-item .value.overtime { color: var(--overtime-color); }

    /* --- Notifikácie --- */
    .notification {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      padding: 0.75rem 1.25rem;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.1);
      z-index: 1050; /* Nad ostatnými prvkami */
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
    }
    .notification.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #saveNotification { background-color: var(--notification-success-bg); color: var(--notification-success-text); border: 1px solid darken(var(--notification-success-bg), 10%); }
    #errorNotification { background-color: var(--notification-error-bg); color: var(--notification-error-text); border: 1px solid darken(var(--notification-error-bg), 10%); }
    #statusNotification { background-color: var(--notification-info-bg); color: var(--notification-info-text); border: 1px solid darken(var(--notification-info-bg), 10%); top: 1rem; bottom: auto; }

    /* --- Auth UI --- */
    .auth-section { text-align: center; margin-bottom: 1.5rem; }
    #login-form { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; max-width: 350px; margin: auto; }
    #login-form input { width: 100%; }
    #login-form .btn-group { margin-top: 0.5rem; } /* Menší margin v login forme */
    #user-info { display: flex; align-items: center; justify-content: center; gap: 1rem; }
    #user-email { font-weight: 500; }
    .hidden { display: none !important; } /* Ponechané */

    /* --- Responzivita --- */
    @media (max-width: 768px) {
      html { font-size: 15px; }
      .container { margin: 0.5rem; padding: 1rem; }
      h1 { font-size: 1.8rem; }
      h2 { font-size: 1.1rem; margin-bottom: 1rem; }
      .settings-content { grid-template-columns: 1fr; } /* Nastavenia pod sebou */
      table { min-width: 800px; font-size: 0.8rem; } /* Zachované rolovanie, menšie písmo */
      th, td { padding: 0.5rem 0.4rem; }
      .btn-group { flex-direction: column; align-items: stretch; }
      .totals-section { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .total-item .value { font-size: 1rem; }
      .navigation select { max-width: 120px; }
    }
     @media (max-width: 480px) {
        html { font-size: 14px; }
        .container { border-radius: 0; margin: 0; padding: 0.75rem; }
        h1 { font-size: 1.6rem; }
        h2 { font-size: 1rem; }
        th, td { padding: 0.4rem 0.3rem; }
        table { font-size: 0.75rem; }
        .navigation { flex-wrap: wrap; } /* Zalamovanie navigácie */
     }

     /* --- Pomocné triedy --- */
     .text-danger { color: var(--overtime-color); } /* Pre nadčasy */
     .text-muted { color: var(--muted-text-color); }
     .fw-bold { font-weight: bold; }
     .d-none { display: none; } /* Bootstrap-like */
     .d-block { display: block; }
     .mt-1 { margin-top: 0.25rem; }
     .mt-2 { margin-top: 0.5rem; }
     .mb-1 { margin-bottom: 0.25rem; }
     .mb-2 { margin-bottom: 0.5rem; }
     .p-1 { padding: 0.25rem; }

  </style>
</head>
<body>
  <div class="container">
    <!-- Auth -->
    <div id="auth-container" class="auth-section">
      <div id="login-form" class="hidden">
        <input type="email" id="email" placeholder="Email" autocomplete="email" aria-label="Email">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password" aria-label="Heslo">
        <div class="btn-group">
            <button class="btn btn-primary" onclick="login()">Prihlásiť sa</button>
            <button class="btn btn-secondary" onclick="register()">Registrovať</button>
        </div>
      </div>
      <div id="user-info" class="hidden">
        <span id="user-email"></span>
        <button class="btn btn-danger btn-sm" onclick="logout()" title="Odhlásiť sa">Odhlásiť</button>
      </div>
    </div>

    <h1>Výkaz Práce Pro</h1>
    <h2 id="employeeSubtitle"></h2>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header" onclick="toggleSettings()">
            <h3>Nastavenia</h3>
            <span class="toggle-icon" aria-hidden="true"></span>
            <button class="btn btn-light btn-sm" onclick="toggleDarkMode(); event.stopPropagation();" title="Prepínač tmavého režimu">Režim</button> <!-- Presunutý sem -->
        </div>
        <div class="settings-content">
            <div>
              <label for="employeeNameInput">Meno pracovníka:</label>
              <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
            </div>
            <div>
              <label for="hourlyWageInput">Hodinová mzda (€):</label>
              <input type="number" id="hourlyWageInput" value="10" min="0" step="0.01" oninput="updateSettings()">
            </div>
            <div>
              <label for="taxRateInput">Daňové percento (%):</label>
              <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()">
            </div>
            <div>
              <label for="standardHoursInput">Denná norma (hod.):</label>
              <input type="number" id="standardHoursInput" value="8" min="0" max="24" step="0.5" oninput="updateSettings()" title="Štandardný počet hodín denne pre výpočet nadčasov">
            </div>
            <div>
              <label for="decimalPlacesSelect">Desatinné miesta:</label>
              <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
              </select>
            </div>
            <!-- Prázdny div pre zarovnanie, ak je nepárny počet -->
            <div></div>
        </div>
    </div>

     <!-- Navigácia Mesiac/Rok -->
    <div class="navigation">
        <button class="btn btn-secondary btn-sm" onclick="changeMonthRelative(-1)" title="Predchádzajúci mesiac"><</button>
        <select id="monthSelect" onchange="changeMonthAbsolute()" aria-label="Vyberte mesiac"></select>
        <select id="yearSelect" onchange="changeYear()" aria-label="Vyberte rok"></select>
        <button class="btn btn-secondary btn-sm" onclick="changeMonthRelative(1)" title="Nasledujúci mesiac">></button>
        <button class="btn btn-primary btn-sm" onclick="goToCurrentMonth()" title="Prejsť na aktuálny mesiac">Aktuálny</button>
    </div>


    <!-- Tabuľka -->
    <div class="table-container">
      <table aria-live="polite" aria-relevant="all"> <!-- ARIA pre screen readery -->
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá (€)</th>
            <th>Čistá (€)</th>
            <th>Poznámky</th>
            <th>Akcie</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Dynamicky generované -->
        </tbody>
      </table>
    </div>

    <!-- Súčty -->
    <div class="totals-section" id="totalSalary">
        <!-- Dynamicky generované -->
         <div class="total-item"><span class="label">Načítavam súčty...</span><span class="value"></span></div>
    </div>

    <!-- Tlačidlá Akcií -->
    <div class="btn-group">
      <button class="btn btn-success" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button> <!-- Príklad ikony -->
      <button class="btn btn-success" onclick="sendPDF()"><i class="fas fa-share-square"></i> Odoslať PDF</button>
      <button class="btn btn-info" onclick="createBackup()"><i class="fas fa-file-excel"></i> Vytvoriť Zálohu (.xlsx)</button>
      <button class="btn btn-warning" onclick="restoreBackup()"><i class="fas fa-upload"></i> Obnoviť zo Zálohy (.xlsx)</button>
      <button id="loadFirebaseBtn" class="btn btn-primary" onclick="loadFromFirestore()" disabled><i class="fas fa-cloud-download-alt"></i> Načítať z Cloudu</button>
      <button id="syncFirebaseBtn" class="btn btn-primary" onclick="syncWithFirebase()" disabled><i class="fas fa-sync-alt"></i> Synchronizovať</button>
    </div>
  </div>

  <!-- Notifikácie -->
  <div id="saveNotification" class="notification" role="status" aria-live="polite"></div>
  <div id="errorNotification" class="notification" role="alert" aria-live="assertive"></div>
  <div id="statusNotification" class="notification" role="status" aria-live="polite"></div>

  <!-- Firebase a Hlavný Skript -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // DÔLEŽITÉ: Zabezpečte Firestore pravidlá na strane servera!
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.appspot.com",
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    let app, auth, db, appCheck;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
            isTokenAutoRefreshEnabled: true
        });
    } catch (error) {
        console.error("Chyba inicializácie Firebase:", error);
        showErrorNotification("Nepodarilo sa pripojiť k backend službám.", 10000);
    }


    // -------------------- KONŠTANTY a POMOCNÉ OBJEKTY --------------------
    const LS_KEYS = {
        DARK_MODE: 'darkMode', SETTINGS: 'appSettings',
        WORK_DATA_PREFIX: 'workData-', PENDING_SYNC_PREFIX: 'pendingSync-'
    };
    const CSS_CLASSES = { DARK_MODE: 'dark-mode', HIDDEN: 'hidden', CURRENT_DAY: 'current-day', NOTIFICATION_SHOW: 'show', SETTINGS_OPEN: 'open' };
    const MONTH_NAMES = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
    const DAYS_OF_WEEK = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"];
    const DEBOUNCE_DELAY = 1500; // ms pre ukladanie
    const CURRENCY_FORMATTER = new Intl.NumberFormat('sk-SK', { style: 'currency', currency: 'EUR' });

    // -------------------- DOM Elementy (získané raz) --------------------
    const Elements = {
        body: document.body,
        workDaysTbody: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        employeeSubtitle: document.getElementById('employeeSubtitle'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        standardHoursInput: document.getElementById('standardHoursInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        settingsPanel: document.getElementById('settingsPanel'),
        saveNotification: document.getElementById('saveNotification'),
        errorNotification: document.getElementById('errorNotification'),
        statusNotification: document.getElementById('statusNotification'),
        loginForm: document.getElementById('login-form'),
        userInfo: document.getElementById('user-info'),
        userEmailSpan: document.getElementById('user-email'),
        emailInput: document.getElementById('email'),
        passwordInput: document.getElementById('password'),
        loadFirebaseBtn: document.getElementById('loadFirebaseBtn'),
        syncFirebaseBtn: document.getElementById('syncFirebaseBtn')
    };

    // -------------------- GLOBÁLNY STAV APLIKÁCIE --------------------
    let state = {
        currentUser: null,
        currentDate: new Date(),
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear(),
        settings: { // Default nastavenia
            employeeName: '',
            hourlyWage: 10.00,
            taxRate: 0.02, // 2%
            standardHours: 8.0,
            decimalPlaces: 2
        },
        monthData: { // Cache pre načítané dáta { 'YYYY-M': { data: [...], ... } }
            // data: [{ start: '', end: '', breakTime: '', notes: '', calculated: { workedDec: 0, gross: 0, net: 0, overtimeDec: 0 } }]
        },
        isSaving: false,
        saveDebounceTimer: null,
        isOnline: navigator.onLine,
        isSettingsOpen: false
    };

    // ==================== INICIALIZÁCIA APLIKÁCIE ====================

    function initializeAppCore() {
        loadSettings(); // Načíta nastavenia z LS
        initializeUI();   // Nastaví UI prvky (selecty, dark mode...)
        setupEventListeners(); // Nastaví globálne listenery

        // Prvotné zobrazenie tabuľky a dát
        refreshDataAndView();

        // Firebase Auth listener
        if (auth) {
            onAuthStateChanged(auth, handleAuthStateChange);
        } else {
            // Ak Firebase zlyhalo, appka beží len lokálne
             updateAuthUI(); // Zobrazí login ako nedostupný?
        }
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem(LS_KEYS.SETTINGS);
        if (savedSettings) {
            try {
                const parsed = JSON.parse(savedSettings);
                // Zlúči uložené s defaultnými, aby nechýbali nové kľúče
                state.settings = { ...state.settings, ...parsed };
                // Zabezpečíme správne typy
                state.settings.hourlyWage = parseFloat(state.settings.hourlyWage) || 10.0;
                state.settings.taxRate = parseFloat(state.settings.taxRate) || 0.02;
                state.settings.standardHours = parseFloat(state.settings.standardHours) || 8.0;
                state.settings.decimalPlaces = parseInt(state.settings.decimalPlaces) || 2;
            } catch (e) { console.error("Chyba pri parsovaní uložených nastavení", e); }
        }
        // Aplikuje načítané/default nastavenia do UI
        applySettingsToUI();
    }

    function saveSettings() {
        try {
            localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(state.settings));
        } catch (e) {
            console.error("Chyba pri ukladaní nastavení do Local Storage:", e);
            showErrorNotification("Nepodarilo sa uložiť nastavenia lokálne.");
        }
    }

    function applySettingsToUI() {
        Elements.employeeNameInput.value = state.settings.employeeName;
        Elements.hourlyWageInput.value = state.settings.hourlyWage.toFixed(2); // Vždy 2 miesta pre mzdu
        Elements.taxRateInput.value = (state.settings.taxRate * 100).toFixed(1);
        Elements.standardHoursInput.value = state.settings.standardHours.toFixed(1);
        Elements.decimalPlacesSelect.value = state.settings.decimalPlaces;
        updateEmployeeSubtitle();
    }

    function initializeUI() {
        // Tmavý režim
        if (localStorage.getItem(LS_KEYS.DARK_MODE) === 'true') {
            Elements.body.classList.add(CSS_CLASSES.DARK_MODE);
        }
        // Výber mesiacov
        MONTH_NAMES.forEach((name, index) => {
            Elements.monthSelect.add(new Option(name, index));
        });
        // Výber rokov
        populateYearSelect();

        // Nastavenie aktuálnych hodnôt v selectoch
        Elements.monthSelect.value = state.currentMonth;
        Elements.yearSelect.value = state.currentYear;

        // Nastavenie panelu nastavení
        Elements.settingsPanel.classList.toggle(CSS_CLASSES.SETTINGS_OPEN, state.isSettingsOpen);

        // Zobrazenie meny (€) pri mzde
        const wageLabel = document.querySelector('label[for="hourlyWageInput"]');
        if (wageLabel && !wageLabel.textContent.includes('€')) { // Aby sa nepridávalo viackrát
             wageLabel.textContent += ' (€)';
        }
    }

    function populateYearSelect() {
      const currentYear = new Date().getFullYear();
      const startYear = currentYear - 5; // 5 rokov dozadu
      const endYear = currentYear + 5;   // 5 rokov dopredu
      Elements.yearSelect.innerHTML = ''; // Vyčistiť pred naplnením
      for (let year = startYear; year <= endYear; year++) {
        Elements.yearSelect.add(new Option(year, year));
      }
      Elements.yearSelect.value = state.currentYear; // Nastaví aktuálny rok
    }

    function setupEventListeners() {
        window.addEventListener('online', () => handleOnlineStatus(true));
        window.addEventListener('offline', () => handleOnlineStatus(false));
        handleOnlineStatus(state.isOnline); // Skontroluj status pri štarte

        // Delegovanie eventov pre tabuľku pre lepší výkon
        Elements.workDaysTbody.addEventListener('input', handleTableInput);
        Elements.workDaysTbody.addEventListener('change', handleTableChange); // Pre time input a textarea
        Elements.workDaysTbody.addEventListener('click', handleTableClick);
    }

     // ==================== SPRÁVA STAVU ONLINE/OFFLINE ====================

    function handleOnlineStatus(isOnline) {
        state.isOnline = isOnline;
        console.log(`Stav pripojenia: ${isOnline ? 'Online' : 'Offline'}`);
        showStatusNotification(isOnline ? 'Pripojené' : 'Offline', isOnline ? 'info' : 'warning');
        updateFirebaseButtonStates(); // Aktualizuje stav tlačidiel pre cloud
        if (isOnline) {
            syncWithFirebase(); // Skúsi synchronizovať čakajúce dáta
        }
    }

    function showNotification(element, message, type = 'info', duration = 3000) {
        let bgColorVar, textColorVar;
        switch(type) {
            case 'success': bgColorVar = '--notification-success-bg'; textColorVar = '--notification-success-text'; break;
            case 'error': bgColorVar = '--notification-error-bg'; textColorVar = '--notification-error-text'; break;
            default: bgColorVar = '--notification-info-bg'; textColorVar = '--notification-info-text'; break;
        }
        element.style.backgroundColor = `var(${bgColorVar})`;
        element.style.color = `var(${textColorVar})`;
        element.textContent = message;
        element.classList.add(CSS_CLASSES.NOTIFICATION_SHOW);
        // Automatické skrytie
        setTimeout(() => {
            element.classList.remove(CSS_CLASSES.NOTIFICATION_SHOW);
        }, duration);
    }
    const showErrorNotification = (msg, duration=4000) => showNotification(Elements.errorNotification, msg, 'error', duration);
    const showSaveNotification = (msg = 'Dáta uložené.') => showNotification(Elements.saveNotification, msg, 'success', 2000);
    const showStatusNotification = (msg, type='info') => showNotification(Elements.statusNotification, msg, type, 5000);


    // ==================== AUTENTIFIKÁCIA ====================

    function handleAuthStateChange(user) {
        console.log('Auth state changed. User:', user ? user.uid : 'None');
        state.currentUser = user;
        updateAuthUI();
        updateFirebaseButtonStates();
        // Po zmene prihlásenia vždy obnovíme pohľad a dáta pre aktuálny mesiac
        refreshDataAndView();
    }

    function updateAuthUI() {
        const user = state.currentUser;
        Elements.loginForm.classList.toggle(CSS_CLASSES.HIDDEN, !!user);
        Elements.userInfo.classList.toggle(CSS_CLASSES.HIDDEN, !user);
        if (user) {
            Elements.userEmailSpan.textContent = user.email;
        } else {
            Elements.userEmailSpan.textContent = '';
            Elements.emailInput.value = '';
            Elements.passwordInput.value = '';
        }
    }

    function updateFirebaseButtonStates() {
        const canUseFirebase = state.currentUser && state.isOnline && db; // Musí byť prihlásený, online a DB inicializované
        Elements.loadFirebaseBtn.disabled = !canUseFirebase;
        Elements.syncFirebaseBtn.disabled = !canUseFirebase;
    }

    // Funkcie login, register, logout - priradené k window pre onclick
    window.login = async function() {
      if (!state.isOnline || !auth) return showErrorNotification('Prihlásenie nie je možné (offline alebo chyba inicializácie).');
      const email = Elements.emailInput.value;
      const password = Elements.passwordInput.value;
      if (!email || !password) return showErrorNotification('Zadajte email aj heslo.');
      try {
        // Spinner/loading state?
        await signInWithEmailAndPassword(auth, email, password);
        // handleAuthStateChange sa postará o zvyšok
      } catch (error) { showErrorNotification(`Chyba prihlásenia: ${mapAuthError(error.code)}`); }
    }
    window.register = async function() {
      if (!state.isOnline || !auth) return showErrorNotification('Registrácia nie je možná (offline alebo chyba inicializácie).');
      const email = Elements.emailInput.value;
      const password = Elements.passwordInput.value;
      if (!email || !password) return showErrorNotification('Zadajte email aj heslo.');
      if (password.length < 6) return showErrorNotification('Heslo musí mať aspoň 6 znakov.');
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await createUserCollection(userCredential.user); // Vytvorí štruktúru v DB
        // handleAuthStateChange sa postará o zvyšok
      } catch (error) { showErrorNotification(`Chyba registrácie: ${mapAuthError(error.code)}`); }
    }
    window.logout = async function() {
      if (!auth) return;
      try { await signOut(auth); }
      catch (error) { showErrorNotification('Chyba pri odhlásení.'); }
    }
    async function createUserCollection(user) { /* ... (ako predtým) ... */ }
    function mapAuthError(errorCode) { /* ... (ako predtým) ... */ }


    // ==================== SPRÁVA DÁT (Načítanie, Ukladanie, Synchronizácia) ====================

    function getMonthDataKey(year, month) { return `${year}-${month}`; }
    function getCurrentMonthDataKey() { return getMonthDataKey(state.currentYear, state.currentMonth); }
    function getLocalStorageKey(prefix) { return `${prefix}${getCurrentMonthDataKey()}`; }

    // Hlavná funkcia na obnovenie dát a pohľadu
    async function refreshDataAndView() {
        console.log(`Obnovujem pohľad pre ${getMonthName(state.currentMonth)} ${state.currentYear}`);
        updateNavigationUI(); // Aktualizuje selecty mesiac/rok
        createTableStructure(); // Vytvorí prázdnu štruktúru tabuľky
        await loadDataForCurrentMonth(); // Načíta dáta (LS/Cache/Firestore) a aplikuje ich
    }

    function updateNavigationUI() {
         Elements.monthSelect.value = state.currentMonth;
         Elements.yearSelect.value = state.currentYear;
    }

    // Načítanie dát pre aktuálne zvolený mesiac/rok
    async function loadDataForCurrentMonth() {
        const dataKey = getCurrentMonthDataKey();
        const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
        const localDataString = localStorage.getItem(localKey);
        const pendingSyncKey = getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX);
        const hasPendingSync = localStorage.getItem(pendingSyncKey) !== null;

        // 1. Skús Cache v pamäti
        if (state.monthData[dataKey]) {
            console.log('Načítavam údaje z cache pamäte.');
            applyDataToTable(state.monthData[dataKey]);
            calculateAllTotals();
            return;
        }

        // 2. Skús Local Storage
        if (localDataString) {
            console.log('Načítavam údaje z Local Storage.');
            try {
                const parsedData = JSON.parse(localDataString);
                state.monthData[dataKey] = parsedData; // Ulož do cache
                applyDataToTable(parsedData);
                calculateAllTotals();
                // Skontroluj synchronizáciu na pozadí
                if (hasPendingSync && state.isOnline && state.currentUser) { syncWithFirebase(); }
                return;
            } catch (e) { console.error("Chyba parsovania dát z Local Storage:", e); localStorage.removeItem(localKey); /* Odstráni poškodené dáta */ }
        }

        // 3. Skús Firestore (ak online a prihlásený)
        if (state.isOnline && state.currentUser && db) {
            console.log('Local Storage prázdny, načítavam z Firestore.');
            try {
                const userRef = doc(db, 'users', state.currentUser.uid);
                const docRef = doc(userRef, 'workDays', dataKey);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    console.log('Dáta nájdené vo Firestore, aplikujem a ukladám lokálne.');
                    state.monthData[dataKey] = cloudData; // Ulož do cache
                    localStorage.setItem(localKey, JSON.stringify(cloudData)); // Ulož do LS
                    applyDataToTable(cloudData);
                    calculateAllTotals();
                } else {
                    console.log('Žiadne údaje vo Firestore pre tento mesiac.');
                    initializeEmptyMonthData(dataKey); // Vytvor prázdnu štruktúru v cache
                    applyDataToTable(state.monthData[dataKey]); // Aplikuj prázdne dáta
                    calculateAllTotals(); // Vypočíta nuly
                }
                return;
            } catch (error) {
                console.error('Chyba pri načítavaní z Firestore:', error);
                showErrorNotification('Chyba pri načítavaní dát z cloudu.');
                // Pokračuj s prázdnymi dátami
            }
        }

        // 4. Ak všetko zlyhalo, inicializuj prázdne dáta
        console.log('Žiadne lokálne ani cloudové dáta (alebo offline/neprihlásený). Inicializujem prázdny mesiac.');
        initializeEmptyMonthData(dataKey);
        applyDataToTable(state.monthData[dataKey]);
        calculateAllTotals();
    }

    // Inicializuje štruktúru dát pre mesiac, ak žiadne neexistujú
    function initializeEmptyMonthData(dataKey) {
        const days = getDaysInMonth(state.currentMonth, state.currentYear);
        const emptyDayData = Array(days).fill(null).map(() => ({
             start: '', end: '', breakTime: '', notes: '',
             calculated: { workedDec: 0, gross: 0, net: 0, overtimeDec: 0 }
        }));
        state.monthData[dataKey] = { data: emptyDayData };
        // Neukladáme prázdne dáta do LS ani FS hneď, až pri prvej zmene
    }

    // Aplikuje načítané dáta (z cache, LS, FS) do tabuľky v UI
    function applyDataToTable(monthDataObject) {
        if (!monthDataObject || !monthDataObject.data) {
            console.warn("Pokus o aplikovanie neplatných dát do tabuľky.");
            return;
        }
        monthDataObject.data.forEach((dayData, index) => {
            const day = index + 1;
            const startEl = document.getElementById(getInputId('start', day));
            const endEl = document.getElementById(getInputId('end', day));
            const breakEl = document.getElementById(getInputId('break', day));
            const notesEl = document.getElementById(getInputId('notes', day));
            // Ostatné (vypočítané) polia sa naplnia cez calculateRowLogic

            if (startEl) startEl.value = dayData.start || '';
            if (endEl) endEl.value = dayData.end || '';
            if (breakEl) breakEl.value = dayData.breakTime || '';
            if (notesEl) notesEl.value = dayData.notes || '';

            // Vypočítame logiku pre riadok (bez spustenia ukladania)
            calculateRowLogic(day);
        });
        // Po aplikovaní všetkých riadkov prepočítame celkové súčty
        calculateAllTotals();
    }

    // Funkcia pre manuálne načítanie z Firestore (tlačidlo)
    window.loadFromFirestore = async function() {
        if (!state.currentUser) return showErrorNotification('Pre načítanie z cloudu sa musíte prihlásiť.');
        if (!state.isOnline || !db) return showErrorNotification('Načítanie z cloudu vyžaduje pripojenie a funkčný backend.');

        if (!confirm('Naozaj chcete načítať dáta z cloudu? Prepíšu sa tým všetky aktuálne zmeny pre tento mesiac.')) return;

        const dataKey = getCurrentMonthDataKey();
        console.log(`Manuálne načítanie z Firestore pre ${dataKey}`);
        try {
            // Zobraziť loading state
            const userRef = doc(db, 'users', state.currentUser.uid);
            const docRef = doc(userRef, 'workDays', dataKey);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
                localStorage.setItem(localKey, JSON.stringify(cloudData)); // Uložíme do LS
                localStorage.removeItem(getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX)); // Odstránime pending flag

                state.monthData[dataKey] = cloudData; // Aktualizujeme cache
                applyDataToTable(cloudData); // Aplikujeme do UI
                calculateAllTotals(); // Prepočítame súčty
                showSaveNotification('Dáta boli úspešne načítané z cloudu.');
            } else {
                showErrorNotification('Pre tento mesiac neboli v cloude nájdené žiadne dáta.');
                // Možnosť: vymazať lokálne dáta? Alebo nechať? Zatiaľ necháme.
            }
        } catch (error) {
            console.error('Chyba pri manuálnom načítavaní z Firestore:', error);
            showErrorNotification('Chyba pri načítavaní dát z cloudu.');
        } finally {
            // Skryť loading state
        }
    }

    // --- Ukladanie dát ---

    // Spúšťa sa po akejkoľvek relevantnej zmene v UI (input, nastavenie)
    function handleDataChange(day = null) {
        // 1. Ak je známy deň, prepočítaj logiku len pre ten riadok
        if (day !== null) {
            calculateRowLogic(day);
        }
        // 2. Prepočítaj všetky celkové súčty
        calculateAllTotals();
        // 3. Naplánuj uloženie dát (debounced)
        scheduleSaveData();
    }

    // Zozbiera aktuálne dáta z UI a stavu pre uloženie
    function collectCurrentDataForSaving() {
        const dataKey = getCurrentMonthDataKey();
        // Ak dáta pre tento mesiac ešte neboli inicializované, urob to teraz
        if (!state.monthData[dataKey]) {
             initializeEmptyMonthData(dataKey);
        }
        const currentMonthState = state.monthData[dataKey];
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);

        // Aktualizuj 'data' pole v cache priamo z UI
        for (let day = 1; day <= daysInMonth; day++) {
             if (!currentMonthState.data[day-1]) { // Ak by chýbal záznam dňa
                  currentMonthState.data[day-1] = { start: '', end: '', breakTime: '', notes: '', calculated: {} };
             }
             const dayState = currentMonthState.data[day-1];
             dayState.start = document.getElementById(getInputId('start', day))?.value || '';
             dayState.end = document.getElementById(getInputId('end', day))?.value || '';
             dayState.breakTime = document.getElementById(getInputId('break', day))?.value || '';
             dayState.notes = document.getElementById(getInputId('notes', day))?.value || '';
             // 'calculated' sa aktualizuje v calculateRowLogic, ktorá beží pred týmto
        }

        // Vráť celý objekt pre daný mesiac (ktorý teraz obsahuje aktuálne dáta)
        // Pridaj aj metadáta o nastaveniach platných v čase uloženia
         return {
             ...currentMonthState, // Obsahuje pole 'data' s aktuálnymi hodnotami
             savedSettings: { ...state.settings }, // Kópia nastavení
             lastUpdated: new Date().toISOString()
         };
    }

     function scheduleSaveData() {
        clearTimeout(state.saveDebounceTimer);
        state.saveDebounceTimer = setTimeout(() => {
            saveData();
        }, DEBOUNCE_DELAY);
    }

    async function saveData() {
        if (state.isSaving) return; // Zabráni viacnásobnému ukladaniu
        state.isSaving = true;
        console.log("Spúšťam ukladanie dát...");

        const dataToSave = collectCurrentDataForSaving();
        const localKey = getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX);
        const dataString = JSON.stringify(dataToSave);

        // 1. Uložiť do Local Storage
        try {
            localStorage.setItem(localKey, dataString);
            console.log('Dáta uložené lokálne.');
        } catch (e) {
            console.error("Chyba pri ukladaní do Local Storage:", e);
            showErrorNotification("Chyba pri lokálnom ukladaní! Úložisko môže byť plné.", 6000);
            state.isSaving = false;
            return; // Neukladáme do FS, ak zlyhá LS
        }

        // 2. Uložiť do Firestore (ak prihlásený a online)
        if (state.currentUser && state.isOnline && db) {
            await saveToFirestore(dataToSave);
        } else if (!state.isOnline) {
             // Označiť pre neskoršiu synchronizáciu
             const pendingSyncKey = getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX);
             localStorage.setItem(pendingSyncKey, dataString);
             console.log('Offline: Dáta označené pre neskoršiu synchronizáciu.');
             showSaveNotification('Ste offline, dáta uložené lokálne.');
        } else {
            showSaveNotification(); // Len lokálne uloženie (neprihlásený)
        }
        state.isSaving = false;
    }

    // Zápis do Firestore
    async function saveToFirestore(dataToSave) {
        if (!state.currentUser || !db) return; // Kontrola pre istotu
        const dataKey = getCurrentMonthDataKey(); // Kľúč dokumentu vo Firestore
        const pendingSyncKey = getLocalStorageKey(LS_KEYS.PENDING_SYNC_PREFIX);
        console.log(`Pokus o zápis do Firestore: users/${state.currentUser.uid}/workDays/${dataKey}`);

        try {
            const userRef = doc(db, 'users', state.currentUser.uid);
            const docRef = doc(userRef, 'workDays', dataKey);
            await setDoc(docRef, dataToSave);

            localStorage.removeItem(pendingSyncKey); // Odstrániť príznak po úspechu
            console.log('Dáta úspešne synchronizované s Firestore.');
            // Zobrazíme notifikáciu len ak nebola zobrazená iná (napr. offline)
             if (!document.getElementById('saveNotification').classList.contains(CSS_CLASSES.NOTIFICATION_SHOW)) {
                  showSaveNotification('Dáta synchronizované s cloudom.');
             }
        } catch (error) {
            console.error('Chyba pri ukladaní do Firestore:', error);
            showErrorNotification('Chyba pri synchronizácii s cloudom.');
            // Označíme pre neskoršiu synchronizáciu
            localStorage.setItem(pendingSyncKey, JSON.stringify(dataToSave));
        }
    }

    // Synchronizácia čakajúcich dát
    window.syncWithFirebase = async function() { // Prístupné aj cez tlačidlo
        if (!state.currentUser || !state.isOnline || !db) {
             console.log("Synchronizácia nie je možná (neprihlásený, offline alebo chyba DB).");
             return;
        }

        console.log('Kontrolujem čakajúce dáta na synchronizáciu...');
        const batch = writeBatch(db);
        let pendingKeys = [];
        let syncCount = 0;

        // Prejdeme všetky kľúče v LS a hľadáme tie s prefixom pendingSync
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(LS_KEYS.PENDING_SYNC_PREFIX)) {
                 const dataString = localStorage.getItem(key);
                 const docId = key.substring(LS_KEYS.PENDING_SYNC_PREFIX.length); // Získame YYYY-M
                 if (dataString && docId) {
                     try {
                         const dataToSync = JSON.parse(dataString);
                         const userRef = doc(db, 'users', state.currentUser.uid);
                         const docRef = doc(userRef, 'workDays', docId);
                         batch.set(docRef, dataToSync); // Pridáme do batch zápisu
                         pendingKeys.push(key); // Poznačíme si kľúč na odstránenie z LS po úspechu
                         syncCount++;
                         console.log(`Pripravené na synchronizáciu: ${docId}`);
                     } catch (e) { console.error(`Chyba parsovania čakajúcich dát pre ${key}:`, e); }
                 }
            }
        }

        if (syncCount === 0) {
            console.log('Žiadne čakajúce dáta na synchronizáciu.');
            // Môžeme zobraziť info notifikáciu
            // showStatusNotification("Všetky dáta sú synchronizované.", "success");
            return;
        }

        showStatusNotification(`Synchronizujem ${syncCount} záznamov...`, 'info');
        try {
            await batch.commit(); // Odošleme všetky zmeny naraz
            // Ak batch prešiel, odstránime pending kľúče z LS
            pendingKeys.forEach(key => localStorage.removeItem(key));
            console.log(`${syncCount} záznamov úspešne synchronizovaných.`);
            showSaveNotification(`Offline dáta (${syncCount} mesiacov) boli synchronizované.`);
            showStatusNotification('Pripojené', 'info'); // Vrátime status
        } catch (error) {
            console.error('Chyba pri batch synchronizácii s Firestore:', error);
            showErrorNotification('Chyba pri synchronizácii offline dát.');
            showStatusNotification('Chyba synchronizácie', 'error');
            // Neodstraňujeme pending kľúče, skúsia sa synchronizovať nabudúce
        }
    }


    // ==================== TVORBA TABUĽKY A VÝPOČTY ====================

    function getDayName(year, month, day) { return DAYS_OF_WEEK[new Date(year, month, day).getDay()]; }
    function getDaysInMonth(month, year) { return new Date(year, month + 1, 0).getDate(); }
    function getInputId(type, day) { return `${type}-${day}`; } // Jednoduchšie ID

    function createTableStructure() {
        console.log('Vytváram štruktúru tabuľky pre:', getMonthName(state.currentMonth), state.currentYear);
        Elements.workDaysTbody.innerHTML = ''; // Vyčistiť starý obsah
        const today = state.currentDate;
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
        const fragment = document.createDocumentFragment();

        for (let day = 1; day <= daysInMonth; day++) {
            const row = document.createElement('tr');
            const isCurrentDay = day === currentDayOfMonth && state.currentMonth === currentMonthIndex && state.currentYear === currentYearValue;
            if (isCurrentDay) { row.classList.add(CSS_CLASSES.CURRENT_DAY); }
            row.setAttribute('data-day', day); // Pridáme data atribút pre ľahšiu identifikáciu

            const dayName = getDayName(state.currentYear, state.currentMonth, day);
            const startId = getInputId('start', day);
            const endId = getInputId('end', day);
            const breakId = getInputId('break', day);
            const notesId = getInputId('notes', day);
            const totalId = getInputId('total', day);
            const grossId = getInputId('gross', day);
            const netId = getInputId('net', day);
            const overtimeId = getInputId('overtime', day); // ID pre zobrazenie nadčasu

            row.innerHTML = `
                <td>${day} (${dayName})</td>
                <td><input type="time" id="${startId}" aria-label="Príchod dňa ${day}"></td>
                <td><input type="time" id="${endId}" aria-label="Odchod dňa ${day}"></td>
                <td><input type="number" id="${breakId}" min="0" step="0.1" placeholder="hod." aria-label="Prestávka dňa ${day}" class="currency"></td>
                <td id="${totalId}" class="text-muted">0h 0m (0.0h)</td>
                <td id="${grossId}" class="currency text-muted">0.00</td>
                <td id="${netId}" class="currency text-muted fw-bold">0.00</td>
                <td><textarea id="${notesId}" rows="1" placeholder="Poznámka..." aria-label="Poznámka dňa ${day}"></textarea></td>
                <td class="text-center">
                    <button class="btn btn-secondary btn-sm" data-action="apply-template" title="Aplikovať štandardný čas">📋</button>
                    <button class="btn btn-danger btn-sm" data-action="reset-row" title="Vynulovať riadok ${day}">❌</button>
                </td>
            `;
            // <span id="${overtimeId}" class="d-block text-danger small"></span>  Môžeme pridať zobrazenie nadčasu priamo do riadku
            fragment.appendChild(row);
        }
        Elements.workDaysTbody.appendChild(fragment);
    }

    // --- Event Handlers pre Tabuľku (Delegované) ---
    function handleTableInput(event) {
        const target = event.target;
        const row = target.closest('tr');
        if (!row) return;
        const day = parseInt(row.getAttribute('data-day'));

        // Okamžitá validácia pre number input (prestávka)
        if (target.type === 'number' && target.id.startsWith('break-')) {
            validateNumberInput(target);
            handleDataChange(day); // Prepočítať a uložiť
        }
         // Pre textarea môžeme tiež hneď ukladať
        if (target.tagName === 'TEXTAREA' && target.id.startsWith('notes-')) {
             handleDataChange(day); // Uloží poznámku
        }
    }
    function handleTableChange(event) {
         const target = event.target;
         const row = target.closest('tr');
         if (!row) return;
         const day = parseInt(row.getAttribute('data-day'));

         // Pre time inputy a textarea (po opustení poľa)
         if (target.type === 'time' || target.tagName === 'TEXTAREA') {
              handleDataChange(day); // Prepočítať a uložiť
         }
    }
     function handleTableClick(event) {
        const target = event.target.closest('button'); // Klikli sme na tlačidlo?
        if (!target) return;
        const row = target.closest('tr');
        if (!row) return;
        const day = parseInt(row.getAttribute('data-day'));
        const action = target.getAttribute('data-action');

        if (action === 'reset-row') {
            resetRow(day);
        } else if (action === 'apply-template') {
             applyTemplate(day);
        }
    }

    // --- Pomocné funkcie pre inputy v tabuľke ---
     function validateNumberInput(input) {
         // Jednoduchá validácia - odstrániť nečíselné znaky okrem desatinnej bodky/čiarky
         // a zabezpečiť, aby hodnota nebola záporná
         input.value = input.value.replace(/[^0-9.,]/g, '').replace(',', '.');
         if (parseFloat(input.value) < 0) {
             input.value = '0';
         }
     }

    // --- Výpočty ---
    function calculateRowLogic(day) {
        const dataKey = getCurrentMonthDataKey();
        if (!state.monthData[dataKey] || !state.monthData[dataKey].data[day-1]) return; // Ak dáta ešte neexistujú

        const dayState = state.monthData[dataKey].data[day-1];
        const startEl = document.getElementById(getInputId('start', day));
        const endEl = document.getElementById(getInputId('end', day));
        const breakEl = document.getElementById(getInputId('break', day));
        const totalCell = document.getElementById(getInputId('total', day));
        const grossCell = document.getElementById(getInputId('gross', day));
        const netCell = document.getElementById(getInputId('net', day));
        // const overtimeCell = document.getElementById(getInputId('overtime', day));

        const startTime = startEl?.value || '';
        const endTime = endEl?.value || '';
        const breakHours = parseFloat(breakEl?.value) || 0;

        let workedMinutes = 0;
        let workedDecimal = 0;
        let overtimeDecimal = 0;

        if (startTime && endTime) { // Výpočet len ak sú oba časy zadané
             try {
                 const start = new Date(`1970-01-01T${startTime}:00`);
                 let end = new Date(`1970-01-01T${endTime}:00`);

                 if (isNaN(start) || isNaN(end)) throw new Error("Neplatný čas");

                 if (end <= start) { end.setDate(end.getDate() + 1); } // Práca cez polnoc

                 const diffMillis = end.getTime() - start.getTime();
                 let diffMinutes = diffMillis / (1000 * 60);
                 diffMinutes -= (breakHours * 60);

                 workedMinutes = Math.max(0, Math.round(diffMinutes));
                 workedDecimal = workedMinutes / 60;

                 // Výpočet nadčasu
                 const standardMinutes = state.settings.standardHours * 60;
                 if (workedMinutes > standardMinutes) {
                      overtimeDecimal = (workedMinutes - standardMinutes) / 60;
                 }

             } catch (e) {
                 console.warn(`Chyba pri výpočte času pre deň ${day}:`, e.message);
                 workedMinutes = 0;
                 workedDecimal = 0;
                 overtimeDecimal = 0;
             }
        }

        // Uloženie vypočítaných hodnôt do stavu dňa
        dayState.calculated = {
            workedDec: workedDecimal,
            gross: workedDecimal * state.settings.hourlyWage,
            net: (workedDecimal * state.settings.hourlyWage) * (1 - state.settings.taxRate),
            overtimeDec: overtimeDecimal
        };

        // Aktualizácia UI pre riadok
        const hours = Math.floor(workedMinutes / 60);
        const minutes = workedMinutes % 60;
        const decPlaces = state.settings.decimalPlaces;

        totalCell.textContent = `${hours}h ${minutes}m (${workedDecimal.toFixed(decPlaces)}h)`;
        grossCell.textContent = formatCurrency(dayState.calculated.gross);
        netCell.textContent = formatCurrency(dayState.calculated.net);

        // Pridanie/odobratie triedy pre vizuálne odlíšenie vyplnených riadkov
        const rowEl = totalCell.closest('tr');
        rowEl?.classList.toggle('has-data', workedDecimal > 0 || breakHours > 0);

        // Zobrazenie nadčasu (napr. v tooltip alebo inom stĺpci)
        // if (overtimeCell) overtimeCell.textContent = overtimeDecimal > 0 ? `+${overtimeDecimal.toFixed(decPlaces)}h` : '';
    }

    function calculateAllTotals() {
        const dataKey = getCurrentMonthDataKey();
        if (!state.monthData[dataKey] || !state.monthData[dataKey].data) {
             renderTotals({ workedDec: 0, gross: 0, net: 0, overtimeDec: 0, days: 0 });
             return;
        }

        const monthDaysData = state.monthData[dataKey].data;
        let totalWorkedDec = 0;
        let totalGross = 0;
        let totalNet = 0;
        let totalOvertimeDec = 0;
        let daysWithEntries = 0;

        monthDaysData.forEach(day => {
            if (day.calculated) {
                totalWorkedDec += day.calculated.workedDec || 0;
                totalGross += day.calculated.gross || 0;
                totalNet += day.calculated.net || 0;
                totalOvertimeDec += day.calculated.overtimeDec || 0;
                if (day.calculated.workedDec > 0 || parseFloat(day.breakTime) > 0 || day.notes) {
                    daysWithEntries++;
                }
            }
        });

        renderTotals({
            workedDec: totalWorkedDec,
            gross: totalGross,
            net: totalNet,
            overtimeDec: totalOvertimeDec,
            days: daysWithEntries
        });
    }

    function renderTotals(totals) {
        const decPlaces = state.settings.decimalPlaces;
        const totalHours = Math.floor(totals.workedDec);
        const totalMinutes = Math.round((totals.workedDec - totalHours) * 60);

        Elements.totalSalaryDiv.innerHTML = `
            <div class="total-item">
                <span class="label">Započítaných dní</span>
                <span class="value">${totals.days}</span>
            </div>
            <div class="total-item">
                <span class="label">Celkový čas</span>
                <span class="value">${totalHours}h ${totalMinutes}m (${totals.workedDec.toFixed(decPlaces)}h)</span>
            </div>
             <div class="total-item">
                <span class="label">Nadčasy</span>
                <span class="value overtime">${totals.overtimeDec.toFixed(decPlaces)} h</span>
            </div>
            <div class="total-item">
                <span class="label">Hrubá mzda</span>
                <span class="value">${formatCurrency(totals.gross)}</span>
            </div>
            <div class="total-item">
                <span class="label">Čistá mzda</span>
                <span class="value fw-bold">${formatCurrency(totals.net)}</span>
            </div>
        `;
    }

    function formatCurrency(value) {
        // Použijeme Intl.NumberFormat pre správne formátovanie meny
        // Ak by Intl nebol podporovaný, vrátime jednoduchý toFixed
        try {
            return CURRENCY_FORMATTER.format(value || 0);
        } catch (e) {
            return (value || 0).toFixed(state.settings.decimalPlaces) + ' €';
        }
    }

    // --- Akcie pre riadky ---
    function resetRow(day) {
      const startEl = document.getElementById(getInputId('start', day));
      const endEl = document.getElementById(getInputId('end', day));
      const breakEl = document.getElementById(getInputId('break', day));
      const notesEl = document.getElementById(getInputId('notes', day));
      if (startEl) startEl.value = '';
      if (endEl) endEl.value = '';
      if (breakEl) breakEl.value = '';
      if (notesEl) notesEl.value = '';
      handleDataChange(day); // Prepočíta na nulu a uloží
    }

    function applyTemplate(day) {
        // Príklad jednoduchej šablóny - môžete rozšíriť
        const startEl = document.getElementById(getInputId('start', day));
        const endEl = document.getElementById(getInputId('end', day));
        const breakEl = document.getElementById(getInputId('break', day));

        if (confirm(`Aplikovať štandardný čas (8:00-16:30, 0.5h prestávka) na deň ${day}?`)) {
             if (startEl) startEl.value = '08:00';
             if (endEl) endEl.value = '16:30';
             if (breakEl) breakEl.value = '0.5';
             handleDataChange(day); // Prepočíta a uloží
        }
    }

    // ==================== NAVIGÁCIA A ZMENA NASTAVENÍ ====================

    window.toggleSettings = function() {
        state.isSettingsOpen = !state.isSettingsOpen;
        Elements.settingsPanel.classList.toggle(CSS_CLASSES.SETTINGS_OPEN, state.isSettingsOpen);
    }

    window.toggleDarkMode = function() {
      Elements.body.classList.toggle(CSS_CLASSES.DARK_MODE);
      localStorage.setItem(LS_KEYS.DARK_MODE, Elements.body.classList.contains(CSS_CLASSES.DARK_MODE));
    }

    window.changeDecimalPlaces = function() {
      state.settings.decimalPlaces = parseInt(Elements.decimalPlacesSelect.value);
      saveSettings(); // Uložíme len nastavenie
      // Prepočíta zobrazenie v tabuľke a súčty
      state.monthData[getCurrentMonthDataKey()]?.data.forEach((_, index) => calculateRowLogic(index+1));
      calculateAllTotals();
      // Nemusíme volať saveData(), lebo sa nemenia základné dáta, len zobrazenie
    }

    window.updateEmployeeName = function() {
      state.settings.employeeName = Elements.employeeNameInput.value.trim();
      updateEmployeeSubtitle();
      saveSettings(); // Uložíme len nastavenie
      scheduleSaveData(); // Aj meno je súčasťou ukladaných mesačných dát
    }
    function updateEmployeeSubtitle() {
        Elements.employeeSubtitle.textContent = state.settings.employeeName ? `Pracovník: ${state.settings.employeeName}` : '';
    }

    window.updateSettings = function() { // Pre mzdu, daň, normu
        const newWage = parseFloat(Elements.hourlyWageInput.value);
        const newTaxRatePercent = parseFloat(Elements.taxRateInput.value);
        const newStandardHours = parseFloat(Elements.standardHoursInput.value);

        let changed = false;
        if (!isNaN(newWage) && newWage >= 0 && newWage !== state.settings.hourlyWage) {
            state.settings.hourlyWage = newWage; changed = true;
        }
        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100 && (newTaxRatePercent / 100) !== state.settings.taxRate) {
            state.settings.taxRate = newTaxRatePercent / 100; changed = true;
        }
         if (!isNaN(newStandardHours) && newStandardHours >= 0 && newStandardHours <= 24 && newStandardHours !== state.settings.standardHours) {
            state.settings.standardHours = newStandardHours; changed = true;
        }

        if (changed) {
            saveSettings(); // Uložíme globálne nastavenia
            // Prepočítať celú tabuľku a súčty, lebo sa zmenili sadzby/norma
             state.monthData[getCurrentMonthDataKey()]?.data.forEach((_, index) => calculateRowLogic(index+1));
             calculateAllTotals();
             scheduleSaveData(); // Uložíme aj mesačné dáta s novými prepočtami a nastaveniami
        }
        // Vrátime hodnoty do UI pre správne formátovanie (aj ak sa nezmenili)
        applySettingsToUI();
    }

    window.changeMonthAbsolute = function() {
        const newMonth = parseInt(Elements.monthSelect.value);
        if (newMonth !== state.currentMonth) {
             state.currentMonth = newMonth;
             refreshDataAndView();
        }
    }
     window.changeYear = function() {
        const newYear = parseInt(Elements.yearSelect.value);
        if (newYear !== state.currentYear) {
             state.currentYear = newYear;
             // Ak meníme rok, musíme skontrolovať aj počet dní v mesiaci (prestupný rok)
             const daysInNewMonth = getDaysInMonth(state.currentMonth, state.currentYear);
             // Ak aktuálny mesiac má menej dní v novom roku, môže to byť problém
             // Pre jednoduchosť len obnovíme pohľad
             refreshDataAndView();
        }
    }
    window.changeMonthRelative = function(delta) {
        let newMonth = state.currentMonth + delta;
        let newYear = state.currentYear;
        if (newMonth > 11) { newMonth = 0; newYear++; }
        if (newMonth < 0) { newMonth = 11; newYear--; }

        // Skontrolujeme, či nový rok je v povolenom rozsahu selectu
        const yearExists = Array.from(Elements.yearSelect.options).some(opt => parseInt(opt.value) === newYear);
        if (!yearExists) {
            showErrorNotification("Rok mimo povoleného rozsahu.");
            return; // Nerobíme nič, ak rok nie je v selecte
        }

        state.currentMonth = newMonth;
        state.currentYear = newYear;
        refreshDataAndView(); // Obnoví pohľad pre nový mesiac/rok
    }
    window.goToCurrentMonth = function() {
         const today = new Date();
         state.currentMonth = today.getMonth();
         state.currentYear = today.getFullYear();
         // Skontrolujeme, či aktuálny rok je v selecte, ak nie, pridáme ho? (Zložitejšie)
         // Zatiaľ predpokladáme, že aktuálny rok tam bude.
          refreshDataAndView();
    }

    // ==================== EXPORT / IMPORT ====================

    // --- PDF Export (prispôsobený pre nové pole Poznámky) ---
    function generatePDFDocument() {
         // Kontrola, či sú knižnice načítané
         if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.autoTable === 'undefined') {
             showErrorNotification("PDF knižnice ešte nie sú načítané. Skúste o chvíľu znova.");
             throw new Error("jsPDF alebo autoTable nie je dostupné.");
         }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' }); // Na šírku pre viac stĺpcov
        const dataKey = getCurrentMonthDataKey();
        const monthDataObject = state.monthData[dataKey] || { data: [] };
        const savedSettings = monthDataObject.savedSettings || state.settings; // Použi nastavenia uložené s dátami, ak existujú

        try { doc.setFont('helvetica'); } catch (e) { console.warn("PDF Font Error"); }

        doc.setFontSize(16);
        const title = `Výkaz práce - ${savedSettings.employeeName || 'Pracovník'} (${getMonthName(state.currentMonth)} ${state.currentYear})`;
        doc.text(title, 14, 15);

        doc.setFontSize(10);
        doc.text(`Mzda: ${savedSettings.hourlyWage.toFixed(2)} €/h | Daň: ${(savedSettings.taxRate * 100).toFixed(1)} % | Norma: ${savedSettings.standardHours.toFixed(1)} h/deň`, 14, 22);

        const tableData = [];
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
        for (let day = 1; day <= daysInMonth; day++) {
             const dayState = monthDataObject.data[day-1];
             if (!dayState) continue; // Preskočiť, ak dáta dňa chýbajú

             const dayName = getDayName(state.currentYear, state.currentMonth, day);
             const workedMinutes = (dayState.calculated?.workedDec || 0) * 60;
             const hours = Math.floor(workedMinutes / 60);
             const minutes = Math.round(workedMinutes % 60);
             const totalTime = `${hours}h ${minutes}m`;

             // Pridať riadok len ak existuje nejaký záznam
             if (dayState.start || dayState.end || parseFloat(dayState.breakTime) > 0 || dayState.notes) {
                  tableData.push([
                     `${day} (${dayName})`,
                     dayState.start || '-',
                     dayState.end || '-',
                     dayState.breakTime || '0',
                     totalTime,
                     formatCurrency(dayState.calculated?.gross || 0).replace(/\s*€/,''), // Odstráni menu pre čistotu
                     formatCurrency(dayState.calculated?.net || 0).replace(/\s*€/,''),
                     dayState.notes || ''
                 ]);
             }
        }

        doc.autoTable({
            head: [['Deň', 'Príchod', 'Odchod', 'Prest.(h)', 'Čas', 'Hrubá(€)', 'Čistá(€)', 'Poznámky']],
            body: tableData,
            startY: 28,
            theme: 'grid', // Alebo 'striped'
            styles: { fontSize: 8, cellPadding: 1.5, valign: 'top' },
            headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold' },
            columnStyles: {
                0: { cellWidth: 25 }, // Deň
                1: { cellWidth: 15 }, // Príchod
                2: { cellWidth: 15 }, // Odchod
                3: { cellWidth: 15, halign: 'right' }, // Prestávka
                4: { cellWidth: 20 }, // Čas
                5: { cellWidth: 20, halign: 'right' }, // Hrubá
                6: { cellWidth: 20, halign: 'right' }, // Čistá
                7: { cellWidth: 'auto' } // Poznámky - automatická šírka
            },
             didDrawPage: function(data) {
                 doc.setFontSize(8);
                 doc.text('Strana ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 8);
                 doc.text(`Vygenerované: ${new Date().toLocaleString('sk-SK')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 8, { align: 'right'});
             }
        });

         // Pridanie súčtov na koniec
         const totals = calculateTotalsObject(); // Získame objekt so súčtami
         const finalY = doc.lastAutoTable.finalY + 5;
         doc.setFontSize(10);
         doc.text("Celkové súčty:", 14, finalY);
         const decPlaces = savedSettings.decimalPlaces;
         const totalHours = Math.floor(totals.workedDec);
         const totalMinutes = Math.round((totals.workedDec - totalHours) * 60);
         const summaryText =
`Odpracovaných dní: ${totals.days}
Celkový čas: ${totalHours}h ${totalMinutes}m (${totals.workedDec.toFixed(decPlaces)} h)
Celkové nadčasy: ${totals.overtimeDec.toFixed(decPlaces)} h
Hrubá mzda: ${formatCurrency(totals.gross)}
Čistá mzda: ${formatCurrency(totals.net)}`;
         doc.text(summaryText, 14, finalY + 5);

         return doc;
    }

    function calculateTotalsObject() { // Pomocná funkcia pre PDF a iné
         const dataKey = getCurrentMonthDataKey();
         if (!state.monthData[dataKey] || !state.monthData[dataKey].data) {
             return { workedDec: 0, gross: 0, net: 0, overtimeDec: 0, days: 0 };
         }
         // ... (logika kopírovaná z calculateAllTotals, ale vracia objekt) ...
         const monthDaysData = state.monthData[dataKey].data;
         let totalWorkedDec = 0, totalGross = 0, totalNet = 0, totalOvertimeDec = 0, daysWithEntries = 0;
         monthDaysData.forEach(day => { /* ... (rovnaký výpočet ako v calculateAllTotals) ... */
            if (day.calculated) { totalWorkedDec += day.calculated.workedDec || 0; totalGross += day.calculated.gross || 0; totalNet += day.calculated.net || 0; totalOvertimeDec += day.calculated.overtimeDec || 0; if (day.calculated.workedDec > 0 || parseFloat(day.breakTime) > 0 || day.notes) { daysWithEntries++; } } });
         return { workedDec: totalWorkedDec, gross: totalGross, net: totalNet, overtimeDec: totalOvertimeDec, days: daysWithEntries };
    }

    window.exportToPDF = function() {
        try {
            const doc = generatePDFDocument();
            const filename = `vykaz_prace_${(state.settings.employeeName || 'pracovnik').replace(/\s+/g, '_')}_${state.currentYear}_${getMonthName(state.currentMonth)}.pdf`;
            doc.save(filename);
            showSaveNotification('PDF súbor bol vygenerovaný.');
        } catch (error) { console.error("Chyba pri exporte PDF:", error); /* showErrorNotification už bola zobrazená v generatePDFDocument */ }
    }
    window.sendPDF = async function() { /* ... (podobne, použije generatePDFDocument) ... */ }

    // --- Excel Záloha / Obnova (prispôsobené pre nové polia) ---
    window.createBackup = function() {
         if (typeof XLSX === 'undefined') return showErrorNotification("Excel knižnica ešte nie je načítaná.");
         const currentData = collectCurrentDataForSaving(); // Získame aktuálne dáta mesiaca vrátane nastavení
         if (!currentData || !currentData.data) return showErrorNotification('Nie sú dáta na zálohu.');

         try {
             const ws_data = [
                 ["Záloha Výkazu Práce Pro"],
                 ["Pracovník", currentData.savedSettings.employeeName],
                 ["Mesiac", getMonthName(state.currentMonth)], ["Rok", state.currentYear],
                 ["Hodinová mzda (€)", currentData.savedSettings.hourlyWage],
                 ["Daňové percento (%)", currentData.savedSettings.taxRate * 100],
                 ["Denná norma (hod.)", currentData.savedSettings.standardHours],
                 ["Desatinné miesta", currentData.savedSettings.decimalPlaces],
                 ["Dátum zálohy", currentData.lastUpdated || new Date().toISOString()],
                 [],
                 ["Deň č.", "Deň v týždni", "Príchod", "Odchod", "Prestávka (h)", "Poznámky", "Hrubá Mzda (€)", "Čistá Mzda (€)", "Odpracované (h)", "Nadčasy (h)"]
             ];
             currentData.data.forEach((dayData, index) => {
                 const day = index + 1;
                 const dayName = getDayName(state.currentYear, state.currentMonth, day);
                 ws_data.push([
                     day, dayName, dayData.start, dayData.end, dayData.breakTime, dayData.notes,
                     dayData.calculated?.gross || 0,
                     dayData.calculated?.net || 0,
                     dayData.calculated?.workedDec || 0,
                     dayData.calculated?.overtimeDec || 0
                 ]);
             });
             // ... (zvyšok XLSX generovania ako predtým) ...
             const wb = XLSX.utils.book_new();
             const ws = XLSX.utils.aoa_to_sheet(ws_data);
             // Nastavenie šírky stĺpcov (môže byť potrebné upraviť)
             ws['!cols'] = [ {wch: 5}, {wch: 5}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 30}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10} ];
             XLSX.utils.book_append_sheet(wb, ws, "VykazPrace");
             const filename = `zaloha_vykaz_${(state.settings.employeeName || 'pracovnik').replace(/\s+/g, '_')}_${state.currentYear}_${getMonthName(state.currentMonth)}.xlsx`;
             XLSX.writeFile(wb, filename);
             showSaveNotification('Záloha (.xlsx) bola úspešne vytvorená.');
         } catch (error) { console.error('Chyba pri vytváraní Excel zálohy:', error); showErrorNotification('Chyba pri vytváraní zálohy.'); }
     };

    window.restoreBackup = function() { /* ... (Potrebuje výraznú úpravu na parsovanie nových stĺpcov a štruktúry) ... */
         if (typeof XLSX === 'undefined') return showErrorNotification("Excel knižnica ešte nie je načítaná.");
         // 1. Vytvoriť input element
         const input = document.createElement('input'); input.type = 'file'; input.accept = '.xlsx';
         // 2. Nastaviť onchange handler
         input.onchange = (event) => {
             const file = event.target.files[0];
             if (!file) return;
             if (!confirm(`Naozaj obnoviť dáta zo súboru "${file.name}" pre ${getMonthName(state.currentMonth)} ${state.currentYear}?`)) return;

             const reader = new FileReader();
             reader.onload = (e) => {
                 try {
                     const data = new Uint8Array(e.target.result);
                     const workbook = XLSX.read(data, { type: 'array' });
                     const ws = workbook.Sheets[workbook.SheetNames[0]];
                     const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "", raw: false });

                     // --- Parsovanie nastavení (robustnejšie) ---
                     let restoredSettings = {};
                     let dataStartIndex = -1;
                     const headerMap = {}; // Na mapovanie názvov stĺpcov na indexy

                     for(let i=0; i < rows.length; i++) {
                         const row = rows[i];
                         if (!row) continue;
                         const key = row[0]?.toString().toLowerCase().trim();
                         const value = row[1]?.toString().trim();
                         // Parsovanie nastavení... (podobne ako predtým)
                         if (key.includes("hodinová mzda")) restoredSettings.hourlyWage = parseFloat(value) || undefined;
                         else if (key.includes("daňové percento")) restoredSettings.taxRate = (parseFloat(value) || 0) / 100;
                         else if (key.includes("denná norma")) restoredSettings.standardHours = parseFloat(value) || undefined;
                         else if (key.includes("meno pracovníka")) restoredSettings.employeeName = value;
                         // ... atď ...

                         // Hľadanie dátovej hlavičky
                         const headerCandidate = row.map(h => h?.toString().toLowerCase().trim());
                         if (headerCandidate.includes("deň č.") && headerCandidate.includes("príchod") && headerCandidate.includes("odchod")) {
                              dataStartIndex = i + 1;
                              // Vytvor mapovanie hlavičky
                              headerCandidate.forEach((h, index) => { if(h) headerMap[h] = index; });
                              break;
                         }
                     }
                     if (dataStartIndex === -1 || !headerMap["príchod"] === undefined) throw new Error("Nepodarilo sa nájsť dátovú tabuľku v súbore.");

                     // --- Parsovanie dát ---
                     const restoredDataArray = [];
                     const daysInTargetMonth = getDaysInMonth(state.currentMonth, state.currentYear);
                     const startIndex = headerMap["príchod"];
                     const endIndex = headerMap["odchod"];
                     const breakIndex = headerMap["prestávka (h)"];
                     const notesIndex = headerMap["poznámky"]; // Index pre poznámky

                     for (let i = dataStartIndex; i < rows.length; i++) {
                          const row = rows[i];
                          if (!row || typeof row[0] !== 'number' || row[0] < 1 || row[0] > daysInTargetMonth) break; // Koniec dát

                          restoredDataArray.push({
                              start: row[startIndex] || "",
                              end: row[endIndex] || "",
                              breakTime: row[breakIndex] || "",
                              notes: row[notesIndex] || "", // Načítanie poznámok
                              calculated: {} // Vypočíta sa nanovo
                          });
                          if (restoredDataArray.length >= daysInTargetMonth) break;
                     }
                      // Doplnenie prázdnych dní...
                     while (restoredDataArray.length < daysInTargetMonth) { restoredDataArray.push({ start: "", end: "", breakTime: "", notes: "", calculated: {}}); }

                     // --- Aplikácia ---
                     // Zlúčenie nastavení
                     state.settings = { ...state.settings, ...restoredSettings };
                     applySettingsToUI();
                     saveSettings();

                     // Vytvorenie objektu pre mesiac a uloženie/aplikácia
                     const restoredMonthData = { data: restoredDataArray, savedSettings: { ...state.settings }, lastUpdated: new Date().toISOString() };
                     const dataKey = getCurrentMonthDataKey();
                     state.monthData[dataKey] = restoredMonthData; // Do cache
                     localStorage.setItem(getLocalStorageKey(LS_KEYS.WORK_DATA_PREFIX), JSON.stringify(restoredMonthData)); // Do LS
                     applyDataToTable(restoredMonthData); // Do UI
                     calculateAllTotals();
                     showSaveNotification('Záloha bola úspešne obnovená.');
                     scheduleSaveData(); // Uložíme do cloudu, ak je to možné

                 } catch (error) { console.error('Chyba pri obnove zo zálohy:', error); showErrorNotification('Chyba pri spracovaní zálohy: ' + error.message); }
             };
             reader.onerror = () => showErrorNotification('Chyba pri čítaní súboru.');
             reader.readAsArrayBuffer(file);
         };
         // 3. Kliknúť na input
         input.click();
     };


    // ==================== ŠTART APLIKÁCIE ====================
    initializeAppCore();

  </script>

  <!-- Service Worker Registrácia (bez zmien) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Skontroluj cestu
          .then(reg => console.log('Service Worker zaregistrovaný:', reg.scope))
          .catch(err => console.error('Registrácia Service Workera zlyhala:', err));
      });
    }
  </script>
</body>
</html>
