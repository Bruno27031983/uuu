<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doch√°dzka</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="icons/icon-192x192.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#5c67f2">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <style>
    /* CSS ≈°t√Ωly zost√°vaj√∫ rovnak√© */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; font-size: 16px; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(244,244,244,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 1.2em; color: #555; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    h1 { text-align: center; font-size: 2.5em; color: black; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; margin-bottom: 20px; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; font-size: 0.9em; }
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; table-layout: fixed; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; word-wrap: break-word; position: relative; }
    th { background-color: #f2f2f2; font-weight: bold; }
    th:nth-child(1), td:nth-child(1) { width: 40px; } th:nth-child(2), td:nth-child(2) { width: 110px; } th:nth-child(3), td:nth-child(3) { width: 110px; } th:nth-child(4), td:nth-child(4) { width: 90px; text-align: center; } th:nth-child(5), td:nth-child(5) { width: 130px;} th:nth-child(6), td:nth-child(6) { width: 150px;} th:nth-child(7), td:nth-child(7) { width: 100px; text-align: right;} th:nth-child(8), td:nth-child(8) { width: 100px; text-align: right;} th:nth-child(9), td:nth-child(9) { width: 70px; text-align: center; }
    input[type="tel"], input[type="number"], input[type="text"], select, textarea { width: 100%; padding: 7px; box-sizing: border-box; background-color: #ffffd0; font-size: 1em; border: 1px solid #ccc; border-radius: 3px; vertical-align: middle; }
    textarea { resize: vertical; min-height: 38px; }
    td:nth-child(6) textarea { min-height: 38px; max-height: 100px; overflow-y: auto; }
    .time-input-wrapper { display: flex; align-items: center; gap: 5px; position: relative; }
    .time-input-wrapper input[type="tel"] { flex-grow: 1; min-width: 45px; padding-right: 30px; }
    .clock-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.4em; color: #555; user-select: none; z-index: 2; }
    .clock-icon:hover { color: #007bff; opacity: 0.8; }
    .btn-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn { padding: 12px 18px; border: none; border-radius: 4px; color: white; background-color: #5c67f2; cursor: pointer; font-size: 1.0em; transition: background-color 0.3s ease; text-align: center; flex: 1 1 150px; max-width: 200px; box-sizing: border-box; }
    .btn:hover { background-color: #4a54e0; } .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; } .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; } .backup-btn { background-color: #8a2be2; padding: 18px 22px; } .backup-btn:hover { background-color: #6a1bb2; }
    #totalSalary { margin-top: 20px; padding: 18px; background-color: #e9ecef; border-radius: 4px; font-size: 1.1em; line-height: 1.6; border: 1px solid #dee2e6; text-align: center; }
    .current-day { background-color: #8a2be2; color: white; } .current-day input, .current-day select, .current-day textarea { background-color: #9932cc; color: white; }
    .logout-section { margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
    #user-info, #login-form { display: none; } #user-info span { font-size: 0.95em; color: #333; } #user-info .btn { min-width: 150px; width: auto; flex-grow: 0; padding: 8px 16px; font-size: 0.9em; max-width: 200px; }
    #installAppButton { padding: 12px 18px; border: none; border-radius: 4px; color: white; background-color: #28a745; cursor: pointer; font-size: 1.0em; transition: background-color 0.3s ease; text-align: center; flex: 1 1 150px; max-width: 200px; box-sizing: border-box; margin-top: 5px; }
    #installAppButton:hover { background-color: #218838; }
    @media (max-width: 768px) { body { padding: 5px; font-size: 15px; } .container { padding: 12px; max-width: 100%; } h1 { font-size: 2.0em; } h2 { font-size: 1.1em; } .settings { flex-direction: column; align-items: stretch; } .settings > div, .settings > details { width: 100%; margin: 5px 0; flex-basis: auto; } .collapsible-content { flex-direction: column; align-items: stretch; } .collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; } table { min-width: 750px; } th, td { padding: 8px; font-size: 1.0em; } input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 1.0em; padding: 8px; } .clock-icon { font-size: 1.5em; } .btn-container { flex-direction: column; align-items: center; } .btn, #installAppButton { max-width: none; font-size: 1.05em; width: 95%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 5px; box-sizing: border-box; height: 44px; padding: 0 20px; flex: none; } .backup-btn { padding: 0 22px; } #user-info .btn { width: 80%; font-size: 0.95em; padding: 10px 16px; height: auto; margin-bottom: 0; } #totalSalary { font-size: 1.0em; padding: 15px; } }
    @media (max-width: 480px) { body { font-size: 14px; } .container { padding: 10px; } h1 { font-size: 1.8em; } h2 { font-size: 1.0em; } th, td { font-size: 0.9em; padding: 7px; } input[type="tel"], input[type="number"], input[type="text"], select, textarea { font-size: 0.95em; padding: 8px; } .settings label { font-size: 1.0em; } .clock-icon { font-size: 1.6em; } .btn, #installAppButton { font-size: 0.95em; width: 95%; height: 42px; padding: 0 15px; flex: none; margin-bottom: 4px; } .backup-btn { padding: 0 15px; } #user-info .btn { width: 85%; padding: 10px 16px; height: auto; margin-bottom: 0; } table { min-width: 600px; } #totalSalary { font-size: 0.95em; padding: 12px; } }
    #saveNotification, #errorNotification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 5px; color: white; z-index: 10000; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: center; font-size: 0.9em; }
    #saveNotification.show, #errorNotification.show { opacity: 1; visibility: visible; } #saveNotification { background-color: #4CAF50; } #errorNotification { background-color: #f44336; }
    #login-form { flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
    #login-form input[type="email"], #login-form input[type="password"] { width: 100%; max-width: 300px; padding: 8px; margin-bottom: 5px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; font-size: 1em; }
    #login-form .btn { width: auto; max-width: 150px; padding: 10px 22px; margin: 5px 0; font-size: 1em; height: auto; flex: initial; background-color: #4CAF50; color: white; }
    #login-form .btn:hover { background-color: #388e3c; } #login-form a { color: #007bff; text-decoration: none; font-size: 0.9em; } #login-form a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <div id="loader">Naƒç√≠tavam aplik√°ciu...</div>

  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
    </div>

    <h1 id="mainTitle">Doch√°dzka üëã</h1>
    <h2></h2>

    <div class="settings">
        <div> <label for="monthSelect">Mesiac: </label> <select id="monthSelect" onchange="changeMonth()"> <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option> <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option> <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option> <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option> </select> </div>
        <details class="collapsible-settings"> <summary>ƒéal≈°ie nastavenia</summary> <div class="collapsible-content"> <div> <label for="employeeNameInput">Meno pracovn√≠ka: </label> <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()"> </div> <div> <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label> <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"> </div> <div> <label for="taxRateInput">Da≈àov√© percento (%): </label> <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"> </div> <div> <label for="yearSelect">Rok: </label> <select id="yearSelect" onchange="changeYear()"></select> </div> <div> <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label> <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"> <option value="1">1</option> <option value="2" selected>2</option> </select> </div> </div> </details>
    </div>

    <div class="table-container"> <table> <thead> <tr> <th>De≈à</th> <th>Pr√≠chod</th> <th>Odchod</th> <th>Prest√°vka</th> <th>Odpracovan√©</th> <th>Pozn√°mky</th> <th>Hrub√° Mzda (‚Ç¨)</th> <th>ƒåist√° Mzda (‚Ç¨)</th> <th>Akcia</th> </tr> </thead> <tbody id="workDays"> </tbody> </table> </div>
    <div id="totalSalary"></div>
    <div class="btn-container"> <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button> <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button> <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button> <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button> <button class="btn export-btn" onclick="loadFromFirestore()">Obnovi≈• z Cloudu</button> </div>
    <div class="logout-section"> <div id="user-info"> <span id="user-email"></span> <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button> </div> </div>

  </div>
  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    const firebaseConfig = { /* ... VA≈†A KONFIGUR√ÅCIA ... */ 
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    const app = initializeApp(firebaseConfig);
    try { 
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // V√Å≈† KƒΩ√öƒå
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) { console.warn("Firebase App Check failed to initialize.", e); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let firestoreListenerUnsubscribe = null;

    const workDaysTableBody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitleElement = document.getElementById('mainTitle');
    const subTitleElement = document.querySelector('h2');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const loaderElement = document.getElementById('loader');
    const loginFormElement = document.getElementById('login-form');
    const userInfoElement = document.getElementById('user-info');
    const userEmailElement = document.getElementById('user-email');

    const currentDateGlobal = new Date();
    let currentMonth = currentDateGlobal.getMonth();
    let currentYear = currentDateGlobal.getFullYear();
    let decimalPlaces = 2;
    let employeeName = '';
    let hourlyWage = 10;
    let taxRate = 0.02;

    // --- DEFIN√çCIE FUNKCI√ç PRESUNUT√â HORE ---
    // --- IndexedDB Helper Functions ---
    const DB_NAME = 'DochadzkaDB';
    const DB_VERSION = 1;
    const PENDING_STORE_NAME = 'pendingSyncs';

    function openDB() { /* ... k√≥d z predch√°dzaj√∫cej odpovede ... */ return new Promise((resolve, reject) => { console.log(`[DB] Pokus o otvorenie DB: ${DB_NAME} v${DB_VERSION}`); const request = indexedDB.open(DB_NAME, DB_VERSION); request.onerror = (event) => { console.error("[DB] Chyba otvorenia IndexedDB:", event.target.error); reject("Chyba otvorenia IndexedDB: " + event.target.error); }; request.onsuccess = (event) => { console.log("[DB] IndexedDB √∫spe≈°ne otvoren√°."); resolve(event.target.result); }; request.onupgradeneeded = (event) => { console.log("[DB] onupgradeneeded - vytv√°ram/aktualizujem object store."); const dbInstance = event.target.result; if (!dbInstance.objectStoreNames.contains(PENDING_STORE_NAME)) { const store = dbInstance.createObjectStore(PENDING_STORE_NAME, { keyPath: 'id', autoIncrement: true }); store.createIndex('userMonthYear', ['userId', 'year', 'month'], { unique: true }); console.log(`[DB] Object store '${PENDING_STORE_NAME}' s indexom 'userMonthYear' vytvoren√Ω.`); } else { console.log(`[DB] Object store '${PENDING_STORE_NAME}' u≈æ existuje.`); } }; }); }
    async function addPendingSync(data) { /* ... k√≥d z predch√°dzaj√∫cej odpovede s vylep≈°en√Ωm logovan√≠m ... */ const db = await openDB(); const transaction = db.transaction(PENDING_STORE_NAME, 'readwrite'); const store = transaction.objectStore(PENDING_STORE_NAME); const index = store.index('userMonthYear'); const keyRange = IDBKeyRange.only([data.userId, data.year, data.month]); return new Promise((resolve, reject) => { let existingRecordKey = null; const cursorRequest = index.openKeyCursor(keyRange); cursorRequest.onsuccess = (event) => { const cursor = event.target.result; if (cursor) { existingRecordKey = cursor.primaryKey; console.log(`[DB] N√°jden√Ω existuj√∫ci pending sync (ID: ${existingRecordKey}) pre ${data.userId}/${data.year}-${data.month}. Bude prep√≠san√Ω.`); proceedWithDeleteAndAdd(); return; } proceedWithAddOnly(); }; cursorRequest.onerror = (event) => { console.error("[DB] Chyba pri hƒæadan√≠ existuj√∫cich pending sync (openKeyCursor):", event.target.error, "Pok√∫≈°am sa prida≈• d√°ta:", JSON.stringify(data)); reject("Chyba hƒæadania v IDB: " + event.target.error); }; function proceedWithDeleteAndAdd() { const deleteRequest = store.delete(existingRecordKey); deleteRequest.onsuccess = () => { console.log(`[DB] Star√Ω pending sync (ID: ${existingRecordKey}) vymazan√Ω.`); proceedWithAddOnly(); }; deleteRequest.onerror = (e) => { console.error(`[DB] Chyba mazania star√©ho pending sync (ID: ${existingRecordKey}):`, e.target.error); proceedWithAddOnly(); }; } function proceedWithAddOnly() { const requestAdd = store.add(data); requestAdd.onsuccess = () => { console.log(`[DB] √öSPECH: Nov√Ω pending sync pridan√Ω/aktualizovan√Ω s ID: ${requestAdd.result} pre ${data.userId}/${data.year}-${data.month}. D√°ta (zaƒçiatok):`, JSON.stringify(data.dataToSync.data.slice(0,1)) + "..."); resolve(requestAdd.result); }; requestAdd.onerror = (e) => { console.error("[DB] CHYBA: Chyba pridania pending sync:", e.target.error, "Pok√∫≈°al som sa prida≈• d√°ta (zaƒçiatok):", JSON.stringify(data).substring(0, 200) + "..."); reject("Chyba pridania pending sync: " + e.target.error); }; } transaction.oncomplete = () => console.log("[DB] Transakcia (addPendingSync) dokonƒçen√°."); transaction.onerror = (e) => console.error("[DB] Chyba transakcie (addPendingSync):", e.target.error); }); }
    async function clearPendingSyncForMonth(userId, year, month) { /* ... k√≥d z predch√°dzaj√∫cej odpovede ... */ console.log(`[DB] Pokus o vymazanie pending sync pre ${userId}/${year}-${month}`); try { const db = await openDB(); const transaction = db.transaction(PENDING_STORE_NAME, 'readwrite'); const store = transaction.objectStore(PENDING_STORE_NAME); const index = store.index('userMonthYear'); const keyRange = IDBKeyRange.only([userId, year, month]); const cursorRequest = index.openKeyCursor(keyRange); cursorRequest.onsuccess = (event) => { const cursor = event.target.result; if (cursor) { console.log(`[DB] Vymaz√°vam pending sync (ID: ${cursor.primaryKey}) pre ${userId}/${year}-${month}`); store.delete(cursor.primaryKey); cursor.continue(); } else { console.log(`[DB] Pre ${userId}/${year}-${month} neboli n√°jden√© ≈æiadne pending syncs na vymazanie.`); } }; cursorRequest.onerror = (event) => { console.error(`[DB] Chyba pri hƒæadan√≠/mazan√≠ pending sync pre mesiac (${userId}/${year}-${month}):`, event.target.error); }; transaction.oncomplete = () => { console.log(`[DB] Transakcia pre vymazanie pending sync pre ${userId}/${year}-${month} dokonƒçen√°.`); }; transaction.onerror = (event) => { console.error(`[DB] Chyba transakcie pri mazan√≠ pending sync pre ${userId}/${year}-${month}:`, event.target.error); } } catch (error) { console.error(`[DB] V≈°eobecn√° chyba v clearPendingSyncForMonth pre ${userId}/${year}-${month}:`, error); } }
    function getMonthName(monthIndex) { const months = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return months[monthIndex] || ''; }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Mesiac alebo rok nie s√∫ definovan√©, pou≈æ√≠vam aktu√°lny d√°tum."); return new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate(); } return new Date(currentYear, month + 1, 0).getDate(); }
    function updateGreeting() { const nameToUse = employeeName || localStorage.getItem('employeeName') || ''; if (nameToUse && mainTitleElement) { mainTitleElement.textContent = `Vitaj sp√§≈• ${nameToUse.split(' ')[0]} üëã`; } else if (mainTitleElement) { mainTitleElement.textContent = 'Doch√°dzka üëã'; } if (subTitleElement) { subTitleElement.textContent = `${getMonthName(currentMonth)} ${currentYear}`; } }
    function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; if (yearSelect) { yearSelect.innerHTML = ''; for (let y = startYear; y <= endYear; y++) { const option = document.createElement('option'); option.value = y; option.textContent = y; yearSelect.appendChild(option); } yearSelect.value = currentYear; } }
    function loadInitialSettings() { hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10; taxRate = (parseFloat(localStorage.getItem('taxRatePercent')) || 2) / 100; decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2; employeeName = localStorage.getItem('employeeName') || ''; currentMonth = parseInt(localStorage.getItem('currentMonth')) || new Date().getMonth(); currentYear = parseInt(localStorage.getItem('currentYear')) || new Date().getFullYear(); if(monthSelect) monthSelect.value = currentMonth; if(yearSelect) yearSelect.value = currentYear; if(decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces; if(employeeNameInput) employeeNameInput.value = employeeName; if(hourlyWageInput) hourlyWageInput.value = hourlyWage.toFixed(1); if(taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1); updateGreeting(); }
    function isOnline() { return navigator.onLine; }
    function showStatusNotification(message, color = '#007bff', duration = 3000) { const n = document.createElement('div'); n.textContent = message; n.style.cssText = `position:fixed; top:20px; right:20px; padding:10px 20px; border-radius:5px; background-color:${color}; color:white; z-index:10001; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition: opacity 0.5s; opacity: 0;`; document.body.appendChild(n); setTimeout(() => n.style.opacity = '1', 10); setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 500); }, duration); }
    function showErrorNotification(message) { const n = document.getElementById('errorNotification'); if(n) {n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 4000);} else {console.error("Error notification element not found!", message)} }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') { const n = document.getElementById('saveNotification'); if(n) {n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 3000);} else {console.log("Save notification:", message)} }
    function mapFirebaseAuthError(code) { const map = {'auth/invalid-email':'Neplatn√Ω email.','auth/user-not-found':'Pou≈æ√≠vateƒæ nen√°jden√Ω.','auth/wrong-password':'Nespr√°vne heslo.','auth/email-already-in-use':'Email u≈æ existuje.','auth/weak-password':'Slab√© heslo.','auth/requires-recent-login':'Vy≈æaduje sa nov√© prihl√°senie.','auth/network-request-failed':'Chyba siete.','auth/missing-email':'Zadajte email.'}; return map[code] || code; }
    async function createUserCollection() { if (!auth.currentUser) return; const uRef = doc(db, 'users', auth.currentUser.uid); try { await setDoc(uRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true }); const iRef = doc(collection(uRef, 'workDays'), 'initial_setup'); await setDoc(iRef, { setupComplete: true }); } catch (err) { console.error('Chyba vytvorenia user kolekcie:', err); } }
    function createTable() { console.log(`Vytv√°ram tabuƒæku pre ${getMonthName(currentMonth)} ${currentYear}`); if (!workDaysTableBody) { console.error("Element tbody#workDays nebol n√°jden√Ω!"); return; } workDaysTableBody.innerHTML = ''; const daysInMonth = getDaysInMonth(currentMonth); const todayFull = new Date(); const todayDate = todayFull.getDate(); const todayMonth = todayFull.getMonth(); const todayYear = todayFull.getFullYear(); for (let i = 1; i <= daysInMonth; i++) { const row = workDaysTableBody.insertRow(); if (i === todayDate && currentMonth === todayMonth && currentYear === todayYear) { row.classList.add('current-day'); } const dayName = getDayName(currentYear, currentMonth, i); const ids = { start: `start-${currentYear}-${currentMonth}-${i}`, end: `end-${currentYear}-${currentMonth}-${i}`, break: `break-${currentYear}-${currentMonth}-${i}`, note: `note-${currentYear}-${currentMonth}-${i}`, total: `total-${currentYear}-${currentMonth}-${i}`, gross: `gross-${currentYear}-${currentMonth}-${i}`, net: `net-${currentYear}-${currentMonth}-${i}` }; row.innerHTML = `<td>${i}. ${dayName}</td><td><div class="time-input-wrapper"><input type="tel" id="${ids.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="window.handleInput(this, '${ids.end}')"><span class="clock-icon" onclick="window.insertCurrentTime('${ids.start}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span></div></td><td><div class="time-input-wrapper"><input type="tel" id="${ids.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="window.handleInput(this, '${ids.break}')"><span class="clock-icon" onclick="window.insertCurrentTime('${ids.end}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span></div></td><td><input type="number" id="${ids.break}" min="0" step="0.5" placeholder="hod." oninput="window.handleBreakInput(${i})"></td><td id="${ids.total}">-</td><td><textarea id="${ids.note}" placeholder="Pozn√°mka" oninput="window.calculateAndUpdateTotals()" rows="1"></textarea></td><td><input type="number" id="${ids.gross}" readonly></td><td><input type="number" id="${ids.net}" readonly></td><td><button class="btn reset-btn" onclick="window.resetRow(${i})">X</button></td>`; } }
    function parseAndApplyData(dataString) { try { const sData = JSON.parse(dataString); console.log("parseAndApplyData - prijat√© d√°ta:", sData); hourlyWage = parseFloat(sData.hourlyWage) ?? hourlyWage; employeeName = String(sData.employeeName) ?? employeeName; decimalPlaces = parseInt(sData.decimalPlaces) ?? decimalPlaces; let loadedTaxRate = sData.taxRate; if (loadedTaxRate !== undefined && loadedTaxRate !== null) { taxRate = parseFloat(loadedTaxRate); } if(hourlyWageInput) hourlyWageInput.value = hourlyWage.toFixed(1); if(taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1); if(employeeNameInput) employeeNameInput.value = employeeName; if(decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces; localStorage.setItem('hourlyWage', hourlyWage.toString()); localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1)); localStorage.setItem('employeeName', employeeName); localStorage.setItem('decimalPlaces', decimalPlaces.toString()); updateGreeting(); if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) { console.warn("parseAndApplyData: Tabuƒæka nebola inicializovan√°, vytv√°ram ju."); createTable(); } const daysInMonth = getDaysInMonth(currentMonth); if (sData.data && Array.isArray(sData.data)) { const daysToProcess = Math.min(daysInMonth, sData.data.length); for (let i = 0; i < daysToProcess; i++) { const dayData = sData.data[i]; const dayIndex = i + 1; const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`); const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`); const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${dayIndex}`); if (startEl && endEl && breakEl) { startEl.value = dayData.start || ''; endEl.value = dayData.end || ''; breakEl.value = dayData.breakTime || ''; if (noteEl) noteEl.value = dayData.note || ''; calculateRow(dayIndex); } } for (let i = daysToProcess + 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { _resetRowInternal(i, false, false); } } } else { console.log("parseAndApplyData: V d√°tach nie s√∫ ≈æiadne z√°znamy pre dni, resetujem tabuƒæku."); for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { _resetRowInternal(i, false, false); } } } calculateTotal(); } catch (err) { showErrorNotification(`Chyba spracovania prijat√Ωch d√°t: ${err.message}`); console.error("Chyba v parseAndApplyData:", err, "Data string:", dataString); loadInitialSettings(); if (workDaysTableBody && workDaysTableBody.hasChildNodes()) { const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { _resetRowInternal(i, false, false); } } } else if (workDaysTableBody) { createTable(); } calculateTotal(); } }
    function loadFromLocalStorageOnly() { const localKey = `workData-${currentYear}-${currentMonth}`; const localData = localStorage.getItem(localKey); if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) { createTable(); } if (localData) { console.log(`Naƒç√≠tavam d√°ta z lok√°lneho √∫lo≈æiska (workData) pre ${getMonthName(currentMonth)} ${currentYear}.`); parseAndApplyData(localData); } else { console.log(`V lok√°lnom √∫lo≈æisku (workData) sa nena≈°li ≈æiadne d√°ta pre ${getMonthName(currentMonth)} ${currentYear}. Resetujem UI.`); const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { _resetRowInternal(i, false, false); } } calculateTotal(); } }
    async function setupFirestoreListener() { if (firestoreListenerUnsubscribe) { console.log('Odhlasujem existuj√∫ci Firestore listener.'); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; } if (!currentUser) { console.log('Nie je prihl√°sen√Ω pou≈æ√≠vateƒæ, Firestore listener sa nenastavuje.'); loadFromLocalStorageOnly(); if (loaderElement) loaderElement.style.display = 'none'; return; } if (!isOnline()) { console.log('Aplik√°cia je offline, Firestore listener sa nenastavuje. Zobrazujem lok√°lne d√°ta.'); loadFromLocalStorageOnly(); showStatusNotification('Ste offline. D√°ta sa zosynchronizuj√∫ po pripojen√≠, ak s√∫ nejak√© ƒçakaj√∫ce.', '#ffc107', 5000); if (loaderElement) loaderElement.style.display = 'none'; return; } const docPath = `users/${currentUser.uid}/workDays/${currentYear}-${currentMonth}`; const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`); console.log(`Nastavujem Firestore listener pre: ${docPath} (UID: ${currentUser.uid})`); if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) { console.log("Tabuƒæka je pr√°zdna, vytv√°ram ≈°trukt√∫ru pred nastaven√≠m listenera."); createTable(); } if (loaderElement) loaderElement.style.display = 'flex'; firestoreListenerUnsubscribe = onSnapshot(docRef, (docSnap) => { if (loaderElement) loaderElement.style.display = 'none'; console.log(`Firestore listener (${docRef.path}): Prijat√© d√°ta pre:`, docSnap.id, '| Pending writes:', docSnap.metadata.hasPendingWrites); const currentLocalDataKey = `workData-${currentYear}-${currentMonth}`; if (docSnap.exists()) { const serverData = docSnap.data(); const serverDataString = JSON.stringify(serverData); console.log(`Firestore listener (${docRef.path}): Dokument existuje, aplikujem d√°ta.`); localStorage.setItem(currentLocalDataKey, serverDataString); parseAndApplyData(serverDataString); if (currentUser) { clearPendingSyncForMonth(currentUser.uid, currentYear, currentMonth).catch(err => console.error("Chyba pri ƒçisten√≠ pending sync z listenera:", err)); } if (!docSnap.metadata.hasPendingWrites) { console.log(`Firestore listener (${docRef.path}): D√°ta automaticky aktualizovan√© zo servera.`); } } else { console.log(`Firestore listener (${docRef.path}): Dokument neexistuje. ƒåist√≠m lok√°lne d√°ta.`); localStorage.removeItem(currentLocalDataKey); if (workDaysTableBody) { const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { _resetRowInternal(i, false, false); } } } loadInitialSettings(); calculateTotal(); updateGreeting(); if (!docSnap.metadata.hasPendingWrites) { showErrorNotification('D√°ta pre tento mesiac boli na serveri odstr√°nen√© alebo neexistuj√∫.'); } } }, (error) => { if (loaderElement) loaderElement.style.display = 'none'; console.error(`Chyba vo Firestore listeneri (${docRef.path}): `, error); showErrorNotification(`Chyba pri poƒç√∫van√≠ zmien z Firebase: ${error.message}`); if (firestoreListenerUnsubscribe) { firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; } loadFromLocalStorageOnly(); }); }
    function debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; }
    async function saveToFirestore() { const saveDataFromUI = collectCurrentData(); const localWorkDataKey = `workData-${currentYear}-${currentMonth}`; localStorage.setItem(localWorkDataKey, JSON.stringify(saveDataFromUI)); if (!currentUser) { console.log('Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω. D√°ta ulo≈æen√© iba lok√°lne (workData). Synchroniz√°cia preskoƒçen√°.'); return; } if (!isOnline()) { console.log('Aplik√°cia je offline. Uklad√°m d√°ta do IndexedDB pre synchroniz√°ciu na pozad√≠.'); try { const pendingData = { userId: currentUser.uid, year: currentYear, month: currentMonth, dataToSync: saveDataFromUI }; await addPendingSync(pendingData); showErrorNotification('Ste offline. D√°ta ulo≈æen√© lok√°lne, zosynchronizuj√∫ sa po pripojen√≠.'); if ('serviceWorker' in navigator && 'SyncManager' in window) { navigator.serviceWorker.ready.then(swReg => swReg.sync.register('sync-pending-data-idb')) .then(() => console.log('Background sync (IDB) zaregistrovan√Ω.')) .catch(err => console.error('Chyba registr√°cie background sync (IDB):', err)); } } catch (error) { console.error("Chyba pri ukladan√≠ do IndexedDB:", error); showErrorNotification("Chyba pri lok√°lnom ukladan√≠ d√°t pre offline synchroniz√°ciu."); } return; } try { console.log(`Uklad√°m d√°ta do Firestore pre ${currentUser.uid}/${currentYear}-${currentMonth}`); const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`); await setDoc(docRef, saveDataFromUI, { merge: true }); await clearPendingSyncForMonth(currentUser.uid, currentYear, currentMonth); showSaveNotification('D√°ta √∫spe≈°ne zosynchronizovan√© s Firebase.'); } catch (err) { showErrorNotification(`Chyba ukladania do Firebase: ${err.message}. D√°ta ulo≈æen√© lok√°lne.`); try { const pendingData = { userId: currentUser.uid, year: currentYear, month: currentMonth, dataToSync: saveDataFromUI }; await addPendingSync(pendingData); if ('serviceWorker' in navigator && 'SyncManager' in window) { navigator.serviceWorker.ready.then(swReg => swReg.sync.register('sync-pending-data-idb')) .catch(syncErr => console.error('Chyba registr√°cie background sync (IDB) po chybe ukladania:', syncErr)); } } catch (idbError) { console.error("Chyba pri ukladan√≠ do IndexedDB po ne√∫spe≈°nom online z√°pise:", idbError); } } }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1500);
    function collectCurrentData() { const sData = { data: [], hourlyWage: parseFloat(hourlyWage), taxRate: parseFloat(taxRate), employeeName: String(employeeName), decimalPlaces: parseInt(decimalPlaces), lastUpdated: new Date().toISOString() }; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const s = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || ''; const e = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || ''; const b = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || ''; const note = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value || ''; const g = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0'; const n = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0'; sData.data.push({ start: s, end: e, breakTime: b, note: note, gross: g, net: n }); } return sData; }
    async function syncWithFirebase() { if (!currentUser || !isOnline()) { return; } console.warn("Funkcia syncWithFirebase (klient) je st√°le pr√≠tomn√°, ale pre IndexedDB by mal prim√°rne fungova≈• Service Worker a jeho 'sync' event. Zv√°≈æte jej √∫pravu alebo odstr√°nenie, ak SW funguje spoƒæahlivo."); }
    function isValidTimeFormat(timeString) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
    function formatAndMoveNext(input, nextId) { let value = input.value.replace(/[^\d:]/g, ''); let originalValue = input.value; let cursorPos = input.selectionStart; if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value += ':'; } else if (value.length === 4 && !value.includes(':')) { value = `${value.substring(0, 2)}:${value.substring(2)}`; } else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = `${value.substring(0, 2)}:${value.substring(2)}`; } value = value.replace(/^:/, ''); if ((value.match(/:/g) || []).length > 1) { const parts = value.split(':'); value = `${parts[0]}:${parts.slice(1).join('')}`; } if (value.length > 5) { value = value.slice(0, 5); } if (input.value !== value) { input.value = value; try { if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); } else { input.setSelectionRange(cursorPos, cursorPos); } } catch (e) { /*ignore*/ } } const day = parseInt(input.id.split('-')[3]); calculateRow(day); if (value.length === 5 && isValidTimeFormat(value)) { if (nextId) { moveNext(input, nextId); } } }
    function moveNext(currentElement, nextInputId) { const nextElement = document.getElementById(nextInputId); if (nextElement) { nextElement.focus(); if (nextElement.tagName === 'INPUT' && nextElement.type === 'tel') { nextElement.select(); } } }
    function calculateRow(day) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return; const startTime = startInput.value; const endTime = endInput.value; const breakTimeHours = parseFloat(breakInput.value) || 0; if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) { totalCell.textContent = '-'; grossInput.value = ''; netInput.value = ''; return; } const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number); const startDate = new Date(2000, 0, 1, startHours, startMinutes); let endDate = new Date(2000, 0, 1, endHours, endMinutes); if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); } let diffMinutes = (endDate.getTime() - startDate.getTime()) / 60000; diffMinutes -= (breakTimeHours * 60); if (diffMinutes < 0) { diffMinutes = 0; } const decimalHours = diffMinutes / 60; const totalMinutesRounded = Math.round(diffMinutes); const hours = Math.floor(totalMinutesRounded / 60); const minutes = totalMinutesRounded % 60; totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`; const grossSalary = Math.max(0, decimalHours * hourlyWage); grossInput.value = grossSalary.toFixed(decimalPlaces); updateNetSalary(day); }
    function updateNetSalary(day) { const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!grossInput || !netInput) return; const grossSalary = parseFloat(grossInput.value) || 0; const netSalary = Math.max(0, grossSalary * (1 - taxRate)); netInput.value = netSalary.toFixed(decimalPlaces); }
    function _resetRowInternal(day, save = true, promptUser = true) { if (promptUser) { if (!confirm("Naozaj chcete vynulova≈• √∫daje pre tento de≈à?")) { return; } } const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); if(start) start.value = ''; if(end) end.value = ''; if(breakEl) breakEl.value = ''; if(noteEl) noteEl.value = ''; calculateRow(day); if (save) { window.calculateAndUpdateTotals(); } }
    function calculateTotal() { let totalMinutes = 0; let totalGross = 0; let totalNet = 0; let daysWorked = 0; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value; const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value; const breakTime = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value) || 0; let dailyMinutes = 0; let dailyGross = 0; let dailyNet = 0; if (isValidTimeFormat(start) && isValidTimeFormat(end)) { const [sH, sM] = start.split(':').map(Number); const [eH, eM] = end.split(':').map(Number); const sDate = new Date(2000, 0, 1, sH, sM); let eDate = new Date(2000, 0, 1, eH, eM); if (eDate < sDate) { eDate.setDate(eDate.getDate() + 1); } let diffM = (eDate.getTime() - sDate.getTime()) / 60000 - (breakTime * 60); if (diffM < 0) diffM = 0; dailyMinutes = diffM; const dailyHours = dailyMinutes / 60; dailyGross = Math.max(0, dailyHours * hourlyWage); dailyNet = Math.max(0, dailyGross * (1 - taxRate)); daysWorked++; } totalMinutes += dailyMinutes; totalGross += dailyGross; totalNet += dailyNet; } const totalMinutesRounded = Math.round(totalMinutes); const totalHours = Math.floor(totalMinutesRounded / 60); const totalMinutesRemainder = totalMinutesRounded % 60; const totalDecimalHours = totalMinutes / 60; const avgNet = daysWorked > 0 ? totalNet / daysWorked : 0; const avgMinutes = daysWorked > 0 ? totalMinutes / daysWorked : 0; const avgMinutesRounded = Math.round(avgMinutes); const avgHours = Math.floor(avgMinutesRounded / 60); const avgMinsRemainder = avgMinutesRounded % 60; const avgDecimalHours = avgMinutes / 60; if (totalSalaryDiv) totalSalaryDiv.innerHTML = `Zapoƒç√≠tan√Ωch dn√≠: ${daysWorked}<br>Celkov√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>Hrub√° mzda: ${totalGross.toFixed(decimalPlaces)} ‚Ç¨<br>ƒåist√° mzda: ${totalNet.toFixed(decimalPlaces)} ‚Ç¨<br>Priem. ƒçist√° mzda/de≈à: ${avgNet.toFixed(decimalPlaces)} ‚Ç¨<br><strong>Priem. ƒças/de≈à: ${avgHours}h ${avgMinsRemainder}m (${avgDecimalHours.toFixed(decimalPlaces)} h)</strong>`; }
    
    // --- Priradenie k window objektu (MUS√ç BY≈§ PO DEFIN√çCI√ÅCH) ---
    window.login = login;
    window.register = register;
    window.logout = logout;
    window.resetPassword = resetPassword;
    window.changeMonth = changeMonth;
    window.changeYear = changeYear;
    window.insertCurrentTime = insertCurrentTime;
    window.handleInput = handleInput;
    window.handleBreakInput = handleBreakInput;
    window.calculateAndUpdateTotals = calculateAndUpdateTotals;
    window.resetRow = _resetRowInternal; // Priradenie _resetRowInternal priamo k window.resetRow
    window.loadFromFirestore = loadFromFirestore;
    window.updateEmployeeName = updateEmployeeName;
    window.updateSettings = updateSettings;
    window.changeDecimalPlaces = changeDecimalPlaces;
    window.exportToPDF = exportToPDF;
    window.sendPDF = sendPDF;
    window.restoreBackup = restoreBackup;
    window.createBackup = createBackup;

    // Hlavn√° inicializaƒçn√° funkcia aplik√°cie
    function initializeAppState() {
        console.log("Sp√∫≈°≈•am initializeAppState...");
        if (loaderElement) loaderElement.style.display = 'flex';
        
        populateYearSelect(); // Najprv napl≈à roky
        loadInitialSettings(); // Potom naƒç√≠taj nastavenia (vr√°tane currentYear/Month z localStorage)

        onAuthStateChanged(auth, (user) => {
            console.log("onAuthStateChanged - user:", user ? user.uid : '≈æiadny pou≈æ√≠vateƒæ');
            currentUser = user;

            // Tieto UI zmeny by mali nasta≈• v≈ædy, keƒè sa zmen√≠ auth stav
            if (loginFormElement) loginFormElement.style.display = currentUser ? 'none' : 'flex';
            if (userInfoElement) userInfoElement.style.display = currentUser ? 'flex' : 'none';
            if (userEmailElement) userEmailElement.textContent = currentUser ? `Prihl√°sen√Ω: ${currentUser.email}` : '';

            if (workDaysTableBody) workDaysTableBody.innerHTML = ''; // V≈ædy vyƒçisti tabuƒæku
            createTable(); // A v≈ædy vytvor nov√∫ ≈°trukt√∫ru

            if (currentUser) {
                console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem Firestore listener.");
                setupFirestoreListener(); // Toto sa postar√° o naƒç√≠tanie d√°t a skrytie loadera
            } else {
                if (firestoreListenerUnsubscribe) {
                    console.log('Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω / odhl√°sil sa, odhlasujem Firestore listener.');
                    firestoreListenerUnsubscribe();
                    firestoreListenerUnsubscribe = null;
                }
                loadFromLocalStorageOnly(); // Naƒç√≠taj lok√°lne d√°ta (ak nejak√© s√∫)
                if (!isOnline()) {
                     showErrorNotification('Ste offline. Niektor√© funkcie m√¥≈æu by≈• obmedzen√©.');
                }
                // Ak nie je user a listener sa nenastavuje, skry loader tu
                if (loaderElement) {
                    console.log("Skr√Ωvam loader (≈æiadny pou≈æ√≠vateƒæ, ≈æiadny listener).");
                    loaderElement.style.display = 'none';
                }
            }
            updateGreeting(); // Aktualizuj pozdrav a podnadpis mesiaca/roka
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded: Sp√∫≈°≈•am inicializ√°ciu aplik√°cie.");
        initializeAppState();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
              if (event.data && event.data.type === 'TRIGGER_SYNC_FROM_SW') {
                console.log('Main App: Prijat√° spr√°va TRIGGER_SYNC_FROM_SW od Service Workera.');
                if (isOnline() && currentUser) {
                  showStatusNotification('Synchroniz√°cia d√°t spusten√° na pozad√≠ Service Workerom...', '#007bff');
                  // syncWithFirebase() by teraz mal pracova≈• s IndexedDB, alebo sa spoliehame ƒçisto na SW
                  // Ak SW funguje, toto volanie nemus√≠ by≈• nutn√© alebo by malo by≈• upraven√©.
                } else {
                  console.log('Main App: Podmienky pre synchroniz√°ciu (online & prihl√°sen√Ω) nie s√∫ splnen√© po spr√°ve od SW.');
                }
              }
            });
        }
        // Fallback pre skrytie loadera, ak by sa nieƒço zaseklo v inicializ√°cii
        setTimeout(() => {
            if (loaderElement && getComputedStyle(loaderElement).display !== 'none') {
                console.warn("Fallback: Loader bol st√°le viditeƒæn√Ω po 5 sekund√°ch, n√∫tene skr√Ωvam.");
                loaderElement.style.display = 'none';
            }
        }, 5000);
    });

    // PWA in≈°talaƒçn√° logika
    let deferredPrompt; 
    const installButtonContainer = document.querySelector('.btn-container'); 
    window.addEventListener('beforeinstallprompt', (e) => { console.log('beforeinstallprompt udalos≈• zachyten√°'); e.preventDefault(); deferredPrompt = e; const installButtonId = 'installAppButton'; let installButton = document.getElementById(installButtonId); if (!installButton) { installButton = document.createElement('button'); installButton.id = installButtonId; installButton.classList.add('btn'); installButton.textContent = 'Nain≈°talova≈• Doch√°dzku'; if (installButtonContainer && installButtonContainer.lastChild) { installButtonContainer.insertBefore(installButton, installButtonContainer.lastChild.nextSibling); } else if (installButtonContainer) { installButtonContainer.appendChild(installButton); } else { console.warn('.btn-container nebol n√°jden√Ω pre in≈°talaƒçn√© tlaƒçidlo.'); } console.log('In≈°talaƒçn√© tlaƒçidlo pridan√©.'); } installButton.style.display = 'block'; installButton.onclick = async () => { console.log('Kliknut√© na in≈°talaƒçn√© tlaƒçidlo'); if (deferredPrompt) { installButton.style.display = 'none'; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; console.log(`Odpoveƒè na in≈°tal√°ciu: ${outcome}`); deferredPrompt = null; } else { console.log('deferredPrompt nie je dostupn√Ω.'); } }; }); 
    window.addEventListener('appinstalled', () => { console.log('PWA bola nain≈°talovan√°'); const installButton = document.getElementById('installAppButton'); if (installButton) { installButton.style.display = 'none'; } deferredPrompt = null; });
  </script>

  <script>
    // Service Worker registr√°cia
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registr√°cia √∫spe≈°n√°, scope: ', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker registr√°cia zlyhala: ', error);
          });
      });
    }
  </script>
</body>
</html>
