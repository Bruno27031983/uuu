<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator - Vylepšená Verzia</title> <!-- Zmenený titulok -->

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <style>
    /* Základné štýly - bez zmien */
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2#employeeSubtitle { /* ID pre dynamický nadpis */
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
      min-height: 1.5em; /* Rezerva miesta */
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle; /* Zarovnanie na stred vertikálne */
    }
    th {
      background-color: #f2f2f2;
    }
    /* Šírky stĺpcov - upravené pre konzistentnosť */
    th:nth-child(1), td:nth-child(1) { width: 15%; } /* Deň */
    th:nth-child(2), td:nth-child(2) { width: 10%; } /* Príchod */
    th:nth-child(3), td:nth-child(3) { width: 10%; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 10%; } /* Prestávka */
    th:nth-child(5), td:nth-child(5) { width: 15%; } /* Odpracované */
    th:nth-child(6), td:nth-child(6) { width: 12.5%; } /* Hrubá */
    th:nth-child(7), td:nth-child(7) { width: 12.5%; } /* Čistá */
    th:nth-child(8), td:nth-child(8) { width: 15%; text-align: center; } /* Akcia */

    input[type="tel"], input[type="number"], input[type="text"], select { /* Pridaný select */
      width: 100%;
      padding: 6px; /* Mierne zväčšené */
      box-sizing: border-box;
      background-color: #ffffd0; /* Svetložltá pre editovateľné */
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
     input:focus, select:focus { /* Zvýraznenie pri focuse */
        border-color: #8a2be2;
        box-shadow: 0 0 5px rgba(138, 43, 226, 0.3);
        outline: none;
     }
    input[readonly] { /* Štýl pre readonly polia */
        background-color: #eee; /* Svetlo šedá */
        cursor: not-allowed;
        font-style: italic;
    }

    .result {
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between; /* Lepšie rozloženie */
      gap: 10px; /* Medzery medzi tlačidlami */
      margin-top: 20px;
    }
    .btn {
      flex: 1 1 150px; /* Flexibilita s minimálnou šírkou */
      padding: 10px 15px; /* Konzistentný padding */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px; /* Mierne menšie pre lepšie zalomenie */
      margin: 0; /* Odstránený margin, použije sa gap */
      transition: background-color 0.3s ease, transform 0.1s ease;
      text-align: center;
    }
    .btn:active {
        transform: scale(0.98); /* Efekt stlačenia */
    }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; } /* Záloha fialová */
    .backup-btn:hover { background-color: #6a1bb2; }
    .restore-btn { background-color: #ff9800; } /* Obnova oranžová */
    .restore-btn:hover { background-color: #f57c00; }
    .firebase-load-btn { background-color: #03A9F4; } /* Firebase modrá */
    .firebase-load-btn:hover { background-color: #0288D1; }
    .dark-mode-btn { background-color: #607D8B; } /* Tmavý režim šedá */
    .dark-mode-btn:hover { background-color: #455A64; }

    #totalSalary {
      font-size: 16px; /* Mierne menšie pre viac info */
      font-weight: bold;
      text-align: left; /* Zarovnanie vľavo pre lepší prehľad */
      margin-top: 20px;
      padding: 15px; /* Viac paddingu */
      background-color: #e6f3ff;
      border-radius: 5px;
      border-left: 5px solid #8a2be2; /* Zvýraznenie naľavo */
      line-height: 1.8; /* Väčšie riadkovanie */
    }
    /* Data size bar odstránený pre jednoduchosť, fokus na funkčnosť */

    .current-day {
      background-color: #e8dff5 !important; /* Jemnejšia fialová pre svetlý režim */
    }
    .current-day td:first-child {
        font-weight: bold;
    }
    .current-day input {
      background-color: #f5eefd !important; /* Ešte svetlejšia pre inputy */
      border-color: #8a2be2;
    }
    /* --- Tmavý režim --- */
    body.dark-mode {
      background-color: #212121; /* Tmavšia šedá */
      color: #e0e0e0; /* Svetlejšia šedá pre text */
    }
    body.dark-mode .container {
      background-color: #333;
      color: #e0e0e0;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    body.dark-mode h2#employeeSubtitle { color: #bdbdbd; }
    body.dark-mode table { background-color: #424242; color: #e0e0e0; }
    body.dark-mode th { background-color: #555; border-color: #616161; }
    body.dark-mode td { background-color: #424242; border-color: #616161; }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select {
      background-color: #616161;
      color: #ffffff;
      border-color: #757575;
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
        border-color: #c6a7ff;
        box-shadow: 0 0 5px rgba(198, 167, 255, 0.4);
    }
    body.dark-mode input[readonly] {
        background-color: #555; /* Tmavšia šedá pre readonly */
        color: #bdbdbd; /* Sivý text */
    }
    /* Tlačidlá v tmavom režime - svetlejšie farby pre kontrast */
    body.dark-mode .reset-btn { background-color: #e57373; }
    body.dark-mode .reset-btn:hover { background-color: #ef5350; }
    body.dark-mode .export-btn { background-color: #81c784; }
    body.dark-mode .export-btn:hover { background-color: #66bb6a; }
    body.dark-mode .backup-btn { background-color: #ba68c8; }
    body.dark-mode .backup-btn:hover { background-color: #ab47bc; }
    body.dark-mode .restore-btn { background-color: #ffb74d; }
    body.dark-mode .restore-btn:hover { background-color: #ffa726; }
    body.dark-mode .firebase-load-btn { background-color: #64b5f6; }
    body.dark-mode .firebase-load-btn:hover { background-color: #42a5f5; }
    body.dark-mode .dark-mode-btn { background-color: #90a4ae; }
    body.dark-mode .dark-mode-btn:hover { background-color: #78909c; }
    /* Farby tlačidiel v tmavom režime - môžu potrebovať doladiť pre čitateľnosť textu */
    body.dark-mode .btn { color: #212121; /* Tmavý text na svetlých tlačidlách */ }

    body.dark-mode #totalSalary {
      background-color: #2c3e50;
      border-left-color: #ab47bc; /* Sýtejšia fialová */
    }
    body.dark-mode .current-day {
      background-color: #4a0e8f !important; /* Sýta fialová pre aktuálny deň */
    }
    body.dark-mode .current-day input {
      background-color: #5c1db3 !important; /* Trochu svetlejšia fialová pre input */
    }

    @keyframes gradientText { /* Bez zmien */
      0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse { /* Bez zmien */
      0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); }
      50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); }
    }

    /* --- Responzívne úpravy --- */
    @media (max-width: 992px) { /* Pridaný breakpoint pre tablety */
        .settings > div {
            flex-basis: calc(50% - 10px); /* Dva stĺpce v nastaveniach */
        }
        .btn {
             flex-basis: calc(33% - 10px); /* Tri tlačidlá na riadok */
             font-size: 14px;
        }
        table { min-width: 700px; } /* Zmenšená min šírka */
        th, td { padding: 6px; font-size: 0.85em; }
    }

    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2#employeeSubtitle { font-size: 1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div { flex-basis: auto; margin: 8px 0; } /* Nastavenia pod sebou */
      .btn-container { flex-direction: column; align-items: stretch; } /* Tlačidlá pod sebou */
      .btn { flex-basis: auto; margin: 5px 0; font-size: 14px; } /* Tlačidlá pod sebou */
      #totalSalary { font-size: 15px; }
      table { min-width: 650px; } /* Ešte menšia min šírka */
      th, td { padding: 5px; font-size: 0.8em; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      th, td { font-size: 0.75em; }
      .btn { font-size: 13px; padding: 8px 12px; }
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 13px; padding: 5px; }
      table { min-width: 600px; } /* Minimálna šírka pre mobily */
    }

    /* --- Notifikácie --- */
    #notification-area { /* Kontajner pre notifikácie */
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1001;
        width: 300px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .notification {
        padding: 12px 18px;
        border-radius: 5px;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateX(100%);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
    }
    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }
    .notification.success { background-color: #4CAF50; }
    .notification.error { background-color: #f44336; }
    .notification.info { background-color: #2196F3; }
    .notification.warning { background-color: #ff9800; }

    /* --- Status pripojenia --- */
     #connection-status {
        position: fixed;
        bottom: 10px;
        left: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
        z-index: 1000;
        opacity: 0.8;
     }
     #connection-status.online { background-color: #4CAF50; color: white; }
     #connection-status.offline { background-color: #f44336; color: white; }

    #login-form { /* Centrovanie formulára */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
        width: 250px; /* Trochu širšie */
        max-width: 90%;
        padding: 8px;
    }
     #login-form div { /* Kontajner pre login/register tlačidlá */
         display: flex;
         gap: 10px;
     }
    #login-form .btn {
        width: 120px;
        flex-grow: 1; /* Aby sa roztiahli, ak je miesto */
    }
    #user-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    #user-info span { font-weight: bold; }

  </style>
</head>
<body>
  <div class="container">
    <!-- Oblasť pre notifikácie -->
    <div id="notification-area"></div>
    <!-- Indikátor stavu pripojenia -->
    <div id="connection-status"></div>

    <!-- Autentifikačné UI -->
    <div id="auth-container">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <div>
            <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
            <button class="btn backup-btn" onclick="register()">Registrovať</button> <!-- Iná farba pre register -->
        </div>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="employeeSubtitle"></h2> <!-- Dynamicky menený podnadpis -->

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option> <option value="1">Február</option>
          <option value="2">Marec</option> <option value="3">Apríl</option>
          <option value="4">Máj</option> <option value="5">Jún</option>
          <option value="6">Júl</option> <option value="7">August</option>
          <option value="8">September</option> <option value="9">Október</option>
          <option value="10">November</option> <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Dynamicky generované roky -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinné miesta:</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option> <option value="2" selected>2</option> <!-- Predvolené 2 miesta -->
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn dark-mode-btn">Tmavý režim</button> <!-- Zmenená trieda -->
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary">Načítavam súčty...</div> <!-- Počiatočný text -->

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Export PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu (XLSX)</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu (XLSX)</button>
      <button class="btn firebase-load-btn" onclick="loadFromFirebase()">Načítať z Cloud</button>
    </div>
  </div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // POZNÁMKA: Kľúče by mali byť ideálne v konfiguračnom súbore alebo premenných prostredia, nie priamo v kóde.
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Váš API kľúč
      authDomain: "uuuuu-f7ef9.firebaseapp.com",
      projectId: "uuuuu-f7ef9",
      storageBucket: "uuuuu-f7ef9.appspot.com", // opravená koncovka
      messagingSenderId: "456105865458",
      appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    // Inicializácia Firebase
    let app, auth, db, appCheck;
    try {
        app = initializeApp(firebaseConfig);
        // Aktivácia App Check (neblokujúca)
        try {
            appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'), // Váš Site Key pre reCAPTCHA v3
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check inicializovaný.");
        } catch (e) {
             console.warn("Nepodarilo sa inicializovať Firebase App Check:", e);
             // Aplikácia bude fungovať aj bez App Check, ale je menej bezpečná
        }
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase inicializovaný úspešne.");
    } catch (error) {
        console.error("Kritická chyba pri inicializácii Firebase:", error);
        showNotification('Kritická chyba pri inicializácii Firebase. Skúste obnoviť stránku.', 'error', 0); // Permanentná chyba
    }


    // -------------------- GLOBÁLNE PREMENNÉ a DOM Elementy --------------------
    let currentUser = null;
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitle = document.getElementById('mainTitle');
    const employeeSubtitle = document.getElementById('employeeSubtitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const notificationArea = document.getElementById('notification-area');
    const connectionStatusDiv = document.getElementById('connection-status');
    const loginForm = document.getElementById('login-form');
    const userInfo = document.getElementById('user-info');
    const userEmailSpan = document.getElementById('user-email');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    // Načítanie nastavení z localStorage s predvolenými hodnotami
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces') || '2'); // Predvolené 2
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage') || hourlyWageInput.value);
    let taxRate = parseFloat(localStorage.getItem('taxRatePercentage') || taxRateInput.value) / 100;


    // -------------------- FUNKCIE PRE ROKY (select) --------------------
    function populateYearSelect() {
      const startYear = 2020;
      const endYear = new Date().getFullYear() + 2; // Aktuálny rok + 2 roky do budúcna
      yearSelect.innerHTML = ''; // Vyčistenie pre prípad opätovného volania
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }
    populateYearSelect();

    // Nastavenie predvolených hodnôt v UI
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    decimalPlacesSelect.value = decimalPlaces;
    employeeNameInput.value = employeeName;
    hourlyWageInput.value = hourlyWage;
    taxRateInput.value = (taxRate * 100).toFixed(1); // Zobraz percentá
    employeeSubtitle.textContent = employeeName ? `Pracovník: ${employeeName}` : 'Zadajte meno pracovníka';


    // -------------------- NOTIFIKÁCIE a STAV PRIPOJENIA --------------------
    function showNotification(message, type = 'info', duration = 3000) {
        if (!notificationArea) return;
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationArea.appendChild(notification);

        // Trigger transition
        setTimeout(() => notification.classList.add('show'), 10);

        if (duration > 0) {
            setTimeout(() => {
                notification.classList.remove('show');
                // Remove from DOM after transition ends
                notification.addEventListener('transitionend', () => notification.remove());
            }, duration);
        }
    }

    function updateConnectionStatus() {
        if (!connectionStatusDiv) return;
        if (navigator.onLine) {
            connectionStatusDiv.textContent = 'Online';
            connectionStatusDiv.className = 'online';
            // Po prechode do online režimu skús synchronizovať čakajúce dáta
            syncPendingData();
        } else {
            connectionStatusDiv.textContent = 'Offline';
            connectionStatusDiv.className = 'offline';
            showNotification('Ste v režime offline. Zmeny sa ukladajú lokálne.', 'warning');
        }
    }
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    // Initial status check
    updateConnectionStatus();


    // -------------------- AUTENTIFIKÁCIA (login, register, logout) --------------------
    window.login = async function() {
      if (!navigator.onLine) {
        showNotification('Prihlásenie nie je možné v režime offline.', 'error');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) {
          showNotification('Prosím, zadajte email aj heslo.', 'warning');
          return;
      }
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // currentUser sa nastaví cez onAuthStateChanged listener
        showNotification(`Vitajte späť, ${userCredential.user.email}!`, 'success');
      } catch (error) {
        console.error('Chyba pri prihlásení:', error);
        showNotification(`Chyba pri prihlásení: ${error.code} - ${error.message}`, 'error');
      }
    }

    window.register = async function() {
      if (!navigator.onLine) {
        showNotification('Registrácia nie je možná v režime offline.', 'error');
        return;
      }
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
       if (!email || !password) {
          showNotification('Prosím, zadajte email aj heslo pre registráciu.', 'warning');
          return;
      }
      if (password.length < 6) {
           showNotification('Heslo musí mať aspoň 6 znakov.', 'warning');
           return;
      }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        // Vytvorí počiatočný dokument pre užívateľa, ak treba (lepšie cez Cloud Functions, ale toto je jednoduchšie)
        await createUserProfileIfNeeded(userCredential.user);
        // currentUser sa nastaví cez onAuthStateChanged listener
        showNotification(`Registrácia úspešná pre ${userCredential.user.email}!`, 'success');
      } catch (error) {
        console.error('Chyba pri registrácii:', error);
        showNotification(`Chyba pri registrácii: ${error.code} - ${error.message}`, 'error');
      }
    }

    window.logout = async function() {
      try {
        await signOut(auth);
        // currentUser sa nastaví na null cez onAuthStateChanged
        showNotification('Boli ste úspešne odhlásený.', 'info');
        // Vymaže dáta z pamäte (ale nie z localStorage)
        // monthData = {}; // Možno nie je potrebné, necháme lokálne dáta
      } catch (error) {
        console.error('Chyba pri odhlásení:', error);
        showNotification('Chyba pri odhlásení: ' + error.message, 'error');
      }
    }

    async function createUserProfileIfNeeded(user) {
      if (!user) return;
      const userDocRef = doc(db, 'users', user.uid);
      try {
        const docSnap = await getDoc(userDocRef);
        if (!docSnap.exists()) {
          await setDoc(userDocRef, {
            email: user.email,
            createdAt: new Date(),
            // Môžu tu byť ďalšie profilové nastavenia
          });
          console.log('Vytvorený profil pre nového užívateľa:', user.uid);
        }
      } catch (error) {
          console.error('Chyba pri vytváraní/kontrole profilu užívateľa:', error);
          // Neprerušujeme chod aplikácie, len logujeme chybu
      }
    }

    // -------------------- RIADENIE UI a Načítanie Dát --------------------

    function updateUI() {
        // Vytvorí prázdnu štruktúru tabuľky pre aktuálny mesiac a rok
        createTableStructure();

        if (currentUser) {
            // Prihlásený užívateľ
            loginForm.style.display = 'none';
            userInfo.style.display = 'flex'; // Používame flex pre layout
            userEmailSpan.textContent = currentUser.email;
            loadInitialData(); // Načíta dáta (LS priorita, potom FS)
            syncPendingData(); // Skontroluje, či netreba niečo odoslať
        } else {
            // Neprihlásený užívateľ
            loginForm.style.display = 'flex'; // Používame flex pre layout
            userInfo.style.display = 'none';
            userEmailSpan.textContent = '';
            loadFromLocalStorageOnly(); // Načíta dáta iba z LS
            if (!navigator.onLine) {
                showNotification('Pracujete offline. Pre prístup ku cloudovým dátam sa prihláste, keď budete online.', 'info');
            }
        }
        // Aktualizuj podnadpis s menom pracovníka
        employeeSubtitle.textContent = employeeName ? `Pracovník: ${employeeName}` : 'Zadajte meno pracovníka';
        // Prepočíta celkové súčty (aj keby boli dáta prázdne)
        calculateTotal();
    }

    // Načítanie dát pri štarte (pre prihláseného usera)
    async function loadInitialData() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localDataString = localStorage.getItem(localKey);

        if (localDataString) {
            console.log(`Načítavam dáta pre ${currentYear}-${currentMonth} z localStorage (priorita).`);
            parseAndApplyData(localDataString);
            // Aj keď máme lokálne dáta, ak sme online, môžeme skontrolovať cloud pre prípad, že tam je niečo novšie
            // Alebo len necháme lokálnu verziu ako hlavnú a synchronizujeme PENDING zmeny
            if(navigator.onLine) {
                // Tu by mohla byť logika porovnania timestampov, ale pre jednoduchosť necháme lokálnu verziu
                 console.log("Lokálne dáta nájdené, neprepisujem z Firebase pri štarte.");
            }
        } else if (navigator.onLine && currentUser) {
            console.log(`LocalStorage pre ${currentYear}-${currentMonth} prázdny, pokúšam sa načítať z Firestore.`);
            await loadFromFirebase(false); // Voláme loadFromFirebase bez potvrdenia
        } else {
            console.log(`Offline alebo žiadne dáta v LS/FS pre ${currentYear}-${currentMonth}. Zobrazuje sa prázdna tabuľka.`);
            // Tabuľka už bola vytvorená, len prepočítame (nulové) súčty
            calculateTotal();
        }
    }

    // Načítanie dát IBA z LocalStorage (pre offline / neprihlásených)
    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localDataString = localStorage.getItem(localKey);

        if (localDataString) {
            console.log(`Načítavam dáta pre ${currentYear}-${currentMonth} iba z localStorage.`);
            parseAndApplyData(localDataString);
        } else {
            console.log(`Žiadne dáta v localStorage pre ${currentYear}-${currentMonth}.`);
            // Tabuľka už bola vytvorená, len prepočítame (nulové) súčty
            calculateTotal();
        }
    }

    // Načítanie dát z Firebase (manuálne tlačidlom alebo pri štarte, ak LS je prázdny)
    window.loadFromFirebase = async function(requireConfirmation = true) { // Parameter pre potvrdenie
        if (!currentUser) {
          showNotification('Pre načítanie z cloudu sa musíte prihlásiť.', 'warning');
          return;
        }
        if (!navigator.onLine) {
           showNotification('Načítanie z cloudu vyžaduje pripojenie na internet.', 'warning');
           return;
        }

        const localKey = `workData-${currentYear}-${currentMonth}`;
        const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;

        if (requireConfirmation) {
            const localChangesExist = localStorage.getItem(localKey) || localStorage.getItem(pendingKey);
            if (localChangesExist && !confirm('Naozaj chcete načítať dáta z cloudu? Týmto sa prepíšu všetky lokálne zmeny pre tento mesiac, ktoré neboli synchronizované.')) {
                console.log('Načítanie z Firebase zrušené používateľom.');
                return;
            }
        }

        console.log(`Pokus o načítanie dát pre ${currentYear}-${currentMonth} z Firestore.`);
        showNotification('Načítavam dáta z cloudu...', 'info', 2000); // Krátka info notifikácia

        try {
            const userDocRef = doc(db, 'users', currentUser.uid, 'workData', `${currentYear}-${currentMonth}`); // Štruktúra: /users/{uid}/workData/{year}-{month}
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const storedData = docSnap.data();
                const dataString = JSON.stringify(storedData);

                console.log('Dáta z Firestore načítané, aplikujem a ukladám do localStorage.');
                localStorage.setItem(localKey, dataString); // Uložíme načítané dáta do LS
                localStorage.removeItem(pendingKey); // Odstránime príznak čakajúcej synchronizácie, lebo sme načítali z cloudu

                parseAndApplyData(dataString); // Aplikujeme načítané dáta do UI
                showNotification('Dáta boli úspešne načítané z cloudu.', 'success');
            } else {
                console.log(`Žiadne údaje vo Firestore pre ${currentUser.uid}/${currentYear}-${currentMonth}.`);
                 // Ak sme tu pri manuálnom načítaní, informujeme usera
                 if (requireConfirmation) {
                     showNotification('Pre tento mesiac neboli v cloude nájdené žiadne dáta.', 'info');
                 }
                 // Ak neboli dáta ani v LS, tabuľka zostane prázdna (alebo s tým, čo tam bolo predtým)
                 // Ak neboli dáta v cloude, ale boli v LS, NEVYMAZÁVAME ich.
                 // Ak chceme vymazať tabuľku, ak v cloude nič nie je:
                 // else { localStorage.removeItem(localKey); parseAndApplyData('{}'); } // Toto by vymazalo
            }
        } catch (error) {
            console.error('Chyba pri načítavaní z Firestore:', error);
            showNotification(`Chyba pri načítavaní dát z cloudu: ${error.message}`, 'error');
        }
    }

    // Spracovanie a aplikácia dát (z LS alebo FS) do UI
    function parseAndApplyData(dataString) {
        try {
            const storedData = JSON.parse(dataString || '{}'); // Zabezpečenie proti null/undefined

            // Aplikácia nastavení z načítaných dát
            hourlyWage = storedData.hourlyWage ?? parseFloat(hourlyWageInput.value); // Použi ?? pre null/undefined
            taxRate = storedData.taxRate ?? (parseFloat(taxRateInput.value) / 100);
            employeeName = storedData.employeeName ?? '';
            decimalPlaces = storedData.decimalPlaces ?? 2;

            // Aktualizácia UI pre nastavenia
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100).toFixed(1);
            employeeNameInput.value = employeeName;
            employeeSubtitle.textContent = employeeName ? `Pracovník: ${employeeName}` : 'Zadajte meno pracovníka';
            decimalPlacesSelect.value = decimalPlaces;

            // Aplikácia dát do tabuľky
            const daysData = storedData.data || [];
            const daysInMonth = getDaysInMonth(currentMonth, currentYear); // Použi aktuálny rok

            for (let i = 1; i <= daysInMonth; i++) {
                 const day = daysData[i-1] || {}; // Získaj dáta pre deň alebo prázdny objekt
                 const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                 const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                 const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

                 if (startElement) startElement.value = day.start || '';
                 if (endElement) endElement.value = day.end || '';
                 if (breakElement) breakElement.value = day.breakTime || '';

                 // Prepočítame riadok, aby sa aktualizovali aj vypočítané hodnoty
                 calculateRow(i);
            }

            // Po aplikovaní všetkých riadkov prepočítame celkové súčty
            calculateTotal();
            console.log(`Dáta pre ${currentYear}-${currentMonth} úspešne aplikované do UI.`);

        } catch (error) {
            console.error('Chyba pri parsovaní alebo aplikovaní dát:', error, "Data string:", dataString);
            showNotification('Chyba pri spracovaní uložených dát. Skúste obnoviť stránku alebo zálohu.', 'error', 5000);
            // V prípade chyby radšej zobrazíme prázdnu tabuľku, než potenciálne poškodené dáta
            createTableStructure(); // Vytvorí len štruktúru
            calculateTotal(); // Vynuluje súčty
        }
    }

    // -------------------- UKLADANIE DÁT (LS + FS) a Synchronizácia --------------------

    // Debounce funkcia
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    // Debounced verzia pre ukladanie do Firestore
    const debouncedSaveToFirestore = debounce(saveToFirestore, 1500); // 1.5 sekundový debounce

    // Zozbieranie aktuálnych dát z UI (tabuľka + nastavenia)
    function collectCurrentData() {
         const saveData = {
            data: [],
            hourlyWage: hourlyWage,
            taxRate: taxRate,
            employeeName: employeeName,
            decimalPlaces: decimalPlaces,
            lastUpdated: new Date().toISOString() // Časová značka poslednej zmeny
         };
         const daysInMonth = getDaysInMonth(currentMonth, currentYear);

         for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            // Čítame hodnoty priamo z inputov pre vypočítané polia, aj keď sú readonly
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

            // Ak elementy neexistujú (napr. počas inicializácie), použijú sa prázdne stringy/nuly
            saveData.data.push({
                start: startElement?.value || '',
                end: endElement?.value || '',
                breakTime: breakElement?.value || '',
                // Ukladáme aj vypočítané hodnoty pre prípadné zobrazenie bez prepočtu
                gross: grossElement?.value || (0).toFixed(decimalPlaces),
                net: netElement?.value || (0).toFixed(decimalPlaces)
            });
         }
         return saveData;
    }

    // Hlavná funkcia volaná po akejkoľvek zmene v tabuľke alebo nastaveniach
    function handleDataChange() {
        // 1. Prepočítať aktuálny riadok (ak je zmena v riadku) - to sa robí v event handleri
        // 2. Prepočítať celkové súčty
        calculateTotal();

        // 3. Zozbierať aktuálne dáta
        const currentData = collectCurrentData();
        const dataString = JSON.stringify(currentData);
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;

        // 4. VŽDY uložiť do LocalStorage
        try {
            localStorage.setItem(localKey, dataString);
            console.log(`Dáta pre ${currentYear}-${currentMonth} uložené do localStorage.`);
            // Ak existoval pending flag, môžeme ho odstrániť, lebo sme práve uložili najnovšiu verziu lokálne
            // Avšak, ak sme offline, nový pending flag sa vytvorí v saveToFirestore
            // Ak sme online a saveToFirestore zlyhá, pending flag sa vytvorí tam
            // Takže tu pending flag nemažeme.
        } catch (error) {
             console.error("Chyba pri ukladaní do localStorage:", error);
             showNotification('Kritická chyba: Nepodarilo sa uložiť dáta lokálne!', 'error', 0);
             // Tu by bolo vhodné zvážiť, čo ďalej - napr. zakázať ďalšie úpravy?
             return; // Zabránime pokusu o uloženie do FS, ak LS zlyhalo
        }


        // 5. Pokúsiť sa uložiť do Firestore (debounced)
        debouncedSaveToFirestore();
    }

    // Ukladanie do Firestore (volané cez debounce)
    async function saveToFirestore() {
        if (!currentUser) {
            // Neprihlásený užívateľ - dáta sú len v LS
            console.log("Neprihlásený užívateľ, preskakujem ukladanie do Firestore.");
            return;
        }

        const localKey = `workData-${currentYear}-${currentMonth}`;
        const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
        const dataString = localStorage.getItem(localKey); // Získame najaktuálnejšie dáta z LS

        if (!dataString) {
            console.warn("Pokus o uloženie do Firestore, ale v localStorage nie sú žiadne dáta.");
            return; // Nemáme čo ukladať
        }

        const saveData = JSON.parse(dataString); // Parsovanie dát z LS

        if (navigator.onLine) {
            // Sme ONLINE, pokúsime sa uložiť do Firestore
            console.log(`Pokus o synchronizáciu dát pre ${currentYear}-${currentMonth} s Firestore.`);
            try {
                const userDocRef = doc(db, 'users', currentUser.uid, 'workData', `${currentYear}-${currentMonth}`);
                await setDoc(userDocRef, saveData); // Prepíše celý dokument aktuálnymi dátami
                console.log(`Dáta pre ${currentYear}-${currentMonth} úspešne synchronizované s Firestore.`);
                // Ak bolo úspešné, odstránime príznak čakajúcej synchronizácie
                localStorage.removeItem(pendingKey);
                showNotification('Dáta synchronizované s cloudom.', 'success', 1500); // Krátka notifikácia
            } catch (error) {
                console.error('Chyba pri ukladaní do Firestore:', error);
                showNotification('Chyba synchronizácie s cloudom. Dáta sú uložené lokálne.', 'error');
                // Uložíme aktuálne dáta ako čakajúce na synchronizáciu
                localStorage.setItem(pendingKey, dataString);
            }
        } else {
            // Sme OFFLINE, len označíme dáta ako čakajúce
            console.log(`Offline: Označujem dáta pre ${currentYear}-${currentMonth} ako čakajúce na synchronizáciu.`);
            localStorage.setItem(pendingKey, dataString);
            showNotification('Ste offline, zmeny uložené lokálne.', 'info', 1500);
        }
    }

    // Synchronizácia čakajúcich dát (volaná pri prechode online alebo pri štarte)
    async function syncPendingData() {
        if (!currentUser || !navigator.onLine) return; // Len pre prihlásených a online

        console.log('Kontrolujem čakajúce dáta na synchronizáciu...');
        let pendingKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('pendingSync-')) {
                pendingKeys.push(key);
            }
        }

        if (pendingKeys.length === 0) {
            console.log('Žiadne čakajúce dáta na synchronizáciu.');
            return;
        }

        showNotification(`Synchronizujem ${pendingKeys.length} mesiacov s cloudom...`, 'info');

        let successCount = 0;
        let errorCount = 0;

        for (const pendingKey of pendingKeys) {
            const dataString = localStorage.getItem(pendingKey);
            if (!dataString) continue; // Pre istotu

            const yearMonthMatch = pendingKey.match(/pendingSync-(\d{4})-(\d{1,2})/);
            if (!yearMonthMatch) continue;
            const [, year, month] = yearMonthMatch;
            const firestoreDocId = `${year}-${month}`;

            try {
                const dataToSync = JSON.parse(dataString);
                 // Porovnanie timestampov? Ak sú dáta vo FS novšie, nesynchronizovať?
                 // Pre jednoduchosť teraz vždy prepisujeme dáta vo FS tými z pending
                const userDocRef = doc(db, 'users', currentUser.uid, 'workData', firestoreDocId);
                await setDoc(userDocRef, dataToSync);
                console.log(`Čakajúce dáta pre ${firestoreDocId} úspešne synchronizované.`);
                localStorage.removeItem(pendingKey); // Odstrániť flag po úspechu
                successCount++;
            } catch (error) {
                console.error(`Chyba pri synchronizácii čakajúcich dát pre ${firestoreDocId}:`, error);
                errorCount++;
                // Necháme pendingKey v LS pre ďalší pokus
            }
        }

        if (successCount > 0) {
            showNotification(`Synchronizácia ${successCount} mesiacov dokončená.`, 'success');
        }
        if (errorCount > 0) {
            showNotification(`Nepodarilo sa synchronizovať ${errorCount} mesiacov. Skúste neskôr.`, 'error');
        }
    }


    // -------------------- TVORBA TABUĽKY a VÝPOČTY --------------------

    function getDayName(year, month, day) {
      const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; // Skrátené názvy
      try {
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
      } catch (e) {
        return ""; // V prípade neplatného dátumu
      }
    }

    function getDaysInMonth(month, year) {
        // Mesiac je 0-based (0=Január, 11=December)
        // new Date(year, month + 1, 0) vráti posledný deň *predchádzajúceho* mesiaca
        // Správny spôsob je získať 0. deň nasledujúceho mesiaca
        return new Date(year, month + 1, 0).getDate();
    }

    // Vytvára LEN HTML štruktúru tabuľky, nenapĺňa dáta
    function createTableStructure() {
      console.log(`Vytváram štruktúru tabuľky pre ${currentMonth + 1}/${currentYear}`);
      if (!workDaysTbody) {
          console.error("Chyba: Element tbody#workDays nebol nájdený!");
          return;
      }
      workDaysTbody.innerHTML = ''; // Vyčistíme predchádzajúci obsah
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth, currentYear);

      const fragment = document.createDocumentFragment(); // Optimalizácia - pridávame do fragmentu

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        const dayDate = new Date(currentYear, currentMonth, i);
        const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6; // Nedeľa (0) alebo Sobota (6)

         // Zvýraznenie aktuálneho dňa
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }
        if (isWeekend) {
             row.style.backgroundColor = currentDayOfMonth === i && currentMonth === currentMonthIndex && currentYear === currentYearValue ? '' : (document.body.classList.contains('dark-mode') ? '#505050' : '#f9f9f9'); // Jemne odlíši víkend, ak to nie je current-day
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        // Vytvoríme riadok s prázdnymi inputmi
        // Používame šablónové reťazce pre lepšiu čitateľnosť
        // inputmode="decimal" pre prestávku pre lepšiu klávesnicu na mobiloch
        // readonly pre vypočítané polia
        row.innerHTML = `
          <td>${i}. ${dayName}</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9]{2}:[0-9]{2}" inputmode="numeric" placeholder="HH:MM" oninput="formatTimeInput(this, 'end-${currentYear}-${currentMonth}-${i}')" onchange="handleDataChange()"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9]{2}:[0-9]{2}" inputmode="numeric" placeholder="HH:MM" oninput="formatTimeInput(this, 'break-${currentYear}-${currentMonth}-${i}')" onchange="handleDataChange()"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.1" inputmode="decimal" placeholder="hod." oninput="calculateRowAndUpdate(${i})" onchange="handleDataChange()"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (0.0 h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" placeholder="€" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" placeholder="€" readonly></td>
          <td style="text-align: center;"><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
        `;
        fragment.appendChild(row);
      }
      workDaysTbody.appendChild(fragment); // Pridáme celý fragment naraz do DOM
      console.log('Štruktúra tabuľky vytvorená.');
    }

    // Formátovanie HH:MM a presun fokusu
    window.formatTimeInput = function(input, nextId) {
        let value = input.value.replace(/[^\d]/g, ''); // Povolí len čísla na začiatku
        let formattedValue = value;

        if (value.length > 2) {
            formattedValue = value.slice(0, 2) + ':' + value.slice(2, 4);
        } else if (value.length === 2 && input.value.length === 2) { // Ak používateľ napísal 2 čísla
             formattedValue = value + ':';
        }

        // Obmedzenie na HH:MM
        if (formattedValue.length > 5) {
            formattedValue = formattedValue.slice(0, 5);
        }

        input.value = formattedValue; // Nastaví hodnotu (aj s možnou dvojbodkou)

        // Validácia a presun až keď je formát HH:MM
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        if (timeRegex.test(formattedValue)) {
             const day = parseInt(input.id.split('-')[3]);
             calculateRow(day); // Prepočíta riadok po zadaní platného času
             // handleDataChange() sa volá onchange, takže tu nemusíme
             moveFocusAndSelect(nextId); // Presunie fokus a označí text
        } else if (formattedValue.length === 5) {
            // Formát je zlý, ale dĺžka sedí -> chyba
            showNotification("Neplatný čas. Zadajte HH:MM (00:00 - 23:59).", "warning", 2000);
            input.style.borderColor = 'red'; // Zvýrazníme chybu
        } else {
             // Čas ešte nie je kompletný, len odstránime červený okraj, ak tam bol
             input.style.borderColor = '';
             // Prepočítame riadok, aj keď nie je kompletný (aby sa vynuloval, ak druhý čas chýba)
             const day = parseInt(input.id.split('-')[3]);
             calculateRow(day);
        }
    }

    function moveFocusAndSelect(elementId) {
        const nextElement = document.getElementById(elementId);
        if (nextElement) {
            nextElement.focus();
            if (nextElement.tagName === 'INPUT' && nextElement.type !== 'button') {
                 // Potrebujeme krátky timeout, aby select() fungoval spoľahlivo po focus()
                 setTimeout(() => nextElement.select(), 0);
            }
        }
    }

    // Kombinovaná funkcia pre recalculate + update totals + save
    window.calculateRowAndUpdate = function(day) {
        calculateRow(day);
        // handleDataChange() sa volá onchange/oninput, takže tu ho explicitne nevoláme,
        // iba ak by sme chceli okamžité uloženie po každej zmene čísla v prestávke
        // handleDataChange(); // Odkomentovať pre okamžité uloženie pri zmene prestávky
    }

    // Výpočet jedného riadku
    function calculateRow(day) {
        const startTimeInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const endTimeInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        // Kontrola existencie elementov
        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossInput || !netInput) {
            // console.warn(`Elementy pre deň ${day} neboli nájdené.`);
            return; // Tichý návrat, ak elementy neexistujú
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        // Prestávka v hodinách, default 0
        const breakTimeHours = parseFloat(breakTimeInput.value) || 0;

        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

        // Reset border color
        startTimeInput.style.borderColor = '';
        endTimeInput.style.borderColor = '';

        let decimalHours = 0;
        let hours = 0;
        let minutes = 0;

        if (timeRegex.test(startTime) && timeRegex.test(endTime)) {
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);

            // Použijeme dátumy na výpočet rozdielu v milisekundách
            // Nastavíme rovnaký dátum, aby sme riešili len čas
            const startDate = new Date(2000, 0, 1, startHours, startMinutes);
            let endDate = new Date(2000, 0, 1, endHours, endMinutes);

            // Ak je koncový čas menší ako počiatočný, predpokladáme prácu cez polnoc
            if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1); // Posuň o jeden deň
            }

            let diffMillis = endDate.getTime() - startDate.getTime();
            let diffMinutesTotal = diffMillis / (1000 * 60);

            // Odpočítať prestávku v minútach
            const breakMinutes = breakTimeHours * 60;
            let workedMinutes = Math.max(0, diffMinutesTotal - breakMinutes); // Celkový čas mínus prestávka

            // Zaokrúhlenie na najbližšiu minútu
            workedMinutes = Math.round(workedMinutes);

            hours = Math.floor(workedMinutes / 60);
            minutes = workedMinutes % 60;
            decimalHours = workedMinutes / 60;

        } else {
             // Ak časy nie sú platné, vynuluj všetko
             decimalHours = 0;
             hours = 0;
             minutes = 0;
             // Ak bol zadaný neplatný čas, označ pole
             if (startTime && !timeRegex.test(startTime)) startTimeInput.style.borderColor = 'red';
             if (endTime && !timeRegex.test(endTime)) endTimeInput.style.borderColor = 'red';
        }

        // Aktualizácia bunky s celkovým časom
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

        // Výpočet a aktualizácia miezd
        const grossSalary = decimalHours * hourlyWage;
        const netSalary = grossSalary * (1 - taxRate);

        grossInput.value = Math.max(0, grossSalary).toFixed(decimalPlaces);
        netInput.value = Math.max(0, netSalary).toFixed(decimalPlaces);

        // handleDataChange() sa volá externe cez onchange/oninput listener
    }

    // Vynulovanie riadku
    window.resetRow = function(day) {
      const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

      if(startInput) { startInput.value = ''; startInput.style.borderColor = ''; }
      if(endInput) { endInput.value = ''; endInput.style.borderColor = ''; }
      if(breakInput) breakInput.value = '';

      calculateRow(day); // Prepočíta na nulu
      handleDataChange(); // Uloží zmeny
      if(startInput) startInput.focus(); // Vráti fokus na začiatok riadku
    }

    // Výpočet celkových súčtov
    function calculateTotal() {
        let totalMinutesWorked = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithValidEntries = 0; // Počíta dni s platným časom začiatku A konca
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

        for (let i = 1; i <= daysInMonth; i++) {
            const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

             // Ak elementy neexistujú, preskočíme deň
             if (!startInput || !endInput || !breakInput || !grossInput || !netInput) continue;

            const startTime = startInput.value;
            const endTime = endInput.value;
            const breakTimeHours = parseFloat(breakInput.value) || 0;
            let dayWorkedMinutes = 0;

            if (timeRegex.test(startTime) && timeRegex.test(endTime)) {
                 const [startHours, startMinutes] = startTime.split(':').map(Number);
                 const [endHours, endMinutes] = endTime.split(':').map(Number);
                 const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                 let endDate = new Date(2000, 0, 1, endHours, endMinutes);
                 if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                 let diffMillis = endDate.getTime() - startDate.getTime();
                 let diffMinutesTotal = diffMillis / (1000 * 60);
                 const breakMinutes = breakTimeHours * 60;
                 dayWorkedMinutes = Math.max(0, diffMinutesTotal - breakMinutes);
                 dayWorkedMinutes = Math.round(dayWorkedMinutes); // Zaokrúhlenie na minúty pre každý deň

                 totalMinutesWorked += dayWorkedMinutes;
                 daysWithValidEntries++; // Iba ak sú oba časy platné
             }
             // Sčítame hrubú a čistú mzdu priamo z inputov (ktoré sú výsledkom calculateRow)
             totalGrossSalary += parseFloat(grossInput.value) || 0;
             totalNetSalary += parseFloat(netInput.value) || 0;
        }

        // Celkové hodiny a minúty
        const totalHours = Math.floor(totalMinutesWorked / 60);
        const totalMinutesRemainder = totalMinutesWorked % 60;
        const totalDecimalHours = totalMinutesWorked / 60;

        // Priemery (iba z dní s platnými záznamami)
        const averageNetSalary = daysWithValidEntries > 0 ? totalNetSalary / daysWithValidEntries : 0;
        const averageWorkedMinutes = daysWithValidEntries > 0 ? totalMinutesWorked / daysWithValidEntries : 0;
        const averageMinutesRounded = Math.round(averageWorkedMinutes);
        const averageHours = Math.floor(averageMinutesRounded / 60);
        const averageMinutesRemainder = averageMinutesRounded % 60;
        const averageDecimalHours = averageWorkedMinutes / 60;

        // Aktualizácia divu s výsledkami - použitie template literal a toFixed
        totalSalaryDiv.innerHTML = `
            Počet dní s platným záznamom: <strong>${daysWithValidEntries}</strong><br>
            Celkový odpracovaný čas: <strong>${totalHours}h ${totalMinutesRemainder}m</strong> (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>
            Celková hrubá mzda: <strong>${totalGrossSalary.toFixed(decimalPlaces)} €</strong><br>
            Celková čistá mzda: <strong>${totalNetSalary.toFixed(decimalPlaces)} €</strong><br>
            Priemerná denná čistá mzda: ${averageNetSalary.toFixed(decimalPlaces)} €<br>
            Priemerný denný odpracovaný čas: ${averageHours}h ${averageMinutesRemainder}m (${averageDecimalHours.toFixed(decimalPlaces)} h)
        `;
    }

    // -------------------- EXPORT a ZDIEĽANIE --------------------
    function getMonthName(monthIndex) { // Opravené meno funkcie
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[monthIndex] || "";
    }

    function generatePDFDoc() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Skúsiť načítať Roboto font (ak zlyhá, použije sa default)
        try {
            // Poznámka: Pridanie fontu týmto spôsobom nemusí vždy fungovať spoľahlivo kvôli CORS a dostupnosti.
            // Bezpečnejšie je hostovať font alebo použiť štandardné PDF fonty. Pre jednoduchosť nechávame takto.
            // doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
            // doc.setFont('Roboto'); // Ak sa font nenačíta, vráti sa k Helvetica/Arial
             doc.setFont('helvetica', 'normal'); // Použijeme štandardný font pre istotu
        } catch (e) {
            console.warn("Nepodarilo sa načítať font Roboto pre PDF, používa sa predvolený.", e);
            doc.setFont('helvetica', 'normal'); // Fallback na štandardný font
        }

        const monthName = getMonthName(currentMonth);
        doc.setFontSize(16);
        doc.text(`Výkaz Práce - ${monthName} ${currentYear}`, 14, 15);
        doc.setFontSize(12);
        doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 22);
        doc.text(`Hodinová mzda: ${hourlyWage.toFixed(decimalPlaces)} €`, 14, 28);
        doc.text(`Daň: ${(taxRate * 100).toFixed(1)} %`, 100, 28); // Daň vpravo

        const tableData = [];
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; // Na kontrolu platných časov

        for (let i = 1; i <= daysInMonth; i++) {
            const dayName = getDayName(currentYear, currentMonth, i);
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakH = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            const total = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || '';
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';

            // Pridáme riadok len ak je zadaný aspoň príchod alebo odchod, alebo nenulová prestávka
            if (start || end || parseFloat(breakH) > 0) {
                 // Zvýrazníme neplatné časy, ak existujú
                 const startDisplay = timeRegex.test(start) ? start : `${start} (?)`;
                 const endDisplay = timeRegex.test(end) ? end : `${end} (?)`;
                 tableData.push([
                     `${i}. ${dayName}`,
                     startDisplay,
                     endDisplay,
                     parseFloat(breakH).toFixed(decimalPlaces), // Formátujeme prestávku
                     total,
                     parseFloat(gross).toFixed(decimalPlaces), // Formátujeme mzdy
                     parseFloat(net).toFixed(decimalPlaces)
                 ]);
             }
        }

        doc.autoTable({
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Hrubá (€)', 'Čistá (€)']],
            body: tableData,
            startY: 35, // Nižšie kvôli hlavičke
            styles: { font: 'helvetica', fontSize: 9 }, // Menšie písmo v tabuľke
            headStyles: { fillColor: [75, 75, 75], textColor: 255, fontStyle: 'bold' }, // Tmavšia hlavička
            alternateRowStyles: { fillColor: [240, 240, 240] }, // Striedanie farieb riadkov
        });

        const totalY = doc.lastAutoTable.finalY + 10; // Pozícia pod tabuľkou
        doc.setFontSize(10);
        // Získame text zo súhrnu, odstránime HTML tagy a rozdelíme na riadky
        const totalTextContent = totalSalaryDiv.innerHTML
                                     .replace(/<strong>(.*?)<\/strong>/g, '$1') // Odstrániť strong tagy
                                     .replace(/<br\s*\/?>/gi, '\n'); // Nahradiť <br> za nový riadok
        doc.text(totalTextContent, 14, totalY);

        return doc; // Vráti objekt jsPDF
    }

    window.exportToPDF = function() {
        try {
            const doc = generatePDFDoc();
            const monthName = getMonthName(currentMonth);
            doc.save(`vykaz_prace_${employeeName || 'pracovnik'}_${monthName}_${currentYear}.pdf`);
            showNotification('PDF súbor bol úspešne vygenerovaný.', 'success');
        } catch (error) {
             console.error("Chyba pri generovaní PDF:", error);
             showNotification(`Chyba pri exporte do PDF: ${error.message}`, 'error');
        }
    }

    window.sendPDF = async function() {
      try {
        const doc = generatePDFDoc();
        const monthName = getMonthName(currentMonth);
        const fileName = `vykaz_prace_${employeeName || 'pracovnik'}_${monthName}_${currentYear}.pdf`;
        const pdfBlob = doc.output('blob');
        const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

        // Použitie Web Share API (ak je dostupné)
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
          await navigator.share({
            files: [pdfFile],
            title: `Výkaz práce ${monthName} ${currentYear}`,
            text: `Výkaz práce pre ${employeeName || 'pracovníka'} za ${monthName} ${currentYear}`
          });
          console.log('PDF úspešne zdieľané.');
          showNotification('PDF bolo úspešne pripravené na zdieľanie.', 'success');
        } else {
          console.warn('Web Share API (pre súbory) nie je podporované alebo dostupné.');
          // Fallback - ponúknuť stiahnutie, ak zdieľanie nejde
          doc.save(fileName);
          showNotification('Zdieľanie súborov nie je podporované. PDF bolo stiahnuté.', 'warning');
        }
      } catch (error) {
        // Chyba môže nastať pri generovaní PDF alebo pri zdieľaní (napr. užívateľ zrušil)
        if (error.name === 'AbortError') {
            console.log('Zdieľanie PDF bolo zrušené používateľom.');
            showNotification('Zdieľanie PDF zrušené.', 'info');
        } else {
            console.error('Chyba pri zdieľaní PDF:', error);
            showNotification(`Chyba pri zdieľaní PDF: ${error.message}`, 'error');
        }
      }
    }


    // -------------------- OSTATNÉ NASTAVENIA a ZMENY --------------------

    // Zmena desatinných miest
    window.changeDecimalPlaces = function() {
      const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
      if (isNaN(newDecimalPlaces) || newDecimalPlaces < 0 || newDecimalPlaces > 5) return; // Validácia

      decimalPlaces = newDecimalPlaces;
      localStorage.setItem('decimalPlaces', decimalPlaces.toString()); // Uložíme nastavenie

      // Prepočítame zobrazenie a uložíme dáta
      const daysInMonth = getDaysInMonth(currentMonth, currentYear);
      for (let i = 1; i <= daysInMonth; i++) {
          calculateRow(i); // Prepočíta každý riadok s novým počtom miest
      }
      handleDataChange(); // Prepočíta súčty a uloží celý stav
      showNotification(`Počet desatinných miest nastavený na ${decimalPlaces}.`, 'info', 1500);
    }

    // Aktualizácia mena pracovníka
    window.updateEmployeeName = function() {
      employeeName = employeeNameInput.value.trim();
      employeeSubtitle.textContent = employeeName ? `Pracovník: ${employeeName}` : 'Zadajte meno pracovníka';
      localStorage.setItem('employeeName', employeeName); // Uložíme nastavenie
      handleDataChange(); // Uloží celý stav (vrátane mena v objekte)
    }

    // Aktualizácia hodinovej mzdy alebo dane
    window.updateSettings = function() {
      const newHourlyWage = parseFloat(hourlyWageInput.value);
      const newTaxRatePercentage = parseFloat(taxRateInput.value);

      // Validácia vstupov
      if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
          hourlyWage = newHourlyWage;
          localStorage.setItem('hourlyWage', hourlyWage.toString());
      } else {
          hourlyWageInput.value = hourlyWage; // Vráti pôvodnú hodnotu, ak je neplatná
          showNotification("Neplatná hodinová mzda.", "warning");
      }

      if (!isNaN(newTaxRatePercentage) && newTaxRatePercentage >= 0 && newTaxRatePercentage <= 100) {
          taxRate = newTaxRatePercentage / 100;
           localStorage.setItem('taxRatePercentage', newTaxRatePercentage.toString());
      } else {
          taxRateInput.value = (taxRate * 100).toFixed(1); // Vráti pôvodnú hodnotu
           showNotification("Neplatné daňové percento (0-100).", "warning");
      }

       // Prepočítame všetky riadky a celkové súčty
      const daysInMonth = getDaysInMonth(currentMonth, currentYear);
      for (let i = 1; i <= daysInMonth; i++) {
         calculateRow(i);
      }
      handleDataChange(); // Prepočíta súčty a uloží celý stav
    }

    // Zmena mesiaca
    window.changeMonth = function() {
      const selectedMonth = parseInt(monthSelect.value);
      if (selectedMonth !== currentMonth) {
          currentMonth = selectedMonth;
          console.log(`Zmena mesiaca na: ${currentMonth + 1}/${currentYear}`);
          updateUI(); // Prekreslí UI a načíta dáta pre nový mesiac
      }
    }

    // Zmena roku
    window.changeYear = function() {
      const selectedYear = parseInt(yearSelect.value);
       if (selectedYear !== currentYear) {
           currentYear = selectedYear;
           console.log(`Zmena roku na: ${currentMonth + 1}/${currentYear}`);
           updateUI(); // Prekreslí UI a načíta dáta pre nový rok
       }
    }

    // Prepínanie tmavého režimu
    window.toggleDarkMode = function() {
      const isDarkMode = document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDarkMode); // Uloží preferenciu
      // Prekreslenie grafov alebo iných elementov, ktoré môžu závisieť od režimu
      // V tomto prípade nie sú, ale ak by boli, volali by sa tu.
    }
    // Aplikácia tmavého režimu pri načítaní stránky
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }


    // -------------------- ZÁLOHA a OBNOVA (Excel) --------------------

    window.createBackup = function() {
      const key = `workData-${currentYear}-${currentMonth}`;
      const dataString = localStorage.getItem(key);

      if (!dataString) {
        showNotification('Pre tento mesiac nie sú v lokálnom úložisku žiadne dáta na zálohu.', 'warning');
        return;
      }

      try {
          const dataObj = JSON.parse(dataString);
          // Hlavička a dáta tabuľky
          const ws_data = [
            ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované (Text)", "Hrubá Mzda (€)", "Čistá Mzda (€)"]
          ];

          const daysInMonth = getDaysInMonth(currentMonth, currentYear);
          for(let i=1; i <= daysInMonth; i++) {
               const dayData = dataObj.data[i-1] || {}; // Získame uložené dáta
               const totalText = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || ''; // Získame textový formát času
               if(dayData.start || dayData.end || parseFloat(dayData.breakTime) > 0) { // Zálohuj len vyplnené dni
                   ws_data.push([
                       `${i}. ${getDayName(currentYear, currentMonth, i)}`,
                       dayData.start || '',
                       dayData.end || '',
                       dayData.breakTime ? parseFloat(dayData.breakTime) : 0, // Uložíme ako číslo
                       totalText, // Uložíme textový formát
                       dayData.gross ? parseFloat(dayData.gross) : 0, // Uložíme ako číslo
                       dayData.net ? parseFloat(dayData.net) : 0 // Uložíme ako číslo
                   ]);
               }
          }

          // Pridanie nastavení na koniec
          ws_data.push([]); // Prázdny riadok ako oddeľovač
          ws_data.push(["Nastavenie", "Hodnota"]);
          ws_data.push(["Hodinová mzda (€)", dataObj.hourlyWage]);
          ws_data.push(["Daňové percento (%)", dataObj.taxRate * 100]);
          ws_data.push(["Meno pracovníka", dataObj.employeeName]);
          ws_data.push(["Počet desatinných miest", dataObj.decimalPlaces]);
          ws_data.push(["Mesiac zálohy (index)", currentMonth]); // Uložíme aj mesiac/rok pre kontrolu
          ws_data.push(["Rok zálohy", currentYear]);
          ws_data.push(["Posledná aktualizácia (ISO)", dataObj.lastUpdated]);
          ws_data.push(["Verzia kalkulačky", "Enhanced V1"]); // Prípadne verzia

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);

          // Skúsime nastaviť šírky stĺpcov (nemusí fungovať vo všetkých Excel verziách)
          ws['!cols'] = [ {wch:10}, {wch:10}, {wch:10}, {wch:12}, {wch:20}, {wch:15}, {wch:15} ];

          XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)} ${currentYear}`);
          const fileName = `zaloha_vykaz_${employeeName || 'pracovnik'}_${getMonthName(currentMonth)}_${currentYear}.xlsx`;
          XLSX.writeFile(wb, fileName);
          showNotification('Záloha do Excelu bola úspešne vytvorená.', 'success');
      } catch(error) {
           console.error('Chyba pri vytváraní Excel zálohy:', error);
           showNotification(`Chyba pri vytváraní zálohy: ${error.message}`, 'error');
      }
    };

    window.restoreBackup = function() {
        if (!confirm('Naozaj chcete obnoviť dáta zo súboru Excel? Týmto sa prepíšu aktuálne zobrazené dáta pre tento mesiac v aplikácii (ale neuložia sa hneď do cloudu).')) {
            return;
        }

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            showNotification('Spracovávam súbor zálohy...', 'info', 2000);
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: false /* Čítaj dátumy ako text */ });
                    const sheetName = workbook.SheetNames[0]; // Predpokladáme prvý list
                    const ws = workbook.Sheets[sheetName];
                    if (!ws) throw new Error("List v súbore nebol nájdený.");

                    // Skús nájsť riadok s nastaveniami
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

                    let settings = {};
                    let backupMonth = -1, backupYear = -1;
                    const settingRowIndex = jsonData.findIndex(row => row[0]?.toString().toLowerCase() === "nastavenie");

                    if (settingRowIndex !== -1) {
                         for (let i = settingRowIndex + 1; i < jsonData.length; i++) {
                             const key = jsonData[i][0]?.toString().trim().toLowerCase();
                             const value = jsonData[i][1]?.toString().trim();
                             if (!key) continue;
                             if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value);
                             else if (key.includes("daňové percento")) settings.taxRate = parseFloat(value) / 100;
                             else if (key.includes("meno pracovníka")) settings.employeeName = value;
                             else if (key.includes("desatinných miest")) settings.decimalPlaces = parseInt(value);
                             else if (key.includes("mesiac zálohy")) backupMonth = parseInt(value);
                             else if (key.includes("rok zálohy")) backupYear = parseInt(value);
                             else if (key.includes("posledná aktualizácia")) settings.lastUpdated = value; // Môže byť string
                         }
                    } else {
                        console.warn("Sekcia s nastaveniami nebola v zálohe nájdená.");
                        // Skúsime načítať aspoň dáta tabuľky
                    }

                     // Kontrola, či záloha patrí k aktuálnemu mesiacu/roku
                    if (backupYear !== -1 && backupMonth !== -1 && (backupYear !== currentYear || backupMonth !== currentMonth)) {
                        if (!confirm(`Záloha je pre ${getMonthName(backupMonth)} ${backupYear}, ale aktuálne prezeráte ${getMonthName(currentMonth)} ${currentYear}. Naozaj chcete použiť túto zálohu?`)) {
                             showNotification("Obnova zálohy zrušená.", "info");
                             return;
                        }
                    }

                    // Nájdenie hlavičky tabuľky
                    const headerRowIndex = jsonData.findIndex(row => row[0]?.toString().toLowerCase().includes("deň"));
                    if (headerRowIndex === -1) throw new Error("Hlavička tabuľky ('Deň', 'Príchod'...) nebola nájdená.");

                    const header = jsonData[headerRowIndex].map(h => h.toString().toLowerCase());
                    const dayIndex = header.indexOf("deň");
                    const startIndex = header.indexOf("príchod");
                    const endIndex = header.indexOf("odchod");
                    const breakIndex = header.indexOf("prestávka (h)");
                    const grossIndex = header.indexOf("hrubá mzda (€)");
                    const netIndex = header.indexOf("čistá mzda (€)");

                    if ([dayIndex, startIndex, endIndex, breakIndex, grossIndex, netIndex].includes(-1)) {
                        throw new Error("Nepodarilo sa nájsť všetky požadované stĺpce v hlavičke tabuľky.");
                    }

                    let dataArray = [];
                     // Prejdeme riadky od hlavičky+1 až po riadok s nastaveniami alebo koniec
                    const endDataRow = (settingRowIndex !== -1) ? settingRowIndex -1 : jsonData.length; // -1 lebo je tam prázdny riadok
                    for (let i = headerRowIndex + 1; i < endDataRow; i++) {
                        const row = jsonData[i];
                        if (!row || !row[dayIndex]) continue; // Preskoč prázdne riadky

                        // Extrahujeme číslo dňa
                         const dayMatch = row[dayIndex].toString().match(/^(\d+)/);
                         if (!dayMatch) continue; // Ak sa nenájde číslo dňa, preskoč
                         const dayNum = parseInt(dayMatch[1]);
                         if (isNaN(dayNum) || dayNum < 1 || dayNum > 31) continue;

                         // Zabezpečíme, aby pole malo správnu dĺžku podľa čísla dňa
                         while (dataArray.length < dayNum - 1) {
                             dataArray.push({}); // Doplníme prázdne dni
                         }

                        // Hodnoty čítame ako stringy, validácia a formátovanie sa urobí neskôr
                         const entry = {
                            start: row[startIndex]?.toString() || "",
                            end: row[endIndex]?.toString() || "",
                            breakTime: row[breakIndex]?.toString() || "",
                            // Gross/Net zo zálohy môžeme ignorovať a nechať ich prepočítať
                            gross: undefined, // parseFloat(row[grossIndex]).toFixed(settings.decimalPlaces || decimalPlaces),
                            net: undefined // parseFloat(row[netIndex]).toFixed(settings.decimalPlaces || decimalPlaces)
                         };
                         // Pridáme na správny index (dayNum - 1)
                         dataArray[dayNum - 1] = entry;
                    }

                    // Doplnenie prázdnych objektov na koniec, ak treba
                    const daysInCurrentMonth = getDaysInMonth(currentMonth, currentYear);
                     while (dataArray.length < daysInCurrentMonth) {
                         dataArray.push({});
                     }
                     // Odstránenie prebytočných dní, ak záloha mala viac dní
                     dataArray = dataArray.slice(0, daysInCurrentMonth);


                    // Vytvorenie finálneho objektu na uloženie/aplikáciu
                    const backupData = {
                        data: dataArray,
                        // Použi hodnoty zo zálohy, ak existujú, inak aktuálne z UI/LS
                        hourlyWage: !isNaN(settings.hourlyWage) ? settings.hourlyWage : hourlyWage,
                        taxRate: !isNaN(settings.taxRate) ? settings.taxRate : taxRate,
                        employeeName: settings.employeeName ?? employeeName,
                        decimalPlaces: !isNaN(settings.decimalPlaces) ? settings.decimalPlaces : decimalPlaces,
                        lastUpdated: settings.lastUpdated || new Date().toISOString() // Zober zo zálohy alebo nový čas
                    };

                    // Aplikujeme dáta do UI (toto prepočíta aj gross/net)
                    parseAndApplyData(JSON.stringify(backupData));

                    // Uložíme obnovené dáta do localStorage, aby boli perzistentné
                    const localKey = `workData-${currentYear}-${currentMonth}`;
                    localStorage.setItem(localKey, JSON.stringify(backupData));
                     // Označíme, že tieto dáta treba synchronizovať, ak sme online a prihlásení
                     if (currentUser && navigator.onLine) {
                         const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
                         localStorage.setItem(pendingKey, JSON.stringify(backupData));
                         showNotification('Záloha úspešne obnovená a načítaná. Dáta sú pripravené na synchronizáciu s cloudom.', 'success');
                         // Spustíme synchronizáciu (alebo sa spustí automaticky)
                         syncPendingData();
                     } else {
                         showNotification('Záloha bola úspešne obnovená a načítaná lokálne.', 'success');
                     }

                } catch (error) {
                    console.error('Chyba pri načítavaní zálohy z Excelu:', error);
                    showNotification(`Chyba pri obnove zo zálohy: ${error.message}`, 'error', 5000);
                }
            };

            reader.onerror = function() {
                showNotification('Chyba pri čítaní súboru zálohy.', 'error');
            }
            reader.readAsArrayBuffer(file);
        };
        input.click(); // Otvorí dialóg na výber súboru
    };


    // -------------------- INICIALIZÁCIA APLIKÁCIE --------------------
    console.log("Spúšťam inicializáciu aplikácie...");

    // Listener na zmeny stavu prihlásenia
    onAuthStateChanged(auth, (user) => {
      console.log("Stav prihlásenia zmenený. User:", user ? user.email : 'Nikto');
      currentUser = user;
      updateUI(); // Aktualizuje celé UI a načíta relevantné dáta
    });

    // Prvotné volanie na nastavenie UI nemusí byť nutné, lebo onAuthStateChanged sa spustí hneď
    // updateUI();

    // Registrácia Service Workera - presunutá mimo module script pre istotu
  </script>

  <!-- Registrácia Service Workera (mimo module script) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
          .then(registration => {
            console.log('Service Worker zaregistrovaný úspešne, rozsah:', registration.scope);
            // Tu môžete pridať logiku na kontrolu aktualizácií SW
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
    } else {
        console.log('Service Worker nie je podporovaný v tomto prehliadači.');
    }
  </script>

</body>
</html>
```

**Ako to funguje (zhrnutie kľúčových zmien):**

1.  **Ukladanie:** Akákoľvek zmena (vstup času, prestávka, nastavenie) spustí `handleDataChange()`. Táto funkcia:
    *   Prepočíta celkové súčty (`calculateTotal`).
    *   Zozbiera *všetky* aktuálne dáta z formulára a tabuľky (`collectCurrentData`).
    *   **Vždy** uloží tieto dáta do `localStorage` pod kľúčom `workData-{rok}-{mesiac}`.
    *   Spustí *debounced* funkciu `saveToFirestore()`.
2.  **Synchronizácia (saveToFirestore):**
    *   Ak používateľ nie je prihlásený, nerobí nič.
    *   Načíta najnovšie dáta z `localStorage`.
    *   Ak je **online**: Pokúsi sa uložiť dáta do Firestore (`/users/{uid}/workData/{rok}-{mesiac}`).
        *   Ak úspešné: Odstráni príznak `pendingSync-{rok}-{mesiac}` z `localStorage` (ak existoval). Zobrazí notifikáciu o úspechu.
        *   Ak neúspešné: Uloží aktuálne dáta pod kľúčom `pendingSync-{rok}-{mesiac}` do `localStorage`. Zobrazí chybovú notifikáciu.
    *   Ak je **offline**: Uloží aktuálne dáta pod kľúčom `pendingSync-{rok}-{mesiac}` do `localStorage`. Zobrazí notifikáciu o uložení offline.
3.  **Automatická Synchronizácia Čakajúcich Dát (syncPendingData):**
    *   Táto funkcia sa volá:
        *   Keď sa zmení stav pripojenia z offline na online.
        *   Pri načítaní stránky, ak je používateľ prihlásený a online.
    *   Prehľadá `localStorage` a nájde všetky kľúče začínajúce na `pendingSync-`.
    *   Pre každý nájdený kľúč sa pokúsi odoslať príslušné dáta do Firestore.
    *   Ak je odoslanie úspešné, odstráni `pendingSync-` kľúč z `localStorage`.
    *   Informuje používateľa o priebehu a výsledku synchronizácie.
4.  **Načítanie Dát:**
    *   **Pri Štarte/Zmene Mesiaca/Roku (`updateUI`):**
        *   Ak je používateľ prihlásený: Najprv hľadá dáta v `localStorage`. Ak nájde, použije ich. Ak nenájde a je online, pokúsi sa načítať z Firestore (`loadFromFirebase(false)`). Ak ani tam nič nie je alebo je offline, zobrazí prázdnu tabuľku.
        *   Ak používateľ nie je prihlásený: Načíta dáta *iba* z `localStorage`.
    *   **Tlačidlo "Načítať z Cloud" (`loadFromFirebase(true)`):**
        *   Funguje len pre prihlásených a online.
        *   Vyžaduje potvrdenie, ak existujú lokálne zmeny.
        *   Načíta dáta z Firestore.
        *   Prepíše dáta v `localStorage`.
        *   Odstráni príznak `pendingSync-` pre daný mesiac.
        *   Aplikuje dáta do UI.

Tento prístup zabezpečuje, že používateľ má vždy k dispozícii poslednú uloženú verziu (aj offline) a synchronizácia s cloudom prebieha automaticky na pozadí, keď je to možné, s jasnou spätnou väzbou. Zároveň je zachovaná možnosť manuálneho načítania z cloudu alebo obnovy zo zálohy.```html
<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bruno's Calculator - Vylepšená Verzia</title> <!-- Zmenený titulok -->

  <!-- Odkaz na manifest (RELATÍVNA cesta) -->
  <link rel="manifest" href="./manifest.json" /> <!-- Uistite sa, že manifest.json existuje a je správne nakonfigurovaný -->

  <!-- Knižnice pre export do PDF a Excelu -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script> <!-- Defer načítanie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script> <!-- Aktualizovaná verzia a Defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script> <!-- Aktualizovaná verzia a Defer -->

  <style>
    /* Základné štýly */
    :root {
        /* Farebná paleta - Svetlý režim */
        --bg-color: #f4f4f4;
        --container-bg: white;
        --text-color: #333;
        --secondary-text-color: #555;
        --border-color: #ddd;
        --header-bg: #f2f2f2;
        --input-bg: #ffffd0;
        --input-border: #ccc;
        --input-focus-border: #8a2be2;
        --input-focus-shadow: rgba(138, 43, 226, 0.3);
        --readonly-bg: #eee;
        --total-bg: #e6f3ff;
        --total-border: #8a2be2;
        --current-day-bg: #e8dff5;
        --current-day-input-bg: #f5eefd;
        --current-day-input-border: #8a2be2;
        --weekend-bg: #f9f9f9;
        --link-color: #007bff;

        /* Farebná paleta - Tmavý režim */
        --dark-bg-color: #212121;
        --dark-container-bg: #333;
        --dark-text-color: #e0e0e0;
        --dark-secondary-text-color: #bdbdbd;
        --dark-border-color: #616161;
        --dark-header-bg: #555;
        --dark-input-bg: #616161;
        --dark-input-border: #757575;
        --dark-input-focus-border: #c6a7ff;
        --dark-input-focus-shadow: rgba(198, 167, 255, 0.4);
        --dark-readonly-bg: #555;
        --dark-readonly-text: #bdbdbd;
        --dark-total-bg: #2c3e50;
        --dark-total-border: #ab47bc;
        --dark-current-day-bg: #4a0e8f;
        --dark-current-day-input-bg: #5c1db3;
        --dark-weekend-bg: #505050;
        --dark-link-color: #64b5f6;

        /* Tlačidlá - Svetlý režim */
        --btn-reset-bg: #f44336;
        --btn-reset-hover: #d32f2f;
        --btn-export-bg: #4CAF50;
        --btn-export-hover: #388e3c;
        --btn-backup-bg: #8a2be2;
        --btn-backup-hover: #6a1bb2;
        --btn-restore-bg: #ff9800;
        --btn-restore-hover: #f57c00;
        --btn-firebase-bg: #03A9F4;
        --btn-firebase-hover: #0288D1;
        --btn-dark-mode-bg: #607D8B;
        --btn-dark-mode-hover: #455A64;
        --btn-text-light: white;

         /* Tlačidlá - Tmavý režim */
        --dark-btn-reset-bg: #e57373;
        --dark-btn-reset-hover: #ef5350;
        --dark-btn-export-bg: #81c784;
        --dark-btn-export-hover: #66bb6a;
        --dark-btn-backup-bg: #ba68c8;
        --dark-btn-backup-hover: #ab47bc;
        --dark-btn-restore-bg: #ffb74d;
        --dark-btn-restore-hover: #ffa726;
        --dark-btn-firebase-bg: #64b5f6;
        --dark-btn-firebase-hover: #42a5f5;
        --dark-btn-dark-mode-bg: #90a4ae;
        --dark-btn-dark-mode-hover: #78909c;
        --btn-text-dark: #212121;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto; /* Väčší margin hore/dole */
      background: var(--container-bg);
      padding: 20px; /* Viac paddingu */
      border-radius: 8px; /* Zaoblenejšie rohy */
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-size: 200% 200%; /* Pre plynulejšiu animáciu */
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
      font-weight: 700; /* Trochu tučnejšie */
    }
    h2#employeeSubtitle {
      text-align: center;
      color: var(--secondary-text-color);
      margin-top: -10px;
      margin-bottom: 20px; /* Väčší odstup pod nadpisom */
      font-size: 1.2em;
      min-height: 1.5em;
      font-weight: 400; /* Normálna hrúbka */
    }
    .settings {
      margin-bottom: 25px; /* Väčší odstup */
      display: grid; /* Použitie gridu pre lepšie zarovnanie */
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responzívny grid */
      gap: 15px; /* Medzery medzi prvkami */
      align-items: end; /* Zarovnanie na spodok (pre tlačidlo tmavého režimu) */
    }
    .settings > div { /* Grid item */
        display: flex;
        flex-direction: column;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9em;
      font-weight: 500; /* Mierne tučnejšie */
      color: var(--secondary-text-color);
    }
    .table-container {
      overflow-x: auto;
       -webkit-overflow-scrolling: touch; /* Plynulejšie skrolovanie na iOS */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 750px; /* Zmenšená min. šírka */
    }
    th, td {
      padding: 10px; /* Viac paddingu */
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
      transition: background-color 0.3s ease;
    }
    th {
      background-color: var(--header-bg);
      font-weight: 600; /* Tučnejšie hlavičky */
      position: sticky; /* Prilepená hlavička pri skrolovaní */
      top: 0; /* Prilepiť na vrch */
      z-index: 10; /* Aby bola nad obsahom */
    }
    /* Šírky stĺpcov - upravené pre konzistentnosť */
    th:nth-child(1), td:nth-child(1) { width: 14%; } /* Deň */
    th:nth-child(2), td:nth-child(2) { width: 10%; } /* Príchod */
    th:nth-child(3), td:nth-child(3) { width: 10%; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { width: 10%; } /* Prestávka */
    th:nth-child(5), td:nth-child(5) { width: 16%; } /* Odpracované */
    th:nth-child(6), td:nth-child(6) { width: 12%; } /* Hrubá */
    th:nth-child(7), td:nth-child(7) { width: 12%; } /* Čistá */
    th:nth-child(8), td:nth-child(8) { width: 16%; text-align: center; } /* Akcia */

    input[type="tel"], input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 8px; /* Zväčšený padding */
      box-sizing: border-box;
      background-color: var(--input-bg);
      font-size: 14px;
      border: 1px solid var(--input-border);
      border-radius: 4px; /* Mierne zaoblenie */
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
    }
     input:focus, select:focus {
        border-color: var(--input-focus-border);
        box-shadow: 0 0 0 3px var(--input-focus-shadow); /* Väčší tieň pri focuse */
        outline: none;
     }
     input.invalid { /* Štýl pre nevalidný vstup */
        border-color: var(--btn-reset-bg) !important;
        box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.3) !important;
     }
    input[readonly] {
        background-color: var(--readonly-bg);
        cursor: default; /* Zmenený kurzor */
        font-style: normal; /* Normálny štýl písma */
        opacity: 0.8; /* Mierne priehľadné */
        color: var(--dark-readonly-text); /* Farba textu z tmavého režimu, aby bola konzistentná */
    }

    .btn-container {
      display: grid; /* Grid pre lepšie usporiadanie */
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responzívny grid */
      gap: 10px;
      margin-top: 25px; /* Väčší odstup */
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500; /* Mierne tučnejšie tlačidlá */
      transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.2s ease;
      text-align: center;
      white-space: nowrap; /* Zabráni nechcenému zalomeniu textu */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn:hover {
        transform: translateY(-1px); /* Jemný posun nahor pri hover */
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn:active {
        transform: scale(0.98) translateY(0);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Farby tlačidiel - Svetlý režim */
    .btn { color: var(--btn-text-light); }
    .reset-btn { background-color: var(--btn-reset-bg); }
    .reset-btn:hover { background-color: var(--btn-reset-hover); }
    .export-btn { background-color: var(--btn-export-bg); }
    .export-btn:hover { background-color: var(--btn-export-hover); }
    .backup-btn { background-color: var(--btn-backup-bg); }
    .backup-btn:hover { background-color: var(--btn-backup-hover); }
    .restore-btn { background-color: var(--btn-restore-bg); }
    .restore-btn:hover { background-color: var(--btn-restore-hover); }
    .firebase-load-btn { background-color: var(--btn-firebase-bg); }
    .firebase-load-btn:hover { background-color: var(--btn-firebase-hover); }
    .dark-mode-btn { background-color: var(--btn-dark-mode-bg); }
    .dark-mode-btn:hover { background-color: var(--btn-dark-mode-hover); }


    #totalSalary {
      font-size: 16px;
      font-weight: 500; /* Mierne tučnejšie */
      text-align: left;
      margin-top: 25px; /* Väčší odstup */
      padding: 15px 20px; /* Viac paddingu */
      background-color: var(--total-bg);
      border-radius: 5px;
      border-left: 5px solid var(--total-border);
      line-height: 1.8;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
     #totalSalary strong {
         font-weight: 700; /* Výraznejšie tučné písmo */
         color: var(--text-color); /* Aby bolo čitateľné aj v tmavom režime */
     }

    .current-day td { /* Jemnejšie zvýraznenie */
      background-color: var(--current-day-bg) !important;
    }
    .current-day td:first-child {
        font-weight: 600; /* Tučnejší deň */
    }
    .current-day input {
      background-color: var(--current-day-input-bg) !important;
      border-color: var(--current-day-input-border);
    }
    tr.weekend td { /* Zvýraznenie víkendu */
       background-color: var(--weekend-bg) !important;
       /* Neplatí pre current-day */
    }
    tr.weekend.current-day td {
         background-color: var(--current-day-bg) !important; /* current-day má prednosť */
    }


    /* --- Tmavý režim --- */
    body.dark-mode {
      background-color: var(--dark-bg-color);
      color: var(--dark-text-color);
    }
    body.dark-mode .container {
      background-color: var(--dark-container-bg);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    body.dark-mode h2#employeeSubtitle { color: var(--dark-secondary-text-color); }
    body.dark-mode table { background-color: var(--dark-container-bg); } /* Zjednotenie pozadia */
    body.dark-mode th { background-color: var(--dark-header-bg); border-color: var(--dark-border-color); }
    body.dark-mode td { border-color: var(--dark-border-color); }
    body.dark-mode tr.weekend td { background-color: var(--dark-weekend-bg) !important; }
    body.dark-mode tr.weekend.current-day td { background-color: var(--dark-current-day-bg) !important; }
    body.dark-mode input[type="tel"],
    body.dark-mode input[type="number"],
    body.dark-mode input[type="text"],
    body.dark-mode select {
      background-color: var(--dark-input-bg);
      color: var(--dark-text-color);
      border-color: var(--dark-input-border);
    }
    body.dark-mode input:focus, body.dark-mode select:focus {
        border-color: var(--dark-input-focus-border);
        box-shadow: 0 0 0 3px var(--dark-input-focus-shadow);
    }
    body.dark-mode input.invalid {
        border-color: var(--dark-btn-reset-bg) !important;
        box-shadow: 0 0 0 3px rgba(229, 115, 115, 0.4) !important;
    }
    body.dark-mode input[readonly] {
        background-color: var(--dark-readonly-bg);
        color: var(--dark-readonly-text);
        opacity: 0.7;
    }
    /* Farby tlačidiel - Tmavý režim */
    body.dark-mode .btn { color: var(--btn-text-dark); } /* Tmavý text na svetlých tlačidlách */
    body.dark-mode .reset-btn { background-color: var(--dark-btn-reset-bg); }
    body.dark-mode .reset-btn:hover { background-color: var(--dark-btn-reset-hover); }
    body.dark-mode .export-btn { background-color: var(--dark-btn-export-bg); }
    body.dark-mode .export-btn:hover { background-color: var(--dark-btn-export-hover); }
    body.dark-mode .backup-btn { background-color: var(--dark-btn-backup-bg); }
    body.dark-mode .backup-btn:hover { background-color: var(--dark-btn-backup-hover); }
    body.dark-mode .restore-btn { background-color: var(--dark-btn-restore-bg); }
    body.dark-mode .restore-btn:hover { background-color: var(--dark-btn-restore-hover); }
    body.dark-mode .firebase-load-btn { background-color: var(--dark-btn-firebase-bg); }
    body.dark-mode .firebase-load-btn:hover { background-color: var(--dark-btn-firebase-hover); }
    body.dark-mode .dark-mode-btn { background-color: var(--dark-btn-dark-mode-bg); color: var(--btn-text-light); } /* Tmavé tlačidlo ostáva tmavé */
    body.dark-mode .dark-mode-btn:hover { background-color: var(--dark-btn-dark-mode-hover); }

    body.dark-mode #totalSalary {
      background-color: var(--dark-total-bg);
      border-left-color: var(--dark-total-border);
      color: var(--dark-text-color); /* Zaistí čitateľnosť textu */
    }
     body.dark-mode #totalSalary strong {
         color: #fff; /* Biela pre lepšiu viditeľnosť v tmavom režime */
     }
    body.dark-mode .current-day td {
      background-color: var(--dark-current-day-bg) !important;
    }
    body.dark-mode .current-day input {
      background-color: var(--dark-current-day-input-bg) !important;
      border-color: var(--dark-input-focus-border); /* Zvýraznenie hranice */
    }

    @keyframes gradientText { /* Bez zmien */
      0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse { /* Bez zmien */
      0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); }
      50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); }
    }

    /* --- Responzívne úpravy --- */
    @media (max-width: 992px) {
        .settings { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } /* Menší min pre tablety */
        .btn-container { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        table { min-width: 700px; }
        th, td { padding: 8px; font-size: 0.85em; }
        h1 { font-size: 2.2em; }
    }

    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 15px; margin: 10px auto; }
      .settings { grid-template-columns: 1fr; gap: 10px; } /* Pod sebou */
      .settings > .dark-mode-btn-wrapper { grid-column: 1 / -1; } /* Tlačidlo tmavého režimu na celú šírku */
      .btn-container { grid-template-columns: 1fr; gap: 8px; } /* Tlačidlá pod sebou */
      table { min-width: 650px; }
      th, td { padding: 6px; font-size: 0.8em; }
       h1 { font-size: 1.8em; }
       h2#employeeSubtitle { font-size: 1em; }
       #totalSalary { font-size: 15px; }
    }

    @media (max-width: 480px) {
      .container { padding: 10px; }
      th, td { font-size: 0.75em; padding: 5px; }
      .btn { font-size: 14px; padding: 10px 12px; } /* Väčšie tlačidlá pre mobil */
      input[type="tel"], input[type="number"], input[type="text"], select { font-size: 13px; padding: 7px; }
      table { min-width: 600px; }
       h1 { font-size: 1.6em; }
       h2#employeeSubtitle { font-size: 0.9em; }
       #totalSalary { font-size: 14px; }
    }

    /* --- Notifikácie --- */
    #notification-area {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1001;
        width: clamp(250px, 80vw, 350px); /* Responzívna šírka */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .notification {
        padding: 12px 18px;
        border-radius: 6px; /* Mierne väčšie zaoblenie */
        color: white;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateX(110%); /* Začiatok mimo obrazovky */
        transition: opacity 0.4s ease-in-out, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Plynulejšia animácia */
        display: flex; /* Pre prípadné pridanie ikonky */
        align-items: center;
        gap: 10px;
    }
    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }
    /* Farby notifikácií */
    .notification.success { background-color: #4CAF50; }
    .notification.error { background-color: #f44336; }
    .notification.info { background-color: #2196F3; }
    .notification.warning { background-color: #ff9800; }

    /* --- Status pripojenia --- */
     #connection-status {
        position: fixed;
        bottom: 10px;
        left: 10px;
        padding: 5px 12px; /* Trochu viac paddingu */
        border-radius: 15px; /* Oválny tvar */
        font-size: 12px;
        font-weight: 600;
        z-index: 1000;
        opacity: 0.9;
        transition: background-color 0.3s ease, color 0.3s ease;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
     }
     #connection-status.online { background-color: var(--btn-export-bg); color: var(--btn-text-light); }
     #connection-status.offline { background-color: var(--btn-reset-bg); color: var(--btn-text-light); }
     body.dark-mode #connection-status.online { background-color: var(--dark-btn-export-bg); color: var(--btn-text-dark); }
     body.dark-mode #connection-status.offline { background-color: var(--dark-btn-reset-bg); color: var(--btn-text-dark); }

    /* --- Login/User Info --- */
    #auth-container {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
        margin-bottom: 20px;
        transition: border-color 0.3s ease;
    }
    #login-form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    #login-form input[type="email"],
    #login-form input[type="password"] {
        width: clamp(200px, 60vw, 300px); /* Responzívna šírka */
        padding: 10px; /* Väčší padding */
    }
     #login-form div { /* Kontajner pre login/register tlačidlá */
         display: flex;
         gap: 10px;
         width: clamp(200px, 60vw, 300px); /* Rovnaká šírka ako inputy */
     }
    #login-form .btn {
        flex: 1; /* Rovnaká šírka oboch tlačidiel */
    }
    #user-info {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap; /* Zalomenie na menších obrazovkách */
        gap: 15px;
    }
    #user-info span { font-weight: 500; color: var(--secondary-text-color); word-break: break-all; } /* Zalomenie dlhého emailu */
    #user-info .btn { flex-shrink: 0; } /* Zabráni zmenšeniu odhlasovacieho tlačidla */

    /* --- Loading overlay --- */
    #loading-overlay {
        position: fixed;
        inset: 0; /* Pokryje celú obrazovku */
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1002; /* Nad všetkým ostatným */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #loading-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .loader { /* Jednoduchý CSS loader */
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--input-focus-border);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
     body.dark-mode .loader {
         border-top-color: var(--dark-input-focus-border);
     }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading-overlay">
      <div class="loader"></div>
  </div>

  <div class="container">
    <!-- Oblasť pre notifikácie -->
    <div id="notification-area"></div>
    <!-- Indikátor stavu pripojenia -->
    <div id="connection-status">Načítavam stav...</div> <!-- Počiatočný text -->

    <!-- Autentifikačné UI -->
    <div id="auth-container">
      <div id="login-form" style="display: none;">
        <input type="email" id="email" placeholder="Email" autocomplete="email">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div>
            <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
            <button class="btn backup-btn" onclick="register()">Registrovať</button>
        </div>
      </div>
      <div id="user-info" style="display: none;">
        <span id="user-email"></span>
        <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
      </div>
    </div>

    <h1>Bruno's Calculator</h1>
    <h2 id="employeeSubtitle"></h2> <!-- Dynamicky menený podnadpis -->

    <!-- Nastavenia -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.01" oninput="updateSettings()"> <!-- Presnosť na 2 miesta -->
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option> <option value="1">Február</option>
          <option value="2">Marec</option> <option value="3">Apríl</option>
          <option value="4">Máj</option> <option value="5">Jún</option>
          <option value="6">Júl</option> <option value="7">August</option>
          <option value="8">September</option> <option value="9">Október</option>
          <option value="10">November</option> <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()">
          <!-- Dynamicky generované roky -->
        </select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinné miesta:</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option> <option value="2" selected>2</option>
          <option value="3">3</option> <!-- Pridaná možnosť 3 miest -->
        </select>
      </div>
      <div class="dark-mode-btn-wrapper"> <!-- Wrapper pre grid layout -->
         <button onclick="toggleDarkMode()" class="btn dark-mode-btn" aria-label="Prepnúť tmavý/svetlý režim">
              <!-- Ikonka (placeholder, môže byť SVG alebo Font Awesome) -->
              <span class="toggle-icon">🌙/☀️</span>
         </button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          <!-- Riadky budú generované cez JavaScript -->
        </tbody>
      </table>
    </div>

    <div id="totalSalary">Načítavam súčty...</div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Export PDF</button>
      <button class="btn export-btn" onclick="sendPDF()" title="Zdieľať PDF cez systémové možnosti">Odoslať PDF</button>
      <button class="btn backup-btn" onclick="createBackup()">Záloha (XLSX)</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnova (XLSX)</button>
      <button class="btn firebase-load-btn" onclick="loadFromFirebase()">Načítať z Cloud</button>
    </div>
  </div>

  <!-- Hlavný JavaScript kód + Firebase -->
  <script type="module">
    // ----------------------- IMPORTY Firebase -----------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, writeBatch, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js'; // Pridané writeBatch, serverTimestamp, Timestamp
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    // ---------------------- KONFIGURÁCIA Firebase --------------------
    // POZNÁMKA: Kľúče by mali byť ideálne v konfiguračnom súbore alebo premenných prostredia.
    // Uistite sa, že tieto hodnoty zodpovedajú vášmu Firebase projektu.
    const firebaseConfig = {
      apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk", // Vložte Váš API kľúč
      authDomain: "uuuuu-f7ef9.firebaseapp.com",        // Váš Auth Domain
      projectId: "uuuuu-f7ef9",                      // Váš Project ID
      storageBucket: "uuuuu-f7ef9.appspot.com",       // Váš Storage Bucket
      messagingSenderId: "456105865458",            // Váš Messaging Sender ID
      appId: "1:456105865458:web:101f0a4dcb455f174b606b", // Váš App ID
    };

    // -------------------- Inicializácia Firebase a App Check -------------
    let app, auth, db, appCheck;
    try {
        app = initializeApp(firebaseConfig);
        // Aktivácia App Check (odporúčané pre bezpečnosť)
        try {
             // Vložte Váš reCAPTCHA v3 Site Key
            appCheck = initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check inicializovaný.");
        } catch (e) {
             console.warn("Nepodarilo sa inicializovať Firebase App Check (možno chýba kľúč reCAPTCHA alebo je blokovaný):", e);
        }
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase inicializovaný úspešne.");
    } catch (error) {
        console.error("Kritická chyba pri inicializácii Firebase:", error);
        showNotification('Kritická chyba pri inicializácii Firebase. Aplikácia nemusí fungovať správne.', 'error', 0); // Permanentná chyba
    }

    // -------------------- GLOBÁLNE PREMENNÉ a DOM Elementy --------------------
    let currentUser = null; // Aktuálne prihlásený používateľ
    let currentDataState = {}; // Objekt na uchovanie načítaných dát pre aktuálny mesiac
    let isSaving = false; // Flag na zabránenie viacnásobnému ukladaniu naraz
    let pendingSyncTimer = null; // Časovač pre odloženú synchronizáciu

    // DOM Elementy
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const employeeSubtitle = document.getElementById('employeeSubtitle');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const notificationArea = document.getElementById('notification-area');
    const connectionStatusDiv = document.getElementById('connection-status');
    const loginForm = document.getElementById('login-form');
    const userInfo = document.getElementById('user-info');
    const userEmailSpan = document.getElementById('user-email');
    const loadingOverlay = document.getElementById('loading-overlay');

    // Nastavenia a Stav Aplikácie
    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces') || '2');
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage') || '10'); // Načítať alebo default 10
    let taxRate = parseFloat(localStorage.getItem('taxRatePercentage') || '2') / 100; // Načítať alebo default 2%

    // Regex pre validáciu času
    const TIME_REGEX = /^([01]\d|2[0-3]):([0-5]\d)$/;


    // -------------------- POMOCNÉ FUNKCIE --------------------

    // Zobrazenie / Skrytie Loading Overlay
    const showLoading = (show) => {
        loadingOverlay.classList.toggle('visible', show);
    };

    // Zobrazenie Notifikácie
    function showNotification(message, type = 'info', duration = 3500) { // Predĺžená default doba
        if (!notificationArea) return;
        // Odstránenie starých notifikácií rovnakého typu (voliteľné)
        // const existingNotifications = notificationArea.querySelectorAll(`.notification.${type}`);
        // existingNotifications.forEach(notif => notif.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        // Prípadne pridať ikonku podľa typu
        // notification.innerHTML = `<i class="icon-${type}"></i> ${message}`;
        notificationArea.appendChild(notification);

        // Trigger transition
        requestAnimationFrame(() => { // Použitie requestAnimationFrame pre plynulejší štart animácie
            notification.classList.add('show');
        });

        if (duration > 0) {
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove(), { once: true }); // Bezpečnejšie odstránenie
            }, duration);
        }
    }

    // Aktualizácia Stavu Pripojenia
    function updateConnectionStatus() {
        if (!connectionStatusDiv) return;
        const isOnline = navigator.onLine;
        connectionStatusDiv.textContent = isOnline ? 'Online' : 'Offline';
        connectionStatusDiv.className = isOnline ? 'online' : 'offline';

        if (isOnline) {
            console.log('Zariadenie je online. Kontrolujem čakajúcu synchronizáciu...');
            // Spustíme synchronizáciu s malým oneskorením, aby sa sieť stabilizovala
            clearTimeout(pendingSyncTimer);
            pendingSyncTimer = setTimeout(syncPendingData, 2000);
        } else {
             console.log('Zariadenie je offline.');
             showNotification('Ste v režime offline. Zmeny sa ukladajú lokálne.', 'warning');
        }
    }

    // Debounce funkcia
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const context = this;
        const later = () => {
          timeout = null;
          func.apply(context, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Generovanie kľúčov pre LocalStorage a Firestore
    const getLocalStorageKey = (year, month) => `workData-${year}-${month}`;
    const getPendingSyncKey = (year, month) => `pendingSync-${year}-${month}`;
    const getFirestoreDocId = (year, month) => `${year}-${month}`; // Jednoduchý formát pre ID dokumentu


    // -------------------- Inicializácia UI Hodnôt --------------------
    function initializeUIValues() {
        populateYearSelect();
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        hourlyWageInput.value = hourlyWage.toFixed(2); // Vždy zobraz 2 miesta v inpute mzdy
        taxRateInput.value = (taxRate * 100).toFixed(1);
        updateEmployeeSubtitle();
        // Aplikácia tmavého režimu pri načítaní
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        updateDarkModeButtonIcon(); // Aktualizácia ikonky tlačidla
    }

    function updateEmployeeSubtitle() {
        employeeSubtitle.textContent = employeeName ? `Pracovník: ${employeeName}` : '(Meno pracovníka nezadané)';
    }

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = new Date().getFullYear() + 2;
      yearSelect.innerHTML = '';
      for (let year = endYear; year >= startYear; year--) { // Od najnovšieho po najstarší
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }

    // -------------------- AUTENTIFIKÁCIA (Firebase Auth) --------------------
    window.login = async function() {
      if (!navigator.onLine) return showNotification('Prihlásenie nie je možné v režime offline.', 'error');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) return showNotification('Prosím, zadajte email aj heslo.', 'warning');

      showLoading(true);
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        showNotification(`Vitajte späť, ${userCredential.user.email}!`, 'success');
        // Zmena stavu sa spracuje v onAuthStateChanged
      } catch (error) {
        console.error('Chyba pri prihlásení:', error);
        showNotification(`Chyba pri prihlásení: ${error.message}`, 'error');
      } finally {
          showLoading(false);
      }
    }

    window.register = async function() {
      if (!navigator.onLine) return showNotification('Registrácia nie je možná v režime offline.', 'error');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
       if (!email || !password) return showNotification('Prosím, zadajte email aj heslo pre registráciu.', 'warning');
      if (password.length < 6) return showNotification('Heslo musí mať aspoň 6 znakov.', 'warning');

      showLoading(true);
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await createUserProfileIfNeeded(userCredential.user); // Vytvorí profil, ak neexistuje
        showNotification(`Registrácia úspešná pre ${userCredential.user.email}!`, 'success');
        // Zmena stavu sa spracuje v onAuthStateChanged
      } catch (error) {
        console.error('Chyba pri registrácii:', error);
        showNotification(`Chyba pri registrácii: ${error.message}`, 'error');
      } finally {
          showLoading(false);
      }
    }

    window.logout = async function() {
        showLoading(true);
        try {
            await signOut(auth);
            showNotification('Boli ste úspešne odhlásený.', 'info');
            // Vymazanie stavu prihlásenia sa spracuje v onAuthStateChanged
        } catch (error) {
            console.error('Chyba pri odhlásení:', error);
            showNotification('Chyba pri odhlásení: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function createUserProfileIfNeeded(user) {
      if (!user) return;
      const userDocRef = doc(db, 'users', user.uid); // Hlavný dokument užívateľa
      try {
        const docSnap = await getDoc(userDocRef);
        if (!docSnap.exists()) {
          // Použijeme batch na vytvorenie profilu a počiatočného dokumentu v subkolekcii
          const batch = writeBatch(db);
          batch.set(userDocRef, {
            email: user.email,
            createdAt: serverTimestamp(), // Použije čas servera
          });
           // Voliteľne môžeme vytvoriť prázdny dokument v subkolekcii, aby existovala
          // const initialWorkDataRef = doc(db, 'users', user.uid, 'workData', 'initial_setup');
          // batch.set(initialWorkDataRef, { setupComplete: true });

          await batch.commit();
          console.log('Vytvorený profil pre nového užívateľa:', user.uid);
        }
      } catch (error) {
          console.error('Chyba pri vytváraní/kontrole profilu užívateľa:', error);
      }
    }

    // Listener na zmeny stavu prihlásenia - centrálny bod pre reakciu na login/logout
    onAuthStateChanged(auth, async (user) => { // Pridaný async
      console.log("Auth State Changed. User:", user ? user.email : 'None');
      currentUser = user; // Nastavenie globálnej premennej

      // Aktualizácia UI podľa stavu prihlásenia
      loginForm.style.display = user ? 'none' : 'flex';
      userInfo.style.display = user ? 'flex' : 'none';
      if (user) {
          userEmailSpan.textContent = user.email;
          await loadInitialData(); // Načíta dáta pre prihláseného užívateľa
          syncPendingData(); // Skontroluje čakajúce dáta hneď po prihlásení
      } else {
          userEmailSpan.textContent = '';
          // Pri odhlásení načítame dáta LEN z LocalStorage
          currentDataState = {}; // Vymažeme stav z pamäte
          loadFromLocalStorageOnly();
      }
      // Vždy prepočítame súčty po zmene stavu
      calculateTotal();
    });


    // -------------------- SPRÁVA DÁT (Načítanie, Ukladanie, Synchronizácia) --------------------

    // Načítanie dát pri štarte aplikácie alebo zmene mesiaca/roka (pre prihláseného)
    async function loadInitialData() {
        if (!currentUser) return; // Iba pre prihlásených

        const localKey = getLocalStorageKey(currentYear, currentMonth);
        const localDataString = localStorage.getItem(localKey);

        showLoading(true);
        try {
            if (localDataString) {
                console.log(`Načítavam dáta pre ${currentYear}-${currentMonth} z localStorage (priorita).`);
                const localData = JSON.parse(localDataString);
                applyDataToUI(localData); // Aplikuje dáta do UI
                currentDataState = localData; // Uložíme do pamäte

                // Voliteľné: Skontrolovať, či vo Firestore nie je novšia verzia (podľa timestampu)
                // Ak áno, opýtať sa používateľa, či chce aktualizovať.
                // Pre jednoduchosť to teraz preskočíme a prioritizujeme lokálne dáta.

            } else if (navigator.onLine) {
                console.log(`LocalStorage prázdny pre ${currentYear}-${currentMonth}, pokúšam sa načítať z Firestore.`);
                await loadFromFirebase(false); // Voláme bez potvrdenia
            } else {
                 console.log(`Offline a žiadne lokálne dáta pre ${currentYear}-${currentMonth}.`);
                 applyDataToUI({}); // Aplikuje prázdne dáta (vyčistí tabuľku)
                 currentDataState = {};
            }
        } catch (error) {
             console.error("Chyba pri načítavaní počiatočných dát:", error);
             showNotification("Chyba pri načítavaní dát. Skúste obnoviť stránku.", "error");
             applyDataToUI({}); // V prípade chyby zobrazí prázdnu tabuľku
             currentDataState = {};
        } finally {
            showLoading(false);
        }
    }

    // Načítanie dát iba z LocalStorage (pre neprihlásených alebo pri štarte offline)
    function loadFromLocalStorageOnly() {
        const localKey = getLocalStorageKey(currentYear, currentMonth);
        const localDataString = localStorage.getItem(localKey);
        console.log(`Načítavam dáta pre ${currentYear}-${currentMonth} iba z localStorage.`);
        try {
            const localData = localDataString ? JSON.parse(localDataString) : {};
            applyDataToUI(localData);
             currentDataState = localData;
        } catch (error) {
            console.error("Chyba pri parsovaní dát z localStorage:", error);
            showNotification("Chyba pri čítaní lokálnych dát.", "error");
            applyDataToUI({}); // Zobrazí prázdnu tabuľku
             currentDataState = {};
        }
        calculateTotal(); // Prepočíta súčty (aj keď sú dáta prázdne)
    }

    // Manuálne načítanie dát z Firebase (tlačidlom)
    window.loadFromFirebase = async function(requireConfirmation = true) {
        if (!currentUser) return showNotification('Pre načítanie z cloudu sa musíte prihlásiť.', 'warning');
        if (!navigator.onLine) return showNotification('Načítanie z cloudu vyžaduje pripojenie na internet.', 'warning');

        const localKey = getLocalStorageKey(currentYear, currentMonth);
        const pendingKey = getPendingSyncKey(currentYear, currentMonth);

        // Skontrolujeme, či existujú lokálne zmeny (v LS alebo ako pending)
        const localDataString = localStorage.getItem(localKey);
        const pendingDataString = localStorage.getItem(pendingKey);
        let localChangesExist = false;
        if (localDataString) {
            // Porovnáme lokálne dáta s tými v pamäti (ak už boli načítané)
            // Toto je zjednodušené, presnejšie by bolo porovnávať timestampy alebo hash
            try {
                 if (JSON.stringify(currentDataState) !== localDataString) {
                     localChangesExist = true;
                 }
            } catch {}
        }
         if (pendingDataString) {
            localChangesExist = true; // Ak existuje pending flag, sú tam zmeny
         }


        if (requireConfirmation && localChangesExist) {
            if (!confirm('Naozaj chcete načítať dáta z cloudu? Týmto sa prepíšu všetky lokálne zmeny pre tento mesiac, ktoré neboli synchronizované.')) {
                console.log('Načítanie z Firebase zrušené používateľom.');
                return;
            }
        }

        console.log(`Manuálny pokus o načítanie dát pre ${currentYear}-${currentMonth} z Firestore.`);
        showLoading(true);

        try {
            const firestoreDocId = getFirestoreDocId(currentYear, currentMonth);
            const userDocRef = doc(db, 'users', currentUser.uid, 'workData', firestoreDocId);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const storedData = docSnap.data();
                // Prevod Firestore Timestamp na ISO string pre konzistenciu
                if (storedData.lastUpdated instanceof Timestamp) {
                    storedData.lastUpdated = storedData.lastUpdated.toDate().toISOString();
                }

                console.log('Dáta z Firestore načítané, aplikujem a ukladám do localStorage.');
                const dataString = JSON.stringify(storedData);
                localStorage.setItem(localKey, dataString); // Prepíšeme LS dátami z cloudu
                localStorage.removeItem(pendingKey); // Odstránime pending flag

                applyDataToUI(storedData); // Aplikujeme načítané dáta do UI
                currentDataState = storedData; // Aktualizujeme stav v pamäti
                showNotification('Dáta boli úspešne načítané z cloudu.', 'success');
            } else {
                console.log(`Žiadne údaje vo Firestore pre ${firestoreDocId}.`);
                showNotification('Pre tento mesiac neboli v cloude nájdené žiadne dáta.', 'info');
                // Ak v cloude nič nie je, NEVYMAZÁVAME lokálne dáta automaticky.
                // Ak používateľ chce začať nanovo, môže použiť reset alebo manuálne vymazať riadky.
                // Ak by sme chceli vymazať lokálne dáta, ak v cloude nič nie je:
                // localStorage.removeItem(localKey);
                // localStorage.removeItem(pendingKey);
                // applyDataToUI({});
                // currentDataState = {};
            }
        } catch (error) {
            console.error('Chyba pri manuálnom načítavaní z Firestore:', error);
            showNotification(`Chyba pri načítavaní dát z cloudu: ${error.message}`, 'error');
        } finally {
            showLoading(false);
        }
    }

    // Aplikácia dát (z LS alebo FS) do UI a aktualizácia globálnych premenných
    function applyDataToUI(dataObject) {
        console.log("Aplikujem dáta do UI:", dataObject);
        currentDataState = dataObject || {}; // Uložíme do pamäte

        // Aplikácia nastavení z načítaných dát, s fallbackom na aktuálne hodnoty
        hourlyWage = parseFloat(currentDataState.hourlyWage ?? hourlyWage);
        taxRate = parseFloat(currentDataState.taxRate ?? taxRate);
        employeeName = currentDataState.employeeName ?? employeeName;
        decimalPlaces = parseInt(currentDataState.decimalPlaces ?? decimalPlaces);

        // Aktualizácia UI pre nastavenia
        hourlyWageInput.value = hourlyWage.toFixed(2); // Vždy 2 miesta v inpute
        taxRateInput.value = (taxRate * 100).toFixed(1);
        employeeNameInput.value = employeeName;
        updateEmployeeSubtitle();
        decimalPlacesSelect.value = decimalPlaces;

        // Vytvorenie štruktúry tabuľky (vyčistí predchádzajúce riadky)
        createTableStructure();

        // Aplikácia dát do tabuľky
        const daysData = currentDataState.data || [];
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);

        for (let i = 1; i <= daysInMonth; i++) {
             const day = daysData[i-1] || {}; // Získaj dáta pre deň alebo prázdny objekt
             const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
             const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
             const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

             if (startElement) startElement.value = day.start || '';
             if (endElement) endElement.value = day.end || '';
             if (breakElement) breakElement.value = day.breakTime || '';

             // Prepočítame riadok, aby sa aktualizovali aj vypočítané hodnoty (čas, mzdy)
             calculateRow(i);
        }

        // Po aplikovaní všetkých riadkov prepočítame celkové súčty
        calculateTotal();
        console.log(`Dáta pre ${currentYear}-${currentMonth} úspešne aplikované.`);
    }

    // -------------------- Ukladanie a Synchronizácia --------------------

    // Zozbieranie aktuálnych dát z UI do objektu
    function collectCurrentDataForSave() {
         const saveData = {
            hourlyWage: hourlyWage,
            taxRate: taxRate,
            employeeName: employeeName,
            decimalPlaces: decimalPlaces,
            lastUpdated: new Date().toISOString(), // ISO string pre jednoduché porovnanie
            data: []
         };
         const daysInMonth = getDaysInMonth(currentMonth, currentYear);

         for (let i = 1; i <= daysInMonth; i++) {
            const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

            // Ukladáme iba stringy, parsovanie a výpočty sa robia pri načítaní/zobrazení
            saveData.data.push({
                start: startElement?.value || '',
                end: endElement?.value || '',
                breakTime: breakElement?.value || '',
                // Uložíme aj vypočítané hodnoty ako stringy
                gross: grossElement?.value || (0).toFixed(decimalPlaces),
                net: netElement?.value || (0).toFixed(decimalPlaces)
            });
         }
         return saveData;
    }

    // Hlavná funkcia volaná po zmene dát (debounced)
    const handleDataChange = debounce(async () => { // Async kvôli saveToFirestore
        if (isSaving) {
             console.log("Preskakujem ukladanie, predchádzajúce ešte prebieha.");
             return;
        }
        isSaving = true;
        console.log("Detekovaná zmena dát, spúšťam proces ukladania...");

        // 1. Prepočítať celkové súčty (riadky sa prepočítavajú priebežne)
        calculateTotal();

        // 2. Zozbierať aktuálne dáta
        const currentDataToSave = collectCurrentDataForSave();
        const dataString = JSON.stringify(currentDataToSave);
        const localKey = getLocalStorageKey(currentYear, currentMonth);
        const pendingKey = getPendingSyncKey(currentYear, currentMonth);

        // 3. VŽDY uložiť do LocalStorage
        try {
            localStorage.setItem(localKey, dataString);
            console.log(`Dáta pre ${currentYear}-${currentMonth} uložené do localStorage.`);
            currentDataState = currentDataToSave; // Aktualizujeme stav v pamäti
        } catch (error) {
             console.error("Kritická chyba pri ukladaní do localStorage:", error);
             showNotification('Kritická chyba: Nepodarilo sa uložiť dáta lokálne!', 'error', 0);
             isSaving = false;
             return; // Neukladáme do FS, ak LS zlyhalo
        }

        // 4. Pokúsiť sa uložiť do Firestore
        await saveToFirestore(currentDataToSave, dataString); // Pošleme dáta priamo

        isSaving = false;
        console.log("Proces ukladania dokončený.");
    }, 750); // Znížený debounce čas na 750ms

    // Ukladanie do Firestore
    async function saveToFirestore(saveData, dataString) { // Prijíma dáta ako argument
        if (!currentUser) {
            console.log("Neprihlásený, preskakujem Firestore.");
            return;
        }

        const localKey = getLocalStorageKey(currentYear, currentMonth);
        const pendingKey = getPendingSyncKey(currentYear, currentMonth);

        // Pridáme serverový timestamp pre presnejšie sledovanie aktualizácií vo Firestore
        const dataForFirestore = {
            ...saveData,
            lastUpdated: serverTimestamp() // Použije čas servera Firestore
        };

        if (navigator.onLine) {
            console.log(`Pokus o synchronizáciu ${currentYear}-${currentMonth} s Firestore.`);
            try {
                const firestoreDocId = getFirestoreDocId(currentYear, currentMonth);
                const userDocRef = doc(db, 'users', currentUser.uid, 'workData', firestoreDocId);
                await setDoc(userDocRef, dataForFirestore); // Prepíše dokument
                console.log(`Dáta ${firestoreDocId} úspešne synchronizované.`);
                localStorage.removeItem(pendingKey); // Odstrániť pending flag
                showNotification('Dáta synchronizované s cloudom.', 'success', 1500);
            } catch (error) {
                console.error(`Chyba pri ukladaní ${currentYear}-${currentMonth} do Firestore:`, error);
                showNotification('Chyba synchronizácie. Dáta uložené lokálne.', 'error');
                // Uložíme verziu s ISO timestampom ako pending
                localStorage.setItem(pendingKey, dataString);
            }
        } else {
            console.log(`Offline: Označujem ${currentYear}-${currentMonth} ako pending.`);
            localStorage.setItem(pendingKey, dataString); // Uložíme verziu s ISO timestampom
            showNotification('Ste offline, zmeny uložené lokálne.', 'info', 1500);
        }
    }

    // Synchronizácia čakajúcich dát
    async function syncPendingData() {
        if (!currentUser || !navigator.onLine || isSaving) return; // Len pre prihlásených, online a ak neprebieha iné ukladanie

        let pendingKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('pendingSync-')) { // Kontrola existencie kľúča
                pendingKeys.push(key);
            }
        }

        if (pendingKeys.length === 0) {
            console.log('Žiadne čakajúce dáta na synchronizáciu.');
            return;
        }

        console.log(`Nájdené ${pendingKeys.length} čakajúce mesiace na synchronizáciu.`);
        showNotification(`Synchronizujem ${pendingKeys.length} mesiacov...`, 'info');
        isSaving = true; // Zablokujeme ďalšie ukladania počas synchronizácie
        showLoading(true);

        let successCount = 0;
        let errorCount = 0;
        const batch = writeBatch(db); // Použijeme batch pre efektívnejší zápis
        let batchHasWrites = false;

        for (const pendingKey of pendingKeys) {
            const dataString = localStorage.getItem(pendingKey);
            if (!dataString) continue;

            const yearMonthMatch = pendingKey.match(/pendingSync-(\d{4})-(\d{1,2})/);
            if (!yearMonthMatch) continue;
            const [, year, month] = yearMonthMatch;
            const firestoreDocId = getFirestoreDocId(year, month);

            try {
                const dataToSync = JSON.parse(dataString);
                // Pridáme server timestamp pre Firestore verziu
                const dataForFirestore = { ...dataToSync, lastUpdated: serverTimestamp() };
                const userDocRef = doc(db, 'users', currentUser.uid, 'workData', firestoreDocId);
                batch.set(userDocRef, dataForFirestore); // Pridáme do batchu
                batchHasWrites = true;
                console.log(`Pripravené na synchronizáciu (batch): ${firestoreDocId}`);
            } catch (error) {
                console.error(`Chyba pri príprave dát ${firestoreDocId} na synchronizáciu:`, error);
                errorCount++; // Chyba pri lokálnom spracovaní, necháme pending
            }
        }

        // Odošleme batch, ak obsahuje nejaké zápisy
        if (batchHasWrites) {
            try {
                await batch.commit();
                console.log('Batch synchronizácia úspešná.');
                // Odstránime pending kľúče pre úspešne synchronizované dáta
                for (const pendingKey of pendingKeys) {
                     // Malá kontrola, či medzitým nevznikla chyba pri príprave
                     const yearMonthMatch = pendingKey.match(/pendingSync-(\d{4})-(\d{1,2})/);
                     if (yearMonthMatch) {
                         // Tu by sme mohli pridať kontrolu, či tento konkrétny dokument nespôsobil chybu,
                         // ale pre jednoduchosť teraz odstránime všetky spracované kľúče, ak batch prešiel.
                         localStorage.removeItem(pendingKey);
                         successCount++;
                     }
                }
                 if (successCount > 0) showNotification(`Synchronizácia ${successCount} mesiacov dokončená.`, 'success');

            } catch (error) {
                console.error('Chyba pri odosielaní batchu do Firestore:', error);
                errorCount = pendingKeys.length; // Ak batch zlyhá, všetky sú chybné
                showNotification('Chyba pri synchronizácii dát s cloudom.', 'error');
                // Pending kľúče zostávajú v LS pre ďalší pokus
            }
        }

        if (errorCount > 0) {
             console.log(`Nepodarilo sa synchronizovať ${errorCount} mesiacov.`);
             // Notifikácia sa zobrazí buď pri chybe prípravy alebo chybe batchu
        }

        isSaving = false;
        showLoading(false);
    }


    // -------------------- TVORBA TABUĽKY a VÝPOČTY --------------------

    function getDayName(year, month, day) {
      const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"];
      try {
        // Dôležité: new Date() pracuje s mesiacmi 0-11
        const date = new Date(Date.UTC(year, month, day)); // Použitie UTC pre konzistenciu
        if (isNaN(date.getTime())) return "?"; // Neplatný dátum
        return daysOfWeek[date.getUTCDay()];
      } catch (e) {
        return "?";
      }
    }

    function getDaysInMonth(month, year) {
        // 0. deň nasledujúceho mesiaca je posledný deň aktuálneho mesiaca
        return new Date(year, month + 1, 0).getDate();
    }

    // Vytvára LEN HTML štruktúru tabuľky
    function createTableStructure() {
      console.log(`Vytváram štruktúru tabuľky pre ${month + 1}/${year}`); // Použitie globálnych premenných
      if (!workDaysTbody) return console.error("Chyba: tbody#workDays nenájdený!");

      workDaysTbody.innerHTML = ''; // Vyčistenie
      const today = new Date();
      const currentDay = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();
      const daysInMonth = getDaysInMonth(currentMonth, currentYear); // Použitie globálnych

      const fragment = document.createDocumentFragment();

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        const dayDate = new Date(currentYear, currentMonth, i);
        const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
        const isCurrentDay = i === currentDay && currentMonth === currentMonthIndex && currentYear === currentYearValue;

        if (isCurrentDay) row.classList.add('current-day');
        if (isWeekend) row.classList.add('weekend'); // Pridanie triedy pre víkend

        const dayName = getDayName(currentYear, currentMonth, i);

        // Použitie data-* atribútov pre ľahší prístup k dňu
        row.dataset.day = i;
        row.innerHTML = `
          <td class="day-cell">${i}. ${dayName}</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" data-day="${i}" data-field="start" maxlength="5" pattern="\\d{2}:\\d{2}" inputmode="numeric" placeholder="HH:MM" oninput="formatTimeInput(this)" onchange="handleDataChange()"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" data-day="${i}" data-field="end" maxlength="5" pattern="\\d{2}:\\d{2}" inputmode="numeric" placeholder="HH:MM" oninput="formatTimeInput(this)" onchange="handleDataChange()"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" data-day="${i}" data-field="break" min="0" step="0.1" inputmode="decimal" placeholder="hod." oninput="calculateRowForInput(this)" onchange="handleDataChange()"></td>
          <td class="total-cell" id="total-${currentYear}-${currentMonth}-${i}">0h 0m (0.00 h)</td>
          <td><input type="text" class="salary-output" id="gross-${currentYear}-${currentMonth}-${i}" readonly placeholder="€"></td>
          <td><input type="text" class="salary-output" id="net-${currentYear}-${currentMonth}-${i}" readonly placeholder="€"></td>
          <td class="action-cell" style="text-align: center;"><button class="btn reset-btn" onclick="resetRow(${i})" title="Vynulovať riadok ${i}">X</button></td>
        `;
        fragment.appendChild(row);
      }
      workDaysTbody.appendChild(fragment);
      console.log('Štruktúra tabuľky vytvorená.');
    }

    // Formátovanie HH:MM pri zadávaní
    window.formatTimeInput = function(input) {
        const day = input.dataset.day;
        input.classList.remove('invalid'); // Odstrániť prípadnú predchádzajúcu chybu
        let value = input.value.replace(/[^\d]/g, '');
        let formattedValue = value;

        if (value.length > 2) {
            formattedValue = value.slice(0, 2) + ':' + value.slice(2, 4);
        } else if (value.length === 2 && input.value.length === 2) {
            formattedValue = value + ':';
        }
        if (formattedValue.length > 5) formattedValue = formattedValue.slice(0, 5);
        input.value = formattedValue;

        // Validácia až keď je formát potenciálne kompletný
        if (formattedValue.length === 5) {
             if (TIME_REGEX.test(formattedValue)) {
                 calculateRow(day); // Prepočítať riadok
                 // Presun fokusu (voliteľné, môže byť otravné)
                 // const nextField = input.dataset.field === 'start' ? 'end' : 'break';
                 // moveFocusAndSelect(document.getElementById(`${nextField}-${currentYear}-${currentMonth}-${day}`));
             } else {
                 input.classList.add('invalid');
                 showNotification(`Neplatný čas (${formattedValue}). Zadajte HH:MM (00:00-23:59).`, "warning", 2500);
                 calculateRow(day); // Prepočíta (vynuluje mzdu) aj pri neplatnom čase
             }
        } else {
             calculateRow(day); // Prepočíta aj pri nekompletnom čase
        }
         // handleDataChange() sa volá onchange
    }

    // Presun fokusu a označenie textu
    function moveFocusAndSelect(nextElement) {
        if (nextElement) {
            nextElement.focus();
            if (nextElement.tagName === 'INPUT' && nextElement.type !== 'button' && !nextElement.readOnly) {
                 setTimeout(() => nextElement.select(), 0);
            }
        }
    }

     // Funkcia volaná pri zmene inputu (okrem času)
     window.calculateRowForInput = function(input) {
         const day = input.dataset.day;
         if (day) {
            calculateRow(day);
         }
         // handleDataChange() sa volá onchange
     }

    // Výpočet jedného riadku
    function calculateRow(day) {
        if (!day) return;
        const dayStr = day.toString(); // Pre istotu pracujeme so stringom

        const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${dayStr}`);
        const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${dayStr}`);
        const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayStr}`);
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayStr}`);
        const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayStr}`);
        const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayStr}`);

        if (!totalCell || !grossInput || !netInput) return; // Základné elementy musia existovať

        const startTime = startInput?.value || '';
        const endTime = endInput?.value || '';
        const breakTimeHours = parseFloat(breakInput?.value) || 0;

        let decimalHours = 0;
        let hours = 0;
        let minutes = 0;
        let isValid = true;

        // Validácia časov
        const isStartValid = TIME_REGEX.test(startTime);
        const isEndValid = TIME_REGEX.test(endTime);
         if (startInput) startInput.classList.toggle('invalid', startTime !== '' && !isStartValid);
         if (endInput) endInput.classList.toggle('invalid', endTime !== '' && !isEndValid);

        if (isStartValid && isEndValid) {
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);

            // Výpočet rozdielu v minútach (bezpečný pre prácu cez polnoc)
            const startTotalMinutes = startH * 60 + startM;
            let endTotalMinutes = endH * 60 + endM;
            if (endTotalMinutes < startTotalMinutes) { // Práca cez polnoc
                endTotalMinutes += 24 * 60;
            }
            const diffMinutes = endTotalMinutes - startTotalMinutes;
            const breakMinutes = breakTimeHours * 60;
            let workedMinutes = Math.max(0, diffMinutes - breakMinutes);

            workedMinutes = Math.round(workedMinutes); // Zaokrúhlenie na celé minúty

            hours = Math.floor(workedMinutes / 60);
            minutes = workedMinutes % 60;
            decimalHours = workedMinutes / 60;
        } else {
            isValid = false; // Ak aspoň jeden čas nie je validný, celý riadok je nevalidný pre výpočet
        }

        // Aktualizácia bunky s celkovým časom
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

        // Výpočet miezd (len ak sú časy validné)
        const grossSalary = isValid ? decimalHours * hourlyWage : 0;
        const netSalary = isValid ? grossSalary * (1 - taxRate) : 0;

        // Použitie toLocaleString pre formátovanie meny
        const formatCurrency = (value) => value.toLocaleString('sk-SK', { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });

        grossInput.value = formatCurrency(Math.max(0, grossSalary));
        netInput.value = formatCurrency(Math.max(0, netSalary));
    }

    // Vynulovanie riadku
    window.resetRow = function(day) {
        const dayStr = day.toString();
        ['start', 'end', 'break'].forEach(field => {
             const input = document.getElementById(`${field}-${currentYear}-${currentMonth}-${dayStr}`);
             if (input) {
                 input.value = '';
                 input.classList.remove('invalid');
             }
        });
        calculateRow(day); // Prepočíta na nulu
        handleDataChange(); // Uloží zmeny
        document.getElementById(`start-${currentYear}-${currentMonth}-${dayStr}`)?.focus();
    }

    // Výpočet celkových súčtov
    function calculateTotal() {
        let totalMinutesWorked = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithValidEntries = 0;
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);

        for (let i = 1; i <= daysInMonth; i++) {
            const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
            const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
            const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
            // Čítame hodnoty priamo z readonly inputov, ale parsujeme ich späť na čísla
            const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
            const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);

            if (!startInput || !endInput || !breakInput || !grossInput || !netInput) continue;

            const startTime = startInput.value;
            const endTime = endInput.value;
            const breakTimeHours = parseFloat(breakInput.value) || 0;
            let dayWorkedMinutes = 0;

            if (TIME_REGEX.test(startTime) && TIME_REGEX.test(endTime)) {
                 const [startH, startM] = startTime.split(':').map(Number);
                 const [endH, endM] = endTime.split(':').map(Number);
                 const startTotalMinutes = startH * 60 + startM;
                 let endTotalMinutes = endH * 60 + endM;
                 if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;
                 const diffMinutes = endTotalMinutes - startTotalMinutes;
                 const breakMinutes = breakTimeHours * 60;
                 dayWorkedMinutes = Math.max(0, diffMinutes - breakMinutes);
                 dayWorkedMinutes = Math.round(dayWorkedMinutes);

                 totalMinutesWorked += dayWorkedMinutes;
                 daysWithValidEntries++;
             }

             // Parsujeme hodnoty z formátovaných stringov
             const parseCurrency = (value) => parseFloat(value.replace(/\s/g, '').replace(',', '.')) || 0;
             totalGrossSalary += parseCurrency(grossInput.value);
             totalNetSalary += parseCurrency(netInput.value);
        }

        const totalHours = Math.floor(totalMinutesWorked / 60);
        const totalMinutesRemainder = totalMinutesWorked % 60;
        const totalDecimalHours = totalMinutesWorked / 60;

        const averageNetSalary = daysWithValidEntries > 0 ? totalNetSalary / daysWithValidEntries : 0;
        const averageWorkedMinutes = daysWithValidEntries > 0 ? totalMinutesWorked / daysWithValidEntries : 0;
        const averageMinutesRounded = Math.round(averageWorkedMinutes);
        const averageHours = Math.floor(averageMinutesRounded / 60);
        const averageMinutesRemainder = averageMinutesRounded % 60;
        const averageDecimalHours = averageWorkedMinutes / 60;

        const formatCurrencyTotal = (value) => value.toLocaleString('sk-SK', { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });

        totalSalaryDiv.innerHTML = `
            Počet dní s platným záznamom: <strong>${daysWithValidEntries}</strong><br>
            Celkový odpracovaný čas: <strong>${totalHours}h ${totalMinutesRemainder}m</strong> (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>
            Celková hrubá mzda: <strong>${formatCurrencyTotal(totalGrossSalary)} €</strong><br>
            Celková čistá mzda: <strong>${formatCurrencyTotal(totalNetSalary)} €</strong><br>
            Priemerná denná čistá mzda: ${formatCurrencyTotal(averageNetSalary)} €<br>
            Priemerný denný odpracovaný čas: ${averageHours}h ${averageMinutesRemainder}m (${averageDecimalHours.toFixed(decimalPlaces)} h)
        `;
    }


    // -------------------- EXPORT a ZDIEĽANIE --------------------
    function getMonthName(monthIndex) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[monthIndex] || "";
    }

    function generatePDFDoc() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Použijeme štandardné fonty pre maximálnu kompatibilitu
        doc.setFont('helvetica', 'normal');

        const monthName = getMonthName(currentMonth);
        doc.setFontSize(16);
        doc.text(`Výkaz Práce - ${monthName} ${currentYear}`, 14, 15);
        doc.setFontSize(12);
        doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 22);
        doc.text(`Hodinová mzda: ${hourlyWage.toLocaleString('sk-SK', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`, 14, 28);
        doc.text(`Daň: ${(taxRate * 100).toFixed(1)} %`, doc.internal.pageSize.width - 40, 28, { align: 'right'}); // Zarovnané vpravo

        const tableData = [];
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);

        for (let i = 1; i <= daysInMonth; i++) {
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const breakH = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value) || 0;
            const total = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || '';
            // Čítame už naformátované hodnoty pre PDF
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';

            // Pridáme riadok len ak je relevantný
            if (start || end || breakH > 0) {
                 const startDisplay = TIME_REGEX.test(start) ? start : (start ? `${start} (?)` : ''); // Označ neplatný čas
                 const endDisplay = TIME_REGEX.test(end) ? end : (end ? `${end} (?)` : '');
                 tableData.push([
                     `${i}. ${getDayName(currentYear, currentMonth, i)}`,
                     startDisplay,
                     endDisplay,
                     breakH.toLocaleString('sk-SK', { minimumFractionDigits: 1, maximumFractionDigits: 2 }), // Prestávka na 1-2 des. miesta
                     total,
                     gross, // Už naformátované
                     net    // Už naformátované
                 ]);
             }
        }

        doc.autoTable({
            head: [['Deň', 'Príchod', 'Odchod', 'Prestávka (h)', 'Odpracované', 'Hrubá (€)', 'Čistá (€)']],
            body: tableData,
            startY: 35,
            theme: 'grid', // 'striped', 'grid', 'plain'
            styles: { font: 'helvetica', fontSize: 9, cellPadding: 2 },
            headStyles: { fillColor: [51, 51, 51], textColor: 255, fontStyle: 'bold', halign: 'center' },
            alternateRowStyles: { fillColor: [245, 245, 245] },
            columnStyles: { // Príklad zarovnania stĺpcov
                 0: { halign: 'left', cellWidth: 25 }, // Deň
                 1: { halign: 'center', cellWidth: 18 }, // Príchod
                 2: { halign: 'center', cellWidth: 18 }, // Odchod
                 3: { halign: 'right', cellWidth: 20 }, // Prestávka
                 4: { halign: 'left', cellWidth: 35 }, // Odpracované
                 5: { halign: 'right', cellWidth: 22 }, // Hrubá
                 6: { halign: 'right', cellWidth: 22 }  // Čistá
            }
        });

        const totalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        const totalTextContent = totalSalaryDiv.innerHTML
                                     .replace(/<strong>(.*?)<\/strong>/g, '$1')
                                     .replace(/<br\s*\/?>/gi, '\n');
        doc.text(totalTextContent, 14, totalY);

        // Pridanie pätičky (voliteľné)
        const pageCount = doc.internal.getNumberOfPages();
        doc.setFontSize(8);
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.text(`Strana ${i} z ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
            doc.text(`Vygenerované: ${new Date().toLocaleString('sk-SK')}`, 14, doc.internal.pageSize.height - 10);
        }

        return doc;
    }

    window.exportToPDF = function() {
        showLoading(true);
        try {
            const doc = generatePDFDoc();
            const monthName = getMonthName(currentMonth);
            const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-z0-9]/gi, '_').toLowerCase(); // Bezpečnejší názov súboru
            doc.save(`vykaz_prace_${safeEmployeeName}_${monthName}_${currentYear}.pdf`);
            showNotification('PDF súbor bol úspešne vygenerovaný.', 'success');
        } catch (error) {
             console.error("Chyba pri generovaní PDF:", error);
             showNotification(`Chyba pri exporte do PDF: ${error.message}`, 'error');
        } finally {
            showLoading(false);
        }
    }

    window.sendPDF = async function() {
        showLoading(true);
        try {
            const doc = generatePDFDoc();
            const monthName = getMonthName(currentMonth);
             const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const fileName = `vykaz_prace_${safeEmployeeName}_${monthName}_${currentYear}.pdf`;
            const pdfBlob = doc.output('blob');
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
              await navigator.share({
                files: [pdfFile],
                title: `Výkaz práce ${monthName} ${currentYear}`,
                text: `Výkaz práce pre ${employeeName || 'pracovníka'} za ${monthName} ${currentYear}`
              });
              console.log('PDF úspešne zdieľané.');
              // Notifikácia nie je nutná, lebo systémové UI potvrdí zdieľanie
            } else {
              console.warn('Web Share API (pre súbory) nie je podporované.');
              doc.save(fileName); // Fallback na stiahnutie
              showNotification('Zdieľanie súborov nie je podporované. PDF bolo stiahnuté.', 'warning');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Zdieľanie PDF zrušené.');
                showNotification('Zdieľanie PDF zrušené.', 'info');
            } else {
                console.error('Chyba pri zdieľaní PDF:', error);
                showNotification(`Chyba pri zdieľaní PDF: ${error.message}`, 'error');
            }
        } finally {
             showLoading(false);
        }
    }


    // -------------------- OSTATNÉ NASTAVENIA a ZMENY --------------------

    window.changeDecimalPlaces = function() {
      const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
      if (isNaN(newDecimalPlaces) || newDecimalPlaces < 1 || newDecimalPlaces > 3) return; // Validácia 1-3

      decimalPlaces = newDecimalPlaces;
      localStorage.setItem('decimalPlaces', decimalPlaces.toString());

      // Prepočítať zobrazenie všetkých riadkov a súčtov
      const daysInMonth = getDaysInMonth(currentMonth, currentYear);
      for (let i = 1; i <= daysInMonth; i++) calculateRow(i);
      handleDataChange(); // Spustí uloženie
      showNotification(`Počet desatinných miest nastavený na ${decimalPlaces}.`, 'info', 1500);
    }

    window.updateEmployeeName = function() {
      employeeName = employeeNameInput.value.trim();
      updateEmployeeSubtitle();
      localStorage.setItem('employeeName', employeeName);
      handleDataChange(); // Uloží zmenu mena v dátovom objekte
    }

    window.updateSettings = function() {
      const newHourlyWage = parseFloat(hourlyWageInput.value);
      const newTaxRatePercentage = parseFloat(taxRateInput.value);
      let changed = false;

      if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && newHourlyWage !== hourlyWage) {
          hourlyWage = newHourlyWage;
          localStorage.setItem('hourlyWage', hourlyWage.toString());
          changed = true;
      } else if (isNaN(newHourlyWage) || newHourlyWage < 0) {
          hourlyWageInput.value = hourlyWage.toFixed(2); // Vráti platnú hodnotu
      }

      if (!isNaN(newTaxRatePercentage) && newTaxRatePercentage >= 0 && newTaxRatePercentage <= 100) {
           const newTaxRate = newTaxRatePercentage / 100;
           if (newTaxRate !== taxRate) {
               taxRate = newTaxRate;
               localStorage.setItem('taxRatePercentage', newTaxRatePercentage.toString());
               changed = true;
           }
      } else {
          taxRateInput.value = (taxRate * 100).toFixed(1); // Vráti platnú hodnotu
      }

       // Prepočítať a uložiť iba ak došlo k zmene
       if (changed) {
           console.log("Nastavenia mzdy/dane zmenené, prepočítavam...");
           const daysInMonth = getDaysInMonth(currentMonth, currentYear);
           for (let i = 1; i <= daysInMonth; i++) calculateRow(i);
           handleDataChange(); // Spustí uloženie
       }
    }

    // Zmena mesiaca/roku
    async function changeDate(newMonth, newYear) {
         if (newMonth === currentMonth && newYear === currentYear) return; // Žiadna zmena

         console.log(`Zmena dátumu na: ${newMonth + 1}/${newYear}`);
         currentMonth = newMonth;
         currentYear = newYear;

         // Aktualizácia selectov (pre prípad, že zmena bola iniciovaná inak)
         monthSelect.value = currentMonth;
         yearSelect.value = currentYear;

         // Načítať dáta pre nový mesiac/rok
         // Ak je prihlásený, načíta z LS/FS, inak len z LS
         currentDataState = {}; // Reset stavu v pamäti
         if (currentUser) {
             await loadInitialData();
         } else {
             loadFromLocalStorageOnly();
         }
    }
    window.changeMonth = function() { changeDate(parseInt(monthSelect.value), currentYear); }
    window.changeYear = function() { changeDate(currentMonth, parseInt(yearSelect.value)); }


    // Prepínanie tmavého režimu
    window.toggleDarkMode = function() {
      const isDarkMode = document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      updateDarkModeButtonIcon(); // Aktualizácia ikonky
    }
     function updateDarkModeButtonIcon() {
         const isDarkMode = document.body.classList.contains('dark-mode');
         const iconSpan = document.querySelector('.dark-mode-btn .toggle-icon');
         if (iconSpan) {
             iconSpan.textContent = isDarkMode ? '☀️' : '🌙'; // Zmení ikonku
         }
         const button = document.querySelector('.dark-mode-btn');
         if (button) {
             button.setAttribute('aria-label', isDarkMode ? 'Prepnúť na svetlý režim' : 'Prepnúť na tmavý režim');
             button.title = isDarkMode ? 'Svetlý režim' : 'Tmavý režim'; // Tooltip
         }
     }


    // -------------------- ZÁLOHA a OBNOVA (Excel) --------------------

    window.createBackup = function() {
      const key = getLocalStorageKey(currentYear, currentMonth);
      const dataString = localStorage.getItem(key);

      if (!dataString) return showNotification('Žiadne lokálne dáta na zálohu.', 'warning');

      showLoading(true);
      try {
          const dataObj = JSON.parse(dataString);
          const ws_data = [
            ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované (Text)", "Hrubá Mzda (€)", "Čistá Mzda (€)"]
          ];
          const daysInMonth = getDaysInMonth(currentMonth, currentYear);
          for(let i=1; i <= daysInMonth; i++) {
               const dayData = dataObj.data?.[i-1] || {};
               const totalText = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)?.textContent || ''; // Získať textovú hodnotu
               if(dayData.start || dayData.end || parseFloat(dayData.breakTime || 0) > 0) {
                   ws_data.push([
                       `${i}. ${getDayName(currentYear, currentMonth, i)}`,
                       dayData.start || '',
                       dayData.end || '',
                       parseFloat(dayData.breakTime || 0), // Uložiť ako číslo
                       totalText,
                       parseFloat(dayData.gross?.replace(/[^\d,-]/g, '').replace(',', '.')) || 0, // Parsnúť menu na číslo
                       parseFloat(dayData.net?.replace(/[^\d,-]/g, '').replace(',', '.')) || 0
                   ]);
               }
          }
          ws_data.push([]);
          ws_data.push(["Nastavenie", "Hodnota"]);
          ws_data.push(["Hodinová mzda (€)", dataObj.hourlyWage]);
          ws_data.push(["Daňové percento (%)", dataObj.taxRate * 100]);
          ws_data.push(["Meno pracovníka", dataObj.employeeName]);
          ws_data.push(["Počet desatinných miest", dataObj.decimalPlaces]);
          ws_data.push(["Mesiac zálohy (0-11)", currentMonth]);
          ws_data.push(["Rok zálohy", currentYear]);
          ws_data.push(["Posledná aktualizácia (ISO)", dataObj.lastUpdated]);
          ws_data.push(["Verzia kalkulačky", "Enhanced V2"]);

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          ws['!cols'] = [ {wch:12}, {wch:10}, {wch:10}, {wch:12}, {wch:20}, {wch:15}, {wch:15} ];
          XLSX.utils.book_append_sheet(wb, ws, `Vykaz ${getMonthName(currentMonth)} ${currentYear}`);
          const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-z0-9]/gi, '_').toLowerCase();
          const fileName = `zaloha_vykaz_${safeEmployeeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`;
          XLSX.writeFile(wb, fileName);
          showNotification('Záloha do Excelu vytvorená.', 'success');
      } catch(error) {
           console.error('Chyba pri vytváraní Excel zálohy:', error);
           showNotification(`Chyba pri vytváraní zálohy: ${error.message}`, 'error');
      } finally {
           showLoading(false);
      }
    };

    window.restoreBackup = function() {
        if (!confirm('Naozaj chcete obnoviť dáta zo súboru Excel? Prepíšu sa tým aktuálne zobrazené dáta pre tento mesiac (neukladá sa do cloudu automaticky).')) return;

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        input.onchange = async (event) => { // Async kvôli možnému loadFromFirebase
            const file = event.target.files[0];
            if (!file) return;
            showLoading(true);
            const reader = new FileReader();
            reader.onload = async (e) => { // Async kvôli potvrdeniu a applyDataToUI
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    if (!ws) throw new Error("List nenájdený.");

                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                    let settings = {};
                    let backupMonth = -1, backupYear = -1;
                    const settingRowIndex = jsonData.findIndex(row => row[0]?.toString().toLowerCase() === "nastavenie");
                    if (settingRowIndex !== -1) {
                         for (let i = settingRowIndex + 1; i < jsonData.length; i++) {
                             const key = jsonData[i][0]?.toString().trim().toLowerCase();
                             const value = jsonData[i][1]?.toString().trim();
                             if (!key) continue;
                             if (key.includes("hodinová mzda")) settings.hourlyWage = parseFloat(value);
                             else if (key.includes("daňové percento")) settings.taxRate = parseFloat(value) / 100;
                             else if (key.includes("meno pracovníka")) settings.employeeName = value;
                             else if (key.includes("desatinných miest")) settings.decimalPlaces = parseInt(value);
                             else if (key.includes("mesiac zálohy")) backupMonth = parseInt(value);
                             else if (key.includes("rok zálohy")) backupYear = parseInt(value);
                             else if (key.includes("posledná aktualizácia")) settings.lastUpdated = value;
                         }
                    } else { console.warn("Nastavenia v zálohe nenájdené."); }

                    if (backupYear !== -1 && backupMonth !== -1 && (backupYear !== currentYear || backupMonth !== currentMonth)) {
                        if (!confirm(`Záloha je pre ${getMonthName(backupMonth)} ${backupYear}. Aktuálne prezeráte ${getMonthName(currentMonth)} ${currentYear}. Použiť túto zálohu?`)) {
                             showNotification("Obnova zálohy zrušená.", "info");
                             showLoading(false);
                             return;
                        }
                        // Ak potvrdí, zmeníme aktuálny mesiac/rok APLIKÁCIE
                        await changeDate(backupMonth, backupYear);
                        // Počkáme na prekreslenie a načítanie (aj keď by mali byť dáta prepísané)
                        await new Promise(resolve => setTimeout(resolve, 100)); // Krátka pauza
                    }

                    const headerRowIndex = jsonData.findIndex(row => row[0]?.toString().toLowerCase().includes("deň"));
                    if (headerRowIndex === -1) throw new Error("Hlavička tabuľky nenájdená.");
                    const header = jsonData[headerRowIndex].map(h => h.toString().toLowerCase());
                    const dayIndex = header.indexOf("deň");
                    const startIndex = header.indexOf("príchod");
                    const endIndex = header.indexOf("odchod");
                    const breakIndex = header.indexOf("prestávka (h)");
                    if ([dayIndex, startIndex, endIndex, breakIndex].includes(-1)) throw new Error("Chýbajú stĺpce v hlavičke.");

                    let dataArray = [];
                    const endDataRow = (settingRowIndex !== -1) ? settingRowIndex - 1 : jsonData.length;
                    const daysInTargetMonth = getDaysInMonth(currentMonth, currentYear); // Použijeme už potenciálne zmenený mesiac/rok
                    // Inicializujeme pole správnej dĺžky
                    for(let d=0; d < daysInTargetMonth; d++) dataArray.push({});

                    for (let i = headerRowIndex + 1; i < endDataRow; i++) {
                        const row = jsonData[i];
                        if (!row || !row[dayIndex]) continue;
                        const dayMatch = row[dayIndex].toString().match(/^(\d+)/);
                        if (!dayMatch) continue;
                        const dayNum = parseInt(dayMatch[1]);
                        if (isNaN(dayNum) || dayNum < 1 || dayNum > daysInTargetMonth) continue; // Ignoruj dni mimo rozsahu

                         // Hodnoty čítame ako stringy, formátovanie rieši applyDataToUI a calculateRow
                         dataArray[dayNum - 1] = {
                            start: row[startIndex]?.toString() || "",
                            end: row[endIndex]?.toString() || "",
                            breakTime: row[breakIndex]?.toString() || "",
                            gross: undefined, // Necháme prepočítať
                            net: undefined   // Necháme prepočítať
                         };
                    }

                    const backupData = {
                        data: dataArray,
                        hourlyWage: !isNaN(settings.hourlyWage) ? settings.hourlyWage : hourlyWage,
                        taxRate: !isNaN(settings.taxRate) ? settings.taxRate : taxRate,
                        employeeName: settings.employeeName ?? employeeName,
                        decimalPlaces: !isNaN(settings.decimalPlaces) ? settings.decimalPlaces : decimalPlaces,
                        lastUpdated: settings.lastUpdated || new Date().toISOString()
                    };

                    // Aplikujeme dáta do UI (prepočíta a zobrazí)
                    applyDataToUI(backupData);

                    // Uložíme do LS
                    const localKey = getLocalStorageKey(currentMonth, currentYear); // Použijeme aktuálny (možno zmenený) dátum
                    localStorage.setItem(localKey, JSON.stringify(backupData));

                    // Označíme na synchronizáciu
                    const pendingKey = getPendingSyncKey(currentMonth, currentYear);
                    localStorage.setItem(pendingKey, JSON.stringify(backupData));
                    showNotification('Záloha úspešne obnovená a načítaná lokálne. Pripravené na synchronizáciu.', 'success');
                    syncPendingData(); // Spustí pokus o synchronizáciu

                } catch (error) {
                    console.error('Chyba pri obnove zo zálohy:', error);
                    showNotification(`Chyba pri obnove zo zálohy: ${error.message}`, 'error', 5000);
                } finally {
                    showLoading(false);
                }
            };
            reader.onerror = () => {
                showNotification('Chyba pri čítaní súboru zálohy.', 'error');
                showLoading(false);
            }
            reader.readAsArrayBuffer(file);
        };
        input.click();
    };


    // -------------------- INICIALIZÁCIA APLIKÁCIE --------------------
    function initializeApp() {
        console.log("Inicializácia aplikácie...");
        initializeUIValues(); // Nastavenie počiatočných hodnôt v UI
        updateConnectionStatus(); // Prvotná kontrola stavu pripojenia
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        // Listener onAuthStateChanged sa postará o načítanie dát po inicializácii Firebase
        console.log("Aplikácia pripravená.");
    }

    // Spustenie inicializácie po načítaní DOMu
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }

  </script>

  <!-- Registrácia Service Workera (mimo module script) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna a súbor existuje
          .then(registration => {
            console.log('Service Worker zaregistrovaný:', registration.scope);
            // Implementácia logiky pre aktualizáciu SW (voliteľné)
            registration.onupdatefound = () => {
              const installingWorker = registration.installing;
              if (installingWorker) {
                installingWorker.onstatechange = () => {
                  if (installingWorker.state === 'installed') {
                    if (navigator.serviceWorker.controller) {
                      // Nový obsah je dostupný, ale starý SW stále kontroluje stránku.
                      // Informujte používateľa, aby obnovil stránku.
                      console.log('Nový obsah je dostupný; prosím, obnovte stránku.');
                      // Tu môžete zobraziť notifikáciu používateľovi.
                    } else {
                      // Obsah je uložený do cache pre offline použitie.
                      console.log('Obsah je uložený v cache pre offline použitie.');
                    }
                  }
                };
              }
            };
          })
          .catch(error => {
            console.error('Registrácia Service Workera zlyhala:', error);
          });
      });
       // Sledovanie zmien v service workeri (voliteľné)
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            // Service worker sa zmenil, môže byť potrebné obnoviť stránku
            console.log('Service worker bol aktualizovaný. Odporúča sa obnoviť stránku.');
            // window.location.reload(); // Automatické obnovenie (môže byť rušivé)
        });
    } else {
        console.warn('Service Worker nie je podporovaný.');
    }
  </script>

</body>
</html>
