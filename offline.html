<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doch√°dzka</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="icons/icon-192x192.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#5c67f2">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 16px;
    }
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f4f4f4; /* Mierne priehƒæadn√© pozadie */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-size: 1.2em;
        color: #555;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      color: black;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .settings > div,
    .settings > details {
        flex: 1 1 200px;
        margin: 0;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9em;
    }
    .collapsible-settings summary {
        cursor: pointer;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        background-color: #f8f8f8;
        display: list-item;
        transition: background-color 0.2s ease;
        font-weight: bold;
    }
    .collapsible-settings summary:hover {
        background-color: #eee;
    }
    .collapsible-content {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 5px 5px 5px;
        border-top: 1px solid #eee;
        margin-top: 5px;
    }
    .collapsible-content > div {
        flex: 1 1 200px;
        margin: 0;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 950px;
      table-layout: fixed;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
      vertical-align: top;
      word-wrap: break-word;
        position: relative;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    th:nth-child(1), td:nth-child(1) { width: 40px; }
    th:nth-child(2), td:nth-child(2) { width: 110px; }
    th:nth-child(3), td:nth-child(3) { width: 110px; }
    th:nth-child(4), td:nth-child(4) { width: 90px; text-align: center; }
    th:nth-child(5), td:nth-child(5) { width: 130px;}
    th:nth-child(6), td:nth-child(6) { width: 150px;}
    th:nth-child(7), td:nth-child(7) { width: 100px; text-align: right;}
    th:nth-child(8), td:nth-child(8) { width: 100px; text-align: right;}
    th:nth-child(9), td:nth-child(9) { width: 70px; text-align: center; }

    input[type="tel"], input[type="number"], input[type="text"], select, textarea {
      width: 100%;
      padding: 7px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 3px;
      vertical-align: middle;
    }
    textarea {
        resize: vertical;
        min-height: 38px;
    }
    td:nth-child(6) textarea {
        min-height: 38px;
        max-height: 100px;
        overflow-y: auto;
    }

    .time-input-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
        position: relative;
    }
    .time-input-wrapper input[type="tel"] {
        flex-grow: 1;
        min-width: 45px;
        padding-right: 30px;
    }
    .clock-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.4em;
        color: #555;
        user-select: none;
        z-index: 2;
    }
    .clock-icon:hover {
      color: #007bff;
      opacity: 0.8;
    }
    .btn-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
    .btn {
      padding: 12px 18px;
      border: none;
      border-radius: 4px;
      color: white;
      background-color: #5c67f2;
      cursor: pointer;
      font-size: 1.0em;
      transition: background-color 0.3s ease;
      text-align: center;
      flex: 1 1 150px;
      max-width: 200px;
      box-sizing: border-box;
    }
    .btn:hover { background-color: #4a54e0; }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .backup-btn { background-color: #8a2be2; padding: 18px 22px; }
    .backup-btn:hover { background-color: #6a1bb2; }
    #totalSalary {
      margin-top: 20px;
      padding: 18px;
      background-color: #e9ecef;
      border-radius: 4px;
      font-size: 1.1em;
      line-height: 1.6;
      border: 1px solid #dee2e6;
      text-align: center;
    }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day select, .current-day textarea {
        background-color: #9932cc;
        color: white;
    }
    .logout-section {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        text-align: center;
    }
    #user-info, #login-form {
        display: none;
    }
    #user-info span {
        font-size: 0.95em;
        color: #333;
    }
    #user-info .btn {
        min-width: 150px;
        width: auto;
        flex-grow: 0;
        padding: 8px 16px;
        font-size: 0.9em;
        max-width: 200px;
    }

    #installAppButton {
        padding: 12px 18px;
        border: none;
        border-radius: 4px;
        color: white;
        background-color: #28a745;
        cursor: pointer;
        font-size: 1.0em;
        transition: background-color 0.3s ease;
        text-align: center;
        flex: 1 1 150px;
        max-width: 200px;
        box-sizing: border-box;
        margin-top: 5px;
    }
    #installAppButton:hover {
        background-color: #218838;
    }

    @media (max-width: 768px) {
      body { padding: 5px; font-size: 15px; }
      .container { padding: 12px; max-width: 100%; }
      h1 { font-size: 2.0em; }
      h2 { font-size: 1.1em; }
      .settings { flex-direction: column; align-items: stretch; }
      .settings > div, .settings > details { width: 100%; margin: 5px 0; flex-basis: auto; }
      .collapsible-content { flex-direction: column; align-items: stretch; }
      .collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; }
      table { min-width: 750px; }
      th, td { padding: 8px; font-size: 1.0em; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea {
          font-size: 1.0em;
          padding: 8px;
      }
      .clock-icon { font-size: 1.5em; }
      .btn-container {
          flex-direction: column;
          align-items: center;
      }
      .btn, #installAppButton {
          max-width: none;
          font-size: 1.05em;
          width: 95%;
          margin-left: auto;
          margin-right: auto;
          margin-top: 0;
          margin-bottom: 5px;
          box-sizing: border-box;
          height: 44px;
          padding: 0 20px;
          flex: none;
      }
        .backup-btn {
            padding: 0 22px;
        }
        #user-info .btn {
            width: 80%;
            font-size: 0.95em;
            padding: 10px 16px;
            height: auto;
            margin-bottom: 0;
        }
      #totalSalary { font-size: 1.0em; padding: 15px; }
    }

    @media (max-width: 480px) {
      body { font-size: 14px; }
      .container { padding: 10px; }
      h1 { font-size: 1.8em; }
      h2 { font-size: 1.0em; }
      th, td { font-size: 0.9em; padding: 7px; }
      input[type="tel"], input[type="number"], input[type="text"], select, textarea {
          font-size: 0.95em;
          padding: 8px;
      }
      .settings label { font-size: 1.0em; }
      .clock-icon { font-size: 1.6em; }
      .btn, #installAppButton {
          font-size: 0.95em;
          width: 95%;
          height: 42px;
          padding: 0 15px;
          flex: none;
          margin-bottom: 4px;
      }
      .backup-btn {
          padding: 0 15px;
      }
        #user-info .btn {
            width: 85%;
            padding: 10px 16px;
            height: auto;
            margin-bottom: 0;
        }
      table { min-width: 600px; }
      #totalSalary { font-size: 0.95em; padding: 12px; }
    }

    #saveNotification, #errorNotification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        text-align: center;
        font-size: 0.9em;
    }
    #saveNotification.show, #errorNotification.show {
        opacity: 1;
        visibility: visible;
    }
    #saveNotification { background-color: #4CAF50; }
    #errorNotification { background-color: #f44336; }

    #login-form {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    #login-form input[type="email"], #login-form input[type="password"] {
        width: 100%;
        max-width: 300px;
        padding: 8px;
        margin-bottom: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        box-sizing: border-box;
        font-size: 1em;
    }
    #login-form .btn {
        width: auto;
        max-width: 150px;
        padding: 10px 22px;
        margin: 5px 0;
        font-size: 1em;
        height: auto;
        flex: initial;
        background-color: #4CAF50;
        color: white;
    }
    #login-form .btn:hover {
        background-color: #388e3c;
    }
    #login-form a { color: #007bff; text-decoration: none; font-size: 0.9em; }
    #login-form a:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <div id="loader">Naƒç√≠tavam aplik√°ciu...</div>

  <div class="container">
    <div id="auth-container" style="text-align: center; margin-bottom: 20px;">
      <div id="login-form">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Heslo">
        <button class="btn export-btn" onclick="login()">Prihl√°si≈• sa</button>
        <button class="btn export-btn" onclick="register()">Registrova≈•</button>
        <a href="#" onclick="resetPassword(); return false;">Zabudli ste heslo?</a>
      </div>
    </div>

    <h1 id="mainTitle">Doch√°dzka üëã</h1>
    <h2></h2> <div class="settings">
        <div>
          <label for="monthSelect">Mesiac: </label>
          <select id="monthSelect" onchange="changeMonth()">
            <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
            <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
            <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
            <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
          </select>
        </div>
        <details class="collapsible-settings">
          <summary>ƒéal≈°ie nastavenia</summary>
          <div class="collapsible-content">
            <div>
              <label for="employeeNameInput">Meno pracovn√≠ka: </label>
              <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
            </div>
            <div>
              <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
              <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div>
              <label for="taxRateInput">Da≈àov√© percento (%): </label>
              <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
            </div>
            <div> <label for="yearSelect">Rok: </label>
              <select id="yearSelect" onchange="changeYear()"></select>
            </div>
            <div>
              <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
              <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                <option value="1">1</option>
                <option value="2" selected>2</option> </select>
            </div>
          </div>
        </details>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Pozn√°mky</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
        </tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div class="btn-container">
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
      <button class="btn export-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button class="btn export-btn" onclick="loadFromFirestore()">Obnovi≈• z Cloudu</button>
      </div>

    <div class="logout-section">
        <div id="user-info">
          <span id="user-email"></span>
          <button class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
        </div>
    </div>

  </div>
  <div id="saveNotification">D√°ta boli √∫spe≈°ne ulo≈æen√©</div>
  <div id="errorNotification"></div>

  <script type="module">
    // Firebase Importy
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js'; // Added onSnapshot
    import { initializeAppCheck, ReCaptchaV3Provider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check.js';

    const firebaseConfig = { // VLO≈ΩTE SVOJE FIREBASE KONFIGURAƒåN√â √öDAJE
        apiKey: "AIzaSyBdLtJlduT3iKiGLDJ0UfAakpf6wcresnk",
        authDomain: "uuuuu-f7ef9.firebaseapp.com",
        projectId: "uuuuu-f7ef9",
        storageBucket: "uuuuu-f7ef9.appspot.com",
        messagingSenderId: "456105865458",
        appId: "1:456105865458:web:101f0a4dcb455f174b606b",
    };

    const app = initializeApp(firebaseConfig);
    try { // VLO≈ΩTE SVOJ reCAPTCHA v3 SITE KEY
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LczmP0qAAAAAACGalBT9zZekkUr3hLgA2e8o99v'),
            isTokenAutoRefreshEnabled: true
        });
    } catch (e) { console.warn("Firebase App Check failed to initialize.", e); }
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let firestoreListenerUnsubscribe = null; // Pre odhl√°senie listenera

    const workDaysTableBody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const mainTitleElement = document.getElementById('mainTitle');
    const subTitleElement = document.querySelector('h2'); // Pre zobrazenie mesiaca/roka
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const loaderElement = document.getElementById('loader');
    const loginFormElement = document.getElementById('login-form');
    const userInfoElement = document.getElementById('user-info');
    const userEmailElement = document.getElementById('user-email');

    const currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2; // Default na 2
    let employeeName = localStorage.getItem('employeeName') || '';
    let hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
    let taxRate = (parseFloat(localStorage.getItem('taxRatePercent')) || 2) / 100;

    function updateGreeting() {
        const nameToUse = employeeName || localStorage.getItem('employeeName') || '';
        if (nameToUse && mainTitleElement) {
            mainTitleElement.textContent = `Vitaj sp√§≈• ${nameToUse.split(' ')[0]} üëã`;
        } else if (mainTitleElement) {
            mainTitleElement.textContent = 'Doch√°dzka üëã';
        }
        if (subTitleElement) {
            subTitleElement.textContent = `${getMonthName(currentMonth)} ${currentYear}`;
        }
    }

    function populateYearSelect() {
        const startYear = 2020; const endYear = new Date().getFullYear() + 2; // Do bud√∫cnosti +2 roky
        if (yearSelect) {
            yearSelect.innerHTML = '';
            for (let y = startYear; y <= endYear; y++) {
                const option = document.createElement('option');
                option.value = y; option.textContent = y;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear;
        }
    }

    function loadInitialSettings() { // Naƒç√≠ta glob√°lne/defaultn√© nastavenia z localStorage
        hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
        taxRate = (parseFloat(localStorage.getItem('taxRatePercent')) || 2) / 100;
        decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 2;
        employeeName = localStorage.getItem('employeeName') || '';

        if(monthSelect) monthSelect.value = currentMonth;
        if(yearSelect) yearSelect.value = currentYear; // Nastav√≠ sa po populateYearSelect
        if(decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
        if(employeeNameInput) employeeNameInput.value = employeeName;
        if(hourlyWageInput) hourlyWageInput.value = hourlyWage.toFixed(1); // Zaokr√∫hli na 1 des. miesto pre zobrazenie
        if(taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1); // Percent√° s 1 des. miestom
        updateGreeting();
    }

    function isOnline() { return navigator.onLine; }

    function showStatusNotification(message, color = '#007bff', duration = 3000) {
        const n = document.createElement('div');
        n.textContent = message;
        n.style.cssText = `position:fixed; top:20px; right:20px; padding:10px 20px; border-radius:5px; background-color:${color}; color:white; z-index:10001; box-shadow:0 2px 5px rgba(0,0,0,0.2); transition: opacity 0.5s; opacity: 0;`;
        document.body.appendChild(n);
        setTimeout(() => n.style.opacity = '1', 10); // Fade in
        setTimeout(() => {
            n.style.opacity = '0';
            setTimeout(() => n.remove(), 500); // Remove after fade out
        }, duration);
    }
    function showErrorNotification(message) { const n = document.getElementById('errorNotification'); if(n) {n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 4000);} else {console.error("Error notification element not found!", message)} }
    function showSaveNotification(message = 'D√°ta boli √∫spe≈°ne ulo≈æen√©') { const n = document.getElementById('saveNotification'); if(n) {n.textContent = message; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 3000);} else {console.log("Save notification:", message)} }
    function mapFirebaseAuthError(code) { const map = {'auth/invalid-email':'Neplatn√Ω email.','auth/user-not-found':'Pou≈æ√≠vateƒæ nen√°jden√Ω.','auth/wrong-password':'Nespr√°vne heslo.','auth/email-already-in-use':'Email u≈æ existuje.','auth/weak-password':'Slab√© heslo.','auth/requires-recent-login':'Vy≈æaduje sa nov√© prihl√°senie.','auth/network-request-failed':'Chyba siete.','auth/missing-email':'Zadajte email.'}; return map[code] || code; }

    async function createUserCollection() { if (!auth.currentUser) return; const uRef = doc(db, 'users', auth.currentUser.uid); try { await setDoc(uRef, { email: auth.currentUser.email, createdAt: new Date() }, { merge: true }); const iRef = doc(collection(uRef, 'workDays'), 'initial_setup'); await setDoc(iRef, { setupComplete: true }); } catch (err) { console.error('Chyba vytvorenia user kolekcie:', err); } }

    function loadFromLocalStorageOnly() {
        const localKey = `workData-${currentYear}-${currentMonth}`;
        const localData = localStorage.getItem(localKey);
        if (localData) {
            console.log("Naƒç√≠tavam d√°ta z lok√°lneho √∫lo≈æiska (workData).");
            parseAndApplyData(localData);
        } else {
            console.log("V lok√°lnom √∫lo≈æisku (workData) sa nena≈°li ≈æiadne d√°ta pre tento mesiac.");
            // Ak nie s√∫ d√°ta, vyƒçisti tabuƒæku a prepoƒç√≠taj (malo by by≈• 0)
            if (workDaysTableBody && workDaysTableBody.hasChildNodes()) { // Len ak u≈æ nieƒço bolo vykreslen√©
                 const daysInMonth = getDaysInMonth(currentMonth);
                 for (let i = 1; i <= daysInMonth; i++) {
                    if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        _resetRowInternal(i, false, false); // Bez ukladania a promptu
                    }
                 }
            }
            calculateTotal();
        }
    }

    function parseAndApplyData(dataString) {
        try {
            const sData = JSON.parse(dataString);
            // Aktualiz√°cia glob√°lnych nastaven√≠ z d√°t (ak s√∫ s√∫ƒças≈•ou mesaƒçn√©ho dokumentu)
            // Tieto nastavenia sa potom ulo≈æia do localStorage glob√°lne
            hourlyWage = parseFloat(sData.hourlyWage) ?? hourlyWage;
            employeeName = sData.employeeName ?? employeeName;
            decimalPlaces = parseInt(sData.decimalPlaces) ?? decimalPlaces;
            let loadedTaxRate = sData.taxRate;
            if (loadedTaxRate !== undefined && loadedTaxRate !== null) {
                if (loadedTaxRate > 1 && loadedTaxRate <= 100) { // Ak je ulo≈æen√© ako percento (napr. 20 pre 20%)
                    taxRate = loadedTaxRate / 100;
                } else if (loadedTaxRate >= 0 && loadedTaxRate <= 1) { // Ak je ulo≈æen√© ako desatinn√© ƒç√≠slo (napr. 0.2)
                    taxRate = loadedTaxRate;
                }
            }

            // Aktualiz√°cia inputov a glob√°lneho localStorage pre nastavenia
            if(hourlyWageInput) hourlyWageInput.value = hourlyWage.toFixed(1);
            if(taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1);
            if(employeeNameInput) employeeNameInput.value = employeeName;
            if(decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;

            localStorage.setItem('hourlyWage', hourlyWage.toString());
            localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1));
            localStorage.setItem('employeeName', employeeName);
            localStorage.setItem('decimalPlaces', decimalPlaces.toString());

            updateGreeting(); // Aktualizuje pozdrav a podnadpis mesiaca/roka

            // Spracovanie d√°t pre jednotliv√© dni
            const daysInMonth = getDaysInMonth(currentMonth);
            if (sData.data?.length) {
                const daysToProcess = Math.min(daysInMonth, sData.data.length);
                for (let i = 0; i < daysToProcess; i++) {
                    const dayData = sData.data[i];
                    const dayIndex = i + 1;
                    const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`);
                    const endEl = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`);
                    const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`);
                    const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${dayIndex}`);
                    if (startEl && endEl && breakEl) { // Skontroluj, ƒçi elementy existuj√∫
                        startEl.value = dayData.start || '';
                        endEl.value = dayData.end || '';
                        breakEl.value = dayData.breakTime || '';
                        if (noteEl) noteEl.value = dayData.note || '';
                        calculateRow(dayIndex); // Prepoƒç√≠ta odpracovan√Ω ƒças a mzdu pre riadok
                    }
                }
                // Pre dni nad r√°mec d√°t v sData (ak je mesiac dlh≈°√≠), resetuj
                for (let i = daysToProcess + 1; i <= daysInMonth; i++) {
                     if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        _resetRowInternal(i, false, false);
                    }
                }
            } else { // Ak v sData nie s√∫ ≈æiadne d√°ta pre dni, resetuj v≈°etky dni
                for (let i = 1; i <= daysInMonth; i++) {
                    if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        _resetRowInternal(i, false, false);
                    }
                }
            }
            calculateTotal(); // Prepoƒç√≠ta celkov√© s√∫ƒçty pre mesiac
        } catch (err) {
            showErrorNotification(`Chyba spracovania d√°t: ${err.message}`);
            console.error("Chyba v parseAndApplyData:", err, "Data string:", dataString);
            // Fallback: pok√∫s sa naƒç√≠ta≈• aspo≈à defaultn√© nastavenia a vyƒçisti tabuƒæku
            loadInitialSettings();
            if (workDaysTableBody) {
                const daysInMonth = getDaysInMonth(currentMonth);
                for (let i = 1; i <= daysInMonth; i++) {
                    if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                         _resetRowInternal(i, false, false);
                    }
                }
            }
            calculateTotal();
        }
    }

    async function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) {
            console.log('Odhlasujem existuj√∫ci Firestore listener.');
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (!currentUser) { // Ak nie je prihl√°sen√Ω pou≈æ√≠vateƒæ, nesna≈æ sa pripoji≈•
            console.log('Nie je prihl√°sen√Ω pou≈æ√≠vateƒæ, Firestore listener sa nenastavuje.');
            loadFromLocalStorageOnly(); // Zobraz lok√°lne d√°ta (ak nejak√© s√∫)
            if (loaderElement) loaderElement.style.display = 'none';
            return;
        }
        if (!isOnline()) {
            console.log('Aplik√°cia je offline, Firestore listener sa nenastavuje. Zobrazujem lok√°lne d√°ta.');
            loadFromLocalStorageOnly();
            const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
            if (localStorage.getItem(pendingKey)) {
                 showStatusNotification('M√°te neodoslan√© zmeny, ktor√© sa zosynchronizuj√∫ po pripojen√≠.', '#ffc107', 5000);
            }
            if (loaderElement) loaderElement.style.display = 'none';
            return;
        }

        const docPath = `users/${currentUser.uid}/workDays/${currentYear}-${currentMonth}`;
        const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
        console.log(`Nastavujem Firestore listener pre: ${docPath}`);

        if (loaderElement) loaderElement.style.display = 'flex';

        firestoreListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
            if (loaderElement) loaderElement.style.display = 'none';
            console.log('Firestore listener: Prijat√© d√°ta zo snapshotu pre:', docSnap.id, '| Pending writes:', docSnap.metadata.hasPendingWrites);

            const currentLocalDataKey = `workData-${currentYear}-${currentMonth}`;

            if (docSnap.exists()) {
                const serverData = docSnap.data();
                const serverDataString = JSON.stringify(serverData);

                console.log('Aplikujem d√°ta zo snapshotu do UI.');
                localStorage.setItem(currentLocalDataKey, serverDataString); // Ulo≈æ aktu√°lne d√°ta zo servera
                parseAndApplyData(serverDataString);

                const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
                if (localStorage.getItem(pendingKey)) {
                    console.log('Vymaz√°vam pending sync d√°ta pre aktu√°lny mesiac, keƒè≈æe boli prijat√© d√°ta zo servera.');
                    localStorage.removeItem(pendingKey);
                }

                if (!docSnap.metadata.hasPendingWrites) {
                    console.log('D√°ta automaticky aktualizovan√© z Firestore (zmena z in√©ho klienta alebo servera).');
                    // showStatusNotification('D√°ta boli automaticky aktualizovan√©.', '#28a745', 2000); // Voliteƒæn√©
                }
            } else {
                console.log('Firestore dokument neexistuje (alebo bol vymazan√Ω). ƒåist√≠m lok√°lne d√°ta pre tento mesiac.');
                localStorage.removeItem(currentLocalDataKey);
                if (workDaysTableBody) { // Uisti sa, ≈æe tabuƒæka existuje
                    const daysInMonth = getDaysInMonth(currentMonth);
                     for (let i = 1; i <= daysInMonth; i++) {
                        if (document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                            _resetRowInternal(i, false, false);
                        }
                     }
                }
                loadInitialSettings(); // Naƒç√≠taj defaultn√©/glob√°lne nastavenia, keƒè≈æe mesaƒçn√© d√°ta nie s√∫
                calculateTotal();
                updateGreeting();
                if (!docSnap.metadata.hasPendingWrites) { // Ak to nebola lok√°lna akcia (napr. reset mesiaca, ktor√Ω by viedol k vymazaniu)
                    showErrorNotification('D√°ta pre tento mesiac boli na serveri odstr√°nen√© alebo neexistuj√∫.');
                }
            }
        }, (error) => {
            if (loaderElement) loaderElement.style.display = 'none';
            console.error("Chyba vo Firestore listeneri: ", error);
            showErrorNotification(`Chyba pri poƒç√∫van√≠ zmien z Firebase: ${error.message}`);
            if (firestoreListenerUnsubscribe) {
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
            }
            loadFromLocalStorageOnly(); // Fallback na lok√°lne d√°ta
        });
    }


    function debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; }
    const debouncedSaveToFirestore = debounce(saveToFirestore, 2000);

    function collectCurrentData() {
        const sData = { data: [], hourlyWage: hourlyWage, taxRate: taxRate, employeeName: employeeName, decimalPlaces: decimalPlaces, lastUpdated: new Date().toISOString() };
        const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
            const s = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const e = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const b = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const note = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value || '';
            const g = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            const n = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0';
            sData.data.push({ start: s, end: e, breakTime: b, note: note, gross: g, net: n });
        }
        return sData;
    }

    async function saveToFirestore() {
        const saveData = collectCurrentData();
        const localWorkDataKey = `workData-${currentYear}-${currentMonth}`;
        const pendingSyncKey = `pendingSync-${currentYear}-${currentMonth}`;

        // Aktualizuj hlavn√Ω localStorage (workData) s najnov≈°√≠mi d√°tami z UI
        // Toto je d√¥le≈æit√©, aby `parseAndApplyData` volan√Ω listenerom mal s ƒç√≠m porovn√°va≈•,
        // alebo aby offline stav mal posledn√© d√°ta.
        localStorage.setItem(localWorkDataKey, JSON.stringify(saveData));


        if (!currentUser) {
            console.log('Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω. D√°ta ulo≈æen√© iba lok√°lne (workData). Firestore synchroniz√°cia preskoƒçen√°.');
            // Ak chceme, aby sa aj neprihl√°sen√©ho pou≈æ√≠vateƒæa d√°ta niekedy synchronizovali (po prihl√°sen√≠),
            // museli by sme ich tie≈æ da≈• do pendingSyncKey, ale to by vy≈æadovalo in√∫ logiku.
            // Pre jednoduchos≈•, neprihl√°sen√© d√°ta s√∫ len v workData.
            return;
        }

        if (!isOnline()) {
            console.log('Aplik√°cia je offline. Uklad√°m d√°ta do fronty pre synchroniz√°ciu na pozad√≠.');
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData));
            showErrorNotification('Ste offline. D√°ta ulo≈æen√© lok√°lne, zosynchronizuj√∫ sa po pripojen√≠.');

            if ('serviceWorker' in navigator && 'SyncManager' in window) {
                navigator.serviceWorker.ready.then(function(swRegistration) {
                    return swRegistration.sync.register('sync-pending-data');
                }).then(() => {
                    console.log('Background sync zaregistrovan√Ω pre ƒçakaj√∫ce d√°ta.');
                }).catch(err => {
                    console.error('Chyba registr√°cie background sync:', err);
                    showErrorNotification('Nepodarilo sa zaregistrova≈• synchroniz√°ciu na pozad√≠.');
                });
            }
            return;
        }

        // Ak sme online, pok√∫sime sa ulo≈æi≈• priamo do Firestore
        try {
            console.log('Aplik√°cia je online. Uklad√°m d√°ta do Firestore.');
            const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
            await setDoc(docRef, saveData, { merge: true }); // merge: true je d√¥le≈æit√©, ak by sme mali v dokumente aj in√© polia
            
            localStorage.removeItem(pendingSyncKey); // Ak boli nejak√© pending d√°ta, s√∫ teraz vyrie≈°en√©
            showSaveNotification('D√°ta √∫spe≈°ne zosynchronizovan√© s Firebase.');
        } catch (err) {
            showErrorNotification(`Chyba ukladania do Firebase: ${err.message}. D√°ta ulo≈æen√© lok√°lne pre neskor≈°iu synchroniz√°ciu.`);
            localStorage.setItem(pendingSyncKey, JSON.stringify(saveData)); // Ulo≈æ ako pending, ak online ukladanie zlyh√°
            // Pok√∫s sa zaregistrova≈• sync aj v tomto pr√≠pade
            if ('serviceWorker' in navigator && 'SyncManager' in window) {
               navigator.serviceWorker.ready.then(function(swRegistration) {
                   return swRegistration.sync.register('sync-pending-data');
               }).catch(syncErr => console.error('Chyba registr√°cie background sync po chybe ukladania:', syncErr));
            }
        }
    }

    async function syncWithFirebase() { // Volan√© SW alebo manu√°lne
        if (!currentUser || !isOnline()) {
            console.log('syncWithFirebase: Podmienky pre synchroniz√°ciu nie s√∫ splnen√© (ch√Ωba pou≈æ√≠vateƒæ alebo ste offline).');
            return;
        }
        const pendingKey = `pendingSync-${currentYear}-${currentMonth}`;
        const localWorkDataKey = `workData-${currentYear}-${currentMonth}`;
        const pendingDataStr = localStorage.getItem(pendingKey);

        if (pendingDataStr) {
            console.log('syncWithFirebase: Na≈°li sa ƒçakaj√∫ce d√°ta na synchroniz√°ciu.');
            if (loaderElement) loaderElement.style.display = 'flex';
            try {
                const dataToSync = JSON.parse(pendingDataStr);
                const docRef = doc(db, 'users', currentUser.uid, 'workDays', `${currentYear}-${currentMonth}`);
                await setDoc(docRef, dataToSync, { merge: true });

                localStorage.setItem(localWorkDataKey, pendingDataStr); // Aktualizuj hlavn√© lok√°lne d√°ta
                localStorage.removeItem(pendingKey);
                showSaveNotification('Lok√°lne ulo≈æen√© zmeny boli √∫spe≈°ne zosynchronizovan√© s Firebase.');
                
                // Ak je listener akt√≠vny, d√°ta by sa mali naƒç√≠ta≈• cez neho.
                // Ale pre istotu, ak by listener nebol (napr. chyba), m√¥≈æeme manu√°lne parsova≈•.
                // Av≈°ak, ak je listener, toto je redundantn√© a m√¥≈æe sp√¥sobi≈• dvojit√© parsovanie.
                // Listener by mal by≈• zdrojom pravdy po √∫spe≈°nom z√°pise.
                // Ak listener be≈æ√≠, setDoc vy≈°≈°ie spust√≠ onSnapshot, ktor√Ω zavol√° parseAndApplyData.
                // Tak≈æe parseAndApplyData(pendingDataStr) tu nie je nutn√©.
                console.log("Pending d√°ta odoslan√©, listener by mal aktualizova≈• UI.");

            } catch (err) {
                showErrorNotification(`Chyba synchroniz√°cie lok√°lnych d√°t: ${err.message}`);
            } finally {
                if (loaderElement) loaderElement.style.display = 'none';
            }
        } else {
            console.log('syncWithFirebase: ≈Ωiadne ƒçakaj√∫ce d√°ta na synchroniz√°ciu.');
        }
    }


    function getDayName(year, month, day) { return new Date(year, month, day).toLocaleDateString('sk-SK', { weekday: 'short' }); }
    function createTable() {
        console.log("Vytv√°ram tabuƒæku pre mesiac:", currentMonth, "rok:", currentYear);
        if (!workDaysTableBody) { console.error("workDaysTableBody nie je definovan√Ω!"); return; }
        workDaysTableBody.innerHTML = ''; // Vyƒçisti pred naplnen√≠m
        const daysInMonth = getDaysInMonth(currentMonth);
        const today = new Date();
        const todayDate = today.getDate();
        const todayMonth = today.getMonth();
        const todayYear = today.getFullYear();

        if (isNaN(daysInMonth) || daysInMonth <= 0) { console.error("Neplatn√Ω poƒçet dn√≠ v mesiaci:", daysInMonth); return; }

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === todayDate && currentMonth === todayMonth && currentYear === todayYear) {
                row.classList.add('current-day');
            }
            const dayName = getDayName(currentYear, currentMonth, i);
            const startId = `start-${currentYear}-${currentMonth}-${i}`;
            const endId = `end-${currentYear}-${currentMonth}-${i}`;
            const breakId = `break-${currentYear}-${currentMonth}-${i}`;
            const noteId = `note-${currentYear}-${currentMonth}-${i}`;
            const totalId = `total-${currentYear}-${currentMonth}-${i}`;
            const grossId = `gross-${currentYear}-${currentMonth}-${i}`;
            const netId = `net-${currentYear}-${currentMonth}-${i}`;
            row.innerHTML = `<td>${i}. ${dayName}</td><td><div class="time-input-wrapper"><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="window.handleInput(this, '${endId}')"><span class="clock-icon" onclick="window.insertCurrentTime('${startId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span></div></td><td><div class="time-input-wrapper"><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="window.handleInput(this, '${breakId}')"><span class="clock-icon" onclick="window.insertCurrentTime('${endId}')" title="Vlo≈æi≈• aktu√°lny ƒças">üïí</span></div></td><td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="window.handleBreakInput(${i})"></td><td id="${totalId}">-</td><td><textarea id="${noteId}" placeholder="Pozn√°mka" oninput="window.calculateAndUpdateTotals()" rows="1"></textarea></td><td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="" readonly></td><td><input type="number" id="${netId}" min="0" step="0.01" placeholder="" readonly></td><td><button class="btn reset-btn" onclick="window.resetRow(${i})">X</button></td>`;
            workDaysTableBody.appendChild(row);
        }
        console.log(`Tabuƒæka vytvoren√° s ${daysInMonth} d≈àami.`);
    }
    function isValidTimeFormat(timeString) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeString); }
    function formatAndMoveNext(input, nextId) { let value = input.value.replace(/[^\d:]/g, ''); let originalValue = input.value; let cursorPos = input.selectionStart; if (value.length === 2 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value += ':'; } else if (value.length === 4 && !value.includes(':')) { value = `${value.substring(0, 2)}:${value.substring(2)}`; } else if (value.length === 3 && !value.includes(':') && value.length > originalValue.replace(/[^\d]/g, '').length) { value = `${value.substring(0, 2)}:${value.substring(2)}`; } value = value.replace(/^:/, ''); if ((value.match(/:/g) || []).length > 1) { const parts = value.split(':'); value = `${parts[0]}:${parts.slice(1).join('')}`; } if (value.length > 5) { value = value.slice(0, 5); } if (input.value !== value) { input.value = value; try { if (value.length === 3 && originalValue.length === 2 && value.endsWith(':')) { input.setSelectionRange(3, 3); } else { input.setSelectionRange(cursorPos, cursorPos); } } catch (e) { /*ignore*/ } } const day = parseInt(input.id.split('-')[3]); calculateRow(day); if (value.length === 5 && isValidTimeFormat(value)) { if (nextId) { moveNext(input, nextId); } } }
    function moveNext(currentElement, nextInputId) { const nextElement = document.getElementById(nextInputId); if (nextElement) { nextElement.focus(); if (nextElement.tagName === 'INPUT' && nextElement.type === 'tel') { nextElement.select(); } } }
    function calculateRow(day) { const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) return; const startTime = startInput.value; const endTime = endInput.value; const breakTimeHours = parseFloat(breakInput.value) || 0; if (!isValidTimeFormat(startTime) || !isValidTimeFormat(endTime)) { totalCell.textContent = '-'; grossInput.value = ''; netInput.value = ''; return; } const [startHours, startMinutes] = startTime.split(':').map(Number); const [endHours, endMinutes] = endTime.split(':').map(Number); const startDate = new Date(2000, 0, 1, startHours, startMinutes); let endDate = new Date(2000, 0, 1, endHours, endMinutes); if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); } let diffMinutes = (endDate.getTime() - startDate.getTime()) / 60000; diffMinutes -= (breakTimeHours * 60); if (diffMinutes < 0) { diffMinutes = 0; } const decimalHours = diffMinutes / 60; const totalMinutesRounded = Math.round(diffMinutes); const hours = Math.floor(totalMinutesRounded / 60); const minutes = totalMinutesRounded % 60; totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`; const grossSalary = Math.max(0, decimalHours * hourlyWage); grossInput.value = grossSalary.toFixed(decimalPlaces); updateNetSalary(day); }
    function updateNetSalary(day) { const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!grossInput || !netInput) return; const grossSalary = parseFloat(grossInput.value) || 0; const netSalary = Math.max(0, grossSalary * (1 - taxRate)); netInput.value = netSalary.toFixed(decimalPlaces); }
    function _resetRowInternal(day, save = true, promptUser = true) { if (promptUser) { if (!confirm("Naozaj chcete vynulova≈• √∫daje pre tento de≈à?")) { return; } } const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakEl = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const noteEl = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); if(start) start.value = ''; if(end) end.value = ''; if(breakEl) breakEl.value = ''; if(noteEl) noteEl.value = ''; calculateRow(day); if (save) { window.calculateAndUpdateTotals(); } }
    function calculateTotal() { let totalMinutes = 0; let totalGross = 0; let totalNet = 0; let daysWorked = 0; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value; const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value; const breakTime = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value) || 0; let dailyMinutes = 0; let dailyGross = 0; let dailyNet = 0; if (isValidTimeFormat(start) && isValidTimeFormat(end)) { const [sH, sM] = start.split(':').map(Number); const [eH, eM] = end.split(':').map(Number); const sDate = new Date(2000, 0, 1, sH, sM); let eDate = new Date(2000, 0, 1, eH, eM); if (eDate < sDate) { eDate.setDate(eDate.getDate() + 1); } let diffM = (eDate.getTime() - sDate.getTime()) / 60000 - (breakTime * 60); if (diffM < 0) diffM = 0; dailyMinutes = diffM; const dailyHours = dailyMinutes / 60; dailyGross = Math.max(0, dailyHours * hourlyWage); dailyNet = Math.max(0, dailyGross * (1 - taxRate)); daysWorked++; } totalMinutes += dailyMinutes; totalGross += dailyGross; totalNet += dailyNet; } const totalMinutesRounded = Math.round(totalMinutes); const totalHours = Math.floor(totalMinutesRounded / 60); const totalMinutesRemainder = totalMinutesRounded % 60; const totalDecimalHours = totalMinutes / 60; const avgNet = daysWorked > 0 ? totalNet / daysWorked : 0; const avgMinutes = daysWorked > 0 ? totalMinutes / daysWorked : 0; const avgMinutesRounded = Math.round(avgMinutes); const avgHours = Math.floor(avgMinutesRounded / 60); const avgMinsRemainder = avgMinutesRounded % 60; const avgDecimalHours = avgMinutes / 60; if (totalSalaryDiv) totalSalaryDiv.innerHTML = `Zapoƒç√≠tan√Ωch dn√≠: ${daysWorked}<br>Celkov√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours.toFixed(decimalPlaces)} h)<br>Hrub√° mzda: ${totalGross.toFixed(decimalPlaces)} ‚Ç¨<br>ƒåist√° mzda: ${totalNet.toFixed(decimalPlaces)} ‚Ç¨<br>Priem. ƒçist√° mzda/de≈à: ${avgNet.toFixed(decimalPlaces)} ‚Ç¨<br><strong>Priem. ƒças/de≈à: ${avgHours}h ${avgMinsRemainder}m (${avgDecimalHours.toFixed(decimalPlaces)} h)</strong>`; }
    function getMonthName(monthIndex) { const months = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return months[monthIndex] || ''; }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Mesiac alebo rok nie s√∫ definovan√©, pou≈æ√≠vam aktu√°lny d√°tum."); return new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate(); } return new Date(currentYear, month + 1, 0).getDate(); }

    // --- Priradenie funkci√≠ k window objektu ---
    window.login = async () => { if (!isOnline()) return showErrorNotification('Ste offline.'); const e = document.getElementById('email').value, p = document.getElementById('password').value; if (!e || !p) return showErrorNotification('Zadajte email a heslo.'); try { await signInWithEmailAndPassword(auth, e, p); /* onAuthStateChanged sa postar√° o zvy≈°ok */ } catch (err) { showErrorNotification(`Chyba prihl√°senia: ${mapFirebaseAuthError(err.code)}`); } };
    window.register = async () => { if (!isOnline()) return showErrorNotification('Ste offline.'); const e = document.getElementById('email').value, p = document.getElementById('password').value; if (!e || !p) return showErrorNotification('Zadajte email a heslo.'); if (p.length < 6) return showErrorNotification('Heslo mus√≠ ma≈• aspo≈à 6 znakov.'); try { await createUserWithEmailAndPassword(auth, e, p); await createUserCollection(); /* onAuthStateChanged sa postar√° o zvy≈°ok */ } catch (err) { showErrorNotification(`Chyba registr√°cie: ${mapFirebaseAuthError(err.code)}`); } };
    window.logout = async () => {
        if (!confirm("Ste si ist√≠, ≈æe sa chcete odhl√°si≈•?")) return;
        if (firestoreListenerUnsubscribe) {
            console.log('Odhlasujem Firestore listener pri odhl√°sen√≠ pou≈æ√≠vateƒæa.');
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }
        try {
            await signOut(auth);
            // onAuthStateChanged sa postar√° o UI zmeny a nastavenie currentUser = null
            // Manu√°lne vyƒçistenie a reset UI pre istotu, ak by onAuthStateChanged neprebehol okam≈æite alebo podƒæa oƒçak√°van√≠
            if (workDaysTableBody) workDaysTableBody.innerHTML = '';
            createTable(); // Vytvor√≠ pr√°zdnu tabuƒæku
            loadInitialSettings(); // Naƒç√≠ta defaultn√©/glob√°lne nastavenia
            calculateTotal(); // Vynuluje s√∫ƒçty
            updateGreeting(); // Nastav√≠ defaultn√Ω pozdrav
            if(loginFormElement) loginFormElement.style.display = 'flex';
            if(userInfoElement) userInfoElement.style.display = 'none';
            if(userEmailElement) userEmailElement.textContent = '';

        } catch (err) {
            showErrorNotification(`Chyba odhl√°senia: ${err.message}`);
        }
    };
    window.resetPassword = async () => { if (!isOnline()) return showErrorNotification('Ste offline.'); const eInput = document.getElementById('email'), email = eInput.value; if (!email) { if(eInput) eInput.style.border = '1px solid red'; setTimeout(() => { if(eInput) eInput.style.border = '1px solid #ccc'; }, 3000); return showErrorNotification('Zadajte email.'); } if(eInput) eInput.style.border = '1px solid #ccc'; try { await sendPasswordResetEmail(auth, email); showSaveNotification(`Email na obnovu hesla bol odoslan√Ω na ${email}.`); } catch (err) { showErrorNotification(`Chyba obnovy hesla: ${mapFirebaseAuthError(err.code)}`); } };
    
    window.changeMonth = () => {
        currentMonth = parseInt(monthSelect.value);
        localStorage.setItem('currentMonth', currentMonth); // Ulo≈æ aktu√°lny mesiac pre pr√≠pad znovunaƒç√≠tania
        if (workDaysTableBody) workDaysTableBody.innerHTML = '';
        createTable();
        setupFirestoreListener(); // Nastav√≠ listener pre nov√Ω mesiac
        updateGreeting(); // Aktualizuj podnadpis
    };
    window.changeYear = () => {
        currentYear = parseInt(yearSelect.value);
        localStorage.setItem('currentYear', currentYear); // Ulo≈æ aktu√°lny rok
        if (workDaysTableBody) workDaysTableBody.innerHTML = '';
        createTable();
        setupFirestoreListener(); // Nastav√≠ listener pre nov√Ω rok
        updateGreeting(); // Aktualizuj podnadpis
    };

    window.insertCurrentTime = (inputId) => { const inputElement = document.getElementById(inputId); if (inputElement) { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); inputElement.value = `${hours}:${minutes}`; window.handleInput(inputElement, ''); } };
    window.handleInput = (input, nextId) => { formatAndMoveNext(input, nextId); window.calculateAndUpdateTotals(); };
    window.handleBreakInput = (day) => { const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); if (breakInput) { let breakValue = parseFloat(breakInput.value); if (isNaN(breakValue) || breakValue < 0) { breakInput.value = ''; } } calculateRow(day); window.calculateAndUpdateTotals(); };
    
    window.calculateAndUpdateTotals = () => {
        calculateTotal(); // Prepoƒç√≠ta a zobraz√≠ celkov√© s√∫ƒçty
        const saveData = collectCurrentData();
        // Priame ukladanie do localStorage (workData) sa deje v parseAndApplyData (ak d√°ta pri≈°li z FS)
        // alebo v saveToFirestore (pred z√°pisom do FS alebo pending).
        // Tu by sme mali len spusti≈• debouncedSaveToFirestore, aby sa zmeny z UI dostali do FS.
        // saveToFirestore potom aktualizuje aj localStorage['workData-...']
        debouncedSaveToFirestore();
    };

    window.resetRow = (day, save = true, promptUser = true) => { // Pridan√© parametre do defin√≠cie na window
         _resetRowInternal(day, save, promptUser);
    };

    window.loadFromFirestore = async () => { // Tlaƒçidlo "Obnovi≈• z Cloudu"
        if (!currentUser) return showErrorNotification('Pre obnovenie z cloudu sa mus√≠te prihl√°si≈•.');
        if (!isOnline()) return showErrorNotification('Ste offline. Sk√∫ste obnovi≈• nesk√¥r, keƒè budete online.');
        if (!confirm('Naozaj chcete manu√°lne obnovi≈• d√°ta z cloudu pre tento mesiac? T√Ωm sa odpoj√≠ a znovu pripoj√≠ sledovanie zmien.')) return;
        console.log("Manu√°lne obnovenie d√°t z Firebase a znovunastavenie listenera.");
        if (workDaysTableBody && !workDaysTableBody.hasChildNodes()) { createTable(); }
        await setupFirestoreListener(); // Odhl√°si star√Ω listener a nastav√≠ nov√Ω, ktor√Ω naƒç√≠ta ƒçerstv√© d√°ta.
    };
    
    window.updateEmployeeName = () => {
        if(!employeeNameInput) return;
        employeeName = employeeNameInput.value.trim();
        localStorage.setItem('employeeName', employeeName); // Ulo≈æ glob√°lne
        updateGreeting();
        window.calculateAndUpdateTotals(); // Spust√≠ ukladanie, aby sa zmena mena prejavila v mesaƒçnom dokumente
    };
    window.updateSettings = () => { // Pre hodinov√∫ mzdu a da≈à
        if(!hourlyWageInput || !taxRateInput) return;
        const wageValue = hourlyWageInput.value;
        const taxValue = taxRateInput.value;
        let wageChanged = false;
        let taxChanged = false;

        if (wageValue === "") { if (hourlyWage !== 0) { hourlyWage = 0; wageChanged = true; } }
        else { const newWage = parseFloat(wageValue); if (!isNaN(newWage) && newWage >= 0) { if (hourlyWage !== newWage) { hourlyWage = newWage; wageChanged = true; } } else { hourlyWageInput.value = hourlyWage.toFixed(1); } }

        if (taxValue === "") { if (taxRate !== 0) { taxRate = 0; taxChanged = true; } }
        else { const newTaxPercent = parseFloat(taxValue); if (!isNaN(newTaxPercent) && newTaxPercent >= 0 && newTaxPercent <=100) { const newTaxDecimal = newTaxPercent / 100; if (taxRate !== newTaxDecimal) { taxRate = newTaxDecimal; taxChanged = true; } } else { taxRateInput.value = (taxRate * 100).toFixed(1); } }

        if (wageChanged) { localStorage.setItem('hourlyWage', hourlyWage.toString()); }
        if (taxChanged) { localStorage.setItem('taxRatePercent', (taxRate * 100).toFixed(1)); }

        if (wageChanged || taxChanged) {
            for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
                if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); }
            }
            window.calculateAndUpdateTotals(); // Spust√≠ ukladanie, aby sa zmeny prejavili v mesaƒçnom dokumente
        }
    };
    window.changeDecimalPlaces = () => {
        if(!decimalPlacesSelect) return;
        decimalPlaces = parseInt(decimalPlacesSelect.value);
        localStorage.setItem('decimalPlaces', decimalPlaces.toString()); // Ulo≈æ glob√°lne
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
            if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) { calculateRow(i); }
        }
        window.calculateAndUpdateTotals(); // Spust√≠ ukladanie, aby sa zmena prejavila v mesaƒçnom dokumente
    };

    // Exporty a z√°lohy zost√°vaj√∫ rovnak√©, ako ste ich mali
    window.exportToPDF = () => { try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`V√Ωkaz pr√°ce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); for (let i = 1; i <= daysInMonth; i++) { const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; const noteValue = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value||'';  const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`); const totalTime = totalCell ? totalCell.textContent.trim() : '-'; const grossSalary = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value||''; const netSalary = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value||''; if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) { tableData.push([ `${i}. ${getDayName(currentYear, currentMonth, i)}`, startTime, endTime, breakTime || '0', totalTime, noteValue, `${parseFloat(grossSalary).toFixed(decimalPlaces)} ‚Ç¨`, `${parseFloat(netSalary).toFixed(decimalPlaces)} ‚Ç¨` ]); } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)','Odpracovan√©', 'Pozn√°mky', 'Hrub√° Mzda','ƒåist√° Mzda']], body:tableData, startY:38, theme:'grid', styles:{font:'Roboto',fontSize:9,cellPadding:2,valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:10,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{ 0: { cellWidth: 15, halign: 'left' }, 1: { cellWidth: 17, halign: 'center' }, 2: { cellWidth: 17, halign: 'center' }, 3: { cellWidth: 12, halign: 'center' }, 4: { cellWidth: 35, halign: 'center' }, 5: { cellWidth: 28, halign: 'left' }, 6: { cellWidth: 28, halign: 'right' }, 7: { cellWidth: 30, halign: 'right' } } }); const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(11); const totalText = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi,'\n').replace(/<\/?strong>/gi,'').replace(/ /g,' ').replace(/‚Ç¨/g,' EUR'); doc.text(totalText, 14, finalY); const nameForFile = employeeName || 'Nezadane'; const safeName = nameForFile.replace(/[^a-zA-Z0-9√Å√°√Ñ√§ƒåƒçƒéƒè√â√©√ç√≠ƒπƒ∫ƒΩƒæ≈á≈à√ì√≥√î√¥≈î≈ï≈†≈°≈§≈•√ö√∫√ù√Ω≈Ω≈æ\s-]/g, '').replace(/\s+/g, '_'); const finalSafeName = safeName || 'Nezadane'; doc.save(`Vykaz_prace_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`); showSaveNotification("PDF v√Ωkaz bol √∫spe≈°ne vygenerovan√Ω."); } catch(err) { showErrorNotification(`Chyba pri exporte do PDF: ${err.message}`); console.error("PDF Export Error:", err); } };
    window.sendPDF = () => { try { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal'); doc.setFont('Roboto'); doc.setFontSize(16); doc.text(`Z√°znam doch√°dzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 22); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName || 'Nezadan√©'}`, 14, 30); const tableData = []; const daysInMonth = getDaysInMonth(currentMonth); let daysWorkedCount = 0; for (let i = 1; i <= daysInMonth; i++) { const startTime = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value||''; const endTime = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value||''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value||''; const noteValue = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`)?.value||'';  if (isValidTimeFormat(startTime) && isValidTimeFormat(endTime)) { tableData.push([ `${i}. ${getDayName(currentYear, currentMonth, i)}`, startTime, endTime, breakTime || '0', noteValue ]); daysWorkedCount++; } } doc.autoTable({ head:[['De≈à','Pr√≠chod','Odchod','Prest√°vka (h)', 'Pozn√°mky']], body:tableData, startY:38, theme:'grid', styles:{font:'Roboto',fontSize:10,cellPadding:3,valign:'middle'}, headStyles:{fillColor:[220,220,220],textColor:[0,0,0],fontStyle:'bold',fontSize:11,halign:'center'}, alternateRowStyles:{fillColor:[245,245,245]}, columnStyles:{ 0:{cellWidth:40,halign:'left'}, 1:{cellWidth:30,halign:'center'}, 2:{cellWidth:30,halign:'center'}, 3:{cellWidth:30,halign:'center'}, 4:{cellWidth:40,halign:'left'}  } }); const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(11); doc.text(`Poƒçet zapoƒç√≠tan√Ωch dn√≠: ${daysWorkedCount}`, 14, finalY); const pdfBlob = doc.output('blob'); const nameForFile = employeeName || 'Nezadane'; const safeName = nameForFile.replace(/[^a-zA-Z0-9√Å√°√Ñ√§ƒåƒçƒéƒè√â√©√ç√≠ƒπƒ∫ƒΩƒæ≈á≈à√ì√≥√î√¥≈î≈ï≈†≈°≈§≈•√ö√∫√ù√Ω≈Ω≈æ\s-]/g, '').replace(/\s+/g, '_'); const finalSafeName = safeName || 'Nezadane'; const pdfFileName = `Dochadzka_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, {type:'application/pdf'}); if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) { showSaveNotification("PDF pripraven√© na zdieƒæanie..."); navigator.share({ files: [pdfFile], title: `Doch√°dzka ${getMonthName(currentMonth)} ${currentYear}`, text: `Z√°znam doch√°dzky pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).catch(error => { if (error.name !== 'AbortError') { console.error('Chyba zdieƒæania:', error); showErrorNotification(`Chyba zdieƒæania: ${error.message}`); } }); } else { showErrorNotification('Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom. S√∫bor bude stiahnut√Ω.'); doc.save(pdfFileName); } } catch(err) { showErrorNotification(`Chyba pri pr√≠prave PDF na odoslanie: ${err.message}`); console.error("Send PDF Error:", err); } };
    window.restoreBackup = () => { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.xlsx'; fileInput.onchange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false }); const headerIndex = rows.findIndex(r => r && r[0]?.toString().toLowerCase().includes("de≈à")); if (headerIndex === -1) throw new Error("Hlaviƒçka tabuƒæky (stƒ∫pec 'De≈à') nebola n√°jden√° v s√∫bore."); const headers = rows[headerIndex]; const dayIndex = headers.findIndex(h => h?.toLowerCase().includes("de≈à")); const startIndex = headers.findIndex(h => h?.toLowerCase().includes("pr√≠chod")); const endIndex = headers.findIndex(h => h?.toLowerCase().includes("odchod")); const breakIndex = headers.findIndex(h => h?.toLowerCase().includes("prest√°vka")); const noteIndex = headers.findIndex(h => h?.toLowerCase().includes("pozn√°mky") || h?.toLowerCase().includes("note"));  if ([dayIndex, startIndex, endIndex, breakIndex].includes(-1)) throw new Error("V s√∫bore ch√Ωbaj√∫ potrebn√© stƒ∫pce (De≈à, Pr√≠chod, Odchod, Prest√°vka)."); let backupDataArray = []; let backupSettings = {}; let rowIndex = headerIndex + 1; for (; rowIndex < rows.length; rowIndex++) { const row = rows[rowIndex]; if (!row || !row[dayIndex]?.toString().match(/^\d+\./)) break; let startTime = row[startIndex]?.toString() || ""; let endTime = row[endIndex]?.toString() || ""; if (!isNaN(parseFloat(startTime)) && parseFloat(startTime) >= 0 && parseFloat(startTime) <= 1 && !startTime.includes(':')) { startTime = XLSX.SSF.format('hh:mm', parseFloat(startTime)); } if (!isNaN(parseFloat(endTime)) && parseFloat(endTime) >= 0 && parseFloat(endTime) <= 1 && !endTime.includes(':')) { endTime = XLSX.SSF.format('hh:mm', parseFloat(endTime)); } const noteFromFile = noteIndex !== -1 ? (row[noteIndex]?.toString() || "") : "";  backupDataArray.push({ start: startTime, end: endTime, breakTime: row[breakIndex]?.toString().replace(',', '.') || "", note: noteFromFile,  gross: "0", net: "0" }); } for (; rowIndex < rows.length; rowIndex++) { const row = rows[rowIndex]; if (row && row.length > 1 && row[0]) { const key = row[0].toString().trim().toLowerCase(); const value = row[1]?.toString().trim() || ""; if (key.includes("hodinov√° mzda")) backupSettings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined; else if (key.includes("da≈àov√© percento")) backupSettings.taxRatePercent = parseFloat(value.replace(',', '.').replace('%', '')) || undefined; else if (key.includes("meno pracovn√≠ka")) backupSettings.employeeName = value || undefined; else if (key.includes("poƒçet desatinn√Ωch miest")) backupSettings.decimalPlaces = parseInt(value) || undefined; } } const restoredHourlyWage = backupSettings.hourlyWage ?? hourlyWage; const restoredTaxRatePercent = backupSettings.taxRatePercent ?? (taxRate * 100); const restoredEmployeeName = backupSettings.employeeName ?? employeeName; const restoredDecimalPlaces = backupSettings.decimalPlaces ?? decimalPlaces; const backupDataObject = { data: backupDataArray, hourlyWage: restoredHourlyWage, taxRate: restoredTaxRatePercent / 100, employeeName: restoredEmployeeName, decimalPlaces: restoredDecimalPlaces, lastUpdated: new Date().toISOString() }; if (!confirm(`Naozaj chcete obnovi≈• d√°ta zo z√°lohy? Aktu√°lne d√°ta pre ${getMonthName(currentMonth)} ${currentYear} bud√∫ prep√≠san√© ${backupDataArray.length} d≈àami zo s√∫boru. Nastavenia (mzda, da≈à atƒè.) bud√∫ tie≈æ aktualizovan√© podƒæa z√°lohy.`)) return; const dataString = JSON.stringify(backupDataObject); localStorage.setItem(`workData-${currentYear}-${currentMonth}`, dataString); parseAndApplyData(dataString); localStorage.removeItem(`pendingSync-${currentYear}-${currentMonth}`); showSaveNotification('D√°ta boli √∫spe≈°ne obnoven√© zo z√°lohy.'); if (currentUser && isOnline()) { saveToFirestore(); /* Po obnove zo z√°lohy odo≈°li na server */ } } catch (err) { showErrorNotification(`Chyba pri obnove d√°t zo z√°lohy: ${err.message}`); console.error("Restore Backup Error:", err); } }; reader.onerror = () => { showErrorNotification('Nastala chyba pri ƒç√≠tan√≠ s√∫boru.'); }; reader.readAsArrayBuffer(file); }; fileInput.click(); };
    window.createBackup = () => { const localKey = `workData-${currentYear}-${currentMonth}`; const dataString = localStorage.getItem(localKey); if (dataString) { try { const dataObject = JSON.parse(dataString); const worksheet_data = [ ["De≈à","Pr√≠chod","Odchod","Prest√°vka (h)", "Pozn√°mky", "Hrub√° Mzda (‚Ç¨)","ƒåist√° Mzda (‚Ç¨)"] ]; if (dataObject.data?.length) { const daysInMonth = getDaysInMonth(currentMonth); const dataToExport = dataObject.data.slice(0, daysInMonth); dataToExport.forEach((rowData, index) => { const dayNum = index + 1; worksheet_data.push([ `${dayNum}. ${getDayName(currentYear, currentMonth, dayNum)}`, rowData.start || "", rowData.end || "", rowData.breakTime || "", rowData.note || "", rowData.gross ? parseFloat(rowData.gross) : 0, rowData.net ? parseFloat(rowData.net) : 0 ]); }); } worksheet_data.push([], ["Nastavenia:", "Hodnota"], ["Hodinov√° mzda", hourlyWage], ["Da≈àov√© percento (%)", taxRate * 100], ["Meno pracovn√≠ka", employeeName], ["Poƒçet desatinn√Ωch miest", decimalPlaces], ["Posledn√° aktualiz√°cia", dataObject.lastUpdated?new Date(dataObject.lastUpdated).toLocaleString('sk-SK'):"Nezn√°ma"]); const workbook = XLSX.utils.book_new(); const worksheet = XLSX.utils.aoa_to_sheet(worksheet_data); const moneyFormat = `0.00" ‚Ç¨"`; const timeFormat = "hh:mm"; const breakFormat = "0.0"; const dataEndRow = (dataObject.data?.length||0)+1; for (let R=1; R<dataEndRow; ++R) { if(worksheet[XLSX.utils.encode_cell({c:1,r:R})]) worksheet[XLSX.utils.encode_cell({c:1,r:R})].z=timeFormat; if(worksheet[XLSX.utils.encode_cell({c:2,r:R})]) worksheet[XLSX.utils.encode_cell({c:2,r:R})].z=timeFormat; if(worksheet[XLSX.utils.encode_cell({c:3,r:R})]) worksheet[XLSX.utils.encode_cell({c:3,r:R})].z=breakFormat; if(worksheet[XLSX.utils.encode_cell({c:5,r:R})]) worksheet[XLSX.utils.encode_cell({c:5,r:R})].z=moneyFormat;  if(worksheet[XLSX.utils.encode_cell({c:6,r:R})]) worksheet[XLSX.utils.encode_cell({c:6,r:R})].z=moneyFormat;  } worksheet['!cols'] = [ {wch:12}, {wch:8}, {wch:8}, {wch:10}, {wch:20},  {wch:14}, {wch:14} ]; const settingsRowIndex = worksheet_data.findIndex(r=>r[0]==="Nastavenia:"); if(settingsRowIndex!==-1) { worksheet['!cols'][0].wch=Math.max(worksheet['!cols'][0].wch, 25); } XLSX.utils.book_append_sheet(workbook, worksheet, `V√Ωkaz ${getMonthName(currentMonth)}`); const nameForFile = employeeName || 'Nezadane'; const safeName = nameForFile.replace(/[^a-zA-Z0-9√Å√°√Ñ√§ƒåƒçƒéƒè√â√©√ç√≠ƒπƒ∫ƒΩƒæ≈á≈à√ì√≥√î√¥≈î≈ï≈†≈°≈§≈•√ö√∫√ù√Ω≈Ω≈æ\s-]/g, '').replace(/\s+/g, '_'); const finalSafeName = safeName || 'Nezadane'; XLSX.writeFile(workbook, `Zaloha_Dochadzka_${finalSafeName}_${getMonthName(currentMonth)}_${currentYear}.xlsx`); showSaveNotification('Z√°loha bola √∫spe≈°ne vytvoren√°.'); } catch(err) { showErrorNotification(`Chyba pri vytv√°ran√≠ z√°lohy: ${err.message}`); console.error("Backup Error:", err); } } else { showErrorNotification('Nie s√∫ k dispoz√≠cii ≈æiadne d√°ta na z√°lohovanie pre tento mesiac.'); } };


    // Hlavn√° inicializaƒçn√° funkcia aplik√°cie
    function initializeAppState() {
        if (loaderElement) loaderElement.style.display = 'flex';

        // Nastavenie defaultn√Ωch hodn√¥t pre selecty mesiaca/roka
        monthSelect.value = currentMonth;
        populateYearSelect(); // Napln√≠ roky a nastav√≠ aktu√°lny rok

        loadInitialSettings(); // Naƒç√≠ta glob√°lne nastavenia, ktor√© sa m√¥≈æu prep√≠sa≈• d√°tami z Firebase

        onAuthStateChanged(auth, (user) => {
            const previousUser = currentUser; // Ulo≈æ predch√°dzaj√∫ceho usera pre porovnanie
            currentUser = user;

            // Ak sa zmenil stav prihl√°senia (napr. z null na usera, alebo z usera na null)
            // alebo ak sa men√≠ user (teoreticky mo≈æn√©, aj keƒè menej ƒçast√© bez odhl√°senia)
            // je potrebn√© znovu inicializova≈• listener a UI.
            // Ak sa len obnovuje str√°nka a user je rovnak√Ω, st√°le potrebujeme nastavi≈• listener.

            if (workDaysTableBody) workDaysTableBody.innerHTML = ''; // V≈ædy vyƒçisti tabuƒæku pred nov√Ωm setupom
            createTable(); // V≈ædy vytvor√≠ ≈°trukt√∫ru tabuƒæky

            if (loginFormElement) loginFormElement.style.display = 'none';
            if (userInfoElement) userInfoElement.style.display = 'none';
            if (userEmailElement) userEmailElement.textContent = '';

            if (currentUser) { // Pou≈æ√≠vateƒæ je prihl√°sen√Ω
                if (userInfoElement) userInfoElement.style.display = 'flex';
                if (userEmailElement) userEmailElement.textContent = `Prihl√°sen√Ω: ${currentUser.email}`;
                
                console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem Firestore listener.");
                setupFirestoreListener(); // Nastav√≠ listener, ktor√Ω naƒç√≠ta d√°ta a poƒç√∫va na zmeny
            
            } else { // Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω / odhl√°sil sa
                if (firestoreListenerUnsubscribe) {
                    console.log('Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω / odhl√°sil sa, odhlasujem Firestore listener.');
                    firestoreListenerUnsubscribe();
                    firestoreListenerUnsubscribe = null;
                }
                if (loginFormElement) loginFormElement.style.display = 'flex';
                
                loadFromLocalStorageOnly(); // Zobraz√≠ d√°ta len z `workData-*` (ak nejak√© s√∫ bez prihl√°senia)
                if (!isOnline()) {
                     showErrorNotification('Ste offline. Niektor√© funkcie m√¥≈æu by≈• obmedzen√©.');
                }
            }
            updateGreeting(); // Aktualizuj pozdrav a podnadpis mesiaca/roka

            // Loader by sa mal skry≈• v setupFirestoreListener alebo ak nie sme prihl√°sen√≠/online
            if (!currentUser || !isOnline() || (currentUser && !isOnline() && !firestoreListenerUnsubscribe)) {
                if (loaderElement) loaderElement.style.display = 'none';
            }
        });
    }


    document.addEventListener('DOMContentLoaded', () => {
        initializeAppState(); // Spust√≠ hlavn√∫ logiku aplik√°cie

        // Listener pre spr√°vy od Service Workera (pre Background Sync)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
              if (event.data && event.data.type === 'TRIGGER_SYNC_FROM_SW') {
                console.log('Main App: Prijat√° spr√°va TRIGGER_SYNC_FROM_SW od Service Workera.');
                if (isOnline() && currentUser) { // Len ak sme online a prihl√°sen√≠
                  showStatusNotification('Synchroniz√°cia d√°t spusten√° na pozad√≠ Service Workerom...', '#007bff');
                  syncWithFirebase().catch(err => {
                     console.error('Automatick√° synchroniz√°cia vyvolan√° SW zlyhala:', err);
                  });
                } else {
                  console.log('Main App: Podmienky pre synchroniz√°ciu (online & prihl√°sen√Ω) nie s√∫ splnen√© po spr√°ve od SW.');
                }
              }
            });
        }
    });

    // PWA in≈°talaƒçn√° logika
    let deferredPrompt;
    const installButtonContainer = document.querySelector('.btn-container');
    window.addEventListener('beforeinstallprompt', (e) => { console.log('beforeinstallprompt udalos≈• zachyten√°'); e.preventDefault(); deferredPrompt = e; const installButtonId = 'installAppButton'; if (!document.getElementById(installButtonId)) { const installButton = document.createElement('button'); installButton.id = installButtonId; installButton.classList.add('btn'); /* Pridaj triedu pre ≈°t√Ωlovanie */ installButton.textContent = 'Nain≈°talova≈• Doch√°dzku'; if (installButtonContainer) { installButtonContainer.appendChild(installButton); console.log('In≈°talaƒçn√© tlaƒçidlo pridan√©.'); } else { console.warn('.btn-container nebol n√°jden√Ω pre in≈°talaƒçn√© tlaƒçidlo.'); } installButton.addEventListener('click', async () => { console.log('Kliknut√© na in≈°talaƒçn√© tlaƒçidlo'); if (deferredPrompt) { installButton.style.display = 'none'; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; console.log(`Odpoveƒè na in≈°tal√°ciu: ${outcome}`); deferredPrompt = null; } else { console.log('deferredPrompt nie je dostupn√Ω.'); } }); } else { const existingInstallButton = document.getElementById(installButtonId); if (existingInstallButton) existingInstallButton.style.display = 'block'; } });
    window.addEventListener('appinstalled', () => { console.log('PWA bola nain≈°talovan√°'); const installButton = document.getElementById('installAppButton'); if (installButton) { installButton.style.display = 'none'; } deferredPrompt = null; });

  </script>

  <script>
    // Service Worker registr√°cia
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js') // Uistite sa, ≈æe cesta je spr√°vna
          .then(registration => { 
            console.log('ServiceWorker registr√°cia √∫spe≈°n√°, scope: ', registration.scope);
          })
          .catch(error => { 
            console.log('ServiceWorker registr√°cia zlyhala: ', error); 
          });
      });
    }
  </script>
</body>
</html>
